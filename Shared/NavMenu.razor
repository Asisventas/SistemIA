@inject IDbContextFactory<SistemIA.Models.AppDbContext> DbFactory
@using Microsoft.EntityFrameworkCore
@using Microsoft.AspNetCore.Components.Routing
@using SistemIA.Shared
@using SistemIA.Services
@implements IDisposable

<div class="nav-menu d-flex flex-column @(AnySubMenuOpen ? "has-submenu-open" : "")">
    <div class="nav-header p-3">
        @if (!string.IsNullOrEmpty(navMenuError))
        {
            <div class="alert alert-danger small p-2">@navMenuError</div>
        }

        <div class="brand-container mb-4">
            @if (!IsCollapsed)
            {
                @if (!string.IsNullOrEmpty(logoImageDataUrl))
                {
                    <img src="@logoImageDataUrl" class="sidebar-logo" alt="Logo Sucursal" />
                }
                else
                {
                    <i class="bi bi-share-fill sidebar-icon-placeholder"></i>
                }
                <h5 class="brand-name mt-2 text-white">SistemIA</h5>
            }
            else
            {
                <i class="bi bi-house-door fs-3 text-white" title="SistemIA"></i>
            }
        </div>
    </div>

    <nav class="nav nav-pills flex-column text-start">  
       @foreach (var item in MenuItems)  
       {  
           <div class="nav-item mb-1">  
               <NavLink class="nav-link" href="@item.Href" Match="@item.Match" title="@(IsCollapsed ? item.Text : "")" @onclick="OnAnyNavigate">  
                   <i class="@item.Icon me-2"></i>@if (!IsCollapsed){<span class="link-text">@item.Text</span>}  
               </NavLink>  
           </div>  
       }  

        <!-- Submenú de Productos -->
        <div class="nav-item mb-1">
            <button class="nav-link submenu-button w-100 d-flex align-items-center justify-content-between @(isProductosSubMenuOpen ? "active" : "")"
                    @onclick="ToggleProductosSubMenu"
                    type="button"
                    title="@(IsCollapsed ? "Productos" : "")">
                <span class="d-flex align-items-center">
                    <i class="bi bi-box-seam me-2"></i>
                    @if (!IsCollapsed)
                    {
                        <span class="link-text text-nowrap">Productos</span>
                    }
                </span>
                @if (!IsCollapsed)
                {
                    <i class="bi @(isProductosSubMenuOpen ? "bi-chevron-down" : "bi-chevron-right") ms-2"></i>
                }
            </button>

            <div class="submenu-container @(isProductosSubMenuOpen ? "show" : "collapse")">
                <div class="submenu-items">
                    <NavLink class="nav-link" href="/productos" title="@(IsCollapsed ? "Administrar" : "")" @onclick="OnAnyNavigate">
                        <i class="bi bi-gear me-2"></i>
                        @if (!IsCollapsed){<span class="link-text">Administrar</span>}
                    </NavLink>
                </div>
            </div>
        </div>

        <!-- Submenú de Ventas -->
        <div class="nav-item mb-1">
            <button class="nav-link submenu-button w-100 d-flex align-items-center justify-content-between @(isVentasSubMenuOpen ? "active" : "")"
                    @onclick="ToggleVentasSubMenu"
                    type="button"
                    title="@(IsCollapsed ? "Ventas" : "")">
                <span class="d-flex align-items-center">
                    <i class="bi bi-receipt-cutoff me-2"></i>
                    @if (!IsCollapsed)
                    {
                        <span class="link-text text-nowrap">Ventas</span>
                    }
                </span>
                @if (!IsCollapsed)
                {
                    <i class="bi @(isVentasSubMenuOpen ? "bi-chevron-down" : "bi-chevron-right") ms-2"></i>
                }
            </button>

            <div class="submenu-container @(isVentasSubMenuOpen ? "show" : "collapse")">
                <div class="submenu-items">
                    <NavLink class="nav-link" href="/ventas" title="@(IsCollapsed ? "Realizar Venta" : "")" @onclick="OnAnyNavigate">
                        <i class="bi bi-plus-square me-2"></i>
                        @if (!IsCollapsed){<span class="link-text">Realizar Venta</span>}
                    </NavLink>
                    <NavLink class="nav-link" href="/presupuestos/explorar" title="@(IsCollapsed ? "Presupuestos" : "")" @onclick="OnAnyNavigate">
                        <i class="bi bi-clipboard-check me-2"></i>
                        @if (!IsCollapsed){<span class="link-text">Presupuestos</span>}
                    </NavLink>
                    <NavLink class="nav-link" href="/ventas/explorar" title="@(IsCollapsed ? "Explorador de Ventas" : "")" @onclick="OnAnyNavigate">
                        <i class="bi bi-search me-2"></i>
                        @if (!IsCollapsed){<span class="link-text">Explorador de Ventas</span>}
                    </NavLink>
                    <hr class="my-1 mx-2 border-secondary opacity-25" />
                    <NavLink class="nav-link" href="/notas-credito" title="@(IsCollapsed ? "Nota de Crédito" : "")" @onclick="OnAnyNavigate">
                        <i class="bi bi-file-earmark-minus text-danger me-2"></i>
                        @if (!IsCollapsed){<span class="link-text">Nota de Crédito</span>}
                    </NavLink>
                    <NavLink class="nav-link" href="/notas-credito/explorar" title="@(IsCollapsed ? "Explorar NC" : "")" @onclick="OnAnyNavigate">
                        <i class="bi bi-journal-minus me-2"></i>
                        @if (!IsCollapsed){<span class="link-text">Explorar NC</span>}
                    </NavLink>
                    <hr class="my-1 mx-2 border-secondary opacity-25" />
                    <NavLink class="nav-link" href="/caja/cierre" title="@(IsCollapsed ? "Cierre de Caja" : "")" @onclick="OnAnyNavigate">
                        <i class="bi bi-cash-stack me-2"></i>
                        @if (!IsCollapsed){<span class="link-text">Cierre de Caja</span>}
                    </NavLink>
                    <NavLink class="nav-link" href="/caja/historial-cierres" title="@(IsCollapsed ? "Historial Cierres" : "")" @onclick="OnAnyNavigate">
                        <i class="bi bi-clock-history me-2"></i>
                        @if (!IsCollapsed){<span class="link-text">Historial Cierres</span>}
                    </NavLink>
                </div>
            </div>
        </div>

        <!-- Submenú de Mesas / Canchas / Bahías (Restaurante/Complejo/Taller) - Solo visible si modo restaurante está activo -->
        @if (_modoRestauranteActivo)
        {
        <div class="nav-item mb-1">
            <button class="nav-link submenu-button w-100 d-flex align-items-center justify-content-between @(isMesasSubMenuOpen ? "active" : "")"
                    @onclick="ToggleMesasSubMenu"
                    type="button"
                    title="@(IsCollapsed ? _nombreMenuMesas : "")">
                <span class="d-flex align-items-center">
                    <i class="bi @_iconoMenuMesas me-2"></i>
                    @if (!IsCollapsed)
                    {
                        <span class="link-text text-nowrap">@_nombreMenuMesas</span>
                    }
                </span>
                @if (!IsCollapsed)
                {
                    <i class="bi @(isMesasSubMenuOpen ? "bi-chevron-down" : "bi-chevron-right") ms-2"></i>
                }
            </button>

            <div class="submenu-container @(isMesasSubMenuOpen ? "show" : "collapse")">
                <div class="submenu-items">
                    <NavLink class="nav-link" href="/mesas/panel" title="@(IsCollapsed ? $"Panel de {_nombreEspacios}" : "")" @onclick="OnAnyNavigate">
                        <i class="bi bi-grid-1x2 me-2"></i>
                        @if (!IsCollapsed){<span class="link-text">Panel de @_nombreEspacios</span>}
                    </NavLink>
                    <NavLink class="nav-link" href="/mesas" title="@(IsCollapsed ? $"Administrar {_nombreEspacios}" : "")" @onclick="OnAnyNavigate">
                        <i class="bi bi-gear me-2"></i>
                        @if (!IsCollapsed){<span class="link-text">Administrar @_nombreEspacios</span>}
                    </NavLink>
                    <hr class="my-1 mx-2 border-secondary opacity-25" />
                    <NavLink class="nav-link" href="/reservas" title="@(IsCollapsed ? "Reservas" : "")" @onclick="OnAnyNavigate">
                        <i class="bi bi-calendar-check me-2"></i>
                        @if (!IsCollapsed){<span class="link-text">Reservas</span>}
                    </NavLink>
                    <NavLink class="nav-link" href="/agenda" title="@(IsCollapsed ? "Agenda" : "")" @onclick="OnAnyNavigate">
                        <i class="bi bi-calendar3 text-info me-2"></i>
                        @if (!IsCollapsed){<span class="link-text">Agenda</span>}
                    </NavLink>
                    <NavLink class="nav-link" href="/pedidos/explorar" title="@(IsCollapsed ? $"Explorar {(_tipoNegocioMesas == "Taller" ? "Órdenes" : "Pedidos")}" : "")" @onclick="OnAnyNavigate">
                        <i class="bi bi-search me-2"></i>
                        @if (!IsCollapsed){<span class="link-text">Explorar @(_tipoNegocioMesas == "Taller" ? "Órdenes" : "Pedidos")</span>}
                    </NavLink>
                    <hr class="my-1 mx-2 border-secondary opacity-25" />
                    @if (_tipoNegocioMesas == "Taller")
                    {
                        <NavLink class="nav-link" href="/taller" title="@(IsCollapsed ? "Pantalla Taller" : "")" @onclick="OnAnyNavigate">
                            <i class="bi bi-tools text-warning me-2"></i>
                            @if (!IsCollapsed){<span class="link-text">Pantalla Taller</span>}
                        </NavLink>
                        <NavLink class="nav-link" href="/ordenes-trabajo/explorar" title="@(IsCollapsed ? "Órdenes de Trabajo" : "")" @onclick="OnAnyNavigate">
                            <i class="bi bi-clipboard-check me-2"></i>
                            @if (!IsCollapsed){<span class="link-text">Órdenes de Trabajo</span>}
                        </NavLink>
                        <NavLink class="nav-link" href="/vehiculos/explorar" title="@(IsCollapsed ? "Vehículos" : "")" @onclick="OnAnyNavigate">
                            <i class="bi bi-car-front me-2"></i>
                            @if (!IsCollapsed){<span class="link-text">Vehículos</span>}
                        </NavLink>
                    }
                    else
                    {
                        <NavLink class="nav-link" href="/cocina" title="@(IsCollapsed ? "Pantalla Cocina" : "")" @onclick="OnAnyNavigate">
                            <i class="bi bi-fire text-danger me-2"></i>
                            @if (!IsCollapsed){<span class="link-text">Pantalla Cocina</span>}
                        </NavLink>
                    }
                    <hr class="my-1 mx-2 border-secondary opacity-25" />
                    <NavLink class="nav-link" href="/caja/cierre" title="@(IsCollapsed ? "Cerrar Turno" : "")" @onclick="OnAnyNavigate">
                        <i class="bi bi-lock text-danger me-2"></i>
                        @if (!IsCollapsed){<span class="link-text">Cerrar Turno</span>}
                    </NavLink>
                </div>
            </div>
        </div>
        }

        <!-- Submenú de Gimnasio - Solo visible si modo gimnasio está activo -->
        @if (_modoGimnasioActivo)
        {
        <div class="nav-item mb-1">
            <button class="nav-link submenu-button w-100 d-flex align-items-center justify-content-between @(isGimnasioSubMenuOpen ? "active" : "")"
                    @onclick="ToggleGimnasioSubMenu"
                    type="button"
                    title="@(IsCollapsed ? "Gimnasio" : "")">
                <span class="d-flex align-items-center">
                    <i class="bi bi-heart-pulse me-2"></i>
                    @if (!IsCollapsed)
                    {
                        <span class="link-text text-nowrap">Gimnasio</span>
                    }
                </span>
                @if (!IsCollapsed)
                {
                    <i class="bi @(isGimnasioSubMenuOpen ? "bi-chevron-down" : "bi-chevron-right") ms-2"></i>
                }
            </button>

            <div class="submenu-container @(isGimnasioSubMenuOpen ? "show" : "collapse")">
                <div class="submenu-items">
                    <NavLink class="nav-link" href="/gimnasio/acceso" title="@(IsCollapsed ? "Control de Acceso" : "")" @onclick="OnAnyNavigate">
                        <i class="bi bi-door-open text-success me-2"></i>
                        @if (!IsCollapsed){<span class="link-text">Control de Acceso</span>}
                    </NavLink>
                    <NavLink class="nav-link" href="/gimnasio/miembros" title="@(IsCollapsed ? "Miembros" : "")" @onclick="OnAnyNavigate">
                        <i class="bi bi-people-fill me-2"></i>
                        @if (!IsCollapsed){<span class="link-text">Miembros</span>}
                    </NavLink>
                    <hr class="my-1 mx-2 border-secondary opacity-25" />
                    <NavLink class="nav-link" href="/gimnasio/clases" title="@(IsCollapsed ? "Clases Grupales" : "")" @onclick="OnAnyNavigate">
                        <i class="bi bi-calendar2-event me-2"></i>
                        @if (!IsCollapsed){<span class="link-text">Clases Grupales</span>}
                    </NavLink>
                    <NavLink class="nav-link" href="/gimnasio/horarios" title="@(IsCollapsed ? "Horarios de Clases" : "")" @onclick="OnAnyNavigate">
                        <i class="bi bi-clock-history me-2"></i>
                        @if (!IsCollapsed){<span class="link-text">Horarios de Clases</span>}
                    </NavLink>
                    <NavLink class="nav-link" href="/gimnasio/reservas" title="@(IsCollapsed ? "Reservas y Asistencia" : "")" @onclick="OnAnyNavigate">
                        <i class="bi bi-bookmark-check me-2"></i>
                        @if (!IsCollapsed){<span class="link-text">Reservas y Asistencia</span>}
                    </NavLink>
                    <hr class="my-1 mx-2 border-secondary opacity-25" />
                    <NavLink class="nav-link" href="/gimnasio/rutinas" title="@(IsCollapsed ? "Rutinas y Entrenamiento" : "")" @onclick="OnAnyNavigate">
                        <i class="bi bi-clipboard-check me-2"></i>
                        @if (!IsCollapsed){<span class="link-text">Rutinas</span>}
                    </NavLink>
                    <NavLink class="nav-link" href="/gimnasio/mi-portal" title="@(IsCollapsed ? "Portal del Cliente" : "")" @onclick="OnAnyNavigate">
                        <i class="bi bi-person-badge text-info me-2"></i>
                        @if (!IsCollapsed){<span class="link-text">Portal del Cliente</span>}
                    </NavLink>
                    <hr class="my-1 mx-2 border-secondary opacity-25" />
                    <NavLink class="nav-link" href="/informes/gimnasio" title="@(IsCollapsed ? "Informes Gimnasio" : "")" @onclick="OnAnyNavigate">
                        <i class="bi bi-bar-chart-line me-2"></i>
                        @if (!IsCollapsed){<span class="link-text">Informes Gimnasio</span>}
                    </NavLink>
                </div>
            </div>
        </div>
        }

        <!-- Submenú de Agenda - Solo visible si modo agenda está activo -->
        @if (_modoAgendaActivo)
        {
        <div class="nav-item mb-1">
            <button class="nav-link submenu-button w-100 d-flex align-items-center justify-content-between @(isAgendaSubMenuOpen ? "active" : "")"
                    @onclick="ToggleAgendaSubMenu"
                    type="button"
                    title="@(IsCollapsed ? "Agenda" : "")">
                <span class="d-flex align-items-center">
                    <i class="bi bi-calendar3 me-2"></i>
                    @if (!IsCollapsed)
                    {
                        <span class="link-text text-nowrap">Agenda</span>
                    }
                </span>
                @if (!IsCollapsed)
                {
                    <i class="bi @(isAgendaSubMenuOpen ? "bi-chevron-down" : "bi-chevron-right") ms-2"></i>
                }
            </button>

            <div class="submenu-container @(isAgendaSubMenuOpen ? "show" : "collapse")">
                <div class="submenu-items">
                    <NavLink class="nav-link" href="/agenda" title="@(IsCollapsed ? "Calendario" : "")" @onclick="OnAnyNavigate">
                        <i class="bi bi-calendar-week text-primary me-2"></i>
                        @if (!IsCollapsed){<span class="link-text">Calendario</span>}
                    </NavLink>
                    <NavLink class="nav-link" href="/agenda?vista=dia" title="@(IsCollapsed ? "Vista Día" : "")" @onclick="OnAnyNavigate">
                        <i class="bi bi-calendar-day me-2"></i>
                        @if (!IsCollapsed){<span class="link-text">Vista Día</span>}
                    </NavLink>
                    <NavLink class="nav-link" href="/agenda?vista=lista" title="@(IsCollapsed ? "Lista de Citas" : "")" @onclick="OnAnyNavigate">
                        <i class="bi bi-list-ul me-2"></i>
                        @if (!IsCollapsed){<span class="link-text">Lista de Citas</span>}
                    </NavLink>
                </div>
            </div>
        </div>
        }

        <!-- Submenú de Compras -->
        <div class="nav-item mb-1">
            <button class="nav-link submenu-button w-100 d-flex align-items-center justify-content-between @(isComprasSubMenuOpen ? "active" : "")"
                    @onclick="ToggleComprasSubMenu"
                    type="button"
                    title="@(IsCollapsed ? "Compras" : "")">
                <span class="d-flex align-items-center">
                    <i class="bi bi-cart-fill me-2"></i>
                    @if (!IsCollapsed)
                    {
                        <span class="link-text text-nowrap">Compras</span>
                    }
                </span>
                @if (!IsCollapsed)
                {
                    <i class="bi @(isComprasSubMenuOpen ? "bi-chevron-down" : "bi-chevron-right") ms-2"></i>
                }
            </button>

            <div class="submenu-container @(isComprasSubMenuOpen ? "show" : "collapse")">
                <div class="submenu-items">
                    <NavLink class="nav-link" href="/compras" title="@(IsCollapsed ? "Registrar Compra" : "")" @onclick="OnAnyNavigate">
                        <i class="bi bi-plus-square me-2"></i>
                        @if (!IsCollapsed){<span class="link-text">Registrar Compra</span>}
                    </NavLink>
                    <NavLink class="nav-link" href="/compras/explorar" title="@(IsCollapsed ? "Explorador de Compras" : "")" @onclick="OnAnyNavigate">
                        <i class="bi bi-search me-2"></i>
                        @if (!IsCollapsed){<span class="link-text">Explorador de Compras</span>}
                    </NavLink>
                    <NavLink class="nav-link" href="/notas-credito-compra" title="@(IsCollapsed ? "Nueva NC Compra" : "")" @onclick="OnAnyNavigate">
                        <i class="bi bi-file-earmark-minus me-2"></i>
                        @if (!IsCollapsed){<span class="link-text">Nueva NC Compra</span>}
                    </NavLink>
                    <NavLink class="nav-link" href="/notas-credito-compra/explorar" title="@(IsCollapsed ? "Explorar NC Compras" : "")" @onclick="OnAnyNavigate">
                        <i class="bi bi-list-ul me-2"></i>
                        @if (!IsCollapsed){<span class="link-text">Explorar NC Compras</span>}
                    </NavLink>
                </div>
            </div>
        </div>

        <!-- Submenú de Clientes -->
        <div class="nav-item mb-1">
            <button class="nav-link submenu-button w-100 d-flex align-items-center justify-content-between @(isClientesSubMenuOpen ? "active" : "")"
                    @onclick="ToggleClientesSubMenu"
                    type="button"
                    title="@(IsCollapsed ? "Clientes" : "")">
                <span class="d-flex align-items-center">
                    <i class="bi bi-person-lines-fill me-2"></i>
                    @if (!IsCollapsed)
                    {
                        <span class="link-text text-nowrap">Clientes</span>
                    }
                </span>
                @if (!IsCollapsed)
                {
                    <i class="bi @(isClientesSubMenuOpen ? "bi-chevron-down" : "bi-chevron-right") ms-2"></i>
                }
            </button>

            <div class="submenu-container @(isClientesSubMenuOpen ? "show" : "collapse")">
                <div class="submenu-items">
                    <NavLink class="nav-link" href="/clientes/explorar" title="@(IsCollapsed ? "Explorar Clientes" : "")" @onclick="OnAnyNavigate">
                        <i class="bi bi-search me-2"></i>
                        @if (!IsCollapsed){<span class="link-text">Explorar Clientes</span>}
                    </NavLink>
                    <NavLink class="nav-link" href="/cobros" title="@(IsCollapsed ? "Cuentas por Cobrar" : "")" @onclick="OnAnyNavigate">
                        <i class="bi bi-cash-coin me-2"></i>
                        @if (!IsCollapsed){<span class="link-text">Cuentas por Cobrar</span>}
                    </NavLink>
                    <hr class="my-1 mx-2 border-secondary opacity-25" />
                    <NavLink class="nav-link" href="/suscripciones" title="@(IsCollapsed ? "Suscripciones" : "")" @onclick="OnAnyNavigate">
                        <i class="bi bi-calendar-check me-2"></i>
                        @if (!IsCollapsed){<span class="link-text">Suscripciones</span>}
                    </NavLink>
                    <NavLink class="nav-link" href="/monitor-facturas-automaticas" title="@(IsCollapsed ? "Monitor Facturación" : "")" @onclick="OnAnyNavigate">
                        <i class="bi bi-speedometer2 me-2"></i>
                        @if (!IsCollapsed){<span class="link-text">Monitor Facturación</span>}
                    </NavLink>
                </div>
            </div>
        </div>

    <!-- Submenú de Proveedores (simplificado) -->
        <div class="nav-item mb-1">
            <button class="nav-link submenu-button w-100 d-flex align-items-center justify-content-between @(isProveedoresSubMenuOpen ? "active" : "")" 
                    @onclick="ToggleProveedoresSubMenu" 
                    type="button"
                    title="@(IsCollapsed ? "Proveedores" : "")">
                <span class="d-flex align-items-center">
                    <i class="bi bi-building-fill-gear me-2"></i>
                    @if (!IsCollapsed)
                    {
                        <span class="link-text text-nowrap">Proveedores</span>
                    }
                </span>
                @if (!IsCollapsed)
                {
                    <i class="bi @(isProveedoresSubMenuOpen ? "bi-chevron-down" : "bi-chevron-right") ms-2"></i>
                }
            </button>

            <div class="submenu-container @(isProveedoresSubMenuOpen ? "show" : "collapse")">
                <div class="submenu-items">
                    <NavLink class="nav-link" href="/proveedores/explorar" title="@(IsCollapsed ? "Explorar Proveedores" : "")" @onclick="OnAnyNavigate">
                        <i class="bi bi-search me-2"></i>
                        @if (!IsCollapsed){<span class="link-text">Explorar Proveedores</span>}
                    </NavLink>
                    <NavLink class="nav-link" href="/pagos-proveedores" title="@(IsCollapsed ? "Pagos a Proveedores" : "")" @onclick="OnAnyNavigate">
                        <i class="bi bi-cash-coin me-2"></i>
                        @if (!IsCollapsed){<span class="link-text">Pagos a Proveedores</span>}
                    </NavLink>
                </div>
            </div>
        </div>

        <!-- Submenú de Informes -->
        <div class="nav-item mb-1">
            <button class="nav-link submenu-button w-100 d-flex align-items-center justify-content-between @(isInformesSubMenuOpen ? "active" : "")" 
                    @onclick="ToggleInformesSubMenu" 
                    type="button"
                    title="@(IsCollapsed ? "Informes" : "")">
                <span class="d-flex align-items-center">
                    <i class="bi bi-file-earmark-bar-graph me-2"></i>
                    @if (!IsCollapsed)
                    {
                        <span class="link-text text-nowrap">Informes</span>
                    }
                </span>
                @if (!IsCollapsed)
                {
                    <i class="bi @(isInformesSubMenuOpen ? "bi-chevron-down" : "bi-chevron-right") ms-2"></i>
                }
            </button>

            <div class="submenu-container @(isInformesSubMenuOpen ? "show" : "collapse")">
                <div class="submenu-items">
                    <!-- Informes de Ventas -->
                    <div class="submenu-section-header">
                        <i class="bi bi-graph-up-arrow me-1 text-success"></i>
                        <span class="small fw-bold text-success">INFORMES DE VENTAS</span>
                    </div>
                    <NavLink class="nav-link" href="/informes/ventas-agrupado" title="@(IsCollapsed ? "Ventas Agrupado" : "")" @onclick="OnAnyNavigate">
                        <i class="bi bi-layout-split me-2"></i>
                        @if (!IsCollapsed){<span class="link-text">Ventas Agrupado</span>}
                    </NavLink>
                    <NavLink class="nav-link" href="/informes/ventas-detallado" title="@(IsCollapsed ? "Ventas Detallada" : "")" @onclick="OnAnyNavigate">
                        <i class="bi bi-list-check me-2"></i>
                        @if (!IsCollapsed){<span class="link-text">Ventas Detallada</span>}
                    </NavLink>
                    
                    <hr class="my-1 mx-2 border-secondary opacity-25" />
                    
                    <!-- Informes de Notas de Crédito -->
                    <div class="submenu-section-header">
                        <i class="bi bi-receipt-cutoff me-1 text-warning"></i>
                        <span class="small fw-bold text-warning">NOTAS DE CRÉDITO</span>
                    </div>
                    <NavLink class="nav-link" href="/informes/nc-agrupado" title="@(IsCollapsed ? "Informe NC Agrupado" : "")" @onclick="OnAnyNavigate">
                        <i class="bi bi-layout-split me-2"></i>
                        @if (!IsCollapsed){<span class="link-text">Informe NC Agrupado</span>}
                    </NavLink>
                    <NavLink class="nav-link" href="/informes/nc-detallado" title="@(IsCollapsed ? "Informe NC Detallado" : "")" @onclick="OnAnyNavigate">
                        <i class="bi bi-list-check me-2"></i>
                        @if (!IsCollapsed){<span class="link-text">Informe NC Detallado</span>}
                    </NavLink>
                    
                    <hr class="my-1 mx-2 border-secondary opacity-25" />
                    
                    <!-- Informes de Compras -->
                    <div class="submenu-section-header">
                        <i class="bi bi-cart3 me-1 text-primary"></i>
                        <span class="small fw-bold text-primary">INFORMES DE COMPRAS</span>
                    </div>
                    <NavLink class="nav-link" href="/informes/compras-general" title="@(IsCollapsed ? "Compras Agrupado" : "")" @onclick="OnAnyNavigate">
                        <i class="bi bi-layout-split me-2"></i>
                        @if (!IsCollapsed){<span class="link-text">Compras Agrupado</span>}
                    </NavLink>
                    <NavLink class="nav-link" href="/informes/compras-detallado" title="@(IsCollapsed ? "Compras Detallado" : "")" @onclick="OnAnyNavigate">
                        <i class="bi bi-list-check me-2"></i>
                        @if (!IsCollapsed){<span class="link-text">Compras Detallado</span>}
                    </NavLink>
                    
                    <hr class="my-1 mx-2 border-secondary opacity-25" />
                    
                    <!-- Informes de NC Compras -->
                    <div class="submenu-section-header">
                        <i class="bi bi-receipt-cutoff me-1 text-info"></i>
                        <span class="small fw-bold text-info">NC COMPRAS</span>
                    </div>
                    <NavLink class="nav-link" href="/informes/nc-compras-agrupado" title="@(IsCollapsed ? "NC Compras Agrupado" : "")" @onclick="OnAnyNavigate">
                        <i class="bi bi-layout-split me-2"></i>
                        @if (!IsCollapsed){<span class="link-text">NC Compras Agrupado</span>}
                    </NavLink>
                    <NavLink class="nav-link" href="/informes/nc-compras-detallado" title="@(IsCollapsed ? "NC Compras Detallado" : "")" @onclick="OnAnyNavigate">
                        <i class="bi bi-list-check me-2"></i>
                        @if (!IsCollapsed){<span class="link-text">NC Compras Detallado</span>}
                    </NavLink>
                    
                    <hr class="my-1 mx-2 border-secondary opacity-25" />
                    
                    <!-- Informes Resumen de Caja -->
                    <div class="submenu-section-header">
                        <i class="bi bi-cash-stack me-1" style="color: #20c997;"></i>
                        <span class="small fw-bold" style="color: #20c997;">RESUMEN DE CAJA</span>
                    </div>
                    <NavLink class="nav-link" href="/informes/resumen-caja" title="@(IsCollapsed ? "Resumen de Caja" : "")" @onclick="OnAnyNavigate">
                        <i class="bi bi-journal-check me-2"></i>
                        @if (!IsCollapsed){<span class="link-text">Resumen de Caja</span>}
                    </NavLink>
                    <NavLink class="nav-link" href="/informes/ventas-clasificacion" title="@(IsCollapsed ? "Por Clasificación" : "")" @onclick="OnAnyNavigate">
                        <i class="bi bi-pie-chart me-2"></i>
                        @if (!IsCollapsed){<span class="link-text">Por Clasificación</span>}
                    </NavLink>
                    
                    <hr class="my-1 mx-2 border-secondary opacity-25" />
                    
                    <!-- Libro IVA / Obligaciones Fiscales -->
                    <div class="submenu-section-header">
                        <i class="bi bi-journal-bookmark-fill me-1 text-danger"></i>
                        <span class="small fw-bold text-danger">LIBRO IVA / FISCAL</span>
                    </div>
                    <NavLink class="nav-link" href="/informes/libro-iva" title="@(IsCollapsed ? "Libro IVA" : "")" @onclick="OnAnyNavigate">
                        <i class="bi bi-journal-richtext me-2"></i>
                        @if (!IsCollapsed){<span class="link-text">Libro IVA Ventas y Compras</span>}
                    </NavLink>
                    
                    <hr class="my-1 mx-2 border-secondary opacity-25" />
                    
                    <!-- Informes de Productos -->
                    <div class="submenu-section-header">
                        <i class="bi bi-box-seam me-1" style="color: #fd7e14;"></i>
                        <span class="small fw-bold" style="color: #fd7e14;">INFORMES DE PRODUCTOS</span>
                    </div>
                    <NavLink class="nav-link" href="/informes/productos-detallado" title="@(IsCollapsed ? "Productos Detallado" : "")" @onclick="OnAnyNavigate">
                        <i class="bi bi-list-check me-2"></i>
                        @if (!IsCollapsed){<span class="link-text">Productos Detallado</span>}
                    </NavLink>
                    <NavLink class="nav-link" href="/informes/productos-valorizado" title="@(IsCollapsed ? "Listado Valorizado" : "")" @onclick="OnAnyNavigate">
                        <i class="bi bi-currency-exchange me-2"></i>
                        @if (!IsCollapsed){<span class="link-text">Listado Valorizado</span>}
                    </NavLink>
                    <NavLink class="nav-link" href="/informes/movimientos-productos" title="@(IsCollapsed ? "Movimientos Inventario" : "")" @onclick="OnAnyNavigate">
                        <i class="bi bi-arrow-left-right me-2"></i>
                        @if (!IsCollapsed){<span class="link-text">Movimientos Inventario</span>}
                    </NavLink>
                    <NavLink class="nav-link" href="/informes/ajustes-stock" title="@(IsCollapsed ? "Ajustes de Stock" : "")" @onclick="OnAnyNavigate">
                        <i class="bi bi-clipboard-check me-2"></i>
                        @if (!IsCollapsed){<span class="link-text">Ajustes de Stock</span>}
                    </NavLink>
                    <NavLink class="nav-link" href="/inventario/salidas-stock" title="@(IsCollapsed ? "Salidas de Stock" : "")" @onclick="OnAnyNavigate">
                        <i class="bi bi-box-arrow-right text-danger me-2"></i>
                        @if (!IsCollapsed){<span class="link-text">Salidas de Stock</span>}
                    </NavLink>
                    
                    <hr class="my-1 mx-2 border-secondary opacity-25" />
                    
                    <!-- Informes de Clientes -->
                    <div class="submenu-section-header">
                        <i class="bi bi-person-lines-fill me-1" style="color: #6f42c1;"></i>
                        <span class="small fw-bold" style="color: #6f42c1;">INFORMES DE CLIENTES</span>
                    </div>
                    <NavLink class="nav-link" href="/informes/clientes" title="@(IsCollapsed ? "Listado de Clientes" : "")" @onclick="OnAnyNavigate">
                        <i class="bi bi-list-check me-2"></i>
                        @if (!IsCollapsed){<span class="link-text">Listado de Clientes</span>}
                    </NavLink>
                    <NavLink class="nav-link" href="/informes/cuentas-por-cobrar" title="@(IsCollapsed ? "Listado de Cobro a Clientes" : "")" @onclick="OnAnyNavigate">
                        <i class="bi bi-cash-stack me-2"></i>
                        @if (!IsCollapsed){<span class="link-text">Listado de Cobro a Clientes</span>}
                    </NavLink>
                    <NavLink class="nav-link" href="/cobros" title="@(IsCollapsed ? "Registro de Cobros" : "")" @onclick="OnAnyNavigate">
                        <i class="bi bi-receipt me-2"></i>
                        @if (!IsCollapsed){<span class="link-text">Registro de Cobros</span>}
                    </NavLink>
                    <NavLink class="nav-link" href="/cobros/listado" title="@(IsCollapsed ? "Historial de Cobros" : "")" @onclick="OnAnyNavigate">
                        <i class="bi bi-receipt-cutoff me-2"></i>
                        @if (!IsCollapsed){<span class="link-text">Historial de Cobros</span>}
                    </NavLink>
                    
                    <hr class="my-1 mx-2 border-secondary opacity-25" />
                    
                    <!-- Informes de Proveedores -->
                    <div class="submenu-section-header">
                        <i class="bi bi-building me-1" style="color: #e83e8c;"></i>
                        <span class="small fw-bold" style="color: #e83e8c;">INFORMES DE PROVEEDORES</span>
                    </div>
                    <NavLink class="nav-link" href="/informes/proveedores" title="@(IsCollapsed ? "Listado de Proveedores" : "")" @onclick="OnAnyNavigate">
                        <i class="bi bi-list-check me-2"></i>
                        @if (!IsCollapsed){<span class="link-text">Listado de Proveedores</span>}
                    </NavLink>
                    <NavLink class="nav-link" href="/informes/cuentas-por-pagar" title="@(IsCollapsed ? "Listado de Pago a Proveedores" : "")" @onclick="OnAnyNavigate">
                        <i class="bi bi-cash-coin me-2"></i>
                        @if (!IsCollapsed){<span class="link-text">Listado de Pago a Proveedores</span>}
                    </NavLink>
                    <NavLink class="nav-link" href="/pagos-proveedores/historial" title="@(IsCollapsed ? "Historial de Pagos" : "")" @onclick="OnAnyNavigate">
                        <i class="bi bi-clock-history me-2"></i>
                        @if (!IsCollapsed){<span class="link-text">Historial de Pagos</span>}
                    </NavLink>
                    
                    <hr class="my-1 mx-2 border-secondary opacity-25" />
                    
                    <!-- Informes de Personal/Asistencia -->
                    <div class="submenu-section-header">
                        <i class="bi bi-person-badge me-1 text-secondary"></i>
                        <span class="small fw-bold text-secondary">INFORMES DE PERSONAL</span>
                    </div>
                    <NavLink class="nav-link" href="/informes-asistencia" title="@(IsCollapsed ? "Informes de Asistencia" : "")" @onclick="OnAnyNavigate">
                        <i class="bi bi-file-earmark-pdf me-2"></i>
                        @if (!IsCollapsed){<span class="link-text">Informe de Asistencia</span>}
                    </NavLink>
                    
                    @if (_modoRestauranteActivo)
                    {
                        <hr class="my-1 mx-2 border-secondary opacity-25" />
                        
                        <!-- Informes de Operaciones (Restaurante/Complejo/Taller) -->
                        <div class="submenu-section-header">
                            <i class="bi @_iconoMenuMesas me-1" style="color: #ff6b6b;"></i>
                            <span class="small fw-bold" style="color: #ff6b6b;">@_nombreMenuMesas.ToUpper()</span>
                        </div>
                        <NavLink class="nav-link" href="/informes/cierre-operaciones" title="@(IsCollapsed ? $"Informe de Cierre de {_nombreMenuMesas}" : "")" @onclick="OnAnyNavigate">
                            <i class="bi bi-clipboard-data me-2"></i>
                            @if (!IsCollapsed){<span class="link-text">Cierre de @_nombreMenuMesas</span>}
                        </NavLink>
                    }
                </div>
            </div>
        </div>

        <!-- Submenú de Gestión de Personal -->
        <div class="nav-item mb-1">
            <button class="nav-link submenu-button w-100 d-flex align-items-center justify-content-between @(isSubMenuOpen ? "active" : "")" 
                    @onclick="ToggleSubMenu" 
                    type="button"
                    title="@(IsCollapsed ? "Gestión de Personal" : "")">
                <span class="d-flex align-items-center">
                    <i class="bi bi-people-fill me-2"></i>
                    @if (!IsCollapsed)
                    {
                        <span class="link-text text-nowrap">Gestión de Personal</span>
                    }
                </span>
                @if (!IsCollapsed)
                {
                    <i class="bi @(isSubMenuOpen ? "bi-chevron-down" : "bi-chevron-right") ms-2"></i>
                }
            </button>

            <div class="submenu-container @(isSubMenuOpen ? "show" : "collapse")">
                <div class="submenu-items">
                    <NavLink class="nav-link" href="/menu-usuarios" title="@(IsCollapsed ? "Usuarios" : "")" @onclick="OnAnyNavigate">
                        <i class="bi bi-person-badge me-2"></i>
                        @if (!IsCollapsed){<span class="link-text">Usuarios</span>}
                    </NavLink>
                    <NavLink class="nav-link" href="/registro-asistencia" title="@(IsCollapsed ? "Asistencia" : "")" @onclick="OnAnyNavigate">
                        <i class="bi bi-calendar-check me-2"></i>
                        @if (!IsCollapsed){<span class="link-text">Asistencia</span>}
                    </NavLink>
                    <NavLink class="nav-link" href="/registro-directo" Match="NavLinkMatch.All" title="@(IsCollapsed ? "Registro Directo" : "")" @onclick="OnAnyNavigate">
                        <i class="bi bi-camera-fill me-2"></i>
                        @if (!IsCollapsed){<span class="link-text">Registro Directo</span>}
                    </NavLink>
                    <NavLink class="nav-link" href="/horarios" title="@(IsCollapsed ? "Horarios" : "")" @onclick="OnAnyNavigate">
                        <i class="bi bi-clock me-2"></i>
                        @if (!IsCollapsed){<span class="link-text">Horarios</span>}
                    </NavLink>
                    <NavLink class="nav-link" href="/asignacionhorarios" title="@(IsCollapsed ? "Asignar" : "")" @onclick="OnAnyNavigate">
                        <i class="bi bi-calendar2-week me-2"></i>
                        @if (!IsCollapsed){<span class="link-text">Asignar</span>}
                    </NavLink>
                    <NavLink class="nav-link" href="/personal/permisos-usuarios" title="@(IsCollapsed ? "Permisos de Usuarios" : "")" @onclick="OnAnyNavigate">
                        <i class="bi bi-shield-lock me-2"></i>
                        @if (!IsCollapsed){<span class="link-text">Permisos de Usuarios</span>}
                    </NavLink>
                </div>
            </div>
        </div>

        <!-- Submenú de Inventario -->
        <div class="nav-item mb-1">
            <button class="nav-link submenu-button w-100 d-flex align-items-center justify-content-between @(isInventarioSubMenuOpen ? "active" : "")"
                    @onclick="ToggleInventarioSubMenu"
                    type="button"
                    title="@(IsCollapsed ? "Inventario" : "")">
                <span class="d-flex align-items-center">
                    <i class="bi bi-archive me-2"></i>
                    @if (!IsCollapsed)
                    {
                        <span class="link-text text-nowrap">Inventario</span>
                    }
                </span>
                @if (!IsCollapsed)
                {
                    <i class="bi @(isInventarioSubMenuOpen ? "bi-chevron-down" : "bi-chevron-right") ms-2"></i>
                }
            </button>

            <div class="submenu-container @(isInventarioSubMenuOpen ? "show" : "collapse")">
                <div class="submenu-items">
                    <NavLink class="nav-link" href="/inventario/depositos" title="@(IsCollapsed ? "Depósitos" : "")" @onclick="OnAnyNavigate">
                        <i class="bi bi-building-down me-2"></i>
                        @if (!IsCollapsed){<span class="link-text">Depósitos</span>}
                    </NavLink>
                        <NavLink class="nav-link" href="/inventario/ajustes" title="@(IsCollapsed ? "Ajustes de Stock" : "")" @onclick="OnAnyNavigate">
                            <i class="bi bi-wrench me-2"></i>
                            @if (!IsCollapsed){<span class="link-text">Ajustes de Stock</span>}
                        </NavLink>
                        <NavLink class="nav-link" href="/inventario/transferencias" title="@(IsCollapsed ? "Transferencias" : "")" @onclick="OnAnyNavigate">
                            <i class="bi bi-arrow-left-right me-2"></i>
                            @if (!IsCollapsed){<span class="link-text">Transferencias</span>}
                        </NavLink>
                        <NavLink class="nav-link" href="/inventario/salidas-stock" title="@(IsCollapsed ? "Salidas de Stock" : "")" @onclick="OnAnyNavigate">
                            <i class="bi bi-box-arrow-right text-danger me-2"></i>
                            @if (!IsCollapsed){<span class="link-text">Salidas de Stock</span>}
                        </NavLink>
                        <NavLink class="nav-link" href="/seleccionar-sucursal" title="@(IsCollapsed ? "Cambiar Sucursal" : "")">
                            <i class="bi bi-arrow-left-right me-2"></i>
                            @if (!IsCollapsed){<span class="link-text">Cambiar Sucursal</span>}
                        </NavLink>
                        <NavLink class="nav-link" href="/inventario/ajustes/explorar" title="@(IsCollapsed ? "Explorar Ajustes" : "")" @onclick="OnAnyNavigate">
                            <i class="bi bi-search me-2"></i>
                            @if (!IsCollapsed){<span class="link-text">Explorar Ajustes</span>}
                        </NavLink>
                        <hr class="my-1 mx-2 border-secondary opacity-25" />
                        <NavLink class="nav-link" href="/inventario/lotes" title="@(IsCollapsed ? "Gestión de Lotes" : "")" @onclick="OnAnyNavigate">
                            <i class="bi bi-box-seam me-2"></i>
                            @if (!IsCollapsed){<span class="link-text">Gestión de Lotes</span>}
                        </NavLink>
                        <NavLink class="nav-link" href="/inventario/alertas-vencimiento" title="@(IsCollapsed ? "Alertas Vencimiento" : "")" @onclick="OnAnyNavigate">
                            <i class="bi bi-exclamation-triangle text-warning me-2"></i>
                            @if (!IsCollapsed){<span class="link-text">Alertas Vencimiento</span>}
                        </NavLink>
                </div>
            </div>
        </div>
    </nav>

    <div class="sidebar-footer mt-auto pb-3">
        <!-- Submenú de Configuración -->
        <div class="nav-item mb-1">
            <button class="nav-link submenu-button w-100 d-flex align-items-center justify-content-between @(isConfiguracionSubMenuOpen ? "active" : "")" 
                    @onclick="ToggleConfiguracionSubMenu" 
                    type="button"
                    title="@(IsCollapsed ? "Configuración" : "")">
                <span class="d-flex align-items-center">
                    <i class="bi bi-gear-fill me-2"></i>
                    @if (!IsCollapsed)
                    {
                        <span class="link-text">Configuración</span>
                    }
                </span>
                @if (!IsCollapsed)
                {
                    <i class="bi @(isConfiguracionSubMenuOpen ? "bi-chevron-down" : "bi-chevron-right") ms-2"></i>
                }
            </button>
            
            <div class="submenu-container @(isConfiguracionSubMenuOpen && !IsCollapsed ? "show" : "collapse")">
                <div class="submenu-items pe-1">
                    <!-- Empresa -->
                    <div class="submenu-section-header">
                        <i class="bi bi-building me-1"></i>
                        <span class="small fw-bold text-muted">EMPRESA</span>
                    </div>
                    <NavLink class="nav-link submenu-item" href="/sucursales" title="Gestión de Sucursales" @onclick="OnAnyNavigate">
                        <i class="bi bi-building me-2"></i>
                        <span class="link-text">Sucursales</span>
                    </NavLink>
                    <NavLink class="nav-link submenu-item" href="/configuracion/sociedad" title="Datos del Emisor (Sociedad)" @onclick="OnAnyNavigate">
                        <i class="bi bi-shop me-2"></i>
                        <span class="link-text">Sociedad (Emisor)</span>
                    </NavLink>
                    <NavLink class="nav-link submenu-item" href="/configuracion/cajas" title="Configuración de Cajas" @onclick="OnAnyNavigate">
                        <i class="bi bi-upc-scan me-2"></i>
                        <span class="link-text">Cajas</span>
                    </NavLink>
                    
                    <hr class="my-1 mx-2 border-secondary opacity-25" />
                    
                    <!-- Catálogos -->
                    <div class="submenu-section-header">
                        <i class="bi bi-list-ul me-1"></i>
                        <span class="small fw-bold text-muted">CATÁLOGOS</span>
                    </div>
                    <NavLink class="nav-link submenu-item" href="/configuracion/tipos-pago" title="Tipos de Pago" @onclick="OnAnyNavigate">
                        <i class="bi bi-credit-card me-2"></i>
                        <span class="link-text">Tipos de Pago</span>
                    </NavLink>
                    <NavLink class="nav-link submenu-item" href="/configuracion/tipos-documento" title="Tipos de Documento" @onclick="OnAnyNavigate">
                        <i class="bi bi-file-text me-2"></i>
                        <span class="link-text">Tipos de Documento</span>
                    </NavLink>
                    <NavLink class="nav-link submenu-item" href="/configuracion/tipos-iva" title="Gestión de Tipos de IVA" @onclick="OnAnyNavigate">
                        <i class="bi bi-percent me-2"></i>
                        <span class="link-text">Tipos de IVA</span>
                    </NavLink>
                    <NavLink class="nav-link submenu-item" href="/configuracion/marcas-clasificaciones" title="Marcas y Clasificaciones de Productos" @onclick="OnAnyNavigate">
                        <i class="bi bi-tags-fill me-2"></i>
                        <span class="link-text">Marcas y Clasificaciones</span>
                    </NavLink>
                    <NavLink class="nav-link submenu-item" href="/configuracion/precios-descuentos" title="Precios y Descuentos" @onclick="OnAnyNavigate">
                        <i class="bi bi-currency-exchange me-2"></i>
                        <span class="link-text">Precios y Descuentos</span>
                    </NavLink>
                    
                    <hr class="my-1 mx-2 border-secondary opacity-25" />
                    
                    <!-- Sistema -->
                    <div class="submenu-section-header">
                        <i class="bi bi-gear me-1"></i>
                        <span class="small fw-bold text-muted">SISTEMA</span>
                    </div>
                    <NavLink class="nav-link submenu-item" href="/configuracion-sistema" title="Configuración General del Sistema" @onclick="OnAnyNavigate">
                        <i class="bi bi-sliders me-2"></i>
                        <span class="link-text">Config. General</span>
                    </NavLink>
                    <NavLink class="nav-link submenu-item" href="/configuracion/correo" title="Configuración de Correo Electrónico" @onclick="OnAnyNavigate">
                        <i class="bi bi-envelope-at me-2"></i>
                        <span class="link-text">Correo Electrónico</span>
                    </NavLink>
                    <NavLink class="nav-link submenu-item" href="/configuracion/cloudsync" title="Backup en la Nube - CloudSync" @onclick="OnAnyNavigate">
                        <i class="bi bi-cloud-arrow-up me-2"></i>
                        <span class="link-text">CloudSync (Backups)</span>
                        <span class="badge bg-success ms-1" style="font-size: 0.55rem;">Nuevo</span>
                    </NavLink>
                    <NavLink class="nav-link submenu-item" href="/configuracion/vpn" title="VPN y Soporte Remoto (Solo SA)" @onclick="OnAnyNavigate">
                        <i class="bi bi-shield-lock me-2"></i>
                        <span class="link-text">VPN / Soporte Remoto</span>
                        <span class="badge bg-warning text-dark ms-1" style="font-size: 0.55rem;">SA</span>
                    </NavLink>
                    <NavLink class="nav-link submenu-item" href="/configuracion/tema" title="Configuración de Tema" @onclick="OnAnyNavigate">
                        <i class="bi bi-palette me-2"></i>
                        <span class="link-text">Tema</span>
                    </NavLink>
                    <NavLink class="nav-link submenu-item" href="/configuracion/auditoria" title="Auditoría del Sistema" @onclick="OnAnyNavigate">
                        <i class="bi bi-journal-text me-2"></i>
                        <span class="link-text">Auditoría</span>
                    </NavLink>
                    <NavLink class="nav-link submenu-item" href="/manual-sistema" title="Manual y Ayuda del Sistema" @onclick="OnAnyNavigate">
                        <i class="bi bi-book me-2"></i>
                        <span class="link-text">Manual del Sistema</span>
                    </NavLink>
                    <NavLink class="nav-link submenu-item" href="/sistema/historial-cambios" title="Historial de Cambios del Sistema" @onclick="OnAnyNavigate">
                        <i class="bi bi-clock-history me-2"></i>
                        <span class="link-text">Historial Cambios</span>
                        <span class="badge bg-info ms-1" style="font-size: 0.6rem;">Nuevo</span>
                    </NavLink>
                    <NavLink class="nav-link submenu-item" href="/sistema/conversaciones-ia" title="Historial de Conversaciones con IA" @onclick="OnAnyNavigate">
                        <i class="bi bi-chat-dots me-2"></i>
                        <span class="link-text">Conversaciones IA</span>
                    </NavLink>
                    
                    <hr class="my-1 mx-2 border-secondary opacity-25" />
                    
                    <!-- Herramientas SA -->
                    <div class="submenu-section-header">
                        <i class="bi bi-shield-lock me-1"></i>
                        <span class="small fw-bold text-muted">SA (Requiere Contraseña)</span>
                    </div>
                    <NavLink class="nav-link submenu-item" href="/configuracion/presupuestos-sistema" title="Presupuestos Comerciales del Sistema (SA)" @onclick="OnAnyNavigate">
                        <i class="bi bi-file-earmark-text me-2"></i>
                        <span class="link-text">Presupuestos Sistema</span>
                        <span class="badge bg-warning text-dark ms-1" style="font-size: 0.55rem;">SA</span>
                    </NavLink>
                    <NavLink class="nav-link submenu-item" href="/asistente-ia" title="Asistente de Inteligencia Artificial (SA)" @onclick="OnAnyNavigate">
                        <i class="bi bi-robot me-2"></i>
                        <span class="link-text">Asistente IA</span>
                        <span class="badge bg-warning text-dark ms-1" style="font-size: 0.55rem;">SA</span>
                    </NavLink>
                    <NavLink class="nav-link submenu-item" href="/admin/asistente-ia" title="Administrar Base de Conocimiento del Asistente IA (SA)" @onclick="OnAnyNavigate">
                        <i class="bi bi-cpu me-2"></i>
                        <span class="link-text">Admin Asistente IA</span>
                        <span class="badge bg-warning text-dark ms-1" style="font-size: 0.55rem;">SA</span>
                    </NavLink>
                    <NavLink class="nav-link submenu-item" href="/pruebas-xml" title="Pruebas XML SIFEN (SA)" @onclick="OnAnyNavigate">
                        <i class="bi bi-filetype-xml me-2"></i>
                        <span class="link-text">Pruebas XML SIFEN</span>
                        <span class="badge bg-warning text-dark ms-1" style="font-size: 0.55rem;">SA</span>
                    </NavLink>
                    <NavLink class="nav-link submenu-item" href="/monitor-sifen" title="Monitor Cola SIFEN" @onclick="OnAnyNavigate">
                        <i class="bi bi-broadcast-pin me-2"></i>
                        <span class="link-text">Monitor Cola SIFEN</span>
                    </NavLink>
                    <NavLink class="nav-link submenu-item" href="/admin/instalador" title="Generar Paquete de Instalación (SA)" @onclick="OnAnyNavigate">
                        <i class="bi bi-box-seam-fill me-2"></i>
                        <span class="link-text">Generar Instalador</span>
                        <span class="badge bg-warning text-dark ms-1" style="font-size: 0.55rem;">SA</span>
                    </NavLink>
                    <a class="nav-link submenu-item" href="http://localhost:5096" target="_blank" title="Abrir Centro de Actualizaciones (SA - puerto 5096)">
                        <i class="bi bi-rocket-takeoff me-2"></i>
                        <span class="link-text">Centro de Actualizaciones</span>
                        <span class="badge bg-warning text-dark ms-1" style="font-size: 0.55rem;">SA</span>
                        <i class="bi bi-box-arrow-up-right ms-1 small opacity-50"></i>
                    </a>
                </div>
            </div>
        </div>
        
        <!-- Indicador de Estado de Backup -->
        @if (!IsCollapsed)
        {
            <div class="backup-status-indicator px-3 py-2 mt-2" title="@_backupTooltip">
                <a href="/configuracion/cloudsync" class="text-decoration-none d-flex align-items-center">
                    @if (_backupActualizado)
                    {
                        <i class="bi bi-cloud-check-fill text-success me-2"></i>
                        <small class="text-success">Backup sincronizado</small>
                    }
                    else if (_ultimoBackup.HasValue)
                    {
                        <i class="bi bi-cloud-slash text-warning me-2"></i>
                        <small class="text-warning">Backup desactualizado</small>
                    }
                    else
                    {
                        <i class="bi bi-cloud-slash text-muted me-2"></i>
                        <small class="text-muted">Sin backup</small>
                    }
                </a>
            </div>
        }
        else
        {
            <div class="backup-status-indicator text-center py-2 mt-2" title="@_backupTooltip">
                <a href="/configuracion/cloudsync" class="text-decoration-none">
                    @if (_backupActualizado)
                    {
                        <i class="bi bi-cloud-check-fill text-success"></i>
                    }
                    else if (_ultimoBackup.HasValue)
                    {
                        <i class="bi bi-cloud-slash text-warning"></i>
                    }
                    else
                    {
                        <i class="bi bi-cloud-slash text-muted"></i>
                    }
                </a>
            </div>
        }
    </div>
    </div>

@code {
    [Parameter] public bool IsCollapsed { get; set; }
    [Parameter] public EventCallback OnNavigateMobile { get; set; }
    
    private bool _previousIsCollapsed;
    private bool isSubMenuOpen = false;
    private bool isInformesSubMenuOpen = false;
    private bool isProveedoresSubMenuOpen = false;
    private bool isVentasSubMenuOpen = false;
    private bool isConfiguracionSubMenuOpen = false;
    private bool isInventarioSubMenuOpen = false;
    private bool isProductosSubMenuOpen = false;
    private bool isComprasSubMenuOpen = false;
    private bool isClientesSubMenuOpen = false;
    private bool isMesasSubMenuOpen = false;
    private string? logoImageDataUrl;
    private string? navMenuError;
    
    // Modo restaurante activo
    private bool _modoRestauranteActivo = false;
    
    // Modo gimnasio activo
    private bool _modoGimnasioActivo = false;
    private bool isGimnasioSubMenuOpen = false;
    
    // Modo agenda activo
    private bool _modoAgendaActivo = false;
    private bool isAgendaSubMenuOpen = false;
    
    // ========== TIPO DE NEGOCIO (Restaurante/Complejo/Taller) ==========
    private string _tipoNegocioMesas = "Restaurante";
    private string _nombreMenuMesas = "Restaurante";
    private string _iconoMenuMesas = "bi-grid-3x3-gap";
    private string _nombreEspacios = "Mesas";
    #pragma warning disable CS0414 // Campo singular reservado para UI futura
    private string _nombreEspacio = "Mesa";
    #pragma warning restore CS0414
    
    // Estado del backup para el indicador
    private bool _backupActualizado = false;
    private DateTime? _ultimoBackup;
    private string _backupTooltip = "Estado del backup";
    
    // Timer para actualizar estado de backup
    private System.Threading.Timer? _backupStatusTimer;
    private bool _disposed = false;

    protected override void OnParametersSet()
    {
        // Forzar re-render cuando IsCollapsed cambie
        if (_previousIsCollapsed != IsCollapsed)
        {
            _previousIsCollapsed = IsCollapsed;
            StateHasChanged();
        }
    }

    protected override async Task OnInitializedAsync()
    {
        try
        {
            await using var dbContext = await DbFactory.CreateDbContextAsync();
            var sucursal = await dbContext.Sucursal.OrderBy(s => s.Id).FirstOrDefaultAsync();

            if (sucursal?.Logo?.Length > 0)
            {
                var base64 = Convert.ToBase64String(sucursal.Logo);
                logoImageDataUrl = $"data:image/png;base64,{base64}";
            }

            // Cargar configuración del sistema para modo restaurante
            var config = await dbContext.ConfiguracionSistema.FirstOrDefaultAsync();
            _modoRestauranteActivo = config?.RestauranteModoActivo == true;
            _modoGimnasioActivo = config?.GimnasioModoActivo == true;
            _modoAgendaActivo = config?.AgendaModoActivo == true;
            
            // Cargar tipo de negocio para adaptar menú (Restaurante/Complejo/Taller)
            _tipoNegocioMesas = config?.TipoNegocioMesas ?? "Restaurante";
            ConfigurarNombresPorTipoNegocio();

            // Cargar estado del backup desde cache
            ActualizarEstadoBackup();
            
            // Iniciar timer para verificar estado de backup cada 30 segundos
            _backupStatusTimer = new System.Threading.Timer(
                async _ => await VerificarEstadoBackupAsync(),
                null,
                TimeSpan.FromSeconds(30),
                TimeSpan.FromSeconds(30));
        }
        catch (Exception ex)
        {
            navMenuError = $"Error en NavMenu: {ex.Message}";
            Console.WriteLine($"[ERROR NavMenu] {ex.Message}\n{ex.StackTrace}");
        }
    }
    
    private async Task VerificarEstadoBackupAsync()
    {
        if (_disposed) return;
        
        var estadoAnterior = _backupActualizado;
        var ultimoAnterior = _ultimoBackup;
        
        ActualizarEstadoBackup();
        
        // Solo refrescar UI si hubo cambios
        if (estadoAnterior != _backupActualizado || ultimoAnterior != _ultimoBackup)
        {
            await InvokeAsync(StateHasChanged);
        }
    }

    private void ActualizarEstadoBackup()
    {
        var (ultimoBackup, estado, sincronizado) = BackupStatusCache.ObtenerEstado();
        _ultimoBackup = ultimoBackup;
        _backupActualizado = BackupStatusCache.EstaActualizado(24);
        
        if (_backupActualizado)
        {
            _backupTooltip = $"Backup sincronizado: {ultimoBackup:dd/MM/yyyy HH:mm}";
        }
        else if (ultimoBackup.HasValue)
        {
            var horas = (DateTime.Now - ultimoBackup.Value).TotalHours;
            _backupTooltip = $"Último backup hace {horas:F0} horas";
        }
        else
        {
            _backupTooltip = "No hay backup sincronizado";
        }
    }
    
    /// <summary>
    /// Configura los nombres del módulo según el tipo de negocio seleccionado
    /// </summary>
    private void ConfigurarNombresPorTipoNegocio()
    {
        switch (_tipoNegocioMesas)
        {
            case "Taller":
                _nombreMenuMesas = "Taller";
                _iconoMenuMesas = "bi-car-front";
                _nombreEspacios = "Bahías";
                #pragma warning disable CS0414
                _nombreEspacio = "Bahía";
                #pragma warning restore CS0414
                break;
            case "Complejo":
                _nombreMenuMesas = "Complejo";
                _iconoMenuMesas = "bi-dribbble";
                _nombreEspacios = "Canchas";
                _nombreEspacio = "Cancha";
                break;
            default: // Restaurante
                _nombreMenuMesas = "Restaurante";
                _iconoMenuMesas = "bi-grid-3x3-gap";
                _nombreEspacios = "Mesas";
                _nombreEspacio = "Mesa";
                break;
        }
    }

    private void ToggleSubMenu() 
    {
        CloseAllSubMenusExcept("sub");
        isSubMenuOpen = !isSubMenuOpen;
        StateHasChanged();
    }

    private void ToggleInformesSubMenu() 
    {
        CloseAllSubMenusExcept("informes");
        isInformesSubMenuOpen = !isInformesSubMenuOpen;
        StateHasChanged();
    }

    private void ToggleProveedoresSubMenu() 
    {
        CloseAllSubMenusExcept("proveedores");
        isProveedoresSubMenuOpen = !isProveedoresSubMenuOpen;
        StateHasChanged();
    }

    private void ToggleVentasSubMenu()
    {
        CloseAllSubMenusExcept("ventas");
        isVentasSubMenuOpen = !isVentasSubMenuOpen;
        StateHasChanged();
    }

    private void ToggleConfiguracionSubMenu() 
    {
        CloseAllSubMenusExcept("configuracion");
        isConfiguracionSubMenuOpen = !isConfiguracionSubMenuOpen;
        StateHasChanged();
    }

    private void ToggleInventarioSubMenu()
    {
        CloseAllSubMenusExcept("inventario");
        isInventarioSubMenuOpen = !isInventarioSubMenuOpen;
        StateHasChanged();
    }

    private void ToggleProductosSubMenu()
    {
        CloseAllSubMenusExcept("productos");
        isProductosSubMenuOpen = !isProductosSubMenuOpen;
        StateHasChanged();
    }

    private void ToggleComprasSubMenu()
    {
        CloseAllSubMenusExcept("compras");
        isComprasSubMenuOpen = !isComprasSubMenuOpen;
        StateHasChanged();
    }

    private void ToggleClientesSubMenu()
    {
        CloseAllSubMenusExcept("clientes");
        isClientesSubMenuOpen = !isClientesSubMenuOpen;
        StateHasChanged();
    }

    private void ToggleMesasSubMenu()
    {
        CloseAllSubMenusExcept("mesas");
        isMesasSubMenuOpen = !isMesasSubMenuOpen;
        StateHasChanged();
    }

    private void ToggleGimnasioSubMenu()
    {
        CloseAllSubMenusExcept("gimnasio");
        isGimnasioSubMenuOpen = !isGimnasioSubMenuOpen;
        StateHasChanged();
    }

    private void ToggleAgendaSubMenu()
    {
        CloseAllSubMenusExcept("agenda");
        isAgendaSubMenuOpen = !isAgendaSubMenuOpen;
        StateHasChanged();
    }

    private void CloseAllSubMenusExcept(string except)
    {
        if (except != "sub") isSubMenuOpen = false;
        if (except != "informes") isInformesSubMenuOpen = false;
        if (except != "proveedores") isProveedoresSubMenuOpen = false;
        if (except != "ventas") isVentasSubMenuOpen = false;
        if (except != "configuracion") isConfiguracionSubMenuOpen = false;
        if (except != "inventario") isInventarioSubMenuOpen = false;
        if (except != "productos") isProductosSubMenuOpen = false;
        if (except != "compras") isComprasSubMenuOpen = false;
        if (except != "clientes") isClientesSubMenuOpen = false;
        if (except != "mesas") isMesasSubMenuOpen = false;
        if (except != "gimnasio") isGimnasioSubMenuOpen = false;
        if (except != "agenda") isAgendaSubMenuOpen = false;
    }

    private bool AnySubMenuOpen => isSubMenuOpen || isInformesSubMenuOpen || isProveedoresSubMenuOpen || 
                                   isVentasSubMenuOpen || isConfiguracionSubMenuOpen || isInventarioSubMenuOpen ||
                                   isProductosSubMenuOpen || isComprasSubMenuOpen || isClientesSubMenuOpen || 
                                   isMesasSubMenuOpen || isGimnasioSubMenuOpen || isAgendaSubMenuOpen;

    // Método para forzar actualización del componente
    private void ForceUpdate()
    {
        StateHasChanged();
    }

    private async Task OnAnyNavigate()
    {
        // Cerrar todos los submenús automáticamente al navegar
        isSubMenuOpen = false;
        isInformesSubMenuOpen = false;
        isProveedoresSubMenuOpen = false;
        isVentasSubMenuOpen = false;
        isConfiguracionSubMenuOpen = false;
        isInventarioSubMenuOpen = false;
        isProductosSubMenuOpen = false;
        isComprasSubMenuOpen = false;
        isClientesSubMenuOpen = false;
        isMesasSubMenuOpen = false;
        isGimnasioSubMenuOpen = false;
        isAgendaSubMenuOpen = false;
        
        StateHasChanged();
        
        if (OnNavigateMobile.HasDelegate)
        {
            await OnNavigateMobile.InvokeAsync();
        }
    }

    private record MenuItem(string Href, string Text, string Icon, NavLinkMatch Match = NavLinkMatch.Prefix);

    private List<MenuItem> MenuItems = new()
    {
        new("/", "Inicio", "bi bi-house-door", NavLinkMatch.All),
    };
    
    public void Dispose()
    {
        _disposed = true;
        _backupStatusTimer?.Dispose();
    }
}

@* Estilos específicos del NavMenu *@
<style>
    /* Solución correcta para scroll en flexbox:
       1. El contenedor padre (.sidebar) tiene overflow:hidden y min-height:0
       2. .nav-menu tiene flex:1, min-height:0, height:100%, overflow-y:auto
       3. Los hijos (.nav-pills, .submenu-container) NO deben tener overflow */
    
    /* Nav menu como contenedor de scroll principal */
    .nav-menu {
        -webkit-overflow-scrolling: touch;
        touch-action: pan-y;
        overscroll-behavior: contain;
        flex: 1 1 auto;
        min-height: 0;
        height: 100%;
        overflow-y: auto;
        overflow-x: hidden;
    }
    
    /* FORZAR submenús a expandir hacia abajo, SIN límite de altura */
    .submenu-container {
        position: relative !important;
        left: auto !important;
        right: auto !important;
        top: auto !important;
        bottom: auto !important;
        transform: none !important;
        z-index: auto !important;
        box-shadow: none !important;
        width: 100% !important;
    }
    
    .submenu-container.show {
        position: relative !important;
        display: block !important;
        float: none !important;
        max-height: none !important; /* SIN límite - expandir completamente */
        overflow: visible !important;
    }
    
    .submenu-items {
        overflow: visible !important; /* Contenido visible, scroll en nav-menu */
    }
    
    /* Ajustes responsive */
    @@media (max-width: 992px) {
        .nav-menu {
            font-size: 0.92rem;
        }
        .nav-menu .link-text { white-space: nowrap; }
        .nav-menu .submenu-items .nav-link { padding: .35rem .75rem; }
    }
    
    @@media (max-width: 768px) {
        .nav-menu { 
            width: 100% !important;
            max-width: 280px;
        }
        .nav-menu .sidebar-logo { max-width: 140px; }
    }
    
    /* Scrollbar fino (Chromium) */
    .nav-menu::-webkit-scrollbar { width: 4px; }
    .nav-menu::-webkit-scrollbar-track { background: transparent; }
    .nav-menu::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 2px; }
    .nav-menu::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.3); }
    
    /* Submenú de configuración: separar visualmente */
    .submenu-items .nav-link.submenu-item { font-size: .9rem; }
    .submenu-items .nav-link.submenu-item i { font-size: .95rem; }
    
    /* Encabezados de sección en submenú de informes */
    .submenu-section-header { 
        padding: .25rem .4rem .1rem .4rem; 
        margin-top: .15rem;
        opacity: 0.85;
    }
    .submenu-section-header .small { font-size: .65rem; letter-spacing: 0.3px; }
    
    /* Submenú de informes más compacto */
    .submenu-items .nav-link { padding-left: .4rem !important; }
    .submenu-items .nav-link i { margin-right: .4rem !important; font-size: .85rem; }
    
    /* Asegurar que el footer no tape elementos */
    .sidebar-footer { background: rgba(0,0,0,0.05); }
</style>
