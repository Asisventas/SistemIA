@inject IDbContextFactory<SistemIA.Models.AppDbContext> DbFactory
@using Microsoft.EntityFrameworkCore
@using Microsoft.AspNetCore.Components.Routing
@using SistemIA.Shared

<div class="nav-menu d-flex flex-column @(AnySubMenuOpen ? "has-submenu-open" : "")">
    <div class="nav-header p-3">
        @if (!string.IsNullOrEmpty(navMenuError))
        {
            <div class="alert alert-danger small p-2">@navMenuError</div>
        }

        <div class="brand-container mb-4">
            @if (!IsCollapsed)
            {
                @if (!string.IsNullOrEmpty(logoImageDataUrl))
                {
                    <img src="@logoImageDataUrl" class="sidebar-logo" alt="Logo Sucursal" />
                }
                else
                {
                    <i class="bi bi-share-fill sidebar-icon-placeholder"></i>
                }
                <h5 class="brand-name mt-2 text-white">SistemIA</h5>
            }
            else
            {
                <i class="bi bi-house-door fs-3 text-white" title="SistemIA"></i>
            }
        </div>
    </div>

    <nav class="nav nav-pills flex-column text-start">  
       @foreach (var item in MenuItems)  
       {  
           <div class="nav-item mb-1">  
               <NavLink class="nav-link" href="@item.Href" Match="@item.Match" title="@(IsCollapsed ? item.Text : "")" @onclick="OnAnyNavigate">  
                   <i class="@item.Icon me-2"></i>@if (!IsCollapsed){<span class="link-text">@item.Text</span>}  
               </NavLink>  
           </div>  
       }  

        <!-- Submenú de Productos -->
        <div class="nav-item mb-1">
            <button class="nav-link submenu-button w-100 d-flex align-items-center justify-content-between @(isProductosSubMenuOpen ? "active" : "")"
                    @onclick="ToggleProductosSubMenu"
                    type="button"
                    title="@(IsCollapsed ? "Productos" : "")">
                <span class="d-flex align-items-center">
                    <i class="bi bi-box-seam me-2"></i>
                    @if (!IsCollapsed)
                    {
                        <span class="link-text text-nowrap">Productos</span>
                    }
                </span>
                @if (!IsCollapsed)
                {
                    <i class="bi @(isProductosSubMenuOpen ? "bi-chevron-down" : "bi-chevron-right") ms-2"></i>
                }
            </button>

            <div class="submenu-container @(isProductosSubMenuOpen ? "show" : "collapse")">
                <div class="submenu-items">
                    <NavLink class="nav-link" href="/productos" title="@(IsCollapsed ? "Administrar" : "")" @onclick="OnAnyNavigate">
                        <i class="bi bi-gear me-2"></i>
                        @if (!IsCollapsed){<span class="link-text">Administrar</span>}
                    </NavLink>
                    <NavLink class="nav-link" href="/informes/productos-detallado" title="@(IsCollapsed ? "Listado Detallado" : "")" @onclick="OnAnyNavigate">
                        <i class="bi bi-list-check me-2"></i>
                        @if (!IsCollapsed){<span class="link-text">Listado Detallado</span>}
                    </NavLink>
                    <NavLink class="nav-link" href="/productos/movimientos" title="@(IsCollapsed ? "Movimientos" : "")" @onclick="OnAnyNavigate">
                        <i class="bi bi-arrow-left-right me-2"></i>
                        @if (!IsCollapsed){<span class="link-text">Movimientos</span>}
                    </NavLink>
                </div>
            </div>
        </div>

        <!-- Submenú de Ventas -->
        <div class="nav-item mb-1">
            <button class="nav-link submenu-button w-100 d-flex align-items-center justify-content-between @(isVentasSubMenuOpen ? "active" : "")"
                    @onclick="ToggleVentasSubMenu"
                    type="button"
                    title="@(IsCollapsed ? "Ventas" : "")">
                <span class="d-flex align-items-center">
                    <i class="bi bi-receipt-cutoff me-2"></i>
                    @if (!IsCollapsed)
                    {
                        <span class="link-text text-nowrap">Ventas</span>
                    }
                </span>
                @if (!IsCollapsed)
                {
                    <i class="bi @(isVentasSubMenuOpen ? "bi-chevron-down" : "bi-chevron-right") ms-2"></i>
                }
            </button>

            <div class="submenu-container @(isVentasSubMenuOpen ? "show" : "collapse")">
                <div class="submenu-items">
                    <NavLink class="nav-link" href="/ventas" title="@(IsCollapsed ? "Realizar Venta" : "")" @onclick="OnAnyNavigate">
                        <i class="bi bi-plus-square me-2"></i>
                        @if (!IsCollapsed){<span class="link-text">Realizar Venta</span>}
                    </NavLink>
                    <NavLink class="nav-link" href="/presupuestos/explorar" title="@(IsCollapsed ? "Presupuestos" : "")" @onclick="OnAnyNavigate">
                        <i class="bi bi-clipboard-check me-2"></i>
                        @if (!IsCollapsed){<span class="link-text">Presupuestos</span>}
                    </NavLink>
                    <NavLink class="nav-link" href="/ventas/explorar" title="@(IsCollapsed ? "Explorador de Ventas" : "")" @onclick="OnAnyNavigate">
                        <i class="bi bi-search me-2"></i>
                        @if (!IsCollapsed){<span class="link-text">Explorador de Ventas</span>}
                    </NavLink>
                    <hr class="my-1 mx-2 border-secondary opacity-25" />
                    <NavLink class="nav-link" href="/caja/cierre" title="@(IsCollapsed ? "Cierre de Caja" : "")" @onclick="OnAnyNavigate">
                        <i class="bi bi-cash-stack me-2"></i>
                        @if (!IsCollapsed){<span class="link-text">Cierre de Caja</span>}
                    </NavLink>
                    <NavLink class="nav-link" href="/caja/historial-cierres" title="@(IsCollapsed ? "Historial Cierres" : "")" @onclick="OnAnyNavigate">
                        <i class="bi bi-clock-history me-2"></i>
                        @if (!IsCollapsed){<span class="link-text">Historial Cierres</span>}
                    </NavLink>
                </div>
            </div>
        </div>

        <!-- Submenú de Compras -->
        <div class="nav-item mb-1">
            <button class="nav-link submenu-button w-100 d-flex align-items-center justify-content-between @(isComprasSubMenuOpen ? "active" : "")"
                    @onclick="ToggleComprasSubMenu"
                    type="button"
                    title="@(IsCollapsed ? "Compras" : "")">
                <span class="d-flex align-items-center">
                    <i class="bi bi-cart-fill me-2"></i>
                    @if (!IsCollapsed)
                    {
                        <span class="link-text text-nowrap">Compras</span>
                    }
                </span>
                @if (!IsCollapsed)
                {
                    <i class="bi @(isComprasSubMenuOpen ? "bi-chevron-down" : "bi-chevron-right") ms-2"></i>
                }
            </button>

            <div class="submenu-container @(isComprasSubMenuOpen ? "show" : "collapse")">
                <div class="submenu-items">
                    <NavLink class="nav-link" href="/compras" title="@(IsCollapsed ? "Registrar Compra" : "")" @onclick="OnAnyNavigate">
                        <i class="bi bi-plus-square me-2"></i>
                        @if (!IsCollapsed){<span class="link-text">Registrar Compra</span>}
                    </NavLink>
                    <NavLink class="nav-link" href="/compras/explorar" title="@(IsCollapsed ? "Explorador de Compras" : "")" @onclick="OnAnyNavigate">
                        <i class="bi bi-search me-2"></i>
                        @if (!IsCollapsed){<span class="link-text">Explorador de Compras</span>}
                    </NavLink>
                </div>
            </div>
        </div>

        <!-- Submenú de Clientes -->
        <div class="nav-item mb-1">
            <button class="nav-link submenu-button w-100 d-flex align-items-center justify-content-between @(isClientesSubMenuOpen ? "active" : "")"
                    @onclick="ToggleClientesSubMenu"
                    type="button"
                    title="@(IsCollapsed ? "Clientes" : "")">
                <span class="d-flex align-items-center">
                    <i class="bi bi-person-lines-fill me-2"></i>
                    @if (!IsCollapsed)
                    {
                        <span class="link-text text-nowrap">Clientes</span>
                    }
                </span>
                @if (!IsCollapsed)
                {
                    <i class="bi @(isClientesSubMenuOpen ? "bi-chevron-down" : "bi-chevron-right") ms-2"></i>
                }
            </button>

            <div class="submenu-container @(isClientesSubMenuOpen ? "show" : "collapse")">
                <div class="submenu-items">
                    <NavLink class="nav-link" href="/clientes/explorar" title="@(IsCollapsed ? "Explorar Clientes" : "")" @onclick="OnAnyNavigate">
                        <i class="bi bi-search me-2"></i>
                        @if (!IsCollapsed){<span class="link-text">Explorar Clientes</span>}
                    </NavLink>
                    <NavLink class="nav-link" href="/cobros" title="@(IsCollapsed ? "Cuentas por Cobrar" : "")" @onclick="OnAnyNavigate">
                        <i class="bi bi-cash-coin me-2"></i>
                        @if (!IsCollapsed){<span class="link-text">Cuentas por Cobrar</span>}
                    </NavLink>
                </div>
            </div>
        </div>

    <!-- Submenú de Proveedores (simplificado) -->
        <div class="nav-item mb-1">
            <button class="nav-link submenu-button w-100 d-flex align-items-center justify-content-between @(isProveedoresSubMenuOpen ? "active" : "")" 
                    @onclick="ToggleProveedoresSubMenu" 
                    type="button"
                    title="@(IsCollapsed ? "Proveedores" : "")">
                <span class="d-flex align-items-center">
                    <i class="bi bi-building-fill-gear me-2"></i>
                    @if (!IsCollapsed)
                    {
                        <span class="link-text text-nowrap">Proveedores</span>
                    }
                </span>
                @if (!IsCollapsed)
                {
                    <i class="bi @(isProveedoresSubMenuOpen ? "bi-chevron-down" : "bi-chevron-right") ms-2"></i>
                }
            </button>

            <div class="submenu-container @(isProveedoresSubMenuOpen ? "show" : "collapse")">
                <div class="submenu-items">
                    <NavLink class="nav-link" href="/proveedores/explorar" title="@(IsCollapsed ? "Explorar Proveedores" : "")" @onclick="OnAnyNavigate">
                        <i class="bi bi-search me-2"></i>
                        @if (!IsCollapsed){<span class="link-text">Explorar Proveedores</span>}
                    </NavLink>
                    <NavLink class="nav-link" href="/proveedores/sifen" title="@(IsCollapsed ? "Gestión SIFEN" : "")" @onclick="OnAnyNavigate">
                        <i class="bi bi-building-fill me-2"></i>
                        @if (!IsCollapsed){<span class="link-text">Gestión SIFEN</span>}
                    </NavLink>
                    <NavLink class="nav-link" href="/pagos-proveedores" title="@(IsCollapsed ? "Pagos a Proveedores" : "")" @onclick="OnAnyNavigate">
                        <i class="bi bi-cash-coin me-2"></i>
                        @if (!IsCollapsed){<span class="link-text">Pagos a Proveedores</span>}
                    </NavLink>
                </div>
            </div>
        </div>

        <!-- Submenú de Informes -->
        <div class="nav-item mb-1">
            <button class="nav-link submenu-button w-100 d-flex align-items-center justify-content-between @(isInformesSubMenuOpen ? "active" : "")" 
                    @onclick="ToggleInformesSubMenu" 
                    type="button"
                    title="@(IsCollapsed ? "Informes" : "")">
                <span class="d-flex align-items-center">
                    <i class="bi bi-file-earmark-bar-graph me-2"></i>
                    @if (!IsCollapsed)
                    {
                        <span class="link-text text-nowrap">Informes</span>
                    }
                </span>
                @if (!IsCollapsed)
                {
                    <i class="bi @(isInformesSubMenuOpen ? "bi-chevron-down" : "bi-chevron-right") ms-2"></i>
                }
            </button>

            <div class="submenu-container @(isInformesSubMenuOpen ? "show" : "collapse")">
                <div class="submenu-items">
                    <!-- Informes de Ventas -->
                    <div class="submenu-section-header">
                        <i class="bi bi-graph-up-arrow me-1"></i>
                        <span class="small fw-bold text-muted">INFORMES DE VENTAS</span>
                    </div>
                    <NavLink class="nav-link" href="/informes/ventas-agrupado" title="@(IsCollapsed ? "Ventas Agrupado" : "")" @onclick="OnAnyNavigate">
                        <i class="bi bi-layout-split me-2"></i>
                        @if (!IsCollapsed){<span class="link-text">Ventas Agrupado</span>}
                    </NavLink>
                    <NavLink class="nav-link" href="/informes/ventas-detallado" title="@(IsCollapsed ? "Ventas Detallada" : "")" @onclick="OnAnyNavigate">
                        <i class="bi bi-list-check me-2"></i>
                        @if (!IsCollapsed){<span class="link-text">Ventas Detallada</span>}
                    </NavLink>
                    
                    <hr class="my-1 mx-2 border-secondary opacity-25" />
                    
                    <!-- Informes de Compras -->
                    <div class="submenu-section-header">
                        <i class="bi bi-cart3 me-1"></i>
                        <span class="small fw-bold text-muted">INFORMES DE COMPRAS</span>
                    </div>
                    <NavLink class="nav-link" href="/informes/compras-general" title="@(IsCollapsed ? "Compras Agrupado" : "")" @onclick="OnAnyNavigate">
                        <i class="bi bi-layout-split me-2"></i>
                        @if (!IsCollapsed){<span class="link-text">Compras Agrupado</span>}
                    </NavLink>
                    <NavLink class="nav-link" href="/informes/compras-detallado" title="@(IsCollapsed ? "Compras Detallado" : "")" @onclick="OnAnyNavigate">
                        <i class="bi bi-list-check me-2"></i>
                        @if (!IsCollapsed){<span class="link-text">Compras Detallado</span>}
                    </NavLink>
                    
                    <hr class="my-1 mx-2 border-secondary opacity-25" />
                    
                    <!-- Informes Resumen de Caja -->
                    <div class="submenu-section-header">
                        <i class="bi bi-cash-stack me-1"></i>
                        <span class="small fw-bold text-muted">RESUMEN DE CAJA</span>
                    </div>
                    <NavLink class="nav-link" href="/informes/resumen-caja" title="@(IsCollapsed ? "Resumen de Caja" : "")" @onclick="OnAnyNavigate">
                        <i class="bi bi-journal-check me-2"></i>
                        @if (!IsCollapsed){<span class="link-text">Resumen de Caja</span>}
                    </NavLink>
                    <NavLink class="nav-link" href="/informes/ventas-clasificacion" title="@(IsCollapsed ? "Por Clasificación" : "")" @onclick="OnAnyNavigate">
                        <i class="bi bi-pie-chart me-2"></i>
                        @if (!IsCollapsed){<span class="link-text">Por Clasificación</span>}
                    </NavLink>
                    
                    <hr class="my-1 mx-2 border-secondary opacity-25" />
                    
                    <!-- Informes de Productos -->
                    <div class="submenu-section-header">
                        <i class="bi bi-box-seam me-1"></i>
                        <span class="small fw-bold text-muted">INFORMES DE PRODUCTOS</span>
                    </div>
                    <NavLink class="nav-link" href="/informes/productos-detallado" title="@(IsCollapsed ? "Productos Detallado" : "")" @onclick="OnAnyNavigate">
                        <i class="bi bi-list-check me-2"></i>
                        @if (!IsCollapsed){<span class="link-text">Productos Detallado</span>}
                    </NavLink>
                    
                    <hr class="my-1 mx-2 border-secondary opacity-25" />
                    
                    <!-- Informes de Clientes -->
                    <div class="submenu-section-header">
                        <i class="bi bi-person-lines-fill me-1"></i>
                        <span class="small fw-bold text-muted">INFORMES DE CLIENTES</span>
                    </div>
                    <NavLink class="nav-link" href="/informes/clientes" title="@(IsCollapsed ? "Listado de Clientes" : "")" @onclick="OnAnyNavigate">
                        <i class="bi bi-list-check me-2"></i>
                        @if (!IsCollapsed){<span class="link-text">Listado de Clientes</span>}
                    </NavLink>
                    <NavLink class="nav-link" href="/informes/cuentas-por-cobrar" title="@(IsCollapsed ? "Pendientes de Cobro" : "")" @onclick="OnAnyNavigate">
                        <i class="bi bi-cash-stack me-2"></i>
                        @if (!IsCollapsed){<span class="link-text">Pendientes de Cobro</span>}
                    </NavLink>
                    <NavLink class="nav-link" href="/cobros" title="@(IsCollapsed ? "Registro de Cobros" : "")" @onclick="OnAnyNavigate">
                        <i class="bi bi-receipt me-2"></i>
                        @if (!IsCollapsed){<span class="link-text">Registro de Cobros</span>}
                    </NavLink>
                    
                    <hr class="my-1 mx-2 border-secondary opacity-25" />
                    
                    <!-- Informes de Proveedores -->
                    <div class="submenu-section-header">
                        <i class="bi bi-building me-1"></i>
                        <span class="small fw-bold text-muted">INFORMES DE PROVEEDORES</span>
                    </div>
                    <NavLink class="nav-link" href="/informes/proveedores" title="@(IsCollapsed ? "Listado de Proveedores" : "")" @onclick="OnAnyNavigate">
                        <i class="bi bi-list-check me-2"></i>
                        @if (!IsCollapsed){<span class="link-text">Listado de Proveedores</span>}
                    </NavLink>
                    <NavLink class="nav-link" href="/informes/cuentas-por-pagar" title="@(IsCollapsed ? "Pendientes de Pago" : "")" @onclick="OnAnyNavigate">
                        <i class="bi bi-cash-coin me-2"></i>
                        @if (!IsCollapsed){<span class="link-text">Pendientes de Pago</span>}
                    </NavLink>
                    <NavLink class="nav-link" href="/pagos-proveedores/historial" title="@(IsCollapsed ? "Historial de Pagos" : "")" @onclick="OnAnyNavigate">
                        <i class="bi bi-clock-history me-2"></i>
                        @if (!IsCollapsed){<span class="link-text">Historial de Pagos</span>}
                    </NavLink>
                    
                    <hr class="my-1 mx-2 border-secondary opacity-25" />
                    
                    <!-- Informes de Personal/Asistencia -->
                    <div class="submenu-section-header">
                        <i class="bi bi-person-badge me-1"></i>
                        <span class="small fw-bold text-muted">INFORMES DE PERSONAL</span>
                    </div>
                    <NavLink class="nav-link" href="/informes-asistencia" title="@(IsCollapsed ? "Informes de Asistencia" : "")" @onclick="OnAnyNavigate">
                        <i class="bi bi-file-earmark-pdf me-2"></i>
                        @if (!IsCollapsed){<span class="link-text">Informe de Asistencia</span>}
                    </NavLink>
                    <NavLink class="nav-link" href="/listado-asistencia" title="@(IsCollapsed ? "Listado Asistencia" : "")" @onclick="OnAnyNavigate">
                        <i class="bi bi-list-ul me-2"></i>
                        @if (!IsCollapsed){<span class="link-text">Listado de Asistencia</span>}
                    </NavLink>
                </div>
            </div>
        </div>

        <!-- Submenú de Gestión de Personal -->
        <div class="nav-item mb-1">
            <button class="nav-link submenu-button w-100 d-flex align-items-center justify-content-between @(isSubMenuOpen ? "active" : "")" 
                    @onclick="ToggleSubMenu" 
                    type="button"
                    title="@(IsCollapsed ? "Gestión de Personal" : "")">
                <span class="d-flex align-items-center">
                    <i class="bi bi-people-fill me-2"></i>
                    @if (!IsCollapsed)
                    {
                        <span class="link-text text-nowrap">Gestión de Personal</span>
                    }
                </span>
                @if (!IsCollapsed)
                {
                    <i class="bi @(isSubMenuOpen ? "bi-chevron-down" : "bi-chevron-right") ms-2"></i>
                }
            </button>

            <div class="submenu-container @(isSubMenuOpen ? "show" : "collapse")">
                <div class="submenu-items">
                    <NavLink class="nav-link" href="/menu-usuarios" title="@(IsCollapsed ? "Usuarios" : "")" @onclick="OnAnyNavigate">
                        <i class="bi bi-person-badge me-2"></i>
                        @if (!IsCollapsed){<span class="link-text">Usuarios</span>}
                    </NavLink>
                    <NavLink class="nav-link" href="/registro-asistencia" title="@(IsCollapsed ? "Asistencia" : "")" @onclick="OnAnyNavigate">
                        <i class="bi bi-calendar-check me-2"></i>
                        @if (!IsCollapsed){<span class="link-text">Asistencia</span>}
                    </NavLink>
                    <NavLink class="nav-link" href="/registro-directo" Match="NavLinkMatch.All" title="@(IsCollapsed ? "Registro Directo" : "")" @onclick="OnAnyNavigate">
                        <i class="bi bi-camera-fill me-2"></i>
                        @if (!IsCollapsed){<span class="link-text">Registro Directo</span>}
                    </NavLink>
                    <NavLink class="nav-link" href="/horarios" title="@(IsCollapsed ? "Horarios" : "")" @onclick="OnAnyNavigate">
                        <i class="bi bi-clock me-2"></i>
                        @if (!IsCollapsed){<span class="link-text">Horarios</span>}
                    </NavLink>
                    <NavLink class="nav-link" href="/asignacionhorarios" title="@(IsCollapsed ? "Asignar" : "")" @onclick="OnAnyNavigate">
                        <i class="bi bi-calendar2-week me-2"></i>
                        @if (!IsCollapsed){<span class="link-text">Asignar</span>}
                    </NavLink>
                    <NavLink class="nav-link" href="/personal/permisos-usuarios" title="@(IsCollapsed ? "Permisos de Usuarios" : "")" @onclick="OnAnyNavigate">
                        <i class="bi bi-shield-lock me-2"></i>
                        @if (!IsCollapsed){<span class="link-text">Permisos de Usuarios</span>}
                    </NavLink>
                </div>
            </div>
        </div>

        <!-- Submenú de Inventario -->
        <div class="nav-item mb-1">
            <button class="nav-link submenu-button w-100 d-flex align-items-center justify-content-between @(isInventarioSubMenuOpen ? "active" : "")"
                    @onclick="ToggleInventarioSubMenu"
                    type="button"
                    title="@(IsCollapsed ? "Inventario" : "")">
                <span class="d-flex align-items-center">
                    <i class="bi bi-archive me-2"></i>
                    @if (!IsCollapsed)
                    {
                        <span class="link-text text-nowrap">Inventario</span>
                    }
                </span>
                @if (!IsCollapsed)
                {
                    <i class="bi @(isInventarioSubMenuOpen ? "bi-chevron-down" : "bi-chevron-right") ms-2"></i>
                }
            </button>

            <div class="submenu-container @(isInventarioSubMenuOpen ? "show" : "collapse")">
                <div class="submenu-items">
                    <NavLink class="nav-link" href="/inventario/depositos" title="@(IsCollapsed ? "Depósitos" : "")" @onclick="OnAnyNavigate">
                        <i class="bi bi-building-down me-2"></i>
                        @if (!IsCollapsed){<span class="link-text">Depósitos</span>}
                    </NavLink>
                    <NavLink class="nav-link" href="/inventario/movimientos" title="@(IsCollapsed ? "Movimientos" : "")" @onclick="OnAnyNavigate">
                        <i class="bi bi-arrow-left-right me-2"></i>
                        @if (!IsCollapsed){<span class="link-text">Movimientos</span>}
                    </NavLink>
                        <NavLink class="nav-link" href="/inventario/ajustes" title="@(IsCollapsed ? "Ajustes de Stock" : "")" @onclick="OnAnyNavigate">
                            <i class="bi bi-wrench me-2"></i>
                            @if (!IsCollapsed){<span class="link-text">Ajustes de Stock</span>}
                        </NavLink>
                        <NavLink class="nav-link" href="/inventario/transferencias" title="@(IsCollapsed ? "Transferencias" : "")" @onclick="OnAnyNavigate">
                            <i class="bi bi-arrow-left-right me-2"></i>
                            @if (!IsCollapsed){<span class="link-text">Transferencias</span>}
                        </NavLink>
                        <NavLink class="nav-link" href="/seleccionar-sucursal" title="@(IsCollapsed ? "Cambiar Sucursal" : "")">
                            <i class="bi bi-arrow-left-right me-2"></i>
                            @if (!IsCollapsed){<span class="link-text">Cambiar Sucursal</span>}
                        </NavLink>
                        <NavLink class="nav-link" href="/inventario/ajustes/explorar" title="@(IsCollapsed ? "Explorar Ajustes" : "")" @onclick="OnAnyNavigate">
                            <i class="bi bi-search me-2"></i>
                            @if (!IsCollapsed){<span class="link-text">Explorar Ajustes</span>}
                        </NavLink>
                </div>
            </div>
        </div>
    </nav>

    <div class="sidebar-footer mt-auto pb-3">
        <!-- Submenú de Configuración -->
        <div class="nav-item mb-1">
            <button class="nav-link submenu-button w-100 d-flex align-items-center justify-content-between @(isConfiguracionSubMenuOpen ? "active" : "")" 
                    @onclick="ToggleConfiguracionSubMenu" 
                    type="button"
                    title="@(IsCollapsed ? "Configuración" : "")">
                <span class="d-flex align-items-center">
                    <i class="bi bi-gear-fill me-2"></i>
                    @if (!IsCollapsed)
                    {
                        <span class="link-text">Configuración</span>
                    }
                </span>
                @if (!IsCollapsed)
                {
                    <i class="bi @(isConfiguracionSubMenuOpen ? "bi-chevron-down" : "bi-chevron-right") ms-2"></i>
                }
            </button>
            
            <div class="submenu-container @(isConfiguracionSubMenuOpen && !IsCollapsed ? "show" : "collapse")">
                <div class="submenu-items pe-1">
                    <!-- Empresa -->
                    <div class="submenu-section-header">
                        <i class="bi bi-building me-1"></i>
                        <span class="small fw-bold text-muted">EMPRESA</span>
                    </div>
                    <NavLink class="nav-link submenu-item" href="/sucursales" title="Gestión de Sucursales" @onclick="OnAnyNavigate">
                        <i class="bi bi-building me-2"></i>
                        <span class="link-text">Sucursales</span>
                    </NavLink>
                    <NavLink class="nav-link submenu-item" href="/configuracion/sociedad" title="Datos del Emisor (Sociedad)" @onclick="OnAnyNavigate">
                        <i class="bi bi-shop me-2"></i>
                        <span class="link-text">Sociedad (Emisor)</span>
                    </NavLink>
                    <NavLink class="nav-link submenu-item" href="/configuracion/cajas" title="Configuración de Cajas" @onclick="OnAnyNavigate">
                        <i class="bi bi-upc-scan me-2"></i>
                        <span class="link-text">Cajas</span>
                    </NavLink>
                    
                    <hr class="my-1 mx-2 border-secondary opacity-25" />
                    
                    <!-- Catálogos -->
                    <div class="submenu-section-header">
                        <i class="bi bi-list-ul me-1"></i>
                        <span class="small fw-bold text-muted">CATÁLOGOS</span>
                    </div>
                    <NavLink class="nav-link submenu-item" href="/configuracion/tipos-pago" title="Tipos de Pago" @onclick="OnAnyNavigate">
                        <i class="bi bi-credit-card me-2"></i>
                        <span class="link-text">Tipos de Pago</span>
                    </NavLink>
                    <NavLink class="nav-link submenu-item" href="/configuracion/tipos-documento" title="Tipos de Documento" @onclick="OnAnyNavigate">
                        <i class="bi bi-file-text me-2"></i>
                        <span class="link-text">Tipos de Documento</span>
                    </NavLink>
                    <NavLink class="nav-link submenu-item" href="/configuracion/tipos-iva" title="Gestión de Tipos de IVA" @onclick="OnAnyNavigate">
                        <i class="bi bi-percent me-2"></i>
                        <span class="link-text">Tipos de IVA</span>
                    </NavLink>
                    <NavLink class="nav-link submenu-item" href="/configuracion/listas-precios" title="Gestión de Listas de Precios" @onclick="OnAnyNavigate">
                        <i class="bi bi-currency-exchange me-2"></i>
                        <span class="link-text">Listas de Precios</span>
                    </NavLink>
                    
                    <hr class="my-1 mx-2 border-secondary opacity-25" />
                    
                    <!-- Sistema -->
                    <div class="submenu-section-header">
                        <i class="bi bi-gear me-1"></i>
                        <span class="small fw-bold text-muted">SISTEMA</span>
                    </div>
                    <NavLink class="nav-link submenu-item" href="/configuracion/tema" title="Configuración de Tema" @onclick="OnAnyNavigate">
                        <i class="bi bi-palette me-2"></i>
                        <span class="link-text">Tema</span>
                    </NavLink>
                    <NavLink class="nav-link submenu-item" href="/configuracion/auditoria" title="Auditoría del Sistema" @onclick="OnAnyNavigate">
                        <i class="bi bi-journal-text me-2"></i>
                        <span class="link-text">Auditoría</span>
                    </NavLink>
                    <NavLink class="nav-link submenu-item" href="/actualizacion-sistema" title="Actualización del Sistema" @onclick="OnAnyNavigate">
                        <i class="bi bi-arrow-repeat me-2"></i>
                        <span class="link-text">Actualización</span>
                    </NavLink>
                    
                    <hr class="my-1 mx-2 border-secondary opacity-25" />
                    
                    <!-- Desarrollo -->
                    <div class="submenu-section-header">
                        <i class="bi bi-code-slash me-1"></i>
                        <span class="small fw-bold text-muted">DESARROLLO</span>
                    </div>
                    <NavLink class="nav-link submenu-item" href="/pruebas-xml" title="Pruebas XML SIFEN" @onclick="OnAnyNavigate">
                        <i class="bi bi-filetype-xml me-2"></i>
                        <span class="link-text">Pruebas XML SIFEN</span>
                    </NavLink>
                    <NavLink class="nav-link submenu-item" href="/admin/instalador" title="Generar Paquete de Instalación" @onclick="OnAnyNavigate">
                        <i class="bi bi-box-seam-fill me-2"></i>
                        <span class="link-text">Generar Instalador</span>
                    </NavLink>
                </div>
            </div>
        </div>
    </div>
    </div>

@code {
    [Parameter] public bool IsCollapsed { get; set; }
    [Parameter] public EventCallback OnNavigateMobile { get; set; }
    
    private bool _previousIsCollapsed;
    private bool isSubMenuOpen = false;
    private bool isInformesSubMenuOpen = false;
    private bool isProveedoresSubMenuOpen = false;
    private bool isVentasSubMenuOpen = false;
    private bool isConfiguracionSubMenuOpen = false;
    private bool isInventarioSubMenuOpen = false;
    private bool isProductosSubMenuOpen = false;
    private bool isComprasSubMenuOpen = false;
    private bool isClientesSubMenuOpen = false;
    private string? logoImageDataUrl;
    private string? navMenuError;
    // Sin indicadores de caja en la barra lateral (se muestran en el Panel de control)

    protected override void OnParametersSet()
    {
        // Forzar re-render cuando IsCollapsed cambie
        if (_previousIsCollapsed != IsCollapsed)
        {
            _previousIsCollapsed = IsCollapsed;
            StateHasChanged();
        }
    }

    protected override async Task OnInitializedAsync()
    {
        try
        {
            await using var dbContext = await DbFactory.CreateDbContextAsync();
            var sucursal = await dbContext.Sucursal.OrderBy(s => s.Id).FirstOrDefaultAsync();

            if (sucursal?.Logo?.Length > 0)
            {
                var base64 = Convert.ToBase64String(sucursal.Logo);
                logoImageDataUrl = $"data:image/png;base64,{base64}";
            }

            // Indicadores de caja solo se muestran en el Panel; aquí no cargamos.
        }
        catch (Exception ex)
        {
            navMenuError = $"Error en NavMenu: {ex.Message}";
            Console.WriteLine($"[ERROR NavMenu] {ex.Message}\n{ex.StackTrace}");
        }
    }

    private void ToggleSubMenu() 
    {
        CloseAllSubMenusExcept("sub");
        isSubMenuOpen = !isSubMenuOpen;
        StateHasChanged();
    }

    private void ToggleInformesSubMenu() 
    {
        CloseAllSubMenusExcept("informes");
        isInformesSubMenuOpen = !isInformesSubMenuOpen;
        StateHasChanged();
    }

    private void ToggleProveedoresSubMenu() 
    {
        CloseAllSubMenusExcept("proveedores");
        isProveedoresSubMenuOpen = !isProveedoresSubMenuOpen;
        StateHasChanged();
    }

    private void ToggleVentasSubMenu()
    {
        CloseAllSubMenusExcept("ventas");
        isVentasSubMenuOpen = !isVentasSubMenuOpen;
        StateHasChanged();
    }

    private void ToggleConfiguracionSubMenu() 
    {
        CloseAllSubMenusExcept("configuracion");
        isConfiguracionSubMenuOpen = !isConfiguracionSubMenuOpen;
        StateHasChanged();
    }

    private void ToggleInventarioSubMenu()
    {
        CloseAllSubMenusExcept("inventario");
        isInventarioSubMenuOpen = !isInventarioSubMenuOpen;
        StateHasChanged();
    }

    private void ToggleProductosSubMenu()
    {
        CloseAllSubMenusExcept("productos");
        isProductosSubMenuOpen = !isProductosSubMenuOpen;
        StateHasChanged();
    }

    private void ToggleComprasSubMenu()
    {
        CloseAllSubMenusExcept("compras");
        isComprasSubMenuOpen = !isComprasSubMenuOpen;
        StateHasChanged();
    }

    private void ToggleClientesSubMenu()
    {
        CloseAllSubMenusExcept("clientes");
        isClientesSubMenuOpen = !isClientesSubMenuOpen;
        StateHasChanged();
    }

    private void CloseAllSubMenusExcept(string except)
    {
        if (except != "sub") isSubMenuOpen = false;
        if (except != "informes") isInformesSubMenuOpen = false;
        if (except != "proveedores") isProveedoresSubMenuOpen = false;
        if (except != "ventas") isVentasSubMenuOpen = false;
        if (except != "configuracion") isConfiguracionSubMenuOpen = false;
        if (except != "inventario") isInventarioSubMenuOpen = false;
        if (except != "productos") isProductosSubMenuOpen = false;
        if (except != "compras") isComprasSubMenuOpen = false;
        if (except != "clientes") isClientesSubMenuOpen = false;
    }

    private bool AnySubMenuOpen => isSubMenuOpen || isInformesSubMenuOpen || isProveedoresSubMenuOpen || 
                                   isVentasSubMenuOpen || isConfiguracionSubMenuOpen || isInventarioSubMenuOpen ||
                                   isProductosSubMenuOpen || isComprasSubMenuOpen || isClientesSubMenuOpen;

    // Método para forzar actualización del componente
    private void ForceUpdate()
    {
        StateHasChanged();
    }

    private async Task OnAnyNavigate()
    {
        // Cerrar todos los submenús automáticamente al navegar
        isSubMenuOpen = false;
        isInformesSubMenuOpen = false;
        isProveedoresSubMenuOpen = false;
        isVentasSubMenuOpen = false;
        isConfiguracionSubMenuOpen = false;
        isInventarioSubMenuOpen = false;
        isProductosSubMenuOpen = false;
        isComprasSubMenuOpen = false;
        isClientesSubMenuOpen = false;
        
        StateHasChanged();
        
        if (OnNavigateMobile.HasDelegate)
        {
            await OnNavigateMobile.InvokeAsync();
        }
    }

    private record MenuItem(string Href, string Text, string Icon, NavLinkMatch Match = NavLinkMatch.Prefix);

    private List<MenuItem> MenuItems = new()
    {
        new("/", "Inicio", "bi bi-house-door", NavLinkMatch.All),
    };
}

@* Estilos específicos del NavMenu *@
<style>
    /* Solución correcta para scroll en flexbox:
       1. El contenedor padre (.sidebar) tiene overflow:hidden y min-height:0
       2. .nav-menu tiene flex:1, min-height:0, height:100%, overflow-y:auto
       3. Los hijos (.nav-pills, .submenu-container) NO deben tener overflow */
    
    /* Nav menu como contenedor de scroll principal */
    .nav-menu {
        -webkit-overflow-scrolling: touch;
        touch-action: pan-y;
        overscroll-behavior: contain;
        flex: 1 1 auto;
        min-height: 0;
        height: 100%;
        overflow-y: auto;
        overflow-x: hidden;
    }
    
    /* FORZAR submenús a expandir hacia abajo, SIN límite de altura */
    .submenu-container {
        position: relative !important;
        left: auto !important;
        right: auto !important;
        top: auto !important;
        bottom: auto !important;
        transform: none !important;
        z-index: auto !important;
        box-shadow: none !important;
        width: 100% !important;
    }
    
    .submenu-container.show {
        position: relative !important;
        display: block !important;
        float: none !important;
        max-height: none !important; /* SIN límite - expandir completamente */
        overflow: visible !important;
    }
    
    .submenu-items {
        overflow: visible !important; /* Contenido visible, scroll en nav-menu */
    }
    
    /* Ajustes responsive */
    @@media (max-width: 992px) {
        .nav-menu {
            font-size: 0.92rem;
        }
        .nav-menu .link-text { white-space: nowrap; }
        .nav-menu .submenu-items .nav-link { padding: .35rem .75rem; }
    }
    
    @@media (max-width: 768px) {
        .nav-menu { 
            width: 100% !important;
            max-width: 280px;
        }
        .nav-menu .sidebar-logo { max-width: 140px; }
    }
    
    /* Scrollbar fino (Chromium) */
    .nav-menu::-webkit-scrollbar { width: 4px; }
    .nav-menu::-webkit-scrollbar-track { background: transparent; }
    .nav-menu::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 2px; }
    .nav-menu::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.3); }
    
    /* Submenú de configuración: separar visualmente */
    .submenu-items .nav-link.submenu-item { font-size: .9rem; }
    .submenu-items .nav-link.submenu-item i { font-size: .95rem; }
    
    /* Encabezados de sección en submenú de informes */
    .submenu-section-header { 
        padding: .25rem .4rem .1rem .4rem; 
        margin-top: .15rem;
        opacity: 0.85;
    }
    .submenu-section-header .small { font-size: .65rem; letter-spacing: 0.3px; }
    
    /* Submenú de informes más compacto */
    .submenu-items .nav-link { padding-left: .4rem !important; }
    .submenu-items .nav-link i { margin-right: .4rem !important; font-size: .85rem; }
    
    /* Asegurar que el footer no tape elementos */
    .sidebar-footer { background: rgba(0,0,0,0.05); }
</style>
