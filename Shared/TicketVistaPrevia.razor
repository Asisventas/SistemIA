@* Componente de Vista Previa de Ticket para Impresión - Formato Factura Paraguay *@
@using SistemIA.Models
@using SistemIA.Services
@using Microsoft.EntityFrameworkCore
@using System.Globalization
@using System.Text
@using QRCoder
@inject IDbContextFactory<AppDbContext> DbFactory
@inject IJSRuntime JS
@inject ImpresionDirectaService ImpresionService

<div class="modal fade show d-block" tabindex="-1" style="background:rgba(0,0,0,0.7);" @onclick="CerrarModal">
    <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable" @onclick:stopPropagation="true">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white py-2">
                <h5 class="modal-title">
                    <i class="bi bi-receipt me-2"></i>Vista Previa del Ticket
                </h5>
                <button type="button" class="btn-close btn-close-white" @onclick="CerrarModal"></button>
            </div>
            <div class="modal-body p-0" style="max-height: 70vh; overflow-y: auto; background: #e9ecef;">
                @if (_cargando)
                {
                    <div class="text-center py-5">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Cargando...</span>
                        </div>
                        <p class="mt-2">Cargando datos del ticket...</p>
                    </div>
                }
                else if (_venta == null)
                {
                    <div class="alert alert-warning m-3">
                        <i class="bi bi-exclamation-triangle me-2"></i>
                        No se encontró la venta especificada.
                    </div>
                }
                else
                {
                    <div class="d-flex justify-content-center py-3">
                        <div class="ticket-preview-container" id="ticketPreviewContent">
                            @* ═══════════════════ ENCABEZADO ═══════════════════ *@
                            <div class="ticket-header">
                                @if (_caja?.MostrarLogo == true && _sucursal?.Logo?.Length > 0)
                                {
                                    <div class="ticket-logo">
                                        <img src="@GetLogoBase64()" alt="Logo" />
                                    </div>
                                }
                                <div class="ticket-empresa">@NombreEmisorTicket</div>
                                <div class="ticket-ruc">RUC: @RucEmisorTicket</div>

                                @if (!string.IsNullOrEmpty(DireccionEmisorTicket))
                                {
                                    <div class="ticket-direccion">@DireccionEmisorTicket</div>
                                }

                                @if (!string.IsNullOrEmpty(TelefonoEmisorTicket))
                                {
                                    <div class="ticket-telefono">Tel: @TelefonoEmisorTicket</div>
                                }

                                @if (!string.IsNullOrEmpty(_sucursal?.RubroEmpresa))
                                {
                                    <div class="ticket-actividad">@_sucursal.RubroEmpresa</div>
                                }
                            </div>

                            <div class="ticket-separator-double"></div>

                            @* ═══════════════════ TIPO DOCUMENTO ═══════════════════ *@
                            <div class="ticket-tipo-doc">
                                @{
                                    var condicionVenta = _tipoPago?.Nombre?.ToUpper() ?? "";
                                    var esRemision = condicionVenta.Contains("REMISIÓN") || condicionVenta.Contains("REMISION");
                                }
                                @if (esRemision)
                                {
                                    @condicionVenta
                                }
                                else if (_caja?.TipoFacturacion == "ELECTRONICA")
                                {
                                    @("FACTURA ELECTRÓNICA")
                                }
                                else
                                {
                                    @(_venta.TipoDocumento?.ToUpper() ?? "FACTURA")
                                }
                            </div>

                            <div class="ticket-separator-double"></div>

                            @* ═══════════════════ DATOS FACTURA ═══════════════════ *@
                            <div class="ticket-info">
                                <div class="ticket-row">
                                    <span class="ticket-label">Timbrado:</span>
                                    <span class="ticket-value">@(_venta.Timbrado ?? _caja?.Timbrado ?? "-")</span>
                                </div>
                                <div class="ticket-row">
                                    <span class="ticket-label">Fecha Inicio Vigencia:</span>
                                    <span class="ticket-value">@(_caja?.VigenciaDel?.ToString("dd/MM/yyyy") ?? "-")</span>
                                </div>
                                <div class="ticket-row">
                                    <span class="ticket-label">Válido Hasta:</span>
                                    <span class="ticket-value">@(_caja?.VigenciaAl?.ToString("dd/MM/yyyy") ?? "-")</span>
                                </div>
                            </div>

                            <div class="ticket-separator"></div>

                            <div class="ticket-info">
                                <div class="ticket-row">
                                    <span class="ticket-label">Factura Nro:</span>
                                    <span class="ticket-value ticket-factura-nro">@FormatearNumeroFactura()</span>
                                </div>
                                <div class="ticket-row">
                                    <span class="ticket-label">Fecha de Emisión:</span>
                                    <span class="ticket-value">@_venta.Fecha.ToString("dd/MM/yyyy HH:mm")</span>
                                </div>
                            </div>

                            <div class="ticket-separator-double"></div>

                            @* ═══════════════════ CLIENTE ═══════════════════ *@
                            <div class="ticket-cliente">
                                <div class="ticket-row">
                                    <span class="ticket-label">Cliente:</span>
                                    <span class="ticket-value">@(_cliente?.RazonSocial ?? "SIN NOMBRE")</span>
                                </div>
                                <div class="ticket-row">
                                    <span class="ticket-label">RUC/CI:</span>
                                    <span class="ticket-value">@FormatearRucConDv(_cliente?.RUC, _cliente?.DV)</span>
                                </div>
                                @if (!string.IsNullOrEmpty(_cliente?.Direccion))
                                {
                                    <div class="ticket-row">
                                        <span class="ticket-label">Dirección:</span>
                                        <span class="ticket-value">@_cliente.Direccion</span>
                                    </div>
                                }
                            </div>

                            <div class="ticket-separator"></div>

                            @* ═══════════════════ CONDICIÓN DE VENTA ═══════════════════ *@
                            <div class="ticket-condicion">
                                <div class="ticket-row">
                                    <span class="ticket-label">Condición de Venta:</span>
                                    <span class="ticket-value">@(_tipoPago?.Nombre?.ToUpper() ?? "CONTADO")</span>
                                </div>
                            </div>

                            <div class="ticket-separator-double"></div>

                            @* ═══════════════════ ENCABEZADO DETALLE ═══════════════════ *@
                            <div class="ticket-detalle-header">
                                <span class="col-cant">CANT.</span>
                                <span class="col-desc">DESCRIPCIÓN</span>
                                @if (_modoFarmaciaActivo)
                                {
                                    <span class="col-descuento">%Desc</span>
                                    <span class="col-pmin">P.MIN.</span>
                                }
                                <span class="col-importe">IMPORTE</span>
                                <span class="col-tiva">IVA</span>
                            </div>

                            <div class="ticket-separator"></div>

                            @* ═══════════════════ DETALLE DE PRODUCTOS ═══════════════════ *@
                            <div class="ticket-detalle">
                                @foreach (var det in _detalles)
                                {
                                    <div class="ticket-detalle-item">
                                        <span class="col-cant">@FormatearCantidad(det.Cantidad)</span>
                                        <span class="col-desc">@det.Producto?.Descripcion</span>
                                        @if (_modoFarmaciaActivo)
                                        {
                                            <span class="col-descuento">@(det.PorcentajeDescuento.HasValue && det.PorcentajeDescuento.Value > 0 ? det.PorcentajeDescuento.Value.ToString("N2") : "-")</span>
                                            <span class="col-pmin">@(det.PrecioMinisterio.HasValue ? FormatearImporte(det.PrecioMinisterio.Value) : "-")</span>
                                        }
                                        <span class="col-importe">@FormatearImporte(det.Importe)</span>
                                        <span class="col-tiva">@ObtenerCodigoIva(det)</span>
                                    </div>
                                }
                            </div>

                            <div class="ticket-separator-double"></div>

                            @* ═══════════════════ SUBTOTALES ═══════════════════ *@
                            <div class="ticket-subtotales">
                                <div class="ticket-row">
                                    <span class="ticket-label">SUB-TOTALES:</span>
                                    <span class="col-exenta-total">@(_totalExentas > 0 ? FormatearImporte(_totalExentas) : "-")</span>
                                    <span class="col-iva5-total">@(_totalConIva5 > 0 ? FormatearImporte(_totalConIva5) : "-")</span>
                                    <span class="col-iva10-total">@(_totalConIva10 > 0 ? FormatearImporte(_totalConIva10) : "-")</span>
                                </div>
                            </div>

                            <div class="ticket-separator"></div>

                            @* ═══════════════════ TOTAL GENERAL ═══════════════════ *@
                            <div class="ticket-total-section">
                                <div class="ticket-row ticket-total">
                                    <span class="ticket-label">TOTAL A PAGAR:</span>
                                    <span class="ticket-value">Gs. @FormatearImporte(_venta.Total)</span>
                                </div>
                            </div>

                            <div class="ticket-separator-double"></div>

                            @* ═══════════════════ LIQUIDACIÓN IVA ═══════════════════ *@
                            <div class="ticket-liquidacion">
                                <div class="ticket-row ticket-liquidacion-header">
                                    <span>SUB TOTALES</span>
                                    <span class="liq-header-right">LIQUIDACION</span>
                                    <span class="liq-header-iva">IVA</span>
                                </div>
                                <div class="ticket-liquidacion-rows">
                                    <div class="liquidacion-row">
                                        <span class="liq-label">Exentas:</span>
                                        <span class="liq-value">@(_totalExentas > 0 ? FormatearImporte(_totalExentas) : "-")</span>
                                        <span class="liq-iva">0</span>
                                    </div>
                                    <div class="liquidacion-row">
                                        <span class="liq-label">Gravado 5%:</span>
                                        <span class="liq-value">@(_totalConIva5 > 0 ? FormatearImporte(_totalConIva5) : "-")</span>
                                        <span class="liq-iva">@(_totalIva5 > 0 ? FormatearImporte(_totalIva5) : "-")</span>
                                    </div>
                                    <div class="liquidacion-row">
                                        <span class="liq-label">Gravado 10%:</span>
                                        <span class="liq-value">@(_totalConIva10 > 0 ? FormatearImporte(_totalConIva10) : "-")</span>
                                        <span class="liq-iva">@(_totalIva10 > 0 ? FormatearImporte(_totalIva10) : "-")</span>
                                    </div>
                                    <div class="liquidacion-row liquidacion-total">
                                        <span class="liq-label">TOTAL:</span>
                                        <span class="liq-value"></span>
                                        <span class="liq-iva">@FormatearImporte(_totalIva5 + _totalIva10)</span>
                                    </div>
                                </div>
                            </div>

                            <div class="ticket-separator-double"></div>

                            @* ═══════════════════ SECCIÓN SIFEN (FACTURA ELECTRÓNICA) - FORMATO KUDE TICKET ═══════════════════ *@
                            @if (_esFacturaElectronica)
                            {
                                <div class="ticket-sifen-section">
                                    @* Layout horizontal: QR a la izquierda, textos a la derecha *@
                                    <div class="ticket-sifen-layout">
                                        @* QR Code compacto *@
                                        <div class="ticket-qr-box">
                                            @if (!string.IsNullOrEmpty(_qrDataUrl))
                                            {
                                                <img src="@_qrDataUrl" alt="QR" class="ticket-qr" />
                                            }
                                            else
                                            {
                                                <div class="ticket-qr-empty">QR</div>
                                            }
                                        </div>
                                        
                                        @* Textos validación *@
                                        <div class="ticket-sifen-info">
                                            <div class="ticket-sifen-text">
                                                Consulte la validez de este documento en:
                                            </div>
                                            <div class="ticket-sifen-url">ekuatia.set.gov.py/consultas/</div>
                                        </div>
                                    </div>
                                    
                                    @* CDC en una línea separada *@
                                    <div class="ticket-cdc-row">
                                        <span class="ticket-cdc-label">CDC:</span>
                                        @if (!string.IsNullOrWhiteSpace(_venta?.CDC))
                                        {
                                            <span class="ticket-cdc-value">@_venta.CDC</span>
                                        }
                                        else
                                        {
                                            <span class="ticket-cdc-pending">Pendiente SIFEN</span>
                                        }
                                    </div>
                                    
                                    @* Nota legal compacta *@
                                    <div class="ticket-sifen-nota">
                                        REPRESENTACIÓN GRÁFICA DE DOCUMENTO ELECTRÓNICO (XML)
                                    </div>
                                </div>
                            }

                            @* ═══════════════════ PIE ═══════════════════ *@
                            <div class="ticket-footer">
                                <div class="ticket-gracias">¡GRACIAS POR SU PREFERENCIA!</div>
                                <div class="ticket-sistema">SistemIA - Sistema de Gestión</div>
                            </div>
                        </div>
                    </div>
                }
            </div>
            <div class="modal-footer bg-light">
                <div class="d-flex w-100 justify-content-between align-items-center flex-wrap gap-2">
                    <div class="btn-group">
                        <button type="button" class="btn btn-outline-secondary" @onclick="CerrarModal">
                            <i class="bi bi-x-lg me-1"></i>Cerrar
                        </button>
                        <a href="/ventas/explorar" class="btn btn-outline-primary">
                            <i class="bi bi-journal-text me-1"></i>Ver Ventas
                        </a>
                    </div>
                    <button type="button" class="btn btn-success" @onclick="ImprimirTicketWindows" disabled="@_imprimiendo" title="Imprimir ticket">
                        @if (_imprimiendo)
                        {
                            <span class="spinner-border spinner-border-sm me-1"></span>
                        }
                        else
                        {
                            <i class="bi bi-printer me-1"></i>
                        }
                        Imprimir
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

@* Modal de Selección de Impresora *@
@if (_mostrarSelectorImpresora)
{
    <SelectorImpresora 
        Ticket="_datosTicketParaImpresion"
        FormatoInicial="@(_caja?.FormatoImpresion ?? "TICKET")"
        OnCerrar="CerrarSelectorImpresora"
        OnImpresionCompletada="OnImpresionDirectaCompletada" />
}

<style>
    /* ═══════════════════ CONTENEDOR PRINCIPAL ═══════════════════ */
    .ticket-preview-container {
        width: 360px;
        min-width: 360px;
        background: white;
        padding: 15px 12px;
        font-family: 'Segoe UI', Tahoma, Arial, sans-serif;
        font-size: 14px;
        line-height: 1.5;
        color: #000;
        box-shadow: 0 4px 20px rgba(0,0,0,0.25);
        border-radius: 4px;
        /* El ticket se expande automáticamente según el contenido */
    }

    /* ═══════════════════ ENCABEZADO ═══════════════════ */
    .ticket-preview-container .ticket-header {
        text-align: center;
        margin-bottom: 6px;
    }

    .ticket-preview-container .ticket-logo {
        text-align: center;
        margin-bottom: 6px;
    }

    .ticket-preview-container .ticket-logo img {
        max-width: 65%;
        max-height: 45px;
    }

    .ticket-preview-container .ticket-empresa {
        font-size: 16px;
        font-weight: bold;
        margin-bottom: 4px;
        word-wrap: break-word;
    }

    .ticket-preview-container .ticket-ruc {
        font-size: 14px;
        font-weight: bold;
        margin: 4px 0;
    }

    .ticket-preview-container .ticket-direccion,
    .ticket-preview-container .ticket-telefono {
        font-size: 12px;
        margin: 2px 0;
        word-wrap: break-word;
    }
    
    .ticket-preview-container .ticket-actividad {
        font-size: 10px;
        margin: 4px 0;
        word-wrap: break-word;
        word-break: break-word;
        white-space: normal;
        line-height: 1.2;
        padding: 2px 4px;
        background: #f8f8f8;
        border-radius: 2px;
        text-align: center;
    }

    /* ═══════════════════ TIPO DOCUMENTO ═══════════════════ */
    .ticket-preview-container .ticket-tipo-doc {
        text-align: center;
        font-size: 14px;
        font-weight: bold;
        padding: 6px 0;
        background: #f0f0f0;
        border: 1px solid #ccc;
        margin: 6px 0;
    }

    /* ═══════════════════ SEPARADORES ═══════════════════ */
    .ticket-preview-container .ticket-separator {
        border-bottom: 1px dashed #999;
        margin: 6px 0;
    }

    .ticket-preview-container .ticket-separator-double {
        border-bottom: 2px solid #333;
        margin: 8px 0;
    }

    /* ═══════════════════ FILAS DE INFORMACIÓN ═══════════════════ */
    .ticket-preview-container .ticket-row {
        display: flex;
        justify-content: space-between;
        margin: 3px 0;
        font-size: 13px;
    }

    .ticket-preview-container .ticket-label {
        font-weight: bold;
        flex-shrink: 0;
    }

    .ticket-preview-container .ticket-value {
        text-align: right;
        word-break: break-word;
    }

    .ticket-preview-container .ticket-factura-nro {
        font-weight: bold;
        font-size: 14px;
    }

    /* ═══════════════════ ENCABEZADO DETALLE ═══════════════════ */
    .ticket-preview-container .ticket-detalle-header {
        display: flex;
        justify-content: space-between;
        font-weight: bold;
        font-size: 12px;
        padding: 5px 0;
        background: #f5f5f5;
    }

    .ticket-preview-container .ticket-detalle-header .col-cant { width: 28px; text-align: center; font-size: 10px; }
    .ticket-preview-container .ticket-detalle-header .col-desc { flex: 1; text-align: left; padding-left: 3px; min-width: 100px; font-size: 10px; }
    .ticket-preview-container .ticket-detalle-header .col-lote { width: 55px; text-align: center; color: #17a2b8; font-size: 10px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .ticket-preview-container .ticket-detalle-header .col-descuento { width: 32px; text-align: right; color: #17a2b8; font-size: 10px; }
    .ticket-preview-container .ticket-detalle-header .col-precio { width: 50px; text-align: right; font-size: 11px; }
    .ticket-preview-container .ticket-detalle-header .col-pmin { width: 50px; text-align: right; color: #0d6efd; font-size: 11px; }
    .ticket-preview-container .ticket-detalle-header .col-importe { width: 50px; text-align: right; font-weight: bold; font-size: 10px; }
    .ticket-preview-container .ticket-detalle-header .col-tiva { width: 24px; text-align: right; font-size: 10px; }

    /* ═══════════════════ DETALLE DE PRODUCTOS ═══════════════════ */
    .ticket-preview-container .ticket-detalle {
        /* Se expande automáticamente */
    }

    .ticket-preview-container .ticket-detalle-item {
        display: flex;
        justify-content: space-between;
        font-size: 12px;
        padding: 4px 0;
        border-bottom: 1px dotted #ddd;
    }

    .ticket-preview-container .ticket-detalle-item:last-child {
        border-bottom: none;
    }

    .ticket-preview-container .ticket-detalle-item .col-cant { width: 28px; text-align: center; flex-shrink: 0; font-size: 11px; }
    .ticket-preview-container .ticket-detalle-item .col-desc { 
        flex: 1; 
        text-align: left; 
        padding-left: 3px;
        padding-right: 2px;
        word-wrap: break-word;
        word-break: break-word;
        overflow-wrap: break-word;
        white-space: normal;
        line-height: 1.1;
        min-width: 100px;
        font-size: 10px;
    }
    .ticket-preview-container .ticket-detalle-item .col-lote { width: 55px; text-align: center; flex-shrink: 0; color: #17a2b8; font-size: 10px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .ticket-preview-container .ticket-detalle-item .col-descuento { width: 32px; text-align: right; flex-shrink: 0; color: #17a2b8; font-size: 10px; }
    .ticket-preview-container .ticket-detalle-item .col-precio { width: 50px; text-align: right; flex-shrink: 0; font-size: 11px; }
    .ticket-preview-container .ticket-detalle-item .col-pmin { width: 45px; text-align: right; flex-shrink: 0; color: #0d6efd; font-size: 10px; }
    .ticket-preview-container .ticket-detalle-item .col-importe { width: 50px; text-align: right; flex-shrink: 0; font-weight: 600; font-size: 11px; }
    .ticket-preview-container .ticket-detalle-item .col-tiva { width: 24px; text-align: right; flex-shrink: 0; font-size: 10px; color: #333; }

    /* ═══════════════════ SUBTOTALES ═══════════════════ */
    .ticket-preview-container .ticket-subtotales {
        font-size: 13px;
        padding: 6px 0;
    }

    .ticket-preview-container .ticket-subtotales .ticket-row {
        display: flex;
        align-items: center;
    }

    .ticket-preview-container .ticket-subtotales .ticket-label {
        flex: 1;
    }

    .ticket-preview-container .col-exenta-total,
    .ticket-preview-container .col-iva5-total,
    .ticket-preview-container .col-iva10-total {
        width: 60px;
        text-align: right;
        font-weight: bold;
    }

    /* ═══════════════════ TOTAL ═══════════════════ */
    .ticket-preview-container .ticket-total-section {
        padding: 10px 0;
        margin: 6px 0;
    }

    .ticket-preview-container .ticket-total {
        font-weight: bold;
        font-size: 18px;
        background: #000;
        color: white;
        padding: 12px 14px;
        margin: 0 -12px;
        border: 2px solid #000;
    }

    /* ═══════════════════ LIQUIDACIÓN IVA ═══════════════════ */
    .ticket-preview-container .ticket-liquidacion {
        padding: 4px 0;
        font-size: 11px;
    }

    .ticket-preview-container .ticket-liquidacion-header {
        display: flex;
        justify-content: space-between;
        font-weight: bold;
        font-size: 11px;
        margin-bottom: 4px;
        padding-bottom: 2px;
        border-bottom: 1px solid #333;
    }

    .ticket-preview-container .ticket-liquidacion-header .liq-header-right {
        text-align: center;
    }

    .ticket-preview-container .ticket-liquidacion-header .liq-header-iva {
        text-align: right;
        width: 55px;
    }

    .ticket-preview-container .ticket-liquidacion-rows {
        display: flex;
        flex-direction: column;
        gap: 2px;
    }

    .ticket-preview-container .liquidacion-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .ticket-preview-container .liquidacion-row .liq-label {
        flex: 1;
        text-align: left;
    }

    .ticket-preview-container .liquidacion-row .liq-value {
        width: 60px;
        text-align: right;
    }

    .ticket-preview-container .liquidacion-row .liq-iva {
        width: 55px;
        text-align: right;
    }

    .ticket-preview-container .liquidacion-row.liquidacion-total {
        font-weight: bold;
        border-top: 1px dashed #ccc;
        padding-top: 3px;
        margin-top: 2px;
    }

    /* ═══════════════════ PIE ═══════════════════ */
    .ticket-preview-container .ticket-footer {
        text-align: center;
        padding-top: 12px;
        padding-bottom: 10px;
    }

    .ticket-preview-container .ticket-gracias {
        font-weight: bold;
        font-size: 14px;
        margin-bottom: 8px;
    }

    .ticket-preview-container .ticket-sistema {
        font-size: 12px;
        color: #333;
        font-weight: 500;
        margin-top: 6px;
        padding-bottom: 8px;
    }

    /* ═══════════════════ SECCIÓN SIFEN / FACTURA ELECTRÓNICA - TICKET COMPACTO ═══════════════════ */
    .ticket-preview-container .ticket-sifen-section {
        margin-top: 8px;
        padding: 8px 4px;
        border-top: 2px solid #333;
        border-bottom: 1px dashed #999;
    }

    .ticket-preview-container .ticket-sifen-layout {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 6px;
        margin-bottom: 8px;
    }

    .ticket-preview-container .ticket-qr-box {
        display: flex;
        justify-content: center;
    }

    .ticket-preview-container .ticket-qr {
        width: 120px;
        height: 120px;
        display: block;
        border: 1px solid #ddd;
        padding: 3px;
        background: white;
    }

    .ticket-preview-container .ticket-qr-empty {
        width: 120px;
        height: 120px;
        border: 2px dashed #999;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 14px;
        color: #999;
        background: #f5f5f5;
    }

    .ticket-preview-container .ticket-sifen-info {
        text-align: center;
        font-size: 9px;
        line-height: 1.3;
    }

    .ticket-preview-container .ticket-sifen-text {
        color: #333;
        margin-bottom: 2px;
    }

    .ticket-preview-container .ticket-sifen-url {
        color: #0066cc;
        font-weight: bold;
        font-size: 9px;
        word-break: break-all;
    }

    .ticket-preview-container .ticket-cdc-row {
        background: #f0f0f0;
        padding: 6px 8px;
        margin: 6px 0;
        border-radius: 3px;
        text-align: center;
        border: 1px solid #ddd;
    }

    .ticket-preview-container .ticket-cdc-label {
        font-weight: bold;
        font-size: 11px;
        display: block;
        margin-bottom: 3px;
        color: #333;
    }

    .ticket-preview-container .ticket-cdc-value {
        font-family: 'Courier New', Consolas, monospace;
        font-size: 9.5px;
        word-break: break-all;
        line-height: 1.4;
        letter-spacing: 0.5px;
        display: block;
        background: #fff;
        padding: 5px;
        border-radius: 2px;
    }

    .ticket-preview-container .ticket-cdc-pending {
        font-size: 9px;
        color: #856404;
        font-style: italic;
    }

    .ticket-preview-container .ticket-sifen-nota {
        font-size: 7px;
        font-weight: bold;
        text-align: center;
        color: #333;
        margin-top: 4px;
        padding: 3px;
        background: #e8e8e8;
        border-radius: 2px;
    }
</style>

@code {
    [Parameter] public int IdVenta { get; set; }
    [Parameter] public EventCallback OnCerrar { get; set; }
    [Parameter] public EventCallback OnImprimirCompletado { get; set; }
    [Parameter] public bool ImprimirAutomatico { get; set; } = false;

    private bool _cargando = true;
    private bool _imprimiendo = false;
    
    // Modal de impresión directa
    private bool _mostrarSelectorImpresora = false;
    private DatosTicket? _datosTicketParaImpresion;
    
    private Venta? _venta;
    private Cliente? _cliente;
    private Sociedad? _sociedad;
    private Sucursal? _sucursal;
    private TipoPago? _tipoPago;
    private Caja? _caja;
    private List<VentaDetalle> _detalles = new();

    // Totales de gravadas (base sin IVA)
    private decimal _subtotalGravadas;
    private decimal _subtotalGravadas5;
    private decimal _subtotalGravadas10;
    private decimal _totalExentas;
    
    // Totales con IVA incluido (para mostrar en columnas 5% y 10%)
    private decimal _totalConIva5;
    private decimal _totalConIva10;
    
    // IVA calculado
    private decimal _totalIva5;
    private decimal _totalIva10;
    
    // Liquidación IVA (base imponible)
    private decimal _liquidacionIva5;
    private decimal _liquidacionIva10;
    
    // Flag para evitar múltiples impresiones automáticas
    private bool _yaImprimioAutomatico = false;
    
    // Modo farmacia - mostrar precio ministerio
    private bool _modoFarmaciaActivo = false;
    
    // SIFEN / Factura Electrónica
    private bool _esFacturaElectronica = false;
    
    // ========== DATOS DEL EMISOR (según modo) ==========
    // Autoimpresor: usar Sucursal | Factura Electrónica: usar Sociedad
    private string NombreEmisorTicket => _esFacturaElectronica 
        ? (_sociedad?.Nombre ?? _sucursal?.NombreEmpresa ?? "EMPRESA") 
        : (_sucursal?.NombreEmpresa ?? "EMPRESA");
    private string RucEmisorTicket => _esFacturaElectronica 
        ? FormatearRucConDv(_sociedad?.RUC, _sociedad?.DV) 
        : FormatearRucConDv(_sucursal?.RUC, _sucursal?.DV);
    private string DireccionEmisorTicket => _esFacturaElectronica 
        ? (_sociedad?.Direccion ?? _sucursal?.Direccion ?? "") 
        : (_sucursal?.Direccion ?? "");
    private string TelefonoEmisorTicket => _esFacturaElectronica 
        ? (_sociedad?.Telefono ?? _sucursal?.Telefono ?? "") 
        : (_sucursal?.Telefono ?? "");
    private string? _qrDataUrl;

    protected override async Task OnInitializedAsync()
    {
        await CargarDatosAsync();
    }

    protected override async Task OnParametersSetAsync()
    {
        if (IdVenta > 0 && (_venta == null || _venta.IdVenta != IdVenta))
        {
            await CargarDatosAsync();
        }
    }

    private async Task CargarDatosAsync()
    {
        _cargando = true;
        StateHasChanged();

        try
        {
            await using var ctx = await DbFactory.CreateDbContextAsync();
            _venta = await ctx.Ventas.FindAsync(IdVenta);
            
            if (_venta != null)
            {
                _detalles = await ctx.VentasDetalles
                    .Include(x => x.Producto)
                    .Where(x => x.IdVenta == IdVenta)
                    .ToListAsync();
                    
                _cliente = _venta.IdCliente.HasValue 
                    ? await ctx.Clientes.FindAsync(_venta.IdCliente) 
                    : null;
                    
                _sociedad = await ctx.Sociedades.FirstOrDefaultAsync();
                _sucursal = await ctx.Sucursal.FindAsync(_venta.IdSucursal);
                _tipoPago = _venta.IdTipoPago.HasValue 
                    ? await ctx.TiposPago.FindAsync(_venta.IdTipoPago) 
                    : null;
                _caja = await ctx.Cajas.FirstOrDefaultAsync(c => c.CajaActual == 1);
                
                // Cargar configuración de farmacia
                var configSistema = await ctx.ConfiguracionSistema.FirstOrDefaultAsync();
                _modoFarmaciaActivo = configSistema?.FarmaciaModoActivo ?? false;

                // ═══════════════════ CÁLCULO DE TOTALES E IMPUESTOS ═══════════════════
                
                // Subtotales gravadas por tasa (base sin IVA)
                _subtotalGravadas5 = _detalles.Sum(x => x.Grabado5);
                _subtotalGravadas10 = _detalles.Sum(x => x.Grabado10);
                _subtotalGravadas = _subtotalGravadas5 + _subtotalGravadas10;
                
                // Total exentas
                _totalExentas = _detalles.Sum(x => x.Exenta);
                
                // IVA incluido en precio (para facturas con IVA incluido)
                _totalIva10 = _detalles.Sum(x => x.IVA10);
                _totalIva5 = _detalles.Sum(x => x.IVA5);
                
                // Totales con IVA incluido (Importe = Base + IVA)
                _totalConIva10 = _subtotalGravadas10 + _totalIva10;
                _totalConIva5 = _subtotalGravadas5 + _totalIva5;
                
                // Liquidación IVA: Total (con IVA incluido) / divisor
                // IVA 10%: Total10 / 11   |   IVA 5%: Total5 / 21
                _liquidacionIva10 = _totalConIva10 > 0 ? Math.Round(_totalConIva10 / 11m, 0) : 0;
                _liquidacionIva5 = _totalConIva5 > 0 ? Math.Round(_totalConIva5 / 21m, 0) : 0;
                
                // ═══════════════════ SIFEN / FACTURA ELECTRÓNICA ═══════════════════
                // Remisiones (interna o normal) NO son factura electrónica - no generan QR ni CDC
                var condVenta = _tipoPago?.Nombre?.ToUpper() ?? "";
                var esRemisionDoc = condVenta.Contains("REMISIÓN") || condVenta.Contains("REMISION");
                _esFacturaElectronica = !esRemisionDoc && (_caja?.TipoFacturacion ?? "").ToUpper().Contains("ELECTR");
                
                // Generar QR si es factura electrónica (no remisión)
                if (_esFacturaElectronica)
                {
                    _qrDataUrl = GenerarQrDataUrl();
                }
                
                // Preparar datos para impresión directa
                _datosTicketParaImpresion = CrearDatosTicket();
                
                // Si hay impresora configurada e ImprimirAutomatico está activo, imprimir directamente con servicio Windows
                // Solo imprimir una vez (evitar duplicados por OnInitialized + OnParametersSet)
                if (ImprimirAutomatico && !string.IsNullOrEmpty(_caja?.NombreImpresora) && !_yaImprimioAutomatico)
                {
                    _yaImprimioAutomatico = true;
                    _ = Task.Run(async () => 
                    {
                        await Task.Delay(200); // Pequeña espera para que el UI se renderice
                        await InvokeAsync(async () => await ImprimirTicketWindows());
                    });
                }
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error cargando datos del ticket: {ex.Message}");
        }
        finally
        {
            _cargando = false;
            StateHasChanged();
        }
    }

    private string FormatearImporte(decimal v) => 
        _venta?.EsMonedaExtranjera == true ? v.ToString("N2") : v.ToString("N0");

    private string FormatearCantidad(decimal cantidad) =>
        cantidad == Math.Truncate(cantidad) ? cantidad.ToString("N0") : cantidad.ToString("N2");

    /// <summary>
    /// Obtiene el código de IVA para mostrar en el ticket (10, 5, E)
    /// </summary>
    private string ObtenerCodigoIva(VentaDetalle det)
    {
        // Usar TipoIva del producto que ya viene incluido
        var tipoIva = det.Producto?.TipoIva;
        if (tipoIva == null) 
        {
            // Si no hay TipoIva del producto, inferir desde IdTipoIva del detalle
            // IdTipoIva: 1=10%, 2=5%, 3=Exenta típicamente
            return det.IdTipoIva switch
            {
                1 => "10",
                2 => "5",
                3 => "0",
                _ => "10"
            };
        }
        
        return tipoIva.Porcentaje switch
        {
            10 => "10",
            5 => "5",
            0 => "0",  // Exenta = 0
            _ => tipoIva.Porcentaje.ToString("N0")
        };
    }

    private string GetLogoBase64() => 
        _sucursal?.Logo != null ? $"data:image/png;base64,{Convert.ToBase64String(_sucursal.Logo)}" : "";

    private string FormatearRucConDv(string? ruc, int? dv)
    {
        if (string.IsNullOrEmpty(ruc)) return "-";
        
        // Si el RUC ya tiene guión, extraer solo la parte numérica
        var rucLimpio = ruc.Contains('-') ? ruc.Split('-')[0] : ruc;
        
        return dv.HasValue ? $"{rucLimpio}-{dv}" : rucLimpio;
    }

    private string FormatearNumeroFactura()
    {
        var est = (_caja?.Nivel1 ?? "001").PadLeft(3, '0');
        var pto = (_caja?.Nivel2 ?? "001").PadLeft(3, '0');
        var num = (_venta?.NumeroFactura ?? "0000001").PadLeft(7, '0');
        return $"{est}-{pto}-{num}";
    }

    private string TruncarTexto(string? texto, int maxLength)
    {
        if (string.IsNullOrEmpty(texto)) return "-";
        return texto.Length <= maxLength ? texto : texto.Substring(0, maxLength - 2) + "..";
    }

    private async Task CerrarModal()
    {
        await OnCerrar.InvokeAsync();
    }

    private async Task ImprimirConServicioDirecto()
    {
        if (_venta == null || _datosTicketParaImpresion == null) return;
        
        _imprimiendo = true;
        StateHasChanged();

        try
        {
            // Usar el diálogo de impresión del navegador
            await JS.InvokeVoidAsync("printTicketElement", "ticketPreviewContent");
            await OnImprimirCompletado.InvokeAsync();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error al imprimir: {ex.Message}");
        }
        finally
        {
            _imprimiendo = false;
            StateHasChanged();
        }
    }

    private async Task ImprimirTicketWindows()
    {
        if (_venta == null || _datosTicketParaImpresion == null) return;
        
        _imprimiendo = true;
        StateHasChanged();

        try
        {
            // Obtener impresora configurada en la caja
            var nombreImpresora = _caja?.NombreImpresora;
            
            // Siempre usar formato ticket 80mm para este botón
            var resultado = await ImpresionService.ImprimirTicket80mm(_datosTicketParaImpresion, nombreImpresora);
            
            if (resultado.Exitoso)
            {
                await OnImprimirCompletado.InvokeAsync();
                await JS.InvokeVoidAsync("alert", $"✅ Ticket impreso: {resultado.Mensaje}");
            }
            else
            {
                await JS.InvokeVoidAsync("alert", $"❌ Error: {resultado.Mensaje}");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error al imprimir ticket: {ex.Message}");
            await JS.InvokeVoidAsync("alert", $"❌ Error al imprimir: {ex.Message}");
        }
        finally
        {
            _imprimiendo = false;
            StateHasChanged();
        }
    }

    private async Task ImprimirDirecto()
    {
        if (_venta == null) return;
        
        _imprimiendo = true;
        StateHasChanged();

        try
        {
            // Imprimir directamente el contenido del ticket usando JavaScript
            // Esto abre el diálogo de impresión del navegador con el contenido del ticket
            await JS.InvokeVoidAsync("printTicketElement", "ticketPreviewContent");
            
            await OnImprimirCompletado.InvokeAsync();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error al imprimir: {ex.Message}");
            // Fallback: abrir página de ticket en ventana nueva
            try
            {
                var url = _caja?.FormatoImpresion == "A4"
                    ? $"/ventas/preview/{IdVenta}?print=1"
                    : $"/ventas/ticket/{IdVenta}/1";
                await JS.InvokeVoidAsync("safeOpen", url, "_blank");
            }
            catch { }
        }
        finally
        {
            _imprimiendo = false;
            StateHasChanged();
        }
    }

    private async Task PrevisualizarPDF()
    {
        if (_venta == null) return;

        _imprimiendo = true;
        StateHasChanged();

        try
        {
            // Abrir la página de ticket sin autoprint para previsualización
            if (_caja?.FormatoImpresion == "A4")
            {
                var url = $"/ventas/preview/{IdVenta}";
                await JS.InvokeVoidAsync("safeOpen", url, "_blank");
            }
            else
            {
                // Ticket sin autoprint (parámetro 0)
                var url = $"/ventas/ticket/{IdVenta}/0";
                await JS.InvokeVoidAsync("safeOpen", url, "_blank");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error al previsualizar: {ex.Message}");
        }
        finally
        {
            _imprimiendo = false;
            StateHasChanged();
        }
    }

    // ═══════════════════ IMPRESIÓN DIRECTA (SIN DIÁLOGO) ═══════════════════
    
    private void MostrarSelectorImpresora()
    {
        if (_venta == null) return;
        
        // Crear los datos del ticket para impresión
        _datosTicketParaImpresion = CrearDatosTicket();
        _mostrarSelectorImpresora = true;
        StateHasChanged();
    }

    private void CerrarSelectorImpresora()
    {
        _mostrarSelectorImpresora = false;
        StateHasChanged();
    }

    private async Task OnImpresionDirectaCompletada(ResultadoImpresion resultado)
    {
        if (resultado.Exitoso)
        {
            Console.WriteLine($"[TicketVistaPrevia] Impresión directa completada: {resultado.Mensaje}");
            _mostrarSelectorImpresora = false;
            await OnImprimirCompletado.InvokeAsync();
        }
        StateHasChanged();
    }

    private DatosTicket CrearDatosTicket()
    {
        var ticket = new DatosTicket
        {
            // Logo (si está habilitado)
            LogoBytes = (_caja?.MostrarLogo == true && _sucursal?.Logo?.Length > 0) 
                ? _sucursal.Logo 
                : null,
            
            // Datos empresa - Autoimpresor: Sucursal | Electrónica: Sociedad
            NombreEmpresa = NombreEmisorTicket,
            RucEmpresa = RucEmisorTicket,
            DireccionEmpresa = DireccionEmisorTicket,
            TelefonoEmpresa = TelefonoEmisorTicket,
            ActividadEconomica = _sucursal?.RubroEmpresa ?? "",
            
            // Datos factura
            NumeroFactura = FormatearNumeroFactura(),
            Fecha = _venta?.Fecha ?? DateTime.Now,
            Timbrado = _venta?.Timbrado ?? _caja?.Timbrado ?? "",
            VigenciaDel = _caja?.VigenciaDel,
            VigenciaAl = _caja?.VigenciaAl,
            CDC = _venta?.CDC ?? "",
            UrlQrSifen = _venta?.UrlQrSifen,  // URL oficial del QR con cHashQR
            CondicionVenta = _tipoPago?.Nombre?.ToUpper() ?? "CONTADO",
            TipoDocumento = _venta?.TipoDocumento?.ToUpper() ?? "FACTURA",
            EsElectronica = _caja?.TipoFacturacion == "ELECTRONICA",
            
            // Datos cliente
            NombreCliente = _cliente?.RazonSocial ?? "SIN NOMBRE",
            RucCliente = FormatearRucConDv(_cliente?.RUC, _cliente?.DV),
            DvCliente = _cliente?.DV.ToString(),
            DireccionCliente = _cliente?.Direccion ?? "",
            
            // Modo farmacia
            ModoFarmacia = _modoFarmaciaActivo,
            
            // Items con desglose de IVA y datos farmacia
            Items = _detalles.Select(d => new ItemTicket
            {
                Descripcion = d.Producto?.Descripcion ?? "",
                Cantidad = d.Cantidad,
                PrecioUnitario = d.PrecioUnitario,
                Subtotal = d.Importe,
                Exenta = d.Exenta,
                Gravado5 = d.Grabado5,
                Gravado10 = d.Grabado10,
                // Campos farmacia
                PorcentajeDescuento = d.PorcentajeDescuento ?? 0,
                PrecioMinisterio = d.PrecioMinisterio ?? 0
            }).ToList(),
            
            // Totales
            Subtotal = _detalles.Sum(d => d.Importe),
            Descuento = 0,
            Total = _venta?.Total ?? 0,
            
            // IVA
            TotalExentas = _totalExentas,
            TotalIva5 = _subtotalGravadas5,
            TotalIva10 = _subtotalGravadas10,
            MontoIva5 = _liquidacionIva5,
            MontoIva10 = _liquidacionIva10,
            TotalIva = _liquidacionIva5 + _liquidacionIva10
        };
        
        return ticket;
    }

    // ═══════════════════ GENERACIÓN QR SIFEN ═══════════════════
    
    /// <summary>
    /// Genera el código QR para factura electrónica
    /// </summary>
    private string GenerarQrDataUrl()
    {
        try
        {
            // PRIORIDAD 1: Usar la URL completa del QR firmado (dCarQR) si está disponible
            if (!string.IsNullOrWhiteSpace(_venta?.UrlQrSifen))
            {
                Console.WriteLine($"[TicketVistaPrevia] QR: Usando UrlQrSifen oficial");
                return GenerarQrDesdeUrl(_venta.UrlQrSifen);
            }
            
            // PRIORIDAD 2: Generar URL con CDC si existe
            if (!string.IsNullOrWhiteSpace(_venta?.CDC))
            {
                var url = $"https://ekuatia.set.gov.py/consultas/gestionarDoc/qr?CDC={_venta.CDC}";
                Console.WriteLine($"[TicketVistaPrevia] QR: Usando CDC: {_venta.CDC[..Math.Min(20, _venta.CDC.Length)]}...");
                return GenerarQrDesdeUrl(url);
            }
            
            Console.WriteLine("[TicketVistaPrevia] QR: Sin CDC disponible");
            return string.Empty;
        }
        catch (Exception ex)
        {
            Console.WriteLine($"[TicketVistaPrevia] Error generando QR: {ex.Message}");
            return string.Empty;
        }
    }
    
    /// <summary>
    /// Genera la imagen QR desde una URL
    /// </summary>
    private string GenerarQrDesdeUrl(string url)
    {
        try
        {
            using var generator = new QRCodeGenerator();
            using var data = generator.CreateQrCode(url, QRCodeGenerator.ECCLevel.Q);
            
            // Generar PNG de alta resolución
            var png = new PngByteQRCode(data);
            var bytes = png.GetGraphic(8); // 8 pixels por módulo
            var base64 = Convert.ToBase64String(bytes);
            
            return $"data:image/png;base64,{base64}";
        }
        catch (Exception ex)
        {
            Console.WriteLine($"[TicketVistaPrevia] Error generando QR desde URL: {ex.Message}");
            return string.Empty;
        }
    }
}
