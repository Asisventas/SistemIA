@page "/clientes/editar/{IdCliente:int}"
@using Microsoft.EntityFrameworkCore
@using Microsoft.AspNetCore.Components.Forms
@using Microsoft.AspNetCore.Components.Web
@using SistemIA.Models
@using SistemIA.Models.Suscripciones
@using SistemIA.Utils
@using SistemIA.Services
@using FaceRecognitionDotNet
@using System.Linq
@using System.Xml
@using System.IO
@using System.ComponentModel.DataAnnotations
@using System.Threading
@using System.Threading.Tasks
@inject IDbContextFactory<SistemIA.Models.AppDbContext> DbFactory
@inject NavigationManager Navigation
@inject IJSRuntime JS
@inject Sifen Sifen
@inject IRucDnitService RucDnitService
@implements IDisposable

<div class="d-flex justify-content-between align-items-center mb-4">
    <h3 class="mb-0">✏️ Editar Cliente</h3>
    @if (cliente != null)
    {
        <button type="button" class="btn btn-outline-warning" @onclick="AbrirModalSoporteRemoto" title="Configuración de Soporte Remoto (requiere contraseña SA)">
            <i class="bi bi-gear-wide-connected me-1"></i>
            @if (cliente.HabilitadoSoporteRemoto)
            {
                <span class="badge bg-success ms-1">VPN</span>
            }
        </button>
    }
</div>

@if (isLoading)
{
    <div>Cargando datos...</div>
}
else if (!string.IsNullOrEmpty(errorMessage))
{
    <div class="alert alert-danger">@errorMessage</div>
}
else if (cliente is not null)
{
    <EditForm Model="@cliente" OnValidSubmit="ActualizarCliente">
        <DataAnnotationsValidator />
        <ValidationSummary />
        <div class="row g-3">
            <!-- Columna Izquierda -->
            <div class="col-lg-6">
                <div class="card">
                    <div class="card-header py-2"><strong>Identificación</strong></div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label">Razón Social</label>
                            <InputText class="form-control" @bind-Value="cliente.RazonSocial" />
                        </div>
                        <div class="row g-2">
                            <div class="col-md-4">
                                <label class="form-label">Tipo Documento</label>
                                <InputSelect class="form-select" @bind-Value="cliente.TipoDocumento">
                                    <option value="">-- Seleccionar --</option>
                                    @foreach (var tipo in tiposDocumentos)
                                    {
                                        <option value="@tipo.TipoDocumento">@tipo.Descripcion</option>
                                    }
                                </InputSelect>
                            </div>
                            <div class="col-md-5">
                                <label class="form-label">RUC o Cédula</label>
                                <small class="d-block text-muted mb-1" style="font-size: 0.75rem;">Se auto-detecta al consultar DNIT</small>
                                <div class="input-group">
                                    <InputText class="form-control"
                                               @bind-Value="cliente.RUC" />
                                    <button type="button" class="btn btn-outline-secondary" @onclick="ConsultarRucManual" disabled="@consultandoRuc">
                                        @if (consultandoRuc)
                                        {
                                            <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                                        }
                                        else
                                        {
                                            <text>DNIT</text>
                                        }
                                    </button>
                                </div>
                                @if (!string.IsNullOrEmpty(mensajeRuc))
                                {
                                    <div class="form-text @(esErrorRuc ? "text-danger" : "text-success")">@mensajeRuc</div>
                                }
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">DV</label>
                                <InputNumber class="form-control" @bind-Value="cliente.DV" readonly />
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card mt-3">
                    <div class="card-header py-2"><strong>Ubicación y contacto</strong></div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label">Dirección</label>
                            <InputText class="form-control" @bind-Value="cliente.Direccion" />
                        </div>
                        <div class="row g-2">
                            <div class="col-md-6">
                                <label class="form-label">País</label>
                                <InputSelect class="form-select" @bind-Value="cliente.CodigoPais" @bind-Value:after="OnPaisChanged">
                                    <option value="">-- Seleccionar --</option>
                                    @foreach (var pais in paises)
                                    {
                                        <option value="@pais.CodigoPais">@pais.Nombre</option>
                                    }
                                </InputSelect>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Ciudad</label>
                                <InputSelect class="form-select" @bind-Value="cliente.IdCiudad" @bind-Value:after="OnCiudadChangedAfter">
                                    <option value="1">ASUNCION (DISTRITO)</option>
                                    @foreach (var ciudad in ciudades.Where(c => c.Numero != 1))
                                    {
                                        <option value="@ciudad.Numero">@ciudad.Nombre (@ciudad.Departamento.ToString("00"))</option>
                                    }
                                </InputSelect>
                            </div>
                        </div>
                        <div class="row g-2 mt-2">
                            <div class="col-md-6">
                                <label class="form-label">Teléfono</label>
                                <InputText class="form-control" @bind-Value="cliente.Telefono" />
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Email</label>
                                <InputText class="form-control" @bind-Value="cliente.Email" />
                            </div>
                        </div>
                        <div class="mt-2">
                            <label class="form-label">Fecha de Nacimiento</label>
                            <InputDate class="form-control" @bind-Value="cliente.FechaNacimiento" />
                        </div>
                    </div>
                </div>
            </div>

            <!-- Columna Derecha -->
            <div class="col-lg-6">
                <div class="card">
                    <div class="card-header py-2 d-flex align-items-center justify-content-between">
                        <strong>Condiciones comerciales</strong>
                        <button class="btn btn-sm btn-outline-info" type="button" data-bs-toggle="collapse" data-bs-target="#sifenCollapse" aria-expanded="false" aria-controls="sifenCollapse">SIFEN</button>
                    </div>
                    <div class="card-body">
                        <div class="row g-2">
                            <div class="col-md-4">
                                <div class="form-check">
                                    <InputCheckbox id="estadoClienteEditar" class="form-check-input" @bind-Value="cliente.Estado" />
                                    <label class="form-check-label" for="estadoClienteEditar">Cliente Activo</label>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-check">
                                    <InputCheckbox id="permiteCreditoEditar" class="form-check-input" @bind-Value="cliente.PermiteCredito" />
                                    <label class="form-check-label" for="permiteCreditoEditar" title="Habilita venta a crédito y remisiones">✓ Permite Crédito</label>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-check">
                                    <InputCheckbox id="extranjeroClienteEditar" class="form-check-input" @bind-Value="cliente.EsExtranjero" @bind-Value:after="OnExtranjeroChanged" />
                                    <label class="form-check-label" for="extranjeroClienteEditar">¿Extranjero?</label>
                                </div>
                            </div>
                        </div>

                        <div class="row g-2 mt-3">
                            <div class="col-md-6">
                                <label class="form-label">Naturaleza SIFEN</label>
                                <InputSelect class="form-select" @bind-Value="cliente.NaturalezaReceptor" @bind-Value:after="OnNaturalezaReceptorChanged">
                                    <option value="1">1 - Contribuyente (con RUC activo)</option>
                                    <option value="2">2 - No Contribuyente (sin RUC)</option>
                                </InputSelect>
                                <small class="form-text text-muted">
                                    @if (cliente.NaturalezaReceptor == 1)
                                    {
                                        <span class="text-success"><i class="bi bi-check-circle me-1"></i>Se enviará RUC a SIFEN</span>
                                    }
                                    else
                                    {
                                        <span class="text-warning"><i class="bi bi-exclamation-triangle me-1"></i>Se enviará documento de identidad</span>
                                        <br/><small class="text-info">Seleccione tipo de documento en la sección inferior</small>
                                    }
                                </small>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Tipo de Contribuyente</label>
                                <InputSelect class="form-select" @bind-Value="cliente.IdTipoContribuyente" disabled="@(cliente.NaturalezaReceptor != 1)">
                                    <option value="">-- Seleccionar --</option>
                                    @foreach (var tipo in tiposContribuyentes)
                                    {
                                        <option value="@tipo.IdTipoContribuyente">@tipo.NombreTipo</option>
                                    }
                                </InputSelect>
                                @if (cliente.NaturalezaReceptor != 1)
                                {
                                    <small class="text-muted">Solo para contribuyentes</small>
                                }
                            </div>
                        </div>

                        <div class="mt-3">
                            <label class="form-label">Tipo de Operación</label>
                            <small class="form-text text-muted d-block">1=B2B (empresas), 2=B2C (personas físicas)</small>
                            <InputSelect @bind-Value="cliente.TipoOperacion" class="form-select">
                                <option value="">Seleccione...</option>
                                <option value="1">1 - B2B (Empresa a Empresa/Extranjero)</option>
                                <option value="2">2 - B2C (Empresa a Cliente)</option>
                                <option value="3">3 - B2G (Empresa a Gobierno)</option>
                                <option value="4">4 - B2F (Empresa a Extranjero)</option>
                            </InputSelect>
                        </div>

                        <div class="row g-2 mt-3">
                            <div class="col-md-4">
                                <label class="form-label">Límite Crédito</label>
                                @if (editandoLimiteCredito)
                                {
                                    <InputNumber @bind-Value="cliente.LimiteCredito" class="form-control" @onblur="OnLimiteCreditoBlur" autofocus disabled="@(!cliente.PermiteCredito)" />
                                }
                                else
                                {
                                    <div class="form-control-plaintext border rounded px-2"
                                         style="min-height:38px; cursor:pointer;"
                                         title="Haz clic para editar"
                                         @onclick="ActivarEdicionLimiteCredito">
                                        @(cliente.LimiteCredito.HasValue ? cliente.LimiteCredito.Value.ToString("N2") : "")
                                    </div>
                                }
                                @if (!cliente.PermiteCredito)
                                {
                                    <small class="text-muted">Habilitar 'Permite Crédito'</small>
                                }
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Plazo Días Crédito</label>
                                <InputNumber class="form-control" @bind-Value="cliente.PlazoDiasCredito" disabled="@(!cliente.PermiteCredito)" />
                                @if (!cliente.PermiteCredito)
                                {
                                    <small class="text-muted">Habilitar 'Permite Crédito'</small>
                                }
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Saldo Pendiente</label>
                                <InputNumber class="form-control" @bind-Value="cliente.Saldo" readonly />
                                @if (cliente.LimiteCredito.HasValue && cliente.Saldo > 0)
                                {
                                    var disponible = cliente.LimiteCredito.Value - cliente.Saldo;
                                    <small class="@(disponible >= 0 ? "text-success" : "text-danger")">Disponible: @disponible.ToString("N2")</small>
                                }
                            </div>
                        </div>

                        <div class="mt-3">
                            <label class="form-label">Precio Diferenciado</label>
                            <div class="d-flex align-items-center">
                                <InputCheckbox class="form-check-input" @bind-Value="cliente.PrecioDiferenciado" />
                                <button type="button" class="btn btn-sm btn-outline-primary ms-2" @onclick="TogglePreciosDiferenciados">
                                    <i class="bi bi-tags"></i> Gestionar precios por producto
                                </button>
                            </div>
                        </div>

                        <!-- Envío de factura por correo -->
                        <div class="mt-3">
                            <label class="form-label">Envío de Factura por Correo</label>
                            <div class="d-flex align-items-center">
                                <div class="form-check form-switch">
                                    <InputCheckbox class="form-check-input" id="enviarFacturaCorreo" 
                                                   @bind-Value="cliente.EnviarFacturaPorCorreo"
                                                   disabled="@(string.IsNullOrWhiteSpace(cliente.Email))" />
                                    <label class="form-check-label" for="enviarFacturaCorreo">
                                        <i class="bi bi-envelope-paper me-1"></i>Enviar factura PDF al confirmar venta
                                    </label>
                                </div>
                            </div>
                            @if (string.IsNullOrWhiteSpace(cliente.Email))
                            {
                                <small class="text-warning"><i class="bi bi-exclamation-triangle me-1"></i>Debe configurar un correo electrónico para habilitar esta opción</small>
                            }
                            else if (cliente.EnviarFacturaPorCorreo)
                            {
                                <small class="text-success"><i class="bi bi-check-circle me-1"></i>Se enviará factura a: @cliente.Email</small>
                            }
                        </div>
                    </div>
                </div>

                <!-- NOTIFICACIONES DE CRÉDITO -->
                @if (cliente.PermiteCredito)
                {
                    <div class="card mt-3">
                        <div class="card-header py-2 bg-info text-white"><strong>📊 Estado de Crédito</strong></div>
                        <div class="card-body">
                            @if (cargandoEstadoCredito)
                            {
                                <div class="text-center">
                                    <div class="spinner-border spinner-border-sm" role="status">
                                        <span class="visually-hidden">Cargando...</span>
                                    </div>
                                </div>
                            }
                            else if (estadoCredito != null)
                            {
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <div class="border rounded p-2">
                                            <small class="text-muted">Límite de Crédito</small>
                                            <div class="fs-5 fw-bold">@(cliente.LimiteCredito?.ToString("N2") ?? "-")</div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="border rounded p-2">
                                            <small class="text-muted">Saldo Pendiente</small>
                                            <div class="fs-5 fw-bold text-@(estadoCredito.SaldoPendiente > 0 ? "danger" : "success")">
                                                @estadoCredito.SaldoPendiente.ToString("N2")
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="border rounded p-2 @(estadoCredito.CreditosVencidos > 0 ? "border-danger" : "")">
                                            <small class="text-muted">Facturas Vencidas</small>
                                            <div class="fs-5 fw-bold text-danger">
                                                @estadoCredito.CreditosVencidos
                                                @if (estadoCredito.MontoVencido > 0)
                                                {
                                                    <small class="text-muted">(@estadoCredito.MontoVencido.ToString("N2"))</small>
                                                }
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="border rounded p-2 @(estadoCredito.CreditosPorVencer > 0 ? "border-warning" : "")">
                                            <small class="text-muted">Por Vencer (7 días)</small>
                                            <div class="fs-5 fw-bold text-warning">
                                                @estadoCredito.CreditosPorVencer
                                                @if (estadoCredito.MontoPorVencer > 0)
                                                {
                                                    <small class="text-muted">(@estadoCredito.MontoPorVencer.ToString("N2"))</small>
                                                }
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                @if (estadoCredito.CreditosVencidos > 0)
                                {
                                    <div class="alert alert-danger mt-3 mb-0">
                                        <i class="bi bi-exclamation-triangle"></i> Este cliente tiene facturas vencidas. Gestione los cobros pendientes.
                                    </div>
                                }
                            }
                        </div>
                    </div>
                }
            </div>
        </div>

        <!-- SECCIÓN SIFEN - Campos específicos para facturación electrónica (colapsable) -->
        <div class="collapse mt-4" id="sifenCollapse">
            <div class="card">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">📄 Información SIFEN (Facturación Electrónica)</h5>
                </div>
                <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">Naturaleza del Receptor</label>
                            <small class="form-text text-muted d-block">
                                1=Contribuyente (con RUC), 2=No contribuyente (consumidor final)
                            </small>
                            <InputSelect class="form-select" @bind-Value="cliente.NaturalezaReceptor" @bind-Value:after="OnNaturalezaReceptorChanged">
                                <option value="1">1 - Contribuyente (Persona con RUC activo)</option>
                                <option value="2">2 - No contribuyente (Consumidor final sin RUC)</option>
                            </InputSelect>
                            @if (cliente.NaturalezaReceptor == 1 && cliente.TipoDocumentoIdentidadSifen.HasValue)
                            {
                                <div class="alert alert-warning mt-2 py-1 small">
                                    <i class="bi bi-exclamation-triangle me-1"></i>
                                    Contribuyentes no usan Tipo Doc. Identidad SIFEN. Se limpiará al guardar.
                                </div>
                            }
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Código Departamento</label>
                            <small class="form-text text-muted d-block">
                                Código oficial según catálogo SIFEN (ej: 01=Capital, 11=Central)
                            </small>
                            <InputText class="form-control" @bind-Value="cliente.CodigoDepartamento" maxlength="2" />
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Descripción Departamento</label>
                            <small class="form-text text-muted d-block">
                                Nombre del departamento (máximo 16 caracteres)
                            </small>
                            <InputText class="form-control" @bind-Value="cliente.DescripcionDepartamento" maxlength="16" />
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">Código Distrito</label>
                            <small class="form-text text-muted d-block">
                                Código oficial según catálogo SIFEN (ej: 0001=Asunción)
                            </small>
                            <InputText class="form-control" @bind-Value="cliente.CodigoDistrito" maxlength="4" />
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Descripción Distrito</label>
                            <small class="form-text text-muted d-block">
                                Nombre del distrito (máximo 30 caracteres)
                            </small>
                            <InputText class="form-control" @bind-Value="cliente.DescripcionDistrito" maxlength="30" />
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Nombre de Fantasía</label>
                            <small class="form-text text-muted d-block">
                                Nombre comercial de la empresa (opcional, máximo 255 caracteres)
                            </small>
                            <InputText class="form-control" @bind-Value="cliente.NombreFantasia" maxlength="255" />
                            </div>
                            </div>
                    </div>
                </div>

                <!-- Campos específicos para No Contribuyentes -->
                <div class="row g-3 mt-3" style="display: @(cliente.NaturalezaReceptor == 2 ? "block" : "none")">
                    <div class="col-12">
                        <div class="alert alert-info">
                            <strong>Campos adicionales para No Contribuyentes:</strong>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">Tipo de Documento de Identidad</label>
                            <small class="form-text text-muted d-block">
                                Catálogo SIFEN v150: 1=CI Paraguaya, 2=CI Extranjera, 3=Pasaporte, 4=Carnet residencia, 5=Innominado
                            </small>
                            <InputSelect class="form-select" @bind-Value="cliente.TipoDocumentoIdentidadSifen" @bind-Value:after="OnTipoDocIdentidadChangedAfter">
                                <option value="">-- Seleccionar --</option>
                                <option value="1">1 - Cédula paraguaya</option>
                                <option value="2">2 - Cédula extranjera</option>
                                <option value="3">3 - Pasaporte</option>
                                <option value="4">4 - Carnet de residencia</option>
                                <option value="5">5 - Innominado (sin documento)</option>
                            </InputSelect>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">Documento</label>
                            <small class="form-text text-muted d-block">
                                Número del documento según el tipo seleccionado arriba
                            </small>
                            <InputText class="form-control" @bind-Value="cliente.NumeroDocumentoIdentidad" maxlength="20" disabled="@(cliente.TipoDocumentoIdentidadSifen == 5)" />
                        </div>
                    </div>
                </div>
            </div>
        </div>

        @if (cliente?.PrecioDiferenciado == true && mostrarPreciosDif)
        {
            <div class="card mt-4">
                <div class="card-header bg-warning-subtle">
                    <h5 class="mb-0"><i class="bi bi-tags me-2"></i>Precios diferenciados por producto</h5>
                </div>
                <div class="card-body">
                    <div class="row g-2 align-items-end mb-2">
                        <div class="col-md-6">
                            <label class="form-label">Producto</label>
                            <div class="position-relative">
                                <input class="form-control" placeholder="Tipee nombre o código..." value="@prodSearch" @oninput="OnProdSearchChanged" @onfocus="ShowProdOpciones" @onblur="OnProdBlur" @onkeydown="OnProdKeyDown" />
                                @if (prodMostrandoOpciones && prodOpciones.Count > 0)
                                {
                                    <div class="list-group position-absolute w-100 shadow-sm bg-white" style="z-index:1000; max-height:260px; overflow:auto;">
                                        @for (int i = 0; i < prodOpciones.Count; i++)
                                        {
                                            var pr = prodOpciones[i];
                                            var itemClass = $"list-group-item list-group-item-action d-flex justify-content-between align-items-center {(i == prodSelectedIndex ? "active" : string.Empty)}";
                                            <button type="button" class="@itemClass" @onmousedown="(() => SeleccionarProducto(pr))" @onclick="(() => SeleccionarProducto(pr))">
                                                <span>@pr.Descripcion</span>
                                                <small class="text-muted">@pr.CodigoInterno · @pr.UnidadMedidaCodigo</small>
                                            </button>
                                        }
                                    </div>
                                }
                                else if (prodMostrandoOpciones && !string.IsNullOrWhiteSpace(prodSearch) && prodOpciones.Count == 0)
                                {
                                    <div class="list-group position-absolute w-100 shadow-sm bg-white" style="z-index:1000; max-height:260px; overflow:auto;">
                                        <div class="list-group-item text-muted">Sin resultados</div>
                                    </div>
                                }
                            </div>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Precio fijo Gs</label>
                            <InputNumber class="form-control" @bind-Value="precioFijoGs" />
                            <div class="form-text">Opcional. Si se define, tiene prioridad sobre el %.</div>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">% Desc.</label>
                            <InputNumber class="form-control" @bind-Value="porcentajeDesc" />
                        </div>
                        <div class="col-md-1 text-end">
                            <button type="button" class="btn btn-outline-primary w-100" @onclick="AgregarPrecioCliente" disabled="@(prodSelectedId == 0 || (precioFijoGs is null && (porcentajeDesc is null || porcentajeDesc <= 0)))">Agregar</button>
                        </div>
                    </div>

                    <div class="table-responsive">
                        <table class="table table-sm table-striped">
                            <thead>
                                <tr>
                                    <th style="width:90px">ID</th>
                                    <th>Producto</th>
                                    <th class="text-end" style="width:120px">Precio lista</th>
                                    <th class="text-end" style="width:130px">Precio fijo Gs</th>
                                    <th class="text-end" style="width:110px">% Desc</th>
                                    <th class="text-end" style="width:130px">Precio final</th>
                                    <th style="width:70px"></th>
                                </tr>
                            </thead>
                            <tbody>
                                @if (preciosCliente.Count == 0)
                                {
                                    <tr><td colspan="7" class="text-muted">Sin filas</td></tr>
                                }
                                else
                                {
                                    @foreach (var pc in preciosCliente)
                                    {
                                        var precioLista = pc.Producto?.PrecioUnitarioGs ?? 0m;
                                        var precioFinal = pc.PrecioFijoGs ?? (precioLista * (1 - ((pc.PorcentajeDescuento ?? 0) / 100m)));
                                        <tr>
                                            <td>@pc.IdProducto</td>
                                            <td>@pc.Producto?.Descripcion</td>
                                            <td class="text-end">@precioLista.ToString("N0")</td>
                                            <td class="text-end">@(pc.PrecioFijoGs?.ToString("N0") ?? "-")</td>
                                            <td class="text-end">@((pc.PorcentajeDescuento?.ToString("N2") ?? "-"))</td>
                                            <td class="text-end">@precioFinal.ToString("N0")</td>
                                            <td class="text-end">
                                                <button type="button" class="btn btn-sm btn-outline-danger" title="Quitar" @onclick="() => QuitarPrecioCliente(pc.IdClientePrecio)"><i class="bi bi-trash"></i></button>
                                            </td>
                                        </tr>
                                    }
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        }

        <!-- ========== SECCIÓN GIMNASIO ========== -->
        @if (_modoGimnasioActivo)
        {
            <div class="card mt-4">
                <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="bi bi-heart-pulse me-2"></i>Datos de Gimnasio</h5>
                    <div class="form-check form-switch mb-0">
                        <InputCheckbox class="form-check-input" id="esMiembroGym" @bind-Value="cliente.EsMiembroGimnasio" />
                        <label class="form-check-label text-white" for="esMiembroGym">Es miembro</label>
                    </div>
                </div>
                @if (cliente.EsMiembroGimnasio)
                {
                    <div class="card-body">
                        <div class="row g-3">
                            <!-- Foto y código -->
                            <div class="col-md-3 text-center">
                                <label class="form-label">Foto para reconocimiento facial</label>
                                <div class="border rounded p-2 bg-light" style="min-height: 150px;">
                                    @if (!string.IsNullOrEmpty(_fotoGimnasioBase64))
                                    {
                                        <img src="@_fotoGimnasioBase64" alt="Foto gimnasio" class="img-fluid rounded" style="max-height: 140px;" />
                                    }
                                    else
                                    {
                                        <div class="text-muted d-flex flex-column align-items-center justify-content-center h-100" style="min-height: 130px;">
                                            <i class="bi bi-person-bounding-box fs-1"></i>
                                            <small>Sin foto</small>
                                        </div>
                                    }
                                </div>
                                <div class="mt-2">
                                    <div class="btn-group btn-group-sm w-100">
                                        <label class="btn btn-outline-secondary" style="cursor: pointer;">
                                            <i class="bi bi-upload me-1"></i>Archivo
                                            <InputFile OnChange="OnFotoGimnasioSelected" class="d-none" accept="image/*" />
                                        </label>
                                        <button type="button" class="btn btn-outline-primary" @onclick="CapturarConCamaraGimnasio">
                                            <i class="bi bi-camera-fill me-1"></i>Cámara
                                        </button>
                                    </div>
                                </div>
                                @if (!string.IsNullOrEmpty(_errorFotoGimnasio))
                                {
                                    <div class="text-danger small mt-1">@_errorFotoGimnasio</div>
                                }
                                @if (cliente.EmbeddingFacialGimnasio != null && cliente.EmbeddingFacialGimnasio.Length > 0)
                                {
                                    <div class="text-success small mt-1"><i class="bi bi-check-circle me-1"></i>Rostro registrado</div>
                                }
                                @if (!string.IsNullOrEmpty(_fotoGimnasioBase64))
                                {
                                    <button type="button" class="btn btn-sm btn-outline-danger mt-1" @onclick="EliminarFotoGimnasio">
                                        <i class="bi bi-trash me-1"></i>Quitar foto
                                    </button>
                                }
                            </div>
                            
                            <!-- Datos principales -->
                            <div class="col-md-9">
                                <div class="row g-3">
                                    <div class="col-md-4">
                                        <label class="form-label">Código Gimnasio</label>
                                        <InputText class="form-control" @bind-Value="cliente.CodigoGimnasio" placeholder="Ej: GYM-001" />
                                        <small class="text-muted">Código manual o tarjeta</small>
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label">Fecha de Alta</label>
                                        <InputDate class="form-control" @bind-Value="cliente.FechaAltaGimnasio" />
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label">Objetivo Fitness</label>
                                        <InputSelect class="form-select" @bind-Value="cliente.ObjetivoFitness">
                                            <option value="">-- Seleccionar --</option>
                                            <option value="Pérdida de peso">Pérdida de peso</option>
                                            <option value="Ganancia muscular">Ganancia muscular</option>
                                            <option value="Mantenimiento">Mantenimiento</option>
                                            <option value="Tonificación">Tonificación</option>
                                            <option value="Resistencia">Resistencia</option>
                                            <option value="Rehabilitación">Rehabilitación</option>
                                            <option value="Otro">Otro</option>
                                        </InputSelect>
                                    </div>
                                    <div class="col-12">
                                        <label class="form-label">Condiciones Médicas</label>
                                        <InputTextArea class="form-control" @bind-Value="cliente.CondicionesMedicas" rows="2" placeholder="Alergias, lesiones, condiciones que el entrenador debe conocer..." />
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">Contacto de Emergencia</label>
                                        <InputText class="form-control" @bind-Value="cliente.ContactoEmergencia" placeholder="Nombre del contacto" />
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">Teléfono de Emergencia</label>
                                        <InputText class="form-control" @bind-Value="cliente.TelefonoEmergencia" placeholder="0981-XXX-XXX" />
                                    </div>
                                    <div class="col-12">
                                        <label class="form-label">Mensaje de Bienvenida Personalizado</label>
                                        <InputText class="form-control" @bind-Value="cliente.MensajeBienvenidaPersonalizado" placeholder="Ej: ¡Hola Juan, bienvenido!" />
                                        <small class="text-muted">Si está vacío, se usará el mensaje por defecto del sistema</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Estadísticas de uso -->
                        @if (cliente.TotalVisitasGimnasio > 0 || cliente.FechaUltimaVisitaGimnasio.HasValue)
                        {
                            <hr class="my-3" />
                            <div class="row g-3">
                                <div class="col-md-4">
                                    <div class="border rounded p-2 text-center bg-light">
                                        <small class="text-muted">Total de Visitas</small>
                                        <div class="fs-4 fw-bold text-success">@cliente.TotalVisitasGimnasio</div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="border rounded p-2 text-center bg-light">
                                        <small class="text-muted">Última Visita</small>
                                        <div class="fs-6 fw-bold">@(cliente.FechaUltimaVisitaGimnasio?.ToString("dd/MM/yyyy HH:mm") ?? "-")</div>
                                    </div>
                                </div>
                                <div class="col-md-4 d-flex align-items-center">
                                    <a href="/gimnasio/miembros?cliente=@cliente.IdCliente" class="btn btn-outline-success w-100">
                                        <i class="bi bi-card-checklist me-1"></i>Ver membresías
                                    </a>
                                </div>
                            </div>
                        }
                    </div>
                }
            </div>
        }

        <div class="mt-4">
            <button type="submit" class="btn btn-primary">💾 Guardar Cambios</button>
            <button type="button" class="btn btn-secondary ms-2" @onclick="Cancelar">Cancelar</button>
        </div>
    </EditForm>
}

<!-- ========== MODAL DATOS SOPORTE REMOTO (SOLO IP Y NOTAS DEL CLIENTE) ========== -->
@if (_mostrarModalSoporteRemoto)
{
    <div class="modal fade show d-block" tabindex="-1" style="background:rgba(0,0,0,0.6);">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-info text-white">
                    <h5 class="modal-title"><i class="bi bi-pc-display-horizontal me-2"></i>Datos de Conexión Remota</h5>
                    <button type="button" class="btn-close btn-close-white" @onclick="CerrarModalSoporteRemoto"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-info py-2 mb-3">
                        <i class="bi bi-info-circle me-2"></i>
                        <small>Configure los datos de conexión VPN de este cliente para soporte remoto.</small>
                    </div>
                    
                    @if (!string.IsNullOrEmpty(_mensajeModalSoporte))
                    {
                        <div class="alert @(_exitoModalSoporte ? "alert-success" : "alert-danger") py-2">
                            @_mensajeModalSoporte
                        </div>
                    }
                    
                    <div class="row g-3">
                        <div class="col-12">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="habilitadoVpn" @bind="_soporteTemp.Habilitado" />
                                <label class="form-check-label" for="habilitadoVpn">
                                    <strong>Habilitado para soporte remoto</strong>
                                </label>
                            </div>
                        </div>
                        
                        @if (_soporteTemp.Habilitado)
                        {
                            <div class="col-md-8">
                                <label class="form-label">IP VPN Asignada *</label>
                                <input type="text" class="form-control" @bind="_soporteTemp.IpVpn" placeholder="192.168.89.XX" />
                                <small class="text-muted">IP fija en el rango VPN del Mikrotik</small>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Puerto</label>
                                <input type="number" class="form-control" @bind="_soporteTemp.Puerto" />
                                <small class="text-muted">Default: 5095</small>
                            </div>
                            <div class="col-12">
                                <label class="form-label">Notas de Acceso</label>
                                <textarea class="form-control" rows="3" @bind="_soporteTemp.Notas" placeholder="Información adicional: usuario Windows, contraseña, horarios, etc."></textarea>
                            </div>
                            
                            @if (cliente?.UltimaConexionRemota.HasValue == true)
                            {
                                <div class="col-12">
                                    <small class="text-muted">
                                        <i class="bi bi-clock-history me-1"></i>
                                        Última conexión: @cliente.UltimaConexionRemota.Value.ToString("dd/MM/yyyy HH:mm")
                                    </small>
                                </div>
                            }
                            
                            <!-- Acciones rápidas -->
                            <div class="col-12 border-top pt-3">
                                <div class="d-flex gap-2 flex-wrap">
                                    <button type="button" class="btn btn-outline-primary btn-sm" @onclick="ProbarConexionVPN" disabled="@(string.IsNullOrEmpty(_soporteTemp.IpVpn) || _probandoConexion)">
                                        @if (_probandoConexion)
                                        {
                                            <span class="spinner-border spinner-border-sm me-1"></span>
                                        }
                                        else
                                        {
                                            <i class="bi bi-wifi me-1"></i>
                                        }
                                        Probar
                                    </button>
                                    <button type="button" class="btn btn-outline-success btn-sm" @onclick="AbrirSistemaRemoto" disabled="@(string.IsNullOrEmpty(_soporteTemp.IpVpn))">
                                        <i class="bi bi-box-arrow-up-right me-1"></i>Abrir Sistema
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary btn-sm" @onclick="CopiarComandoRDP" disabled="@(string.IsNullOrEmpty(_soporteTemp.IpVpn))">
                                        <i class="bi bi-terminal me-1"></i>RDP
                                    </button>
                                </div>
                                @if (!string.IsNullOrEmpty(_resultadoPrueba))
                                {
                                    <div class="mt-2 small @(_exitoPrueba ? "text-success" : "text-danger")">
                                        <i class="bi @(_exitoPrueba ? "bi-check-circle" : "bi-x-circle") me-1"></i>@_resultadoPrueba
                                    </div>
                                }
                            </div>
                        }
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="CerrarModalSoporteRemoto">Cancelar</button>
                    <button type="button" class="btn btn-primary" @onclick="GuardarConfigSoporteRemoto" disabled="@_guardandoSoporte">
                        @if (_guardandoSoporte)
                        {
                            <span class="spinner-border spinner-border-sm me-1"></span>
                        }
                        else
                        {
                            <i class="bi bi-check-lg me-1"></i>
                        }
                        Guardar
                    </button>
                </div>
            </div>
        </div>
    </div>
}

@code {
    [Parameter]
    public int IdCliente { get; set; }

    private Cliente? cliente;
    private List<TiposDocumentosIdentidad> tiposDocumentos = new();
    private List<TiposContribuyentes> tiposContribuyentes = new();
    private List<Paises> paises = new();
    private List<CiudadCatalogo> ciudades = new();
    private List<TipoOperacion> tiposOperacion = new();
    private string? errorMessage;
    private bool isLoading = true;
    private bool editandoLimiteCredito => cliente?.LimiteCredito == null || editandoLimiteCreditoInterno;
    private bool editandoLimiteCreditoInterno = false;
    private bool consultandoRuc = false;
    private string? mensajeRuc;
    private bool esErrorRuc = false;
    // Precios diferenciados
    private bool mostrarPreciosDif = false;
    private List<ClientePrecio> preciosCliente = new();
    private string prodSearch = string.Empty;
    private List<Producto> prodOpciones = new();
    private bool prodMostrandoOpciones = false;
    private int prodSelectedIndex = -1;
    private int prodSelectedId = 0;
    private decimal? precioFijoGs;
    private decimal? porcentajeDesc;
    private CancellationTokenSource? _searchCts;
    
    // Estado de crédito
    private bool cargandoEstadoCredito = false;
    private EstadoCreditoCliente? estadoCredito;
    
    // ========== GIMNASIO ==========
    private bool _modoGimnasioActivo = false;
    private string? _fotoGimnasioBase64;
    private string? _errorFotoGimnasio;
    private DotNetObjectReference<EditarCliente>? _dotNetHelperGimnasio;
    


    public class EstadoCreditoCliente
    {
        public decimal SaldoPendiente { get; set; }
        public int CreditosVencidos { get; set; }
        public decimal MontoVencido { get; set; }
        public int CreditosPorVencer { get; set; }
        public decimal MontoPorVencer { get; set; }
    }
    
    // ========== SOPORTE REMOTO (DATOS DEL CLIENTE) ==========
    private bool _mostrarModalSoporteRemoto = false;
    private string? _mensajeModalSoporte;
    private bool _exitoModalSoporte = false;
    private bool _guardandoSoporte = false;
    private bool _probandoConexion = false;
    private string? _resultadoPrueba;
    private bool _exitoPrueba = false;
    private SoporteRemotoTemp _soporteTemp = new();
    
    private class SoporteRemotoTemp
    {
        public bool Habilitado { get; set; }
        public string? IpVpn { get; set; }
        public int? Puerto { get; set; } = 5095;
        public string? Notas { get; set; }
    }

    private void ActivarEdicionLimiteCredito()
    {
        editandoLimiteCreditoInterno = true;
    }

    private void OnLimiteCreditoBlur(FocusEventArgs e)
    {
        editandoLimiteCreditoInterno = false;
    }

    protected override async Task OnInitializedAsync()
    {
        try
        {
            await using var dbContext = await DbFactory.CreateDbContextAsync();
            tiposContribuyentes = await dbContext.TiposContribuyentes.ToListAsync();
            tiposDocumentos = await dbContext.TiposDocumentosIdentidad.ToListAsync();
            paises = await dbContext.Paises.ToListAsync();
            ciudades = await dbContext.CiudadesCatalogo.OrderBy(c => c.Nombre).ToListAsync();
            tiposOperacion = await dbContext.TiposOperacion.ToListAsync();

            cliente = await dbContext.Clientes.AsNoTracking().FirstOrDefaultAsync(c => c.IdCliente == IdCliente);
            
            // Cargar configuración del sistema para modo gimnasio
            var config = await dbContext.ConfiguracionSistema.FirstOrDefaultAsync();
            _modoGimnasioActivo = config?.GimnasioModoActivo ?? false;
            
            // Preparar foto de gimnasio para mostrar
            if (cliente?.FotoGimnasio != null && cliente.FotoGimnasio.Length > 0)
            {
                _fotoGimnasioBase64 = $"data:image/jpeg;base64,{Convert.ToBase64String(cliente.FotoGimnasio)}";
            }

            if (cliente == null)
            {
                errorMessage = "Cliente no encontrado.";
            }
            else
            {
                await EnsureTablaPreciosClienteAsync(dbContext);
                await CargarPreciosClienteAsync(dbContext, cliente.IdCliente);
                
                // Cargar estado de crédito si el cliente tiene habilitado el crédito
                if (cliente.PermiteCredito)
                {
                    await CargarEstadoCreditoAsync(dbContext);
                }
                

            }
        }
        catch (Exception ex)
        {
            errorMessage = "Error al cargar datos.";
            Console.WriteLine($"[ERROR] {ex.Message}");
        }
        isLoading = false;
    }

    private void TogglePreciosDiferenciados()
    {
        if (cliente is null) return;
        if (!cliente.PrecioDiferenciado)
        {
            cliente.PrecioDiferenciado = true;
        }
        mostrarPreciosDif = !mostrarPreciosDif;
    }

    private async Task EnsureTablaPreciosClienteAsync(AppDbContext ctx)
    {
        try
        {
            await ctx.Database.ExecuteSqlRawAsync(@"IF OBJECT_ID('dbo.ClientesPrecios','U') IS NULL
BEGIN
  CREATE TABLE [dbo].[ClientesPrecios](
    [IdClientePrecio] INT IDENTITY(1,1) NOT NULL PRIMARY KEY,
    [IdCliente] INT NOT NULL,
    [IdProducto] INT NOT NULL,
    [PrecioFijoGs] DECIMAL(18,4) NULL,
    [PorcentajeDescuento] DECIMAL(18,2) NULL,
    [Activo] BIT NOT NULL CONSTRAINT DF_ClientesPrecios_Activo DEFAULT(1),
    [FechaCreacion] DATETIME NOT NULL CONSTRAINT DF_ClientesPrecios_Fecha DEFAULT(GETDATE()),
    [UsuarioCreacion] VARCHAR(50) NULL
  );
  CREATE UNIQUE INDEX IX_ClientesPrecios_Cliente_Producto ON [dbo].[ClientesPrecios]([IdCliente],[IdProducto]);
END");
        }
        catch { }
    }

    private async Task CargarPreciosClienteAsync(AppDbContext ctx, int idCliente)
    {
        preciosCliente = await ctx.ClientesPrecios
            .AsNoTracking()
            .Include(cp => cp.Producto)
            .Where(cp => cp.IdCliente == idCliente && cp.Activo)
            .OrderBy(cp => cp.Producto!.Descripcion)
            .ToListAsync();
        StateHasChanged();
    }

    private void ShowProdOpciones()
    {
        prodMostrandoOpciones = true;
        if (prodOpciones.Count > 0 && prodSelectedIndex < 0) prodSelectedIndex = 0;
    }

    private async Task BuscarProductosAsync(string term, CancellationToken ct)
    {
        term = (term ?? string.Empty).Trim();
        if (string.IsNullOrWhiteSpace(term))
        {
            prodOpciones = new();
            prodSelectedIndex = -1;
            StateHasChanged();
            return;
        }
        await using var db = await DbFactory.CreateDbContextAsync();
        var q = db.Productos.AsNoTracking()
            .Where(p => p.Descripcion.Contains(term) || p.CodigoInterno.Contains(term))
            .OrderBy(p => p.Descripcion)
            .Take(20);
        prodOpciones = await q.ToListAsync(ct);
        prodSelectedIndex = prodOpciones.Count > 0 ? 0 : -1;
        StateHasChanged();
    }

    private async Task OnProdSearchChanged(ChangeEventArgs e)
    {
        prodSearch = e.Value?.ToString() ?? string.Empty;
        prodSelectedId = 0;
        prodMostrandoOpciones = true;
        prodSelectedIndex = -1;
        _searchCts?.Cancel();
        _searchCts = new CancellationTokenSource();
        var token = _searchCts.Token;
        try
        {
            await Task.Delay(200, token);
            await BuscarProductosAsync(prodSearch, token);
        }
        catch (TaskCanceledException) { }
    }

    private void SeleccionarProducto(Producto pr)
    {
        prodSelectedId = pr.IdProducto;
        prodSearch = pr.Descripcion;
        prodMostrandoOpciones = false;
        prodSelectedIndex = -1;
    }

    private async Task OnProdBlur(FocusEventArgs e)
    {
        await Task.Delay(150);
        prodMostrandoOpciones = false;
        StateHasChanged();
    }

    private void OnProdKeyDown(KeyboardEventArgs e)
    {
        if (!prodMostrandoOpciones) return;
        if (e.Key == "ArrowDown")
        {
            if (prodOpciones.Count == 0) return;
            prodSelectedIndex = (prodSelectedIndex + 1 + prodOpciones.Count) % prodOpciones.Count;
        }
        else if (e.Key == "ArrowUp")
        {
            if (prodOpciones.Count == 0) return;
            prodSelectedIndex = (prodSelectedIndex - 1 + prodOpciones.Count) % prodOpciones.Count;
        }
        else if (e.Key == "Enter")
        {
            if (prodSelectedIndex >= 0 && prodSelectedIndex < prodOpciones.Count)
            {
                SeleccionarProducto(prodOpciones[prodSelectedIndex]);
            }
        }
        else if (e.Key == "Escape")
        {
            prodMostrandoOpciones = false;
        }
    }

    private async Task AgregarPrecioCliente()
    {
        if (cliente is null || cliente.IdCliente <= 0) { await JS.InvokeVoidAsync("alert", "Cliente no válido"); return; }
        if (prodSelectedId <= 0) { return; }
        if (precioFijoGs is null && (porcentajeDesc is null || porcentajeDesc <= 0)) { await JS.InvokeVoidAsync("alert", "Ingrese un precio fijo o un porcentaje de descuento"); return; }
        await using var db = await DbFactory.CreateDbContextAsync();
        await EnsureTablaPreciosClienteAsync(db);
        var existe = await db.ClientesPrecios.AnyAsync(x => x.IdCliente == cliente.IdCliente && x.IdProducto == prodSelectedId);
        if (existe) { await JS.InvokeVoidAsync("alert", "Ese producto ya tiene precio diferenciado para este cliente"); return; }
        var nuevo = new ClientePrecio
        {
            IdCliente = cliente.IdCliente,
            IdProducto = prodSelectedId,
            PrecioFijoGs = precioFijoGs,
            PorcentajeDescuento = porcentajeDesc,
            Activo = true,
            UsuarioCreacion = "Sistema"
        };
        db.ClientesPrecios.Add(nuevo);
        await db.SaveChangesAsync();
        // Reset
        prodSelectedId = 0;
        prodSearch = string.Empty;
        prodOpciones.Clear();
        prodMostrandoOpciones = false;
        prodSelectedIndex = -1;
        precioFijoGs = null;
        porcentajeDesc = null;
        await CargarPreciosClienteAsync(db, cliente.IdCliente);
    }

    private async Task QuitarPrecioCliente(int idClientePrecio)
    {
        await using var db = await DbFactory.CreateDbContextAsync();
        var row = await db.ClientesPrecios.FirstOrDefaultAsync(x => x.IdClientePrecio == idClientePrecio);
        if (row is null) return;
        db.ClientesPrecios.Remove(row);
        await db.SaveChangesAsync();
        if (cliente is not null)
        {
            await CargarPreciosClienteAsync(db, cliente.IdCliente);
        }
    }

    private async Task ActualizarCliente()
    {
        await using var dbContext = await DbFactory.CreateDbContextAsync();
        if (cliente == null)
            return;
        try
        {
            // Validar que el RUC no esté duplicado en otro cliente
            if (!string.IsNullOrWhiteSpace(cliente.RUC))
            {
                var rucExiste = await dbContext.Clientes.AnyAsync(c => c.RUC == cliente.RUC && c.IdCliente != cliente.IdCliente);
                if (rucExiste)
                {
                    errorMessage = "Ya existe otro cliente con ese número de documento (RUC)";
                    return;
                }
            }
            
            // ========== NORMALIZACIÓN DE CAMPOS SIFEN ANTES DE GUARDAR ==========
            // Para No Contribuyentes (NaturalezaReceptor=2), asegurar que los campos estén completos
            if (cliente.NaturalezaReceptor == 2)
            {
                // Si no tiene tipo documento, usar CI paraguaya por defecto
                if (!cliente.TipoDocumentoIdentidadSifen.HasValue)
                {
                    cliente.TipoDocumentoIdentidadSifen = 1; // CI paraguaya
                }
                
                // Si NumeroDocumentoIdentidad está vacío pero tiene RUC, copiar el RUC
                if (string.IsNullOrWhiteSpace(cliente.NumeroDocumentoIdentidad) && !string.IsNullOrWhiteSpace(cliente.RUC))
                {
                    cliente.NumeroDocumentoIdentidad = cliente.RUC.Replace("-", "").Replace(" ", "").Trim();
                }
                
                // Si es Innominado (tipo 5), no necesita número de documento
                if (cliente.TipoDocumentoIdentidadSifen == 5)
                {
                    cliente.NumeroDocumentoIdentidad = null;
                }
            }
            else if (cliente.NaturalezaReceptor == 1)
            {
                // Contribuyentes usan RUC, no necesitan TipoDocumentoIdentidadSifen
                cliente.TipoDocumentoIdentidadSifen = null;
                cliente.NumeroDocumentoIdentidad = null;
            }
            // =====================================================================
            
            dbContext.Clientes.Update(cliente);
            await dbContext.SaveChangesAsync();
            Navigation.NavigateTo("/clientes");
        }
        catch (Exception ex)
        {
            errorMessage = ex.Message.Contains("suscripción") ? ex.Message : "Error al actualizar el cliente.";
            Console.WriteLine($"[ERROR] {ex.Message}");
        }
    }

    private async Task OnRucChanged()
    {
        if (cliente == null)
            return;
        if (string.IsNullOrWhiteSpace(cliente.RUC))
        {
            mensajeRuc = "Por favor ingrese un número de RUC";
            esErrorRuc = true;
            return;
        }
        if (!cliente.RUC.All(char.IsDigit))
        {
            mensajeRuc = "El RUC debe contener solo números";
            esErrorRuc = true;
            return;
        }
        if (cliente.RUC.Length < 5 || cliente.RUC.Length > 8)
        {
            mensajeRuc = "El RUC debe tener entre 5 y 8 dígitos";
            esErrorRuc = true;
            return;
        }
        cliente.DV = RucHelper.CalcularDvRuc(cliente.RUC);
        
        // PASO 1: Buscar primero en RucDnit (1.5M registros locales - más rápido)
        try
        {
            var datosLocal = await RucDnitService.ObtenerDatosRucAsync(cliente.RUC);
            if (datosLocal.Nombre != null)
            {
                cliente.RazonSocial = datosLocal.Nombre;
                if (datosLocal.DV.HasValue)
                    cliente.DV = datosLocal.DV.Value;
                
                // Si el RUC fue encontrado, es un CONTRIBUYENTE (NaturalezaReceptor = 1)
                cliente.NaturalezaReceptor = 1; // Contribuyente (tiene RUC activo)
                
                // Determinar tipo según longitud del RUC:
                // RUC con 8 dígitos = Persona Jurídica (ej: 80033703)
                // RUC con 7 dígitos o menos = Persona Física (ej: 4637249)
                if (cliente.RUC.Length == 8)
                {
                    cliente.IdTipoContribuyente = 2; // Persona Jurídica (8 dígitos)
                }
                else
                {
                    cliente.IdTipoContribuyente = 1; // Persona Física (7 dígitos o menos)
                }
                
                // Determinar TipoOperacion según valor del RUC:
                // RUC >= 50,000,000 = B2B (empresas y extranjeros)
                // RUC < 50,000,000 = B2C (personas físicas/clientes)
                if (long.TryParse(cliente.RUC, out long rucNumerico))
                {
                    cliente.TipoOperacion = rucNumerico >= 50_000_000 ? "1" : "2"; // 1=B2B, 2=B2C
                }
                
                // Establecer TipoDocumento = RUC
                cliente.TipoDocumento = "RU";
                cliente.NumeroDocumento = cliente.RUC;
                
                // Contribuyentes NO usan TipoDocumentoIdentidadSifen (usan RUC directamente)
                cliente.TipoDocumentoIdentidadSifen = null;
                cliente.NumeroDocumentoIdentidad = null;
                
                // Por defecto, es paraguayo (no extranjero)
                if (string.IsNullOrEmpty(cliente.CodigoPais))
                {
                    cliente.CodigoPais = "PRY";
                }
                cliente.EsExtranjero = cliente.CodigoPais != "PRY";
                
                var estadoInfo = datosLocal.Estado ?? "ACTIVO";
                cliente.Estado = estadoInfo.ToUpper().Contains("ACTIVO");
                
                mensajeRuc = $"✓ {cliente.RazonSocial} (DNIT local) - {estadoInfo}";
                esErrorRuc = false;
                StateHasChanged();
                return;
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"[DEBUG] RucDnit no disponible: {ex.Message}");
        }
        
        // PASO 2: Si no está en RucDnit, consultar SIFEN (API externa)
        try
        {
            await using var dbContext = await DbFactory.CreateDbContextAsync();
            var sociedad = await dbContext.Sociedades.FirstOrDefaultAsync();
            if (sociedad == null)
            {
                mensajeRuc = "No hay sociedad configurada en el sistema";
                esErrorRuc = true;
                return;
            }
            
            Console.WriteLine($"[DEBUG] Sociedad encontrada: {sociedad.Nombre}");
            Console.WriteLine($"[DEBUG] CertificadoRuta: {sociedad.PathCertificadoP12}");
            Console.WriteLine($"[DEBUG] CertificadoPassword existe: {!string.IsNullOrEmpty(sociedad.PasswordCertificadoP12)}");
            
            if (string.IsNullOrEmpty(sociedad.PathCertificadoP12) || string.IsNullOrEmpty(sociedad.PasswordCertificadoP12))
            {
                mensajeRuc = "La sociedad no tiene configurado el certificado digital";
                esErrorRuc = true;
                return;
            }
            
            Console.WriteLine($"[DEBUG] Iniciando consulta RUC para: {cliente.RUC}");
            
            // Usar URLs de SIFEN desde configuración de sociedad
            var url = sociedad.DeUrlConsultaRuc ?? SifenConfig.GetConsultaRucUrl("test");
            // IMPORTANTE: La URL DEBE terminar en .wsdl para evitar error 0160
            if (!string.IsNullOrWhiteSpace(url) && !url.EndsWith(".wsdl", StringComparison.OrdinalIgnoreCase))
            {
                url = url + ".wsdl";
            }
            
            var sifen = new Sifen();
            var xmlRespuesta = await sifen.Consulta(url, cliente.RUC, "1", sociedad.PathCertificadoP12 ?? "", sociedad.PasswordCertificadoP12 ?? "");
            
            Console.WriteLine($"[DEBUG EditarCliente] Respuesta recibida, longitud: {xmlRespuesta?.Length ?? 0}");
            Console.WriteLine($"[DEBUG EditarCliente] Primeros 100 chars: {xmlRespuesta?.Substring(0, Math.Min(100, xmlRespuesta?.Length ?? 0))}");
            
            if (string.IsNullOrEmpty(xmlRespuesta))
            {
                Console.WriteLine($"[DEBUG EditarCliente] ❌ Respuesta vacía");
                mensajeRuc = "⚠️ Sin respuesta de SIFEN. Verifique conexión e intente nuevamente.";
                esErrorRuc = true;
                return;
            }
            
            // Verificar si la respuesta es un JSON de error (todos los reintentos fallaron)
            bool esJsonError = xmlRespuesta.TrimStart().StartsWith("{") && xmlRespuesta.Contains("\"error\"");
            Console.WriteLine($"[DEBUG EditarCliente] ¿Es JSON de error?: {esJsonError}");
            
            if (esJsonError)
            {
                Console.WriteLine($"[DEBUG EditarCliente] ❌ Respuesta es JSON de error");
                mensajeRuc = "⚠️ Error de conexión con SIFEN. Intente nuevamente.";
                esErrorRuc = true;
                return;
            }
            
            // Verificar tipo de respuesta SIFEN
            // - rResEnviConsRUC = respuesta de consulta RUC (lo que esperamos)
            // - rRetEnviDe = respuesta de envío DE (error del servidor - respuesta equivocada)
            bool esRespuestaConsultaRuc = xmlRespuesta.Contains("rResEnviConsRUC") || xmlRespuesta.Contains("xContRUC");
            bool esRespuestaEnvioDe = xmlRespuesta.Contains("rRetEnviDe") || xmlRespuesta.Contains("rProtDe");
            bool tieneError0160 = xmlRespuesta.Contains("0160") || xmlRespuesta.Contains("XML Mal Formado");
            bool tieneExito0502 = xmlRespuesta.Contains(">0502<");
            
            Console.WriteLine($"[DEBUG EditarCliente] ¿Es respuesta ConsultaRUC?: {esRespuestaConsultaRuc}");
            Console.WriteLine($"[DEBUG EditarCliente] ¿Es respuesta EnvíoDE (error servidor)?: {esRespuestaEnvioDe}");
            Console.WriteLine($"[DEBUG EditarCliente] ¿Tiene error 0160?: {tieneError0160}, ¿Tiene éxito 0502?: {tieneExito0502}");
            
            // Si recibimos respuesta de tipo EnvíoDE en lugar de ConsultaRUC, es error del servidor BIG-IP
            if (esRespuestaEnvioDe && !esRespuestaConsultaRuc)
            {
                Console.WriteLine($"[DEBUG EditarCliente] ⚠️ Servidor devolvió respuesta tipo incorrecto (rRetEnviDe)");
                mensajeRuc = "⚠️ Error de servidor SIFEN. Intente nuevamente.";
                esErrorRuc = true;
                return;
            }
            
            // Verificar error 0160 solo si NO es respuesta de consulta RUC válida
            if (tieneError0160 && !esRespuestaConsultaRuc && !tieneExito0502)
            {
                Console.WriteLine($"[DEBUG EditarCliente] ❌ Error de formato 0160");
                mensajeRuc = "⚠️ Error de formato en SIFEN. Intente nuevamente.";
                esErrorRuc = true;
                return;
            }
            
            Console.WriteLine($"[DEBUG EditarCliente] ✓ Procesando respuesta XML...");
            var xmlDoc = new System.Xml.XmlDocument();
            xmlDoc.LoadXml(xmlRespuesta);
            
            // Buscar código de respuesta
            var codResNode = xmlDoc.SelectSingleNode("//*[local-name()='dCodRes']");
            var msgResNode = xmlDoc.SelectSingleNode("//*[local-name()='dMsgRes']");
            var codRes = codResNode?.InnerText ?? "";
            var msgRes = msgResNode?.InnerText ?? "";
            
            Console.WriteLine($"[DEBUG EditarCliente] dCodRes: {codRes}, dMsgRes: {msgRes}");
            
            // Código 0502 = RUC encontrado
            if (codRes == "0502")
            {
                // Buscar datos del contribuyente dentro de xContRUC
                // Campos reales de SIFEN: dRUCCons, dRazCons, dCodEstCons, dDesEstCons, dRUCFactElec
                var xContRUC = xmlDoc.SelectSingleNode("//*[local-name()='xContRUC']");
                if (xContRUC != null)
                {
                    // dRazCons = Razón Social del contribuyente consultado
                    var dRazCons = xContRUC.SelectSingleNode(".//*[local-name()='dRazCons']")?.InnerText;
                    // dDesEstCons = Descripción del estado (ACTIVO, INACTIVO, etc.)
                    var dDesEstCons = xContRUC.SelectSingleNode(".//*[local-name()='dDesEstCons']")?.InnerText;
                    // dCodEstCons = Código del estado (ACT, INA, etc.)
                    var dCodEstCons = xContRUC.SelectSingleNode(".//*[local-name()='dCodEstCons']")?.InnerText;
                    // dRUCFactElec = Si puede facturar electrónicamente (S/N)
                    var dRUCFactElec = xContRUC.SelectSingleNode(".//*[local-name()='dRUCFactElec']")?.InnerText;
                    
                    Console.WriteLine($"[DEBUG EditarCliente] dRazCons: {dRazCons}");
                    Console.WriteLine($"[DEBUG EditarCliente] dDesEstCons: {dDesEstCons}");
                    Console.WriteLine($"[DEBUG EditarCliente] dCodEstCons: {dCodEstCons}");
                    Console.WriteLine($"[DEBUG EditarCliente] dRUCFactElec: {dRUCFactElec}");
                    
                    bool datosActualizados = false;
                    
                    // Actualizar cliente con datos de SIFEN
                    if (!string.IsNullOrEmpty(dRazCons))
                    {
                        cliente.RazonSocial = dRazCons.Trim();
                        datosActualizados = true;
                    }
                    
                    // Estado del contribuyente
                    if (!string.IsNullOrEmpty(dDesEstCons))
                    {
                        cliente.Estado = dDesEstCons.ToUpper().Contains("ACTIVO") || dCodEstCons == "ACT";
                        datosActualizados = true;
                    }
                    
                    // Determinar tipo de contribuyente por la longitud del RUC
                    // RUC con 8 dígitos = Persona Jurídica (ej: 80033703)
                    // RUC con 7 dígitos o menos = Persona Física (ej: 4637249)
                    if (!string.IsNullOrEmpty(cliente.RUC))
                    {
                        // Si el RUC fue encontrado en SIFEN, es un CONTRIBUYENTE (NaturalezaReceptor = 1)
                        cliente.NaturalezaReceptor = 1; // Contribuyente (tiene RUC activo en SIFEN)
                        
                        // Determinar tipo: Persona Física o Jurídica según longitud del RUC
                        if (cliente.RUC.Length == 8)
                        {
                            cliente.IdTipoContribuyente = 2; // Persona Jurídica (8 dígitos)
                        }
                        else
                        {
                            cliente.IdTipoContribuyente = 1; // Persona Física (7 dígitos o menos)
                        }
                        
                        // Establecer TipoDocumento = RUC
                        cliente.TipoDocumento = "RU";
                        cliente.NumeroDocumento = cliente.RUC;
                        
                        // Determinar TipoOperacion según valor del RUC:
                        // RUC >= 50,000,000 = B2B (empresas y extranjeros)
                        // RUC < 50,000,000 = B2C (personas físicas/clientes)
                        if (long.TryParse(cliente.RUC, out long rucNumerico))
                        {
                            cliente.TipoOperacion = rucNumerico >= 50_000_000 ? "1" : "2"; // 1=B2B, 2=B2C
                        }
                        
                        // Contribuyentes NO usan TipoDocumentoIdentidadSifen (usan RUC directamente)
                        cliente.TipoDocumentoIdentidadSifen = null;
                        cliente.NumeroDocumentoIdentidad = null;
                        
                        // Por defecto, es paraguayo (no extranjero)
                        if (string.IsNullOrEmpty(cliente.CodigoPais))
                        {
                            cliente.CodigoPais = "PRY";
                        }
                        cliente.EsExtranjero = cliente.CodigoPais != "PRY";
                        
                        datosActualizados = true;
                    }
                    
                    if (datosActualizados)
                    {
                        mensajeRuc = $"✓ {dRazCons?.Trim()} (SIFEN) - {dDesEstCons}";
                        esErrorRuc = false;
                        StateHasChanged();
                    }
                    else
                    {
                        mensajeRuc = "RUC encontrado pero sin datos actualizables";
                        esErrorRuc = true;
                    }
                }
                else
                {
                    mensajeRuc = "RUC encontrado pero sin datos del contribuyente";
                    esErrorRuc = true;
                }
            }
            else if (codRes == "0501")
            {
                // 0501 = RUC no encontrado en SIFEN
                // Si no está en RucDnit local NI en SIFEN, es una Cédula de Identidad
                cliente.NaturalezaReceptor = 2; // No contribuyente
                cliente.TipoDocumentoIdentidadSifen = 1; // Cédula de Identidad Paraguaya
                cliente.NumeroDocumentoIdentidad = cliente.RUC; // Copiar el número
                cliente.TipoDocumento = "CI";
                cliente.NumeroDocumento = cliente.RUC;
                cliente.IdTipoContribuyente = 1; // Persona Física
                
                mensajeRuc = $"✓ Número identificado como Cédula de Identidad (no encontrado como RUC en SET)";
                esErrorRuc = false; // No es error, es información
                StateHasChanged();
            }
            else
            {
                mensajeRuc = $"Respuesta SIFEN: [{codRes}] {msgRes}";
                esErrorRuc = codRes != "0500"; // 0500 es procesado correctamente
            }
        }
        catch (Exception ex)
        {
            mensajeRuc = $"Error al consultar RUC: {ex.Message}";
            esErrorRuc = true;
            Console.WriteLine($"[ERROR] {ex.Message}");
        }
    }

    private void Cancelar()
    {
        Navigation.NavigateTo("/clientes");
    }

    private async Task OnCiudadChanged(ChangeEventArgs e)
    {
        if (cliente != null && int.TryParse(e.Value?.ToString(), out int ciudadId))
        {
            cliente.IdCiudad = ciudadId;
            
            // Configuración automática de datos SIFEN según la ciudad seleccionada
            await ConfigurarDatosSifenPorCiudad(ciudadId);
        }
    }

    private async Task OnCiudadChangedAfter()
    {
        // Configuración automática de datos SIFEN después de que el binding se complete
        if (cliente != null && cliente.IdCiudad > 0)
        {
            await ConfigurarDatosSifenPorCiudad(cliente.IdCiudad);
        }
    }

    private async Task ConfigurarDatosSifenPorCiudad(int ciudadId)
    {
        if (cliente == null) return;

        try
        {
            await using var dbContext = await DbFactory.CreateDbContextAsync();
            var ciudad = await dbContext.CiudadesCatalogo.FindAsync(ciudadId);
            if (ciudad == null) return;

            var dep = await dbContext.DepartamentosCatalogo.FindAsync(ciudad.Departamento);
            var dis = await dbContext.DistritosCatalogo.FindAsync(ciudad.Distrito);

            if (dep != null)
            {
                cliente.CodigoDepartamento = ciudad.Departamento.ToString("00");
                cliente.DescripcionDepartamento = dep.Nombre.ToUpperInvariant();
            }
            if (dis != null)
            {
                cliente.CodigoDistrito = ciudad.Distrito.ToString("0000");
                cliente.DescripcionDistrito = dis.Nombre.ToUpperInvariant();
            }

            StateHasChanged();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"[ERROR] Error al configurar datos SIFEN por ciudad: {ex.Message}");
        }
    }

    private async Task ConsultarRucManual()
    {
        if (cliente == null || string.IsNullOrWhiteSpace(cliente.RUC))
        {
            mensajeRuc = "Por favor ingrese un número de RUC";
            esErrorRuc = true;
            return;
        }

        consultandoRuc = true;
        mensajeRuc = "Consultando datos en DNIT SET Paraguay...";
        esErrorRuc = false;
        StateHasChanged();

        try
        {
            await OnRucChanged();
        }
        finally
        {
            consultandoRuc = false;
            StateHasChanged();
        }
    }

    private Task OnTipoDocIdentidadChangedAfter()
    {
        if (cliente != null && cliente.TipoDocumentoIdentidadSifen == 5)
        {
            cliente.NumeroDocumentoIdentidad = "0";
        }
        return Task.CompletedTask;
    }

    /// <summary>
    /// Cuando cambia NaturalezaReceptor, ajustar campos SIFEN automáticamente.
    /// Contribuyentes (1) NO usan iTipIDRec, solo usan RUC.
    /// No Contribuyentes (2) SÍ usan iTipIDRec + NumeroDocumentoIdentidad.
    /// </summary>
    private Task OnNaturalezaReceptorChanged()
    {
        if (cliente != null)
        {
            if (cliente.NaturalezaReceptor == 1) // Contribuyente
            {
                // Contribuyentes no usan TipoDocumentoIdentidadSifen (se envía RUC en su lugar)
                cliente.TipoDocumentoIdentidadSifen = null;
                cliente.NumeroDocumentoIdentidad = null;
            }
            else if (cliente.NaturalezaReceptor == 2) // No contribuyente
            {
                // Si no tiene tipo doc, asignar CI paraguaya por defecto
                if (!cliente.TipoDocumentoIdentidadSifen.HasValue)
                {
                    cliente.TipoDocumentoIdentidadSifen = 1; // Cédula paraguaya
                }
                
                // FIX: Copiar RUC/Cédula al campo NumeroDocumentoIdentidad si está vacío
                // Para No Contribuyentes, SIFEN requiere iTipIDRec + dNumIDRec
                if (string.IsNullOrWhiteSpace(cliente.NumeroDocumentoIdentidad) && !string.IsNullOrWhiteSpace(cliente.RUC))
                {
                    // Quitar guiones y espacios, solo dejar números
                    cliente.NumeroDocumentoIdentidad = cliente.RUC.Replace("-", "").Replace(" ", "").Trim();
                }
            }
        }
        return Task.CompletedTask;
    }

    /// <summary>
    /// Cuando cambia el país, configurar automáticamente EsExtranjero y campos SIFEN
    /// </summary>
    private Task OnPaisChanged()
    {
        if (cliente != null)
        {
            cliente.EsExtranjero = !string.IsNullOrEmpty(cliente.CodigoPais) && cliente.CodigoPais != "PRY";
            ConfigurarCamposSifenExtranjero();
        }
        return Task.CompletedTask;
    }

    /// <summary>
    /// Cuando cambia el checkbox de Extranjero manualmente
    /// </summary>
    private Task OnExtranjeroChanged()
    {
        if (cliente != null)
        {
            ConfigurarCamposSifenExtranjero();
            
            // Si se marca como extranjero pero el país es Paraguay o vacío, limpiar país
            if (cliente.EsExtranjero && (string.IsNullOrEmpty(cliente.CodigoPais) || cliente.CodigoPais == "PRY"))
            {
                cliente.CodigoPais = ""; // Limpiar para que el usuario seleccione el país correcto
            }
            // Si se desmarca extranjero, establecer Paraguay
            else if (!cliente.EsExtranjero)
            {
                cliente.CodigoPais = "PRY";
            }
        }
        return Task.CompletedTask;
    }

    /// <summary>
    /// Configura los campos SIFEN según si el cliente es extranjero o no
    /// </summary>
    private void ConfigurarCamposSifenExtranjero()
    {
        if (cliente == null) return;

        if (cliente.EsExtranjero)
        {
            // Cliente Extranjero:
            // - TipoOperacion = "4" (B2F - Venta a Extranjero)
            // - NaturalezaReceptor = 2 (No contribuyente, porque no tiene RUC paraguayo)
            // - TipoDocumentoIdentidadSifen = 3 (Pasaporte) por defecto si no está seteado
            cliente.TipoOperacion = "4"; // B2F - Venta a Extranjero
            cliente.NaturalezaReceptor = 2; // No contribuyente (sin RUC paraguayo)
            
            // Si no tiene tipo de documento, usar Pasaporte por defecto para extranjeros
            if (!cliente.TipoDocumentoIdentidadSifen.HasValue || cliente.TipoDocumentoIdentidadSifen == 1)
            {
                cliente.TipoDocumentoIdentidadSifen = 3; // Pasaporte
            }
        }
        else
        {
            // Cliente paraguayo - mantener configuración normal
            // Si tiene RUC válido, será Contribuyente (1); si no, será No Contribuyente (2)
            cliente.CodigoPais = "PRY";
            
            // Determinar TipoOperacion según valor del RUC si está disponible:
            if (!string.IsNullOrWhiteSpace(cliente.RUC) && long.TryParse(cliente.RUC, out long rucNumerico))
            {
                cliente.TipoOperacion = rucNumerico >= 50_000_000 ? "1" : "2"; // 1=B2B, 2=B2C
            }
            else if (string.IsNullOrWhiteSpace(cliente.TipoOperacion))
            {
                cliente.TipoOperacion = "2"; // B2C por defecto para clientes sin RUC
            }
        }
    }
    
    private async Task CargarEstadoCreditoAsync(AppDbContext dbContext)
    {
        if (cliente == null) return;
        
        cargandoEstadoCredito = true;
        StateHasChanged();
        
        try
        {
            var hoy = DateTime.Today;
            var dentro7Dias = hoy.AddDays(7);
            
            var cuentas = await dbContext.CuentasPorCobrar
                .Where(c => c.IdCliente == cliente.IdCliente && c.Estado == "PENDIENTE")
                .ToListAsync();
            
            estadoCredito = new EstadoCreditoCliente
            {
                SaldoPendiente = cuentas.Sum(c => c.SaldoPendiente),
                CreditosVencidos = cuentas.Count(c => c.FechaVencimiento < hoy),
                MontoVencido = cuentas.Where(c => c.FechaVencimiento < hoy).Sum(c => c.SaldoPendiente),
                CreditosPorVencer = cuentas.Count(c => c.FechaVencimiento >= hoy && c.FechaVencimiento <= dentro7Dias),
                MontoPorVencer = cuentas.Where(c => c.FechaVencimiento >= hoy && c.FechaVencimiento <= dentro7Dias).Sum(c => c.SaldoPendiente)
            };
        }
        catch (Exception ex)
        {
            Console.WriteLine($"[ERROR] CargarEstadoCreditoAsync: {ex.Message}");
            estadoCredito = null;
        }
        finally
        {
            cargandoEstadoCredito = false;
            StateHasChanged();
        }
    }
    
    // ========== MÉTODOS SOPORTE REMOTO ==========
    
    private void AbrirModalSoporteRemoto()
    {
        // Inicializar datos temporales con los del cliente
        _soporteTemp = new SoporteRemotoTemp
        {
            Habilitado = cliente?.HabilitadoSoporteRemoto ?? false,
            IpVpn = cliente?.IpVpnAsignada,
            Puerto = cliente?.PuertoSistema ?? 5095,
            Notas = cliente?.NotasAccesoRemoto
        };
        
        _mensajeModalSoporte = null;
        _resultadoPrueba = null;
        _mostrarModalSoporteRemoto = true;
    }
    
    private void CerrarModalSoporteRemoto()
    {
        _mostrarModalSoporteRemoto = false;
        _mensajeModalSoporte = null;
        _resultadoPrueba = null;
    }
    
    private async Task GuardarConfigSoporteRemoto()
    {
        if (cliente == null) return;
        
        _guardandoSoporte = true;
        _mensajeModalSoporte = null;
        StateHasChanged();
        
        try
        {
            await using var dbContext = await DbFactory.CreateDbContextAsync();
            var clienteDb = await dbContext.Clientes.FindAsync(cliente.IdCliente);
            
            if (clienteDb != null)
            {
                clienteDb.HabilitadoSoporteRemoto = _soporteTemp.Habilitado;
                clienteDb.IpVpnAsignada = _soporteTemp.IpVpn?.Trim();
                clienteDb.PuertoSistema = _soporteTemp.Puerto ?? 5095;
                clienteDb.NotasAccesoRemoto = _soporteTemp.Notas?.Trim();
                
                await dbContext.SaveChangesAsync();
                
                // Actualizar cliente local
                cliente.HabilitadoSoporteRemoto = clienteDb.HabilitadoSoporteRemoto;
                cliente.IpVpnAsignada = clienteDb.IpVpnAsignada;
                cliente.PuertoSistema = clienteDb.PuertoSistema;
                cliente.NotasAccesoRemoto = clienteDb.NotasAccesoRemoto;
                
                _exitoModalSoporte = true;
                _mensajeModalSoporte = "Datos guardados correctamente.";
                
                // Cerrar modal después de un momento
                await Task.Delay(1200);
                CerrarModalSoporteRemoto();
            }
        }
        catch (Exception ex)
        {
            _exitoModalSoporte = false;
            _mensajeModalSoporte = $"Error al guardar: {ex.Message}";
        }
        finally
        {
            _guardandoSoporte = false;
            StateHasChanged();
        }
    }
    
    private async Task ProbarConexionVPN()
    {
        if (string.IsNullOrWhiteSpace(_soporteTemp.IpVpn)) return;
        
        _probandoConexion = true;
        _resultadoPrueba = null;
        StateHasChanged();
        
        try
        {
            var url = $"http://{_soporteTemp.IpVpn}:{_soporteTemp.Puerto ?? 5095}/";
            using var httpClient = new HttpClient { Timeout = TimeSpan.FromSeconds(5) };
            
            var response = await httpClient.GetAsync(url);
            
            if (response.IsSuccessStatusCode)
            {
                _exitoPrueba = true;
                _resultadoPrueba = $"✓ Conectado a {_soporteTemp.IpVpn}";
                
                // Registrar última conexión
                if (cliente != null)
                {
                    await using var dbContext = await DbFactory.CreateDbContextAsync();
                    var clienteDb = await dbContext.Clientes.FindAsync(cliente.IdCliente);
                    if (clienteDb != null)
                    {
                        clienteDb.UltimaConexionRemota = DateTime.Now;
                        await dbContext.SaveChangesAsync();
                        cliente.UltimaConexionRemota = clienteDb.UltimaConexionRemota;
                    }
                }
            }
            else
            {
                _exitoPrueba = false;
                _resultadoPrueba = $"Código {(int)response.StatusCode}";
            }
        }
        catch (TaskCanceledException)
        {
            _exitoPrueba = false;
            _resultadoPrueba = "Timeout (5s)";
        }
        catch (HttpRequestException)
        {
            _exitoPrueba = false;
            _resultadoPrueba = "Sin conexión";
        }
        catch (Exception ex)
        {
            _exitoPrueba = false;
            _resultadoPrueba = ex.Message;
        }
        finally
        {
            _probandoConexion = false;
            StateHasChanged();
        }
    }
    
    private async Task AbrirSistemaRemoto()
    {
        if (string.IsNullOrWhiteSpace(_soporteTemp.IpVpn)) return;
        
        var url = $"http://{_soporteTemp.IpVpn}:{_soporteTemp.Puerto ?? 5095}/";
        await JS.InvokeVoidAsync("open", url, "_blank");
    }
    
    private async Task CopiarComandoRDP()
    {
        if (string.IsNullOrWhiteSpace(_soporteTemp.IpVpn)) return;
        
        var comando = $"mstsc /v:{_soporteTemp.IpVpn}";
        await JS.InvokeVoidAsync("navigator.clipboard.writeText", comando);
        
        _resultadoPrueba = "RDP copiado";
        _exitoPrueba = true;
        StateHasChanged();
    }
    
    // ========== MÉTODOS GIMNASIO ==========
    
    private async Task OnFotoGimnasioSelected(InputFileChangeEventArgs e)
    {
        if (cliente == null) return;
        
        try
        {
            var archivo = e.File;
            if (archivo.Size > 5 * 1024 * 1024)
            {
                _errorFotoGimnasio = "La imagen no debe superar 5 MB";
                StateHasChanged();
                return;
            }
            
            using var stream = archivo.OpenReadStream(5 * 1024 * 1024);
            using var ms = new MemoryStream();
            await stream.CopyToAsync(ms);
            await ProcesarImagenGimnasioAsync(ms.ToArray());
        }
        catch (Exception ex)
        {
            Console.WriteLine($"[ERROR] OnFotoGimnasioSelected: {ex.Message}");
            _errorFotoGimnasio = "Error al cargar la imagen";
            StateHasChanged();
        }
    }
    
    private async Task CapturarConCamaraGimnasio()
    {
        _dotNetHelperGimnasio = DotNetObjectReference.Create(this);
        await JS.InvokeVoidAsync("capturarFotoConCamaraGimnasio", _dotNetHelperGimnasio);
    }
    
    [JSInvokable]
    public async Task RecibirImagenDesdeCamaraGimnasio(string? base64Image)
    {
        if (!string.IsNullOrEmpty(base64Image))
        {
            var imageBytes = Convert.FromBase64String(base64Image.Split(',')[1]);
            await ProcesarImagenGimnasioAsync(imageBytes);
        }
        await InvokeAsync(StateHasChanged);
    }
    
    private async Task ProcesarImagenGimnasioAsync(byte[] imagenBytes)
    {
        if (cliente == null) return;
        
        _errorFotoGimnasio = null;
        cliente.FotoGimnasio = imagenBytes;
        _fotoGimnasioBase64 = $"data:image/jpeg;base64,{Convert.ToBase64String(imagenBytes)}";
        
        if (imagenBytes == null || imagenBytes.Length == 0)
        {
            cliente.EmbeddingFacialGimnasio = null;
            StateHasChanged();
            return;
        }
        
        try
        {
            await Task.Run(() =>
            {
                var baseDir = AppContext.BaseDirectory;
                var modeloPath = Path.Combine(baseDir, "face_recognition_models");
                if (!Directory.Exists(modeloPath))
                    modeloPath = @"C:\asis\SistemIA\face_recognition_models";
                    
                using var faceRecognition = FaceRecognition.Create(modeloPath);
                using var ms = new MemoryStream(imagenBytes);
                using var bitmap = new System.Drawing.Bitmap(ms);
                using var img = FaceRecognition.LoadImage(bitmap);
                
                var faceLocations = faceRecognition.FaceLocations(img).ToArray();
                if (faceLocations.Length != 1)
                {
                    _errorFotoGimnasio = faceLocations.Length == 0 
                        ? "No se detectó ningún rostro en la imagen" 
                        : "La foto debe contener exactamente un rostro";
                    cliente.EmbeddingFacialGimnasio = null;
                    return;
                }
                
                var encodings = faceRecognition.FaceEncodings(img, faceLocations).ToArray();
                if (encodings.Length != 1)
                {
                    _errorFotoGimnasio = "Error al procesar el rostro";
                    cliente.EmbeddingFacialGimnasio = null;
                    return;
                }
                
                using var encoding = encodings[0];
                cliente.EmbeddingFacialGimnasio = ConvertDoubleArrayToByteArrayGimnasio(encoding.GetRawEncoding());
            });
        }
        catch (Exception ex)
        {
            _errorFotoGimnasio = $"Error al procesar: {ex.Message}";
            cliente.EmbeddingFacialGimnasio = null;
            Console.WriteLine($"[ERROR] ProcesarImagenGimnasioAsync: {ex}");
        }
        finally
        {
            await InvokeAsync(StateHasChanged);
        }
    }
    
    private static byte[] ConvertDoubleArrayToByteArrayGimnasio(double[] array)
    {
        var result = new byte[array.Length * sizeof(double)];
        Buffer.BlockCopy(array, 0, result, 0, result.Length);
        return result;
    }
    
    private void EliminarFotoGimnasio()
    {
        if (cliente == null) return;
        
        cliente.FotoGimnasio = null;
        cliente.EmbeddingFacialGimnasio = null;
        _fotoGimnasioBase64 = null;
        _errorFotoGimnasio = null;
        StateHasChanged();
    }
    
    public void Dispose()
    {
        _dotNetHelperGimnasio?.Dispose();
    }
}

