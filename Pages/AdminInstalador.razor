@page "/admin/instalador"
@using Microsoft.EntityFrameworkCore
@using SistemIA.Models
@using SistemIA.Controllers
@using System.Text
@using System.Text.Json
@using System.IO.Compression
@using Microsoft.Data.SqlClient
@inject IDbContextFactory<AppDbContext> DbFactory
@inject IJSRuntime JS
@inject IWebHostEnvironment Env
@inject IConfiguration Configuration
@inject NavigationManager Navigation

<PageTitle>Generador de Instalador - SistemIA</PageTitle>

<SaProtection TituloPagina="Generador de Instalador" UrlRetorno="/">
<div class="container py-4">
    <div class="row justify-content-center">
        <div class="col-lg-10 col-xl-10">
            <!-- Header -->
            <div class="text-center mb-4">
                <div class="mb-3">
                    <i class="bi bi-box-seam display-3 text-primary"></i>
                </div>
                <h2 class="fw-bold">Generador de Instalador</h2>
                <p class="text-muted">Genere el paquete de instalaci√≥n de SistemIA con configuraci√≥n personalizada</p>
            </div>

            <!-- Card principal -->
            <div class="card shadow-lg border-0">
                <div class="card-body p-4">
                    <div class="row g-4">
                        <!-- Columna izquierda - Versi√≥n y opciones de BD -->
                        <div class="col-md-6">
                            <!-- Versi√≥n -->
                            <div class="mb-4">
                                <label class="form-label fw-bold">
                                    <i class="bi bi-tag me-2"></i>Versi√≥n del Paquete
                                </label>
                                <input type="text" class="form-control form-control-lg text-center" 
                                       @bind="_version" disabled="@_generando" 
                                       style="font-size: 1.3rem; letter-spacing: 2px;" />
                            </div>
                            
                            <!-- Opciones de Base de Datos -->
                            <div class="mb-4">
                                <label class="form-label fw-bold">
                                    <i class="bi bi-database me-2"></i>Opciones de Base de Datos
                                </label>
                                <div class="border rounded p-3 bg-light">
                                    <div class="form-check mb-2">
                                        <input type="checkbox" class="form-check-input" id="chkIncluirBackup"
                                               @bind="_incluirBackupBD" disabled="@_generando" />
                                        <label class="form-check-label" for="chkIncluirBackup">
                                            <i class="bi bi-archive me-1 text-primary"></i>
                                            Incluir backup de base de datos
                                        </label>
                                        <div class="form-text small">
                                            Copia la BD actual para restaurar en el destino
                                        </div>
                                    </div>
                                    <div class="form-check">
                                        <input type="checkbox" class="form-check-input" id="chkLimpiarDatos"
                                               @bind="_limpiarDatosAntes" disabled="@(_generando || !_incluirBackupBD)" />
                                        <label class="form-check-label" for="chkLimpiarDatos">
                                            <i class="bi bi-eraser me-1 text-warning"></i>
                                            Limpiar datos antes del backup
                                        </label>
                                        <div class="form-text small">
                                            Ejecuta LimpiarDatos.sql antes del backup
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Modo de instalaci√≥n -->
                            <div class="mb-4">
                                <label class="form-label fw-bold">
                                    <i class="bi bi-pc-display me-2"></i>Modo de Instalaci√≥n
                                </label>
                                <select class="form-select" @bind="_modoInstalacion" disabled="@_generando">
                                    <option value="Servidor">üñ•Ô∏è Servidor (BD local + aplicaci√≥n)</option>
                                    <option value="Cliente">üíª Cliente (conecta a servidor remoto)</option>
                                    <option value="Seleccionar">‚öôÔ∏è Permitir seleccionar al instalar</option>
                                </select>
                                <div class="form-text small">
                                    Define el modo por defecto del instalador generado
                                </div>
                            </div>
                        </div>
                        
                        <!-- Columna derecha - Configuraci√≥n del servidor destino -->
                        <div class="col-md-6">
                            <label class="form-label fw-bold">
                                <i class="bi bi-gear me-2"></i>Configuraci√≥n del Destino
                            </label>
                            <div class="border rounded p-3 bg-light">
                                @if (_modoInstalacion == "Cliente")
                                {
                                    <!-- Configuraci√≥n cliente -->
                                    <div class="mb-3">
                                        <label class="form-label small text-muted">Servidor Remoto (IP o Hostname)</label>
                                        <input type="text" class="form-control" @bind="_servidorRemoto" 
                                               placeholder="ej: 192.168.1.100" disabled="@_generando" />
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label small text-muted">Puerto Remoto</label>
                                        <input type="number" class="form-control" @bind="_puertoRemoto" 
                                               placeholder="5095" disabled="@_generando" />
                                    </div>
                                    <div class="form-check">
                                        <input type="checkbox" class="form-check-input" id="chkUsarHttpsCliente"
                                               @bind="_usarHttpsCliente" disabled="@_generando" />
                                        <label class="form-check-label" for="chkUsarHttpsCliente">
                                            <i class="bi bi-shield-lock me-1"></i>
                                            Usar HTTPS (puerto 7060)
                                        </label>
                                    </div>
                                }
                                else
                                {
                                    <!-- Configuraci√≥n servidor -->
                                    <div class="mb-3">
                                        <label class="form-label small text-muted">
                                            Servidor SQL (instancia)
                                        </label>
                                        <input type="text" class="form-control" @bind="_sqlServerDestino" 
                                               placeholder="ej: localhost\SQLEXPRESS" disabled="@_generando" />
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label small text-muted">
                                            Nombre de la Base de Datos
                                        </label>
                                        <input type="text" class="form-control" @bind="_nombreBDDestino" 
                                               placeholder="ej: SistemIA" disabled="@_generando" />
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label small text-muted">
                                            Contrase√±a SA (SQL Server)
                                        </label>
                                        <div class="input-group">
                                            <input type="@(_mostrarPassword ? "text" : "password")" 
                                                   class="form-control" @bind="_sqlPasswordDestino" 
                                                   placeholder="Contrase√±a del usuario sa" disabled="@_generando" />
                                            <button type="button" class="btn btn-outline-secondary"
                                                    @onclick="() => _mostrarPassword = !_mostrarPassword">
                                                <i class="bi @(_mostrarPassword ? "bi-eye-slash" : "bi-eye")"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <hr class="my-2" />
                                    <div class="mb-3">
                                        <label class="form-label small text-muted">
                                            <i class="bi bi-hdd me-1"></i>Nombre del Servicio Windows
                                        </label>
                                        <input type="text" class="form-control" @bind="_nombreServicio" 
                                               placeholder="ej: SistemIA" disabled="@_generando" />
                                        <div class="form-text small">
                                            Nombre √∫nico del servicio (sin espacios)
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label small text-muted">
                                            <i class="bi bi-folder me-1"></i>Carpeta de Instalaci√≥n
                                        </label>
                                        <input type="text" class="form-control" @bind="_rutaInstalacion" 
                                               placeholder="ej: C:\\SistemIA" disabled="@_generando" />
                                        <div class="form-text small">
                                            Ruta completa donde se instalar√° el sistema
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-6">
                                            <div class="mb-3">
                                                <label class="form-label small text-muted">
                                                    <i class="bi bi-globe me-1"></i>Puerto HTTP
                                                </label>
                                                <input type="number" class="form-control" @bind="_puertoHttp" 
                                                       placeholder="5095" disabled="@_generando" min="1024" max="65535" />
                                            </div>
                                        </div>
                                        <div class="col-6">
                                            <div class="mb-3">
                                                <label class="form-label small text-muted">
                                                    <i class="bi bi-shield-lock me-1 text-success"></i>Puerto HTTPS
                                                </label>
                                                <input type="number" class="form-control" @bind="_puertoHttps" 
                                                       placeholder="7060" disabled="@_generando" min="1024" max="65535" />
                                            </div>
                                        </div>
                                    </div>
                                    <div class="form-text small text-warning mb-2">
                                        <i class="bi bi-exclamation-triangle me-1"></i>
                                        Usa puertos diferentes para cada instalaci√≥n (ej: 5096/7061, 5097/7062...)
                                    </div>
                                    <hr class="my-2" />
                                    <div class="form-check mb-2">
                                        <input type="checkbox" class="form-check-input" id="chkCrearAcceso"
                                               @bind="_crearAccesoDirecto" disabled="@_generando" />
                                        <label class="form-check-label" for="chkCrearAcceso">
                                            <i class="bi bi-desktop me-1"></i>
                                            Crear acceso directo en escritorio
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        <input type="checkbox" class="form-check-input" id="chkUsarMkcert"
                                               @bind="_usarMkcert" disabled="@_generando" />
                                        <label class="form-check-label" for="chkUsarMkcert">
                                            <i class="bi bi-shield-lock me-1 text-success"></i>
                                            Instalar certificado HTTPS (mkcert)
                                        </label>
                                    </div>
                                }
                            </div>
                        </div>
                    </div>
                    
                    <hr class="my-4" />

                    <!-- Barra de progreso -->
                    @if (_generando)
                    {
                        <div class="mb-4">
                            <div class="d-flex justify-content-between mb-2">
                                <span class="text-muted small">@_estadoActual</span>
                                <span class="fw-bold">@_progreso%</span>
                            </div>
                            <div class="progress" style="height: 20px;">
                                <div class="progress-bar progress-bar-striped progress-bar-animated bg-success" 
                                     role="progressbar" 
                                     style="width: @_progreso%"
                                     aria-valuenow="@_progreso" 
                                     aria-valuemin="0" 
                                     aria-valuemax="100">
                                </div>
                            </div>
                        </div>
                    }

                    <!-- Botones -->
                    <div class="d-grid gap-2 mb-4">
                        @if (_generando)
                        {
                            <button class="btn btn-danger btn-lg py-3" @onclick="CancelarGeneracion">
                                <i class="bi bi-x-circle me-2"></i>
                                <span>Cancelar</span>
                            </button>
                        }
                        else
                        {
                            <button class="btn btn-success btn-lg py-3" @onclick="GenerarPaqueteInstalador">
                                <i class="bi bi-download me-2"></i>
                                <span>Generar Instalador</span>
                            </button>
                        }
                    </div>

                    <!-- Info -->
                    <div class="alert alert-success border-0 small mb-0">
                        <i class="bi bi-check-circle me-2"></i>
                        <strong>Listo:</strong> El instalador generado incluir√° la configuraci√≥n preestablecida arriba.
                        @if (_modoInstalacion == "Seleccionar")
                        {
                            <span>El usuario podr√° elegir el modo de instalaci√≥n.</span>
                        }
                        else
                        {
                            <span>Modo: <strong>@_modoInstalacion</strong></span>
                        }
                    </div>
                </div>
            </div>

            <!-- Log de operaciones (siempre visible) -->
            <div class="card shadow-sm mt-4">
                <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center" 
                     @onclick="() => _logExpandido = !_logExpandido" 
                     style="cursor: pointer;">
                    <span>
                        <i class="bi bi-terminal me-2"></i>
                        Log de Operaciones (@_logs.Count l√≠neas)
                    </span>
                    <i class="bi bi-chevron-@(_logExpandido ? "up" : "down")"></i>
                </div>
                @if (_logExpandido)
                {
                    <div class="card-body p-0">
                        <div @ref="_logContainer" class="bg-dark text-light p-3" 
                             style="height: 350px; overflow-y: auto; font-family: 'Consolas', monospace; font-size: 0.9rem; line-height: 1.5;">
                            @if (_logs.Count == 0)
                            {
                                <div class="text-muted">Esperando operaciones...</div>
                            }
                            else
                            {
                                @foreach (var log in _logs)
                                {
                                    <div class="@GetLogClass(log.Tipo) py-1 border-bottom border-secondary">
                                        <span class="text-secondary">[@log.Fecha.ToString("HH:mm:ss")]</span> @log.Mensaje
                                    </div>
                                }
                            }
                        </div>
                    </div>
                }
            </div>
        </div>
    </div>
</div>

@* Modal de √©xito *@
@if (_mostrarModalExito)
{
    <div class="modal-backdrop fade show" style="z-index: 1040;"></div>
    <div class="modal fade show d-block" tabindex="-1" style="z-index: 1050;">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow-lg">
                <div class="modal-body text-center p-5">
                    <div class="mb-4">
                        <i class="bi bi-check-circle-fill text-success" style="font-size: 5rem;"></i>
                    </div>
                    <h4 class="fw-bold mb-3">¬°Instalador Generado!</h4>
                    <p class="text-muted mb-4">
                        El paquete de instalaci√≥n se ha generado correctamente y la descarga deber√≠a comenzar autom√°ticamente.
                    </p>
                    @if (!string.IsNullOrEmpty(_infoArchivo))
                    {
                        <div class="alert alert-light border mb-4">
                            <i class="bi bi-file-earmark-zip me-2"></i>@_infoArchivo
                        </div>
                    }
                    <div class="d-flex gap-2 justify-content-center">
                        @if (!string.IsNullOrEmpty(_downloadToken))
                        {
                            <a href="/api/download/stream/@_downloadToken" download="@_downloadFileName" 
                               class="btn btn-primary btn-lg px-4">
                                <i class="bi bi-download me-2"></i>Descargar
                            </a>
                        }
                        <button class="btn btn-success btn-lg px-4" @onclick="CerrarModalExito">
                            <i class="bi bi-check-lg me-2"></i>Aceptar
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
}

@* Toast para errores *@
@if (!string.IsNullOrEmpty(_mensaje) && _esError)
{
    <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 1050;">
        <div class="toast show bg-danger text-white">
            <div class="toast-body">
                <i class="bi bi-x-circle me-2"></i>
                @_mensaje
                <button type="button" class="btn-close btn-close-white float-end" @onclick="() => _mensaje = null"></button>
            </div>
        </div>
    </div>
}
</SaProtection>

@code {
    private string _version = "1.0.0";
    private bool _generando = false;
    private string? _mensaje;
    private bool _esError;
    private List<LogEntry> _logs = new();
    private bool _logExpandido = true;
    
    // Progreso
    private int _progreso = 0;
    private string _estadoActual = "";
    
    // Modal de √©xito
    private bool _mostrarModalExito = false;
    private string? _infoArchivo;
    private string? _downloadToken;
    private string? _downloadFileName;
    
    // Cancelaci√≥n
    private CancellationTokenSource? _cts;
    private System.Diagnostics.Process? _procesoActual;
    
    // Referencia al contenedor de logs
    private ElementReference _logContainer;
    
    // Lock para sincronizar logs
    private readonly object _logLock = new();
    
    // ========== NUEVAS OPCIONES DE CONFIGURACI√ìN ==========
    // Opciones de Base de Datos
    private bool _incluirBackupBD = true;
    private bool _limpiarDatosAntes = false;
    
    // Modo de instalaci√≥n
    private string _modoInstalacion = "Servidor"; // Servidor, Cliente, Seleccionar
    
    // Configuraci√≥n Servidor destino
    private string _sqlServerDestino = "localhost\\SQLEXPRESS";
    private string _nombreBDDestino = "SistemIA";
    private string _sqlPasswordDestino = "";
    private bool _mostrarPassword = false;
    private bool _crearAccesoDirecto = true;
    private bool _usarMkcert = true;
    
    // Configuraci√≥n de instalaci√≥n
    private string _nombreServicio = "SistemIA";
    private string _rutaInstalacion = "C:\\SistemIA";
    private int _puertoHttp = 5095;
    private int _puertoHttps = 7060;
    
    // Configuraci√≥n Cliente destino
    private string _servidorRemoto = "";
    private int _puertoRemoto = 5095;
    private bool _usarHttpsCliente = false;
    
    protected override void OnInitialized()
    {
        // Obtener versi√≥n actual del sistema si existe
        var versionFile = Path.Combine(Env.ContentRootPath, "version.txt");
        if (File.Exists(versionFile))
        {
            _version = File.ReadAllText(versionFile).Trim();
        }
        
        // Cargar config.json actual para precargar valores
        CargarConfiguracionActual();
    }
    
    private void CargarConfiguracionActual()
    {
        try
        {
            var configPath = Path.Combine(Env.ContentRootPath, "Installer", "config.json");
            if (File.Exists(configPath))
            {
                var json = File.ReadAllText(configPath);
                using var doc = JsonDocument.Parse(json);
                var root = doc.RootElement;
                
                // Cargar valores actuales
                if (root.TryGetProperty("ModoInstalacion", out var modo))
                    _modoInstalacion = modo.GetString() ?? "Servidor";
                if (root.TryGetProperty("CrearAccesoDirecto", out var acceso))
                    _crearAccesoDirecto = acceso.GetBoolean();
                if (root.TryGetProperty("UsarMkcert", out var mkcert))
                    _usarMkcert = mkcert.GetBoolean();
                if (root.TryGetProperty("BaseDatos", out var bd))
                {
                    if (bd.TryGetProperty("Servidor", out var srv))
                        _sqlServerDestino = srv.GetString() ?? "localhost\\SQLEXPRESS";
                    if (bd.TryGetProperty("NombreBD", out var nombreBd))
                        _nombreBDDestino = nombreBd.GetString() ?? "SistemIA";
                }
                if (root.TryGetProperty("Cliente", out var cliente))
                {
                    if (cliente.TryGetProperty("ServidorRemoto", out var srvRem))
                        _servidorRemoto = srvRem.GetString() ?? "";
                    if (cliente.TryGetProperty("PuertoRemoto", out var puerto))
                        _puertoRemoto = puerto.GetInt32();
                    if (cliente.TryGetProperty("UsarHttps", out var https))
                        _usarHttpsCliente = https.GetBoolean();
                }
                
                // Cargar configuraci√≥n de instalaci√≥n
                if (root.TryGetProperty("Instalacion", out var instalacion))
                {
                    if (instalacion.TryGetProperty("NombreServicio", out var nombreSrv))
                        _nombreServicio = nombreSrv.GetString() ?? "SistemIA";
                    if (instalacion.TryGetProperty("RutaInstalacion", out var ruta))
                        _rutaInstalacion = ruta.GetString() ?? "C:\\SistemIA";
                    if (instalacion.TryGetProperty("PuertoHttp", out var pHttp))
                        _puertoHttp = pHttp.GetInt32();
                    if (instalacion.TryGetProperty("PuertoHttps", out var pHttps))
                        _puertoHttps = pHttps.GetInt32();
                }
            }
        }
        catch { /* Ignorar errores de carga */ }
    }
    
    private void CerrarModalExito()
    {
        _mostrarModalExito = false;
        _infoArchivo = null;
        _downloadToken = null;
        _downloadFileName = null;
        StateHasChanged();
    }
    
    private async Task ActualizarProgreso(int porcentaje, string estado)
    {
        _progreso = porcentaje;
        _estadoActual = estado;
        await InvokeAsync(StateHasChanged);
        await Task.Delay(10);
    }
    
    private async Task GenerarPaqueteInstalador()
    {
        _generando = true;
        _mostrarModalExito = false;
        _logs.Clear();
        _progreso = 0;
        _cts = new CancellationTokenSource();
        var ct = _cts.Token;
        await InvokeAsync(StateHasChanged);
        
        try
        {
            await ActualizarProgreso(5, "Iniciando generaci√≥n...");
            AgregarLog("Iniciando generaci√≥n del paquete de instalaci√≥n...", "info");
            AgregarLog($"üìã Modo: {_modoInstalacion} | Incluir BD: {_incluirBackupBD} | Limpiar: {_limpiarDatosAntes}", "info");
            
            ct.ThrowIfCancellationRequested();
            
            var installerPath = Path.Combine(Env.ContentRootPath, "Installer");
            var backupFile = Path.Combine(installerPath, "SistemIA_Base.bak");
            
            // Paso 1: Backup de BD (15%)
            if (_incluirBackupBD)
            {
                await ActualizarProgreso(10, "Generando backup de base de datos...");
                
                if (_limpiarDatosAntes)
                {
                    // === FLUJO SEGURO: Restaurar a BD temporal, limpiar, y generar backup ===
                    AgregarLog("üîí Generando backup limpio de forma SEGURA (sin modificar BD actual)...", "info");
                    var backupResult = await GenerarBackupLimpio(backupFile);
                    if (!backupResult.exito)
                    {
                        AgregarLog($"‚ö†Ô∏è No se pudo generar backup limpio: {backupResult.error}", "warning");
                    }
                    else
                    {
                        AgregarLog($"‚úÖ Backup limpio generado (BD original intacta)", "success");
                    }
                }
                else
                {
                    // === FLUJO NORMAL: Backup directo sin limpiar ===
                    AgregarLog("Generando backup de la base de datos...", "info");
                    var backupResult = await GenerarBackupBD(backupFile);
                    if (!backupResult.exito)
                    {
                        AgregarLog($"‚ö†Ô∏è No se pudo generar backup: {backupResult.error}", "warning");
                    }
                    else
                    {
                        AgregarLog($"‚úÖ Backup de BD [{backupResult.dbName}] generado", "success");
                    }
                }
            }
            else
            {
                AgregarLog("‚ÑπÔ∏è Backup de BD omitido seg√∫n configuraci√≥n", "info");
                // Eliminar backup anterior si existe
                if (File.Exists(backupFile))
                    File.Delete(backupFile);
            }
            
            // Paso 1.5: Generar config.json personalizado
            await ActualizarProgreso(15, "Generando configuraci√≥n personalizada...");
            AgregarLog("üìù Generando config.json con par√°metros personalizados...", "info");
            await GenerarConfigJsonPersonalizado(installerPath);
            AgregarLog("‚úÖ Configuraci√≥n generada", "success");
            
            // Paso 2: Compilar instalador gr√°fico (30%)
            await ActualizarProgreso(20, "Compilando instalador gr√°fico...");
            AgregarLog("Compilando instalador gr√°fico...", "info");
            var installerAppResult = await CompilarInstaladorGrafico();
            
            await ActualizarProgreso(30, "Preparando archivos...");
            
            using var memoryStream = new MemoryStream();
            using (var archive = new ZipArchive(memoryStream, ZipArchiveMode.Create, true))
            {
                // Paso 3: Agregar instalador (40%)
                if (installerAppResult.exito && File.Exists(installerAppResult.exePath))
                {
                    await ActualizarProgreso(35, "Agregando instalador ejecutable...");
                    AgregarLog("‚úÖ Agregando SistemIA-Instalador.exe", "success");
                    var installerEntry = archive.CreateEntry("SistemIA-Instalador.exe");
                    using var entryStream = installerEntry.Open();
                    using var fileStream = File.OpenRead(installerAppResult.exePath!);
                    await fileStream.CopyToAsync(entryStream);
                }
                else
                {
                    AgregarLog($"‚ö†Ô∏è Instalador gr√°fico no disponible: {installerAppResult.error}", "warning");
                    // Agregar batch como respaldo
                    AgregarLog("Agregando Instalar.bat como respaldo...", "info");
                    var batEntry = archive.CreateEntry("Instalar.bat");
                    using var writer = new StreamWriter(batEntry.Open(), Encoding.UTF8);
                    await writer.WriteAsync(GenerarInstallBat());
                }
                
                // Paso 4: Agregar scripts de instalaci√≥n (50%)
                await ActualizarProgreso(45, "Agregando scripts de instalaci√≥n...");
                if (Directory.Exists(installerPath))
                {
                    // Scripts y archivos de texto (se copian como UTF-8)
                    var scriptFiles = new[] { 
                        "Install-SistemIA.ps1", 
                        "Actualizar-SistemIA.ps1",
                        "CrearBaseDatos.sql", 
                        "InicializarDatos.sql", 
                        "LimpiarDatos.sql",
                        "Instalar.bat",
                        "Diagnostico-SistemIA.bat",
                        "config.json",
                        "README.md" 
                    };
                    foreach (var file in scriptFiles)
                    {
                        var filePath = Path.Combine(installerPath, file);
                        if (File.Exists(filePath))
                        {
                            AgregarLog($"Agregando {file}...", "info");
                            var content = await File.ReadAllTextAsync(filePath);
                            var entry = archive.CreateEntry(file);
                            using var writer = new StreamWriter(entry.Open(), Encoding.UTF8);
                            await writer.WriteAsync(content);
                        }
                    }
                    
                    // Carpeta Certificados (vac√≠a pero necesaria para mkcert)
                    var certsDir = Path.Combine(installerPath, "Certificados");
                    if (Directory.Exists(certsDir))
                    {
                        foreach (var certFile in Directory.GetFiles(certsDir))
                        {
                            var certFileName = Path.GetFileName(certFile);
                            AgregarLog($"Agregando Certificados/{certFileName}...", "info");
                            var entry = archive.CreateEntry($"Certificados/{certFileName}");
                            using var entryStream = entry.Open();
                            using var fileStream = File.OpenRead(certFile);
                            await fileStream.CopyToAsync(entryStream);
                        }
                    }
                }
                
                await ActualizarProgreso(50, "Agregando backup de base de datos...");
                
                // Paso 5: Backup de BD (55%)
                if (File.Exists(backupFile))
                {
                    AgregarLog("Agregando SistemIA_Base.bak...", "info");
                    var backupEntry = archive.CreateEntry("SistemIA_Base.bak", CompressionLevel.NoCompression);
                    using var entryStream = backupEntry.Open();
                    using var fileStream = File.OpenRead(backupFile);
                    await fileStream.CopyToAsync(entryStream);
                }
                
                // Paso 6: Publicar aplicaci√≥n (60-90%)
                await ActualizarProgreso(60, "Publicando aplicaci√≥n (esto puede tardar)...");
                AgregarLog("Publicando aplicaci√≥n...", "info");
                
                ct.ThrowIfCancellationRequested();
                
                var publishResult = await PublicarAplicacion(ct);
                if (publishResult.exito)
                {
                    await ActualizarProgreso(75, "Agregando binarios al paquete...");
                    AgregarLog("‚úÖ Aplicaci√≥n publicada, agregando binarios...", "success");
                    await AgregarCarpetaPublish(archive, publishResult.publishPath!);
                    AgregarLog("‚úÖ Binarios agregados correctamente", "success");
                }
                else
                {
                    AgregarLog($"‚ö†Ô∏è No se pudo publicar: {publishResult.error}", "warning");
                }
                
                await ActualizarProgreso(95, "Finalizando paquete...");
            }
            
            // Guardar archivo ZIP temporalmente
            await ActualizarProgreso(97, "Guardando paquete...");
            var fileName = $"SistemIA_Installer_v{_version}.zip";
            var tempPath = Path.Combine(Path.GetTempPath(), fileName);
            
            using (var fileStream = new FileStream(tempPath, FileMode.Create, FileAccess.Write))
            {
                memoryStream.Position = 0;
                await memoryStream.CopyToAsync(fileStream);
            }
            
            // Registrar descarga y obtener token
            await ActualizarProgreso(98, "Preparando descarga...");
            var token = DownloadController.RegisterDownload(tempPath);
            
            // Guardar token para bot√≥n de descarga manual
            _downloadToken = token;
            _downloadFileName = fileName;
            
            // Obtener tama√±o del archivo para informar
            var fileInfo = new FileInfo(tempPath);
            var sizeMB = fileInfo.Length / (1024.0 * 1024.0);
            AgregarLog($"‚úÖ Paquete generado: {fileName} ({sizeMB:F1} MB)", "success");
            
            await ActualizarProgreso(100, "¬°Completado!");
            AgregarLog($"‚úÖ Iniciando descarga...", "success");
            
            // Iniciar descarga usando JavaScript - m√©todo m√°s confiable
            var downloadUrl = $"/api/download/stream/{token}";
            await JS.InvokeVoidAsync("eval", $"(function() {{ var a = document.createElement('a'); a.href = '{downloadUrl}'; a.download = '{fileName}'; document.body.appendChild(a); a.click(); document.body.removeChild(a); }})()");
            
            // Mostrar modal de √©xito
            _infoArchivo = $"{fileName} ({sizeMB:F1} MB)";
            _mostrarModalExito = true;
            _progreso = 0;
            _estadoActual = "";
        }
        catch (OperationCanceledException)
        {
            AgregarLog("‚ö†Ô∏è Operaci√≥n cancelada", "warning");
            MostrarMensaje("Generaci√≥n cancelada", true);
            _progreso = 0;
            _estadoActual = "";
        }
        catch (Exception ex)
        {
            AgregarLog($"‚ùå Error: {ex.Message}", "error");
            MostrarMensaje("Error al generar instalador: " + ex.Message, true);
            // Resetear progreso en caso de error
            _progreso = 0;
            _estadoActual = "";
        }
        finally
        {
            _generando = false;
            _cts?.Dispose();
            _cts = null;
            StateHasChanged();
        }
    }
    
    private async Task<(bool exito, string? exePath, string? error)> CompilarInstaladorGrafico()
    {
        try
        {
            // InstallerApp est√° en c:\asis\InstallerApp (fuera del proyecto SistemIA)
            var installerAppPath = Path.Combine(Path.GetDirectoryName(Env.ContentRootPath)!, "InstallerApp");
            var publishPath = Path.Combine(installerAppPath, "publish");
            var exePath = Path.Combine(publishPath, "SistemIA-Instalador.exe");
            
            if (!Directory.Exists(installerAppPath))
            {
                return (false, null, "Directorio InstallerApp no encontrado");
            }
            
            // Limpiar publish anterior
            if (Directory.Exists(publishPath))
            {
                Directory.Delete(publishPath, true);
            }
            
            // Compilar el instalador
            var psi = new System.Diagnostics.ProcessStartInfo
            {
                FileName = "dotnet",
                Arguments = "publish -c Release -o publish",
                WorkingDirectory = installerAppPath,
                RedirectStandardOutput = true,
                RedirectStandardError = true,
                UseShellExecute = false,
                CreateNoWindow = true
            };
            
            using var process = System.Diagnostics.Process.Start(psi);
            if (process == null)
            {
                return (false, null, "No se pudo iniciar dotnet publish");
            }
            
            var output = await process.StandardOutput.ReadToEndAsync();
            var error = await process.StandardError.ReadToEndAsync();
            await process.WaitForExitAsync();
            
            if (process.ExitCode != 0)
            {
                return (false, null, $"dotnet publish fall√≥: {error}");
            }
            
            if (File.Exists(exePath))
            {
                AgregarLog("‚úÖ Instalador gr√°fico compilado correctamente", "success");
                return (true, exePath, null);
            }
            
            return (false, null, "Ejecutable no generado");
        }
        catch (Exception ex)
        {
            return (false, null, ex.Message);
        }
    }
    
    private string GenerarInstallBat()
    {
        var sb = new StringBuilder();
        sb.AppendLine("@echo off");
        sb.AppendLine("chcp 65001 > nul");
        sb.AppendLine("title SistemIA - Instalador");
        sb.AppendLine();
        sb.AppendLine("echo.");
        sb.AppendLine("echo ================================================================");
        sb.AppendLine("echo              SISTEM√çA INSTALLER v" + _version);
        sb.AppendLine("echo         Sistema de Gestion Empresarial");
        sb.AppendLine("echo ================================================================");
        sb.AppendLine("echo.");
        sb.AppendLine();
        sb.AppendLine(":: Verificar permisos de administrador");
        sb.AppendLine("net session >nul 2>&1");
        sb.AppendLine("if %errorLevel% neq 0 (");
        sb.AppendLine("    echo [ERROR] Este instalador requiere permisos de administrador.");
        sb.AppendLine("    echo.");
        sb.AppendLine("    echo Por favor, haga clic derecho en este archivo y seleccione");
        sb.AppendLine("    echo \"Ejecutar como administrador\"");
        sb.AppendLine("    echo.");
        sb.AppendLine("    pause");
        sb.AppendLine("    exit /b 1");
        sb.AppendLine(")");
        sb.AppendLine();
        sb.AppendLine(":: Verificar PowerShell");
        sb.AppendLine("where powershell >nul 2>&1");
        sb.AppendLine("if %errorLevel% neq 0 (");
        sb.AppendLine("    echo [ERROR] PowerShell no esta instalado o no esta en el PATH.");
        sb.AppendLine("    pause");
        sb.AppendLine("    exit /b 1");
        sb.AppendLine(")");
        sb.AppendLine();
        sb.AppendLine(":: Ejecutar script de instalaci√≥n");
        sb.AppendLine("echo Iniciando instalador de SistemIA...");
        sb.AppendLine("echo.");
        sb.AppendLine();
        sb.AppendLine("powershell -ExecutionPolicy Bypass -File \"%~dp0Install-SistemIA.ps1\"");
        sb.AppendLine();
        sb.AppendLine("echo.");
        sb.AppendLine("pause");
        return sb.ToString();
    }
    
    private void AgregarLog(string mensaje, string tipo)
    {
        lock (_logLock)
        {
            _logs.Add(new LogEntry { Fecha = DateTime.Now, Mensaje = mensaje, Tipo = tipo });
        }
    }
    
    private async Task AgregarLogAsync(string mensaje, string tipo)
    {
        lock (_logLock)
        {
            _logs.Add(new LogEntry { Fecha = DateTime.Now, Mensaje = mensaje, Tipo = tipo });
        }
        await InvokeAsync(StateHasChanged);
    }
    
    private string GetLogClass(string tipo) => tipo switch
    {
        "error" => "text-danger",
        "success" => "text-success",
        "warning" => "text-warning",
        _ => "text-info"
    };
    
    private void MostrarMensaje(string mensaje, bool esError)
    {
        _mensaje = mensaje;
        _esError = esError;
    }
    
    private class LogEntry
    {
        public DateTime Fecha { get; set; }
        public string Mensaje { get; set; } = "";
        public string Tipo { get; set; } = "info";
    }
    
    private async Task<(bool exito, string? error, string? dbName)> GenerarBackupBD(string backupPath)
    {
        try
        {
            var connectionString = Configuration.GetConnectionString("DefaultConnection");
            if (string.IsNullOrEmpty(connectionString))
            {
                return (false, "No se encontr√≥ la cadena de conexi√≥n", null);
            }
            
            // Extraer nombre de BD de la cadena de conexi√≥n actual
            var builder = new SqlConnectionStringBuilder(connectionString);
            var dbName = builder.InitialCatalog;
            
            if (string.IsNullOrEmpty(dbName))
            {
                return (false, "No se pudo determinar el nombre de la BD", null);
            }
            
            // Asegurar que el directorio existe
            var dir = Path.GetDirectoryName(backupPath);
            if (!string.IsNullOrEmpty(dir) && !Directory.Exists(dir))
            {
                Directory.CreateDirectory(dir);
            }
            
            // Ejecutar backup de la BD actual del sistema
            using var connection = new SqlConnection(connectionString);
            await connection.OpenAsync();
            
            var backupQuery = $@"
                BACKUP DATABASE [{dbName}] 
                TO DISK = '{backupPath}' 
                WITH FORMAT, INIT, COMPRESSION, 
                NAME = 'SistemIA Base Backup - {DateTime.Now:yyyy-MM-dd HH:mm}'";
            
            using var cmd = new SqlCommand(backupQuery, connection);
            cmd.CommandTimeout = 300; // 5 minutos
            await cmd.ExecuteNonQueryAsync();
            
            return (true, null, dbName);
        }
        catch (Exception ex)
        {
            return (false, ex.Message, null);
        }
    }
    
    /// <summary>
    /// Genera un backup LIMPIO de forma SEGURA:
    /// 1. Hace backup de la BD actual
    /// 2. Restaura a una BD temporal (SistemIA_Temp_Limpieza)
    /// 3. Ejecuta limpieza en la BD temporal
    /// 4. Genera backup de la BD temporal limpia
    /// 5. Elimina la BD temporal
    /// As√≠ la BD original NUNCA se modifica.
    /// </summary>
    private async Task<(bool exito, string? error)> GenerarBackupLimpio(string backupPath)
    {
        const string tempDbName = "SistemIA_Temp_Limpieza";
        string? backupTempPath = null;
        
        try
        {
            var connectionString = Configuration.GetConnectionString("DefaultConnection");
            if (string.IsNullOrEmpty(connectionString))
                return (false, "No se encontr√≥ la cadena de conexi√≥n");
            
            var builder = new SqlConnectionStringBuilder(connectionString);
            var dbName = builder.InitialCatalog;
            
            if (string.IsNullOrEmpty(dbName))
                return (false, "No se pudo determinar el nombre de la BD");
            
            // Conectar al master para operaciones de BD
            builder.InitialCatalog = "master";
            var masterConnString = builder.ConnectionString;
            
            using var masterConn = new SqlConnection(masterConnString);
            await masterConn.OpenAsync();
            
            // Obtener ruta de datos de SQL Server
            using var cmdPath = new SqlCommand("SELECT SERVERPROPERTY('InstanceDefaultDataPath') AS DataPath", masterConn);
            var dataPath = (string?)await cmdPath.ExecuteScalarAsync() ?? @"C:\Program Files\Microsoft SQL Server\MSSQL16.SQL2022\MSSQL\DATA\";
            
            // Obtener ruta de backup de SQL Server
            using var cmdBackup = new SqlCommand("SELECT SERVERPROPERTY('InstanceDefaultBackupPath') AS BackupPath", masterConn);
            var backupPathSql = (string?)await cmdBackup.ExecuteScalarAsync() ?? @"C:\Program Files\Microsoft SQL Server\MSSQL16.SQL2022\MSSQL\Backup\";
            
            backupTempPath = Path.Combine(backupPathSql, $"{dbName}_Temp_{DateTime.Now:yyyyMMdd_HHmmss}.bak");
            
            AgregarLog("üì¶ Paso 1/5: Generando backup temporal de BD actual...", "info");
            
            // 1. Backup de la BD actual a archivo temporal
            using var cmdBackupOrig = new SqlCommand($@"
                BACKUP DATABASE [{dbName}] 
                TO DISK = '{backupTempPath}' 
                WITH FORMAT, INIT, COMPRESSION", masterConn);
            cmdBackupOrig.CommandTimeout = 300;
            await cmdBackupOrig.ExecuteNonQueryAsync();
            
            AgregarLog("üîÑ Paso 2/5: Restaurando a BD temporal...", "info");
            
            // 2. Eliminar BD temporal si existe
            using var cmdDropTemp = new SqlCommand($@"
                IF EXISTS (SELECT name FROM sys.databases WHERE name = '{tempDbName}')
                BEGIN
                    ALTER DATABASE [{tempDbName}] SET SINGLE_USER WITH ROLLBACK IMMEDIATE;
                    DROP DATABASE [{tempDbName}];
                END", masterConn);
            cmdDropTemp.CommandTimeout = 60;
            await cmdDropTemp.ExecuteNonQueryAsync();
            
            // 3. Restaurar backup a BD temporal con nuevos nombres de archivo
            var mdfPath = Path.Combine(dataPath, $"{tempDbName}.mdf");
            var ldfPath = Path.Combine(dataPath, $"{tempDbName}_log.ldf");
            
            // Obtener nombres l√≥gicos del backup
            using var cmdFileList = new SqlCommand($"RESTORE FILELISTONLY FROM DISK = '{backupTempPath}'", masterConn);
            cmdFileList.CommandTimeout = 60;
            string? logicalDataName = null;
            string? logicalLogName = null;
            
            using (var reader = await cmdFileList.ExecuteReaderAsync())
            {
                while (await reader.ReadAsync())
                {
                    var type = reader["Type"].ToString();
                    var logicalName = reader["LogicalName"].ToString();
                    if (type == "D") logicalDataName = logicalName;
                    else if (type == "L") logicalLogName = logicalName;
                }
            }
            
            if (string.IsNullOrEmpty(logicalDataName) || string.IsNullOrEmpty(logicalLogName))
                return (false, "No se pudieron obtener los nombres l√≥gicos del backup");
            
            using var cmdRestore = new SqlCommand($@"
                RESTORE DATABASE [{tempDbName}] 
                FROM DISK = '{backupTempPath}'
                WITH MOVE '{logicalDataName}' TO '{mdfPath}',
                     MOVE '{logicalLogName}' TO '{ldfPath}',
                     REPLACE", masterConn);
            cmdRestore.CommandTimeout = 300;
            await cmdRestore.ExecuteNonQueryAsync();
            
            AgregarLog("üßπ Paso 3/5: Limpiando datos de la BD temporal...", "info");
            
            // 4. Ejecutar limpieza en la BD temporal
            builder.InitialCatalog = tempDbName;
            var tempConnString = builder.ConnectionString;
            
            var limpiarScript = Path.Combine(Env.ContentRootPath, "Installer", "LimpiarDatos.sql");
            if (!File.Exists(limpiarScript))
                return (false, "No se encontr√≥ LimpiarDatos.sql");
            
            var script = await File.ReadAllTextAsync(limpiarScript);
            
            using var tempConn = new SqlConnection(tempConnString);
            await tempConn.OpenAsync();
            
            var batches = script.Split(new[] { "\nGO\n", "\nGO\r\n", "\r\nGO\r\n", "\r\nGO\n" }, 
                                        StringSplitOptions.RemoveEmptyEntries);
            
            foreach (var batch in batches)
            {
                if (string.IsNullOrWhiteSpace(batch)) continue;
                using var cmd = new SqlCommand(batch, tempConn);
                cmd.CommandTimeout = 120;
                try { await cmd.ExecuteNonQueryAsync(); } catch { /* Ignorar errores individuales */ }
            }
            
            tempConn.Close();
            
            AgregarLog("üíæ Paso 4/5: Generando backup limpio final...", "info");
            
            // 5. Generar backup de la BD temporal limpia
            var dir = Path.GetDirectoryName(backupPath);
            if (!string.IsNullOrEmpty(dir) && !Directory.Exists(dir))
                Directory.CreateDirectory(dir);
            
            using var cmdFinalBackup = new SqlCommand($@"
                BACKUP DATABASE [{tempDbName}] 
                TO DISK = '{backupPath}' 
                WITH FORMAT, INIT, COMPRESSION, 
                NAME = 'SistemIA Base Limpia - {DateTime.Now:yyyy-MM-dd HH:mm}'", masterConn);
            cmdFinalBackup.CommandTimeout = 300;
            await cmdFinalBackup.ExecuteNonQueryAsync();
            
            AgregarLog("üóëÔ∏è Paso 5/5: Eliminando BD temporal...", "info");
            
            // 6. Eliminar BD temporal
            using var cmdDropFinal = new SqlCommand($@"
                ALTER DATABASE [{tempDbName}] SET SINGLE_USER WITH ROLLBACK IMMEDIATE;
                DROP DATABASE [{tempDbName}];", masterConn);
            cmdDropFinal.CommandTimeout = 60;
            await cmdDropFinal.ExecuteNonQueryAsync();
            
            // 7. Eliminar backup temporal
            if (!string.IsNullOrEmpty(backupTempPath) && File.Exists(backupTempPath))
            {
                try { File.Delete(backupTempPath); } catch { }
            }
            
            return (true, null);
        }
        catch (Exception ex)
        {
            // Intentar limpiar en caso de error
            try
            {
                var connectionString = Configuration.GetConnectionString("DefaultConnection");
                if (!string.IsNullOrEmpty(connectionString))
                {
                    var builder = new SqlConnectionStringBuilder(connectionString);
                    builder.InitialCatalog = "master";
                    using var masterConn = new SqlConnection(builder.ConnectionString);
                    await masterConn.OpenAsync();
                    
                    using var cmdDrop = new SqlCommand($@"
                        IF EXISTS (SELECT name FROM sys.databases WHERE name = '{tempDbName}')
                        BEGIN
                            ALTER DATABASE [{tempDbName}] SET SINGLE_USER WITH ROLLBACK IMMEDIATE;
                            DROP DATABASE [{tempDbName}];
                        END", masterConn);
                    await cmdDrop.ExecuteNonQueryAsync();
                }
            }
            catch { }
            
            // Eliminar backup temporal
            if (!string.IsNullOrEmpty(backupTempPath) && File.Exists(backupTempPath))
            {
                try { File.Delete(backupTempPath); } catch { }
            }
            
            return (false, ex.Message);
        }
    }
    
    /// <summary>
    /// Ejecuta el script LimpiarDatos.sql antes de generar el backup
    /// </summary>
    private async Task<(bool exito, string? error)> EjecutarLimpiezaDatos()
    {
        try
        {
            var connectionString = Configuration.GetConnectionString("DefaultConnection");
            if (string.IsNullOrEmpty(connectionString))
                return (false, "No se encontr√≥ la cadena de conexi√≥n");
            
            var limpiarScript = Path.Combine(Env.ContentRootPath, "Installer", "LimpiarDatos.sql");
            if (!File.Exists(limpiarScript))
                return (false, "No se encontr√≥ LimpiarDatos.sql");
            
            var script = await File.ReadAllTextAsync(limpiarScript);
            
            using var connection = new SqlConnection(connectionString);
            await connection.OpenAsync();
            
            // Dividir script por GO (separador de batch de SQL Server)
            var batches = script.Split(new[] { "\nGO\n", "\nGO\r\n", "\r\nGO\r\n", "\r\nGO\n" }, 
                                        StringSplitOptions.RemoveEmptyEntries);
            
            foreach (var batch in batches)
            {
                if (string.IsNullOrWhiteSpace(batch)) continue;
                using var cmd = new SqlCommand(batch, connection);
                cmd.CommandTimeout = 120;
                await cmd.ExecuteNonQueryAsync();
            }
            
            return (true, null);
        }
        catch (Exception ex)
        {
            return (false, ex.Message);
        }
    }
    
    /// <summary>
    /// Genera el config.json personalizado con los par√°metros de la UI
    /// </summary>
    private async Task GenerarConfigJsonPersonalizado(string installerPath)
    {
        var config = new
        {
            Version = _version,
            FechaGeneracion = DateTime.Now.ToString("yyyy-MM-dd HH:mm:ss"),
            
            // ========== SECCI√ìN INSTALACI√ìN ==========
            Instalacion = new
            {
                ModoInstalacion = _modoInstalacion,
                CrearAccesoDirecto = _crearAccesoDirecto,
                UsarMkcert = _usarMkcert,
                RutaInstalacion = _rutaInstalacion,
                NombreServicio = _nombreServicio,
                DescripcionServicio = $"{_nombreServicio} - Sistema de Gesti√≥n Empresarial",
                InicioAutomatico = true,
                Autostart = true,
                PuertoHttp = _puertoHttp,
                PuertoHttps = _puertoHttps
            },
            
            BaseDatos = new
            {
                Servidor = _sqlServerDestino,
                NombreBD = _nombreBDDestino,
                BaseDatos = _nombreBDDestino,  // Duplicado para compatibilidad con script
                Usuario = "sa",
                Contrasena = _sqlPasswordDestino,
                Password = _sqlPasswordDestino,  // Duplicado para compatibilidad con script
                RestaurarBackup = _incluirBackupBD,
                AutenticacionWindows = false,
                TrustServerCertificate = true
            },
            
            Cliente = new
            {
                ServidorRemoto = _servidorRemoto,
                PuertoRemoto = _puertoRemoto,
                UsarHttps = _usarHttpsCliente
            },
            
            Puertos = new
            {
                HTTP = _puertoHttp,
                HTTPS = _puertoHttps
            },
            
            Certificado = new
            {
                TipoCertificado = _usarMkcert ? "mkcert" : "self-signed",
                Dominios = new[] { "localhost", "sistemialocal" },
                ValidezAnios = 10
            },
            
            // ========== DATOS DE EMPRESA (se configuran despu√©s) ==========
            Sociedad = new
            {
                Nombre = "Mi Empresa",
                RUC = "80000000-0",
                Direccion = ""
            }
        };
        
        var options = new JsonSerializerOptions 
        { 
            WriteIndented = true,
            Encoder = System.Text.Encodings.Web.JavaScriptEncoder.UnsafeRelaxedJsonEscaping
        };
        
        var json = JsonSerializer.Serialize(config, options);
        var configPath = Path.Combine(installerPath, "config.json");
        await File.WriteAllTextAsync(configPath, json, Encoding.UTF8);
    }
    
    private async Task<(bool exito, string? error, string? publishPath)> PublicarAplicacion(CancellationToken ct)
    {
        try
        {
            var projectPath = Env.ContentRootPath;
            var csprojPath = Path.Combine(projectPath, "SistemIA.csproj");
            
            if (!File.Exists(csprojPath))
            {
                return (false, "No se encontr√≥ SistemIA.csproj", null);
            }
            
            var publishPath = Path.Combine(projectPath, "bin", "Release", "net8.0", "publish");
            
            AgregarLog($"üìÇ Destino: {publishPath}", "info");
            await ActualizarUIAsync();
            
            // Ejecutar dotnet publish
            var psi = new System.Diagnostics.ProcessStartInfo
            {
                FileName = "dotnet",
                Arguments = $"publish \"{csprojPath}\" -c Release -r win-x64 --self-contained true -o \"{publishPath}\"",
                WorkingDirectory = projectPath,
                UseShellExecute = false,
                RedirectStandardOutput = true,
                RedirectStandardError = true,
                CreateNoWindow = true
            };
            
            AgregarLog("üöÄ Iniciando dotnet publish...", "info");
            await ActualizarUIAsync();
            
            _procesoActual = System.Diagnostics.Process.Start(psi);
            if (_procesoActual == null)
            {
                return (false, "No se pudo iniciar el proceso de publicaci√≥n", null);
            }
            
            // Leer output en tiempo real
            var outputTask = Task.Run(async () =>
            {
                try
                {
                    while (!_procesoActual.StandardOutput.EndOfStream && !ct.IsCancellationRequested)
                    {
                        var line = await _procesoActual.StandardOutput.ReadLineAsync();
                        if (!string.IsNullOrWhiteSpace(line))
                        {
                            await InvokeAsync(() =>
                            {
                                // Filtrar l√≠neas importantes
                                if (line.Contains("error") || line.Contains("Error"))
                                    AgregarLog($"‚ùå {line}", "error");
                                else if (line.Contains("warning") || line.Contains("Warning"))
                                    AgregarLog($"‚ö†Ô∏è {line}", "warning");
                                else if (line.Contains("->") || line.Contains("publish"))
                                    AgregarLog($"üì¶ {line}", "info");
                                StateHasChanged();
                            });
                        }
                    }
                }
                catch { }
            }, ct);
            
            // Leer errores en tiempo real
            var errorTask = Task.Run(async () =>
            {
                try
                {
                    while (!_procesoActual.StandardError.EndOfStream && !ct.IsCancellationRequested)
                    {
                        var line = await _procesoActual.StandardError.ReadLineAsync();
                        if (!string.IsNullOrWhiteSpace(line))
                        {
                            await InvokeAsync(() =>
                            {
                                AgregarLog($"‚ùå {line}", "error");
                                StateHasChanged();
                            });
                        }
                    }
                }
                catch { }
            }, ct);
            
            // Esperar con timeout de 5 minutos
            var timeoutTask = Task.Delay(TimeSpan.FromMinutes(5), ct);
            var processTask = _procesoActual.WaitForExitAsync(ct);
            
            // Actualizar UI peri√≥dicamente mientras espera
            var uiUpdateTask = Task.Run(async () =>
            {
                var dots = 0;
                while (!processTask.IsCompleted && !ct.IsCancellationRequested)
                {
                    await Task.Delay(1000, ct);
                    dots = (dots + 1) % 4;
                    var dotsStr = new string('.', dots + 1);
                    await InvokeAsync(() =>
                    {
                        _estadoActual = $"Compilando{dotsStr} (esto puede tardar varios minutos)";
                        StateHasChanged();
                    });
                }
            }, ct);
            
            var completedTask = await Task.WhenAny(processTask, timeoutTask);
            
            if (ct.IsCancellationRequested)
            {
                MatarProceso();
                return (false, "Operaci√≥n cancelada por el usuario", null);
            }
            
            if (completedTask == timeoutTask)
            {
                MatarProceso();
                return (false, "Timeout: la publicaci√≥n tard√≥ m√°s de 5 minutos", null);
            }
            
            // Esperar a que terminen de leer los outputs
            await Task.WhenAll(outputTask, errorTask).WaitAsync(TimeSpan.FromSeconds(2));
            
            if (_procesoActual.ExitCode != 0)
            {
                return (false, $"Error en publicaci√≥n (c√≥digo: {_procesoActual.ExitCode})", null);
            }
            
            AgregarLog("‚úÖ dotnet publish completado exitosamente", "success");
            _procesoActual = null;
            return (true, null, publishPath);
        }
        catch (OperationCanceledException)
        {
            MatarProceso();
            return (false, "Operaci√≥n cancelada", null);
        }
        catch (Exception ex)
        {
            MatarProceso();
            AgregarLog($"‚ùå Excepci√≥n: {ex.Message}", "error");
            return (false, ex.Message, null);
        }
    }
    
    private async Task ActualizarUIAsync()
    {
        await InvokeAsync(StateHasChanged);
        await Task.Delay(10);
    }
    
    private void MatarProceso()
    {
        try
        {
            if (_procesoActual != null && !_procesoActual.HasExited)
            {
                _procesoActual.Kill(true);
                _procesoActual.Dispose();
            }
        }
        catch { }
        _procesoActual = null;
    }
    
    private async Task CancelarGeneracion()
    {
        _cts?.Cancel();
        await Task.Run(() => MatarProceso());
        AgregarLog("‚ö†Ô∏è Generaci√≥n cancelada por el usuario", "warning");
        _generando = false;
        _progreso = 0;
        _estadoActual = "";
        MostrarMensaje("Generaci√≥n cancelada", true);
        await InvokeAsync(StateHasChanged);
    }
    
    private async Task AgregarCarpetaPublish(ZipArchive archive, string publishPath)
    {
        var files = Directory.GetFiles(publishPath, "*", SearchOption.AllDirectories);
        var totalFiles = files.Length;
        var processed = 0;
        
        foreach (var file in files)
        {
            var relativePath = Path.GetRelativePath(publishPath, file);
            var entryPath = Path.Combine("publish", relativePath).Replace('\\', '/');
            
            // Usar compresi√≥n para los archivos de publish
            var entry = archive.CreateEntry(entryPath, CompressionLevel.Optimal);
            
            using var entryStream = entry.Open();
            using var fileStream = File.OpenRead(file);
            await fileStream.CopyToAsync(entryStream);
            
            processed++;
            if (processed % 50 == 0)
            {
                await ActualizarProgreso(75 + (processed * 15 / totalFiles), $"Agregando binarios... {processed}/{totalFiles}");
                AgregarLog($"Procesando binarios... {processed}/{totalFiles}", "info");
            }
        }
    }
}
