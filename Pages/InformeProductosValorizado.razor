@page "/informes/productos-valorizado"
@using Microsoft.EntityFrameworkCore
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize]
@inject IDbContextFactory<SistemIA.Models.AppDbContext> DbFactory
@inject Microsoft.JSInterop.IJSRuntime JS
@inject SistemIA.Services.ISucursalProvider SucursalProvider
@inject NavigationManager Nav
@inject Microsoft.AspNetCore.Components.Authorization.AuthenticationStateProvider AuthStateProvider
@using ClosedXML.Excel

<PageProtection Modulo="/inventario" Permiso="VIEW">
<PageTitle>Listado Valorizado de Inventario</PageTitle>

<div class="container-fluid py-4">
  <h4 class="mb-4"><i class="bi bi-box-seam me-2"></i>Listado Valorizado de Inventario</h4>

  <!-- ========== FILTROS ========== -->
  <div class="card card-filtros mb-4">
    <div class="card-header"><i class="bi bi-funnel me-2"></i>Filtros</div>
    <div class="card-body">
      <div class="row g-3">
        <div class="col-md-2">
          <label class="form-label">Código</label>
          <input type="text" class="form-control" @bind="fCodigo" @bind:event="oninput" placeholder="Buscar..."/>
        </div>
        <div class="col-md-3">
          <label class="form-label">Descripción</label>
          <input type="text" class="form-control" @bind="fDescripcion" @bind:event="oninput" placeholder="Buscar..."/>
        </div>
        <div class="col-md-2">
          <label class="form-label">Marca</label>
          <select class="form-select" @bind="fIdMarca">
            <option value="0">— Todas —</option>
            @foreach (var m in marcas)
            {
              <option value="@m.IdMarca">@m.NombreMarca</option>
            }
          </select>
        </div>
        <div class="col-md-2">
          <label class="form-label">Categoría</label>
          <select class="form-select" @bind="fIdClasificacion">
            <option value="0">— Todas —</option>
            @foreach (var c in clasificaciones)
            {
              <option value="@c.IdClasificacion">@c.Nombre</option>
            }
          </select>
        </div>
        <div class="col-md-2">
          <label class="form-label">Depósito</label>
          <select class="form-select" @bind="fIdDeposito">
            <option value="0">— Todos (suma) —</option>
            @foreach (var d in depositos)
            {
              <option value="@d.IdDeposito">@d.Nombre</option>
            }
          </select>
        </div>
        <div class="col-md-1">
          <label class="form-label">Estado</label>
          <select class="form-select" @bind="fActivo">
            <option value="1">Activos</option>
            <option value="0">Inactivos</option>
            <option value="-1">Todos</option>
          </select>
        </div>
      </div>
      <div class="row g-3 mt-2">
        <div class="col-md-2">
          <label class="form-label">Tipo</label>
          <select class="form-select" @bind="fTipoItem">
            <option value="0">— Todos —</option>
            <option value="1">Productos</option>
            <option value="2">Servicios</option>
          </select>
        </div>
        <div class="col-md-2">
          <div class="form-check mt-4">
            <input type="checkbox" class="form-check-input" id="chkConStock" @bind="fSoloConStock" />
            <label class="form-check-label" for="chkConStock">Solo con stock</label>
          </div>
        </div>
        <div class="col-md-8 d-flex align-items-end justify-content-end gap-2">
          <button class="btn btn-primary" @onclick="Buscar"><i class="bi bi-search me-1"></i>Buscar</button>
          <button class="btn btn-outline-secondary" @onclick="ExportarCsv" disabled="@(!filas.Any())"><i class="bi bi-filetype-csv me-1"></i>CSV</button>
          <button class="btn btn-outline-success" @onclick="ExportarXlsx" disabled="@(!filas.Any())"><i class="bi bi-file-earmark-excel me-1"></i>Excel</button>
          <button class="btn btn-outline-dark" @onclick="Imprimir" disabled="@(!filas.Any())"><i class="bi bi-printer me-1"></i>Imprimir</button>
          <EnviarInformeCorreo 
            TituloInforme="Stock Valorizado" 
            OnGenerarHtml="GenerarTablaHtml" 
            FiltrosAplicados="@ObtenerFiltrosTexto()" />
        </div>
      </div>
    </div>
  </div>

  <!-- ========== RESUMEN DE UTILIDADES ========== -->
  @if (filas.Any())
  {
    <div class="row g-3 mb-4">
      <div class="col-md-3">
        <div class="card bg-info text-white h-100">
          <div class="card-body text-center">
            <div class="small text-uppercase">Valor Costo Total</div>
            <div class="fs-4 fw-bold">@totalCostoValorizado.ToString("N0") Gs</div>
            <div class="small">(@filas.Count productos)</div>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card bg-primary text-white h-100">
          <div class="card-body text-center">
            <div class="small text-uppercase">Valor Venta Total</div>
            <div class="fs-4 fw-bold">@totalVentaValorizado.ToString("N0") Gs</div>
            <div class="small">(@totalUnidades.ToString("N0") unidades)</div>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card bg-success text-white h-100">
          <div class="card-body text-center">
            <div class="small text-uppercase">Utilidad Bruta</div>
            <div class="fs-4 fw-bold">@utilidadBruta.ToString("N0") Gs</div>
            <div class="small">Diferencia Venta - Costo</div>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card @(margenPromedio >= 0 ? "bg-success" : "bg-danger") text-white h-100">
          <div class="card-body text-center">
            <div class="small text-uppercase">Mark-up Promedio</div>
            <div class="fs-4 fw-bold">@margenPromedio.ToString("N2") %</div>
            <div class="small">(Utilidad / Costo) × 100</div>
          </div>
        </div>
      </div>
    </div>
  }

  <!-- ========== TABLA DE DATOS ========== -->
  <div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
      <span><i class="bi bi-table me-2"></i>Detalle de Productos (@filas.Count registros)</span>
    </div>
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-sm table-striped table-hover mb-0">
          <thead class="table-light sticky-top">
            <tr>
              <th style="width:40px">#</th>
              <th style="width:100px">Código</th>
              <th>Descripción</th>
              <th class="text-center" style="width:80px" title="Paquetes calculados">Paq.</th>
              <th style="width:120px">Categoría</th>
              <th style="width:120px">Marca</th>
              <th class="text-end" style="width:80px">Cantidad</th>
              <th class="text-end" style="width:100px">Costo Unit.</th>
              <th class="text-end" style="width:100px">Precio Unit.</th>
              <th class="text-end" style="width:120px">Costo Total</th>
              <th class="text-end" style="width:120px">Venta Total</th>
              <th class="text-end" style="width:100px">Utilidad</th>
              <th class="text-end" style="width:90px">Mark-up %</th>
            </tr>
          </thead>
          <tbody>
            @if (!filas.Any())
            {
              <tr>
                <td colspan="13" class="text-center text-muted py-4">
                  <i class="bi bi-inbox fs-1 d-block mb-2"></i>
                  Sin resultados. Aplique filtros y presione Buscar.
                </td>
              </tr>
            }
            else
            {
              int n = 0;
              foreach (var r in filas)
              {
                var margenClass = r.MargenPorcentaje >= 30 ? "text-success" : (r.MargenPorcentaje >= 15 ? "text-warning" : "text-danger");
                var utilidadPct = r.VentaTotal > 0 ? (r.Utilidad / r.VentaTotal) * 100 : 0;
                var utilidadPctClass = utilidadPct >= 30 ? "text-primary" : "text-danger";
                var esPaq = (r.UnidadMedidaCodigo == "006" || r.UnidadMedidaCodigo == "005") && r.CantidadPorPaquete > 1;
                var paqVal = esPaq ? Math.Floor(r.Cantidad / r.CantidadPorPaquete) : 0m;
                var sueltVal = esPaq ? r.Cantidad % r.CantidadPorPaquete : 0m;
                var paqTxt = esPaq ? $"{paqVal:N0}{(sueltVal > 0 ? $" +{sueltVal:N0}" : "")}" : "-";
                <tr>
                  <td class="text-muted">@(++n)</td>
                  <td><span class="badge bg-secondary">@r.CodigoInterno</span></td>
                  <td><div class="fw-semibold">@r.Descripcion</div></td>
                  <td class="text-center" title="@(esPaq ? $"{paqVal:N0} paq. × {r.CantidadPorPaquete} = {paqVal * r.CantidadPorPaquete:N0} + {sueltVal:N0} sueltas" : "No aplica")">@paqTxt</td>
                  <td>@(string.IsNullOrEmpty(r.Clasificacion) ? "—" : r.Clasificacion)</td>
                  <td>@(string.IsNullOrEmpty(r.Marca) ? "—" : r.Marca)</td>
                  <td class="text-end">@r.Cantidad.ToString("N2")</td>
                  <td class="text-end">@r.CostoUnitario.ToString("N0")</td>
                  <td class="text-end">@r.PrecioUnitario.ToString("N0")</td>
                  <td class="text-end fw-semibold">@r.CostoTotal.ToString("N0")</td>
                  <td class="text-end fw-semibold">@r.VentaTotal.ToString("N0")</td>
                  <td class="text-end @(r.Utilidad >= 0 ? "text-success" : "text-danger")">@r.Utilidad.ToString("N0")</td>
                  <td class="text-end">
                    <span class="@margenClass fw-bold">@r.MargenPorcentaje.ToString("N1")%</span>
                    <br/><small class="@utilidadPctClass">Ut: @utilidadPct.ToString("N1")%</small>
                  </td>
                </tr>
              }
            }
          </tbody>
          @if (filas.Any())
          {
            var utilidadPromedio = totalVentaValorizado > 0 ? (utilidadBruta / totalVentaValorizado) * 100 : 0;
            var utilidadPromedioClass = utilidadPromedio >= 30 ? "text-primary" : "text-danger";
            <tfoot class="table-light">
              <tr class="fw-bold">
                <th colspan="6" class="text-end">TOTALES</th>
                <th class="text-end">@totalUnidades.ToString("N2")</th>
                <th></th>
                <th></th>
                <th class="text-end">@totalCostoValorizado.ToString("N0")</th>
                <th class="text-end">@totalVentaValorizado.ToString("N0")</th>
                <th class="text-end text-success">@utilidadBruta.ToString("N0")</th>
                <th class="text-end">
                  <span>@margenPromedio.ToString("N1")%</span>
                  <br/><small class="@utilidadPromedioClass">Ut: @utilidadPromedio.ToString("N1")%</small>
                </th>
              </tr>
            </tfoot>
          }
        </table>
      </div>
    </div>
  </div>
</div>

</PageProtection>

@code {
  // ========== FILTROS ==========
  private string? fCodigo;
  private string? fDescripcion;
  private int fIdMarca = 0;
  private int fIdClasificacion = 0;
  private int fIdDeposito = 0;
  private int fTipoItem = 0;
  private int fActivo = 1;
  private bool fSoloConStock = true;

  // ========== CATÁLOGOS ==========
  private List<SistemIA.Models.Marca> marcas = new();
  private List<SistemIA.Models.Clasificacion> clasificaciones = new();
  private List<SistemIA.Models.Deposito> depositos = new();
  private List<FilaValorizada> filas = new();

  // ========== TOTALES ==========
  private decimal totalCostoValorizado = 0;
  private decimal totalVentaValorizado = 0;
  private decimal utilidadBruta = 0;
  private decimal margenPromedio = 0;
  private decimal totalUnidades = 0;

  protected override async Task OnInitializedAsync()
  {
    var sucId = SucursalProvider.GetSucursalId();
    if (!sucId.HasValue)
    {
      var ret = System.Net.WebUtility.UrlEncode(Nav.Uri);
      Nav.NavigateTo($"/seleccionar-sucursal?returnUrl={ret}", forceLoad: true);
      return;
    }

    await using var ctx = await DbFactory.CreateDbContextAsync();
    marcas = await ctx.Marcas.AsNoTracking().OrderBy(m => m.NombreMarca).ToListAsync();
    clasificaciones = await ctx.Clasificaciones.AsNoTracking().Where(c => c.Activo).OrderBy(c => c.Nombre).ToListAsync();
    depositos = await ctx.Depositos.AsNoTracking()
      .Where(d => d.Activo && d.IdSucursal == sucId)
      .OrderBy(d => d.Nombre)
      .ToListAsync();

    await Buscar();
  }

  private async Task Buscar()
  {
    await using var ctx = await DbFactory.CreateDbContextAsync();
    var sucId = SucursalProvider.GetSucursalId();

    // Obtener stocks por depósito
    Dictionary<int, decimal> stocksPorProducto = new();

    if (fIdDeposito > 0)
    {
      var stocksDeposito = await ctx.ProductosDepositos.AsNoTracking()
        .Where(pd => pd.IdDeposito == fIdDeposito)
        .Select(pd => new { pd.IdProducto, pd.Stock })
        .ToListAsync();
      foreach (var s in stocksDeposito)
        stocksPorProducto[s.IdProducto] = s.Stock;
    }
    else
    {
      var stocksAgrupados = await ctx.ProductosDepositos.AsNoTracking()
        .GroupBy(pd => pd.IdProducto)
        .Select(g => new { IdProducto = g.Key, Stock = g.Sum(x => x.Stock) })
        .ToListAsync();
      foreach (var s in stocksAgrupados)
        stocksPorProducto[s.IdProducto] = s.Stock;
    }

    var q = from p in ctx.Productos.AsNoTracking()
            join m in ctx.Marcas.AsNoTracking() on p.IdMarca equals m.IdMarca into mJoin
            from m in mJoin.DefaultIfEmpty()
            join c in ctx.Clasificaciones.AsNoTracking() on p.IdClasificacion equals c.IdClasificacion into cJoin
            from c in cJoin.DefaultIfEmpty()
            select new {
              p.IdProducto, p.CodigoInterno, p.Descripcion,
              Marca = m != null ? m.NombreMarca : null,
              Clasificacion = c != null ? c.Nombre : null,
              p.CostoUnitarioGs, p.PrecioUnitarioGs,
              p.Stock, p.Activo, p.IdSucursal, p.IdMarca, p.IdClasificacion, p.TipoItem,
              p.CantidadPorPaquete, p.UnidadMedidaCodigo
            };

    if (sucId.HasValue)
      q = q.Where(x => x.IdSucursal == sucId.Value);

    // Aplicar filtros
    if (!string.IsNullOrWhiteSpace(fCodigo))
      q = q.Where(x => (x.CodigoInterno ?? "").Contains(fCodigo.Trim()));
    if (!string.IsNullOrWhiteSpace(fDescripcion))
      q = q.Where(x => (x.Descripcion ?? "").Contains(fDescripcion.Trim()));
    if (fIdMarca != 0)
      q = q.Where(x => x.IdMarca == fIdMarca);
    if (fIdClasificacion != 0)
      q = q.Where(x => x.IdClasificacion == fIdClasificacion);
    if (fTipoItem != 0)
      q = q.Where(x => x.TipoItem == fTipoItem);
    if (fActivo != -1)
      q = q.Where(x => x.Activo == (fActivo == 1));

    var data = await q.OrderBy(x => x.Descripcion).Take(5000).ToListAsync();

    filas = data.Select(x => {
      decimal stock = stocksPorProducto.GetValueOrDefault(x.IdProducto, 0);
      decimal costo = x.CostoUnitarioGs ?? 0;
      decimal precio = x.PrecioUnitarioGs;
      decimal costoTotal = costo * stock;
      decimal ventaTotal = precio * stock;
      decimal utilidad = ventaTotal - costoTotal;
      decimal margen = costoTotal > 0 ? (utilidad / costoTotal) * 100 : (ventaTotal > 0 ? 100 : 0);

      return new FilaValorizada {
        IdProducto = x.IdProducto,
        CodigoInterno = x.CodigoInterno ?? "",
        Descripcion = x.Descripcion ?? "",
        Marca = x.Marca,
        Clasificacion = x.Clasificacion,
        CantidadPorPaquete = (int)(x.CantidadPorPaquete ?? 1),
        UnidadMedidaCodigo = x.UnidadMedidaCodigo,
        Cantidad = stock,
        CostoUnitario = costo,
        PrecioUnitario = precio,
        CostoTotal = costoTotal,
        VentaTotal = ventaTotal,
        Utilidad = utilidad,
        MargenPorcentaje = margen
      };
    }).ToList();

    // Filtrar solo con stock si está activo
    if (fSoloConStock)
      filas = filas.Where(f => f.Cantidad > 0).ToList();

    // Calcular totales
    totalUnidades = filas.Sum(f => f.Cantidad);
    totalCostoValorizado = filas.Sum(f => f.CostoTotal);
    totalVentaValorizado = filas.Sum(f => f.VentaTotal);
    utilidadBruta = totalVentaValorizado - totalCostoValorizado;
    margenPromedio = totalCostoValorizado > 0 ? (utilidadBruta / totalCostoValorizado) * 100 : 0;
  }

  private async Task Imprimir()
  {
    if (!filas.Any()) return;

    var head = new System.Text.StringBuilder();
    head.AppendLine("<meta charset=\"utf-8\"/>");
    head.AppendLine("<title>Listado Valorizado de Inventario</title>");
    head.AppendLine("<link rel=\"stylesheet\" href=\"/css/bootstrap/bootstrap.min.css\" />");
    head.AppendLine("<style>");
    head.AppendLine("@media print { @page { size: A4 landscape; margin: 10mm 10mm; } }");
    head.AppendLine("body{font-size:9px;color:#111;}");
    head.AppendLine(".factura-header{display:flex;align-items:center;gap:16px;border-bottom:2px solid #222;padding-bottom:8px;margin-bottom:12px;}");
    head.AppendLine(".factura-header .logo{max-width:120px;max-height:60px;object-fit:contain;display:block;border-radius:6px;border:1px solid #e5e7eb;background:#fff;padding:6px;}");
    head.AppendLine(".factura-header .logo-wrap{width:140px;display:flex;align-items:center;justify-content:center;}");
    head.AppendLine(".factura-header .empresa h2{margin:0;font-size:18px;}");
    head.AppendLine(".factura-header .empresa .small{color:#555;}");
    head.AppendLine(".tabla th,.tabla td{padding:.2rem .3rem;border-bottom:1px solid #e5e7eb;vertical-align:top;font-size:8px;}");
    head.AppendLine(".right{text-align:right}");
    head.AppendLine(".center{text-align:center}");
    head.AppendLine(".muted{color:#666}");
    head.AppendLine(".resumen{display:flex;gap:20px;margin-bottom:15px;padding:10px;background:#f8f9fa;border-radius:8px;}");
    head.AppendLine(".resumen-item{flex:1;text-align:center;padding:8px;background:white;border-radius:6px;border:1px solid #dee2e6;}");
    head.AppendLine(".resumen-item .label{font-size:9px;color:#666;text-transform:uppercase;}");
    head.AppendLine(".resumen-item .value{font-size:14px;font-weight:bold;}");
    head.AppendLine(".text-success{color:#198754}");
    head.AppendLine(".text-danger{color:#dc3545}");
    head.AppendLine("</style>");

    await using var ctx = await DbFactory.CreateDbContextAsync();
    var suc = await ctx.Sucursal.AsNoTracking().OrderBy(s => s.Id).FirstOrDefaultAsync();
    var sucIdSel = SucursalProvider.GetSucursalId();
    if (sucIdSel.HasValue)
    {
      var s2 = await ctx.Sucursal.AsNoTracking().FirstOrDefaultAsync(s => s.Id == sucIdSel.Value);
      if (s2 != null) suc = s2;
    }
    string empresa = suc?.NombreEmpresa ?? "Empresa";
    string sucursal = suc?.NombreSucursal ?? "Sucursal";
    string ruc = suc != null ? $"{suc.RUC}-{suc.DV}" : "";
    string? logoDataUri = null;
    if (suc?.Logo != null && suc.Logo.Length > 0) logoDataUri = $"data:image/png;base64,{Convert.ToBase64String(suc.Logo)}";

    var depositoNombre = fIdDeposito == 0 ? "Todos" : depositos.FirstOrDefault(d => d.IdDeposito == fIdDeposito)?.Nombre ?? "";
    var filtros = $"Marca: {(fIdMarca == 0 ? "Todas" : marcas.FirstOrDefault(m => m.IdMarca == fIdMarca)?.NombreMarca)} | Categoría: {(fIdClasificacion == 0 ? "Todas" : clasificaciones.FirstOrDefault(c => c.IdClasificacion == fIdClasificacion)?.Nombre)} | Depósito: {depositoNombre}";

    var sb = new System.Text.StringBuilder();
    sb.AppendLine("<div class=\"container-fluid\">");
    sb.AppendLine("  <div class=\"factura-header\">");
    sb.AppendLine("    <div class=\"logo-wrap\">");
    if (!string.IsNullOrEmpty(logoDataUri)) sb.AppendLine($"      <img class=\"logo\" src=\"{logoDataUri}\" alt=\"Logo\"/>");
    else sb.AppendLine("      <div class=\"logo d-flex align-items-center justify-content-center\" style=\"font-size:10px;color:#999;min-height:40px;min-width:100px;\">LOGO</div>");
    sb.AppendLine("    </div>");
    sb.AppendLine("    <div class=\"empresa\">");
    sb.AppendLine($"      <h2>{System.Net.WebUtility.HtmlEncode(empresa)}</h2>");
    sb.AppendLine($"      <div class=\"small\">RUC: {ruc}</div>");
    sb.AppendLine($"      <div class=\"small\">{System.Net.WebUtility.HtmlEncode(sucursal)}</div>");
    sb.AppendLine("    </div>");
    sb.AppendLine("    <div class=\"ms-auto text-end\">");
    sb.AppendLine("      <div class=\"fw-bold\" style=\"font-size:18px\">Listado Valorizado de Inventario</div>");
    sb.AppendLine($"      <div>Fecha: {DateTime.Now:dd/MM/yyyy HH:mm}</div>");
    sb.AppendLine($"      <div class=\"small muted\">{System.Net.WebUtility.HtmlEncode(filtros)}</div>");
    sb.AppendLine("    </div>");
    sb.AppendLine("  </div>");

    // Resumen
    sb.AppendLine("  <div class=\"resumen\">");
    sb.AppendLine($"    <div class=\"resumen-item\"><div class=\"label\">Valor Costo</div><div class=\"value\">{totalCostoValorizado:N0} Gs</div></div>");
    sb.AppendLine($"    <div class=\"resumen-item\"><div class=\"label\">Valor Venta</div><div class=\"value\">{totalVentaValorizado:N0} Gs</div></div>");
    sb.AppendLine($"    <div class=\"resumen-item\"><div class=\"label\">Utilidad Bruta</div><div class=\"value text-success\">{utilidadBruta:N0} Gs</div></div>");
    sb.AppendLine($"    <div class=\"resumen-item\"><div class=\"label\">Margen Promedio</div><div class=\"value\">{margenPromedio:N2}%</div></div>");
    sb.AppendLine($"    <div class=\"resumen-item\"><div class=\"label\">Total Unidades</div><div class=\"value\">{totalUnidades:N0}</div></div>");
    sb.AppendLine("  </div>");

    // Tabla
    sb.AppendLine("  <table class=\"table table-sm tabla\">");
    sb.AppendLine("    <thead><tr><th>#</th><th>Código</th><th>Descripción</th><th class='center'>Paq.</th><th>Categoría</th><th>Marca</th><th class='right'>Cantidad</th><th class='right'>Costo Unit.</th><th class='right'>Precio Unit.</th><th class='right'>Costo Total</th><th class='right'>Venta Total</th><th class='right'>Utilidad</th><th class='right'>Margen %</th></tr></thead>");
    sb.AppendLine("    <tbody>");
    int n = 0;
    foreach (var r in filas)
    {
      var utilClass = r.Utilidad >= 0 ? "text-success" : "text-danger";
      var esPaq = (r.UnidadMedidaCodigo == "006" || r.UnidadMedidaCodigo == "005") && r.CantidadPorPaquete > 1;
      var paqVal = esPaq ? Math.Floor(r.Cantidad / r.CantidadPorPaquete) : 0m;
      var sueltVal = esPaq ? r.Cantidad % r.CantidadPorPaquete : 0m;
      var paqTxt = esPaq ? $"{paqVal:N0}{(sueltVal > 0 ? $" +{sueltVal:N0}" : "")}" : "-";
      sb.AppendLine($"      <tr><td>{++n}</td><td>{System.Net.WebUtility.HtmlEncode(r.CodigoInterno)}</td><td>{System.Net.WebUtility.HtmlEncode(r.Descripcion)}</td><td class='center'>{paqTxt}</td><td>{System.Net.WebUtility.HtmlEncode(r.Clasificacion ?? "-")}</td><td>{System.Net.WebUtility.HtmlEncode(r.Marca ?? "-")}</td><td class='right'>{r.Cantidad:N2}</td><td class='right'>{r.CostoUnitario:N0}</td><td class='right'>{r.PrecioUnitario:N0}</td><td class='right'>{r.CostoTotal:N0}</td><td class='right'>{r.VentaTotal:N0}</td><td class='right {utilClass}'>{r.Utilidad:N0}</td><td class='right'>{r.MargenPorcentaje:N1}%</td></tr>");
    }
    sb.AppendLine("    </tbody>");
    sb.AppendLine($"    <tfoot><tr class='fw-bold'><th colspan='6' class='right'>TOTALES</th><th class='right'>{totalUnidades:N2}</th><th></th><th></th><th class='right'>{totalCostoValorizado:N0}</th><th class='right'>{totalVentaValorizado:N0}</th><th class='right text-success'>{utilidadBruta:N0}</th><th class='right'>{margenPromedio:N2}%</th></tr></tfoot>");
    sb.AppendLine("  </table>");
    sb.AppendLine("</div>");

    await JS.InvokeVoidAsync("printHtmlWithHead", head.ToString(), sb.ToString());
  }

  private async Task ExportarCsv()
  {
    if (!filas.Any()) return;
    var sep = ';';
    var sb = new System.Text.StringBuilder();
    var auth = await AuthStateProvider.GetAuthenticationStateAsync();
    var usuario = auth.User?.Identity?.Name ?? "";
    var suc = SucursalProvider.GetSucursalNombre() ?? "";

    sb.AppendLine($"Generado={DateTime.Now:yyyy-MM-dd HH:mm};Usuario={usuario};Sucursal={suc}");
    sb.AppendLine($"Valor Costo Total={totalCostoValorizado:N0};Valor Venta Total={totalVentaValorizado:N0};Utilidad Bruta={utilidadBruta:N0};Margen Promedio={margenPromedio:N2}%");
    sb.AppendLine();
    sb.AppendLine(string.Join(sep, new[] { "Nro", "Código", "Descripción", "Paq.", "Categoría", "Marca", "Cantidad", "Costo Unit.", "Precio Unit.", "Costo Total", "Venta Total", "Utilidad", "Margen %" }));

    int n = 0;
    foreach (var r in filas)
    {
      var esPaq = (r.UnidadMedidaCodigo == "006" || r.UnidadMedidaCodigo == "005") && r.CantidadPorPaquete > 1;
      var paqVal = esPaq ? Math.Floor(r.Cantidad / r.CantidadPorPaquete) : 0m;
      var sueltVal = esPaq ? r.Cantidad % r.CantidadPorPaquete : 0m;
      var paqTxt = esPaq ? $"{paqVal:N0}{(sueltVal > 0 ? $" +{sueltVal:N0}" : "")}" : "-";
      string[] cols = new[]
      {
        (++n).ToString(),
        r.CodigoInterno,
        r.Descripcion,
        paqTxt,
        r.Clasificacion ?? "",
        r.Marca ?? "",
        r.Cantidad.ToString(System.Globalization.CultureInfo.InvariantCulture),
        r.CostoUnitario.ToString(System.Globalization.CultureInfo.InvariantCulture),
        r.PrecioUnitario.ToString(System.Globalization.CultureInfo.InvariantCulture),
        r.CostoTotal.ToString(System.Globalization.CultureInfo.InvariantCulture),
        r.VentaTotal.ToString(System.Globalization.CultureInfo.InvariantCulture),
        r.Utilidad.ToString(System.Globalization.CultureInfo.InvariantCulture),
        r.MargenPorcentaje.ToString(System.Globalization.CultureInfo.InvariantCulture)
      };
      var line = string.Join(sep, cols.Select(v => !string.IsNullOrEmpty(v) && (v.Contains(sep) || v.Contains('"') || v.Contains('\n')) ? $"\"{v.Replace("\"", "\"\"")}\"" : v ?? ""));
      sb.AppendLine(line);
    }

    var utf8bom = new System.Text.UTF8Encoding(encoderShouldEmitUTF8Identifier: true);
    var bytes = utf8bom.GetBytes(sb.ToString());
    var b64 = Convert.ToBase64String(bytes);
    var file = $"InventarioValorizado_{DateTime.Now:yyyyMMdd_HHmmss}.csv";
    await JS.InvokeVoidAsync("downloadFile", b64, file, "text/csv;charset=utf-8");
  }

  private async Task ExportarXlsx()
  {
    if (!filas.Any()) return;
    var auth = await AuthStateProvider.GetAuthenticationStateAsync();
    var usuario = auth.User?.Identity?.Name ?? "";
    var suc = SucursalProvider.GetSucursalNombre() ?? "";

    using var wb = new XLWorkbook();
    var ws = wb.AddWorksheet("Inventario Valorizado");
    int row = 1;

    // Encabezado
    ws.Cell(row, 1).Value = "Generado"; ws.Cell(row, 2).Value = DateTime.Now; ws.Cell(row, 2).Style.DateFormat.Format = "yyyy-MM-dd HH:mm"; row++;
    ws.Cell(row, 1).Value = "Usuario"; ws.Cell(row, 2).Value = usuario; row++;
    ws.Cell(row, 1).Value = "Sucursal"; ws.Cell(row, 2).Value = suc; row += 2;

    // Resumen
    ws.Cell(row, 1).Value = "RESUMEN DE UTILIDADES";
    ws.Cell(row, 1).Style.Font.Bold = true;
    ws.Cell(row, 1).Style.Font.FontSize = 12;
    row++;
    ws.Cell(row, 1).Value = "Valor Costo Total"; ws.Cell(row, 2).Value = totalCostoValorizado; ws.Cell(row, 2).Style.NumberFormat.Format = "#,##0"; row++;
    ws.Cell(row, 1).Value = "Valor Venta Total"; ws.Cell(row, 2).Value = totalVentaValorizado; ws.Cell(row, 2).Style.NumberFormat.Format = "#,##0"; row++;
    ws.Cell(row, 1).Value = "Utilidad Bruta"; ws.Cell(row, 2).Value = utilidadBruta; ws.Cell(row, 2).Style.NumberFormat.Format = "#,##0"; 
    ws.Cell(row, 2).Style.Font.FontColor = XLColor.Green; row++;
    ws.Cell(row, 1).Value = "Margen Promedio %"; ws.Cell(row, 2).Value = margenPromedio / 100; ws.Cell(row, 2).Style.NumberFormat.Format = "0.00%"; row++;
    ws.Cell(row, 1).Value = "Total Unidades"; ws.Cell(row, 2).Value = totalUnidades; ws.Cell(row, 2).Style.NumberFormat.Format = "#,##0.00"; row += 2;

    // Cabeceras de tabla
    var headers = new[] { "#", "Código", "Descripción", "Paq.", "Categoría", "Marca", "Cantidad", "Costo Unit.", "Precio Unit.", "Costo Total", "Venta Total", "Utilidad", "Margen %" };
    for (int c = 0; c < headers.Length; c++) ws.Cell(row, c + 1).Value = headers[c];
    ws.Range(row, 1, row, headers.Length).Style.Font.Bold = true;
    ws.Range(row, 1, row, headers.Length).Style.Fill.BackgroundColor = XLColor.LightGray;
    row++;

    // Datos
    int n = 0;
    foreach (var r in filas)
    {
      var esPaq = (r.UnidadMedidaCodigo == "006" || r.UnidadMedidaCodigo == "005") && r.CantidadPorPaquete > 1;
      var paqVal = esPaq ? Math.Floor(r.Cantidad / r.CantidadPorPaquete) : 0m;
      var sueltVal = esPaq ? r.Cantidad % r.CantidadPorPaquete : 0m;
      var paqTxt = esPaq ? $"{paqVal:N0}{(sueltVal > 0 ? $" +{sueltVal:N0}" : "")}" : "-";
      ws.Cell(row, 1).Value = ++n;
      ws.Cell(row, 2).Value = r.CodigoInterno;
      ws.Cell(row, 3).Value = r.Descripcion;
      ws.Cell(row, 4).Value = paqTxt;
      ws.Cell(row, 5).Value = r.Clasificacion ?? "";
      ws.Cell(row, 6).Value = r.Marca ?? "";
      ws.Cell(row, 7).Value = r.Cantidad; ws.Cell(row, 7).Style.NumberFormat.Format = "#,##0.00";
      ws.Cell(row, 8).Value = r.CostoUnitario; ws.Cell(row, 8).Style.NumberFormat.Format = "#,##0";
      ws.Cell(row, 9).Value = r.PrecioUnitario; ws.Cell(row, 9).Style.NumberFormat.Format = "#,##0";
      ws.Cell(row, 10).Value = r.CostoTotal; ws.Cell(row, 10).Style.NumberFormat.Format = "#,##0";
      ws.Cell(row, 11).Value = r.VentaTotal; ws.Cell(row, 11).Style.NumberFormat.Format = "#,##0";
      ws.Cell(row, 12).Value = r.Utilidad; ws.Cell(row, 12).Style.NumberFormat.Format = "#,##0";
      if (r.Utilidad >= 0)
        ws.Cell(row, 12).Style.Font.FontColor = XLColor.Green;
      else
        ws.Cell(row, 12).Style.Font.FontColor = XLColor.Red;
      ws.Cell(row, 13).Value = r.MargenPorcentaje / 100; ws.Cell(row, 13).Style.NumberFormat.Format = "0.0%";
      row++;
    }

    // Fila de totales
    ws.Cell(row, 6).Value = "TOTALES"; ws.Cell(row, 6).Style.Font.Bold = true;
    ws.Cell(row, 7).Value = totalUnidades; ws.Cell(row, 7).Style.NumberFormat.Format = "#,##0.00"; ws.Cell(row, 7).Style.Font.Bold = true;
    ws.Cell(row, 10).Value = totalCostoValorizado; ws.Cell(row, 10).Style.NumberFormat.Format = "#,##0"; ws.Cell(row, 10).Style.Font.Bold = true;
    ws.Cell(row, 11).Value = totalVentaValorizado; ws.Cell(row, 11).Style.NumberFormat.Format = "#,##0"; ws.Cell(row, 11).Style.Font.Bold = true;
    ws.Cell(row, 12).Value = utilidadBruta; ws.Cell(row, 12).Style.NumberFormat.Format = "#,##0"; ws.Cell(row, 12).Style.Font.Bold = true; ws.Cell(row, 12).Style.Font.FontColor = XLColor.Green;
    ws.Cell(row, 13).Value = margenPromedio / 100; ws.Cell(row, 13).Style.NumberFormat.Format = "0.00%"; ws.Cell(row, 13).Style.Font.Bold = true;

    ws.Columns().AdjustToContents();
    using var ms = new System.IO.MemoryStream();
    wb.SaveAs(ms);
    var b64 = Convert.ToBase64String(ms.ToArray());
    var file = $"InventarioValorizado_{DateTime.Now:yyyyMMdd_HHmmss}.xlsx";
    await JS.InvokeVoidAsync("downloadFile", b64, file, "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet");
  }

  private string ObtenerFiltrosTexto()
  {
    var partes = new List<string>();
    if (!string.IsNullOrWhiteSpace(fCodigo)) partes.Add($"Código: {fCodigo}");
    if (!string.IsNullOrWhiteSpace(fDescripcion)) partes.Add($"Descripción: {fDescripcion}");
    if (fIdMarca != 0) partes.Add($"Marca: {marcas.FirstOrDefault(m=>m.IdMarca==fIdMarca)?.NombreMarca}");
    if (fIdClasificacion != 0) partes.Add($"Categoría: {clasificaciones.FirstOrDefault(c=>c.IdClasificacion==fIdClasificacion)?.Nombre}");
    if (fIdDeposito != 0) partes.Add($"Depósito: {depositos.FirstOrDefault(d=>d.IdDeposito==fIdDeposito)?.Nombre}");
    partes.Add($"Estado: {(fActivo == 1 ? "Activos" : fActivo == 0 ? "Inactivos" : "Todos")}");
    if (fSoloConStock) partes.Add("Solo con stock");
    return string.Join(" | ", partes);
  }

  private Task<string> GenerarTablaHtml()
  {
    var sb = new System.Text.StringBuilder();
    // Resumen
    sb.AppendLine("<div style='margin-bottom:15px; padding:10px; background:#f8f9fa; border-radius:8px;'>");
    sb.AppendLine($"<strong>Resumen:</strong> Valor Costo: {totalCostoValorizado:N0} Gs | Valor Venta: {totalVentaValorizado:N0} Gs | Utilidad: {utilidadBruta:N0} Gs | Margen: {margenPromedio:N2}% | Unidades: {totalUnidades:N0}");
    sb.AppendLine("</div>");
    
    sb.AppendLine("<table border='1' cellpadding='5' cellspacing='0' style='border-collapse:collapse; font-size:10px;'>");
    sb.AppendLine("<thead><tr style='background-color:#f0f0f0; font-weight:bold;'>");
    sb.AppendLine("<th>#</th><th>Código</th><th>Descripción</th><th style='text-align:center'>Paq.</th><th>Categoría</th><th>Marca</th><th style='text-align:right'>Cantidad</th><th style='text-align:right'>Costo Unit.</th><th style='text-align:right'>Precio Unit.</th><th style='text-align:right'>Costo Total</th><th style='text-align:right'>Venta Total</th><th style='text-align:right'>Utilidad</th><th style='text-align:right'>Margen %</th>");
    sb.AppendLine("</tr></thead>");
    sb.AppendLine("<tbody>");
    int n = 0;
    foreach (var r in filas)
    {
      var utilColor = r.Utilidad >= 0 ? "color:#198754" : "color:#dc3545";
      var esPaq = (r.UnidadMedidaCodigo == "006" || r.UnidadMedidaCodigo == "005") && r.CantidadPorPaquete > 1;
      var paqVal = esPaq ? Math.Floor(r.Cantidad / r.CantidadPorPaquete) : 0m;
      var sueltVal = esPaq ? r.Cantidad % r.CantidadPorPaquete : 0m;
      var paqTxt = esPaq ? $"{paqVal:N0}{(sueltVal > 0 ? $" +{sueltVal:N0}" : "")}" : "-";
      sb.AppendLine("<tr>");
      sb.AppendLine($"<td>{++n}</td><td>{System.Net.WebUtility.HtmlEncode(r.CodigoInterno)}</td><td>{System.Net.WebUtility.HtmlEncode(r.Descripcion)}</td><td style='text-align:center'>{paqTxt}</td><td>{System.Net.WebUtility.HtmlEncode(r.Clasificacion ?? "-")}</td><td>{System.Net.WebUtility.HtmlEncode(r.Marca ?? "-")}</td><td style='text-align:right'>{r.Cantidad:N2}</td><td style='text-align:right'>{r.CostoUnitario:N0}</td><td style='text-align:right'>{r.PrecioUnitario:N0}</td><td style='text-align:right'>{r.CostoTotal:N0}</td><td style='text-align:right'>{r.VentaTotal:N0}</td><td style='text-align:right; {utilColor}'>{r.Utilidad:N0}</td><td style='text-align:right'>{r.MargenPorcentaje:N1}%</td>");
      sb.AppendLine("</tr>");
    }
    sb.AppendLine("</tbody>");
    sb.AppendLine("<tfoot><tr style='background-color:#f0f0f0; font-weight:bold;'>");
    sb.AppendLine($"<td colspan='6' style='text-align:right'>TOTALES</td><td style='text-align:right'>{totalUnidades:N2}</td><td></td><td></td><td style='text-align:right'>{totalCostoValorizado:N0}</td><td style='text-align:right'>{totalVentaValorizado:N0}</td><td style='text-align:right; color:#198754'>{utilidadBruta:N0}</td><td style='text-align:right'>{margenPromedio:N2}%</td>");
    sb.AppendLine("</tr></tfoot>");
    sb.AppendLine("</table>");
    return Task.FromResult(sb.ToString());
  }

  // ========== CLASE AUXILIAR ==========
  private class FilaValorizada
  {
    public int IdProducto { get; set; }
    public string CodigoInterno { get; set; } = string.Empty;
    public string Descripcion { get; set; } = string.Empty;
    public string? Marca { get; set; }
    public string? Clasificacion { get; set; }
    public int CantidadPorPaquete { get; set; } = 1;
    public string? UnidadMedidaCodigo { get; set; }
    public decimal Cantidad { get; set; }
    public decimal CostoUnitario { get; set; }
    public decimal PrecioUnitario { get; set; }
    public decimal CostoTotal { get; set; }
    public decimal VentaTotal { get; set; }
    public decimal Utilidad { get; set; }
    public decimal MargenPorcentaje { get; set; }
  }
}
