@page "/sucursal-config"
@using Microsoft.EntityFrameworkCore
@using SistemIA.Models
@using SistemIA.Utils
@using System.Text
@inject IDbContextFactory<SistemIA.Models.AppDbContext> DbFactory

<h3>Configuracion de Sucursal para DNIT y Facturaci√≥n Electr√≥nica</h3>

@if (loading)
{
    <p>Cargando...</p>
}
else
{
    <div class="row">
        <div class="col-md-8">
            <div class="card">
                <div class="card-body">
                    @if (sucursalExiste)
                    {
                        <div class="alert alert-info">
                            <strong>Sucursal configurada:</strong> @nombreSucursal
                        </div>
                    }
                    else
                    {
                        <div class="alert alert-warning">
                            No hay sucursal configurada. Complete los datos para habilitar DNIT y facturaci√≥n electr√≥nica.
                        </div>
                    }

                    <div class="mb-3">
                        <label class="form-label">Nombre Sucursal</label>
                        <input type="text" class="form-control" @bind="nombreSucursal" />
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Nombre Empresa</label>
                        <input type="text" class="form-control" @bind="nombreEmpresa" />
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">RUC</label>
                        <input type="text" class="form-control" @bind="ruc" />
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Certificado (.p12)</label>
                        <select class="form-select" @bind="certificadoPath">
                            <option value="">-- Seleccionar --</option>
                            @foreach (var cert in certificados)
                            {
                                <option value="@cert">@System.IO.Path.GetFileName(cert)</option>
                            }
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Password Certificado</label>
                        <div class="input-group">
                            <input type="@(mostrarPassword ? "text" : "password")" class="form-control" @bind="password" placeholder="Ingrese la contrase√±a del certificado" />
                            <button class="btn btn-outline-secondary" type="button" @onclick="TogglePasswordVisibility">
                                @if (mostrarPassword)
                                {
                                    <i class="fas fa-eye-slash"></i>
                                }
                                else
                                {
                                    <i class="fas fa-eye"></i>
                                }
                            </button>
                        </div>
                        @if (!string.IsNullOrEmpty(password))
                        {
                            <div class="form-text">
                                <small>Contrase√±a actual: <code>@(mostrarPassword ? password : new string('*', password.Length))</code></small>
                            </div>
                        }
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Ambiente SET</label>
                        <select class="form-select" @bind="ambiente">
                            <option value="test">Pruebas (sifen-test.set.gov.py)</option>
                            <option value="prod">Producci√≥n (sifen.set.gov.py)</option>
                        </select>
                        <div class="form-text">Seleccione el ambiente de la SET para consultas RUC y facturaci√≥n electr√≥nica</div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Timbrado SET</label>
                        <input type="text" class="form-control" @bind="timbrado" placeholder="Ej: 12345678" />
                        <div class="form-text">N√∫mero de timbrado asignado por la SET para facturaci√≥n electr√≥nica</div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Punto de Expedici√≥n</label>
                        <input type="text" class="form-control" @bind="puntoExpedicion" placeholder="001" maxlength="3" />
                        <div class="form-text">Punto de expedici√≥n (3 d√≠gitos)</div>
                    </div>
                    
                    <button type="button" class="btn btn-primary" @onclick="Guardar" disabled="@saving">
                        @if (saving)
                        {
                            <span class="spinner-border spinner-border-sm me-2"></span>
                            <text>Guardando...</text>
                        }
                        else
                        {
                            <text>Guardar Configuracion</text>
                        }
                    </button>
                    
                    <button type="button" class="btn btn-secondary ms-2" @onclick="ProbarConexion" disabled="@probandoConexion">
                        @if (probandoConexion)
                        {
                            <span class="spinner-border spinner-border-sm me-2"></span>
                            <text>Probando...</text>
                        }
                        else
                        {
                            <text>üîç Probar Conexi√≥n SIFEN</text>
                        }
                    </button>
                    
                    <button type="button" class="btn btn-outline-info ms-2" @onclick="DiagnosticoCompleto" disabled="@diagnosticando">
                        @if (diagnosticando)
                        {
                            <span class="spinner-border spinner-border-sm me-2"></span>
                            <text>Diagnosticando...</text>
                        }
                        else
                        {
                            <text>üîß Diagn√≥stico Completo</text>
                        }
                    </button>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card">
                <div class="card-body">
                    <h6>Informaci√≥n SIFEN</h6>
                    <div class="small">
                        <p><strong>URLs Oficiales:</strong></p>
                        <ul class="mb-2">
                            <li><strong>Pruebas:</strong> sifen-test.set.gov.py</li>
                            <li><strong>Producci√≥n:</strong> sifen.set.gov.py</li>
                        </ul>
                        
                        <p><strong>Endpoints disponibles:</strong></p>
                        <ul class="mb-2">
                            <li>Consulta RUC: <code>/de/ws/consultas/consulta-ruc.wsdl</code></li>
                            <li>Env√≠o DE: <code>/de/ws/sync/recibe-de.wsdl</code></li>
                            <li>Consulta DE: <code>/de/ws/consultas/consulta-de.wsdl</code></li>
                        </ul>
                        
                        <p><strong>Certificados:</strong></p>
                        @if (certificados.Any())
                        {
                            <ul>
                                @foreach (var cert in certificados)
                                {
                                    <li>@System.IO.Path.GetFileName(cert)</li>
                                }
                            </ul>
                        }
                        else
                        {
                            <p class="text-muted">No hay certificados .p12 en /certificados</p>
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>

    @if (!string.IsNullOrEmpty(mensaje))
    {
        <div class="alert @(esError ? "alert-danger" : "alert-success") mt-3">
            @mensaje
        </div>
    }
    
    @if (!string.IsNullOrEmpty(resultadoDiagnostico))
    {
        <div class="card mt-3">
            <div class="card-header">
                <h6>Resultado del Diagn√≥stico</h6>
            </div>
            <div class="card-body">
                <pre class="small" style="max-height: 400px; overflow-y: auto;">@resultadoDiagnostico</pre>
            </div>
        </div>
    }
}

@code {
    private bool loading = true;
    private bool saving = false;
    private bool probandoConexion = false;
    private bool diagnosticando = false;
    private bool sucursalExiste = false;
    private bool esError = false;
    private bool mostrarPassword = false;
    private string mensaje = "";
    private string resultadoDiagnostico = "";
    
    private string nombreSucursal = "Sucursal Principal";
    private string nombreEmpresa = "Mi Empresa";
    private string ruc = "80000000";
    private string certificadoPath = "";
    private string password = "";
    private string ambiente = "test";
    private string timbrado = "";
    private string puntoExpedicion = "001";
    
    private List<string> certificados = new();
    private Sucursal? currentSucursal;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            // Buscar certificados
            var certDir = Path.Combine(Directory.GetCurrentDirectory(), "certificados");
            if (Directory.Exists(certDir))
            {
                certificados = Directory.GetFiles(certDir, "*.p12").ToList();
            }

            // Cargar sucursal
            using var db = await DbFactory.CreateDbContextAsync();
            currentSucursal = await db.Sucursal.FirstOrDefaultAsync();
            
            if (currentSucursal is not null)
            {
                sucursalExiste = true;
                nombreSucursal = currentSucursal.NombreSucursal;
                nombreEmpresa = currentSucursal.NombreEmpresa;
                ruc = currentSucursal.RUC;
                certificadoPath = currentSucursal.CertificadoRuta ?? "";
                password = currentSucursal.CertificadoPassword ?? "";
                ambiente = currentSucursal.Ambiente ?? "test";
                timbrado = currentSucursal.Timbrado ?? "";
                puntoExpedicion = currentSucursal.PuntoExpedicion ?? "001";
            }
        }
        catch (Exception ex)
        {
            mensaje = $"Error: {ex.Message}";
            esError = true;
        }
        finally
        {
            loading = false;
        }
    }

    private async Task Guardar()
    {
        if (string.IsNullOrWhiteSpace(nombreSucursal) || 
            string.IsNullOrWhiteSpace(ruc) ||
            string.IsNullOrWhiteSpace(certificadoPath) ||
            string.IsNullOrWhiteSpace(password) ||
            string.IsNullOrWhiteSpace(puntoExpedicion))
        {
            mensaje = "Complete todos los campos obligatorios (Nombre, RUC, Certificado, Password, Punto Expedici√≥n)";
            esError = true;
            return;
        }

        saving = true;
        mensaje = "";
        
        try
        {
            using var db = await DbFactory.CreateDbContextAsync();
            
            if (currentSucursal is null)
            {
                currentSucursal = new Sucursal
                {
                    NumSucursal = "001",
                    NombreSucursal = nombreSucursal,
                    NombreEmpresa = nombreEmpresa,
                    Direccion = "Asuncion",
                    RUC = ruc,
                    DV = RucHelper.CalcularDvRuc(ruc),
                    CertificadoRuta = certificadoPath,
                    CertificadoPassword = password,
                    Ambiente = ambiente,
                    Timbrado = timbrado,
                    PuntoExpedicion = puntoExpedicion,
                    IdCiudad = 1
                };
                
                db.Sucursal.Add(currentSucursal);
                sucursalExiste = true;
            }
            else
            {
                currentSucursal.NombreSucursal = nombreSucursal;
                currentSucursal.NombreEmpresa = nombreEmpresa;
                currentSucursal.RUC = ruc;
                currentSucursal.DV = RucHelper.CalcularDvRuc(ruc);
                currentSucursal.CertificadoRuta = certificadoPath;
                currentSucursal.CertificadoPassword = password;
                currentSucursal.Ambiente = ambiente;
                currentSucursal.Timbrado = timbrado;
                currentSucursal.PuntoExpedicion = puntoExpedicion;
                
                db.Sucursal.Update(currentSucursal);
            }
            
            await db.SaveChangesAsync();
            
            mensaje = "Configuraci√≥n guardada. DNIT y facturaci√≥n electr√≥nica habilitados.";
            esError = false;
        }
        catch (Exception ex)
        {
            mensaje = $"Error al guardar: {ex.Message}";
            esError = true;
        }
        finally
        {
            saving = false;
        }
    }
    
    private async Task ProbarConexion()
    {
        if (string.IsNullOrWhiteSpace(certificadoPath) || string.IsNullOrWhiteSpace(password))
        {
            mensaje = "Configure el certificado y contrase√±a antes de probar la conexi√≥n";
            esError = true;
            return;
        }

        probandoConexion = true;
        mensaje = "";
        resultadoDiagnostico = "";
        
        try
        {
            Console.WriteLine("[DEBUG] === INICIANDO PRUEBA DE CONEXI√ìN SIFEN ===");
            Console.WriteLine($"[DEBUG] Ambiente: {ambiente}");
            Console.WriteLine($"[DEBUG] Certificado: {certificadoPath}");
            
            // Usar SifenTester con formato XML corregido
            var ambienteCodigo = ambiente == "test" ? "1" : "2";
            var testResult = await SifenTester.TestConnection(ambienteCodigo, certificadoPath, password);
            
            Console.WriteLine($"[DEBUG] Resultado: Success={testResult.Success}, StatusCode={testResult.StatusCode}");
            Console.WriteLine($"[DEBUG] Message: {testResult.Message}");
            Console.WriteLine($"[DEBUG] Response: {testResult.ResponsePreview}");
            
            if (testResult.Success)
            {
                mensaje = $"‚úÖ {testResult.Message}";
                esError = false;
            }
            else
            {
                mensaje = $"‚ùå {testResult.Message}";
                if (!string.IsNullOrEmpty(testResult.Details))
                    mensaje += $"\nDetalles: {testResult.Details}";
                if (testResult.StatusCode > 0)
                    mensaje += $"\nStatus Code: {testResult.StatusCode}";
                esError = true;
            }
        }
        finally
        {
            probandoConexion = false;
        }
    }
    
    private async Task DiagnosticoCompleto()
    {
        diagnosticando = true;
        resultadoDiagnostico = "";
        mensaje = "";
        
        var diagnostico = new StringBuilder();
        diagnostico.AppendLine("=== DIAGN√ìSTICO COMPLETO SIFEN ===");
        diagnostico.AppendLine($"Fecha: {DateTime.Now:yyyy-MM-dd HH:mm:ss}");
        diagnostico.AppendLine();
        
        try
        {
            // 1. Verificar conectividad b√°sica
            diagnostico.AppendLine("1. CONECTIVIDAD B√ÅSICA");
            diagnostico.AppendLine("---------------------");
            
            var testBasico = await SifenTester.TestBasicConnectivity(ambiente == "test" ? "1" : "2");
            diagnostico.AppendLine($"Estado: {(testBasico.Success ? "‚úÖ OK" : "‚ùå ERROR")}");
            diagnostico.AppendLine($"Mensaje: {testBasico.Message}");
            diagnostico.AppendLine($"Detalles: {testBasico.Details}");
            if (testBasico.StatusCode > 0)
                diagnostico.AppendLine($"Status Code: {testBasico.StatusCode}");
            diagnostico.AppendLine();
            
            // 2. Verificar certificado
            diagnostico.AppendLine("2. VERIFICACI√ìN DE CERTIFICADO");
            diagnostico.AppendLine("-----------------------------");
            
            if (string.IsNullOrWhiteSpace(certificadoPath) || string.IsNullOrWhiteSpace(password))
            {
                diagnostico.AppendLine("‚ùå Certificado o contrase√±a no configurados");
            }
            else
            {
                var testCompleto = await SifenTester.TestConnection(ambiente == "test" ? "1" : "2", certificadoPath, password);
                diagnostico.AppendLine($"Estado: {(testCompleto.Success ? "‚úÖ OK" : "‚ùå ERROR")}");
                diagnostico.AppendLine($"Mensaje: {testCompleto.Message}");
                diagnostico.AppendLine($"Detalles: {testCompleto.Details}");
                if (testCompleto.StatusCode > 0)
                    diagnostico.AppendLine($"Status Code: {testCompleto.StatusCode}");
                
                if (!string.IsNullOrEmpty(testCompleto.ResponsePreview))
                {
                    diagnostico.AppendLine("Response Preview:");
                    diagnostico.AppendLine(testCompleto.ResponsePreview);
                }
                
                if (testCompleto.Success)
                {
                    mensaje = "‚úÖ Diagn√≥stico completado: SIFEN est√° operativo";
                    esError = false;
                }
                else
                {
                    mensaje = "‚ùå Problemas detectados en la conexi√≥n SIFEN";
                    esError = true;
                }
            }
            
            diagnostico.AppendLine();
            
            // 3. Informaci√≥n de configuraci√≥n
            diagnostico.AppendLine("3. CONFIGURACI√ìN ACTUAL");
            diagnostico.AppendLine("----------------------");
            var ambienteTexto = ambiente == "test" ? "Pruebas" : "Producci√≥n";
            var urlBase = ambiente == "test" ? "https://sifen-test.set.gov.py" : "https://sifen.set.gov.py";
            var certificadoTexto = string.IsNullOrEmpty(certificadoPath) ? "No configurado" : Path.GetFileName(certificadoPath);
            var timbradoTexto = string.IsNullOrEmpty(timbrado) ? "No configurado" : timbrado;
            
            diagnostico.AppendLine($"Ambiente: {ambienteTexto}");
            diagnostico.AppendLine($"URL Base: {urlBase}");
            diagnostico.AppendLine($"Certificado: {certificadoTexto}");
            diagnostico.AppendLine($"RUC: {ruc}");
            diagnostico.AppendLine($"Timbrado: {timbradoTexto}");
            diagnostico.AppendLine();
            
            // 4. Recomendaciones
            diagnostico.AppendLine("4. RECOMENDACIONES");
            diagnostico.AppendLine("------------------");
            
            if (string.IsNullOrEmpty(certificadoPath))
                diagnostico.AppendLine("‚Ä¢ Configure un certificado .p12 v√°lido");
            if (string.IsNullOrEmpty(password))
                diagnostico.AppendLine("‚Ä¢ Configure la contrase√±a del certificado");
            if (string.IsNullOrEmpty(timbrado))
                diagnostico.AppendLine("‚Ä¢ Configure el n√∫mero de timbrado para facturaci√≥n electr√≥nica");
            
            diagnostico.AppendLine("‚Ä¢ Verifique que el certificado est√© vigente");
            diagnostico.AppendLine("‚Ä¢ Confirme que el RUC corresponda al certificado");
            diagnostico.AppendLine("‚Ä¢ En caso de problemas, contacte al soporte t√©cnico de la SET");
            
            resultadoDiagnostico = diagnostico.ToString();
        }
        catch (Exception ex)
        {
            diagnostico.AppendLine($"ERROR durante el diagn√≥stico: {ex.Message}");
            resultadoDiagnostico = diagnostico.ToString();
            mensaje = "‚ùå Error durante el diagn√≥stico";
            esError = true;
        }
        finally
        {
            diagnosticando = false;
        }
    }
    
    private void TogglePasswordVisibility()
    {
        mostrarPassword = !mostrarPassword;
    }
}
