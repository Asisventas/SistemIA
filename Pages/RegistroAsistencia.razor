@page "/registro-asistencia"
@using Microsoft.EntityFrameworkCore
@using FaceRecognitionDotNet
@using System.IO
@using System.Drawing
@using SistemIA.Models
@using SistemIA.Services
@inject IDbContextFactory<SistemIA.Models.AppDbContext> DbFactory
@inject NavigationManager Navigation
@inject IJSRuntime JS
@inject AsistenciaCalculatorService AsistenciaCalculator
@implements IDisposable

<PageProtection Modulo="/personal" Permiso="VIEW">

<PageTitle>Registro de Asistencia</PageTitle>

<h3>Registro de Asistencia</h3>

<!-- RECONOCIMIENTO FACIAL -->
<div class="card mb-4">
    <div class="card-header">Registrar por Reconocimiento Facial</div>
    <div class="card-body text-center">
        <div class="mb-3 mx-auto" style="max-width: 400px;">
            <label for="sucursalReconocimiento" class="form-label"><b>Sucursal Actual:</b></label>
            <InputSelect id="sucursalReconocimiento" class="form-select form-select-lg" @bind-Value="sucursalSeleccionadaId" TValue="int">
                <option value="0">-- Seleccione una Sucursal --</option>
                @foreach (var suc in sucursales)
                {
                    <option value="@suc.Id">@suc.NombreSucursal</option>
                }
            </InputSelect>
        </div>
        <div class="mb-3">
            <video id="videoElement" style="max-width: 100%; border: 1px solid #ccc;"></video>
            <canvas id="canvasElement" class="d-none"></canvas>
        </div>
        @if (!string.IsNullOrEmpty(reconocimientoStatusMessage))
        {
            <div class="alert @(reconocimientoExitoso ? "alert-success" : "alert-danger")" role="alert">
                @((MarkupString)reconocimientoStatusMessage.Replace(Environment.NewLine, "<br />"))
            </div>
        }
        <div class="d-grid gap-2 col-6 mx-auto">
            <button class="btn btn-success btn-lg" @onclick="ReconocerYMarcarAsistencia" disabled="@isProcessing">
                @if (isProcessing)
                {
                    <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                    <span> Procesando...</span>
                }
                else
                {
                    <span><i class="bi bi-person-bounding-box"></i> Reconocer y Marcar Asistencia</span>
                }
            </button>
        </div>
    </div>
</div>

<!-- REGISTRO MANUAL -->
<div class="card mb-4">
    <div class="card-header">Registrar Nueva Asistencia Manualmente</div>
    <div class="card-body">
        <EditForm Model="nuevaAsistencia" OnValidSubmit="GuardarAsistencia">
            <DataAnnotationsValidator />
            <ValidationSummary />
            <div class="mb-3">
                <label class="form-label">Usuario:</label>
                <InputSelect class="form-select" @bind-Value="nuevaAsistencia.Id_Usuario" TValue="int">
                    <option value="0">-- Seleccionar --</option>
                    @foreach (var u in usuarios)
                    {
                        <option value="@u.Id_Usu">@u.Nombres @u.Apellidos</option>
                    }
                </InputSelect>
            </div>
            <div class="mb-3">
                <label class="form-label">Sucursal:</label>
                <InputSelect class="form-select" @bind-Value="nuevaAsistencia.Sucursal" TValue="int">
                    <option value="0">-- Seleccionar --</option>
                    @foreach (var s in sucursales)
                    {
                        <option value="@s.Id">@s.NombreSucursal</option>
                    }
                </InputSelect>
            </div>
            <div class="mb-3">
                <label class="form-label">Tipo:</label>
                <InputSelect class="form-select" @bind-Value="nuevaAsistencia.TipoRegistro" TValue="string">
                    <option value="">-- Seleccionar --</option>
                    <option value="Entrada">Entrada</option>
                    <option value="Salida">Salida</option>
                    <option value="InicioBreak">Inicio Break</option>
                    <option value="FinBreak">Fin Break</option>
                </InputSelect>
            </div>
            <div class="mb-3">
                <label class="form-label">Notas:</label>
                <InputTextArea class="form-control" @bind-Value="nuevaAsistencia.Notas" />
            </div>
            <button type="submit" class="btn btn-primary">Guardar Asistencia</button>
        </EditForm>
    </div>
</div>

<!-- FILTRO Y EXPORTACIÓN -->
<div class="row mb-3">
    <div class="col-md-3">
        <label class="form-label">Filtrar por Usuario:</label>
        <InputSelect class="form-select" @bind-Value="FiltroUsuarioId" TValue="int">
            <option value="0">Todos</option>
            @foreach (var u in usuarios)
            {
                <option value="@u.Id_Usu">@u.Nombres @u.Apellidos</option>
            }
        </InputSelect>
    </div>
    <div class="col-md-3">
        <label class="form-label">Desde:</label>
        <InputDate class="form-control" @bind-Value="fechaDesde" />
    </div>
    <div class="col-md-3">
        <label class="form-label">Hasta:</label>
        <InputDate class="form-control" @bind-Value="fechaHasta" />
    </div>
    <div class="col-md-3 d-flex align-items-end gap-2">
        <button class="btn btn-outline-primary" @onclick="ImprimirAsistencias"><i class="bi bi-printer"></i> Imprimir</button>
        <button class="btn btn-outline-success" @onclick="ExportarExcel"><i class="bi bi-file-earmark-excel"></i> Excel</button>
        <button class="btn btn-outline-danger" @onclick="ExportarPdf"><i class="bi bi-file-earmark-pdf"></i> PDF</button>
    </div>
</div>

<!-- HISTORIAL -->
<h4>Historial de Asistencias</h4>
@if (asistencias == null)
{
    <p><em>Cargando...</em></p>
}
else if (!asistenciasFiltradas.Any())
{
    <p>No hay registros para mostrar.</p>
}
else
{
    <table class="table table-striped table-hover" id="tablaAsistencias">
        <thead class="table-dark">
            <tr>
                <th>Usuario</th>
                <th>Sucursal</th>
                <th>Fecha/Hora</th>
                <th>Tipo</th>
                <th>Estado</th>
                <th>Tiempo</th>
                <th>Método</th>
                <th>Notas</th>
                <th>Acciones</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var asis in asistenciasFiltradas)
            {
                <tr class="@GetRowClassByString(asis.EstadoPuntualidad)">
                    <td>
                        <div class="d-flex align-items-center">
                            @if (!string.IsNullOrEmpty(asis.MetodoRegistro))
                            {
                                <i class="fas fa-user-check me-2"></i>
                            }
                            <span>@(asis.Usuario?.Nombres) @(asis.Usuario?.Apellidos)</span>
                        </div>
                    </td>
                    <td>@(asis.SucursalNavigation?.NombreSucursal)</td>
                    <td>
                        <div>
                            <strong>@asis.FechaHora.ToString("dd/MM/yyyy")</strong><br>
                            <small class="text-muted">@asis.FechaHora.ToString("HH:mm:ss")</small>
                        </div>
                    </td>
                    <td>
                        <span class="badge @GetTipoClass(asis.TipoRegistro)">
                            @asis.TipoRegistro
                        </span>
                    </td>
                    <td>
                        @if (!string.IsNullOrEmpty(asis.EstadoPuntualidad))
                        {
                            <span class="@GetEstadoClassByString(asis.EstadoPuntualidad)">
                                @asis.EstadoPuntualidad
                            </span>
                            @if (asis.DiferenciaMinutos.HasValue && asis.DiferenciaMinutos.Value != 0)
                            {
                                <br><small class="text-warning">
                                    @GetDiferenciaText(asis)
                                </small>
                            }
                        }
                    </td>
                    <td>
                        @if (asis.HoraProgramada.HasValue)
                        {
                            <small class="text-muted">
                                Prog: @asis.HoraProgramada.Value.ToString("HH:mm")<br>
                                @if (asis.TiempoTrabajadoMinutos.HasValue)
                                {
                                    <span>Trabajado: @FormatMinutos(asis.TiempoTrabajadoMinutos.Value)</span>
                                }
                                @if (asis.HorasExtraMinutos.HasValue && asis.HorasExtraMinutos > 0)
                                {
                                    <br><span class="text-warning">Extra: @FormatMinutos(asis.HorasExtraMinutos.Value)</span>
                                }
                            </small>
                        }
                    </td>
                    <td>
                        <small>@(asis.MetodoRegistro ?? "Manual")</small>
                        @if (asis.RequiereJustificacion)
                        {
                            <br><span class="badge bg-warning text-dark">Requiere Justif.</span>
                        }
                    </td>
                    <td>
                        @if (!string.IsNullOrEmpty(asis.Notas))
                        {
                            <span>@asis.Notas</span>
                        }
                        @if (!string.IsNullOrEmpty(asis.ObservacionesSistema))
                        {
                            <br><small class="text-muted">@asis.ObservacionesSistema</small>
                        }
                    </td>
                    <td>
                        <button class="btn btn-sm btn-danger" @onclick="() => EliminarAsistencia(asis.Id_Asistencia)">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                </tr>
            }
        </tbody>
    </table>
}


</PageProtection>

@code {


    private SistemIA.Models.Asistencia nuevaAsistencia = new();
    private List<SistemIA.Models.Asistencia> asistencias = new();
    private List<SistemIA.Models.Asistencia> asistenciasFiltradas = new();
    private List<Usuario> usuarios = new();
    private List<Sucursal> sucursales = new();



    private int _filtroUsuarioId = 0;
    private int FiltroUsuarioId
    {
        get => _filtroUsuarioId;
        set { _filtroUsuarioId = value; FiltrarAsistencias(); }
    }

    private int sucursalSeleccionadaId = 1;

    // Lógica de reconocimiento directamente en la página
    private FaceRecognition? faceRecognition;
    private List<double[]> knownEmbeddings = new();
    private List<int> knownUserIds = new();

    private bool isProcessing = false;
    private string? reconocimientoStatusMessage;
    private bool reconocimientoExitoso = false;
    private const double FACE_RECOGNITION_TOLERANCE = 0.55;

    private DateTime? fechaDesde = null;
    private DateTime? fechaHasta = null;

    protected override async Task OnInitializedAsync()
    {

        await using var Db = await DbFactory.CreateDbContextAsync();
        // Usar ruta relativa al ejecutable para que funcione en cualquier instalación
        var baseDir = AppContext.BaseDirectory;
        var modeloPath = Path.Combine(baseDir, "face_recognition_models");
        if (!Directory.Exists(modeloPath))
            modeloPath = @"C:\asis\SistemIA\face_recognition_models";
        faceRecognition = FaceRecognition.Create(modeloPath);

        sucursales = await Db.Sucursal.OrderBy(s => s.NombreSucursal).ToListAsync();
        usuarios = await Db.Usuarios.OrderBy(u => u.Nombres).ToListAsync();

        await CargarEmbeddingsConocidos();
        await CargarAsistencias();
    }

    private async Task CargarEmbeddingsConocidos()
    {
        knownEmbeddings.Clear();
        knownUserIds.Clear();

        await using var Db = await DbFactory.CreateDbContextAsync();
        // Se consultaban todos los usuarios que tenían un embedding guardado
        var usuariosConEmbedding = await Db.Usuarios
            .Where(u => u.EmbeddingFacial != null && u.EmbeddingFacial.Length > 0)
            .ToListAsync();

        foreach (var user in usuariosConEmbedding)
        {
            var doubleArray = ConvertByteArrayToDoubleArray(user.EmbeddingFacial);
            if (doubleArray.Length > 0)
            {
                knownEmbeddings.Add(doubleArray);
                knownUserIds.Add(user.Id_Usu);
            }
        }
    }

    private async Task IniciarCamara()
    {
        reconocimientoStatusMessage = "Iniciando cámara...";
        await JS.InvokeVoidAsync("startCamera", "videoElement");
    }

    private async Task DetenerCamara()
    {
        await JS.InvokeVoidAsync("stopCamera", "videoElement");
    }

    private async Task ReconocerYMarcarAsistencia()
    {
        if (sucursalSeleccionadaId == 0) { reconocimientoStatusMessage = "Debe seleccionar una sucursal."; return; }

        isProcessing = true;
        reconocimientoExitoso = false;
        await InvokeAsync(StateHasChanged);

        try
        {
            await IniciarCamara();
            await Task.Delay(1500);
            reconocimientoStatusMessage = "Analizando rostro...";
            await InvokeAsync(StateHasChanged);

            string? base64Image = await JS.InvokeAsync<string>("captureFrame", "videoElement", "canvasElement");
            if (string.IsNullOrEmpty(base64Image)) { reconocimientoStatusMessage = "No se pudo capturar la imagen."; return; }

            var imageBytes = Convert.FromBase64String(base64Image.Split(',')[1]);

            await Task.Run(async () =>
            {
                using var ms = new MemoryStream(imageBytes);
                using var bitmap = new Bitmap(ms);
                using var img = FaceRecognition.LoadImage(bitmap);
                var faceLocations = faceRecognition?.FaceLocations(img).ToArray() ?? Array.Empty<Location>();

                if (faceLocations.Length != 1) { await InvokeAsync(() => reconocimientoStatusMessage = "No se detectó un único rostro."); return; }

                var capturedEncodings = faceRecognition?.FaceEncodings(img, faceLocations).ToArray() ?? Array.Empty<FaceEncoding>();
                if (capturedEncodings.Length == 0) { await InvokeAsync(() => reconocimientoStatusMessage = "Error al procesar el rostro."); return; }

                using var capturedEncoding = capturedEncodings[0];
                var capturedVector = capturedEncoding.GetRawEncoding();
                var bestMatchIndex = -1;
                var minDistance = 1.0;
                for (int i = 0; i < knownEmbeddings.Count; i++)
                {
                    var distance = CalculateEuclideanDistance(knownEmbeddings[i], capturedVector);
                    if (distance < minDistance) { minDistance = distance; bestMatchIndex = i; }
                }

                if (bestMatchIndex != -1 && minDistance <= FACE_RECOGNITION_TOLERANCE)
                {
                    var userId = knownUserIds[bestMatchIndex];
                    var usuario = usuarios.FirstOrDefault(u => u.Id_Usu == userId);
                    if (usuario != null)
                    {
                        await InvokeAsync(() => RegistrarAsistenciaAutomatica(usuario));
                        await InvokeAsync(() => { reconocimientoStatusMessage = $"¡Marcación Registrada Correctamente, {usuario.Nombres}!"; reconocimientoExitoso = true; });
                    }
                }
                else
                {
                    await InvokeAsync(() => reconocimientoStatusMessage = $"Usuario no reconocido (Distancia: {minDistance:F2}).");
                }
            });
        }
        catch (Exception ex) { reconocimientoStatusMessage = $"Error: {ex.Message}"; }
        finally
        {
            await Task.Delay(2500);
            await DetenerCamara();
            isProcessing = false;
            await InvokeAsync(StateHasChanged);
        }
    }

    private async Task RegistrarAsistenciaAutomatica(Usuario usuario)
    {
        await using var Db = await DbFactory.CreateDbContextAsync();
        
        // Obtener la caja activa para el turno
        var cajaActiva = await Db.Cajas
            .Where(c => c.CajaActual == 1 && c.IdSucursal == sucursalSeleccionadaId)
            .FirstOrDefaultAsync();
        
        var ultimoRegistro = await Db.Asistencias.Where(a => a.Id_Usuario == usuario.Id_Usu).OrderByDescending(a => a.FechaHora).FirstOrDefaultAsync();
        string tipoRegistro = (ultimoRegistro == null || ultimoRegistro.TipoRegistro == "Salida" || ultimoRegistro.TipoRegistro == "FinBreak") ? "Entrada" : "Salida";

        // Crear registro de asistencia con información básica
        var asistencia = new SistemIA.Models.Asistencia
        {
            Id_Usuario = usuario.Id_Usu,
            FechaHora = DateTime.Now,
            TipoRegistro = tipoRegistro,
            Sucursal = sucursalSeleccionadaId,
            Notas = "Reconocimiento Facial",
            MetodoRegistro = "Facial",
            EsRegistroAutomatico = true,
            UbicacionRegistro = "Terminal Principal",
            Turno = cajaActiva?.TurnoActual,
            IdCaja = cajaActiva?.IdCaja
        };

        // *** NUEVO: Calcular automáticamente todos los campos de control de tiempo ***
        asistencia = await AsistenciaCalculator.CalcularControlTiempo(asistencia);

        Db.Asistencias.Add(asistencia);
        await Db.SaveChangesAsync();

        // Generar mensaje personalizado basado en el estado de puntualidad
        string mensajeDeVoz = GenerarMensajeVoz(usuario, asistencia);
        await JS.InvokeVoidAsync("hablarTexto", mensajeDeVoz);
        await CargarAsistencias();
    }

    private string GenerarMensajeVoz(Usuario usuario, Asistencia asistencia)
    {
        if (asistencia.TipoRegistro == "Entrada")
        {
            return asistencia.EstadoPuntualidad switch
            {
                "Puntual" => $"¡Buenos días, {usuario.Nombres}! Entrada registrada correctamente.",
                "Tardanza" => $"Hola, {usuario.Nombres}. Se registra tardanza de {asistencia.DiferenciaMinutos} minutos.",
                "Adelanto" => $"¡Buenos días, {usuario.Nombres}! Entrada temprana registrada.",
                _ => $"Hola, {usuario.Nombres}. Entrada registrada."
            };
        }
        else
        {
            return asistencia.EstadoPuntualidad switch
            {
                "Puntual" => $"¡Hasta luego, {usuario.Nombres}! Salida registrada correctamente.",
                "SalidaTemprana" => $"Hasta luego, {usuario.Nombres}. Se registra salida temprana de {Math.Abs(asistencia.DiferenciaMinutos ?? 0)} minutos.",
                "TiempoExtra" => $"¡Excelente trabajo, {usuario.Nombres}! Se registra tiempo extra de {asistencia.HorasExtraMinutos} minutos.",
                _ => $"Hasta luego, {usuario.Nombres}. Salida registrada."
            };
        }
    }

    private async Task CargarAsistencias()
    {
        await using var Db = await DbFactory.CreateDbContextAsync();
        // Esta era la consulta lenta que cargaba todo el historial
        asistencias = await Db.Asistencias
            .Include(a => a.Usuario)
            .Include(a => a.SucursalNavigation)
            .OrderByDescending(a => a.FechaHora)
            .ToListAsync();
        FiltrarAsistencias();
    }

    private void FiltrarAsistencias()
    {
        if (FiltroUsuarioId == 0)
        {
            asistenciasFiltradas = asistencias;
        }
        else
        {
            asistenciasFiltradas = asistencias.Where(a => a.Id_Usuario == FiltroUsuarioId).ToList();
        }
        StateHasChanged();
    }

    private async Task GuardarAsistencia()
    {
        await using var Db = await DbFactory.CreateDbContextAsync();
        if (nuevaAsistencia.Id_Usuario == 0 || string.IsNullOrWhiteSpace(nuevaAsistencia.TipoRegistro) || nuevaAsistencia.Sucursal == 0)
        {
            await JS.InvokeVoidAsync("alert", "Debe seleccionar un usuario, sucursal y tipo de registro.");
            return;
        }
        
        // Obtener la caja activa para el turno
        var cajaActiva = await Db.Cajas
            .Where(c => c.CajaActual == 1 && c.IdSucursal == nuevaAsistencia.Sucursal)
            .FirstOrDefaultAsync();
        
        nuevaAsistencia.FechaHora = DateTime.Now;
        nuevaAsistencia.MetodoRegistro = "Manual";
        nuevaAsistencia.EsRegistroAutomatico = false;
        nuevaAsistencia.Turno = cajaActiva?.TurnoActual;
        nuevaAsistencia.IdCaja = cajaActiva?.IdCaja;
        
        // Calcular control de tiempo (puntualidad, etc.)
        nuevaAsistencia = await AsistenciaCalculator.CalcularControlTiempo(nuevaAsistencia);
        
        Db.Asistencias.Add(nuevaAsistencia);
        await Db.SaveChangesAsync();
        nuevaAsistencia = new();
        await CargarAsistencias();
        await JS.InvokeVoidAsync("alert", "Asistencia manual registrada correctamente.");
    }

    private async Task EliminarAsistencia(int id)
    {
        await using var Db = await DbFactory.CreateDbContextAsync();

        bool confirmed = await JS.InvokeAsync<bool>("confirm", "¿Está seguro de que desea eliminar este registro?");
        if (confirmed)
        {
            var asistenciaAEliminar = await Db.Asistencias.FindAsync(id);
            if (asistenciaAEliminar != null)
            {
                Db.Asistencias.Remove(asistenciaAEliminar);
                await Db.SaveChangesAsync();
                await CargarAsistencias();
            }
        }
    }

    private double[] ConvertByteArrayToDoubleArray(byte[] byteArray)
    {
        if (byteArray == null || byteArray.Length % sizeof(double) != 0)
            return Array.Empty<double>();

        var doubleArray = new double[byteArray.Length / sizeof(double)];
        Buffer.BlockCopy(byteArray, 0, doubleArray, 0, doubleArray.Length * sizeof(double));
        return doubleArray;
    }

    private double CalculateEuclideanDistance(double[] vector1, double[] vector2)
    {
        if (vector1.Length != vector2.Length) throw new ArgumentException("Vectores de diferente longitud.");
        double sum = 0;
        for (int i = 0; i < vector1.Length; i++)
        {
            sum += Math.Pow(vector1[i] - vector2[i], 2);
        }
        return Math.Sqrt(sum);
    }

    private IEnumerable<Asistencia> AsistenciasFiltradasExport
    => asistenciasFiltradas
        .Where(a =>
            (!fechaDesde.HasValue || a.FechaHora.Date >= fechaDesde.Value.Date) &&
            (!fechaHasta.HasValue || a.FechaHora.Date <= fechaHasta.Value.Date)
        );

    private async Task ImprimirAsistencias()
    {
        // Prepara los datos como HTML para imprimir
        var html = await JS.InvokeAsync<string>("getAsistenciasHtml", "tablaAsistencias");
        await JS.InvokeVoidAsync("printHtml", html);
    }
    private async Task ExportarExcel()
    {
        var csv = "Usuario,Sucursal,Fecha/Hora,Tipo,Notas\n";
        foreach (var asis in AsistenciasFiltradasExport)
        {
            csv += $"\"{asis.Usuario?.Nombres} {asis.Usuario?.Apellidos}\",\"{asis.SucursalNavigation?.NombreSucursal}\",\"{asis.FechaHora:dd/MM/yyyy HH:mm}\",\"{asis.TipoRegistro}\",\"{asis.Notas}\"\n";
        }
        var bytes = System.Text.Encoding.UTF8.GetBytes(csv);
        var base64 = Convert.ToBase64String(bytes);
        await JS.InvokeVoidAsync("downloadFileFromBase64", "asistencias.csv", base64, "text/csv");
    }
    private async Task ExportarPdf()
    {
        await JS.InvokeVoidAsync("exportAsistenciasToPdf", "tablaAsistencias");
    }
    // Métodos helper para la presentación de datos de asistencia basados en strings
    private string GetRowClassByString(string? estadoPuntualidad)
    {
        if (string.IsNullOrEmpty(estadoPuntualidad)) return "";
        
        return estadoPuntualidad.ToLower() switch
        {
            "puntual" => "table-success",
            "tardanza" => "table-warning",
            "adelanto" => "table-info",
            "ausencia" => "table-danger",
            "salidatemprana" => "table-warning",
            "tiempoextra" => "table-primary",
            "nolaborable" => "table-secondary",
            _ => ""
        };
    }

    private string GetEstadoClassByString(string? estadoPuntualidad)
    {
        if (string.IsNullOrEmpty(estadoPuntualidad)) return "badge bg-secondary";
        
        return estadoPuntualidad.ToLower() switch
        {
            "puntual" => "badge bg-success",
            "tardanza" => "badge bg-warning text-dark",
            "adelanto" => "badge bg-info text-dark",
            "ausencia" => "badge bg-danger",
            "salidatemprana" => "badge bg-warning text-dark",
            "tiempoextra" => "badge bg-primary",
            "nolaborable" => "badge bg-secondary",
            _ => "badge bg-secondary"
        };
    }

    private string GetTipoClass(string tipoRegistro)
    {
        return tipoRegistro switch
        {
            "Entrada" => "badge bg-primary",
            "Salida" => "badge bg-dark",
            _ => "badge bg-secondary"
        };
    }

    private string GetDiferenciaText(Models.Asistencia asistencia)
    {
        if (asistencia.DiferenciaMinutos == null) return "-";
        
        var minutos = asistencia.DiferenciaMinutos.Value;
        var signo = minutos >= 0 ? "+" : "";
        
        if (Math.Abs(minutos) >= 60)
        {
            var horas = Math.Abs(minutos) / 60;
            var minutosRestantes = Math.Abs(minutos) % 60;
            return $"{signo}{(minutos >= 0 ? horas : -horas)}h {minutosRestantes}m";
        }
        else
        {
            return $"{signo}{minutos}m";
        }
    }

    private string FormatTiempo(TimeSpan? tiempo)
    {
        if (tiempo == null) return "-";
        return tiempo.Value.ToString(@"hh\:mm");
    }

    private string FormatMinutos(int minutos)
    {
        if (minutos >= 60)
        {
            var horas = minutos / 60;
            var minutosRestantes = minutos % 60;
            return $"{horas}h {minutosRestantes}m";
        }
        else
        {
            return $"{minutos}m";
        }
    }

    private string GetMetodoClassByString(string? metodoRegistro)
    {
        if (string.IsNullOrEmpty(metodoRegistro)) return "badge bg-secondary";
        
        return metodoRegistro.ToLower() switch
        {
            "facial" => "badge bg-success",
            "manual" => "badge bg-warning text-dark",
            "huella" => "badge bg-info text-dark",
            "tarjeta" => "badge bg-primary",
            "qr" => "badge bg-info",
            "movil" => "badge bg-success",
            "web" => "badge bg-primary",
            "automatico" => "badge bg-secondary",
            _ => "badge bg-secondary"
        };
    }

    private string GetHorasExtraText(Models.Asistencia asistencia)
    {
        if (asistencia.HorasExtraMinutos == null || asistencia.HorasExtraMinutos <= 0) return "-";
        
        var minutos = asistencia.HorasExtraMinutos.Value;
        if (minutos >= 60)
        {
            var horas = minutos / 60;
            var minutosRestantes = minutos % 60;
            return $"{horas}h {minutosRestantes}m";
        }
        else
        {
            return $"{minutos}m";
        }
    }

    public void Dispose()
    {
        _ = DetenerCamara();
        faceRecognition?.Dispose();
    }
}
