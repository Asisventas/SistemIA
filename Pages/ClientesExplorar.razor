@page "/clientes/explorar"
@inject IDbContextFactory<SistemIA.Models.AppDbContext> DbFactory
@inject NavigationManager Nav
@inject IJSRuntime JS
@inject SistemIA.Services.ISucursalProvider SucursalProvider
@inject Microsoft.AspNetCore.Components.Authorization.AuthenticationStateProvider AuthStateProvider
@using Microsoft.EntityFrameworkCore

<PageProtection Modulo="/clientes" Permiso="VIEW">

<h3 class="mb-3">Explorador de Clientes</h3>

<div class="card mb-3">
  <div class="card-body">
    <div class="row g-2">
      <div class="col-md-4"><input class="form-control" placeholder="RUC o Razón Social" @bind="filtroTexto" @bind:event="oninput" @onkeyup="OnKeyUp" /></div>
      <div class="col-md-2">
        <select class="form-select" @bind="filtroEstado" @bind:after="Buscar">
          <option value="">Todos</option>
          <option value="true">Activos</option>
          <option value="false">Inactivos</option>
        </select>
      </div>
      <div class="col-md-3 d-flex gap-2">
        <button class="btn btn-primary" @onclick="Buscar"><i class="bi bi-search"></i> Buscar</button>
        <button class="btn btn-secondary" @onclick="Limpiar">Limpiar</button>
      </div>
      <div class="col-md-3 text-end">
        <a class="btn btn-success" href="/clientes/crear"><i class="bi bi-person-plus"></i> Nuevo</a>
      </div>
    </div>
  </div>
</div>

<div class="card">
  <div class="table-responsive">
    <table class="table table-hover align-middle mb-0">
      <thead class="table-light">
        <tr>
          <th>Razón Social</th>
          <th>RUC</th>
          <th>Contacto</th>
          <th>Teléfono</th>
          <th>Email</th>
          <th class="text-end">Acciones</th>
        </tr>
      </thead>
      <tbody>
        @foreach (var c in clientes)
        {
          <tr>
            <td>@c.RazonSocial</td>
            <td>@c.RucCompleto</td>
            <td>@c.Contacto</td>
            <td>@c.Telefono</td>
            <td>@c.Email</td>
            <td class="text-end">
              <div class="btn-group btn-group-sm">
                <a class="btn btn-outline-primary" title="Editar" href="/clientes/editar/@c.Id"><i class="bi bi-pencil"></i></a>
              </div>
            </td>
          </tr>
        }
      </tbody>
    </table>
  </div>
  @if (!clientes.Any())
  {
    <div class="p-3 text-muted">Sin resultados</div>
  }
</div>

</PageProtection>

@code {
  private string filtroTexto = string.Empty;
  private string? filtroEstado = string.Empty;
  private List<ItemCliente> clientes = new();

  protected override async Task OnInitializedAsync()
  {
    await Buscar();
  }

  private async Task Buscar()
  {
    await using var ctx = await DbFactory.CreateDbContextAsync();
    var q = ctx.Clientes.AsNoTracking()
      .Select(x => new ItemCliente {
        Id = x.IdCliente,
        RazonSocial = x.RazonSocial,
        RUC = x.RUC,
        DV = x.DV,
        Contacto = x.Contacto ?? "",
        Telefono = x.Telefono ?? x.Celular ?? "",
        Email = x.Email ?? "",
        Estado = x.Estado
      });
    if (!string.IsNullOrWhiteSpace(filtroTexto))
      q = q.Where(x => x.RazonSocial.Contains(filtroTexto) || x.RUC.Contains(filtroTexto));
    if (!string.IsNullOrWhiteSpace(filtroEstado) && bool.TryParse(filtroEstado, out var est))
      q = q.Where(x => x.Estado == est);

    clientes = await q.OrderBy(x => x.RazonSocial).Take(500).ToListAsync();
  }

  private async Task OnKeyUp(KeyboardEventArgs e)
  {
    if (e.Key == "Enter") await Buscar();
  }

  private class ItemCliente
  {
    public int Id { get; set; }
    public string RazonSocial { get; set; } = string.Empty;
    public string RUC { get; set; } = string.Empty;
    public int DV { get; set; }
    public string RucCompleto => string.IsNullOrWhiteSpace(RUC) ? "" : $"{RUC}-{DV}";
    public string Contacto { get; set; } = string.Empty;
    public string Telefono { get; set; } = string.Empty;
    public string Email { get; set; } = string.Empty;
    public bool Estado { get; set; }
  }

  private async Task Limpiar()
  {
    filtroTexto = string.Empty;
    filtroEstado = string.Empty;
    await Buscar();
  }
}
