@page "/proveedores/explorar"
@inject IDbContextFactory<SistemIA.Models.AppDbContext> DbFactory
@inject IJSRuntime JS
@inject Microsoft.AspNetCore.Components.Authorization.AuthenticationStateProvider AuthStateProvider
@inject SistemIA.Services.ISucursalProvider SucursalProvider
@inject NavigationManager Nav
@using Microsoft.EntityFrameworkCore

<PageProtection Modulo="/proveedores" Permiso="VIEW">

<h3 class="mb-3">Explorador de Proveedores</h3>

<div class="card mb-3">
  <div class="card-body">
    <div class="row g-2">
      <div class="col-md-6"><input class="form-control" placeholder="RUC o Razón Social" @bind="filtroTexto" @bind:event="oninput" @onkeyup="OnKeyUp" /></div>
      <div class="col-md-3 d-flex gap-2">
        <button class="btn btn-primary" @onclick="Buscar"><i class="bi bi-search"></i> Buscar</button>
        <button class="btn btn-secondary" @onclick="Limpiar">Limpiar</button>
      </div>
      <div class="col-md-3 text-end">
        <a class="btn btn-success" href="/proveedores/sifen/crear"><i class="bi bi-building-fill-add"></i> Nuevo</a>
      </div>
    </div>
  </div>
</div>

<div class="card">
  <div class="table-responsive">
    <table class="table table-hover align-middle mb-0">
      <thead class="table-light">
        <tr>
          <th>Razón Social</th>
          <th>RUC</th>
          <th>Teléfono</th>
          <th>Email</th>
          <th class="text-end">Acciones</th>
        </tr>
      </thead>
      <tbody>
        @foreach (var p in proveedores)
        {
          <tr>
            <td>@p.Nombre</td>
            <td>@p.RucCompleto</td>
            <td>@p.Telefono</td>
            <td>@p.Correo</td>
            <td class="text-end">
              <div class="btn-group btn-group-sm">
                <a class="btn btn-outline-primary" title="Editar" href="/proveedores/sifen/editar/@p.Id"><i class="bi bi-pencil"></i></a>
              </div>
            </td>
          </tr>
        }
      </tbody>
    </table>
  </div>
  @if (!proveedores.Any())
  {
    <div class="p-3 text-muted">Sin resultados</div>
  }
</div>

</PageProtection>

@code {
  private string filtroTexto = string.Empty;
  private List<ItemProveedor> proveedores = new();

  protected override async Task OnInitializedAsync()
  {
    await Buscar();
  }

  private async Task Buscar()
  {
    await using var ctx = await DbFactory.CreateDbContextAsync();
    var q = ctx.ProveedoresSifen.AsNoTracking()
      .Select(x => new ItemProveedor {
        Id = x.IdProveedor,
        Nombre = x.RazonSocial,
        RUC = x.RUC,
        DV = x.DV,
        Telefono = x.Telefono ?? "",
        Correo = x.Email ?? ""
      });
    if (!string.IsNullOrWhiteSpace(filtroTexto))
      q = q.Where(x => x.Nombre.Contains(filtroTexto) || x.RUC.Contains(filtroTexto));

    proveedores = await q.OrderBy(x => x.Nombre).Take(500).ToListAsync();
  }

  private async Task OnKeyUp(KeyboardEventArgs e)
  {
    if (e.Key == "Enter") await Buscar();
  }

  private class ItemProveedor
  {
    public int Id { get; set; }
    public string Nombre { get; set; } = string.Empty;
    public string RUC { get; set; } = string.Empty;
    public int DV { get; set; }
    public string RucCompleto => string.IsNullOrWhiteSpace(RUC) ? "" : $"{RUC}-{DV}";
    public string Telefono { get; set; } = string.Empty;
    public string Correo { get; set; } = string.Empty;
  }

  private async Task Limpiar()
  {
    filtroTexto = string.Empty;
    await Buscar();
  }
}
