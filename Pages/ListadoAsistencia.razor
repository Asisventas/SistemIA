@page "/listado-asistencia"
@inject IDbContextFactory<SistemIA.Models.AppDbContext> DbFactory
@inject IJSRuntime JSRuntime
@using Microsoft.EntityFrameworkCore

<PageProtection Modulo="/reportes" Permiso="VIEW">


<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2 class="text-primary">
                    <i class="bi bi-list-ul me-2"></i>
                    Listado de Asistencias
                </h2>
                <small class="text-muted">@DateTime.Now.ToString("dd/MM/yyyy")</small>
            </div>

            @if (!string.IsNullOrEmpty(errorMessage))
            {
                <div class="alert alert-danger" role="alert">
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    @errorMessage
                </div>
            }

            <!-- Filtros -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">Filtros de Búsqueda</h5>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-3">
                            <label class="form-label">Fecha Desde</label>
                            <input type="date" class="form-control" @bind="fechaDesde" />
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Fecha Hasta</label>
                            <input type="date" class="form-control" @bind="fechaHasta" />
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Usuario</label>
                            <select class="form-select" @bind="usuarioSeleccionado">
                                <option value="">Todos los usuarios</option>
                                @foreach (var usuario in usuarios)
                                {
                                    <option value="@usuario.Id_Usu">@usuario.Nombres @usuario.Apellidos</option>
                                }
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Sucursal</label>
                            <select class="form-select" @bind="sucursalSeleccionada">
                                <option value="">Todas las sucursales</option>
                                @foreach (var sucursal in sucursales)
                                {
                                    <option value="@sucursal.Id">@sucursal.NombreSucursal</option>
                                }
                            </select>
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-12">
                            <button class="btn btn-primary me-2" @onclick="FiltrarAsistencias">
                                <i class="bi bi-search me-2"></i>Buscar
                            </button>
                            <button class="btn btn-secondary me-2" @onclick="LimpiarFiltros">
                                <i class="bi bi-x-circle me-2"></i>Limpiar
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tabla de resultados -->
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Registros de Asistencia</h5>
                    <span class="badge bg-primary">@asistenciasFiltradas.Count registros</span>
                </div>
                <div class="card-body p-0">
                    @if (cargando)
                    {
                        <div class="text-center p-4">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Cargando...</span>
                            </div>
                            <p class="mt-2">Cargando registros...</p>
                        </div>
                    }
                    else if (asistenciasFiltradas.Any())
                    {
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead class="table-dark">
                                    <tr>
                                        <th>Fecha y Hora</th>
                                        <th>Usuario</th>
                                        <th>Tipo</th>
                                        <th>Sucursal</th>
                                        <th>Observaciones</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var asistencia in asistenciasFiltradas.Take(100))
                                    {
                                        <tr>
                                            <td>
                                                <span class="fw-bold">@asistencia.FechaHora.ToString("dd/MM/yyyy")</span><br>
                                                <small class="text-muted">@asistencia.FechaHora.ToString("HH:mm:ss")</small>
                                            </td>
                                            <td>
                                                <span class="fw-bold">@(asistencia.Usuario?.Nombres ?? "") @(asistencia.Usuario?.Apellidos ?? "")</span><br>
                                                <small class="text-muted">@(asistencia.Usuario?.Correo ?? "")</small>
                                            </td>
                                            <td>
                                                @if (asistencia.TipoRegistro == "Entrada")
                                                {
                                                    <span class="badge bg-success">
                                                        <i class="bi bi-box-arrow-in-right me-1"></i>Entrada
                                                    </span>
                                                }
                                                else
                                                {
                                                    <span class="badge bg-danger">
                                                        <i class="bi bi-box-arrow-right me-1"></i>Salida
                                                    </span>
                                                }
                                            </td>
                                            <td>@sucursales.FirstOrDefault(s => s.Id == asistencia.Sucursal)?.NombreSucursal</td>
                                            <td>
                                                @if (!string.IsNullOrEmpty(asistencia.ObservacionesSistema))
                                                {
                                                    <small>@asistencia.ObservacionesSistema</small>
                                                }
                                                else
                                                {
                                                    <small class="text-muted">Sin observaciones</small>
                                                }
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                        @if (asistenciasFiltradas.Count > 100)
                        {
                            <div class="alert alert-info m-3">
                                <i class="bi bi-info-circle me-2"></i>
                                Mostrando los primeros 100 registros de @asistenciasFiltradas.Count total. Use filtros para refinar la búsqueda.
                            </div>
                        }
                    }
                    else
                    {
                        <div class="text-center p-4">
                            <i class="bi bi-inbox display-1 text-muted"></i>
                            <h5 class="mt-3">No se encontraron registros</h5>
                            <p class="text-muted">Ajuste los filtros de búsqueda para encontrar registros de asistencia.</p>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

</PageProtection>

@code {
    private List<Asistencia> todasLasAsistencias = new();
    private List<Asistencia> asistenciasFiltradas = new();
    private List<Usuario> usuarios = new();
    private List<Sucursal> sucursales = new();
    private bool cargando = true;
    private string? errorMessage;

    // Filtros
    private DateTime fechaDesde = DateTime.Today.AddDays(-30);
    private DateTime fechaHasta = DateTime.Today;
    private string usuarioSeleccionado = "";
    private string sucursalSeleccionada = "";

    protected override async Task OnInitializedAsync()
    {
        await CargarDatos();
    }

    private async Task CargarDatos()
    {
        try
        {
            cargando = true;
            await using var context = await DbFactory.CreateDbContextAsync();

            // Cargar datos para filtros
            usuarios = await context.Usuarios.OrderBy(u => u.Nombres).ToListAsync();
            sucursales = await context.Sucursal.OrderBy(s => s.NombreSucursal).ToListAsync();

            // Cargar asistencias con datos relacionados - CORREGIDO: usar SucursalNavigation
            todasLasAsistencias = await context.Asistencias
                .Include(a => a.Usuario)
                .Include(a => a.SucursalNavigation)
                .OrderByDescending(a => a.FechaHora)
                .ToListAsync();

            await FiltrarAsistencias();
        }
        catch (Exception ex)
        {
            errorMessage = $"Error al cargar datos: {ex.Message}";
            Console.WriteLine($"Error al cargar datos: {ex.Message}");
        }
        finally
        {
            cargando = false;
        }
    }

    private Task FiltrarAsistencias()
    {
        try
        {
            asistenciasFiltradas = todasLasAsistencias.Where(a =>
                a.FechaHora.Date >= fechaDesde.Date &&
                a.FechaHora.Date <= fechaHasta.Date &&
                (string.IsNullOrEmpty(usuarioSeleccionado) || a.Id_Usuario.ToString() == usuarioSeleccionado) &&
                (string.IsNullOrEmpty(sucursalSeleccionada) || a.Sucursal.ToString() == sucursalSeleccionada)
            ).ToList();

            StateHasChanged();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error al filtrar: {ex.Message}");
        }
        return Task.CompletedTask;
    }

    private async Task LimpiarFiltros()
    {
        fechaDesde = DateTime.Today.AddDays(-30);
        fechaHasta = DateTime.Today;
        usuarioSeleccionado = "";
        sucursalSeleccionada = "";
        await FiltrarAsistencias();
    }
}
