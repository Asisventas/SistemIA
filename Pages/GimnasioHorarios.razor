@page "/gimnasio/horarios"
@using SistemIA.Models
@using SistemIA.Models.Gimnasio
@using Microsoft.EntityFrameworkCore
@inject AppDbContext _db
@inject NavigationManager Nav

<PageTitle>Horarios de Clases - Gimnasio</PageTitle>

<div class="container-fluid py-3">
    <!-- Encabezado -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h3 class="mb-0">
            <i class="bi bi-calendar-week text-primary me-2"></i>
            Horarios de Clases
        </h3>
        <div class="d-flex gap-2">
            <select class="form-select" style="width: 200px" @bind="_filtroClase" @bind:after="FiltrarHorarios">
                <option value="0">Todas las clases</option>
                @foreach (var clase in _clases)
                {
                    <option value="@clase.IdClase">@clase.Nombre</option>
                }
            </select>
            <button class="btn btn-primary" @onclick="NuevoHorario">
                <i class="bi bi-plus-lg me-1"></i>Nuevo Horario
            </button>
        </div>
    </div>

    <!-- Vista de calendario semanal -->
    <div class="card shadow-sm mb-4">
        <div class="card-header bg-light d-flex justify-content-between align-items-center">
            <h6 class="mb-0"><i class="bi bi-calendar3 me-2"></i>Horario Semanal</h6>
            <div class="d-flex gap-2">
                <button class="btn btn-outline-secondary btn-sm" @onclick="SemanaAnterior">
                    <i class="bi bi-chevron-left"></i>
                </button>
                <span class="align-self-center px-3">
                    <strong>@_inicioSemana.ToString("dd MMM") - @_inicioSemana.AddDays(6).ToString("dd MMM yyyy")</strong>
                </span>
                <button class="btn btn-outline-secondary btn-sm" @onclick="SemanaSiguiente">
                    <i class="bi bi-chevron-right"></i>
                </button>
                <button class="btn btn-outline-primary btn-sm ms-2" @onclick="IrAHoy">Hoy</button>
            </div>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-bordered mb-0" style="table-layout: fixed;">
                    <thead class="table-light">
                        <tr>
                            <th style="width: 60px" class="text-center">Hora</th>
                            @for (int d = 0; d < 7; d++)
                            {
                                var fecha = _inicioSemana.AddDays(d);
                                var esHoy = fecha.Date == DateTime.Today;
                                <th class="text-center @(esHoy ? "bg-primary-subtle" : "")" style="width: calc((100% - 60px) / 7)">
                                    <div>@ObtenerNombreDia(d)</div>
                                    <small class="@(esHoy ? "fw-bold" : "text-muted")">@fecha.ToString("dd/MM")</small>
                                </th>
                            }
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var hora in _horasDelDia)
                        {
                            <tr style="height: 60px;">
                                <td class="text-center align-middle small text-muted bg-light">
                                    @hora.ToString(@"hh\:mm")
                                </td>
                                @for (int d = 0; d < 7; d++)
                                {
                                    var fecha = _inicioSemana.AddDays(d);
                                    var claseEnHora = ObtenerClaseEnHorario(d, hora, fecha);
                                    var esHoy = fecha.Date == DateTime.Today;
                                    
                                    <td class="p-1 @(esHoy ? "bg-primary-subtle" : "")" 
                                        style="vertical-align: top; cursor: pointer;"
                                        @onclick="() => ClickCelda(d, hora)">
                                        @if (claseEnHora != null)
                                        {
                                            <div class="p-1 rounded text-white small" 
                                                 style="background-color: @(claseEnHora.Clase?.ColorHex ?? "#3498db"); cursor: pointer;"
                                                 @onclick="() => EditarHorario(claseEnHora)" @onclick:stopPropagation="true">
                                                <div class="fw-bold text-truncate">@claseEnHora.Clase?.Nombre</div>
                                                <div class="opacity-75">
                                                    @claseEnHora.HoraInicio.ToString(@"hh\:mm")-@claseEnHora.HoraFin.ToString(@"hh\:mm")
                                                </div>
                                                @if (claseEnHora.Instructor != null || claseEnHora.Clase?.Instructor != null)
                                                {
                                                    <div class="opacity-75 text-truncate">
                                                        <i class="bi bi-person-badge"></i>
                                                        @(claseEnHora.Instructor?.NombreCompleto ?? claseEnHora.Clase?.Instructor?.NombreCompleto)
                                                    </div>
                                                }
                                                @if (claseEnHora.Cancelado)
                                                {
                                                    <span class="badge bg-danger">Cancelado</span>
                                                }
                                            </div>
                                        }
                                    </td>
                                }
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Lista de horarios -->
    <div class="card shadow-sm">
        <div class="card-header bg-light">
            <h6 class="mb-0"><i class="bi bi-list-ul me-2"></i>Lista de Horarios</h6>
        </div>
        <div class="table-responsive">
            <table class="table table-hover align-middle mb-0">
                <thead class="table-light">
                    <tr>
                        <th>Clase</th>
                        <th>Tipo</th>
                        <th>Día/Fecha</th>
                        <th>Horario</th>
                        <th>Instructor</th>
                        <th>Sala</th>
                        <th>Capacidad</th>
                        <th>Estado</th>
                        <th class="text-center">Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var h in _horariosFiltrados)
                    {
                        <tr class="@(h.Cancelado ? "table-danger" : "")">
                            <td>
                                <div class="d-flex align-items-center gap-2">
                                    <div class="rounded-circle" style="width: 12px; height: 12px; background-color: @(h.Clase?.ColorHex ?? "#ccc")"></div>
                                    <span>@h.Clase?.Nombre</span>
                                </div>
                            </td>
                            <td>
                                @if (h.TipoHorario == "Recurrente")
                                {
                                    <span class="badge bg-primary">Recurrente</span>
                                }
                                else
                                {
                                    <span class="badge bg-info">Único</span>
                                }
                            </td>
                            <td>
                                @if (h.TipoHorario == "Recurrente")
                                {
                                    <span>@h.NombreDia</span>
                                }
                                else
                                {
                                    <span>@h.FechaEspecifica?.ToString("dd/MM/yyyy")</span>
                                }
                            </td>
                            <td>@h.HorarioFormateado</td>
                            <td>@(h.Instructor?.NombreCompleto ?? h.Clase?.Instructor?.NombreCompleto ?? "-")</td>
                            <td>@(h.Sala ?? h.Clase?.Sala ?? "-")</td>
                            <td>@h.CapacidadEfectiva</td>
                            <td>
                                @if (h.Cancelado)
                                {
                                    <span class="badge bg-danger">Cancelado</span>
                                }
                                else if (h.Activo)
                                {
                                    <span class="badge bg-success">Activo</span>
                                }
                                else
                                {
                                    <span class="badge bg-secondary">Inactivo</span>
                                }
                            </td>
                            <td class="text-center">
                                <div class="btn-group btn-group-sm">
                                    <button class="btn btn-outline-primary" title="Editar" @onclick="() => EditarHorario(h)">
                                        <i class="bi bi-pencil"></i>
                                    </button>
                                    @if (!h.Cancelado)
                                    {
                                        <button class="btn btn-outline-warning" title="Cancelar" @onclick="() => CancelarHorario(h)">
                                            <i class="bi bi-x-circle"></i>
                                        </button>
                                    }
                                    <button class="btn btn-outline-danger" title="Eliminar" @onclick="() => ConfirmarEliminar(h)">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
        @if (!_horariosFiltrados.Any())
        {
            <div class="text-center py-4 text-muted">
                <i class="bi bi-calendar-x display-4"></i>
                <p class="mt-2">No hay horarios configurados</p>
            </div>
        }
    </div>
</div>

<!-- Modal Edición Horario -->
@if (_mostrarModal)
{
    <div class="modal fade show d-block" tabindex="-1" style="background: rgba(0,0,0,0.5)">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">
                        <i class="bi bi-calendar-plus me-2"></i>
                        @(_horarioEdit.IdHorario == 0 ? "Nuevo Horario" : "Editar Horario")
                    </h5>
                    <button type="button" class="btn-close btn-close-white" @onclick="CerrarModal"></button>
                </div>
                <div class="modal-body">
                    <div class="row g-3">
                        <!-- Clase -->
                        <div class="col-md-6">
                            <label class="form-label">Clase *</label>
                            <select class="form-select" @bind="_horarioEdit.IdClase">
                                <option value="0">Seleccionar clase...</option>
                                @foreach (var c in _clases)
                                {
                                    <option value="@c.IdClase">@c.Nombre (@c.DuracionMinutos min)</option>
                                }
                            </select>
                        </div>

                        <!-- Tipo de Horario -->
                        <div class="col-md-6">
                            <label class="form-label">Tipo de Horario *</label>
                            <select class="form-select" @bind="_horarioEdit.TipoHorario">
                                <option value="Recurrente">Recurrente (semanal)</option>
                                <option value="Único">Fecha específica</option>
                            </select>
                        </div>

                        @if (_horarioEdit.TipoHorario == "Recurrente")
                        {
                            <!-- Día de la semana -->
                            <div class="col-md-4">
                                <label class="form-label">Día de la Semana *</label>
                                <select class="form-select" @bind="_horarioEdit.DiaSemana">
                                    <option value="0">Domingo</option>
                                    <option value="1">Lunes</option>
                                    <option value="2">Martes</option>
                                    <option value="3">Miércoles</option>
                                    <option value="4">Jueves</option>
                                    <option value="5">Viernes</option>
                                    <option value="6">Sábado</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Vigencia Desde</label>
                                <input type="date" class="form-control" @bind="_horarioEdit.FechaInicioRecurrencia" />
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Vigencia Hasta</label>
                                <input type="date" class="form-control" @bind="_horarioEdit.FechaFinRecurrencia" />
                            </div>
                        }
                        else
                        {
                            <!-- Fecha específica -->
                            <div class="col-md-6">
                                <label class="form-label">Fecha *</label>
                                <input type="date" class="form-control" @bind="_horarioEdit.FechaEspecifica" />
                            </div>
                        }

                        <!-- Hora inicio y fin -->
                        <div class="col-md-4">
                            <label class="form-label">Hora Inicio *</label>
                            <input type="text" class="form-control" placeholder="HH:mm" @bind="_horaInicioStr" />
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Hora Fin *</label>
                            <input type="text" class="form-control" placeholder="HH:mm" @bind="_horaFinStr" />
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Duración (min)</label>
                            <input type="number" class="form-control" @bind="_horarioEdit.DuracionMinutos" />
                        </div>

                        <!-- Instructor -->
                        <div class="col-md-6">
                            <label class="form-label">Instructor (override)</label>
                            <select class="form-select" @bind="_horarioEdit.IdInstructor">
                                <option value="">Usar instructor de la clase</option>
                                @foreach (var i in _instructores)
                                {
                                    <option value="@i.IdInstructor">@i.NombreCompleto</option>
                                }
                            </select>
                        </div>

                        <!-- Capacidad y Sala -->
                        <div class="col-md-3">
                            <label class="form-label">Capacidad</label>
                            <input type="number" class="form-control" @bind="_horarioEdit.CapacidadMaxima" placeholder="Heredar de clase" />
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Sala</label>
                            <input type="text" class="form-control" @bind="_horarioEdit.Sala" placeholder="Heredar" />
                        </div>

                        <!-- Estado -->
                        <div class="col-md-6">
                            <div class="form-check form-switch mt-4">
                                <input class="form-check-input" type="checkbox" @bind="_horarioEdit.Activo" id="chkActivo" />
                                <label class="form-check-label" for="chkActivo">Horario activo</label>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-outline-secondary" @onclick="CerrarModal">Cancelar</button>
                    <button class="btn btn-primary" @onclick="GuardarHorario">
                        <i class="bi bi-check-lg me-1"></i>Guardar
                    </button>
                </div>
            </div>
        </div>
    </div>
}

<!-- Modal Cancelar Horario -->
@if (_mostrarCancelar)
{
    <div class="modal fade show d-block" tabindex="-1" style="background: rgba(0,0,0,0.5)">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-warning">
                    <h5 class="modal-title"><i class="bi bi-x-circle me-2"></i>Cancelar Horario</h5>
                    <button type="button" class="btn-close" @onclick="() => _mostrarCancelar = false"></button>
                </div>
                <div class="modal-body">
                    <p>¿Desea cancelar este horario?</p>
                    <div class="mb-3">
                        <label class="form-label">Motivo de cancelación</label>
                        <textarea class="form-control" rows="2" @bind="_motivoCancelacion" placeholder="Ej: Instructor enfermo, mantenimiento..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-outline-secondary" @onclick="() => _mostrarCancelar = false">Volver</button>
                    <button class="btn btn-warning" @onclick="ConfirmarCancelacion">
                        <i class="bi bi-x-circle me-1"></i>Cancelar Horario
                    </button>
                </div>
            </div>
        </div>
    </div>
}

<!-- Modal Confirmar Eliminar -->
@if (_mostrarConfirmarEliminar)
{
    <div class="modal fade show d-block" tabindex="-1" style="background: rgba(0,0,0,0.5)">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title"><i class="bi bi-exclamation-triangle me-2"></i>Confirmar Eliminación</h5>
                    <button type="button" class="btn-close btn-close-white" @onclick="() => _mostrarConfirmarEliminar = false"></button>
                </div>
                <div class="modal-body">
                    <p>¿Está seguro de eliminar este horario?</p>
                    <p class="text-muted small">Las reservas asociadas también serán eliminadas.</p>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-outline-secondary" @onclick="() => _mostrarConfirmarEliminar = false">Cancelar</button>
                    <button class="btn btn-danger" @onclick="EliminarHorario">
                        <i class="bi bi-trash me-1"></i>Eliminar
                    </button>
                </div>
            </div>
        </div>
    </div>
}

@code {
    [SupplyParameterFromQuery] public int? clase { get; set; }

    private List<HorarioClase> _horarios = new();
    private List<HorarioClase> _horariosFiltrados = new();
    private List<ClaseGimnasio> _clases = new();
    private List<Instructor> _instructores = new();
    private int _filtroClase = 0;
    private int _idSucursal = 1;
    private DateTime _inicioSemana;
    private List<TimeSpan> _horasDelDia = new();

    // Modal
    private bool _mostrarModal = false;
    private HorarioClase _horarioEdit = new();
    private string _horaInicioStr = "07:00";
    private string _horaFinStr = "08:00";

    // Cancelar
    private bool _mostrarCancelar = false;
    private HorarioClase? _horarioCancelar;
    private string _motivoCancelacion = "";

    // Eliminar
    private bool _mostrarConfirmarEliminar = false;
    private HorarioClase? _horarioEliminar;

    protected override async Task OnInitializedAsync()
    {
        // Calcular inicio de semana (lunes)
        var hoy = DateTime.Today;
        int diff = ((int)hoy.DayOfWeek - 1 + 7) % 7;
        _inicioSemana = hoy.AddDays(-diff);

        // Generar horas del día (6:00 a 22:00)
        for (int h = 6; h <= 22; h++)
        {
            _horasDelDia.Add(TimeSpan.FromHours(h));
        }

        if (clase.HasValue)
        {
            _filtroClase = clase.Value;
        }

        await CargarDatos();
    }

    private async Task CargarDatos()
    {
        _clases = await _db.ClasesGimnasio
            .Where(c => c.IdSucursal == _idSucursal || c.IdSucursal == null)
            .OrderBy(c => c.Nombre)
            .ToListAsync();

        _instructores = await _db.Instructores
            .Where(i => (i.IdSucursal == _idSucursal || i.IdSucursal == null) && i.Activo)
            .OrderBy(i => i.NombreCompleto)
            .ToListAsync();

        _horarios = await _db.HorariosClases
            .Include(h => h.Clase)
            .Include(h => h.Instructor)
            .Where(h => h.Clase!.IdSucursal == _idSucursal || h.Clase.IdSucursal == null)
            .OrderBy(h => h.DiaSemana).ThenBy(h => h.HoraInicio)
            .ToListAsync();

        FiltrarHorarios();
    }

    private void FiltrarHorarios()
    {
        _horariosFiltrados = _filtroClase == 0
            ? _horarios.ToList()
            : _horarios.Where(h => h.IdClase == _filtroClase).ToList();
    }

    private string ObtenerNombreDia(int d)
    {
        var dias = new[] { "Lun", "Mar", "Mié", "Jue", "Vie", "Sáb", "Dom" };
        return dias[d];
    }

    private HorarioClase? ObtenerClaseEnHorario(int diaSemana, TimeSpan hora, DateTime fecha)
    {
        // diaSemana: 0=Lun, 1=Mar, ... , 6=Dom
        // DayOfWeek: 0=Dom, 1=Lun, ...
        int dayOfWeek = (diaSemana + 1) % 7; // Convertir a DayOfWeek

        return _horarios.FirstOrDefault(h =>
        {
            // Verificar si corresponde a este día
            if (h.TipoHorario == "Recurrente")
            {
                if (h.DiaSemana != dayOfWeek) return false;
                if (h.FechaInicioRecurrencia.HasValue && fecha < h.FechaInicioRecurrencia.Value) return false;
                if (h.FechaFinRecurrencia.HasValue && fecha > h.FechaFinRecurrencia.Value) return false;
            }
            else
            {
                if (h.FechaEspecifica?.Date != fecha.Date) return false;
            }

            // Verificar hora
            return h.HoraInicio <= hora && hora < h.HoraFin;
        });
    }

    private void SemanaAnterior()
    {
        _inicioSemana = _inicioSemana.AddDays(-7);
    }

    private void SemanaSiguiente()
    {
        _inicioSemana = _inicioSemana.AddDays(7);
    }

    private void IrAHoy()
    {
        var hoy = DateTime.Today;
        int diff = ((int)hoy.DayOfWeek - 1 + 7) % 7;
        _inicioSemana = hoy.AddDays(-diff);
    }

    private void ClickCelda(int diaSemana, TimeSpan hora)
    {
        // Crear nuevo horario con día y hora preseleccionados
        int dayOfWeek = (diaSemana + 1) % 7;
        _horarioEdit = new HorarioClase
        {
            TipoHorario = "Recurrente",
            DiaSemana = dayOfWeek,
            Activo = true,
            DuracionMinutos = 60
        };
        _horaInicioStr = hora.ToString(@"hh\:mm");
        _horaFinStr = hora.Add(TimeSpan.FromHours(1)).ToString(@"hh\:mm");
        _mostrarModal = true;
    }

    private void NuevoHorario()
    {
        _horarioEdit = new HorarioClase
        {
            TipoHorario = "Recurrente",
            DiaSemana = 1, // Lunes
            Activo = true,
            DuracionMinutos = 60
        };
        if (_filtroClase > 0)
        {
            _horarioEdit.IdClase = _filtroClase;
        }
        _horaInicioStr = "07:00";
        _horaFinStr = "08:00";
        _mostrarModal = true;
    }

    private void EditarHorario(HorarioClase h)
    {
        _horarioEdit = new HorarioClase
        {
            IdHorario = h.IdHorario,
            IdClase = h.IdClase,
            IdInstructor = h.IdInstructor,
            TipoHorario = h.TipoHorario,
            DiaSemana = h.DiaSemana,
            FechaInicioRecurrencia = h.FechaInicioRecurrencia,
            FechaFinRecurrencia = h.FechaFinRecurrencia,
            FechaEspecifica = h.FechaEspecifica,
            HoraInicio = h.HoraInicio,
            HoraFin = h.HoraFin,
            DuracionMinutos = h.DuracionMinutos,
            CapacidadMaxima = h.CapacidadMaxima,
            Sala = h.Sala,
            Activo = h.Activo,
            FechaCreacion = h.FechaCreacion
        };
        _horaInicioStr = h.HoraInicio.ToString(@"hh\:mm");
        _horaFinStr = h.HoraFin.ToString(@"hh\:mm");
        _mostrarModal = true;
    }

    private async Task GuardarHorario()
    {
        if (_horarioEdit.IdClase == 0) return;

        // Parsear horas
        if (TimeSpan.TryParse(_horaInicioStr, out var hi))
            _horarioEdit.HoraInicio = hi;
        if (TimeSpan.TryParse(_horaFinStr, out var hf))
            _horarioEdit.HoraFin = hf;

        // Calcular duración
        _horarioEdit.DuracionMinutos = (int)(_horarioEdit.HoraFin - _horarioEdit.HoraInicio).TotalMinutes;

        if (_horarioEdit.IdHorario == 0)
        {
            _horarioEdit.FechaCreacion = DateTime.Now;
            _db.HorariosClases.Add(_horarioEdit);
        }
        else
        {
            var existente = await _db.HorariosClases.FindAsync(_horarioEdit.IdHorario);
            if (existente != null)
            {
                existente.IdClase = _horarioEdit.IdClase;
                existente.IdInstructor = _horarioEdit.IdInstructor;
                existente.TipoHorario = _horarioEdit.TipoHorario;
                existente.DiaSemana = _horarioEdit.DiaSemana;
                existente.FechaInicioRecurrencia = _horarioEdit.FechaInicioRecurrencia;
                existente.FechaFinRecurrencia = _horarioEdit.FechaFinRecurrencia;
                existente.FechaEspecifica = _horarioEdit.FechaEspecifica;
                existente.HoraInicio = _horarioEdit.HoraInicio;
                existente.HoraFin = _horarioEdit.HoraFin;
                existente.DuracionMinutos = _horarioEdit.DuracionMinutos;
                existente.CapacidadMaxima = _horarioEdit.CapacidadMaxima;
                existente.Sala = _horarioEdit.Sala;
                existente.Activo = _horarioEdit.Activo;
                existente.FechaModificacion = DateTime.Now;
            }
        }

        await _db.SaveChangesAsync();
        await CargarDatos();
        CerrarModal();
    }

    private void CancelarHorario(HorarioClase h)
    {
        _horarioCancelar = h;
        _motivoCancelacion = "";
        _mostrarCancelar = true;
    }

    private async Task ConfirmarCancelacion()
    {
        if (_horarioCancelar != null)
        {
            var h = await _db.HorariosClases.FindAsync(_horarioCancelar.IdHorario);
            if (h != null)
            {
                h.Cancelado = true;
                h.MotivoCancelacion = _motivoCancelacion;
                h.FechaModificacion = DateTime.Now;
                await _db.SaveChangesAsync();
                await CargarDatos();
            }
        }
        _mostrarCancelar = false;
    }

    private void ConfirmarEliminar(HorarioClase h)
    {
        _horarioEliminar = h;
        _mostrarConfirmarEliminar = true;
    }

    private async Task EliminarHorario()
    {
        if (_horarioEliminar != null)
        {
            // Eliminar reservas asociadas
            var reservas = await _db.ReservasClases.Where(r => r.IdHorario == _horarioEliminar.IdHorario).ToListAsync();
            _db.ReservasClases.RemoveRange(reservas);

            _db.HorariosClases.Remove(_horarioEliminar);
            await _db.SaveChangesAsync();
            await CargarDatos();
        }
        _mostrarConfirmarEliminar = false;
    }

    private void CerrarModal()
    {
        _mostrarModal = false;
        _horarioEdit = new();
    }

    private void OnHoraInicioChange(ChangeEventArgs e)
    {
        _horaInicioStr = e.Value?.ToString() ?? "07:00";
    }

    private void OnHoraFinChange(ChangeEventArgs e)
    {
        _horaFinStr = e.Value?.ToString() ?? "08:00";
    }
}
