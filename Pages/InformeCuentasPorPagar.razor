@page "/informes/cuentas-por-pagar"
@inject IDbContextFactory<SistemIA.Models.AppDbContext> DbFactory
@inject IJSRuntime JS
@inject Microsoft.AspNetCore.Components.Authorization.AuthenticationStateProvider AuthStateProvider
@inject SistemIA.Services.ISucursalProvider SucursalProvider
@inject SistemIA.Services.ICajaProvider CajaProvider
@inject NavigationManager Nav
@using Microsoft.EntityFrameworkCore

<PageProtection Modulo="/informes/cuentas-por-pagar" Permiso="VIEW">

<h3 class="mb-3"><i class="bi bi-file-earmark-text"></i> Listado de Pago a Proveedores</h3>

<div class="card mb-3">
  <div class="card-body">
    <div class="row g-2 align-items-end">
      <div class="col-md-3">
        <label class="form-label small">Desde</label>
        <input type="date" class="form-control" @bind="filtroDesde" />
      </div>
      <div class="col-md-3">
        <label class="form-label small">Hasta</label>
        <input type="date" class="form-control" @bind="filtroHasta" />
      </div>
      <div class="col-md-3">
        <label class="form-label small">Proveedor</label>
        <input class="form-control" placeholder="RUC o Razón Social" @bind="filtroTexto" @bind:event="oninput" @onkeyup="OnKeyUp" />
      </div>
      <div class="col-md-3">
        <label class="form-label small">Estado</label>
        <select class="form-select" @bind="filtroEstado" @bind:after="Buscar">
          <option value="">Todos</option>
          <option value="Abierta">Pendiente</option>
          <option value="Pagada">Pagada</option>
          <option value="Vencida">Vencida</option>
        </select>
      </div>
    </div>
    <div class="row g-2 mt-2">
      <div class="col-12 d-flex gap-2 justify-content-end">
        <button class="btn btn-primary" @onclick="Buscar"><i class="bi bi-search"></i> Buscar</button>
        <button class="btn btn-secondary" @onclick="Limpiar">Limpiar</button>
        <button class="btn btn-outline-secondary" title="Imprimir" @onclick="Imprimir"><i class="bi bi-printer"></i> Imprimir</button>
        <button class="btn btn-outline-success" title="Exportar a Excel" @onclick="Exportar"><i class="bi bi-file-earmark-excel"></i> Exportar</button>
        <EnviarInformeCorreo 
          TituloInforme="Cuentas por Pagar" 
          OnGenerarHtml="GenerarTablaHtml" 
          FiltrosAplicados="@ObtenerFiltrosTexto()" />
      </div>
    </div>
  </div>
</div>

<!-- Resumen de totales -->
@if (items.Any())
{
  <div class="row mb-3">
    <div class="col-md-3">
      <div class="card bg-primary text-white">
        <div class="card-body py-2">
          <div class="small">Total Deuda</div>
          <div class="h5 mb-0">@totalDeuda.ToString("N0") Gs</div>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card bg-danger text-white">
        <div class="card-body py-2">
          <div class="small">Total Vencido</div>
          <div class="h5 mb-0">@totalVencido.ToString("N0") Gs</div>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card bg-warning text-dark">
        <div class="card-body py-2">
          <div class="small">Por Vencer (7 días)</div>
          <div class="h5 mb-0">@totalPorVencer.ToString("N0") Gs</div>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card bg-success text-white">
        <div class="card-body py-2">
          <div class="small">Al Día</div>
          <div class="h5 mb-0">@totalAlDia.ToString("N0") Gs</div>
        </div>
      </div>
    </div>
  </div>
}

<div class="card">
  <div class="table-responsive">
    <table class="table table-hover align-middle mb-0">
      <thead class="table-light">
        <tr>
          <th>#</th>
          <th>Proveedor</th>
          <th>RUC</th>
          <th>Compra</th>
          <th>Fecha Crédito</th>
          @if (filtroEstado != "Pagada")
          {
            <th>Vencimiento</th>
          }
          @if (filtroEstado == "Pagada")
          {
            <th>Fecha Pago</th>
          }
          <th class="text-end">Monto Total</th>
          <th class="text-end">Saldo Pendiente</th>
          <th class="text-center">Cuotas</th>
          <th class="text-center">Estado</th>
        </tr>
      </thead>
      <tbody>
        @{ int fila = 0; }
        @foreach (var item in items)
        {
          fila++;
          var diasVencido = (DateTime.Today - (item.FechaVencimiento ?? DateTime.Today)).Days;
          var claseVencimiento = diasVencido > 0 ? "text-danger fw-bold" : (diasVencido >= -7 ? "text-warning" : "");
          <tr>
            <td class="text-muted">@fila</td>
            <td>@item.ProveedorNombre</td>
            <td>@item.ProveedorRuc</td>
            <td>
              <small class="text-muted">@item.NumeroCompra</small>
            </td>
            <td>@item.FechaCredito.ToString("dd/MM/yyyy")</td>
            @if (filtroEstado != "Pagada")
            {
              <td class="@claseVencimiento">
                @(item.FechaVencimiento?.ToString("dd/MM/yyyy") ?? "-")
                @if (diasVencido > 0)
                {
                  <br /><small class="text-danger">(@diasVencido días vencido)</small>
                }
              </td>
            }
            @if (filtroEstado == "Pagada")
            {
              <td>@(item.FechaPago?.ToString("dd/MM/yyyy") ?? "-")</td>
            }
            <td class="text-end">@item.MontoTotal.ToString("N0")</td>
            <td class="text-end fw-bold">@item.SaldoPendiente.ToString("N0")</td>
            <td class="text-center">@item.NumeroCuotas</td>
            <td class="text-center">
              @if (item.Estado == "Abierta" && diasVencido > 0)
              {
                <span class="badge bg-danger">Vencida</span>
              }
              else if (item.Estado == "Abierta")
              {
                <span class="badge bg-warning text-dark">Pendiente</span>
              }
              else if (item.Estado == "Pagada")
              {
                <span class="badge bg-success">Pagada</span>
              }
              else
              {
                <span class="badge bg-secondary">@item.Estado</span>
              }
            </td>
          </tr>
        }
      </tbody>
    </table>
  </div>
  @if (!items.Any())
  {
    <div class="p-3 text-muted">Sin resultados</div>
  }
  else
  {
    <div class="card-footer d-flex justify-content-between">
      <span class="text-muted small">Mostrando @items.Count registros</span>
      <span class="fw-bold">Total Saldo Pendiente: @items.Sum(x => x.SaldoPendiente).ToString("N0") Gs</span>
    </div>
  }
</div>

</PageProtection>

@code {
  private DateTime filtroDesde = DateTime.Today.AddMonths(-3);
  private DateTime filtroHasta = DateTime.Today.AddMonths(3);
  private string filtroTexto = string.Empty;
  private string filtroEstado = ""; // Todos por defecto
  private List<ItemCuentaPorPagar> items = new();

  private decimal totalDeuda => items.Sum(x => x.SaldoPendiente);
  private decimal totalVencido => items.Where(x => x.FechaVencimiento.HasValue && x.FechaVencimiento.Value.Date < DateTime.Today && x.Estado == "Abierta").Sum(x => x.SaldoPendiente);
  private decimal totalPorVencer => items.Where(x => x.FechaVencimiento.HasValue && x.FechaVencimiento.Value.Date >= DateTime.Today && x.FechaVencimiento.Value.Date <= DateTime.Today.AddDays(7) && x.Estado == "Abierta").Sum(x => x.SaldoPendiente);
  private decimal totalAlDia => items.Where(x => x.FechaVencimiento.HasValue && x.FechaVencimiento.Value.Date > DateTime.Today.AddDays(7) && x.Estado == "Abierta").Sum(x => x.SaldoPendiente);

  protected override async Task OnInitializedAsync()
  {
    // Usar fecha de caja si está disponible
    await using var ctx = await DbFactory.CreateDbContextAsync();
    var cajaId = CajaProvider.GetCajaId();
    if (cajaId.HasValue)
    {
      var caja = await ctx.Cajas.AsNoTracking().FirstOrDefaultAsync(c => c.IdCaja == cajaId.Value);
      if (caja?.FechaActualCaja != null)
      {
        filtroDesde = caja.FechaActualCaja.Value.Date;
        filtroHasta = caja.FechaActualCaja.Value.Date;
      }
    }
    await Buscar();
  }

  private async Task Buscar()
  {
    items.Clear();
    await using var ctx = await DbFactory.CreateDbContextAsync();
    var texto = filtroTexto?.Trim().ToLower() ?? "";

    // Si filtro es "Pagada" o "Todos" → cargar de PagosProveedores
    if (string.IsNullOrEmpty(filtroEstado) || filtroEstado == "Pagada")
    {
      var queryPagos = ctx.PagosProveedores.AsNoTracking()
                          .Include(p => p.Proveedor)
                          .Include(p => p.Compra)
                          .Where(p => p.FechaPago >= filtroDesde && p.FechaPago <= filtroHasta)
                          .AsQueryable();

      // Filtro de texto
      if (!string.IsNullOrWhiteSpace(texto))
      {
        queryPagos = queryPagos.Where(p => 
          (p.Proveedor != null && p.Proveedor.RazonSocial.ToLower().Contains(texto)) ||
          (p.Proveedor != null && p.Proveedor.RUC.ToLower().Contains(texto)) ||
          (p.Compra != null && p.Compra.NumeroFactura != null && p.Compra.NumeroFactura.Contains(texto)));
      }

      var pagos = await queryPagos.OrderByDescending(p => p.FechaPago).Take(300).ToListAsync();
      
      foreach (var p in pagos)
      {
        items.Add(new ItemCuentaPorPagar
        {
          IdCuentaPorPagar = p.IdPagoProveedor,
          IdCompra = p.IdCompra,
          NumeroCompra = p.Compra != null 
            ? $"{p.Compra.Establecimiento}-{p.Compra.PuntoExpedicion}-{p.Compra.NumeroFactura}" 
            : $"Compra #{p.IdCompra}",
          ProveedorNombre = p.Proveedor?.RazonSocial ?? "Sin proveedor",
          ProveedorRuc = p.Proveedor != null ? $"{p.Proveedor.RUC}-{p.Proveedor.DV}" : "",
          FechaCredito = p.FechaPago,
          FechaVencimiento = p.FechaPago, // Pagos no tienen vencimiento
          FechaPago = p.FechaPago,
          MontoTotal = p.MontoTotal,
          SaldoPendiente = 0, // Ya pagado
          NumeroCuotas = 1,
          Estado = "Pagada"
        });
      }
    }

    // Si filtro es "Abierta", "Vencida" o "Todos" → cargar de CuentasPorPagar
    if (string.IsNullOrEmpty(filtroEstado) || filtroEstado == "Abierta" || filtroEstado == "Vencida")
    {
      var queryCuentas = ctx.CuentasPorPagar.AsNoTracking()
                            .Include(c => c.Proveedor)
                            .Include(c => c.Compra)
                               .ThenInclude(cmp => cmp!.Proveedor)
                            .Where(cpp => cpp.FechaCredito >= filtroDesde && cpp.FechaCredito <= filtroHasta)
                            .AsQueryable();

      // Filtro de estado específico
      if (filtroEstado == "Abierta")
      {
        queryCuentas = queryCuentas.Where(x => x.Estado == "Abierta" && (x.FechaVencimiento == null || x.FechaVencimiento >= DateTime.Today));
      }
      else if (filtroEstado == "Vencida")
      {
        queryCuentas = queryCuentas.Where(x => x.Estado == "Abierta" && x.FechaVencimiento != null && x.FechaVencimiento < DateTime.Today);
      }

      // Filtro de texto
      if (!string.IsNullOrWhiteSpace(texto))
      {
        queryCuentas = queryCuentas.Where(cpp => 
          (cpp.Proveedor != null && cpp.Proveedor.RazonSocial.ToLower().Contains(texto)) ||
          (cpp.Proveedor != null && cpp.Proveedor.RUC.ToLower().Contains(texto)) ||
          (cpp.Compra != null && cpp.Compra.Proveedor != null && cpp.Compra.Proveedor.RazonSocial.ToLower().Contains(texto)) ||
          (cpp.Compra != null && cpp.Compra.Proveedor != null && cpp.Compra.Proveedor.RUC.ToLower().Contains(texto)) ||
          (cpp.Compra != null && cpp.Compra.NumeroFactura != null && cpp.Compra.NumeroFactura.Contains(texto)));
      }

      var cuentas = await queryCuentas.OrderBy(x => x.FechaVencimiento).Take(300).ToListAsync();

      foreach (var cpp in cuentas)
      {
        var prov = cpp.Proveedor ?? cpp.Compra?.Proveedor;
        items.Add(new ItemCuentaPorPagar
        {
          IdCuentaPorPagar = cpp.IdCuentaPorPagar,
          IdCompra = cpp.IdCompra,
          NumeroCompra = cpp.Compra != null 
            ? $"{cpp.Compra.Establecimiento}-{cpp.Compra.PuntoExpedicion}-{cpp.Compra.NumeroFactura}" 
            : $"Compra #{cpp.IdCompra}",
          ProveedorNombre = prov?.RazonSocial ?? "Sin proveedor",
          ProveedorRuc = prov != null ? $"{prov.RUC}-{prov.DV}" : "",
          FechaCredito = cpp.FechaCredito,
          FechaVencimiento = cpp.FechaVencimiento,
          MontoTotal = cpp.MontoTotal,
          SaldoPendiente = cpp.SaldoPendiente,
          NumeroCuotas = cpp.NumeroCuotas,
          Estado = cpp.Estado
        });
      }
    }

    // Ordenar resultados combinados
    items = items.OrderByDescending(x => x.FechaCredito).Take(500).ToList();
  }

  private async Task OnKeyUp(KeyboardEventArgs e)
  {
    if (e.Key == "Enter") await Buscar();
  }

  private async Task Limpiar()
  {
    filtroTexto = string.Empty;
    filtroEstado = ""; // Todos
    filtroDesde = DateTime.Today.AddMonths(-3);
    filtroHasta = DateTime.Today.AddMonths(3);
    await Buscar();
  }

  private async Task Imprimir()
  {
    if (!items.Any()) return;

    var head = new System.Text.StringBuilder();
    head.AppendLine("<meta charset=\"utf-8\"/>");
    head.AppendLine("<title>Listado de Pago a Proveedores</title>");
    head.AppendLine("<link rel=\"stylesheet\" href=\"/css/bootstrap/bootstrap.min.css\" />");
    head.AppendLine("<style>");
    head.AppendLine("@media print { @page { size: A4 landscape; margin: 10mm 10mm; } }");
    head.AppendLine("body{font-size:10px;color:#111;}");
    head.AppendLine(".hdr{display:flex;align-items:center;gap:16px;border-bottom:2px solid #222;padding-bottom:8px;margin-bottom:12px;}");
    head.AppendLine(".logo{max-width:100px;max-height:50px;object-fit:contain;display:block;border-radius:6px;border:1px solid #e5e7eb;background:#fff;padding:4px;}");
    head.AppendLine(".tabla th,.tabla td{padding:.3rem;border-bottom:1px solid #e5e7eb;vertical-align:top;}");
    head.AppendLine(".right{text-align:right}");
    head.AppendLine(".muted{color:#666}");
    head.AppendLine(".text-danger{color:#dc3545}");
    head.AppendLine(".text-warning{color:#ffc107}");
    head.AppendLine(".resumen{display:flex;gap:20px;margin-bottom:12px;}");
    head.AppendLine(".resumen-item{padding:8px 16px;border-radius:4px;text-align:center;}");
    head.AppendLine(".resumen-item.total{background:#0d6efd;color:white;}");
    head.AppendLine(".resumen-item.vencido{background:#dc3545;color:white;}");
    head.AppendLine(".resumen-item.porvencer{background:#ffc107;color:#000;}");
    head.AppendLine(".resumen-item.aldia{background:#198754;color:white;}");
    head.AppendLine("</style>");

    await using var ctx = await DbFactory.CreateDbContextAsync();
    var suc = await ctx.Sucursal.AsNoTracking().OrderBy(s => s.Id).FirstOrDefaultAsync();
    var sucIdSel = SucursalProvider.GetSucursalId();
    if (sucIdSel.HasValue)
    {
      var s2 = await ctx.Sucursal.AsNoTracking().FirstOrDefaultAsync(s => s.Id == sucIdSel.Value);
      if (s2 != null) suc = s2;
    }
    string empresa = suc?.NombreEmpresa ?? "Empresa";
    string sucursal = suc?.NombreSucursal ?? "Sucursal";
    string ruc = suc != null ? $"{suc.RUC}-{suc.DV}" : "";
    string? logoDataUri = null;
    if (suc?.Logo != null && suc.Logo.Length > 0) logoDataUri = $"data:image/png;base64,{Convert.ToBase64String(suc.Logo)}";

    var filtros = System.Net.WebUtility.HtmlEncode($"Desde: {filtroDesde:dd/MM/yyyy} | Hasta: {filtroHasta:dd/MM/yyyy} | Estado: {(string.IsNullOrEmpty(filtroEstado) ? "Todos" : filtroEstado)}");

    var sb = new System.Text.StringBuilder();
    sb.AppendLine("<div class=\"container-fluid\">");
    sb.AppendLine("  <div class=\"hdr\">");
    if (!string.IsNullOrEmpty(logoDataUri)) sb.AppendLine($"    <img class=\"logo\" src=\"{logoDataUri}\" alt=\"Logo\"/>");
    sb.AppendLine("    <div>");
    sb.AppendLine($"      <div class=\"h5 mb-0\">{empresa}</div>");
    sb.AppendLine($"      <div class=\"small muted\">RUC: {ruc} • {sucursal}</div>");
    sb.AppendLine("    </div>");
    sb.AppendLine("    <div class=\"ms-auto text-end\">");
    sb.AppendLine("      <div class=\"fw-bold\" style=\"font-size:16px\">Listado de Pago a Proveedores</div>");
    sb.AppendLine($"      <div class=\"small muted\">{filtros}</div>");
    sb.AppendLine($"      <div class=\"small muted\">Fecha: {DateTime.Now:dd/MM/yyyy HH:mm}</div>");
    sb.AppendLine("    </div>");
    sb.AppendLine("  </div>");

    // Resumen
    sb.AppendLine("  <div class=\"resumen\">");
    sb.AppendLine($"    <div class=\"resumen-item total\"><div class=\"small\">Total Deuda</div><div class=\"fw-bold\">{totalDeuda:N0} Gs</div></div>");
    sb.AppendLine($"    <div class=\"resumen-item vencido\"><div class=\"small\">Vencido</div><div class=\"fw-bold\">{totalVencido:N0} Gs</div></div>");
    sb.AppendLine($"    <div class=\"resumen-item porvencer\"><div class=\"small\">Por Vencer</div><div class=\"fw-bold\">{totalPorVencer:N0} Gs</div></div>");
    sb.AppendLine($"    <div class=\"resumen-item aldia\"><div class=\"small\">Al Día</div><div class=\"fw-bold\">{totalAlDia:N0} Gs</div></div>");
    sb.AppendLine("  </div>");

    sb.AppendLine("  <table class=\"table table-sm tabla\">");
    if (filtroEstado == "Pagada")
    {
      sb.AppendLine("    <thead><tr><th>#</th><th>Proveedor</th><th>RUC</th><th>Compra</th><th>Fecha</th><th>Fecha Pago</th><th class=\"right\">Monto</th><th class=\"right\">Saldo</th><th>Cuotas</th><th>Estado</th></tr></thead>");
    }
    else
    {
      sb.AppendLine("    <thead><tr><th>#</th><th>Proveedor</th><th>RUC</th><th>Compra</th><th>Fecha</th><th>Vencimiento</th><th class=\"right\">Monto</th><th class=\"right\">Saldo</th><th>Cuotas</th><th>Estado</th></tr></thead>");
    }
    sb.AppendLine("    <tbody>");
    int n = 0;
    foreach (var item in items)
    {
      var diasVencido = (DateTime.Today - (item.FechaVencimiento ?? DateTime.Today)).Days;
      var claseVenc = diasVencido > 0 ? "text-danger" : (diasVencido >= -7 ? "text-warning" : "");
      var prov = System.Net.WebUtility.HtmlEncode(item.ProveedorNombre);
      var rucProv = System.Net.WebUtility.HtmlEncode(item.ProveedorRuc);
      var estado = item.Estado == "Abierta" && diasVencido > 0 ? "Vencida" : item.Estado;
      if (filtroEstado == "Pagada")
      {
        sb.AppendLine($"      <tr><td>{++n}</td><td>{prov}</td><td>{rucProv}</td><td>{item.NumeroCompra}</td><td>{item.FechaCredito:dd/MM/yyyy}</td><td>{item.FechaPago:dd/MM/yyyy}</td><td class=\"right\">{item.MontoTotal:N0}</td><td class=\"right fw-bold\">{item.SaldoPendiente:N0}</td><td>{item.NumeroCuotas}</td><td>{estado}</td></tr>");
      }
      else
      {
        sb.AppendLine($"      <tr><td>{++n}</td><td>{prov}</td><td>{rucProv}</td><td>{item.NumeroCompra}</td><td>{item.FechaCredito:dd/MM/yyyy}</td><td class=\"{claseVenc}\">{item.FechaVencimiento:dd/MM/yyyy}</td><td class=\"right\">{item.MontoTotal:N0}</td><td class=\"right fw-bold\">{item.SaldoPendiente:N0}</td><td>{item.NumeroCuotas}</td><td>{estado}</td></tr>");
      }
    }
    sb.AppendLine("    </tbody>");
    var colspanSaldo = filtroEstado == "Pagada" ? "7" : "7";
    sb.AppendLine($"    <tfoot><tr><th colspan=\"{colspanSaldo}\"></th><th class=\"right\">{items.Sum(x => x.SaldoPendiente):N0}</th><th colspan=\"2\"></th></tr></tfoot>");
    sb.AppendLine("  </table>");
    sb.AppendLine($"  <div class=\"text-muted small mt-2\">Total: {items.Count} registros</div>");
    sb.AppendLine("</div>");

    await JS.InvokeVoidAsync("printHtmlWithHead", head.ToString(), sb.ToString());
  }

  private async Task Exportar()
  {
    if (!items.Any()) return;
    var sep = ';';
    var sb = new System.Text.StringBuilder();
    var auth = await AuthStateProvider.GetAuthenticationStateAsync();
    var usuario = auth.User?.Identity?.Name ?? "";
    var suc = SucursalProvider.GetSucursalNombre() ?? "";
    sb.AppendLine($"Generado={DateTime.Now:yyyy-MM-dd HH:mm};Usuario={usuario};Sucursal={suc}");
    sb.AppendLine(string.Join(sep, new[] { "Nro", "Proveedor", "RUC", "Compra", "Fecha Crédito", "Vencimiento", "Monto Total", "Saldo Pendiente", "Cuotas", "Estado" }));
    int n = 0;
    foreach (var item in items)
    {
      var diasVencido = (DateTime.Today - (item.FechaVencimiento ?? DateTime.Today)).Days;
      var estado = item.Estado == "Abierta" && diasVencido > 0 ? "Vencida" : item.Estado;
      string[] cols = new[]
      {
        (++n).ToString(),
        item.ProveedorNombre?.Replace("\"", "'") ?? "",
        item.ProveedorRuc,
        item.NumeroCompra,
        item.FechaCredito.ToString("dd/MM/yyyy"),
        item.FechaVencimiento?.ToString("dd/MM/yyyy") ?? "",
        item.MontoTotal.ToString("N0"),
        item.SaldoPendiente.ToString("N0"),
        item.NumeroCuotas.ToString(),
        estado
      };
      var line = string.Join(sep, cols.Select(v => v != null && (v.Contains(sep) || v.Contains('"') || v.Contains('\n')) ? $"\"{v.Replace("\"", "\"\"")}\"" : v));
      sb.AppendLine(line);
    }
    var utf8bom = new System.Text.UTF8Encoding(encoderShouldEmitUTF8Identifier: true);
    var bytes = utf8bom.GetBytes(sb.ToString());
    var b64 = Convert.ToBase64String(bytes);
    var file = $"ProveedoresPendientesPago_{DateTime.Now:yyyyMMdd_HHmmss}.csv";
    await JS.InvokeVoidAsync("downloadFile", b64, file, "text/csv;charset=utf-8");
  }

  private class ItemCuentaPorPagar
  {
    public int IdCuentaPorPagar { get; set; }
    public int IdCompra { get; set; }
    public string NumeroCompra { get; set; } = string.Empty;
    public string ProveedorNombre { get; set; } = string.Empty;
    public string ProveedorRuc { get; set; } = string.Empty;
    public DateTime FechaCredito { get; set; }
    public DateTime? FechaVencimiento { get; set; }
    public DateTime? FechaPago { get; set; }
    public decimal MontoTotal { get; set; }
    public decimal SaldoPendiente { get; set; }
    public int NumeroCuotas { get; set; }
    public string Estado { get; set; } = string.Empty;
  }

  private string ObtenerFiltrosTexto()
  {
    var filtros = new List<string>();
    filtros.Add($"Desde: {filtroDesde:dd/MM/yyyy}");
    filtros.Add($"Hasta: {filtroHasta:dd/MM/yyyy}");
    if (!string.IsNullOrWhiteSpace(filtroTexto)) filtros.Add($"Proveedor: {filtroTexto}");
    if (!string.IsNullOrWhiteSpace(filtroEstado)) filtros.Add($"Estado: {filtroEstado}");
    return string.Join(" | ", filtros);
  }

  private Task<string> GenerarTablaHtml()
  {
    if (!items.Any()) return Task.FromResult("<p>Sin datos para mostrar</p>");
    var sb = new System.Text.StringBuilder();
    // Resumen
    sb.AppendLine("<div style='margin-bottom:15px;'>");
    sb.AppendLine($"<strong>Total Deuda:</strong> {totalDeuda:N0} Gs | <strong>Vencido:</strong> <span style='color:red'>{totalVencido:N0} Gs</span> | <strong>Por Vencer:</strong> <span style='color:orange'>{totalPorVencer:N0} Gs</span> | <strong>Al Día:</strong> <span style='color:green'>{totalAlDia:N0} Gs</span>");
    sb.AppendLine("</div>");
    sb.AppendLine("<table border='1' cellpadding='5' cellspacing='0' style='border-collapse:collapse;width:100%;font-size:12px;'>");
    sb.AppendLine("<thead><tr style='background:#f0f0f0;'><th>#</th><th>Proveedor</th><th>RUC</th><th>Compra</th><th>Fecha</th><th>Vencimiento</th><th style='text-align:right'>Monto</th><th style='text-align:right'>Saldo</th><th>Estado</th></tr></thead>");
    sb.AppendLine("<tbody>");
    int n = 0;
    foreach (var item in items)
    {
      var diasVencido = (DateTime.Today - (item.FechaVencimiento ?? DateTime.Today)).Days;
      var estado = item.Estado == "Abierta" && diasVencido > 0 ? "Vencida" : item.Estado;
      var colorVenc = diasVencido > 0 ? "color:red" : (diasVencido >= -7 ? "color:orange" : "");
      sb.AppendLine($"<tr><td>{++n}</td><td>{System.Net.WebUtility.HtmlEncode(item.ProveedorNombre)}</td><td>{item.ProveedorRuc}</td><td>{item.NumeroCompra}</td><td>{item.FechaCredito:dd/MM/yyyy}</td><td style='{colorVenc}'>{item.FechaVencimiento:dd/MM/yyyy}</td><td style='text-align:right'>{item.MontoTotal:N0}</td><td style='text-align:right;font-weight:bold'>{item.SaldoPendiente:N0}</td><td>{estado}</td></tr>");
    }
    sb.AppendLine("</tbody>");
    sb.AppendLine($"<tfoot><tr style='background:#e0e0e0;font-weight:bold;'><td colspan='7'>Total</td><td style='text-align:right'>{items.Sum(x => x.SaldoPendiente):N0}</td><td></td></tr></tfoot>");
    sb.AppendLine("</table>");
    return Task.FromResult(sb.ToString());
  }
}
