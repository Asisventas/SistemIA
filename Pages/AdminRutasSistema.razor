@page "/admin/rutas-sistema"
@using SistemIA.Services
@inject RutasSistemaService RutasService
@inject NavigationManager Nav
@inject IDbContextFactory<SistemIA.Models.AppDbContext> DbFactory

<PageProtection Modulo="/admin" Permiso="ADMIN">

<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h3 class="mb-0">
            <i class="bi bi-diagram-3 text-primary me-2"></i>
            Mapa de Rutas del Sistema (IA)
        </h3>
        <button class="btn btn-outline-primary" @onclick="ReescanearRutas">
            <i class="bi bi-arrow-clockwise me-1"></i>Reescanear
        </button>
    </div>

    @if (!string.IsNullOrEmpty(_mensaje))
    {
        <div class="alert alert-info alert-dismissible fade show">
            @_mensaje
            <button type="button" class="btn-close" @onclick="() => _mensaje = null"></button>
        </div>
    }

    <!-- Buscador de prueba -->
    <div class="card mb-4 shadow-sm">
        <div class="card-header bg-light">
            <h6 class="mb-0"><i class="bi bi-search me-2"></i>Probar Búsqueda de IA</h6>
        </div>
        <div class="card-body">
            <div class="row g-3">
                <div class="col-md-8">
                    <input type="text" class="form-control" @bind="_consultaPrueba" @bind:event="oninput"
                           placeholder="Escribe una consulta como lo haría un usuario (ej: 'configuración de correos')"/>
                </div>
                <div class="col-md-4">
                    <button class="btn btn-primary w-100" @onclick="ProbarBusqueda">
                        <i class="bi bi-search me-1"></i>Buscar Ruta
                    </button>
                </div>
            </div>
            @if (_resultadoBusqueda != null)
            {
                <div class="mt-3 p-3 border rounded bg-success bg-opacity-10">
                    <h6 class="text-success"><i class="bi bi-check-circle me-1"></i>Resultado:</h6>
                    <p class="mb-1"><strong>Ruta:</strong> @_resultadoBusqueda.Ruta</p>
                    <p class="mb-1"><strong>Título:</strong> @_resultadoBusqueda.Titulo</p>
                    <p class="mb-1"><strong>Categoría:</strong> @_resultadoBusqueda.Categoria</p>
                    <p class="mb-0"><strong>Palabras clave:</strong> @string.Join(", ", _resultadoBusqueda.PalabrasClave.Take(10))</p>
                </div>
            }
            else if (_busquedaRealizada)
            {
                <div class="mt-3 p-3 border rounded bg-warning bg-opacity-10">
                    <h6 class="text-warning"><i class="bi bi-exclamation-triangle me-1"></i>Sin resultados</h6>
                    <p class="mb-0">No se encontró ninguna ruta que coincida con la consulta.</p>
                </div>
            }
        </div>
    </div>

    <!-- Estadísticas -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card text-bg-primary">
                <div class="card-body text-center">
                    <h2 class="mb-0">@_rutas.Count</h2>
                    <small>Total Rutas</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-bg-success">
                <div class="card-body text-center">
                    <h2 class="mb-0">@_rutas.Select(r => r.Categoria).Distinct().Count()</h2>
                    <small>Categorías</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-bg-info">
                <div class="card-body text-center">
                    <h2 class="mb-0">@_rutas.SelectMany(r => r.PalabrasClave).Distinct().Count()</h2>
                    <small>Palabras Clave</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-bg-warning">
                <div class="card-body text-center">
                    <h2 class="mb-0">@_rutas.Count(r => r.Descripcion.Length > 0)</h2>
                    <small>Con Descripción</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Filtro por categoría -->
    <div class="mb-3">
        <label class="form-label small text-muted">Filtrar por Categoría</label>
        <select class="form-select" @bind="_categoriaFiltro">
            <option value="">Todas las categorías</option>
            @foreach (var cat in _rutas.Select(r => r.Categoria).Distinct().OrderBy(c => c))
            {
                <option value="@cat">@cat (@_rutas.Count(r => r.Categoria == cat))</option>
            }
        </select>
    </div>

    <!-- Tabla de rutas -->
    <div class="card shadow-sm">
        <div class="card-header bg-white border-bottom">
            <div class="d-flex justify-content-between align-items-center">
                <h6 class="mb-0"><i class="bi bi-table me-2"></i>Rutas Escaneadas</h6>
                <small class="text-muted">@RutasFiltradas.Count() rutas</small>
            </div>
        </div>
        <div class="table-responsive" style="max-height: 500px; overflow-y: auto;">
            <table class="table table-hover table-sm align-middle mb-0">
                <thead class="table-light sticky-top">
                    <tr>
                        <th style="width: 40px">
                            <i class="bi bi-bookmark"></i>
                        </th>
                        <th>Ruta</th>
                        <th>Título</th>
                        <th>Categoría</th>
                        <th>Palabras Clave</th>
                        <th style="width: 80px">Acción</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var ruta in RutasFiltradas)
                    {
                        <tr>
                            <td>
                                <i class="bi @ruta.Icono text-primary"></i>
                            </td>
                            <td>
                                <code class="small">@ruta.Ruta</code>
                            </td>
                            <td>@ruta.Titulo</td>
                            <td>
                                <span class="badge bg-secondary">@ruta.Categoria</span>
                            </td>
                            <td>
                                <small class="text-muted">
                                    @string.Join(", ", ruta.PalabrasClave.Take(5))
                                    @if (ruta.PalabrasClave.Count > 5)
                                    {
                                        <span class="text-info">+@(ruta.PalabrasClave.Count - 5)</span>
                                    }
                                </small>
                            </td>
                            <td>
                                <button class="btn btn-sm btn-outline-primary" @onclick="() => Nav.NavigateTo(ruta.Ruta)" title="Ir">
                                    <i class="bi bi-box-arrow-up-right"></i>
                                </button>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>

</PageProtection>

@code {
    private List<RutaSistema> _rutas = new();
    private string _categoriaFiltro = "";
    private string? _mensaje;
    private string _consultaPrueba = "";
    private RutaSistema? _resultadoBusqueda;
    private bool _busquedaRealizada = false;

    private IEnumerable<RutaSistema> RutasFiltradas => 
        string.IsNullOrEmpty(_categoriaFiltro) 
            ? _rutas.OrderBy(r => r.Categoria).ThenBy(r => r.Titulo)
            : _rutas.Where(r => r.Categoria == _categoriaFiltro).OrderBy(r => r.Titulo);

    protected override void OnInitialized()
    {
        CargarRutas();
    }

    private void CargarRutas()
    {
        _rutas = RutasService.ObtenerRutas();
        if (!_rutas.Any())
        {
            ReescanearRutas();
        }
    }

    private void ReescanearRutas()
    {
        RutasService.EscanearRutas();
        _rutas = RutasService.ObtenerRutas();
        _mensaje = $"Escaneadas {_rutas.Count} rutas del sistema.";
    }

    private void ProbarBusqueda()
    {
        _busquedaRealizada = true;
        if (string.IsNullOrWhiteSpace(_consultaPrueba))
        {
            _resultadoBusqueda = null;
            return;
        }
        _resultadoBusqueda = RutasService.BuscarMejorRuta(_consultaPrueba);
    }
}
