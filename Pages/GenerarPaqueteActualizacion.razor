@page "/generar-paquete-actualizacion"
@using SistemIA.Services
@inject ActualizacionService ActualizacionService
@inject IJSRuntime JS

<PageTitle>Generar Paquete de Actualización</PageTitle>

<div class="container-fluid py-4">
    <div class="row">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header bg-success text-white">
                    <h4 class="mb-0">
                        <i class="fas fa-box me-2"></i>
                        Generar Paquete de Actualización
                    </h4>
                </div>
                <div class="card-body">
                    
                    @if (!generandoPaquete && resultadoGeneracion == null)
                    {
                        <div class="row">
                            <div class="col-md-8">
                                <div class="alert alert-info">
                                    <i class="fas fa-info-circle me-2"></i>
                                    <strong>Generar Paquete de Actualización</strong><br/>
                                    Esta función compila el proyecto actual y crea un paquete ZIP listo para distribuir a otros servidores.
                                </div>

                                <div class="mb-3">
                                    <label class="form-label fw-bold">
                                        <i class="fas fa-tag me-2"></i>
                                        Versión del Paquete
                                    </label>
                                    <input type="text" class="form-control" @bind="versionPaquete" 
                                           placeholder="ej: 1.2.0" />
                                    <div class="form-text">
                                        Número de versión para identificar este paquete (formato: X.Y.Z)
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label fw-bold">
                                        <i class="fas fa-edit me-2"></i>
                                        Descripción de Cambios
                                    </label>
                                    <textarea class="form-control" rows="8" @bind="descripcionCambios" 
                                              placeholder="Describa los cambios incluidos en esta actualización:&#10;- Nueva característica X&#10;- Corrección de bug Y&#10;- Mejora en módulo Z"></textarea>
                                    <div class="form-text">
                                        Detalle los cambios que se incluyen en esta actualización
                                    </div>
                                </div>

                                <div class="d-flex gap-2">
                                    <button class="btn btn-success btn-lg" 
                                            @onclick="IniciarGeneracionPaquete" 
                                            disabled="@(string.IsNullOrWhiteSpace(versionPaquete) || string.IsNullOrWhiteSpace(descripcionCambios))">
                                        <i class="fas fa-box me-2"></i>
                                        Generar Paquete
                                    </button>
                                    <a href="/actualizacion-sistema" class="btn btn-secondary btn-lg">
                                        <i class="fas fa-arrow-left me-2"></i>
                                        Volver a Actualización
                                    </a>
                                </div>
                            </div>

                            <div class="col-md-4">
                                <div class="card bg-light">
                                    <div class="card-body">
                                        <h6 class="card-title">
                                            <i class="fas fa-cogs me-2"></i>
                                            Proceso de Generación
                                        </h6>
                                        <ol class="mb-0" style="font-size: 0.9rem;">
                                            <li>Verificar migraciones de BD</li>
                                            <li>Limpieza de compilaciones previas</li>
                                            <li>Compilación en modo Release</li>
                                            <li>Publicación self-contained (incluye .NET)</li>
                                            <li>Excluir appsettings.json</li>
                                            <li>Verificación de archivos críticos</li>
                                            <li>Creación del archivo ZIP</li>
                                        </ol>
                                        <div class="alert alert-info mt-3 mb-2" style="font-size: 0.85rem;">
                                            <i class="fas fa-box me-2"></i>
                                            <strong>El paquete incluye:</strong>
                                            <ul class="mb-0 mt-1" style="padding-left: 1.2rem;">
                                                <li>Binarios de la aplicación (~85 MB)</li>
                                                <li>Runtime .NET 8 integrado</li>
                                                <li>Script Actualizar.bat</li>
                                                <li>Migraciones de BD</li>
                                            </ul>
                                        </div>
                                        <div class="alert alert-warning mb-0" style="font-size: 0.85rem;">
                                            <i class="fas fa-shield-alt me-2"></i>
                                            <strong>NO incluye:</strong> appsettings.json<br/>
                                            <small>(preserva la configuración del servidor)</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    }

                    @if (generandoPaquete)
                    {
                        <div class="card border-primary">
                            <div class="card-header bg-primary text-white">
                                <h5 class="mb-0">
                                    <i class="fas fa-cog fa-spin me-2"></i>
                                    Generando Paquete v@versionPaquete...
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="progress mb-3" style="height: 30px;">
                                    <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                         role="progressbar" 
                                         style="width: @(progresoGeneracion)%">
                                        @progresoGeneracion%
                                    </div>
                                </div>

                                <div class="log-container">
                                    @foreach (var log in logsGeneracion)
                                    {
                                        <div class="log-entry">@log</div>
                                    }
                                </div>
                            </div>
                        </div>
                    }

                    @if (resultadoGeneracion != null)
                    {
                        @if (resultadoGeneracion.Exitoso)
                        {
                            <div class="alert alert-success border-success">
                                <h5 class="alert-heading">
                                    <i class="fas fa-check-circle me-2"></i>
                                    ¡Paquete Generado Exitosamente!
                                </h5>
                                <hr/>
                                <div class="row">
                                    <div class="col-md-6">
                                        <p><strong>Archivo:</strong> @resultadoGeneracion.NombreArchivo</p>
                                        <p><strong>Ubicación:</strong><br/><code style="font-size: 0.85rem;">@resultadoGeneracion.RutaZip</code></p>
                                        <p><strong>Tamaño:</strong> @resultadoGeneracion.TamanoMB.ToString("F2") MB</p>
                                        <p><strong>Archivos:</strong> @resultadoGeneracion.TotalArchivos</p>
                                    </div>
                                    <div class="col-md-6">
                                        <p><strong>Hash SHA256:</strong><br/><code style="font-size: 0.65rem; word-break: break-all;">@resultadoGeneracion.HashSHA256</code></p>
                                        <p><strong>Tiempo:</strong> @resultadoGeneracion.TiempoTotal.ToString(@"mm\:ss")</p>
                                    </div>
                                </div>
                                <hr/>
                                <div class="alert alert-info mb-3">
                                    <strong><i class="fas fa-box me-2"></i>Contenido del paquete:</strong>
                                    <ul class="mb-0 mt-2">
                                        <li>✓ Binarios de la aplicación (usa runtime de instalación existente)</li>
                                        <li>✓ Script <strong>Actualizar.bat</strong> para instalación automática</li>
                                        <li>✓ Migraciones de BD (se aplican al iniciar)</li>
                                        <li>✓ <strong>NO incluye</strong> appsettings.json (preserva configuración)</li>
                                    </ul>
                                </div>
                                <div class="alert alert-secondary mb-3">
                                    <strong><i class="fas fa-terminal me-2"></i>Para actualizar un servidor:</strong>
                                    <ol class="mb-0 mt-2">
                                        <li>Copiar el ZIP al servidor destino</li>
                                        <li>Extraer en una carpeta temporal</li>
                                        <li>Ejecutar <code>Actualizar.bat</code> como Administrador</li>
                                    </ol>
                                </div>
                                <p class="mb-0">
                                    <strong>CHANGELOG generado:</strong><br/>
                                    <code style="font-size: 0.85rem;">@resultadoGeneracion.RutaChangelog</code>
                                </p>
                                <div class="mt-3 d-flex gap-2">
                                    <button class="btn btn-primary" @onclick="AbrirCarpetaReleases">
                                        <i class="fas fa-folder-open me-2"></i>
                                        Abrir Carpeta Releases
                                    </button>
                                    <button class="btn btn-secondary" @onclick="GenerarOtroPaquete">
                                        <i class="fas fa-redo me-2"></i>
                                        Generar Otro Paquete
                                    </button>
                                    <a href="/actualizacion-sistema" class="btn btn-outline-secondary">
                                        <i class="fas fa-arrow-left me-2"></i>
                                        Volver
                                    </a>
                                </div>
                            </div>
                        }
                        else
                        {
                            <div class="alert alert-danger border-danger">
                                <h5 class="alert-heading">
                                    <i class="fas fa-times-circle me-2"></i>
                                    Error al Generar Paquete
                                </h5>
                                <p><strong>Error:</strong> @resultadoGeneracion.Error</p>
                                
                                <div class="log-container mt-3">
                                    <strong>Logs:</strong>
                                    @foreach (var log in logsGeneracion)
                                    {
                                        <div class="log-entry">@log</div>
                                    }
                                </div>

                                <div class="mt-3 d-flex gap-2">
                                    <button class="btn btn-warning" @onclick="IntentarNuevamente">
                                        <i class="fas fa-redo me-2"></i>
                                        Intentar Nuevamente
                                    </button>
                                    <a href="/actualizacion-sistema" class="btn btn-secondary">
                                        <i class="fas fa-arrow-left me-2"></i>
                                        Volver
                                    </a>
                                </div>
                            </div>
                        }
                    }

                </div>
            </div>
        </div>
    </div>
</div>

@code {
    private VersionInfo versionActual = new();
    
    private string versionPaquete = "";
    private string descripcionCambios = "";
    private bool generandoPaquete = false;
    private int progresoGeneracion = 0;
    private List<string> logsGeneracion = new();
    private ResultadoGeneracionPaquete? resultadoGeneracion = null;

    protected override void OnInitialized()
    {
        versionActual = ActualizacionService.ObtenerVersionActual();
    }

    private async Task IniciarGeneracionPaquete()
    {
        if (string.IsNullOrWhiteSpace(versionPaquete) || string.IsNullOrWhiteSpace(descripcionCambios))
        {
            await JS.InvokeVoidAsync("alert", "Debe completar versión y descripción de cambios.");
            return;
        }

        var confirmar = await JS.InvokeAsync<bool>("confirm", 
            $"¿Generar paquete de actualización versión {versionPaquete}?\n\n" +
            "Este proceso compilará el proyecto y creará un ZIP listo para distribuir.\n" +
            "Puede tardar varios minutos.");

        if (!confirmar)
            return;

        generandoPaquete = true;
        progresoGeneracion = 0;
        logsGeneracion.Clear();
        resultadoGeneracion = null;
        StateHasChanged();

        var progress = new Progress<string>(mensaje =>
        {
            InvokeAsync(() =>
            {
                logsGeneracion.Add($"[{DateTime.Now:HH:mm:ss}] {mensaje}");
                
                // Actualizar progreso (7 pasos)
                if (mensaje.Contains("[1/7]")) progresoGeneracion = 10;
                else if (mensaje.Contains("[2/7]")) progresoGeneracion = 20;
                else if (mensaje.Contains("[3/7]")) progresoGeneracion = 35;
                else if (mensaje.Contains("[4/7]")) progresoGeneracion = 55;
                else if (mensaje.Contains("[5/7]")) progresoGeneracion = 70;
                else if (mensaje.Contains("[6/7]")) progresoGeneracion = 85;
                else if (mensaje.Contains("[7/7]")) progresoGeneracion = 95;
                else if (mensaje.Contains("exitosamente")) progresoGeneracion = 100;

                StateHasChanged();
            });
        });

        resultadoGeneracion = await ActualizacionService.GenerarPaqueteActualizacion(versionPaquete, descripcionCambios, progress);
        
        generandoPaquete = false;
        progresoGeneracion = 100;
        StateHasChanged();
    }

    private async Task AbrirCarpetaReleases()
    {
        try
        {
            var rutaCarpeta = Path.Combine(versionActual.RutaAplicacion, "Releases");
            if (Directory.Exists(rutaCarpeta))
            {
                System.Diagnostics.Process.Start("explorer.exe", rutaCarpeta);
            }
            else
            {
                await JS.InvokeVoidAsync("alert", "La carpeta Releases no existe.");
            }
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("alert", $"Error al abrir carpeta: {ex.Message}");
        }
    }

    private void GenerarOtroPaquete()
    {
        resultadoGeneracion = null;
        versionPaquete = "";
        descripcionCambios = "";
        logsGeneracion.Clear();
        progresoGeneracion = 0;
        StateHasChanged();
    }

    private void IntentarNuevamente()
    {
        resultadoGeneracion = null;
        generandoPaquete = false;
        logsGeneracion.Clear();
        progresoGeneracion = 0;
        StateHasChanged();
    }
}

<style>
    .log-container {
        max-height: 400px;
        overflow-y: auto;
        font-family: 'Courier New', monospace;
        font-size: 0.85rem;
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 4px;
        padding: 1rem;
    }

    .log-entry {
        padding: 2px 0;
        border-bottom: 1px solid #e9ecef;
    }

    .log-entry:last-child {
        border-bottom: none;
    }

    .log-container::-webkit-scrollbar {
        width: 8px;
    }

    .log-container::-webkit-scrollbar-track {
        background: #f1f1f1;
    }

    .log-container::-webkit-scrollbar-thumb {
        background: #888;
        border-radius: 4px;
    }

    .log-container::-webkit-scrollbar-thumb:hover {
        background: #555;
    }
</style>
