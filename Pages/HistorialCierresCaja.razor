@page "/caja/historial-cierres"
@using Microsoft.EntityFrameworkCore
@using SistemIA.Models
@using SistemIA.Models.Enums
@inject IDbContextFactory<AppDbContext> DbFactory
@inject NavigationManager Navigation
@inject IJSRuntime JS
@inject SistemIA.Services.ISucursalProvider SucursalProvider

<PageProtection Modulo="/ventas" Permiso="VIEW">

<h3 class="mb-4"><i class="bi bi-clock-history me-2"></i>Historial de Cierres de Caja</h3>

<div class="card mb-4">
    <div class="card-body">
        <div class="row g-3 align-items-end">
            <div class="col-md-3">
                <label class="form-label">Desde</label>
                <input type="date" class="form-control" @bind="filtroDesde" />
            </div>
            <div class="col-md-3">
                <label class="form-label">Hasta</label>
                <input type="date" class="form-control" @bind="filtroHasta" />
            </div>
            <div class="col-md-2">
                <label class="form-label">Caja</label>
                <select class="form-select" @bind="filtroCaja">
                    <option value="0">Todas</option>
                    @foreach (var c in cajas)
                    {
                        <option value="@c.IdCaja">Caja #@c.IdCaja</option>
                    }
                </select>
            </div>
            <div class="col-auto">
                <button class="btn btn-primary" @onclick="Buscar">
                    <i class="bi bi-search me-1"></i>Buscar
                </button>
            </div>
            <div class="col-auto">
                <button class="btn btn-outline-secondary" @onclick="@(() => Navigation.NavigateTo("/caja/cierre"))">
                    <i class="bi bi-arrow-left me-1"></i>Volver
                </button>
            </div>
        </div>
    </div>
</div>

@if (cargando)
{
    <div class="text-center py-4">
        <div class="spinner-border text-primary"></div>
    </div>
}
else if (cierres.Count == 0)
{
    <div class="alert alert-info">
        <i class="bi bi-info-circle me-2"></i>No se encontraron cierres de caja en el período seleccionado.
    </div>
}
else
{
    <div class="table-responsive">
        <table class="table table-striped table-hover">
            <thead class="table-dark">
                <tr>
                    <th>ID</th>
                    <th>Caja</th>
                    <th>Fecha Caja</th>
                    <th>Turno</th>
                    <th>Fecha/Hora Cierre</th>
                    <th>Usuario</th>
                    <th class="text-end">Esperado</th>
                    <th class="text-end">Entregado</th>
                    <th class="text-end">Diferencia</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var cierre in cierres)
                {
                    <tr>
                        <td><span class="badge bg-secondary">@cierre.IdCierreCaja</span></td>
                        <td>@cierre.IdCaja</td>
                        <td>@cierre.FechaCaja.ToString("dd/MM/yyyy")</td>
                        <td><span class="badge bg-info">@cierre.Turno</span></td>
                        <td>@cierre.FechaCierre.ToString("dd/MM/yyyy HH:mm")</td>
                        <td>@cierre.UsuarioCierre</td>
                        <td class="text-end">@cierre.TotalEsperado.ToString("N0")</td>
                        <td class="text-end">@cierre.TotalEntregado.ToString("N0")</td>
                        <td class="text-end @(cierre.Diferencia < 0 ? "text-danger fw-bold" : cierre.Diferencia > 0 ? "text-success" : "")">
                            @cierre.Diferencia.ToString("N0")
                        </td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary" @onclick="@(() => VerDetalle(cierre))">
                                <i class="bi bi-eye"></i>
                            </button>
                        </td>
                    </tr>
                }
            </tbody>
            <tfoot class="table-secondary">
                <tr class="fw-bold">
                    <td colspan="6">TOTALES</td>
                    <td class="text-end">@cierres.Sum(c => c.TotalEsperado).ToString("N0")</td>
                    <td class="text-end">@cierres.Sum(c => c.TotalEntregado).ToString("N0")</td>
                    <td class="text-end @(cierres.Sum(c => c.Diferencia) < 0 ? "text-danger" : cierres.Sum(c => c.Diferencia) > 0 ? "text-success" : "")">
                        @cierres.Sum(c => c.Diferencia).ToString("N0")
                    </td>
                    <td></td>
                </tr>
            </tfoot>
        </table>
    </div>
}

<!-- Modal Detalle -->
@if (cierreDetalle != null)
{
    <div class="modal fade show d-block" tabindex="-1" style="background-color:rgba(0,0,0,0.5);">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">
                        <i class="bi bi-receipt me-2"></i>
                        Detalle Cierre #@cierreDetalle.IdCierreCaja
                    </h5>
                    <button type="button" class="btn-close btn-close-white" @onclick="CerrarModal"></button>
                </div>
                <div class="modal-body">
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <strong>Fecha Caja:</strong><br />
                            @cierreDetalle.FechaCaja.ToString("dd/MM/yyyy")
                        </div>
                        <div class="col-md-4">
                            <strong>Turno:</strong><br />
                            @cierreDetalle.Turno
                        </div>
                        <div class="col-md-4">
                            <strong>Cerrado por:</strong><br />
                            @cierreDetalle.UsuarioCierre
                        </div>
                    </div>
                    
                    <hr />
                    
                    <h6>Resumen de Operaciones</h6>
                    <div class="row mb-3 text-center">
                        <div class="col-md-3">
                            <div class="card bg-success text-white">
                                <div class="card-body py-2">
                                    <small>Ventas Contado</small>
                                    <div class="fw-bold">@cierreDetalle.TotalVentasContado.ToString("N0")</div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-primary text-white">
                                <div class="card-body py-2">
                                    <small>Ventas Crédito</small>
                                    <div class="fw-bold">@cierreDetalle.TotalVentasCredito.ToString("N0")</div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-info text-white">
                                <div class="card-body py-2">
                                    <small>Cobros</small>
                                    <div class="fw-bold">@cierreDetalle.TotalCobrosCredito.ToString("N0")</div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-danger text-white">
                                <div class="card-body py-2">
                                    <small>Anulaciones</small>
                                    <div class="fw-bold">@cierreDetalle.TotalAnulaciones.ToString("N0")</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    @if (cierreDetalle.CantNotasCredito > 0 || cierreDetalle.CantComprasEfectivo > 0 || cierreDetalle.CantNotasCreditoCompras > 0)
                    {
                        <div class="row mb-3 text-center">
                            @if (cierreDetalle.CantNotasCredito > 0)
                            {
                                <div class="col-md-3">
                                    <div class="card border-warning">
                                        <div class="card-body py-2">
                                            <small class="text-warning">NC Ventas (@cierreDetalle.CantNotasCredito)</small>
                                            <div class="fw-bold text-warning">-@cierreDetalle.TotalNotasCredito.ToString("N0")</div>
                                        </div>
                                    </div>
                                </div>
                            }
                            @if (cierreDetalle.CantComprasEfectivo > 0)
                            {
                                <div class="col-md-3">
                                    <div class="card border-danger">
                                        <div class="card-body py-2">
                                            <small class="text-danger">Compras Efect. (@cierreDetalle.CantComprasEfectivo)</small>
                                            <div class="fw-bold text-danger">-@cierreDetalle.TotalComprasEfectivo.ToString("N0")</div>
                                        </div>
                                    </div>
                                </div>
                            }
                            @if (cierreDetalle.CantNotasCreditoCompras > 0)
                            {
                                <div class="col-md-3">
                                    <div class="card border-success">
                                        <div class="card-body py-2">
                                            <small class="text-success">NC Compras (@cierreDetalle.CantNotasCreditoCompras)</small>
                                            <div class="fw-bold text-success">+@cierreDetalle.TotalNotasCreditoCompras.ToString("N0")</div>
                                        </div>
                                    </div>
                                </div>
                            }
                            <div class="col-md-3">
                                <div class="card bg-dark text-white">
                                    <div class="card-body py-2">
                                        <small>Neto en Caja</small>
                                        <div class="fw-bold">@((cierreDetalle.TotalVentasContado + cierreDetalle.TotalCobrosCredito - cierreDetalle.TotalNotasCredito - cierreDetalle.TotalComprasEfectivo + cierreDetalle.TotalNotasCreditoCompras).ToString("N0"))</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    }

                    <h6>Entregas por Medio de Pago</h6>
                    <table class="table table-sm table-striped">
                        <thead>
                            <tr>
                                <th>Medio</th>
                                <th class="text-end">Esperado</th>
                                <th class="text-end">Entregado</th>
                                <th class="text-end">Diferencia</th>
                                <th>Observación</th>
                            </tr>
                        </thead>
                        <tbody>
                            @if (entregasDetalle != null)
                            {
                                @foreach (var e in entregasDetalle)
                                {
                                    <tr>
                                        <td>
                                            <i class="bi @ObtenerIconoMedio(e.Medio) me-1"></i>
                                            @ObtenerNombreMedio(e.Medio)
                                        </td>
                                        <td class="text-end">@e.MontoEsperado.ToString("N0")</td>
                                        <td class="text-end">@e.MontoEntregado.ToString("N0")</td>
                                        <td class="text-end @(e.Diferencia < 0 ? "text-danger" : e.Diferencia > 0 ? "text-success" : "")">
                                            @e.Diferencia.ToString("N0")
                                        </td>
                                        <td><small>@e.Observaciones</small></td>
                                    </tr>
                                }
                            }
                        </tbody>
                        <tfoot class="table-secondary">
                            <tr class="fw-bold">
                                <td>TOTAL</td>
                                <td class="text-end">@cierreDetalle.TotalEsperado.ToString("N0")</td>
                                <td class="text-end">@cierreDetalle.TotalEntregado.ToString("N0")</td>
                                <td class="text-end @(cierreDetalle.Diferencia < 0 ? "text-danger" : cierreDetalle.Diferencia > 0 ? "text-success" : "")">
                                    @cierreDetalle.Diferencia.ToString("N0")
                                </td>
                                <td></td>
                            </tr>
                        </tfoot>
                    </table>

                    @if (!string.IsNullOrEmpty(cierreDetalle.Observaciones))
                    {
                        <div class="alert alert-secondary mt-3 mb-0">
                            <strong>Observaciones:</strong> @cierreDetalle.Observaciones
                        </div>
                    }
                </div>
                <div class="modal-footer">
                    <button class="btn btn-outline-primary" @onclick="() => ImprimirTicket(cierreDetalle, entregasDetalle)" title="Imprimir Ticket">
                        <i class="bi bi-receipt me-1"></i>Ticket
                    </button>
                    <button class="btn btn-primary" @onclick="() => ImprimirA4(cierreDetalle, entregasDetalle)" title="Imprimir A4">
                        <i class="bi bi-printer me-1"></i>A4
                    </button>
                    <button class="btn btn-secondary" @onclick="CerrarModal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>
}

</PageProtection>

@code {
    private DateTime filtroDesde = DateTime.Today.AddDays(-30);
    private DateTime filtroHasta = DateTime.Today;
    private int filtroCaja = 0;
    private bool cargando = false;

    private List<Caja> cajas = new();
    private List<Models.CierreCaja> cierres = new();
    
    private Models.CierreCaja? cierreDetalle;
    private List<Models.EntregaCaja>? entregasDetalle;

    protected override async Task OnInitializedAsync()
    {
        await using var ctx = await DbFactory.CreateDbContextAsync();
        var sucId = SucursalProvider.GetSucursalId();
        
        // Cargar solo cajas de la sucursal actual
        var cajasQuery = ctx.Cajas.AsNoTracking();
        if (sucId.HasValue)
            cajasQuery = cajasQuery.Where(c => c.IdSucursal == sucId.Value);
        cajas = await cajasQuery.OrderBy(c => c.IdCaja).ToListAsync();
        
        await Buscar();
    }

    private async Task Buscar()
    {
        cargando = true;
        try
        {
            await using var ctx = await DbFactory.CreateDbContextAsync();
            var sucId = SucursalProvider.GetSucursalId();
            
            var query = ctx.CierresCaja.AsNoTracking()
                .Where(c => c.FechaCaja >= filtroDesde && c.FechaCaja <= filtroHasta);

            // Filtrar por sucursal actual
            if (sucId.HasValue)
                query = query.Where(c => c.IdSucursal == sucId.Value || c.IdSucursal == null);

            if (filtroCaja > 0)
                query = query.Where(c => c.IdCaja == filtroCaja);

            cierres = await query
                .OrderByDescending(c => c.FechaCaja)
                .ThenByDescending(c => c.Turno)
                .ToListAsync();
        }
        finally
        {
            cargando = false;
        }
    }

    private async Task VerDetalle(Models.CierreCaja cierre)
    {
        await using var ctx = await DbFactory.CreateDbContextAsync();
        entregasDetalle = await ctx.EntregasCaja
            .AsNoTracking()
            .Where(e => e.IdCierreCaja == cierre.IdCierreCaja)
            .ToListAsync();
        cierreDetalle = cierre;
    }

    private void CerrarModal()
    {
        cierreDetalle = null;
        entregasDetalle = null;
    }

    private string ObtenerIconoMedio(MedioPago medio) => medio switch
    {
        MedioPago.Efectivo => "bi-cash",
        MedioPago.Tarjeta => "bi-credit-card",
        MedioPago.Cheque or MedioPago.ChequeDia or MedioPago.ChequeDiferido => "bi-bank",
        MedioPago.Transferencia => "bi-arrow-left-right",
        MedioPago.QR => "bi-qr-code",
        _ => "bi-wallet2"
    };

    private string ObtenerNombreMedio(MedioPago medio) => medio switch
    {
        MedioPago.Efectivo => "Efectivo",
        MedioPago.Tarjeta => "Tarjetas",
        MedioPago.Cheque => "Cheques",
        MedioPago.ChequeDia => "Cheques del Día",
        MedioPago.ChequeDiferido => "Cheques Diferidos",
        MedioPago.Transferencia => "Transferencias",
        MedioPago.QR => "Pagos QR",
        _ => "Otros"
    };

    private async Task ImprimirA4(Models.CierreCaja? cierre, List<Models.EntregaCaja>? entregasList)
    {
        if (cierre == null) return;
        
        await using var ctx = await DbFactory.CreateDbContextAsync();
        var sucId = SucursalProvider.GetSucursalId();
        var suc = await ctx.Sucursal.AsNoTracking().FirstOrDefaultAsync(s => s.Id == sucId);
        
        string empresa = suc?.NombreEmpresa ?? "Empresa";
        string sucursal = suc?.NombreSucursal ?? "Sucursal";
        string ruc = suc != null ? $"{suc.RUC}-{suc.DV}" : "";
        string direccion = suc?.Direccion ?? "";
        string telefono = suc?.Telefono ?? "";
        string? logoDataUri = null;
        if (suc?.Logo != null && suc.Logo.Length > 0)
            logoDataUri = $"data:image/png;base64,{Convert.ToBase64String(suc.Logo)}";

        var head = new System.Text.StringBuilder();
        head.AppendLine("<meta charset='utf-8'/>");
        head.AppendLine("<title>Cierre de Caja</title>");
        head.AppendLine("<link rel='stylesheet' href='/css/bootstrap/bootstrap.min.css' />");
        head.AppendLine("<style>");
        head.AppendLine("@media print { @page { size: A4; margin: 10mm; } }");
        head.AppendLine("body{font-size:11px;color:#111;}");
        head.AppendLine(".header{border-bottom:2px solid #222;padding-bottom:10px;margin-bottom:15px;}");
        head.AppendLine(".logo{max-width:100px;max-height:60px;object-fit:contain;}");
        head.AppendLine(".tabla th,.tabla td{padding:.3rem .5rem;border-bottom:1px solid #ddd;}");
        head.AppendLine(".right{text-align:right} .center{text-align:center} .bold{font-weight:bold}");
        head.AppendLine(".resumen-card{background:#f8f9fa;border-radius:8px;padding:10px;margin-bottom:10px;}");
        head.AppendLine(".diferencia-neg{color:#dc3545;font-weight:bold} .diferencia-pos{color:#198754;font-weight:bold}");
        head.AppendLine("</style>");

        var sb = new System.Text.StringBuilder();
        sb.AppendLine("<div class='container-fluid'>");
        
        // Encabezado
        sb.AppendLine("<div class='header d-flex justify-content-between align-items-start'>");
        sb.AppendLine("<div class='d-flex align-items-center gap-3'>");
        if (!string.IsNullOrEmpty(logoDataUri))
            sb.AppendLine($"<img class='logo' src='{logoDataUri}' alt='Logo' />");
        sb.AppendLine($"<div><h4 class='mb-0'>{empresa}</h4><div class='small'>RUC: {ruc}</div><div class='small'>{sucursal}</div>");
        if (!string.IsNullOrEmpty(direccion)) sb.AppendLine($"<div class='small'>{direccion}</div>");
        if (!string.IsNullOrEmpty(telefono)) sb.AppendLine($"<div class='small'>Tel: {telefono}</div>");
        sb.AppendLine("</div></div>");
        sb.AppendLine($"<div class='text-end'><h5>CIERRE DE CAJA #{cierre.IdCierreCaja}</h5>");
        sb.AppendLine($"<div><strong>Caja:</strong> {cierre.IdCaja} | <strong>Turno:</strong> {cierre.Turno}</div>");
        sb.AppendLine($"<div><strong>Fecha Caja:</strong> {cierre.FechaCaja:dd/MM/yyyy}</div>");
        sb.AppendLine($"<div><strong>Cerrado:</strong> {cierre.FechaCierre:dd/MM/yyyy HH:mm}</div>");
        sb.AppendLine($"<div><strong>Usuario:</strong> {cierre.UsuarioCierre}</div>");
        sb.AppendLine("</div></div>");

        // Resumen de operaciones
        sb.AppendLine("<h6 class='mt-3 mb-2'>Resumen de Operaciones</h6>");
        sb.AppendLine("<div class='row mb-3'>");
        sb.AppendLine($"<div class='col-3'><div class='resumen-card text-center'><div class='small text-muted'>Ventas Contado</div><div class='fw-bold text-success fs-5'>{cierre.TotalVentasContado:N0} ₲</div></div></div>");
        sb.AppendLine($"<div class='col-3'><div class='resumen-card text-center'><div class='small text-muted'>Ventas Crédito</div><div class='fw-bold text-primary fs-5'>{cierre.TotalVentasCredito:N0} ₲</div></div></div>");
        sb.AppendLine($"<div class='col-3'><div class='resumen-card text-center'><div class='small text-muted'>Cobros Crédito</div><div class='fw-bold text-info fs-5'>{cierre.TotalCobrosCredito:N0} ₲</div></div></div>");
        sb.AppendLine($"<div class='col-3'><div class='resumen-card text-center'><div class='small text-muted'>Anulaciones</div><div class='fw-bold text-danger fs-5'>{cierre.TotalAnulaciones:N0} ₲</div></div></div>");
        sb.AppendLine("</div>");

        // Entregas por medio de pago
        if (entregasList?.Any() == true)
        {
            sb.AppendLine("<h6 class='mb-2'>Entregas por Medio de Pago</h6>");
            sb.AppendLine("<table class='table table-sm tabla'>");
            sb.AppendLine("<thead class='table-dark'><tr><th>Medio de Pago</th><th class='right'>Esperado</th><th class='right'>Entregado</th><th class='right'>Diferencia</th><th>Observación</th></tr></thead>");
            sb.AppendLine("<tbody>");
            foreach (var e in entregasList)
            {
                var difClass = e.Diferencia < 0 ? "diferencia-neg" : e.Diferencia > 0 ? "diferencia-pos" : "";
                sb.AppendLine($"<tr><td>{ObtenerNombreMedio(e.Medio)}</td><td class='right'>{e.MontoEsperado:N0}</td><td class='right'>{e.MontoEntregado:N0}</td><td class='right {difClass}'>{e.Diferencia:N0}</td><td class='small'>{e.Observaciones ?? ""}</td></tr>");
            }
            sb.AppendLine("</tbody>");
        }
        
        var difTotalClass = cierre.Diferencia < 0 ? "diferencia-neg" : cierre.Diferencia > 0 ? "diferencia-pos" : "";
        sb.AppendLine($"<tfoot class='table-secondary'><tr class='fw-bold'><td>TOTAL</td><td class='right'>{cierre.TotalEsperado:N0}</td><td class='right'>{cierre.TotalEntregado:N0}</td><td class='right {difTotalClass}'>{cierre.Diferencia:N0}</td><td></td></tr></tfoot>");
        sb.AppendLine("</table>");

        // Observaciones
        if (!string.IsNullOrEmpty(cierre.Observaciones))
        {
            sb.AppendLine($"<div class='alert alert-secondary mt-3'><strong>Observaciones:</strong> {cierre.Observaciones}</div>");
        }

        // Firmas
        sb.AppendLine("<div class='row mt-5 pt-4'>");
        sb.AppendLine("<div class='col-4 text-center'><div style='border-top:1px solid #333;padding-top:5px;'>Cajero/a</div></div>");
        sb.AppendLine("<div class='col-4 text-center'><div style='border-top:1px solid #333;padding-top:5px;'>Supervisor/a</div></div>");
        sb.AppendLine("<div class='col-4 text-center'><div style='border-top:1px solid #333;padding-top:5px;'>Recibido por</div></div>");
        sb.AppendLine("</div>");

        sb.AppendLine("</div>");
        await JS.InvokeVoidAsync("printHtmlWithHead", head.ToString(), sb.ToString());
    }

    private async Task ImprimirTicket(Models.CierreCaja? cierre, List<Models.EntregaCaja>? entregasList)
    {
        if (cierre == null) return;
        
        await using var ctx = await DbFactory.CreateDbContextAsync();
        var sucId = SucursalProvider.GetSucursalId();
        var suc = await ctx.Sucursal.AsNoTracking().FirstOrDefaultAsync(s => s.Id == sucId);
        
        string empresa = suc?.NombreEmpresa ?? "Empresa";
        string sucursal = suc?.NombreSucursal ?? "Sucursal";
        string ruc = suc != null ? $"{suc.RUC}-{suc.DV}" : "";

        var head = new System.Text.StringBuilder();
        head.AppendLine("<meta charset='utf-8'/>");
        head.AppendLine("<title>Cierre de Caja - Ticket</title>");
        head.AppendLine("<style>");
        head.AppendLine("@media print { @page { size: 80mm auto; margin: 2mm; } }");
        head.AppendLine("body{font-family:'Courier New',monospace;font-size:12px;width:76mm;margin:0 auto;color:#000;}");
        head.AppendLine(".center{text-align:center} .right{text-align:right} .bold{font-weight:bold}");
        head.AppendLine(".line{border-top:1px dashed #000;margin:5px 0;}");
        head.AppendLine(".doble-line{border-top:2px solid #000;margin:5px 0;}");
        head.AppendLine("table{width:100%;border-collapse:collapse;} td{padding:2px 0;}");
        head.AppendLine(".small{font-size:10px}");
        head.AppendLine("</style>");

        var sb = new System.Text.StringBuilder();
        sb.AppendLine("<div class='center bold'>" + empresa + "</div>");
        sb.AppendLine("<div class='center small'>RUC: " + ruc + "</div>");
        sb.AppendLine("<div class='center small'>" + sucursal + "</div>");
        sb.AppendLine("<div class='doble-line'></div>");
        sb.AppendLine("<div class='center bold'>CIERRE DE CAJA</div>");
        sb.AppendLine("<div class='line'></div>");
        sb.AppendLine($"<div>Cierre #: {cierre.IdCierreCaja}</div>");
        sb.AppendLine($"<div>Caja: {cierre.IdCaja} - Turno: {cierre.Turno}</div>");
        sb.AppendLine($"<div>Fecha Caja: {cierre.FechaCaja:dd/MM/yyyy}</div>");
        sb.AppendLine($"<div>Cerrado: {cierre.FechaCierre:dd/MM/yyyy HH:mm}</div>");
        sb.AppendLine($"<div>Usuario: {cierre.UsuarioCierre}</div>");
        sb.AppendLine("<div class='line'></div>");
        
        sb.AppendLine("<div class='bold'>RESUMEN OPERACIONES</div>");
        sb.AppendLine("<table>");
        sb.AppendLine($"<tr><td>Ventas Contado:</td><td class='right'>{cierre.TotalVentasContado:N0}</td></tr>");
        sb.AppendLine($"<tr><td>Ventas Crédito:</td><td class='right'>{cierre.TotalVentasCredito:N0}</td></tr>");
        sb.AppendLine($"<tr><td>Cobros Crédito:</td><td class='right'>{cierre.TotalCobrosCredito:N0}</td></tr>");
        sb.AppendLine($"<tr><td>Anulaciones:</td><td class='right'>{cierre.TotalAnulaciones:N0}</td></tr>");
        sb.AppendLine("</table>");
        sb.AppendLine("<div class='line'></div>");

        sb.AppendLine("<div class='bold'>ENTREGAS</div>");
        sb.AppendLine("<table>");
        if (entregasList?.Any() == true)
        {
            foreach (var e in entregasList)
            {
                sb.AppendLine($"<tr><td>{ObtenerNombreMedio(e.Medio)}:</td><td class='right'>{e.MontoEntregado:N0}</td></tr>");
            }
        }
        sb.AppendLine("</table>");
        sb.AppendLine("<div class='line'></div>");
        
        sb.AppendLine("<table>");
        sb.AppendLine($"<tr class='bold'><td>ESPERADO:</td><td class='right'>{cierre.TotalEsperado:N0}</td></tr>");
        sb.AppendLine($"<tr class='bold'><td>ENTREGADO:</td><td class='right'>{cierre.TotalEntregado:N0}</td></tr>");
        sb.AppendLine($"<tr class='bold'><td>DIFERENCIA:</td><td class='right'>{cierre.Diferencia:N0}</td></tr>");
        sb.AppendLine("</table>");
        sb.AppendLine("<div class='doble-line'></div>");
        
        if (!string.IsNullOrEmpty(cierre.Observaciones))
        {
            sb.AppendLine($"<div class='small'>Obs: {cierre.Observaciones}</div>");
            sb.AppendLine("<div class='line'></div>");
        }

        sb.AppendLine("<br/><br/>");
        sb.AppendLine("<div class='center'>____________________</div>");
        sb.AppendLine("<div class='center small'>Firma Cajero</div>");
        sb.AppendLine("<br/><br/>");
        sb.AppendLine("<div class='center'>____________________</div>");
        sb.AppendLine("<div class='center small'>Firma Receptor</div>");

        await JS.InvokeVoidAsync("printHtmlWithHead", head.ToString(), sb.ToString());
    }
}
