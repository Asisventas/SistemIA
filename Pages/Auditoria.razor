@page "/configuracion/auditoria"
@using SistemIA.Models
@using SistemIA.Services
@using Microsoft.EntityFrameworkCore
@inject IDbContextFactory<AppDbContext> DbFactory
@inject AuditoriaService AuditoriaService
@inject IJSRuntime JS

<PageProtection Modulo="/configuracion" Permiso="VIEW">

<PageTitle>Auditoría del Sistema - SistemIA</PageTitle>

<div class="container-fluid py-4">
    <div class="row mb-4">
        <div class="col">
            <h3><i class="bi bi-journal-text"></i> Auditoría del Sistema</h3>
            <p class="text-muted">Registro completo de acciones realizadas por usuarios</p>
        </div>
    </div>

    <!-- Filtros -->
    <div class="card shadow-sm mb-4">
        <div class="card-header bg-primary text-white">
            <i class="bi bi-funnel"></i> Filtros de Búsqueda
        </div>
        <div class="card-body">
            <div class="row g-3">
                <div class="col-md-3">
                    <label class="form-label">Fecha Desde:</label>
                    <input type="date" class="form-control" @bind="fechaDesde" />
                </div>
                <div class="col-md-3">
                    <label class="form-label">Fecha Hasta:</label>
                    <input type="date" class="form-control" @bind="fechaHasta" />
                </div>
                <div class="col-md-3">
                    <label class="form-label">Usuario:</label>
                    <select class="form-select" @bind="usuarioSeleccionadoId">
                        <option value="0">-- Todos --</option>
                        @foreach (var usuario in usuarios)
                        {
                            <option value="@usuario.Id_Usu">@usuario.UsuarioNombre - @usuario.Nombres</option>
                        }
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Módulo:</label>
                    <input type="text" class="form-control" @bind="moduloFiltro" placeholder="Ej: Ventas, Productos..." />
                </div>
                <div class="col-md-3">
                    <label class="form-label">Tipo Acción:</label>
                    <select class="form-select" @bind="tipoAccionFiltro">
                        <option value="">-- Todos --</option>
                        <option value="CREATE">Crear</option>
                        <option value="UPDATE">Actualizar</option>
                        <option value="DELETE">Eliminar</option>
                        <option value="VIEW">Consultar</option>
                        <option value="EXPORT">Exportar</option>
                        <option value="PRINT">Imprimir</option>
                        <option value="LOGIN">Inicio Sesión</option>
                        <option value="LOGOUT">Cierre Sesión</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Límite:</label>
                    <select class="form-select" @bind="limite">
                        <option value="50">50 registros</option>
                        <option value="100">100 registros</option>
                        <option value="200">200 registros</option>
                        <option value="500">500 registros</option>
                    </select>
                </div>
                <div class="col-md-6 align-self-end">
                    <button class="btn btn-primary" @onclick="CargarAuditorias" disabled="@cargando">
                        <i class="bi bi-search"></i> Buscar
                    </button>
                    <button class="btn btn-secondary ms-2" @onclick="LimpiarFiltros">
                        <i class="bi bi-x-circle"></i> Limpiar
                    </button>
                    <button class="btn btn-success ms-2" @onclick="ExportarExcel" disabled="@(!auditorias.Any() || exportando)">
                        @if (exportando)
                        {
                            <span class="spinner-border spinner-border-sm me-1"></span>
                        }
                        else
                        {
                            <i class="bi bi-file-earmark-excel me-1"></i>
                        }
                        Exportar Excel
                    </button>
                    <button class="btn btn-outline-primary ms-2" @onclick="Imprimir" disabled="@(!auditorias.Any())">
                        <i class="bi bi-printer me-1"></i> Imprimir
                    </button>
                    <button class="btn btn-outline-info ms-2" @onclick="() => mostrarModalEnvio = true" disabled="@(!auditorias.Any())">
                        <i class="bi bi-envelope me-1"></i> Enviar
                    </button>
                </div>
            </div>
        </div>
    </div>

    @if (mensaje != null)
    {
        <div class="alert alert-@(mensajeEsError ? "danger" : "info") alert-dismissible fade show" role="alert">
            @mensaje
            <button type="button" class="btn-close" @onclick="() => mensaje = null"></button>
        </div>
    }

    @if (cargando)
    {
        <div class="text-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Cargando...</span>
            </div>
            <p class="mt-2">Cargando auditorías...</p>
        </div>
    }
    else if (auditorias.Any())
    {
        <!-- Estadísticas -->
        <div class="row mb-4">
            <div class="col-md-12">
                <div class="card shadow-sm">
                    <div class="card-body">
                        <h5><i class="bi bi-bar-chart"></i> Estadísticas</h5>
                        <div class="row">
                            @foreach (var stat in estadisticas)
                            {
                                <div class="col-md-2 text-center">
                                    <h4 class="text-primary mb-0">@stat.Value</h4>
                                    <small class="text-muted">@ObtenerNombreAccion(stat.Key)</small>
                                </div>
                            }
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tabla de Auditorías -->
        <div class="card shadow-sm">
            <div class="card-header bg-secondary text-white">
                <i class="bi bi-list-ul"></i> Registros de Auditoría (@auditorias.Count)
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover table-striped mb-0">
                        <thead class="table-light">
                            <tr>
                                <th style="width: 8%;">Fecha Equipo</th>
                                <th style="width: 8%;">Fecha/Turno Caja</th>
                                <th style="width: 10%;">Sucursal/Caja</th>
                                <th style="width: 10%;">Usuario</th>
                                <th style="width: 8%;">Módulo</th>
                                <th style="width: 12%;">Acción</th>
                                <th style="width: 6%;">Tipo</th>
                                <th style="width: 8%;">Entidad</th>
                                <th style="width: 18%;">Descripción</th>
                                <th style="width: 4%;">Estado</th>
                                <th style="width: 3%;"></th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var auditoria in auditorias)
                            {
                                <tr class="@(auditoria.Exitosa ? "" : "table-danger")">
                                    <td>
                                        @{
                                            var fechaMostrar = auditoria.FechaHoraEquipo ?? auditoria.FechaHora;
                                        }
                                        <small>@fechaMostrar.ToString("dd/MM/yyyy")</small><br />
                                        <small class="text-muted">@fechaMostrar.ToString("HH:mm:ss")</small>
                                    </td>
                                    <td>
                                        @if (auditoria.FechaCaja.HasValue)
                                        {
                                            <small>@auditoria.FechaCaja.Value.ToString("dd/MM/yyyy")</small><br />
                                            <small class="text-muted">Turno: @auditoria.Turno</small>
                                        }
                                        else
                                        {
                                            <small class="text-muted">-</small>
                                        }
                                    </td>
                                    <td>
                                        @if (!string.IsNullOrEmpty(auditoria.NombreSucursal))
                                        {
                                            <small><strong>@auditoria.NombreSucursal</strong></small><br />
                                            <small class="text-muted">@auditoria.NombreCaja</small>
                                        }
                                        else
                                        {
                                            <small class="text-muted">-</small>
                                        }
                                    </td>
                                    <td>
                                        <strong>@auditoria.NombreUsuario</strong><br />
                                        <small class="text-muted">@auditoria.RolUsuario</small>
                                    </td>
                                    <td>@auditoria.Modulo</td>
                                    <td>@auditoria.Accion</td>
                                    <td>
                                        <span class="badge bg-@ObtenerColorTipo(auditoria.TipoAccion)">
                                            @auditoria.TipoAccion
                                        </span>
                                    </td>
                                    <td>
                                        @auditoria.Entidad
                                        @if (auditoria.IdRegistroAfectado.HasValue)
                                        {
                                            <br /><small class="text-muted">ID: @auditoria.IdRegistroAfectado</small>
                                        }
                                    </td>
                                    <td>
                                        <small>@auditoria.Descripcion</small>
                                    </td>
                                    <td class="text-center">
                                        @if (auditoria.Exitosa)
                                        {
                                            <i class="bi bi-check-circle text-success" title="Exitosa"></i>
                                        }
                                        else
                                        {
                                            <i class="bi bi-x-circle text-danger" title="@auditoria.MensajeError"></i>
                                        }
                                    </td>
                                    <td>
                                        <button class="btn btn-sm btn-outline-primary" @onclick="() => VerDetalle(auditoria)">
                                            <i class="bi bi-eye"></i>
                                        </button>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    }
    else if (!cargando)
    {
        <div class="alert alert-info">
            <i class="bi bi-info-circle"></i> No se encontraron registros de auditoría con los filtros seleccionados.
        </div>
    }
</div>

<!-- Modal de Detalle -->
@if (auditoriaSeleccionada != null)
{
    <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog modal-xl modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title"><i class="bi bi-info-circle"></i> Detalle de Auditoría</h5>
                    <button type="button" class="btn-close btn-close-white" @onclick="CerrarDetalle"></button>
                </div>
                <div class="modal-body">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <strong>Usuario:</strong> @auditoriaSeleccionada.NombreUsuario (@auditoriaSeleccionada.Usuario?.UsuarioNombre)
                        </div>
                        <div class="col-md-6">
                            <strong>Rol:</strong> @auditoriaSeleccionada.RolUsuario
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <strong>Fecha/Hora:</strong> @auditoriaSeleccionada.FechaHora.ToString("dd/MM/yyyy HH:mm:ss")
                        </div>
                        <div class="col-md-6">
                            <strong>Módulo:</strong> @auditoriaSeleccionada.Modulo
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <strong>Acción:</strong> @auditoriaSeleccionada.Accion
                        </div>
                        <div class="col-md-6">
                            <strong>Tipo:</strong> <span class="badge bg-@ObtenerColorTipo(auditoriaSeleccionada.TipoAccion)">@auditoriaSeleccionada.TipoAccion</span>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <strong>Entidad:</strong> @auditoriaSeleccionada.Entidad
                        </div>
                        <div class="col-md-6">
                            <strong>ID Registro:</strong> @auditoriaSeleccionada.IdRegistroAfectado
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-12">
                            <strong>Descripción:</strong><br />
                            @auditoriaSeleccionada.Descripcion
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <strong>Dirección IP:</strong> @auditoriaSeleccionada.DireccionIP
                        </div>
                        <div class="col-md-6">
                            <strong>Navegador:</strong> @auditoriaSeleccionada.Navegador
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <strong>Estado:</strong> @(auditoriaSeleccionada.Exitosa ? "Exitosa" : "Fallida")
                        </div>
                        <div class="col-md-6">
                            <strong>Severidad:</strong> <span class="badge bg-@ObtenerColorSeveridad(auditoriaSeleccionada.Severidad)">@auditoriaSeleccionada.Severidad</span>
                        </div>
                    </div>
                    @if (!string.IsNullOrEmpty(auditoriaSeleccionada.MensajeError))
                    {
                        <div class="row mb-3">
                            <div class="col-md-12">
                                <div class="alert alert-danger">
                                    <strong>Error:</strong> @auditoriaSeleccionada.MensajeError
                                </div>
                            </div>
                        </div>
                    }
                    @if (!string.IsNullOrEmpty(auditoriaSeleccionada.DatosAntes) || !string.IsNullOrEmpty(auditoriaSeleccionada.DatosDespues))
                    {
                        <div class="row">
                            @if (!string.IsNullOrEmpty(auditoriaSeleccionada.DatosAntes))
                            {
                                <div class="col-md-6">
                                    <h6>Datos Antes:</h6>
                                    <pre class="bg-light p-3 rounded" style="max-height: 300px; overflow-y: auto;">@FormatearJson(auditoriaSeleccionada.DatosAntes)</pre>
                                </div>
                            }
                            @if (!string.IsNullOrEmpty(auditoriaSeleccionada.DatosDespues))
                            {
                                <div class="col-md-6">
                                    <h6>Datos Después:</h6>
                                    <pre class="bg-light p-3 rounded" style="max-height: 300px; overflow-y: auto;">@FormatearJson(auditoriaSeleccionada.DatosDespues)</pre>
                                </div>
                            }
                        </div>
                    }
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="CerrarDetalle">Cerrar</button>
                </div>
            </div>
        </div>
    </div>
}

@* Modal de Envío por Correo *@
@if (mostrarModalEnvio)
{
    <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-info text-white">
                    <h5 class="modal-title"><i class="bi bi-envelope"></i> Enviar Auditoría por Correo</h5>
                    <button type="button" class="btn-close btn-close-white" @onclick="() => mostrarModalEnvio = false"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Correo Destino:</label>
                        <input type="email" class="form-control" @bind="correoDestino" placeholder="ejemplo@correo.com" />
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Asunto:</label>
                        <input type="text" class="form-control" @bind="asuntoCorreo" />
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Mensaje adicional (opcional):</label>
                        <textarea class="form-control" rows="3" @bind="mensajeCorreo" placeholder="Escriba un mensaje adicional..."></textarea>
                    </div>
                    <div class="alert alert-info small">
                        <i class="bi bi-info-circle"></i> Se adjuntará un archivo Excel con @auditorias.Count registros de auditoría.
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="() => mostrarModalEnvio = false">Cancelar</button>
                    <button type="button" class="btn btn-primary" @onclick="EnviarPorCorreo" disabled="@(enviandoCorreo || string.IsNullOrWhiteSpace(correoDestino))">
                        @if (enviandoCorreo)
                        {
                            <span class="spinner-border spinner-border-sm me-1"></span>
                        }
                        else
                        {
                            <i class="bi bi-send me-1"></i>
                        }
                        Enviar
                    </button>
                </div>
            </div>
        </div>
    </div>
}

</PageProtection>

@code {
    private bool cargando = false;
    private List<AuditoriaAccion> auditorias = new();
    private List<Usuario> usuarios = new();
    private Dictionary<string, int> estadisticas = new();
    private AuditoriaAccion? auditoriaSeleccionada;
    private string? mensaje;
    private bool mensajeEsError;
    
    // Variables para exportar/enviar
    private bool exportando = false;
    private bool mostrarModalEnvio = false;
    private bool enviandoCorreo = false;
    private string correoDestino = "";
    private string asuntoCorreo = "Informe de Auditoría del Sistema - SistemIA";
    private string mensajeCorreo = "";

    // Filtros
    private DateTime? fechaDesde = DateTime.Today.AddDays(-7);
    private DateTime? fechaHasta = DateTime.Today.AddDays(1);
    private int usuarioSeleccionadoId = 0;
    private string? moduloFiltro;
    private string? tipoAccionFiltro;
    private int limite = 100;

    protected override async Task OnInitializedAsync()
    {
        await CargarUsuarios();
        await CargarAuditorias();
    }

    private async Task CargarUsuarios()
    {
        await using var ctx = await DbFactory.CreateDbContextAsync();
        usuarios = await ctx.Usuarios
            .Where(u => u.Estado_Usu)
            .OrderBy(u => u.UsuarioNombre)
            .ToListAsync();
    }

    private async Task CargarAuditorias()
    {
        cargando = true;
        mensaje = null;
        StateHasChanged();

        try
        {
            int? idUsuario = usuarioSeleccionadoId > 0 ? usuarioSeleccionadoId : null;
            
            auditorias = await AuditoriaService.ObtenerHistorialAsync(
                fechaDesde,
                fechaHasta,
                idUsuario,
                moduloFiltro,
                tipoAccionFiltro,
                limite
            );

            if (auditorias.Any())
            {
                estadisticas = await AuditoriaService.ObtenerEstadisticasAsync(
                    fechaDesde,
                    fechaHasta,
                    idUsuario,
                    moduloFiltro
                );
            }
            else
            {
                estadisticas.Clear();
                mensaje = "No se encontraron registros con los filtros seleccionados.";
            }
        }
        catch (Exception ex)
        {
            mensaje = $"Error al cargar auditorías: {ex.Message}";
            mensajeEsError = true;
        }
        finally
        {
            cargando = false;
        }
    }

    private void LimpiarFiltros()
    {
        fechaDesde = DateTime.Today.AddDays(-7);
        fechaHasta = DateTime.Today.AddDays(1);
        usuarioSeleccionadoId = 0;
        moduloFiltro = null;
        tipoAccionFiltro = null;
        limite = 100;
    }

    private void VerDetalle(AuditoriaAccion auditoria)
    {
        auditoriaSeleccionada = auditoria;
    }

    private void CerrarDetalle()
    {
        auditoriaSeleccionada = null;
    }

    private string ObtenerColorTipo(string? tipo)
    {
        return tipo switch
        {
            "CREATE" => "success",
            "UPDATE" => "primary",
            "DELETE" => "danger",
            "VIEW" => "info",
            "EXPORT" => "warning",
            "PRINT" => "secondary",
            "LOGIN" => "success",
            "LOGOUT" => "secondary",
            _ => "secondary"
        };
    }

    private string ObtenerColorSeveridad(string? severidad)
    {
        return severidad switch
        {
            "INFO" => "info",
            "WARNING" => "warning",
            "ERROR" => "danger",
            "CRITICAL" => "dark",
            _ => "secondary"
        };
    }

    private string ObtenerNombreAccion(string codigo)
    {
        return codigo switch
        {
            "CREATE" => "Creados",
            "UPDATE" => "Actualizados",
            "DELETE" => "Eliminados",
            "VIEW" => "Consultados",
            "EXPORT" => "Exportados",
            "PRINT" => "Impresos",
            _ => codigo
        };
    }

    private string FormatearJson(string? json)
    {
        if (string.IsNullOrEmpty(json)) return string.Empty;
        
        try
        {
            var jsonDocument = System.Text.Json.JsonDocument.Parse(json);
            return System.Text.Json.JsonSerializer.Serialize(jsonDocument, new System.Text.Json.JsonSerializerOptions 
            { 
                WriteIndented = true 
            });
        }
        catch
        {
            return json;
        }
    }

    private async Task ExportarExcel()
    {
        if (!auditorias.Any()) return;
        
        exportando = true;
        StateHasChanged();
        
        try
        {
            var excelBytes = GenerarExcelAuditoria();
            var fileName = $"Auditoria_{DateTime.Now:yyyyMMdd_HHmmss}.xlsx";
            
            // Descargar el archivo
            await JS.InvokeVoidAsync("descargarArchivoBase64", fileName, Convert.ToBase64String(excelBytes), "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet");
            
            mensaje = "Archivo Excel generado exitosamente.";
            mensajeEsError = false;
        }
        catch (Exception ex)
        {
            mensaje = $"Error al exportar: {ex.Message}";
            mensajeEsError = true;
        }
        finally
        {
            exportando = false;
            StateHasChanged();
        }
    }

    private byte[] GenerarExcelAuditoria()
    {
        using var workbook = new ClosedXML.Excel.XLWorkbook();
        var worksheet = workbook.Worksheets.Add("Auditoría");
        
        // Título
        worksheet.Cell(1, 1).Value = "INFORME DE AUDITORÍA DEL SISTEMA";
        worksheet.Range(1, 1, 1, 10).Merge().Style.Font.Bold = true;
        worksheet.Cell(1, 1).Style.Font.FontSize = 14;
        worksheet.Cell(1, 1).Style.Alignment.Horizontal = ClosedXML.Excel.XLAlignmentHorizontalValues.Center;
        
        // Filtros aplicados
        worksheet.Cell(2, 1).Value = $"Período: {fechaDesde?.ToString("dd/MM/yyyy") ?? "-"} al {fechaHasta?.ToString("dd/MM/yyyy") ?? "-"}";
        worksheet.Cell(3, 1).Value = $"Generado: {DateTime.Now:dd/MM/yyyy HH:mm:ss}";
        worksheet.Cell(4, 1).Value = $"Total registros: {auditorias.Count}";
        
        // Encabezados
        int fila = 6;
        var headers = new[] { "Fecha/Hora", "Fecha Caja", "Turno", "Sucursal", "Caja", "Usuario", "Rol", "Módulo", "Acción", "Tipo", "Entidad", "ID Registro", "Descripción", "Estado" };
        for (int i = 0; i < headers.Length; i++)
        {
            worksheet.Cell(fila, i + 1).Value = headers[i];
            worksheet.Cell(fila, i + 1).Style.Font.Bold = true;
            worksheet.Cell(fila, i + 1).Style.Fill.BackgroundColor = ClosedXML.Excel.XLColor.LightGray;
            worksheet.Cell(fila, i + 1).Style.Border.OutsideBorder = ClosedXML.Excel.XLBorderStyleValues.Thin;
        }
        
        // Datos
        fila = 7;
        foreach (var a in auditorias)
        {
            var fechaMostrar = a.FechaHoraEquipo ?? a.FechaHora;
            worksheet.Cell(fila, 1).Value = fechaMostrar.ToString("dd/MM/yyyy HH:mm:ss");
            worksheet.Cell(fila, 2).Value = a.FechaCaja?.ToString("dd/MM/yyyy") ?? "-";
            worksheet.Cell(fila, 3).Value = a.Turno?.ToString() ?? "-";
            worksheet.Cell(fila, 4).Value = a.NombreSucursal ?? "-";
            worksheet.Cell(fila, 5).Value = a.NombreCaja ?? "-";
            worksheet.Cell(fila, 6).Value = a.NombreUsuario ?? "-";
            worksheet.Cell(fila, 7).Value = a.RolUsuario ?? "-";
            worksheet.Cell(fila, 8).Value = a.Modulo ?? "-";
            worksheet.Cell(fila, 9).Value = a.Accion ?? "-";
            worksheet.Cell(fila, 10).Value = a.TipoAccion ?? "-";
            worksheet.Cell(fila, 11).Value = a.Entidad ?? "-";
            worksheet.Cell(fila, 12).Value = a.IdRegistroAfectado?.ToString() ?? "-";
            worksheet.Cell(fila, 13).Value = a.Descripcion ?? "-";
            worksheet.Cell(fila, 14).Value = a.Exitosa ? "Exitosa" : "Fallida";
            
            // Color de fila según estado
            if (!a.Exitosa)
            {
                worksheet.Row(fila).Style.Fill.BackgroundColor = ClosedXML.Excel.XLColor.LightPink;
            }
            
            fila++;
        }
        
        // Ajustar columnas
        worksheet.Columns().AdjustToContents();
        
        using var stream = new System.IO.MemoryStream();
        workbook.SaveAs(stream);
        return stream.ToArray();
    }

    private async Task Imprimir()
    {
        if (!auditorias.Any()) return;
        
        try
        {
            // Generar HTML para impresión
            var html = GenerarHtmlImpresion();
            await JS.InvokeVoidAsync("imprimirHtml", html);
        }
        catch (Exception ex)
        {
            mensaje = $"Error al imprimir: {ex.Message}";
            mensajeEsError = true;
        }
    }

    private string GenerarHtmlImpresion()
    {
        var sb = new System.Text.StringBuilder();
        sb.AppendLine("<html>");
        sb.AppendLine("<head>");
        sb.AppendLine("<title>Auditoría del Sistema</title>");
        sb.AppendLine("<style>");
        sb.AppendLine("body { font-family: Arial, sans-serif; font-size: 10px; margin: 10px; }");
        sb.AppendLine("h1 { font-size: 16px; text-align: center; margin-bottom: 5px; }");
        sb.AppendLine(".info { text-align: center; font-size: 9px; color: #666; margin-bottom: 10px; }");
        sb.AppendLine("table { width: 100%; border-collapse: collapse; }");
        sb.AppendLine("th, td { border: 1px solid #333; padding: 3px 5px; text-align: left; }");
        sb.AppendLine("th { background-color: #e0e0e0; font-weight: bold; }");
        sb.AppendLine(".error { background-color: #ffcccc; }");
        sb.AppendLine("@media print { @page { size: landscape; margin: 5mm; } }");
        sb.AppendLine("</style>");
        sb.AppendLine("</head>");
        sb.AppendLine("<body>");
        sb.AppendLine("<h1>AUDITORÍA DEL SISTEMA</h1>");
        sb.AppendLine($"<div class='info'>Período: {fechaDesde?.ToString("dd/MM/yyyy") ?? "-"} al {fechaHasta?.ToString("dd/MM/yyyy") ?? "-"} | Generado: {DateTime.Now:dd/MM/yyyy HH:mm:ss} | Total: {auditorias.Count} registros</div>");
        sb.AppendLine("<table>");
        sb.AppendLine("<thead><tr>");
        sb.AppendLine("<th>Fecha/Hora</th><th>Sucursal/Caja</th><th>Usuario</th><th>Módulo</th><th>Acción</th><th>Tipo</th><th>Entidad</th><th>Descripción</th><th>Estado</th>");
        sb.AppendLine("</tr></thead>");
        sb.AppendLine("<tbody>");
        
        foreach (var a in auditorias)
        {
            var fechaMostrar = a.FechaHoraEquipo ?? a.FechaHora;
            var cssClass = a.Exitosa ? "" : " class='error'";
            sb.AppendLine($"<tr{cssClass}>");
            sb.AppendLine($"<td>{fechaMostrar:dd/MM/yyyy HH:mm}</td>");
            sb.AppendLine($"<td>{System.Web.HttpUtility.HtmlEncode(a.NombreSucursal ?? "-")}<br/><small>{System.Web.HttpUtility.HtmlEncode(a.NombreCaja ?? "")}</small></td>");
            sb.AppendLine($"<td>{System.Web.HttpUtility.HtmlEncode(a.NombreUsuario ?? "-")}</td>");
            sb.AppendLine($"<td>{System.Web.HttpUtility.HtmlEncode(a.Modulo ?? "-")}</td>");
            sb.AppendLine($"<td>{System.Web.HttpUtility.HtmlEncode(a.Accion ?? "-")}</td>");
            sb.AppendLine($"<td>{System.Web.HttpUtility.HtmlEncode(a.TipoAccion ?? "-")}</td>");
            sb.AppendLine($"<td>{System.Web.HttpUtility.HtmlEncode(a.Entidad ?? "-")}</td>");
            sb.AppendLine($"<td>{System.Web.HttpUtility.HtmlEncode(a.Descripcion ?? "-")}</td>");
            sb.AppendLine($"<td>{(a.Exitosa ? "✓" : "✗")}</td>");
            sb.AppendLine("</tr>");
        }
        
        sb.AppendLine("</tbody></table>");
        sb.AppendLine("</body></html>");
        
        return sb.ToString();
    }

    private async Task EnviarPorCorreo()
    {
        if (string.IsNullOrWhiteSpace(correoDestino) || !auditorias.Any()) return;
        
        enviandoCorreo = true;
        StateHasChanged();
        
        try
        {
            // Obtener configuración de correo de la sucursal 1 (o la que esté configurada)
            await using var ctx = await DbFactory.CreateDbContextAsync();
            var configCorreo = await ctx.ConfiguracionesCorreo.FirstOrDefaultAsync(c => c.Activo);
            
            if (configCorreo == null)
            {
                mensaje = "No hay configuración de correo activa. Configure el correo en Configuración > Correo.";
                mensajeEsError = true;
                return;
            }
            
            // Generar Excel
            var excelBytes = GenerarExcelAuditoria();
            var nombreArchivo = $"Auditoria_{DateTime.Now:yyyyMMdd_HHmmss}.xlsx";
            
            // Construir cuerpo del correo
            var sbCorreo = new System.Text.StringBuilder();
            sbCorreo.AppendLine("<h2>Informe de Auditoría del Sistema</h2>");
            sbCorreo.AppendLine($"<p><strong>Período:</strong> {fechaDesde?.ToString("dd/MM/yyyy") ?? "-"} al {fechaHasta?.ToString("dd/MM/yyyy") ?? "-"}</p>");
            sbCorreo.AppendLine($"<p><strong>Total de registros:</strong> {auditorias.Count}</p>");
            sbCorreo.AppendLine($"<p><strong>Generado:</strong> {DateTime.Now:dd/MM/yyyy HH:mm:ss}</p>");
            if (!string.IsNullOrWhiteSpace(mensajeCorreo))
            {
                sbCorreo.AppendLine($"<p><strong>Mensaje:</strong> {System.Web.HttpUtility.HtmlEncode(mensajeCorreo)}</p>");
            }
            sbCorreo.AppendLine("<hr/>");
            sbCorreo.AppendLine("<p>Se adjunta archivo Excel con el detalle completo de la auditoría.</p>");
            sbCorreo.AppendLine("<p style='color: #888; font-size: 12px;'>Este correo fue enviado automáticamente desde SistemIA.</p>");
            var cuerpoHtml = sbCorreo.ToString();
            
            // Determinar si usar SSL/TLS
            var usarSsl = configCorreo.TipoSeguridad?.ToUpper() == "SSL" 
                       || configCorreo.TipoSeguridad?.ToUpper() == "TLS" 
                       || configCorreo.TipoSeguridad?.ToUpper() == "STARTTLS";
            
            // Enviar correo con adjunto
            using var smtpClient = new System.Net.Mail.SmtpClient(configCorreo.ServidorSmtp, configCorreo.Puerto)
            {
                Credentials = new System.Net.NetworkCredential(configCorreo.UsuarioSmtp, configCorreo.ContrasenaSmtp),
                EnableSsl = usarSsl
            };
            
            using var mailMessage = new System.Net.Mail.MailMessage
            {
                From = new System.Net.Mail.MailAddress(configCorreo.CorreoRemitenteEfectivo, configCorreo.NombreRemitenteEfectivo),
                Subject = asuntoCorreo,
                Body = cuerpoHtml,
                IsBodyHtml = true
            };
            
            mailMessage.To.Add(correoDestino);
            
            // Adjuntar Excel
            using var ms = new System.IO.MemoryStream(excelBytes);
            var attachment = new System.Net.Mail.Attachment(ms, nombreArchivo, "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet");
            mailMessage.Attachments.Add(attachment);
            
            await smtpClient.SendMailAsync(mailMessage);
            
            mensaje = $"Correo enviado exitosamente a {correoDestino}";
            mensajeEsError = false;
            mostrarModalEnvio = false;
            
            // Limpiar campos
            correoDestino = "";
            mensajeCorreo = "";
        }
        catch (Exception ex)
        {
            mensaje = $"Error al enviar correo: {ex.Message}";
            mensajeEsError = true;
        }
        finally
        {
            enviandoCorreo = false;
            StateHasChanged();
        }
    }
}
