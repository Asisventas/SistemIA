@page "/mesas/panel"
@inject IDbContextFactory<AppDbContext> DbFactory
@inject IJSRuntime JS
@inject NavigationManager Nav
@inject ICorreoService CorreoService
@inject PermisosService PermisosService
@inject ComandaService ComandaService
@inject ICajaProvider CajaProvider
@inject ISucursalProvider SucursalProvider
@inject IReservaCorreoService ReservaCorreoService
@inject SistemIA.Services.ImpresionDirectaService ImpresionDirectaService
@using Microsoft.EntityFrameworkCore
@using SistemIA.Services
@using SistemIA.Models.Enums
@using Microsoft.AspNetCore.Components.Authorization
@implements IDisposable

<PageProtection Modulo="/mesas" Permiso="VIEW">

<div class="mesas-panel-container @(!_mostrarAgenda ? "agenda-colapsada" : "")">
    <!-- ========== PANEL IZQUIERDO: MESAS (40%) ========== -->
    <div class="panel-mesas @(_mesaSeleccionada != null ? "con-pedido" : "") @(!_mostrarAgenda ? "agenda-oculta" : "") @(_ocultarPanelMesas ? "mesas-ocultas" : "")">
        <!-- Encabezado -->
        <div class="d-flex justify-content-between align-items-center mb-2 px-2">
            <div class="d-flex align-items-center gap-2">
                <h5 class="mb-0">
                    <i class="bi @_iconoEspacio text-primary me-2"></i>
                    @_tituloPanel
                </h5>
                @if (_sucursalActual != null)
                {
                    <span class="badge bg-secondary small">@_sucursalActual.NombreSucursal</span>
                }
            </div>
            <div class="d-flex gap-1">
                <button class="btn btn-outline-secondary btn-sm" @onclick="Refrescar" title="Refrescar">
                    <i class="bi bi-arrow-clockwise"></i>
                </button>
                <a href="/mesas" class="btn btn-outline-primary btn-sm" title="Administrar">
                    <i class="bi bi-gear"></i>
                </a>
            </div>
        </div>

        <!-- Indicador de Caja Activa (igual que Ventas) -->
        @if (_cajaActual != null)
        {
            <div class="alert alert-info border-0 d-flex flex-wrap gap-3 align-items-center justify-content-between mb-2 mx-2 py-2 small">
                <div class="d-flex flex-wrap gap-3 align-items-center">
                    @if (_sucursalActual != null)
                    {
                        <span title="Sucursal">
                            <i class="bi bi-building text-primary me-1"></i>
                            <strong>@(_sucursalActual.NombreSucursal ?? "Sucursal")</strong>
                        </span>
                    }
                    <span title="Caja Activa">
                        <i class="bi bi-cash-stack text-success me-1"></i>
                        <strong>@(_cajaActual.Nombre ?? $"Caja {_cajaActual.IdCaja}")</strong>
                    </span>
                    <span title="Fecha de Caja">
                        <i class="bi bi-calendar3 text-info me-1"></i>
                        <strong>@_fechaCaja.ToString("dd/MM/yyyy")</strong>
                    </span>
                    <span title="Turno Actual">
                        <i class="bi bi-clock text-warning me-1"></i>
                        <strong>Turno @_turnoActual</strong>
                    </span>
                </div>
                <a href="/caja/cierre" class="btn btn-sm btn-outline-danger" title="Ir al Cierre de Caja">
                    <i class="bi bi-lock me-1"></i>Cerrar Turno
                </a>
            </div>
        }
        else
        {
            <div class="alert alert-warning py-2 px-3 mb-2 mx-2">
                <i class="bi bi-exclamation-triangle-fill me-2"></i>
                <strong>No hay caja activa.</strong> 
                <a href="/caja" class="alert-link">Ir a Cajas para abrir una caja</a>
            </div>
        }

        <!-- Leyenda de estados -->
        <div class="d-flex gap-2 mb-2 px-2 small flex-wrap">
            <span><span class="badge" style="background-color: #28a745">‚óè</span> Libre</span>
            <span><span class="badge" style="background-color: #dc3545">‚óè</span> Ocupada</span>
            <span><span class="badge" style="background-color: #ffc107; color: #000">‚óè</span> Reservada</span>
        </div>
        
        <!-- Mensajes de √©xito/error -->
        @if (!string.IsNullOrEmpty(_mensajeExito))
        {
            <div class="alert alert-success alert-dismissible fade show mx-2 py-2" role="alert">
                <i class="bi bi-check-circle-fill me-2"></i>@_mensajeExito
                <button type="button" class="btn-close btn-sm" @onclick='() => _mensajeExito = ""'></button>
            </div>
        }
        @if (!string.IsNullOrEmpty(_mensajeError))
        {
            <div class="alert alert-danger alert-dismissible fade show mx-2 py-2" role="alert">
                <i class="bi bi-exclamation-triangle-fill me-2"></i>@_mensajeError
                <button type="button" class="btn-close btn-sm" @onclick='() => _mensajeError = ""'></button>
            </div>
        }

        <!-- Filtro por zonas -->
        @if (_zonas.Any())
        {
            <div class="btn-group mb-2 px-2" role="group">
                <button type="button" class="btn @(_zonaFiltro == null ? "btn-primary" : "btn-outline-primary") btn-sm" 
                        @onclick="() => FiltrarPorZona(null)">
                    Todas
                </button>
                @foreach (var zona in _zonas)
                {
                    <button type="button" class="btn @(_zonaFiltro == zona ? "btn-primary" : "btn-outline-primary") btn-sm" 
                            @onclick="() => FiltrarPorZona(zona)">
                        @zona
                    </button>
                }
            </div>
        }
        
        @* Filtro por tipo de espacio (solo en modo Complejo) *@
        @if (_modoCanchas && _mesas.Select(m => m.Tipo).Distinct().Count() > 1)
        {
            <div class="btn-group mb-2 px-2" role="group">
                <button type="button" class="btn @(_tipoEspacioFiltro == null ? "btn-success" : "btn-outline-success") btn-sm" 
                        @onclick="() => FiltrarPorTipoEspacio(null)">
                    <i class="bi bi-grid-fill me-1"></i>Todos
                </button>
                <button type="button" class="btn @(_tipoEspacioFiltro == "Cancha" ? "btn-success" : "btn-outline-success") btn-sm" 
                        @onclick='() => FiltrarPorTipoEspacio("Cancha")'>
                    <i class="bi bi-dribbble me-1"></i>Canchas
                </button>
                <button type="button" class="btn @(_tipoEspacioFiltro == "Mesa" ? "btn-success" : "btn-outline-success") btn-sm" 
                        @onclick='() => FiltrarPorTipoEspacio("Mesa")'>
                    <i class="bi bi-cup-straw me-1"></i>Mesas/Bar
                </button>
            </div>
        }

        <!-- Grid de Mesas -->
        @if (_cargando)
        {
            <div class="text-center py-4">
                <div class="spinner-border text-primary" role="status"></div>
                <p class="mt-2 text-muted small">Cargando @_terminoEspacioPlural.ToLower()...</p>
            </div>
        }
        else if (!_mesasFiltradas.Any())
        {
            <div class="alert alert-info mx-2">
                <i class="bi bi-info-circle me-2"></i>
                No hay @_terminoEspacioPlural.ToLower() configuradas. 
                <a href="/mesas" class="alert-link">Crear @_terminoEspacioPlural.ToLower()</a>.
            </div>
        }
        else
        {
            <div class="mesas-grid p-2">
                @foreach (var mesa in _mesasFiltradas)
                {
                    var pedidoActivo = _pedidosActivos.FirstOrDefault(p => p.IdMesa == mesa.IdMesa);
                    var tieneReservaProxima = _reservasProximas.Any(r => r.IdMesa == mesa.IdMesa);
                    var reservaEnCurso = _modoCanchas ? _reservasHoy.FirstOrDefault(r => r.IdMesa == mesa.IdMesa && r.Estado == "EnCurso") : null;
                    var canchaFinalizada = reservaEnCurso != null && ReservaFinalizada(reservaEnCurso);
                    var estadoVisual = pedidoActivo != null ? "Ocupada" : (reservaEnCurso != null ? "Ocupada" : (tieneReservaProxima ? "Reservada" : mesa.Estado));
                    var colorFondo = estadoVisual switch
                    {
                        "Ocupada" => mesa.ColorOcupada,
                        "Reservada" => mesa.ColorReservada,
                        "Mantenimiento" => "#6c757d",
                        _ => mesa.ColorLibre
                    };
                    var esSeleccionada = _mesaSeleccionada?.IdMesa == mesa.IdMesa;
                    var esDelivery = mesa.Tipo == "Delivery";
                    var tieneImagen = !string.IsNullOrEmpty(mesa.ImagenUrl);
                    var esMesaUnida = mesa.IdMesaPrincipal.HasValue;
                    var mesasUnidasList = _mesas.Where(m => m.IdMesaPrincipal == mesa.IdMesa).OrderBy(n => n.Numero).ToList();
                    var tieneMesasUnidas = mesasUnidasList.Any();
                    var cantidadMesasUnidas = mesasUnidasList.Count + 1; // +1 por la mesa principal
                    var clasesForma = mesa.Forma?.ToLower() switch
                    {
                        "circulo" => "forma-circulo",
                        "rectangulo" => "forma-rectangulo",
                        "oval" => "forma-oval",
                        _ => "forma-cuadrado"
                    };

                    @* No mostrar mesas que est√°n unidas a otra (se muestran en la principal) *@
                    @if (!esMesaUnida)
                    {
                    <div class="mesa-card @clasesForma @(esSeleccionada ? "seleccionada" : "") @(pedidoActivo != null || reservaEnCurso != null ? "ocupada" : "") @(esDelivery ? "delivery-card" : "") @(tieneMesasUnidas ? (cantidadMesasUnidas >= 3 ? "mesa-unida mesa-unida-3" : "mesa-unida") : "") @(_mesaDestino?.IdMesa == mesa.IdMesa ? "drop-target" : "") @(canchaFinalizada ? "cancha-finalizada" : "")"
                         style="@ObtenerEstiloMesaCard(mesa, colorFondo)"
                         draggable="@(esDelivery ? "false" : "true")"
                         @ondragstart="() => OnDragStart(mesa)"
                         @ondragstart:stopPropagation="true"
                         @ondragend="OnDragEnd"
                         @ondragover:preventDefault="true"
                         @ondragenter="() => OnDragEnter(mesa)"
                         @ondragleave="OnDragLeave"
                         @ondrop="() => OnDrop(mesa)"
                         @ondrop:stopPropagation="true"
                         @onclick="() => SeleccionarMesa(mesa)"
                         @ondblclick="() => AbrirDetalleCancha(mesa, reservaEnCurso)"
                         @oncontextmenu="(e) => MostrarMenuContextual(e, mesa)"
                         @oncontextmenu:preventDefault>
                        
                        @* Visualizaci√≥n de mesas unidas - como cuadros conectados *@
                        @if (tieneMesasUnidas)
                        {
                            <div class="mesas-unidas-visual">
                                <div class="mesa-mini">@mesa.Numero</div>
                                @foreach (var mesaUnida in mesasUnidasList)
                                {
                                    <span class="mesa-mini-plus">+</span>
                                    <div class="mesa-mini">@mesaUnida.Numero</div>
                                }
                            </div>
                        }
                        else
                        {
                        @* Si es delivery sin imagen, mostrar icono grande de delivery *@
                        @if (esDelivery && !tieneImagen)
                        {
                            <i class="bi bi-bag-check" style="font-size: 2rem; opacity: 0.9;"></i>
                        }
                        
                        <div class="mesa-numero @(tieneImagen ? "con-imagen" : "")">
                            @if (esDelivery)
                            {
                                <span class="delivery-badge">@mesa.Numero</span>
                            }
                            else
                            {
                                @mesa.Numero
                            }
                        </div>
                        }
                        
                        @if (pedidoActivo != null)
                        {
                            <div class="mesa-total">@pedidoActivo.Total.ToString("N0")</div>
                            @if (pedidoActivo.MontoPagado > 0)
                            {
                                <div class="mesa-pendiente">Pend: @pedidoActivo.SaldoPendiente.ToString("N0")</div>
                            }
                            @* Tiempo transcurrido desde inicio del pedido *@
                            @if (pedidoActivo.HoraInicio.HasValue)
                            {
                                var tiempoTranscurrido = DateTime.Now - pedidoActivo.HoraInicio.Value;
                                <div class="mesa-tiempo" title="Tiempo en mesa">
                                    <i class="bi bi-stopwatch"></i> @tiempoTranscurrido.ToString(@"hh\:mm")
                                </div>
                            }
                        }
                        else if (_modoCanchas && reservaEnCurso != null)
                        {
                            @* MODO CANCHAS: Mostrar icono/imagen primero, tiempo abajo *@
                            var inicioRes = reservaEnCurso.FechaReserva.Date.Add(reservaEnCurso.HoraInicio);
                            var tiempoRestante = ObtenerTiempoRestanteCancha(reservaEnCurso);
                            var tiempoBajo = _tiemposRestantes.TryGetValue(reservaEnCurso.IdReserva, out var t) && t <= TimeSpan.FromMinutes(_config?.CanchasMinutosAlerta ?? 5) && t > TimeSpan.Zero;
                            var tiempoAgotado = _tiemposRestantes.TryGetValue(reservaEnCurso.IdReserva, out var ta) && ta <= TimeSpan.Zero;
                            var tiempoTranscurrido = DateTime.Now > inicioRes ? DateTime.Now - inicioRes : TimeSpan.Zero;
                            
                            @* Nombre de cancha arriba *@
                            <div class="cancha-nombre">@(mesa.Nombre ?? $"Cancha {mesa.Numero}")</div>
                            
                            @* Tiempo transcurrido en grande debajo del icono *@
                            <div class="cancha-tiempo-transcurrido">
                                <i class="bi bi-play-circle me-1"></i>@tiempoTranscurrido.ToString(@"hh\:mm\:ss")
                            </div>
                            
                            @* Tiempo restante abajo *@
                            <div class="cancha-tiempo @(tiempoAgotado ? "tiempo-agotado" : tiempoBajo ? "tiempo-bajo" : "")" title="Tiempo restante">
                                <i class="bi bi-hourglass-split me-1"></i>@tiempoRestante
                            </div>
                            
                            @* Nombre del cliente *@
                            @if (!string.IsNullOrEmpty(reservaEnCurso.NombreCliente))
                            {
                                <div class="cancha-cliente">@reservaEnCurso.NombreCliente</div>
                            }
                        }
                        else if (!string.IsNullOrEmpty(mesa.Nombre))
                        {
                            <div class="mesa-nombre">@mesa.Nombre</div>
                        }
                    </div>
                    }
                }
            </div>
        }

        <!-- ========== MEN√ö CONTEXTUAL (CLIC DERECHO) ========== -->
        @if (_mostrarMenuContextual && _mesaMenuContextual != null)
        {
            var tieneMesasUnidasCtx = _mesas.Any(m => m.IdMesaPrincipal == _mesaMenuContextual.IdMesa);
            var pedidoMesaCtx = _pedidosActivos.FirstOrDefault(p => p.IdMesa == _mesaMenuContextual.IdMesa);
            
            <div class="menu-contextual-overlay" @onclick="CerrarMenuContextual"></div>
            <div class="menu-contextual" style="left: @(_menuContextualX)px; top: @(_menuContextualY)px;">
                <div class="menu-contextual-header">
                    <i class="bi bi-grid-3x3-gap me-2"></i>Mesa @_mesaMenuContextual.Numero
                </div>
                
                @if (tieneMesasUnidasCtx)
                {
                    var mesasUnidasCtx = _mesas.Where(m => m.IdMesaPrincipal == _mesaMenuContextual.IdMesa).ToList();
                    <div class="menu-contextual-info">
                        <small class="text-muted">Unida con: @string.Join(", ", mesasUnidasCtx.Select(m => m.Numero))</small>
                    </div>
                    <button class="menu-contextual-item text-danger" @onclick="SepararMesasContextual">
                        <i class="bi bi-scissors me-2"></i>Separar Mesas
                    </button>
                }
                else if (_mesaMenuContextual.Tipo != "Delivery")
                {
                    <button class="menu-contextual-item text-primary" @onclick="IniciarUnionDesdeContextMenu">
                        <i class="bi bi-link-45deg me-2"></i>Unir con otra mesa...
                    </button>
                }
                
                <hr class="my-1" />
                
                @* Cambiar forma de la mesa (disponible para todos incluyendo deliverys) *@
                <div class="menu-contextual-submenu">
                        <small class="text-muted px-3">Forma:</small>
                        <div class="d-flex gap-1 px-2 py-1">
                            <button class="btn btn-sm @(_mesaMenuContextual.Forma == "Cuadrado" ? "btn-primary" : "btn-outline-secondary")" 
                                    title="Cuadrado" @onclick='() => CambiarFormaMesa("Cuadrado")'>
                                <i class="bi bi-square"></i>
                            </button>
                            <button class="btn btn-sm @(_mesaMenuContextual.Forma == "Circulo" ? "btn-primary" : "btn-outline-secondary")" 
                                    title="C√≠rculo" @onclick='() => CambiarFormaMesa("Circulo")'>
                                <i class="bi bi-circle"></i>
                            </button>
                            <button class="btn btn-sm @(_mesaMenuContextual.Forma == "Rectangulo" ? "btn-primary" : "btn-outline-secondary")" 
                                    title="Rect√°ngulo" @onclick='() => CambiarFormaMesa("Rectangulo")'>
                                <i class="bi bi-aspect-ratio"></i>
                            </button>
                            <button class="btn btn-sm @(_mesaMenuContextual.Forma == "Oval" ? "btn-primary" : "btn-outline-secondary")" 
                                    title="Oval" @onclick='() => CambiarFormaMesa("Oval")'>
                                <i class="bi bi-record-circle"></i>
                            </button>
                        </div>
                    </div>
                    <hr class="my-1" />
                
                <button class="menu-contextual-item" @onclick="() => { CerrarMenuContextual(); SeleccionarMesa(_mesaMenuContextual); }">
                    <i class="bi bi-hand-index me-2"></i>Seleccionar Mesa
                </button>
                
                @if (pedidoMesaCtx != null)
                {
                    <button class="menu-contextual-item" @onclick="() => { CerrarMenuContextual(); _mesaSeleccionada = _mesaMenuContextual; MostrarConfirmarCerrarMesa(); }">
                        <i class="bi bi-x-circle me-2"></i>Cerrar Mesa
                    </button>
                }
            </div>
        }

        <!-- Resumen r√°pido -->
        <div class="resumen-mesas px-2 py-2 border-top mt-auto">
            <div class="d-flex justify-content-between small">
                <span class="text-success"><i class="bi bi-circle-fill me-1"></i>@_mesasFiltradas.Count(m => m.Estado == "Libre" && !_pedidosActivos.Any(p => p.IdMesa == m.IdMesa)) Libres</span>
                <span class="text-danger"><i class="bi bi-circle-fill me-1"></i>@_pedidosActivos.Count Ocupadas</span>
                <span class="text-primary fw-bold">Total: Gs @_pedidosActivos.Sum(p => p.Total).ToString("N0")</span>
            </div>
        </div>

        <!-- ========== ALERTAS DE COCINA ========== -->
        @if (_modoRestaurante && (_itemsPendientesCocina > 0 || _itemsEnPreparacion > 0 || _itemsListosServir > 0))
        {
            <div class="alertas-cocina px-2 py-2 border-top">
                <div class="d-flex align-items-center gap-2 mb-1">
                    <i class="bi bi-fire text-danger"></i>
                    <small class="fw-bold">Estado Cocina:</small>
                    <button class="btn btn-sm p-0 ms-1" @onclick="ToggleSonidosCocina" 
                            title="@(_sonidosCocinaActivo ? "Sonidos activados - Click para silenciar" : "Sonidos desactivados - Click para activar")">
                        @if (_sonidosCocinaActivo)
                        {
                            <i class="bi bi-volume-up-fill text-success"></i>
                        }
                        else
                        {
                            <i class="bi bi-volume-mute-fill text-muted"></i>
                        }
                    </button>
                    <a href="/cocina" class="ms-auto small text-decoration-none" title="Abrir Pantalla Cocina">
                        <i class="bi bi-box-arrow-up-right"></i>
                    </a>
                </div>
                <div class="d-flex gap-2 flex-wrap">
                    @if (_itemsPendientesCocina > 0)
                    {
                        <span class="badge bg-warning text-dark d-flex align-items-center gap-1" 
                              style="@(_itemsPendientesCocina > 5 ? "animation: pulse-warning 1s infinite;" : "")">
                            <i class="bi bi-hourglass-split"></i>
                            @_itemsPendientesCocina Pendientes
                        </span>
                    }
                    @if (_itemsEnPreparacion > 0)
                    {
                        <span class="badge bg-danger d-flex align-items-center gap-1"
                              style="animation: pulse-danger 1.5s infinite;">
                            <i class="bi bi-fire"></i>
                            @_itemsEnPreparacion En Prep.
                        </span>
                    }
                    @if (_itemsListosServir > 0)
                    {
                        <span class="badge bg-success d-flex align-items-center gap-1 blink-success">
                            <i class="bi bi-check-circle-fill"></i>
                            @_itemsListosServir ¬°LISTOS!
                        </span>
                    }
                </div>
                
                @* ========== DETALLE POR MESA - PENDIENTES ========== *@
                @if (_itemsPendientesCocina > 0 && _detallesPendientes.Any())
                {
                    <div class="pendientes-detalle mt-1 ps-2 border-start border-warning border-2">
                        <small class="text-warning fw-bold">Esperando cocina:</small>
                        @foreach (var item in _detallesPendientes.Take(3))
                        {
                            <small class="d-block text-warning-emphasis">
                                <i class="bi bi-clock"></i> 
                                <strong>@item.Mesa:</strong> @item.Descripcion
                            </small>
                        }
                        @if (_detallesPendientes.Count > 3)
                        {
                            <small class="text-muted">...y @(_detallesPendientes.Count - 3) m√°s</small>
                        }
                    </div>
                }

                @* ========== DETALLE POR MESA - EN PREPARACI√ìN ========== *@
                @if (_itemsEnPreparacion > 0 && _detallesEnPreparacion.Any())
                {
                    <div class="preparacion-detalle mt-1 ps-2 border-start border-danger border-2">
                        <small class="text-danger fw-bold">üî• En cocina:</small>
                        @foreach (var item in _detallesEnPreparacion.Take(3))
                        {
                            <small class="d-block text-danger-emphasis">
                                <i class="bi bi-fire"></i> 
                                <strong>@item.Mesa:</strong> @item.Descripcion
                            </small>
                        }
                        @if (_detallesEnPreparacion.Count > 3)
                        {
                            <small class="text-muted">...y @(_detallesEnPreparacion.Count - 3) m√°s</small>
                        }
                    </div>
                }

                @* ========== DETALLE POR MESA - LISTOS ========== *@
                @if (_itemsListosServir > 0 && _detallesListosServir.Any())
                {
                    <div class="listos-detalle mt-1 ps-2 border-start border-success border-2">
                        <small class="text-success fw-bold">‚úì ¬°Para servir!</small>
                        @foreach (var item in _detallesListosServir.Take(5))
                        {
                            <small class="d-block text-success">
                                <i class="bi bi-check-circle-fill"></i> 
                                <strong>@item.Mesa:</strong> @item.Descripcion
                            </small>
                        }
                        @if (_detallesListosServir.Count > 5)
                        {
                            <small class="text-muted">...y @(_detallesListosServir.Count - 5) m√°s</small>
                        }
                    </div>
                }
            </div>
        }
    </div>

    <!-- ========== PANEL CENTRAL: PEDIDO (30%) ========== -->
    @if (_mesaSeleccionada != null)
    {
        <div class="panel-pedido @(!_mostrarAgenda ? "agenda-oculta" : "") @(_ocultarPanelMesas ? "mesas-expandido" : "")">
            <!-- √Årea scrolleable -->
            <div class="panel-pedido-scroll">
                <!-- Encabezado del pedido -->
                <div class="pedido-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="d-flex align-items-center gap-2">
                            <!-- Bot√≥n volver a mesas (visible cuando panel mesas est√° oculto) -->
                            @if (_ocultarPanelMesas)
                            {
                                <button class="btn btn-sm btn-primary" @onclick="MostrarPanelMesas" title="Volver a @_terminoEspacioPlural">
                                    <i class="bi bi-arrow-left me-1"></i>@_terminoEspacioPlural
                                </button>
                            }
                            <div>
                                <h5 class="mb-0">
                                    <i class="bi @(_mesaSeleccionada.Icono ?? "bi-grid") me-2"></i>
                                    @_mesaSeleccionada.TextoMostrar
                                </h5>
                                @if (_pedidoActual != null && _pedidoActual.IdPedido > 0)
                                {
                                    <small class="text-muted">
                                        Pedido #@_pedidoActual.IdPedido ¬∑ @_pedidoActual.TiempoTranscurridoTexto
                                    </small>
                                }
                            </div>
                        </div>
                        <div class="d-flex gap-1">
                            <!-- Bot√≥n para ocultar mesas y expandir pedido -->
                            @if (!_ocultarPanelMesas)
                            {
                                <button class="btn btn-sm btn-outline-primary d-md-none" @onclick="OcultarPanelMesas" title="Expandir pedido">
                                    <i class="bi bi-arrows-fullscreen"></i>
                                </button>
                            }
                            <button class="btn btn-sm btn-outline-secondary" @onclick="CerrarPanelPedido">
                                <i class="bi bi-x-lg"></i>
                            </button>
                        </div>
                    </div>
                </div>

            <!-- B√∫squeda de productos -->
            <div class="pedido-busqueda">
                <div class="input-group input-group-sm">
                    <span class="input-group-text"><i class="bi bi-search"></i></span>
                    <input type="text" class="form-control" placeholder="Buscar producto..." 
                           @bind="_busquedaProducto" @bind:event="oninput" @onkeyup="BuscarProductos" />
                    @if (!string.IsNullOrEmpty(_busquedaProducto))
                    {
                        <button class="btn btn-outline-secondary" @onclick="LimpiarBusqueda">
                            <i class="bi bi-x"></i>
                        </button>
                    }
                </div>

                <!-- Categor√≠as r√°pidas -->
                @if (_clasificaciones.Any())
                {
                    <div class="categorias-rapidas mt-2">
                        <button class="btn btn-xs @(_clasificacionSeleccionada == null ? "btn-primary" : "btn-outline-secondary")"
                                @onclick="() => FiltrarClasificacion(null)">
                            Todas
                        </button>
                        @foreach (var cat in _clasificaciones.Take(6))
                        {
                            <button class="btn btn-xs @(_clasificacionSeleccionada == cat.IdClasificacion ? "btn-primary" : "btn-outline-secondary")"
                                    @onclick="() => FiltrarClasificacion(cat.IdClasificacion)">
                                @cat.Nombre
                            </button>
                        }
                    </div>
                }
            </div>

            <!-- Grid de productos con im√°genes -->
            <div class="productos-grid">
                @if (_productosFiltrados.Any())
                {
                    @foreach (var prod in _productosFiltrados.Take(24))
                    {
                        <div class="producto-card" @onclick="() => AgregarProducto(prod)">
                            @if (!string.IsNullOrEmpty(prod.Foto))
                            {
                                <div class="producto-imagen" style="background-image: url('@prod.Foto')"></div>
                            }
                            else
                            {
                                <div class="producto-imagen producto-sin-imagen">
                                    <i class="bi bi-box-seam"></i>
                                </div>
                            }
                            <div class="producto-info">
                                <div class="producto-nombre">@prod.Descripcion</div>
                                <div class="producto-precio">@prod.PrecioUnitarioGs.ToString("N0")</div>
                            </div>
                        </div>
                    }
                }
                else
                {
                    <div class="text-center text-muted py-4 w-100">
                        <i class="bi bi-box-seam fs-3 d-block mb-2"></i>
                        @if (!string.IsNullOrEmpty(_busquedaProducto))
                        {
                            <span>No se encontraron productos</span>
                        }
                        else
                        {
                            <span>Busque o seleccione una categor√≠a</span>
                        }
                    </div>
                }
            </div>

            <!-- Detalle del pedido -->
            <div class="pedido-detalle">
                <div class="detalle-header">
                    <span><i class="bi bi-receipt me-1"></i>Detalle (@_detallesPedido.Count items)</span>
                    @if (_detallesPedido.Any(d => !d.Facturado))
                    {
                        <button class="btn btn-xs btn-outline-primary" @onclick="SeleccionarTodos">
                            <i class="bi bi-check-all"></i> Sel. todos
                        </button>
                    }
                </div>
                
                <div class="detalle-items">
                    @if (_detallesPedido.Any())
                    {
                        @foreach (var det in _detallesPedido.OrderByDescending(d => d.FechaCreacion))
                        {
                            <div class="detalle-item @(det.Facturado ? "facturado" : "") @(_itemsSeleccionados.Contains(det.IdPedidoDetalle) ? "seleccionado" : "") @GetClaseEstadoCocina(det)">
                                @if (!det.Facturado)
                                {
                                    <input type="checkbox" class="form-check-input me-2" 
                                           checked="@_itemsSeleccionados.Contains(det.IdPedidoDetalle)"
                                           @onchange="() => ToggleSeleccionItem(det.IdPedidoDetalle)" />
                                }
                                else
                                {
                                    <i class="bi bi-check-circle-fill text-success me-2" title="Ya facturado"></i>
                                }
                                
                                @* ========== INDICADOR VISUAL ESTADO COCINA ========== *@
                                @if (det.EnviadoCocina)
                                {
                                    <div class="estado-cocina-badge me-2" title="@GetTituloEstadoCocina(det)">
                                        @switch (det.Estado)
                                        {
                                            case "Pendiente":
                                                <span class="badge-cocina pendiente"><i class="bi bi-hourglass-split"></i></span>
                                                break;
                                            case "EnPreparacion":
                                                <span class="badge-cocina preparando"><i class="bi bi-fire"></i></span>
                                                break;
                                            case "Listo":
                                                <span class="badge-cocina listo"><i class="bi bi-check-circle-fill"></i></span>
                                                break;
                                            case "Entregado":
                                                <span class="badge-cocina entregado"><i class="bi bi-hand-thumbs-up-fill"></i></span>
                                                break;
                                        }
                                    </div>
                                }
                                else if (!det.Facturado)
                                {
                                    <div class="estado-cocina-badge me-2" title="No enviado a cocina">
                                        <span class="badge-cocina no-enviado"><i class="bi bi-clock"></i></span>
                                    </div>
                                }
                                
                                <div class="item-info flex-grow-1">
                                    <div class="item-nombre">@det.Descripcion</div>
                                    <div class="item-detalle">
                                        @det.Cantidad x @det.PrecioUnitario.ToString("N0")
                                        @if (det.EnviadoCocina && !string.IsNullOrEmpty(det.Estado) && det.Estado != "Entregado")
                                        {
                                            <span class="ms-2 estado-texto-@det.Estado.ToLower()">
                                                @GetTextoEstadoCocina(det)
                                            </span>
                                        }
                                    </div>
                                    @* Input de notas/comentarios para cocina (ej: SIN CEBOLLA) *@
                                    @if (!det.Facturado && !det.EnviadoCocina)
                                    {
                                        <input type="text" class="form-control form-control-sm notas-cocina-input mt-1" 
                                               placeholder="Notas cocina (ej: sin cebolla)"
                                               @bind="det.NotasCocina" @bind:event="oninput"
                                               @onclick:stopPropagation="true" />
                                    }
                                    else if (!string.IsNullOrWhiteSpace(det.NotasCocina))
                                    {
                                        <div class="notas-cocina-texto mt-1">
                                            <i class="bi bi-chat-left-text me-1"></i>@det.NotasCocina
                                        </div>
                                    }
                                </div>
                                <div class="item-importe">@det.Importe.ToString("N0")</div>
                                @if (!det.Facturado)
                                {
                                    <div class="item-acciones">
                                        <button class="btn btn-xs btn-outline-secondary" @onclick="() => CambiarCantidad(det, -1)" @onclick:stopPropagation="true">
                                            <i class="bi bi-dash"></i>
                                        </button>
                                        <button class="btn btn-xs btn-outline-secondary" @onclick="() => CambiarCantidad(det, 1)" @onclick:stopPropagation="true">
                                            <i class="bi bi-plus"></i>
                                        </button>
                                        <button class="btn btn-xs btn-outline-danger" @onclick="() => EliminarDetalle(det)" @onclick:stopPropagation="true">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </div>
                                }
                            </div>
                        }
                    }
                    else
                    {
                        <div class="text-center text-muted py-3">
                            <i class="bi bi-cart3 d-block mb-2"></i>
                            Pedido vac√≠o
                        </div>
                    }
                </div>
            </div>
            </div> <!-- Fin panel-pedido-scroll -->

            <!-- Totales y acciones -->
            <div class="pedido-footer">
                <div class="totales-grid">
                    <div class="total-row">
                        <span><i class="bi bi-receipt me-1"></i>Total Pedido:</span>
                        <span class="fw-bold">@_totalPedidoGeneral.ToString("N0")</span>
                    </div>
                    @if (_montoFacturadoVentas > 0)
                    {
                        <div class="total-row text-success">
                            <span><i class="bi bi-check-circle me-1"></i>Ya Pagado:</span>
                            <span class="fw-semibold">@_montoFacturadoVentas.ToString("N0")</span>
                        </div>
                    }
                    @if (_totalPedido > 0)
                    {
                        <div class="total-row total-pendiente">
                            <span><i class="bi bi-clock me-1"></i>Pendiente:</span>
                            <span class="fw-bold">@_totalPedido.ToString("N0")</span>
                        </div>
                    }
                    else if (_totalPedidoGeneral > 0 && _montoFacturadoVentas >= _totalPedidoGeneral)
                    {
                        <div class="total-row text-success">
                            <span><i class="bi bi-check-circle-fill me-1"></i>PAGADO COMPLETO</span>
                        </div>
                    }
                    @if (_itemsSeleccionados.Any())
                    {
                        <div class="total-row total-seleccionado">
                            <span>Seleccionado:</span>
                            <span>@_totalSeleccionado.ToString("N0")</span>
                        </div>
                    }
                </div>

                <div class="acciones-pedido">
                    <button class="btn btn-outline-secondary btn-sm" @onclick="GuardarPedido" disabled="@_guardando">
                        @if (_guardando)
                        {
                            <span class="spinner-border spinner-border-sm"></span>
                        }
                        else
                        {
                            <i class="bi bi-save me-1"></i>
                        }
                        Guardar
                    </button>
                    
                    @if (_detallesPedido.Any(d => !d.EnviadoCocina))
                    {
                        <button class="btn btn-warning btn-sm" @onclick="ImprimirComanda" disabled="@_imprimiendoComanda" title="Enviar a cocina/barra">
                            @if (_imprimiendoComanda)
                            {
                                <span class="spinner-border spinner-border-sm"></span>
                            }
                            else
                            {
                                <i class="bi bi-fire me-1"></i>
                            }
                            Comanda
                        </button>
                    }
                    
                    @if (_detallesPedido.Any(d => d.EnviadoCocina))
                    {
                        <button class="btn btn-outline-warning btn-sm" @onclick="ReimprimirComanda" disabled="@_reimprimiendoComanda" title="Reimprimir comanda enviada">
                            @if (_reimprimiendoComanda)
                            {
                                <span class="spinner-border spinner-border-sm"></span>
                            }
                            else
                            {
                                <i class="bi bi-printer me-1"></i>
                            }
                            Reimprimir
                        </button>
                    }
                    
                    @if (_detallesPedido.Any())
                    {
                        <button class="btn btn-outline-info btn-sm" @onclick="ImprimirPedidoCliente" disabled="@_imprimiendoPedido" title="Imprimir comprobante de pedido para el cliente">
                            @if (_imprimiendoPedido)
                            {
                                <span class="spinner-border spinner-border-sm"></span>
                            }
                            else
                            {
                                <i class="bi bi-receipt me-1"></i>
                            }
                            Ticket
                        </button>
                    }
                    
                    @if (_detallesPedido.Any(d => !d.Facturado))
                    {
                        <button class="btn btn-success btn-sm flex-grow-1" @onclick="AbrirModalCobrar">
                            <i class="bi bi-cash-coin me-1"></i>
                            Cobrar @(_itemsSeleccionados.Any() ? $"({_itemsSeleccionados.Count})" : "Todo")
                        </button>
                    }
                    
                    @if (_pedidoActual != null && _pedidoActual.IdPedido > 0)
                    {
                        <button class="btn btn-outline-danger btn-sm" @onclick="MostrarConfirmarCerrarMesa" title="Cerrar mesa y descontar stock">
                            <i class="bi bi-door-closed me-1"></i>Cerrar
                        </button>
                    }
                </div>
            </div>
        </div>
    }

    <!-- ========== PANEL DERECHO: AGENDA/GRILLA (30%) ========== -->
    <div class="panel-agenda @(_mostrarAgenda ? "" : "colapsado")">
        <div class="agenda-toggle" @onclick="ToggleAgenda" title="@(_mostrarAgenda ? "Ocultar agenda" : "Ver agenda del d√≠a")">
            <i class="bi @(_mostrarAgenda ? "bi-chevron-right" : "bi-chevron-left")"></i>
        </div>
        
        @if (_mostrarAgenda)
        {
            <div class="agenda-contenido">
                <div class="agenda-header">
                    <div class="d-flex justify-content-between align-items-center w-100">
                        <h6 class="mb-0">
                            <i class="bi @(_vistaGrilla ? "bi-grid-3x3-gap" : "bi-list-ul") me-2"></i>
                            @if (_vistaGrilla)
                            {
                                <span>Grilla de Disponibilidad</span>
                            }
                            else
                            {
                                <span>Agenda @(_fechaAgenda.Date == _fechaCaja.Date ? "del D√≠a" : _fechaAgenda.ToString("dd/MM"))</span>
                            }
                        </h6>
                        <div class="d-flex align-items-center gap-2">
                            <span class="badge bg-primary">@(_vistaGrilla ? _reservasFechaGrilla.Count : _reservasHoy.Count)</span>
                            <button class="btn btn-sm @(_vistaGrilla ? "btn-primary" : "btn-outline-secondary")" 
                                    @onclick="() => { _vistaGrilla = !_vistaGrilla; if (_vistaGrilla) CargarReservasFechaGrilla(); }" 
                                    title="@(_vistaGrilla ? "Ver lista" : "Ver grilla")">
                                <i class="bi @(_vistaGrilla ? "bi-list-ul" : "bi-grid-3x3-gap")"></i>
                            </button>
                        </div>
                    </div>
                </div>
                
                @* ========== VISTA GRILLA (para Complejos Deportivos) ========== *@
                @if (_vistaGrilla)
                {
                    <div class="grilla-controles mb-2">
                        <div class="d-flex flex-column align-items-center gap-2">
                            @* Selector de mesa/cancha *@
                            <div class="d-flex align-items-center gap-2 w-100 justify-content-center">
                                <label class="form-label mb-0 small text-muted"><i class="bi bi-grid-3x3-gap me-1"></i></label>
                                <select class="form-select form-select-sm" style="width: auto; min-width: 150px;"
                                        @onchange="@(e => { _mesaSeleccionadaGrilla = string.IsNullOrEmpty(e.Value?.ToString()) ? null : int.Parse(e.Value.ToString()!); })">
                                    <option value="">-- Todas --</option>
                                    @foreach (var mesa in _mesasFiltradas.OrderBy(m => m.Nombre))
                                    {
                                        <option value="@mesa.IdMesa" selected="@(_mesaSeleccionadaGrilla == mesa.IdMesa)">@(mesa.TextoMostrar ?? mesa.Nombre)</option>
                                    }
                                </select>
                            </div>
                            @* Controles de fecha *@
                            <div class="d-flex align-items-center gap-2">
                                <button class="btn btn-sm btn-outline-secondary" @onclick="() => CambiarFechaGrilla(-1)" title="D√≠a anterior">
                                    <i class="bi bi-chevron-left"></i>
                                </button>
                                <input type="date" class="form-control form-control-sm" style="width: 130px; text-align: center;"
                                       value="@_fechaGrilla.ToString("yyyy-MM-dd")"
                                       @onchange="@(e => { _fechaGrilla = DateTime.Parse(e.Value?.ToString() ?? _fechaCaja.ToString("yyyy-MM-dd")); CargarReservasFechaGrilla(); })" />
                                <button class="btn btn-sm btn-outline-secondary" @onclick="() => CambiarFechaGrilla(1)" title="D√≠a siguiente">
                                    <i class="bi bi-chevron-right"></i>
                                </button>
                                <button class="btn btn-sm @(_fechaGrilla.Date == _fechaCaja.Date ? "btn-primary" : "btn-outline-primary")" 
                                        @onclick="() => { _fechaGrilla = _fechaCaja; CargarReservasFechaGrilla(); }" title="Ir a fecha de caja">
                                    <i class="bi bi-calendar-check me-1"></i>Caja
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="grilla-disponibilidad @(_mesaSeleccionadaGrilla.HasValue ? "vista-individual" : "")">
                        @* Encabezado: columnas de mesas/canchas *@
                        <div class="grilla-header">
                            <div class="grilla-celda-hora">Hora</div>
                            @foreach (var mesa in ObtenerMesasParaGrilla())
                            {
                                <div class="grilla-celda-header @(_mesaSeleccionadaGrilla.HasValue ? "header-individual" : "")" title="@mesa.Nombre">
                                    <span class="grilla-header-texto">@(mesa.TextoMostrar ?? mesa.Nombre)</span>
                                </div>
                            }
                        </div>
                        
                        @* Filas: horarios *@
                        <div class="grilla-body">
                            @{
                                var horaActual = _horaInicioGrilla;
                                while (horaActual < _horaFinGrilla)
                                {
                                    var horaFila = horaActual;
                                    var esHoraActualReal = DateTime.Today == _fechaGrilla.Date && 
                                                          DateTime.Now.TimeOfDay >= horaFila && 
                                                          DateTime.Now.TimeOfDay < horaFila.Add(TimeSpan.FromMinutes(_intervaloMinutos));
                                    
                                    <div class="grilla-fila @(esHoraActualReal ? "hora-actual" : "")">
                                        <div class="grilla-celda-hora">
                                            @horaFila.ToString(@"hh\:mm")
                                        </div>
                                        @foreach (var mesa in ObtenerMesasParaGrilla())
                                        {
                                            var reservaEnCelda = GetReservaEnHorario(mesa.IdMesa, horaFila);
                                            var esPasado = _fechaGrilla.Date < DateTime.Today || 
                                                          (_fechaGrilla.Date == DateTime.Today && horaFila < DateTime.Now.TimeOfDay);
                                            
                                            <div class="grilla-celda @(_mesaSeleccionadaGrilla.HasValue ? "celda-individual" : "") @(reservaEnCelda != null ? GetClaseCeldaReserva(reservaEnCelda) : (esPasado ? "pasado" : "libre"))"
                                                 @ondblclick="() => CeldaGrillaDobleClick(mesa, horaFila, reservaEnCelda)"
                                                 title="@GetTituloCelda(mesa, horaFila, reservaEnCelda)">
                                                @if (reservaEnCelda != null)
                                                {
                                                    <span class="grilla-celda-cliente @(_mesaSeleccionadaGrilla.HasValue ? "cliente-individual" : "")">@TruncarTextoGrilla(reservaEnCelda.NombreCliente, _mesaSeleccionadaGrilla.HasValue ? 30 : 10)</span>
                                                    <span class="grilla-celda-hora-reserva">@reservaEnCelda.HoraInicio.ToString("hh':'mm") - @(reservaEnCelda.HoraFin?.ToString("hh':'mm") ?? "")</span>
                                                    @if (_mesaSeleccionadaGrilla.HasValue && !string.IsNullOrEmpty(reservaEnCelda.Telefono))
                                                    {
                                                        <span class="grilla-celda-telefono"><i class="bi bi-telephone-fill me-1"></i>@reservaEnCelda.Telefono</span>
                                                    }
                                                }
                                            </div>
                                        }
                                    </div>
                                    horaActual = horaActual.Add(TimeSpan.FromMinutes(_intervaloMinutos));
                                }
                            }
                        </div>
                    </div>
                    
                    @* Leyenda *@
                    <div class="grilla-leyenda mt-2">
                        <div class="leyenda-item"><span class="leyenda-color libre"></span> Libre</div>
                        <div class="leyenda-item"><span class="leyenda-color confirmada"></span> Confirmada</div>
                        <div class="leyenda-item"><span class="leyenda-color en-curso"></span> En Curso</div>
                        <div class="leyenda-item"><span class="leyenda-color completada"></span> Completada</div>
                    </div>
                }
                else
                {
                    @* ========== VISTA LISTA (original) ========== *@
                    @* Controles de fecha para agenda *@
                    <div class="agenda-controles mb-2">
                        <div class="d-flex align-items-center justify-content-center gap-2">
                            <button class="btn btn-sm btn-outline-secondary" @onclick="() => CambiarFechaAgenda(-1)" title="D√≠a anterior">
                                <i class="bi bi-chevron-left"></i>
                            </button>
                            <input type="date" class="form-control form-control-sm" style="width: 130px; text-align: center;"
                                   value="@_fechaAgenda.ToString("yyyy-MM-dd")"
                                   @onchange="@(e => { _fechaAgenda = DateTime.Parse(e.Value?.ToString() ?? _fechaCaja.ToString("yyyy-MM-dd")); _ = CargarReservasAgenda(); })" />
                            <button class="btn btn-sm btn-outline-secondary" @onclick="() => CambiarFechaAgenda(1)" title="D√≠a siguiente">
                                <i class="bi bi-chevron-right"></i>
                            </button>
                            <button class="btn btn-sm @(_fechaAgenda.Date == _fechaCaja.Date ? "btn-primary" : "btn-outline-primary")" 
                                    @onclick="() => { _fechaAgenda = _fechaCaja; _ = CargarReservasAgenda(); }" title="Ir a fecha de caja">
                                <i class="bi bi-calendar-check me-1"></i>Caja
                            </button>
                        </div>
                    </div>

                    @if (!_reservasHoy.Any())
                    {
                        <div class="text-center py-4 text-muted">
                            <i class="bi bi-calendar-x fs-2 d-block mb-2"></i>
                            <small>Sin reservas para @_fechaAgenda.ToString("dd/MM/yyyy")</small>
                        </div>
                    }
                    else
                    {
                        <div class="agenda-lista">
                            @foreach (var reserva in _reservasHoy.OrderBy(r => r.HoraInicio))
                            {
                                var esProxima = reserva.HoraInicio <= DateTime.Now.TimeOfDay.Add(TimeSpan.FromMinutes(30)) 
                                             && reserva.HoraInicio >= DateTime.Now.TimeOfDay.Add(TimeSpan.FromMinutes(-15));
                                var estaEnCurso = reserva.Estado == "EnCurso";
                                var estaCompletada = reserva.Estado == "Completada";
                                var mesaReserva = _mesas.FirstOrDefault(m => m.IdMesa == reserva.IdMesa);
                                
                                <div class="agenda-item @(estaEnCurso ? "en-curso" : "") @(esProxima && !estaEnCurso ? "proxima" : "") @(estaCompletada ? "completada" : "")">
                                    <div class="d-flex justify-content-between align-items-start">
                                        <div class="flex-grow-1" @onclick="() => SeleccionarMesaDesdeReserva(reserva)" style="cursor: pointer;">
                                            <div class="fw-bold small">
                                                <i class="bi bi-clock me-1"></i>
                                                @reserva.HoraInicio.ToString(@"hh\:mm")
                                                @if (reserva.HoraFin.HasValue)
                                                {
                                                    <span class="text-muted">- @reserva.HoraFin.Value.ToString(@"hh\:mm")</span>
                                                }
                                            </div>
                                            <div class="small">@reserva.NombreCliente</div>
                                            @if (!string.IsNullOrEmpty(reserva.Telefono))
                                            {
                                                <div class="text-muted small"><i class="bi bi-telephone me-1"></i>@reserva.Telefono</div>
                                            }
                                        </div>
                                        <div class="text-end">
                                            <span class="badge @GetBadgeClassReserva(reserva.Estado)">
                                                @(mesaReserva?.TextoMostrar ?? $"{_terminoEspacio} {reserva.IdMesa}")
                                            </span>
                                            <div class="small text-muted">@reserva.CantidadPersonas pers.</div>
                                            
                                            @if (estaEnCurso && reserva.HoraInicioReal.HasValue)
                                            {
                                                var tiempoEnMesa = DateTime.Now.TimeOfDay - reserva.HoraInicioReal.Value;
                                                <div class="badge bg-info mt-1">
                                                    <i class="bi bi-stopwatch me-1"></i>@tiempoEnMesa.ToString(@"hh\:mm")
                                                </div>
                                            }
                                            @if (estaCompletada && reserva.HoraInicioReal.HasValue && reserva.HoraFinReal.HasValue)
                                            {
                                                var tiempoTotal = reserva.HoraFinReal.Value - reserva.HoraInicioReal.Value;
                                                <div class="badge bg-secondary mt-1">
                                                    <i class="bi bi-clock-history me-1"></i>@tiempoTotal.ToString(@"hh\:mm")
                                                </div>
                                            }
                                        </div>
                                    </div>
                                    @if (!string.IsNullOrEmpty(reserva.Observaciones))
                                    {
                                        <div class="text-muted small mt-1 fst-italic">
                                            <i class="bi bi-chat-text me-1"></i>@reserva.Observaciones
                                        </div>
                                    }
                                    
                                    <div class="mt-2 d-flex gap-1">
                                        @if (reserva.Estado == "Confirmada")
                                        {
                                            <button class="btn btn-success btn-sm flex-grow-1" @onclick="() => IniciarReserva(reserva)" @onclick:stopPropagation="true">
                                                <i class="bi bi-play-fill me-1"></i>Iniciar
                                            </button>
                                            <button class="btn btn-outline-danger btn-sm" @onclick="() => CancelarReserva(reserva)" @onclick:stopPropagation="true" title="Cancelar">
                                                <i class="bi bi-x-lg"></i>
                                            </button>
                                        }
                                        @if (estaEnCurso)
                                        {
                                            <span class="text-muted small fst-italic">
                                                <i class="bi bi-info-circle me-1"></i>Se completa al cerrar mesa
                                            </span>
                                        }
                                    </div>
                                </div>
                            }
                        </div>
                    }
                }
                
                <div class="agenda-footer">
                    <a href="/reservas" class="btn btn-outline-primary btn-sm w-100">
                        <i class="bi bi-calendar-plus me-1"></i>Gestionar Reservas
                    </a>
                </div>
            </div>
        }
    </div>
</div>

<!-- ========== MODAL CONFIRMAR CERRAR MESA ========== -->
@if (_mostrarConfirmarCerrarMesa)
{
    <div class="modal fade show d-block" style="background: rgba(0,0,0,0.5);" @onclick="() => _mostrarConfirmarCerrarMesa = false">
        <div class="modal-dialog modal-dialog-centered" @onclick:stopPropagation="true">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title">
                        <i class="bi bi-exclamation-triangle me-2"></i>Cerrar Mesa
                    </h5>
                    <button type="button" class="btn-close btn-close-white" @onclick="() => _mostrarConfirmarCerrarMesa = false"></button>
                </div>
                <div class="modal-body">
                    @if (_itemsNoFacturados.Any())
                    {
                        <div class="alert alert-warning">
                            <i class="bi bi-exclamation-triangle me-2"></i>
                            <strong>Hay @_itemsNoFacturados.Count item(s) sin facturar</strong>
                            <p class="mb-0 small">Se descontar√° del stock autom√°ticamente.</p>
                        </div>
                        <div class="table-responsive" style="max-height: 200px;">
                            <table class="table table-sm table-striped mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th>Producto</th>
                                        <th class="text-end">Cant.</th>
                                        <th class="text-end">Importe</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var item in _itemsNoFacturados)
                                    {
                                        <tr>
                                            <td>@item.Descripcion</td>
                                            <td class="text-end">@item.Cantidad.ToString("N2")</td>
                                            <td class="text-end">@item.Importe.ToString("N0")</td>
                                        </tr>
                                    }
                                </tbody>
                                <tfoot>
                                    <tr class="fw-bold">
                                        <td colspan="2">Total sin facturar:</td>
                                        <td class="text-end text-danger">@_itemsNoFacturados.Sum(i => i.Importe).ToString("N0")</td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    }
                    else
                    {
                        <p>¬øEst√° seguro que desea cerrar esta mesa?</p>
                        <p class="text-success"><i class="bi bi-check-circle me-1"></i>Todos los items fueron facturados.</p>
                    }
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="() => _mostrarConfirmarCerrarMesa = false">
                        Cancelar
                    </button>
                    <button type="button" class="btn btn-danger" @onclick="CerrarMesaConfirmado" disabled="@_cerrando">
                        @if (_cerrando)
                        {
                            <span class="spinner-border spinner-border-sm me-1"></span>
                        }
                        <i class="bi bi-door-closed me-1"></i>
                        Cerrar Mesa
                    </button>
                </div>
            </div>
        </div>
    </div>
}

<!-- ========== MODAL SELECCIONAR MESA DESTINO ========== -->
@if (_mostrarSelectorMesaDestino && _mesaArrastrada != null)
{
    var mesasDisponibles = _mesas.Where(m => 
        m.IdMesa != _mesaArrastrada.IdMesa && 
        m.Tipo != "Delivery" && 
        !m.IdMesaPrincipal.HasValue &&
        !_mesas.Any(mu => mu.IdMesaPrincipal == m.IdMesa) // No tiene otras mesas unidas
    ).ToList();
    
    <div class="modal fade show d-block" style="background: rgba(0,0,0,0.6);" @onclick="CancelarSelectorMesaDestino">
        <div class="modal-dialog modal-dialog-centered modal-lg" @onclick:stopPropagation="true">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">
                        <i class="bi bi-link-45deg me-2"></i>Seleccionar Mesa para Unir con Mesa @_mesaArrastrada.Numero
                    </h5>
                    <button type="button" class="btn-close btn-close-white" @onclick="CancelarSelectorMesaDestino"></button>
                </div>
                <div class="modal-body">
                    @if (!mesasDisponibles.Any())
                    {
                        <div class="alert alert-warning">
                            <i class="bi bi-exclamation-triangle me-2"></i>No hay mesas disponibles para unir.
                        </div>
                    }
                    else
                    {
                        <p class="text-muted mb-3">Selecciona la mesa con la que quieres unir:</p>
                        <div class="row g-2">
                            @foreach (var mesa in mesasDisponibles)
                            {
                                var pedido = _pedidosActivos.FirstOrDefault(p => p.IdMesa == mesa.IdMesa);
                                <div class="col-4 col-md-3">
                                    <button class="btn w-100 p-3 @(pedido != null ? "btn-outline-danger" : "btn-outline-success")"
                                            @onclick="() => SeleccionarMesaDestino(mesa)">
                                        <div class="fw-bold fs-5">@mesa.Numero</div>
                                        @if (pedido != null)
                                        {
                                            <small class="text-danger">Gs @pedido.Total.ToString("N0")</small>
                                        }
                                        else
                                        {
                                            <small class="text-success">Libre</small>
                                        }
                                    </button>
                                </div>
                            }
                        </div>
                    }
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="CancelarSelectorMesaDestino">
                        <i class="bi bi-x-lg me-1"></i>Cancelar
                    </button>
                </div>
            </div>
        </div>
    </div>
}

<!-- ========== MODAL UNIR MESAS ========== -->
@if (_mostrarModalUnirMesas && _mesaArrastrada != null && _mesaDestino != null)
{
    var pedidoOrigen = _pedidosActivos.FirstOrDefault(p => p.IdMesa == _mesaArrastrada.IdMesa);
    var pedidoDestino = _pedidosActivos.FirstOrDefault(p => p.IdMesa == _mesaDestino.IdMesa);
    
    <div class="modal fade show d-block" style="background: rgba(0,0,0,0.6);" @onclick="CancelarUnion">
        <div class="modal-dialog modal-dialog-centered" @onclick:stopPropagation="true">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">
                        <i class="bi bi-link-45deg me-2"></i>Unir Mesas
                    </h5>
                    <button type="button" class="btn-close btn-close-white" @onclick="CancelarUnion"></button>
                </div>
                <div class="modal-body">
                    <div class="text-center mb-3">
                        <div class="d-flex align-items-center justify-content-center gap-3">
                            <div class="p-3 border rounded bg-light">
                                <i class="bi bi-table fs-2 text-primary"></i>
                                <div class="fw-bold">Mesa @_mesaArrastrada.Numero</div>
                                @if (pedidoOrigen != null)
                                {
                                    <small class="text-muted">Gs @pedidoOrigen.Total.ToString("N0")</small>
                                }
                                else
                                {
                                    <small class="text-success">Libre</small>
                                }
                            </div>
                            <i class="bi bi-arrow-right fs-3 text-primary"></i>
                            <div class="p-3 border rounded bg-light">
                                <i class="bi bi-table fs-2 text-success"></i>
                                <div class="fw-bold">Mesa @_mesaDestino.Numero</div>
                                @if (pedidoDestino != null)
                                {
                                    <small class="text-muted">Gs @pedidoDestino.Total.ToString("N0")</small>
                                }
                                else
                                {
                                    <small class="text-success">Libre</small>
                                }
                            </div>
                        </div>
                    </div>
                    
                    <div class="alert alert-info mb-0">
                        <i class="bi bi-info-circle me-2"></i>
                        @if (pedidoOrigen != null && pedidoDestino != null)
                        {
                            <span>Los pedidos de ambas mesas se <strong>fusionar√°n</strong> en la Mesa @_mesaDestino.Numero.</span>
                        }
                        else if (pedidoOrigen != null)
                        {
                            <span>El pedido de la Mesa @_mesaArrastrada.Numero se <strong>mover√°</strong> a la Mesa @_mesaDestino.Numero.</span>
                        }
                        else
                        {
                            <span>La Mesa @_mesaArrastrada.Numero quedar√° <strong>unida</strong> a la Mesa @_mesaDestino.Numero.</span>
                        }
                    </div>

                    @if (!string.IsNullOrEmpty(_mensajeUnion))
                    {
                        <div class="alert alert-danger mt-3 mb-0">
                            <i class="bi bi-exclamation-triangle me-2"></i>@_mensajeUnion
                        </div>
                    }
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="CancelarUnion">
                        <i class="bi bi-x-lg me-1"></i>Cancelar
                    </button>
                    <button type="button" class="btn btn-primary" @onclick="ConfirmarUnirMesas" disabled="@_uniendoMesas">
                        @if (_uniendoMesas)
                        {
                            <span class="spinner-border spinner-border-sm me-1"></span>
                        }
                        <i class="bi bi-link-45deg me-1"></i>Unir Mesas
                    </button>
                </div>
            </div>
        </div>
    </div>
}

<!-- ========== MODAL CORTES√çA DE LA CASA ========== -->
@if (_mostrarModalCortesia)
{
    <div class="modal fade show d-block" style="background: rgba(0,0,0,0.6);" @onclick="() => _mostrarModalCortesia = false">
        <div class="modal-dialog modal-dialog-centered" @onclick:stopPropagation="true">
            <div class="modal-content">
                <div class="modal-header bg-warning text-dark">
                    <h5 class="modal-title">
                        <i class="bi bi-gift me-2"></i>Cortes√≠a de la Casa
                    </h5>
                    <button type="button" class="btn-close" @onclick="CerrarModalCortesia"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle me-2"></i>
                        <strong>Saldo pendiente: Gs @_saldoPendienteCortesia.ToString("N0")</strong>
                        <p class="mb-0 small mt-1">Para cerrar la mesa como cortes√≠a, un usuario con permisos de administrador debe autorizar.</p>
                    </div>
                    
                    @if (!string.IsNullOrEmpty(_errorCortesia))
                    {
                        <div class="alert alert-danger py-2">
                            <i class="bi bi-exclamation-triangle me-1"></i>@_errorCortesia
                        </div>
                    }
                    
                    <div class="mb-3">
                        <label class="form-label">Usuario Autorizador</label>
                        <input type="text" class="form-control" @bind="_usuarioCortesia" placeholder="Nombre de usuario" />
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Contrase√±a</label>
                        <input type="password" class="form-control" @bind="_passwordCortesia" placeholder="Contrase√±a" 
                               @onkeypress="@(async (e) => { if (e.Key == "Enter") await ValidarYProcesarCortesia(); })" />
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Motivo de la Cortes√≠a <span class="text-danger">*</span></label>
                        <textarea class="form-control" rows="3" @bind="_motivoCortesia" 
                                  placeholder="Ej: Cliente frecuente, compensaci√≥n por demora, promoci√≥n especial..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="CerrarModalCortesia" disabled="@_validandoCortesia">
                        <i class="bi bi-x-lg me-1"></i>Cancelar
                    </button>
                    <button type="button" class="btn btn-warning" @onclick="ValidarYProcesarCortesia" 
                            disabled="@(_validandoCortesia || string.IsNullOrWhiteSpace(_usuarioCortesia) || string.IsNullOrWhiteSpace(_passwordCortesia) || string.IsNullOrWhiteSpace(_motivoCortesia))">
                        @if (_validandoCortesia)
                        {
                            <span class="spinner-border spinner-border-sm me-1"></span>
                        }
                        <i class="bi bi-gift me-1"></i>Autorizar Cortes√≠a
                    </button>
                </div>
            </div>
        </div>
    </div>
}

<!-- ========== MODAL COBRAR (iframe de Ventas) ========== -->
@if (_mostrarModalVentas)
{
    <div class="modal-ventas-overlay" @onclick="CerrarModalVentas">
        <div class="modal-ventas-container" @onclick:stopPropagation="true">
            <div class="modal-ventas-header">
                <h5 class="mb-0">
                    <i class="bi bi-receipt me-2"></i>
                    Facturar - @_mesaSeleccionada?.TextoMostrar
                </h5>
                <button class="btn btn-sm btn-outline-light" @onclick="CerrarModalVentas">
                    <i class="bi bi-x-lg"></i>
                </button>
            </div>
            <div class="modal-ventas-body">
                <iframe src="@_urlVentas" class="iframe-ventas"></iframe>
            </div>
        </div>
    </div>
}

<!-- ========== MODAL DETALLE CANCHA ========== -->
@if (_mostrarModalDetalleCancha && _canchaDetalleReserva != null)
{
    // Usar HoraInicioReal si la reserva ya fue iniciada (Estado = EnCurso), sino usar HoraInicio programada
    var reservaYaIniciada = _canchaDetalleReserva.Estado == "EnCurso" && _canchaDetalleReserva.HoraInicioReal.HasValue;
    var horaInicioEfectiva = reservaYaIniciada 
        ? _canchaDetalleReserva.HoraInicioReal!.Value 
        : _canchaDetalleReserva.HoraInicio;
    var inicioReserva = _canchaDetalleReserva.FechaReserva.Date.Add(horaInicioEfectiva);
    var horaFinOriginal = _canchaDetalleReserva.HoraFin ?? (_canchaDetalleReserva.DuracionMinutos.HasValue 
        ? _canchaDetalleReserva.HoraInicio.Add(TimeSpan.FromMinutes(_canchaDetalleReserva.DuracionMinutos.Value))
        : _canchaDetalleReserva.HoraInicio.Add(TimeSpan.FromHours(1)));
    
    // Usar HoraFinEfectiva que considera llegada tard√≠a y extensi√≥n
    var horaFinCalculada = _canchaDetalleReserva.HoraFinEfectiva ?? horaFinOriginal;
    var finReserva = _canchaDetalleReserva.FechaReserva.Date.Add(horaFinCalculada);
    var finReservaOriginal = _canchaDetalleReserva.FechaReserva.Date.Add(horaFinOriginal);
    
    var ahora = DateTime.Now;
    // Si ya fue iniciada manualmente, est√° en curso aunque no haya llegado la hora programada
    var reservaEnCurso = reservaYaIniciada || (ahora >= inicioReserva && ahora < finReserva);
    var reservaPendiente = !reservaYaIniciada && ahora < _canchaDetalleReserva.FechaReserva.Date.Add(_canchaDetalleReserva.HoraInicio);
    var tiempoHastaInicio = reservaPendiente ? _canchaDetalleReserva.FechaReserva.Date.Add(_canchaDetalleReserva.HoraInicio) - ahora : TimeSpan.Zero;
    var tiempoTranscurrido = reservaEnCurso ? ahora - inicioReserva : TimeSpan.Zero;
    var tiempoRestanteSpan = finReserva > ahora ? finReserva - ahora : TimeSpan.Zero;
    var tiempoExcedido = ahora > finReserva ? ahora - finReserva : TimeSpan.Zero;
    var minutosAlerta = _config?.CanchasMinutosAlerta ?? 5;
    var tiempoBajo = tiempoRestanteSpan.TotalMinutes <= minutosAlerta && tiempoRestanteSpan > TimeSpan.Zero;
    var tiempoAgotado = ahora >= finReserva;
    
    // Detectar llegada tard√≠a/adelantada
    var llegoTarde = _canchaDetalleReserva.LlegoTarde;
    var llegoAdelantado = _canchaDetalleReserva.LlegoAdelantado;
    var minutosDesfase = _canchaDetalleReserva.MinutosDesfase;
    var extensionPermitida = _canchaDetalleReserva.ExtensionPermitida;
    var tieneTiempoPerdido = llegoTarde && !extensionPermitida && _canchaDetalleReserva.MinutosPerdidos > 0;
    
    <div class="modal-cancha-overlay" @onclick="CerrarModalDetalleCancha">
        <div class="modal-cancha-container @(tiempoAgotado ? "finalizada" : tiempoBajo ? "alerta" : "")" @onclick:stopPropagation="true">
            <div class="modal-cancha-header @(tiempoAgotado ? "bg-danger" : tiempoBajo ? "bg-warning" : reservaPendiente ? "bg-info" : llegoTarde && !extensionPermitida ? "bg-orange" : "bg-success")">
                <h4 class="mb-0">
                    <i class="bi bi-dribbble me-2"></i>
                    @(_canchaDetalleMesa?.Nombre ?? $"Cancha {_canchaDetalleMesa?.Numero}")
                </h4>
                <button class="btn btn-sm btn-outline-light" @onclick="CerrarModalDetalleCancha">
                    <i class="bi bi-x-lg"></i>
                </button>
            </div>
            
            <div class="modal-cancha-body">
                @if (reservaPendiente)
                {
                    @* Reserva a√∫n no ha comenzado - mostrar solo cuenta regresiva (doble clic para iniciar) *@
                    <div class="cancha-cronometro" @ondblclick="() => IniciarReservaDesdeModal()" style="cursor: pointer;" title="Doble clic para iniciar">
                        <div class="cronometro-label">COMIENZA EN</div>
                        <div class="cronometro-tiempo pendiente">
                            <i class="bi bi-clock-fill me-2"></i>
                            @tiempoHastaInicio.ToString(@"hh\:mm\:ss")
                        </div>
                        <small class="text-muted mt-1" style="font-size: 10px;"><i class="bi bi-mouse me-1"></i>Doble clic para iniciar</small>
                    </div>
                }
                else if (reservaEnCurso)
                {
                    @* Reserva en curso - mostrar tiempo transcurrido y restante *@
                    <div class="cancha-cronometro">
                        <div class="cronometro-label">TIEMPO TRANSCURRIDO</div>
                        <div class="cronometro-tiempo transcurrido">
                            <i class="bi bi-play-circle-fill me-2"></i>
                            @tiempoTranscurrido.ToString(@"hh\:mm\:ss")
                        </div>
                    </div>
                    
                    <div class="cancha-cronometro @(tiempoBajo ? "bajo" : "")">
                        <div class="cronometro-label">TIEMPO RESTANTE</div>
                        <div class="cronometro-tiempo @(tiempoBajo ? "bajo" : "restante")">
                            <i class="bi bi-hourglass-split me-2"></i>
                            @tiempoRestanteSpan.ToString(@"hh\:mm\:ss")
                        </div>
                    </div>
                }
                else
                {
                    @* Tiempo agotado - mostrar tiempo extra *@
                    <div class="cancha-cronometro finalizado">
                        <div class="cronometro-label">TIEMPO EXTRA</div>
                        <div class="cronometro-tiempo extra">
                            <i class="bi bi-exclamation-triangle-fill me-2"></i>
                            -@tiempoExcedido.ToString(@"hh\:mm\:ss")
                        </div>
                    </div>
                }
                
                @* Informaci√≥n de la reserva *@
                <div class="cancha-info-reserva">
                    <div class="info-grupo">
                        <i class="bi bi-person-fill text-primary me-2"></i>
                        <div>
                            <span class="info-label">Reservado por</span>
                            <span class="info-valor">@(_canchaDetalleReserva.NombreCliente ?? "Sin nombre")</span>
                        </div>
                    </div>
                    
                    @if (!string.IsNullOrEmpty(_canchaDetalleReserva.Telefono))
                    {
                        <div class="info-grupo">
                            <i class="bi bi-telephone-fill text-success me-2"></i>
                            <div>
                                <span class="info-label">Tel√©fono</span>
                                <span class="info-valor">@_canchaDetalleReserva.Telefono</span>
                            </div>
                        </div>
                    }
                    
                    <div class="info-grupo">
                        <i class="bi bi-clock-fill text-info me-2"></i>
                        <div>
                            <span class="info-label">Horario reservado</span>
                            <span class="info-valor">@_canchaDetalleReserva.HoraInicio.ToString(@"hh\:mm") - @(_canchaDetalleReserva.HoraFin?.ToString(@"hh\:mm") ?? "--:--")</span>
                        </div>
                    </div>
                    
                    @* Estado de llegada (tard√≠a/adelantada/a tiempo) *@
                    @if (reservaYaIniciada)
                    {
                        <div class="info-grupo">
                            <i class="bi @(llegoTarde ? "bi-alarm" : llegoAdelantado ? "bi-arrow-up-circle" : "bi-check-circle") @(llegoTarde ? "text-warning" : "text-success") me-2"></i>
                            <div>
                                <span class="info-label">Hora de llegada</span>
                                <span class="info-valor">
                                    @_canchaDetalleReserva.HoraInicioReal?.ToString(@"hh\:mm")
                                    @if (llegoTarde)
                                    {
                                        <span class="badge bg-warning text-dark ms-2">
                                            <i class="bi bi-exclamation-triangle me-1"></i>
                                            @minutosDesfase min tarde
                                        </span>
                                        @if (!extensionPermitida)
                                        {
                                            <span class="badge bg-danger ms-1" title="Pierde @_canchaDetalleReserva.MinutosPerdidos min">
                                                -@_canchaDetalleReserva.MinutosPerdidos min
                                            </span>
                                        }
                                        else
                                        {
                                            <span class="badge bg-success ms-1" title="Extensi√≥n permitida">
                                                <i class="bi bi-check me-1"></i>Extensi√≥n OK
                                            </span>
                                        }
                                    }
                                    else if (llegoAdelantado)
                                    {
                                        <span class="badge bg-info ms-2">
                                            <i class="bi bi-arrow-up me-1"></i>
                                            @Math.Abs(minutosDesfase) min antes
                                        </span>
                                    }
                                    else
                                    {
                                        <span class="badge bg-success ms-2">
                                            <i class="bi bi-check me-1"></i>A tiempo
                                        </span>
                                    }
                                </span>
                            </div>
                        </div>
                        
                        @* Horario efectivo (solo si lleg√≥ tarde o adelantado) *@
                        @if (llegoTarde || llegoAdelantado)
                        {
                            <div class="info-grupo">
                                <i class="bi bi-clock-history text-secondary me-2"></i>
                                <div>
                                    <span class="info-label">Horario efectivo</span>
                                    <span class="info-valor">
                                        @_canchaDetalleReserva.HoraInicioReal?.ToString(@"hh\:mm") - @horaFinCalculada.ToString(@"hh\:mm")
                                        @if (tieneTiempoPerdido)
                                        {
                                            <span class="text-muted small ms-2">(@_canchaDetalleReserva.DuracionEfectivaMinutos min en lugar de @_canchaDetalleReserva.DuracionMinutos min)</span>
                                        }
                                    </span>
                                </div>
                            </div>
                        }
                        
                        @* Bot√≥n para permitir extensi√≥n si lleg√≥ tarde y no tiene extensi√≥n *@
                        @if (llegoTarde && !extensionPermitida)
                        {
                            <div class="info-grupo border-top pt-2 mt-2">
                                <i class="bi bi-shield-exclamation text-warning me-2"></i>
                                <div class="w-100">
                                    <span class="info-label">Llegada tard√≠a</span>
                                    <div class="d-flex align-items-center gap-2 mt-1">
                                        <span class="text-muted small">El cliente pierde @_canchaDetalleReserva.MinutosPerdidos min por llegada tard√≠a.</span>
                                        <button class="btn btn-sm btn-outline-success" @onclick="() => PermitirExtensionReserva(_canchaDetalleReserva)" 
                                                title="Permitir que use todo el tiempo reservado (verificar que no haya reserva siguiente)">
                                            <i class="bi bi-plus-circle me-1"></i>Permitir Extensi√≥n
                                        </button>
                                    </div>
                                </div>
                            </div>
                        }
                    }
                    
                    @if (_canchaDetalleReserva.MontoSena > 0)
                    {
                        <div class="info-grupo">
                            <i class="bi bi-cash-stack text-warning me-2"></i>
                            <div>
                                <span class="info-label">Se√±a</span>
                                <span class="info-valor">Gs @_canchaDetalleReserva.MontoSena?.ToString("N0")</span>
                                @if (_canchaDetalleReserva.SenaPagada)
                                {
                                    <span class="badge bg-success ms-2"><i class="bi bi-check-circle me-1"></i>PAGADA</span>
                                }
                                else
                                {
                                    <span class="badge bg-warning text-dark ms-2"><i class="bi bi-clock me-1"></i>PENDIENTE</span>
                                    <button class="btn btn-sm btn-outline-success ms-2" @onclick="AbrirModalPagoSena" title="Registrar pago de se√±a">
                                        <i class="bi bi-wallet2 me-1"></i>Cobrar
                                    </button>
                                }
                            </div>
                        </div>
                    }
                    
                    @if (!string.IsNullOrEmpty(_canchaDetalleReserva.Observaciones))
                    {
                        <div class="info-grupo">
                            <i class="bi bi-chat-left-text-fill text-secondary me-2"></i>
                            <div>
                                <span class="info-label">Observaciones</span>
                                <span class="info-valor">@_canchaDetalleReserva.Observaciones</span>
                            </div>
                        </div>
                    }
                </div>
            </div>
            
            <div class="modal-cancha-footer">
                @if (reservaPendiente)
                {
                    <button class="btn btn-success btn-lg" @onclick="IniciarReservaDesdeModal">
                        <i class="bi bi-play-circle me-2"></i>Iniciar Turno
                    </button>
                }
                else if (tiempoAgotado)
                {
                    <button class="btn btn-danger btn-lg" @onclick="() => FinalizarReservaCancha(_canchaDetalleReserva)">
                        <i class="bi bi-stop-circle me-2"></i>Finalizar Turno
                    </button>
                }
                else
                {
                    <button class="btn btn-warning btn-lg" @onclick="() => ExtenderReservaCancha(_canchaDetalleReserva)">
                        <i class="bi bi-plus-circle me-2"></i>Extender Tiempo
                    </button>
                }
                <button class="btn btn-outline-secondary btn-lg" @onclick="CerrarModalDetalleCancha">
                    <i class="bi bi-x-lg me-2"></i>Cerrar
                </button>
            </div>
        </div>
    </div>
}

<!-- ========== MODAL CREAR RESERVA DESDE GRILLA ========== -->
@if (_mostrarModalReserva && _nuevaReserva != null)
{
    var mesaReserva = _mesas.FirstOrDefault(m => m.IdMesa == _nuevaReserva.IdMesa);
    <div class="modal fade show d-block" style="background: rgba(0,0,0,0.6);" @onclick="CerrarModalReservaGrilla">
        <div class="modal-dialog modal-dialog-centered" @onclick:stopPropagation="true">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title">
                        <i class="bi bi-calendar-plus me-2"></i>Nueva Reserva - @(mesaReserva?.Nombre ?? $"Cancha {mesaReserva?.Numero}")
                    </h5>
                    <button type="button" class="btn-close btn-close-white" @onclick="CerrarModalReservaGrilla"></button>
                </div>
                <div class="modal-body">
                    <div class="row g-3">
                        <div class="col-12">
                            <div class="alert alert-info py-2 mb-3">
                                <i class="bi bi-calendar3 me-2"></i>
                                <strong>@_nuevaReserva.FechaReserva.ToString("dddd d 'de' MMMM yyyy")</strong>
                                <span class="ms-3"><i class="bi bi-clock me-1"></i>@_nuevaReserva.HoraInicio.ToString(@"hh\:mm") - @_nuevaReserva.HoraFin?.ToString(@"hh\:mm")</span>
                            </div>
                        </div>
                        
                        <div class="col-12" style="position: relative;">
                            <label class="form-label small text-muted">Nombre del Cliente *</label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="bi bi-search"></i></span>
                                <input type="text" class="form-control" 
                                       placeholder="Buscar por nombre, RUC o tel√©fono..."
                                       @bind="_buscarClienteReservaTexto"
                                       @bind:event="oninput"
                                       @bind:after="FiltrarClientesReserva"
                                       @onfocus="() => _mostrarSugerenciasClienteReserva = _clientesFiltradosReserva.Any()"
                                       @onblur="OnClienteBlurReservaGrilla" />
                            </div>
                            
                            @* Dropdown de sugerencias *@
                            @if (_mostrarSugerenciasClienteReserva && _clientesFiltradosReserva.Any())
                            {
                                <div class="dropdown-menu show w-100 shadow" 
                                     style="max-height: 200px; overflow-y: auto; position: absolute; z-index: 1060; top: 100%;">
                                    @foreach (var cli in _clientesFiltradosReserva.Take(10))
                                    {
                                        <button type="button" class="dropdown-item py-2"
                                                @onmousedown="() => _mouseDownEnSugerenciaReserva = true"
                                                @onclick="() => SeleccionarClienteReservaGrilla(cli)">
                                            <div class="fw-bold">@cli.RazonSocial</div>
                                            <small class="text-muted">
                                                @(cli.RUC ?? cli.NumeroDocumento)
                                                @if (!string.IsNullOrEmpty(cli.Telefono)) { <span>| <i class="bi bi-telephone"></i> @cli.Telefono</span> }
                                            </small>
                                        </button>
                                    }
                                </div>
                            }
                            
                            @* Mostrar cliente seleccionado *@
                            @if (!string.IsNullOrEmpty(_nuevaReserva?.NombreCliente))
                            {
                                <div class="mt-1 p-2 border rounded bg-light d-flex justify-content-between align-items-center">
                                    <div>
                                        <i class="bi bi-person-check text-success me-1"></i>
                                        <strong>@_nuevaReserva.NombreCliente</strong>
                                        @if (!string.IsNullOrEmpty(_nuevaReserva.Telefono))
                                        {
                                            <small class="text-muted ms-2"><i class="bi bi-telephone"></i> @_nuevaReserva.Telefono</small>
                                        }
                                    </div>
                                    <button type="button" class="btn btn-sm btn-outline-secondary" @onclick="LimpiarClienteReservaGrilla">
                                        <i class="bi bi-x"></i>
                                    </button>
                                </div>
                            }
                        </div>
                        
                        <div class="col-md-6">
                            <label class="form-label small text-muted">Tel√©fono</label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="bi bi-telephone"></i></span>
                                <input type="tel" class="form-control" @bind="_nuevaReserva.Telefono" 
                                       placeholder="0981..." />
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <label class="form-label small text-muted">Email <small class="text-info">(para confirmaci√≥n)</small></label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="bi bi-envelope"></i></span>
                                <input type="email" class="form-control" @bind="_nuevaReserva.Email" 
                                       placeholder="cliente@email.com" />
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <label class="form-label small text-muted">Cantidad de Personas</label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="bi bi-people"></i></span>
                                <input type="number" class="form-control" @bind="_nuevaReserva.CantidadPersonas" 
                                       min="1" max="@(mesaReserva?.Capacidad ?? 20)" />
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <label class="form-label small text-muted">Hora Inicio</label>
                            <input type="time" class="form-control" 
                                   value="@_nuevaReserva.HoraInicio.ToString("hh':'mm")"
                                   @onchange="@(e => _nuevaReserva!.HoraInicio = TimeSpan.Parse(e.Value?.ToString() ?? string.Empty))" />
                        </div>
                        
                        <div class="col-md-6">
                            <label class="form-label small text-muted">Hora Fin</label>
                            <input type="time" class="form-control" 
                                   value="@(_nuevaReserva.HoraFin?.ToString("hh':'mm") ?? "")"
                                   @onchange="@(e => { if (TimeSpan.TryParse(e.Value?.ToString(), out var t)) _nuevaReserva!.HoraFin = t; })" />
                        </div>
                        
                        <div class="col-md-6">
                            <label class="form-label small text-muted">Monto Se√±a (Gs)</label>
                            <div class="input-group">
                                <span class="input-group-text">Gs</span>
                                <input type="number" class="form-control" @bind="_nuevaReserva.MontoSena" min="0" step="1000" />
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <label class="form-label small text-muted">Estado</label>
                            <select class="form-select" @bind="_nuevaReserva.Estado">
                                <option value="Pendiente">Pendiente</option>
                                <option value="Confirmada">Confirmada</option>
                            </select>
                        </div>
                        
                        <div class="col-12">
                            <label class="form-label small text-muted">Observaciones</label>
                            <textarea class="form-control" rows="2" @bind="_nuevaReserva.Observaciones"
                                      placeholder="Notas adicionales..."></textarea>
                        </div>
                    </div>
                    
                    @if (!string.IsNullOrEmpty(_mensajeReservaGrilla))
                    {
                        <div class="alert @(_reservaGrillaExito ? "alert-success" : "alert-danger") mt-3 mb-0">
                            <i class="bi @(_reservaGrillaExito ? "bi-check-circle" : "bi-exclamation-triangle") me-2"></i>
                            @_mensajeReservaGrilla
                        </div>
                    }
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="CerrarModalReservaGrilla">
                        <i class="bi bi-x-lg me-1"></i>Cancelar
                    </button>
                    <button type="button" class="btn btn-success" @onclick="GuardarReservaGrilla" disabled="@_guardandoReservaGrilla">
                        @if (_guardandoReservaGrilla)
                        {
                            <span class="spinner-border spinner-border-sm me-1"></span>
                        }
                        <i class="bi bi-check-lg me-1"></i>Guardar Reserva
                    </button>
                </div>
            </div>
        </div>
    </div>
}

<!-- ========== MODAL PAGO SE√ëA ========== -->
@if (_mostrarModalPagoSena && _canchaDetalleReserva != null)
{
    <div class="modal fade show d-block" style="background: rgba(0,0,0,0.6);" @onclick="CerrarModalPagoSena">
        <div class="modal-dialog modal-dialog-centered" @onclick:stopPropagation="true">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title">
                        <i class="bi bi-wallet2 me-2"></i>Registrar Pago de Se√±a
                    </h5>
                    <button type="button" class="btn-close btn-close-white" @onclick="CerrarModalPagoSena"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-info py-2 mb-3">
                        <i class="bi bi-person me-2"></i>
                        <strong>@_canchaDetalleReserva.NombreCliente</strong>
                        <span class="ms-3">
                            <i class="bi bi-cash-stack me-1"></i>
                            Monto: <strong>Gs @_canchaDetalleReserva.MontoSena?.ToString("N0")</strong>
                        </span>
                    </div>
                    
                    <div class="row g-3">
                        <div class="col-12">
                            <label class="form-label small text-muted">Medio de Pago *</label>
                            <select class="form-select" @bind="_medioPagoSena">
                                <option value="@MedioPago.Efectivo">üíµ Efectivo</option>
                                <option value="@MedioPago.Tarjeta">üí≥ Tarjeta</option>
                                <option value="@MedioPago.QR">üì± QR</option>
                                <option value="@MedioPago.Transferencia">üè¶ Transferencia</option>
                            </select>
                        </div>
                        
                        @if (_medioPagoSena == MedioPago.Tarjeta)
                        {
                            <div class="col-6">
                                <label class="form-label small text-muted">Tipo Tarjeta</label>
                                <select class="form-select" @bind="_tipoTarjetaSena">
                                    <option value="@TipoTarjeta.Debito">D√©bito</option>
                                    <option value="@TipoTarjeta.Credito">Cr√©dito</option>
                                </select>
                            </div>
                            <div class="col-6">
                                <label class="form-label small text-muted">Marca</label>
                                <input type="text" class="form-control" @bind="_marcaTarjetaSena" placeholder="Visa, Master..." />
                            </div>
                            <div class="col-12">
                                <label class="form-label small text-muted">Nro. Autorizaci√≥n</label>
                                <input type="text" class="form-control" @bind="_numeroAutorizacionSena" />
                            </div>
                        }
                        
                        @if (_medioPagoSena == MedioPago.Transferencia)
                        {
                            <div class="col-6">
                                <label class="form-label small text-muted">Banco</label>
                                <input type="text" class="form-control" @bind="_bancoTransferenciaSena" />
                            </div>
                            <div class="col-6">
                                <label class="form-label small text-muted">Nro. Comprobante</label>
                                <input type="text" class="form-control" @bind="_numeroComprobanteSena" />
                            </div>
                        }

                        @if (_medioPagoSena == MedioPago.QR)
                        {
                            <div class="col-12">
                                <label class="form-label small text-muted">Nro. Comprobante</label>
                                <input type="text" class="form-control" @bind="_numeroComprobanteSena" />
                            </div>
                        }
                    </div>
                    
                    @if (!string.IsNullOrEmpty(_mensajePagoSena))
                    {
                        <div class="alert @(_pagoSenaExito ? "alert-success" : "alert-danger") mt-3 mb-0">
                            <i class="bi @(_pagoSenaExito ? "bi-check-circle" : "bi-exclamation-triangle") me-2"></i>
                            @_mensajePagoSena
                        </div>
                    }
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="CerrarModalPagoSena">
                        <i class="bi bi-x-lg me-1"></i>Cancelar
                    </button>
                    <button type="button" class="btn btn-success" @onclick="RegistrarPagoSena" disabled="@_guardandoPagoSena">
                        @if (_guardandoPagoSena)
                        {
                            <span class="spinner-border spinner-border-sm me-1"></span>
                        }
                        <i class="bi bi-check-lg me-1"></i>Confirmar Pago
                    </button>
                </div>
            </div>
        </div>
    </div>
}

</PageProtection>

<style>
    /* ========== LAYOUT PRINCIPAL ========== */
    .mesas-panel-container {
        display: flex;
        height: calc(100vh - 140px);
        overflow: hidden;
    }

    .panel-mesas {
        flex: 0 0 100%;
        display: flex;
        flex-direction: column;
        background: var(--bg-page);
        border-right: 1px solid var(--bar-border);
        transition: flex 0.3s ease;
        overflow: hidden;
    }

    .panel-mesas.con-pedido {
        flex: 0 0 40%;
    }

    /* Cuando la agenda est√° colapsada, los paneles se expanden */
    .panel-mesas.agenda-oculta {
        flex: 0 0 calc(100% - 30px);
    }

    .panel-mesas.con-pedido.agenda-oculta {
        flex: 0 0 55%;
    }

    /* Contenedor con agenda colapsada - mesas y pedidos ocupan todo */
    .mesas-panel-container.agenda-colapsada .panel-mesas {
        flex: 1 1 60% !important;
    }
    
    .mesas-panel-container.agenda-colapsada .panel-mesas.con-pedido {
        flex: 0 0 35% !important;
    }
    
    .mesas-panel-container.agenda-colapsada .panel-pedido {
        flex: 1 1 auto !important;
        max-width: calc(100% - 35% - 30px);
    }
    
    .mesas-panel-container.agenda-colapsada .panel-agenda.colapsado {
        flex: 0 0 30px !important;
        min-width: 30px;
        max-width: 30px;
    }
    
    /* Panel pedido sin max-height cuando agenda colapsada */
    .mesas-panel-container.agenda-colapsada .panel-pedido {
        max-height: none;
        height: auto;
    }

    .panel-pedido {
        flex: 0 0 30%;
        display: flex;
        flex-direction: column;
        background: var(--bg-surface);
        overflow: hidden;
        max-height: calc(100vh - 140px);
        border-right: 1px solid var(--bar-border);
        transition: flex 0.3s ease;
    }

    .panel-pedido.agenda-oculta {
        flex: 1 1 auto;
        max-height: none;
    }

    .panel-pedido-scroll {
        flex: 1;
        overflow-y: auto;
        overflow-x: hidden;
        min-height: 0;
    }

    /* ========== PANEL AGENDA ========== */
    .panel-agenda {
        flex: 0 0 30%;
        display: flex;
        flex-direction: column;
        background: var(--bg-surface);
        overflow: hidden;
        position: relative;
        transition: flex 0.3s ease;
    }

    .panel-agenda.colapsado {
        flex: 0 0 30px;
    }

    .agenda-toggle {
        position: absolute;
        left: 0;
        top: 50%;
        transform: translateY(-50%);
        width: 24px;
        height: 60px;
        background: var(--bs-primary);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        border-radius: 0 8px 8px 0;
        z-index: 10;
        transition: all 0.2s;
    }

    .agenda-toggle:hover {
        width: 28px;
        background: var(--bs-primary);
        filter: brightness(1.1);
    }

    .panel-agenda.colapsado .agenda-toggle {
        left: 3px;
    }

    .agenda-contenido {
        flex: 1;
        display: flex;
        flex-direction: column;
        overflow: hidden;
        margin-left: 24px;
    }

    .agenda-header {
        padding: 10px 12px;
        background: var(--bar-bg);
        border-bottom: 1px solid var(--bar-border);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .agenda-lista {
        flex: 1;
        overflow-y: auto;
        padding: 8px;
    }

    .agenda-item {
        background: var(--bg-page);
        border-radius: 8px;
        padding: 10px;
        margin-bottom: 8px;
        cursor: pointer;
        border-left: 3px solid transparent;
        transition: all 0.2s;
    }

    .agenda-item:hover {
        background: var(--bar-bg);
    }

    .agenda-item.proxima {
        border-left-color: var(--bs-warning);
        background: rgba(255, 193, 7, 0.1);
    }

    .agenda-item.en-curso {
        border-left-color: var(--bs-success);
        background: rgba(40, 167, 69, 0.15);
        border-left-width: 4px;
    }

    .agenda-item.completada {
        border-left-color: var(--bs-secondary);
        background: rgba(108, 117, 125, 0.1);
        opacity: 0.7;
    }

    .agenda-footer {
        padding: 10px;
        border-top: 1px solid var(--bar-border);
    }

    /* ========== GRILLA DE DISPONIBILIDAD ========== */
    .grilla-controles {
        padding: 8px 12px;
        background: var(--bg-page);
        border-bottom: 1px solid var(--bar-border);
    }

    .grilla-disponibilidad {
        flex: 1;
        display: flex;
        flex-direction: column;
        overflow: hidden;
        font-size: 11px;
    }

    .grilla-header {
        display: flex;
        background: var(--bar-bg);
        border-bottom: 2px solid var(--bar-border);
        position: sticky;
        top: 0;
        z-index: 1;
    }

    .grilla-celda-hora {
        min-width: 50px;
        max-width: 50px;
        padding: 6px 4px;
        text-align: center;
        font-weight: 600;
        background: var(--bar-bg);
        border-right: 1px solid var(--bar-border);
        color: var(--text-primary);
    }

    .grilla-celda-header {
        flex: 1;
        min-width: 60px;
        padding: 6px 4px;
        text-align: center;
        font-weight: 600;
        border-right: 1px solid var(--bar-border);
        overflow: hidden;
    }

    .grilla-header-texto {
        display: block;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        font-size: 10px;
    }

    .grilla-body {
        flex: 1;
        overflow-y: auto;
        overflow-x: hidden;
    }

    .grilla-fila {
        display: flex;
        border-bottom: 1px solid var(--bar-border);
        min-height: 32px;
    }

    .grilla-fila.hora-actual {
        background: rgba(13, 110, 253, 0.08);
    }

    .grilla-fila.hora-actual .grilla-celda-hora {
        background: var(--bs-primary);
        color: white;
        font-weight: bold;
    }

    .grilla-celda {
        flex: 1;
        min-width: 60px;
        padding: 2px 4px;
        border-right: 1px solid var(--bar-border);
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.15s ease;
        overflow: hidden;
    }

    .grilla-celda:hover {
        filter: brightness(0.9);
        transform: scale(1.02);
    }

    .grilla-celda.libre {
        background: var(--bg-surface);
    }

    .grilla-celda.libre:hover {
        background: rgba(40, 167, 69, 0.15);
    }

    .grilla-celda.pasado {
        background: var(--bar-bg);
        cursor: not-allowed;
        opacity: 0.5;
    }

    .grilla-celda.confirmada {
        background: rgba(13, 110, 253, 0.25);
        border-left: 3px solid var(--bs-primary);
    }

    .grilla-celda.en-curso {
        background: rgba(40, 167, 69, 0.3);
        border-left: 3px solid var(--bs-success);
        animation: pulse-grilla 1.5s ease-in-out infinite;
    }

    .grilla-celda.completada {
        background: rgba(108, 117, 125, 0.2);
        border-left: 3px solid var(--bs-secondary);
    }

    .grilla-celda.pendiente {
        background: rgba(255, 193, 7, 0.25);
        border-left: 3px solid var(--bs-warning);
    }

    .grilla-celda.reservada {
        background: rgba(13, 202, 240, 0.2);
        border-left: 3px solid var(--bs-info);
    }

    @@keyframes pulse-grilla {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.7; }
    }

    .grilla-celda-cliente {
        font-size: 9px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 100%;
        font-weight: 500;
    }

    .grilla-celda-hora-reserva {
        font-size: 8px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 100%;
        opacity: 0.8;
        display: block;
        margin-top: 1px;
    }

    .grilla-celda-telefono {
        font-size: 9px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 100%;
        opacity: 0.7;
        display: block;
        margin-top: 2px;
    }

    /* Vista Individual (una sola mesa/cancha) */
    .grilla-disponibilidad.vista-individual {
        max-width: 100%;
    }

    .grilla-celda-header.header-individual {
        flex: 1;
        min-width: 200px;
        font-size: 14px;
        padding: 10px;
    }

    .grilla-celda.celda-individual {
        min-width: 200px;
        min-height: 50px;
        padding: 8px 12px;
        flex-direction: column;
        align-items: flex-start;
        justify-content: center;
    }

    .grilla-celda-cliente.cliente-individual {
        font-size: 13px;
        font-weight: 600;
    }

    /* Leyenda */
    .grilla-leyenda {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        padding: 6px 12px;
        background: var(--bar-bg);
        border-top: 1px solid var(--bar-border);
        font-size: 10px;
    }

    .leyenda-item {
        display: flex;
        align-items: center;
        gap: 4px;
    }

    .leyenda-color {
        width: 12px;
        height: 12px;
        border-radius: 3px;
        border: 1px solid var(--bar-border);
    }

    .leyenda-color.libre { background: var(--bg-surface); }
    .leyenda-color.confirmada { background: rgba(13, 110, 253, 0.3); border-left: 3px solid var(--bs-primary); }
    .leyenda-color.en-curso { background: rgba(40, 167, 69, 0.35); border-left: 3px solid var(--bs-success); }
    .leyenda-color.completada { background: rgba(108, 117, 125, 0.25); border-left: 3px solid var(--bs-secondary); }

    /* ========== GRID DE MESAS ========== */
    .mesas-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
        gap: 10px;
        overflow-y: auto;
        flex: 1;
        padding: 10px;
    }

    .mesa-card {
        aspect-ratio: 1;
        border-radius: 12px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.2s ease;
        color: white;
        text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
        box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        position: relative;
        overflow: hidden;
    }

    .mesa-card:hover {
        transform: scale(1.05);
        box-shadow: 0 4px 16px rgba(0,0,0,0.25);
    }

    .mesa-card.seleccionada {
        outline: 3px solid var(--bs-primary);
        outline-offset: 2px;
    }

    .mesa-card.ocupada {
        animation: pulse-ocupada 2s infinite;
    }

    /* Estilos para Delivery */
    .mesa-card.delivery-card {
        border-radius: 16px;
    }
    
    /* ========== FORMAS DE MESA ========== */
    .mesa-card.forma-cuadrado {
        border-radius: 12px;
        aspect-ratio: 1;
    }
    
    .mesa-card.forma-circulo {
        border-radius: 50%;
        aspect-ratio: 1;
    }
    
    .mesa-card.forma-rectangulo {
        border-radius: 12px;
        aspect-ratio: 1.4/1; /* Ligeramente m√°s ancho que alto */
    }
    
    .mesa-card.forma-oval {
        border-radius: 50%;
        aspect-ratio: 1.4/1; /* Ligeramente m√°s ancho que alto */
    }
    
    /* Ajustar mesas unidas con formas */
    .mesa-card.mesa-unida.forma-rectangulo,
    .mesa-card.mesa-unida.forma-oval {
        grid-column: span 2;
        aspect-ratio: 1.8/1;
    }
    
    /* ========== DRAG & DROP - UNIR MESAS ========== */
    .mesa-card[draggable="true"] {
        cursor: grab;
    }
    
    .mesa-card[draggable="true"]:active {
        cursor: grabbing;
    }
    
    .mesa-card.drop-target {
        outline: 3px dashed var(--bs-primary) !important;
        outline-offset: 3px;
        background: rgba(var(--bs-primary-rgb), 0.3) !important;
        transform: scale(1.08);
    }
    
    .mesa-card.mesa-unida {
        border: 2px solid rgba(255,255,255,0.5);
        grid-column: span 2; /* Ocupa 2 columnas cuando tiene mesas unidas */
        aspect-ratio: 2/1; /* M√°s ancho que alto */
        border-radius: 16px;
    }
    
    .mesa-card.mesa-unida-3 {
        grid-column: span 3;
        aspect-ratio: 3/1;
    }
    
    .mesas-unidas-visual {
        display: flex;
        gap: 4px;
        align-items: center;
        justify-content: center;
        flex-wrap: wrap;
    }
    
    .mesa-mini {
        background: rgba(255,255,255,0.2);
        border-radius: 8px;
        padding: 4px 12px;
        font-weight: bold;
        font-size: 1.2rem;
    }
    
    .mesa-mini-plus {
        font-size: 1.5rem;
        opacity: 0.7;
    }
    
    .badge-mesas-unidas {
        position: absolute;
        top: 4px;
        right: 4px;
        background: rgba(0,0,0,0.4);
        border-radius: 50%;
        width: 22px;
        height: 22px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.75rem;
    }
    
    /* ========== MEN√ö CONTEXTUAL ========== */
    .menu-contextual-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        z-index: 1000;
    }
    
    .menu-contextual {
        position: fixed;
        z-index: 1001;
        background: var(--bg-surface, #fff);
        border: 1px solid var(--border-color, #dee2e6);
        border-radius: 8px;
        box-shadow: 0 4px 16px rgba(0,0,0,0.2);
        min-width: 200px;
        padding: 4px 0;
        animation: fadeIn 0.15s ease-out;
    }
    
    @@keyframes fadeIn {
        from { opacity: 0; transform: scale(0.95); }
        to { opacity: 1; transform: scale(1); }
    }
    
    .menu-contextual-header {
        padding: 8px 12px;
        font-weight: 600;
        color: var(--text-primary, #333);
        border-bottom: 1px solid var(--border-color, #dee2e6);
        background: var(--bg-page, #f8f9fa);
    }
    
    .menu-contextual-info {
        padding: 6px 12px;
        font-size: 0.8rem;
    }
    
    .menu-contextual-item {
        display: flex;
        align-items: center;
        width: 100%;
        padding: 8px 12px;
        border: none;
        background: transparent;
        text-align: left;
        cursor: pointer;
        transition: background 0.15s;
    }
    
    .menu-contextual-item:hover {
        background: var(--bg-page, #f8f9fa);
    }
    
    .menu-contextual-item.text-danger:hover {
        background: rgba(220, 53, 69, 0.1);
    }

    .delivery-badge {
        background: rgba(255,255,255,0.25);
        padding: 2px 10px;
        border-radius: 12px;
        font-size: 1.1rem;
    }

    .mesa-numero.con-imagen {
        background: rgba(0,0,0,0.4);
        padding: 4px 12px;
        border-radius: 8px;
        font-size: 1.2rem;
    }

    .mesa-numero {
        font-size: 1.5rem;
        font-weight: bold;
    }

    .mesa-total {
        font-size: 0.8rem;
        background: rgba(0,0,0,0.3);
        padding: 2px 8px;
        border-radius: 4px;
        margin-top: 4px;
    }

    .mesa-pendiente {
        font-size: 0.65rem;
        color: #ffc107;
    }
    
    .mesa-tiempo {
        font-size: 0.65rem;
        color: #17a2b8;
        margin-top: 2px;
    }
    .mesa-tiempo i {
        font-size: 0.6rem;
    }

    .mesa-nombre {
        font-size: 0.7rem;
        opacity: 0.9;
    }

    @@keyframes pulse-ocupada {
        0%, 100% { box-shadow: 0 2px 8px rgba(0,0,0,0.15); }
        50% { box-shadow: 0 2px 16px rgba(220, 53, 69, 0.4); }
    }

    /* ========== MODO CANCHAS - TIEMPO Y PARPADEO ========== */
    .cancha-tiempo {
        font-size: 0.75rem;
        font-weight: bold;
        color: #fff;
        text-shadow: 0 1px 2px rgba(0,0,0,0.5);
        margin-top: 2px;
        font-family: 'Consolas', 'Courier New', monospace;
        padding: 2px 6px;
        background: rgba(0,0,0,0.3);
        border-radius: 4px;
    }
    .cancha-tiempo.tiempo-bajo {
        color: #ffc107;
        background: rgba(255,193,7,0.2);
    }
    .cancha-tiempo.tiempo-agotado {
        color: #ff4444;
        background: rgba(255,68,68,0.2);
    }
    
    .cancha-nombre {
        font-size: 0.7rem;
        font-weight: 600;
        color: rgba(255,255,255,0.9);
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .cancha-tiempo-transcurrido {
        font-size: 1.1rem;
        font-weight: bold;
        color: #fff;
        font-family: 'Consolas', 'Courier New', monospace;
        text-shadow: 0 2px 4px rgba(0,0,0,0.5);
        margin: 4px 0;
    }
    
    .cancha-cliente {
        font-size: 0.6rem;
        color: rgba(255,255,255,0.8);
        margin-top: 2px;
        max-width: 100%;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }
    
    .mesa-card.cancha-finalizada {
        animation: parpadeo-cancha 0.5s ease-in-out infinite;
    }
    
    @@keyframes parpadeo-cancha {
        0%, 100% { 
            opacity: 1; 
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }
        50% { 
            opacity: 0.5; 
            box-shadow: 0 0 20px rgba(255, 68, 68, 0.8), 0 0 40px rgba(255, 68, 68, 0.4);
        }
    }
    
    /* ========== MODAL DETALLE CANCHA ========== */
    .modal-cancha-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.7);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 2000;
        animation: fadeIn 0.2s ease-out;
    }
    
    .modal-cancha-container {
        background: var(--bg-surface, #fff);
        border-radius: 16px;
        width: 90vw;
        max-width: 600px;
        max-height: 90vh;
        overflow: hidden;
        box-shadow: 0 20px 60px rgba(0,0,0,0.4);
        animation: slideUp 0.3s ease-out;
    }
    
    .modal-cancha-container.alerta {
        box-shadow: 0 0 30px rgba(255, 193, 7, 0.5), 0 20px 60px rgba(0,0,0,0.4);
    }
    
    .modal-cancha-container.finalizada {
        animation: parpadeoModal 0.8s ease-in-out infinite;
    }
    
    @@keyframes slideUp {
        from { opacity: 0; transform: translateY(30px); }
        to { opacity: 1; transform: translateY(0); }
    }
    
    @@keyframes parpadeoModal {
        0%, 100% { box-shadow: 0 0 30px rgba(220, 53, 69, 0.5), 0 20px 60px rgba(0,0,0,0.4); }
        50% { box-shadow: 0 0 60px rgba(220, 53, 69, 0.8), 0 20px 60px rgba(0,0,0,0.4); }
    }
    
    .modal-cancha-header {
        padding: 16px 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        color: #fff;
    }
    
    .modal-cancha-header h4 {
        font-weight: 700;
        margin: 0;
    }
    
    .modal-cancha-body {
        padding: 20px;
        display: flex;
        flex-direction: column;
        gap: 20px;
    }
    
    .cancha-cronometro {
        text-align: center;
        padding: 20px;
        background: var(--bg-page, #f8f9fa);
        border-radius: 12px;
    }
    
    .cancha-cronometro.bajo {
        background: rgba(255, 193, 7, 0.15);
    }
    
    .cancha-cronometro.finalizado {
        background: rgba(220, 53, 69, 0.15);
    }
    
    .cronometro-label {
        font-size: 0.8rem;
        font-weight: 600;
        color: var(--text-muted, #6c757d);
        text-transform: uppercase;
        letter-spacing: 1px;
        margin-bottom: 8px;
    }
    
    .cronometro-tiempo {
        font-size: 3rem;
        font-weight: 700;
        font-family: 'Consolas', 'Courier New', monospace;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .cronometro-tiempo.transcurrido {
        color: #198754;
    }
    
    .cronometro-tiempo.pendiente {
        color: #0dcaf0;
    }
    
    .cronometro-tiempo.restante {
        color: #0d6efd;
    }
    
    .cronometro-tiempo.bajo {
        color: #ffc107;
    }
    
    .cronometro-tiempo.extra {
        color: #dc3545;
        animation: pulso 1s ease-in-out infinite;
    }
    
    @@keyframes pulso {
        0%, 100% { transform: scale(1); }
        50% { transform: scale(1.05); }
    }
    
    .cancha-info-reserva {
        display: flex;
        flex-direction: column;
        gap: 12px;
        padding: 16px;
        background: var(--bg-page, #f8f9fa);
        border-radius: 12px;
    }
    
    .info-grupo {
        display: flex;
        align-items: center;
        gap: 12px;
    }
    
    .info-grupo i {
        font-size: 1.2rem;
        width: 24px;
        text-align: center;
    }
    
    .info-grupo div {
        display: flex;
        flex-direction: column;
    }
    
    .info-label {
        font-size: 0.75rem;
        color: var(--text-muted, #6c757d);
        text-transform: uppercase;
    }
    
    .info-valor {
        font-size: 1rem;
        font-weight: 600;
        color: var(--text-primary, #333);
    }
    
    .modal-cancha-footer {
        padding: 16px 20px;
        display: flex;
        gap: 12px;
        justify-content: center;
        border-top: 1px solid var(--border-color, #dee2e6);
        background: var(--bg-page, #f8f9fa);
    }

    /* ========== PANEL PEDIDO ========== */
    .pedido-header {
        padding: 6px 12px;
        background: var(--bar-bg);
        border-bottom: 1px solid var(--bar-border);
        flex-shrink: 0;
    }

    .pedido-busqueda {
        padding: 4px 8px;
        background: var(--bg-surface);
        border-bottom: 1px solid var(--bar-border);
        flex-shrink: 0;
    }

    .categorias-rapidas {
        display: flex;
        flex-wrap: wrap;
        gap: 2px;
        margin-top: 3px;
    }

    .btn-xs {
        padding: 1px 5px;
        font-size: 0.65rem;
    }

    /* ========== GRID PRODUCTOS ========== */
    .productos-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(95px, 1fr));
        gap: 6px;
        padding: 6px;
        overflow-y: auto;
        max-height: 230px;
        background: var(--bg-page);
        flex-shrink: 0;
    }

    .producto-card {
        background: var(--bg-surface);
        border-radius: 8px;
        overflow: hidden;
        cursor: pointer;
        transition: all 0.2s ease;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    .producto-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 3px 8px rgba(0,0,0,0.15);
    }

    .producto-imagen {
        height: 70px;
        background-size: cover;
        background-position: center;
        background-color: #f0f0f0;
    }

    .producto-sin-imagen {
        display: flex;
        align-items: center;
        justify-content: center;
        color: #999;
        font-size: 1.5rem;
    }

    .producto-info {
        padding: 5px;
        text-align: center;
    }

    .producto-nombre {
        font-size: 0.7rem;
        font-weight: 500;
        line-height: 1.2;
        height: 2.4em;
        overflow: hidden;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        word-break: break-word;
    }

    .producto-precio {
        font-size: 0.75rem;
        color: var(--bs-primary);
        font-weight: bold;
    }

    /* ========== DETALLE PEDIDO ========== */
    .pedido-detalle {
        flex: 0 0 auto;
        display: flex;
        flex-direction: column;
        border-top: 1px solid var(--bar-border);
    }

    .detalle-header {
        padding: 6px 12px;
        background: var(--bar-bg);
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-weight: 500;
        font-size: 0.8rem;
    }

    .detalle-items {
        max-height: 180px;
        overflow-y: auto;
        padding: 4px 8px;
    }

    .detalle-item {
        display: flex;
        align-items: center;
        padding: 8px;
        border-bottom: 1px solid var(--bar-border);
        gap: 8px;
    }

    .detalle-item.facturado {
        opacity: 0.6;
        background: rgba(40, 167, 69, 0.1);
    }

    .detalle-item.seleccionado {
        background: rgba(13, 110, 253, 0.1);
    }
    
    /* ========== ESTADOS COCINA EN DETALLE ========== */
    .detalle-item.estado-pendiente {
        border-left: 3px solid #ffc107;
    }
    .detalle-item.estado-preparando {
        border-left: 3px solid #dc3545;
        background: rgba(220, 53, 69, 0.08);
        animation: pulse-preparando 2s infinite;
    }
    .detalle-item.estado-listo {
        border-left: 3px solid #28a745;
        background: rgba(40, 167, 69, 0.15);
        animation: pulse-listo 1s infinite;
    }
    .detalle-item.estado-entregado {
        border-left: 3px solid #6c757d;
        opacity: 0.7;
    }
    
    .badge-cocina {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 24px;
        height: 24px;
        border-radius: 50%;
        font-size: 0.75rem;
    }
    .badge-cocina.no-enviado {
        background: #6c757d;
        color: white;
    }
    .badge-cocina.pendiente {
        background: #ffc107;
        color: #212529;
        animation: spin 2s linear infinite;
    }
    .badge-cocina.preparando {
        background: #dc3545;
        color: white;
        animation: pulse-fire 0.5s infinite alternate;
    }
    .badge-cocina.listo {
        background: #28a745;
        color: white;
        animation: bounce 0.5s infinite alternate;
    }
    .badge-cocina.entregado {
        background: #17a2b8;
        color: white;
    }
    
    .estado-texto-pendiente { color: #ffc107; font-size: 0.7rem; }
    .estado-texto-enpreparacion { color: #dc3545; font-size: 0.7rem; font-weight: bold; }
    .estado-texto-listo { color: #28a745; font-size: 0.7rem; font-weight: bold; }
    
    @@keyframes pulse-preparando {
        0%, 100% { background: rgba(220, 53, 69, 0.08); }
        50% { background: rgba(220, 53, 69, 0.2); }
    }
    @@keyframes pulse-listo {
        0%, 100% { background: rgba(40, 167, 69, 0.15); }
        50% { background: rgba(40, 167, 69, 0.35); }
    }
    @@keyframes pulse-fire {
        from { transform: scale(1); }
        to { transform: scale(1.2); }
    }
    @@keyframes bounce {
        from { transform: translateY(0); }
        to { transform: translateY(-3px); }
    }
    @@keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
    }

    .item-info {
        min-width: 0;
    }

    .item-nombre {
        font-size: 0.85rem;
        font-weight: 500;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .item-detalle {
        font-size: 0.75rem;
        color: var(--text-muted);
    }

    .item-importe {
        font-weight: bold;
        font-size: 0.9rem;
        min-width: 70px;
        text-align: right;
    }

    .item-acciones {
        display: flex;
        gap: 2px;
    }

    /* ========== NOTAS COCINA ========== */
    .notas-cocina-input {
        font-size: 0.75rem;
        padding: 2px 6px;
        border: 1px dashed var(--bs-warning);
        background: rgba(255, 193, 7, 0.1);
        border-radius: 4px;
    }

    .notas-cocina-input::placeholder {
        font-style: italic;
        color: var(--bs-warning);
        opacity: 0.8;
    }

    .notas-cocina-texto {
        font-size: 0.7rem;
        color: var(--bs-warning);
        font-style: italic;
        padding: 2px 4px;
        background: rgba(255, 193, 7, 0.1);
        border-radius: 3px;
    }

    /* ========== FOOTER PEDIDO ========== */
    .pedido-footer {
        padding: 6px 10px;
        background: var(--bg-surface);
        border-top: 2px solid var(--bs-primary);
        flex-shrink: 0;
        box-shadow: 0 -4px 12px rgba(0,0,0,0.15);
    }

    .totales-grid {
        margin-bottom: 4px;
        padding: 4px 8px;
        background: var(--bar-bg);
        border-radius: 6px;
    }

    .total-row {
        display: flex;
        justify-content: space-between;
        font-size: 0.85rem;
        padding: 2px 0;
    }

    .total-pendiente {
        color: var(--bs-danger);
        font-weight: bold;
        font-size: 1rem;
    }

    .total-seleccionado {
        color: var(--bs-primary);
        font-weight: bold;
        font-size: 1.1rem;
        border-top: 1px solid var(--bar-border);
        padding-top: 8px;
        margin-top: 4px;
    }

    .acciones-pedido {
        display: flex;
        gap: 10px;
    }
    
    .acciones-pedido .btn {
        flex: 1;
        padding: 10px 15px;
        font-size: 0.9rem;
    }
    
    .acciones-pedido .btn-success {
        font-weight: bold;
    }

    /* ========== MODAL VENTAS ========== */
    .modal-ventas-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.7);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1050;
    }

    .modal-ventas-container {
        width: 95%;
        height: 90%;
        max-width: 1200px;
        background: var(--bg-surface);
        border-radius: 12px;
        display: flex;
        flex-direction: column;
        overflow: hidden;
        box-shadow: 0 10px 40px rgba(0,0,0,0.3);
    }

    .modal-ventas-header {
        padding: 12px 20px;
        background: var(--bs-primary);
        color: white;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .modal-ventas-body {
        flex: 1;
        overflow: hidden;
    }

    .iframe-ventas {
        width: 100%;
        height: 100%;
        border: none;
    }

    /* ========== ALERTAS COCINA ========== */
    .alertas-cocina {
        background: linear-gradient(135deg, rgba(220, 53, 69, 0.1), rgba(255, 193, 7, 0.1));
        border-top: 2px solid var(--bs-danger) !important;
    }

    .alertas-cocina .badge {
        padding: 6px 10px;
        font-size: 0.8rem;
    }

    .blink-success {
        animation: blink-green 0.8s infinite;
    }

    @@keyframes blink-green {
        0%, 100% { opacity: 1; box-shadow: 0 0 8px rgba(40, 167, 69, 0.8); }
        50% { opacity: 0.7; box-shadow: 0 0 2px rgba(40, 167, 69, 0.3); }
    }

    @@keyframes pulse-warning {
        0%, 100% { transform: scale(1); }
        50% { transform: scale(1.05); }
    }

    @@keyframes pulse-danger {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.7; }
    }

    .listos-detalle {
        max-height: 80px;
        overflow-y: auto;
        font-size: 0.8rem;
    }

    /* ========== RESPONSIVE ========== */
    @@media (max-width: 768px) {
        .mesas-panel-container {
            flex-direction: column;
        }
        
        .panel-mesas, .panel-mesas.con-pedido {
            flex: 0 0 40%;
        }
        
        .panel-pedido {
            flex: 0 0 60%;
        }
        
        /* Agenda colapsada en m√≥vil - mesas compactas, pedido grande */
        .mesas-panel-container.agenda-colapsada .panel-mesas {
            flex: 0 0 50% !important;
        }
        
        .mesas-panel-container.agenda-colapsada .panel-mesas.con-pedido {
            flex: 0 0 30% !important;
            max-height: 30vh;
            overflow-y: auto;
        }
        
        .mesas-panel-container.agenda-colapsada .panel-pedido {
            flex: 1 1 auto !important;
            min-height: 65vh;
            max-height: none;
            overflow: visible;
        }
        
        .mesas-panel-container.agenda-colapsada .panel-agenda.colapsado {
            flex: 0 0 35px !important;
            display: flex;
            min-height: 35px;
            max-height: 35px;
        }
        
        /* Productos grid m√°s grande cuando agenda colapsada */
        .mesas-panel-container.agenda-colapsada .productos-grid {
            max-height: 50vh !important;
            min-height: 200px;
        }
        
        /* Detalle pedido m√°s espacio */
        .mesas-panel-container.agenda-colapsada .detalle-items-container {
            max-height: 35vh;
        }

        .mesas-grid {
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
        }
        
        /* Panel mesas oculto en m√≥vil */
        .panel-mesas.mesas-ocultas {
            display: none !important;
        }
        
        /* Panel pedido expandido cuando mesas ocultas */
        .panel-pedido.mesas-expandido {
            flex: 1 1 100% !important;
            max-width: 100% !important;
            height: 100vh;
        }
        
        /* Encabezado del pedido m√°s prominente en m√≥vil */
        .panel-pedido.mesas-expandido .pedido-header {
            padding: 8px 10px;
            background: linear-gradient(135deg, var(--bs-primary), #0a58ca);
            color: white;
        }
        
        .panel-pedido.mesas-expandido .pedido-header h5 {
            font-size: 1rem;
            color: white;
        }
        
        .panel-pedido.mesas-expandido .pedido-header .text-muted {
            color: rgba(255,255,255,0.8) !important;
        }
        
        .panel-pedido.mesas-expandido .pedido-header .btn-primary {
            background: white;
            color: var(--bs-primary);
            border-color: white;
            font-weight: 600;
            padding: 5px 12px;
            font-size: 0.85rem;
        }
        
        .panel-pedido.mesas-expandido .pedido-header .btn-outline-secondary {
            background: rgba(255,255,255,0.2);
            color: white;
            border-color: rgba(255,255,255,0.5);
        }
        
        /* Botones de acci√≥n compactos en m√≥vil */
        .panel-pedido.mesas-expandido .acciones-pedido {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            padding: 6px 8px;
        }
        
        .panel-pedido.mesas-expandido .acciones-pedido .btn {
            padding: 8px 10px;
            font-size: 0.75rem;
            flex: 1 1 auto;
            min-width: 70px;
        }
        
        .panel-pedido.mesas-expandido .acciones-pedido .btn-success {
            flex: 1 1 100%;
        }
        
        /* Grid de productos m√°s grande para m√≥vil - im√°genes m√°s peque√±as */
        .panel-pedido.mesas-expandido .productos-grid {
            grid-template-columns: repeat(auto-fill, minmax(70px, 1fr));
            gap: 4px;
            padding: 4px;
            max-height: 45vh;
            flex: 1;
        }
        
        .panel-pedido.mesas-expandido .producto-card .producto-imagen {
            height: 50px;
        }
        
        .panel-pedido.mesas-expandido .producto-card .producto-info {
            padding: 3px;
        }
        
        .panel-pedido.mesas-expandido .producto-card .producto-nombre {
            font-size: 0.6rem;
            height: 2em;
        }
        
        .panel-pedido.mesas-expandido .producto-card .producto-precio {
            font-size: 0.7rem;
        }
        
        /* Detalles del pedido scrolleable */
        .panel-pedido.mesas-expandido .detalle-items-container {
            max-height: 30vh;
            overflow-y: auto;
        }
        
        /* B√∫squeda m√°s compacta */
        .panel-pedido.mesas-expandido .pedido-busqueda {
            padding: 4px 6px;
        }
        
        /* Categor√≠as scroll horizontal */
        .panel-pedido.mesas-expandido .categorias-rapidas {
            overflow-x: auto;
            flex-wrap: nowrap;
            padding-bottom: 4px;
            gap: 3px;
        }
        
        .panel-pedido.mesas-expandido .categorias-rapidas .btn-xs {
            white-space: nowrap;
            flex-shrink: 0;
            padding: 2px 6px;
            font-size: 0.6rem;
        }
        
        /* Totales m√°s compactos */
        .panel-pedido.mesas-expandido .totales-pedido {
            padding: 6px 8px;
            font-size: 0.85rem;
        }
        
        /* ========== PANEL AGENDA EN M√ìVIL ========== */
        .panel-agenda {
            flex: 1 1 auto !important;
            min-height: 55vh;
            max-height: none;
            overflow: visible;
        }
        
        .panel-agenda .agenda-contenido {
            height: 100%;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .panel-agenda .grilla-disponibilidad {
            flex: 1;
            overflow-y: auto;
            min-height: 0;
        }
        
        .panel-agenda .grilla-body {
            min-height: 200px;
            max-height: none;
        }
        
        .panel-agenda .agenda-lista {
            flex: 1;
            overflow-y: auto;
            min-height: 200px;
        }
        
        /* Grilla controles m√°s compactos en m√≥vil */
        .panel-agenda .grilla-controles {
            padding: 6px 8px;
        }
        
        .panel-agenda .grilla-controles .form-select-sm,
        .panel-agenda .grilla-controles .form-control-sm {
            font-size: 0.75rem;
            padding: 0.2rem 0.4rem;
        }
        
        .panel-agenda .grilla-controles .btn-sm {
            padding: 0.2rem 0.4rem;
            font-size: 0.75rem;
        }
    }
    
    /* Para pantallas muy peque√±as (menos de 400px) */
    @@media (max-width: 400px) {
        .panel-pedido.mesas-expandido .productos-grid {
            grid-template-columns: repeat(4, 1fr);
            gap: 3px;
        }
        
        .panel-pedido.mesas-expandido .producto-card .producto-imagen {
            height: 45px;
        }
        
        .panel-pedido.mesas-expandido .producto-card .producto-nombre {
            font-size: 0.55rem;
        }
        
        .panel-pedido.mesas-expandido .producto-card .producto-precio {
            font-size: 0.65rem;
        }
        
        .panel-pedido.mesas-expandido .acciones-pedido .btn {
            padding: 6px 8px;
            font-size: 0.7rem;
        }
        
        /* Panel agenda en pantallas muy peque√±as */
        .panel-agenda {
            min-height: 50vh;
        }
        
        .panel-agenda .agenda-header {
            padding: 6px 8px;
        }
        
        .panel-agenda .grilla-controles {
            padding: 4px 6px;
        }
        
        .panel-agenda .grilla-body {
            min-height: 180px;
        }
    }
</style>

@code {
    // ========== TIMER PARA ACTUALIZACI√ìN AUTOM√ÅTICA ==========
    private System.Threading.Timer? _timerActualizacion;
    private System.Threading.Timer? _timerEstadosCocina;
    private System.Threading.Timer? _timerVerificarCaja;
    private bool _disposed = false;
    
    // ========== ESTADO GENERAL ==========
    private bool _cargando = true;
    private bool _guardando = false;
    private bool _cerrando = false;
    private int _idSucursal = 1;
    private int? _idCaja;
    private int _turnoActual = 1;
    private DateTime _fechaCaja = DateTime.Today;

    // ========== TIPO DE NEGOCIO Y MODO ==========
    private string _tipoNegocio = "Restaurante";
    private bool _modoCanchas = false;
    private bool _modoTaller = false;
    
    // Propiedades din√°micas basadas en TipoNegocioMesas
    private string _terminoEspacio => _tipoNegocio switch
    {
        "Complejo" => "Cancha",
        "Taller" => "Bah√≠a",
        _ => "Mesa"
    };
    private string _terminoEspacioPlural => _tipoNegocio switch
    {
        "Complejo" => "Canchas",
        "Taller" => "Bah√≠as",
        _ => "Mesas"
    };
    private string _iconoEspacio => _tipoNegocio switch
    {
        "Complejo" => "bi-dribbble",
        "Taller" => "bi-wrench",
        _ => "bi-grid-3x3-gap"
    };
    private string _tituloPanel => _tipoNegocio switch
    {
        "Complejo" => "Panel de Canchas",
        "Taller" => "Panel de Bah√≠as",
        _ => "Panel de Mesas"
    };
    
    private HashSet<int> _reservasIniciadas = new(); // IDs de reservas a las que ya se toc√≥ sonido de inicio
    private HashSet<int> _reservasFinalizadas = new(); // IDs de reservas a las que ya se toc√≥ sonido de fin
    private Dictionary<int, TimeSpan> _tiemposRestantes = new(); // IdReserva -> Tiempo restante
    
    // Modal detalle cancha
    private bool _mostrarModalDetalleCancha = false;
    private Reserva? _canchaDetalleReserva;
    private Mesa? _canchaDetalleMesa;

    // ========== MODAL PAGO SE√ëA ==========
    private bool _mostrarModalPagoSena = false;
    private bool _guardandoPagoSena = false;
    private string _mensajePagoSena = "";
    private bool _pagoSenaExito = false;
    private MedioPago _medioPagoSena = MedioPago.Efectivo;
    private string? _numeroAutorizacionSena;
    private string? _marcaTarjetaSena;
    private string? _bancoTransferenciaSena;
    private string? _numeroComprobanteSena;
    private TipoTarjeta? _tipoTarjetaSena;

    // ========== DATOS ==========
    private List<Mesa> _mesas = new();
    private List<Mesa> _mesasFiltradas = new();
    private List<Pedido> _pedidosActivos = new();
    private List<Reserva> _reservasProximas = new();
    private List<Reserva> _reservasHoy = new(); // Reservas de la fecha agenda
    private DateTime _fechaAgenda = DateTime.Today; // Fecha seleccionada en agenda (Vista Lista)
    private List<string> _zonas = new();
    private string? _zonaFiltro;
    private string? _tipoEspacioFiltro; // Filtro por tipo (Cancha, Mesa) en modo Complejo
    private Models.ConfiguracionSistema? _config;
    private Sucursal? _sucursalActual;

    // ========== GRILLA DE DISPONIBILIDAD ==========
    private DateTime _fechaGrilla = DateTime.Today;
    private TimeSpan _horaInicioGrilla = new TimeSpan(7, 0, 0);
    private TimeSpan _horaFinGrilla = new TimeSpan(23, 0, 0);
    private int _intervaloMinutos = 60; // 60 minutos por celda
    private bool _vistaGrilla = true; // true=grilla, false=lista
    private int? _mesaSeleccionadaGrilla = null; // null = todas, o IdMesa espec√≠fico
    private List<Reserva> _reservasFechaGrilla = new(); // Reservas del d√≠a seleccionado en grilla
    private Reserva? _nuevaReserva = null; // Reserva que se est√° creando desde la grilla
    private bool _mostrarModalReserva = false; // Modal de crear/editar reserva
    private string _mensajeReservaGrilla = ""; // Mensaje en modal de reserva grilla
    private bool _reservaGrillaExito = false; // Si el mensaje es de √©xito
    private bool _guardandoReservaGrilla = false; // Spinner de guardado
    
    // B√∫squeda de clientes para reserva r√°pida
    private List<Cliente> _clientesReserva = new();
    private List<Cliente> _clientesFiltradosReserva = new();
    private bool _mostrarSugerenciasClienteReserva = false;
    private string _buscarClienteReservaTexto = "";
    private bool _mouseDownEnSugerenciaReserva = false;

    // ========== UNIR MESAS (DRAG & DROP) ==========
    private Mesa? _mesaArrastrada = null;
    private Mesa? _mesaDestino = null;
    private bool _mostrarModalUnirMesas = false;
    private bool _uniendoMesas = false;
    private string _mensajeUnion = "";
    private string _mensajeExito = "";
    private string _mensajeError = "";
    private bool _mostrarSelectorMesaDestino = false;

    // ========== MEN√ö CONTEXTUAL (CLIC DERECHO) ==========
    private bool _mostrarMenuContextual = false;
    private Mesa? _mesaMenuContextual = null;
    private double _menuContextualX = 0;
    private double _menuContextualY = 0;

    // ========== MESA SELECCIONADA ==========
    private Mesa? _mesaSeleccionada;
    private Pedido? _pedidoActual;
    private List<PedidoDetalle> _detallesPedido = new();
    private HashSet<int> _itemsSeleccionados = new();

    // ========== PRODUCTOS ==========
    private string _busquedaProducto = "";
    private int? _clasificacionSeleccionada;
    private List<Producto> _productosDisponibles = new();
    private List<Producto> _productosFiltrados = new();
    private List<Clasificacion> _clasificaciones = new();

    // ========== MODAL VENTAS ==========
    private bool _mostrarModalVentas = false;
    private string _urlVentas = "";

    // ========== AGENDA ==========
    private bool _mostrarAgenda = true;
    
    // ========== PANEL MESAS M√ìVIL ==========
    private bool _ocultarPanelMesas = false;

    // ========== CERRAR MESA ==========
    private bool _mostrarConfirmarCerrarMesa = false;
    private List<PedidoDetalle> _itemsNoFacturados = new();
    
    // ========== CORTES√çA DE LA CASA ==========
    private bool _mostrarModalCortesia = false;
    private string _usuarioCortesia = "";
    private string _passwordCortesia = "";
    private string _motivoCortesia = "";
    private string _errorCortesia = "";
    private bool _validandoCortesia = false;
    private decimal _saldoPendienteCortesia = 0;

    // ========== COMANDA ==========
    private bool _imprimiendoComanda = false;
    private bool _reimprimiendoComanda = false;
    private bool _imprimiendoPedido = false;
    private int _numeroComanda = 0;
    private Caja? _cajaActual;

    // ========== ALERTAS COCINA ==========
    private bool _modoRestaurante = false;
    private int _itemsPendientesCocina = 0;
    private int _itemsEnPreparacion = 0;
    private int _itemsListosServir = 0;
    private List<ItemCocinaDetalle> _detallesListosServir = new();
    private List<ItemCocinaDetalle> _detallesEnPreparacion = new();
    private List<ItemCocinaDetalle> _detallesPendientes = new();
    private bool _sonidosCocinaActivo = true;
    private int _listosAnterior = 0; // Para detectar nuevos items listos

    private class ItemCocinaDetalle
    {
        public string Mesa { get; set; } = "";
        public string Descripcion { get; set; } = "";
        public DateTime? Fecha { get; set; }
    }

    // ========== CALCULADOS ==========
    private decimal _totalPedidoGeneral => _detallesPedido.Sum(d => d.Importe); // Total de todo el pedido
    private decimal _montoFacturadoVentas = 0; // Monto facturado real (suma de ventas con IdPedido + MontoPagado del pedido)
    private decimal _totalPedido => Math.Max(0, _totalPedidoGeneral - _montoFacturadoVentas); // Pendiente de facturar
    private decimal _totalSeleccionado => _detallesPedido
        .Where(d => _itemsSeleccionados.Contains(d.IdPedidoDetalle))
        .Sum(d => d.Importe);

    [CascadingParameter]
    private Task<AuthenticationState> AuthStateTask { get; set; } = default!;
    
    private DotNetObjectReference<MesasPanel>? _dotNetRef;

    protected override async Task OnInitializedAsync()
    {
        // ========== OBTENER SUCURSAL DEL PROVIDER (igual que Ventas) ==========
        var sucId = SucursalProvider.GetSucursalId();
        if (sucId.HasValue)
        {
            _idSucursal = sucId.Value;
        }
        
        await CargarDatos();
        
        // Iniciar timer que actualiza cada segundo para mostrar tiempo en reservas y canchas
        _timerActualizacion = new System.Threading.Timer(async _ =>
        {
            if (!_disposed)
            {
                // Modo canchas: actualizar tiempos restantes y verificar finalizaciones
                if (_modoCanchas)
                {
                    await ActualizarTiemposCanchasAsync();
                }
                else if (_reservasHoy.Any(r => r.Estado == "EnCurso"))
                {
                    await InvokeAsync(StateHasChanged);
                }
            }
        }, null, TimeSpan.FromSeconds(1), TimeSpan.FromSeconds(1));

        // Timer para actualizar estados de cocina cada 5 segundos
        _timerEstadosCocina = new System.Threading.Timer(async _ =>
        {
            await ActualizarEstadosCocinaAsync();
        }, null, TimeSpan.FromSeconds(5), TimeSpan.FromSeconds(5));
        
        // Timer para verificar cambios en la caja cada 30 segundos (cierre de caja)
        _timerVerificarCaja = new System.Threading.Timer(async _ =>
        {
            await VerificarCambioCajaAsync();
        }, null, TimeSpan.FromSeconds(30), TimeSpan.FromSeconds(30));
    }
    
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            // Registrar listener para mensajes del iframe (Ventas)
            _dotNetRef = DotNetObjectReference.Create(this);
            
            // Guardar referencia global para el event listener
            await JS.InvokeVoidAsync("eval", $@"
                window._mesasPanelDotNetRef = DotNet.createJSObjectReference({{}});
            ");
            
            // Configurar el handler con la referencia correcta
            await JS.InvokeVoidAsync("eval", @"
                if (window._mesasPanelMsgHandler) {
                    window.removeEventListener('message', window._mesasPanelMsgHandler);
                }
                window._mesasPanelMsgHandler = function(e) {
                    if (e.data && (e.data.tipo === 'ventaGuardada' || e.data.tipo === 'ventaModalCerrar')) {
                        console.log('[MesasPanel] Mensaje recibido:', e.data.tipo, e.data);
                        // Cerrar el modal e invocar callback
                        if (window._mesasPanelCallback) {
                            window._mesasPanelCallback(e.data.idVenta || 0, e.data.idPedido || 0, e.data.impreso || false);
                        }
                    }
                };
                window.addEventListener('message', window._mesasPanelMsgHandler);
            ");
            
            // Registrar callback que invoca el m√©todo del componente
            await JS.InvokeVoidAsync("eval", @"
                window._mesasPanelCallback = async function(idVenta, idPedido, impreso) {
                    console.log('[MesasPanel] Callback ejecutado - impreso:', impreso);
                    // Cerrar el modal forzando un click en el overlay
                    var overlay = document.querySelector('.modal-ventas-overlay');
                    if (overlay) {
                        overlay.click();
                    }
                };
            ");
        }
    }
    
    [JSInvokable]
    public async Task OnVentaGuardada(int idVenta, int idPedido)
    {
        Console.WriteLine($"[MesasPanel] Venta #{idVenta} guardada para pedido #{idPedido}");
        
        // Cerrar modal y refrescar
        _mostrarModalVentas = false;
        _urlVentas = "";
        
        await Refrescar();
        
        if (_mesaSeleccionada != null)
        {
            await CargarPedidoMesa(_mesaSeleccionada);
        }
        
        await InvokeAsync(StateHasChanged);
    }

    private async Task CargarDatos()
    {
        _cargando = true;
        StateHasChanged();

        try
        {
            await using var db = await DbFactory.CreateDbContextAsync();

            _config = await db.ConfiguracionSistema.FirstOrDefaultAsync();
            
            // ========== OBTENER CAJA DE LA MISMA FORMA QUE VENTAS ==========
            // Primero intentar obtener del CajaProvider (caja seleccionada en sesi√≥n)
            var cajaIdProvider = CajaProvider.GetCajaId();
            if (cajaIdProvider.HasValue)
            {
                _cajaActual = await db.Cajas.AsNoTracking().FirstOrDefaultAsync(c => c.IdCaja == cajaIdProvider.Value);
            }
            
            // Si no hay caja en provider, buscar la marcada como actual
            if (_cajaActual == null)
            {
                _cajaActual = await db.Cajas.AsNoTracking().FirstOrDefaultAsync(c => c.CajaActual == 1);
            }
            
            // Si a√∫n no hay, tomar la primera disponible
            if (_cajaActual == null)
            {
                _cajaActual = await db.Cajas.AsNoTracking().FirstOrDefaultAsync();
            }
            
            _sucursalActual = await db.Sucursal.FirstOrDefaultAsync(s => s.Id == _idSucursal);
            
            // ========== USAR FECHA DE CAJA Y TURNO ==========
            if (_cajaActual != null)
            {
                _fechaCaja = _cajaActual.FechaActualCaja ?? DateTime.Today;
                _turnoActual = _cajaActual.TurnoActual ?? 1;
                _idCaja = _cajaActual.IdCaja;
                _idSucursal = _cajaActual.IdSucursal ?? 1;
            }
            
            // Verificar modo restaurante y modo canchas basado en TipoNegocioMesas
            _modoRestaurante = _config?.RestauranteModoActivo == true;
            _tipoNegocio = _config?.TipoNegocioMesas ?? "Restaurante";
            _modoCanchas = _tipoNegocio == "Complejo";
            _modoTaller = _tipoNegocio == "Taller";
            
            // En modo Complejo, activar vista de grilla por defecto
            if (_modoCanchas)
            {
                _vistaGrilla = true;
            }
            
            // ========== SINCRONIZAR FECHA GRILLA Y AGENDA CON FECHA DE CAJA ==========
            _fechaGrilla = _fechaCaja;
            _fechaAgenda = _fechaCaja;

            // Filtrar mesas/canchas/bah√≠as seg√∫n el tipo de negocio
            // En modo Complejo: mostrar tanto Canchas como Mesas (para bar/restaurant del complejo)
            List<string>? tiposFiltro = _tipoNegocio switch
            {
                "Complejo" => new List<string> { "Cancha", "Mesa" }, // Canchas + Mesas para ventas
                "Taller" => new List<string> { "Bahia" },
                _ => null // Restaurante: no filtra por tipo
            };

            _mesas = await db.Mesas
                .Include(m => m.MesasUnidas) // Incluir mesas unidas
                .Where(m => m.IdSucursal == _idSucursal && m.Activa)
                .Where(m => tiposFiltro == null || tiposFiltro.Contains(m.Tipo))
                .OrderBy(m => m.Tipo) // Agrupar por tipo primero (Cancha, Mesa)
                .ThenBy(m => m.Orden)
                .ThenBy(m => m.Numero.Length) // Ordenar por longitud primero (1,2,3 antes de 10,11,12)
                .ThenBy(m => m.Numero)
                .ToListAsync();

            _zonas = _mesas
                .Where(m => !string.IsNullOrEmpty(m.Zona))
                .Select(m => m.Zona!)
                .Distinct()
                .OrderBy(z => z)
                .ToList();

            _pedidosActivos = await db.Pedidos
                .Where(p => p.IdSucursal == _idSucursal 
                         && (p.Estado == "Abierto" || p.Estado == "EnCurso" || p.Estado == "PendientePago"))
                .Include(p => p.Mesa)
                .Include(p => p.Detalles)
                .ToListAsync();

            var ahora = DateTime.Now;
            var hoy = ahora.Date;
            var horaLimite = ahora.AddHours(2).TimeOfDay;

            _reservasProximas = await db.Reservas
                .Where(r => r.IdSucursal == _idSucursal 
                         && r.FechaReserva.Date == hoy
                         && r.HoraInicio <= horaLimite
                         && r.Estado != "Cancelada"
                         && r.Estado != "Completada")
                .ToListAsync();

            // Reservas para el panel de agenda (usa _fechaAgenda)
            _reservasHoy = await db.Reservas
                .Where(r => r.IdSucursal == _idSucursal 
                         && r.FechaReserva.Date == _fechaAgenda.Date
                         && r.Estado != "Cancelada")
                .OrderBy(r => r.HoraInicio)
                .ToListAsync();

            // ========== CARGAR ESTADO DE COCINA ==========
            if (_modoRestaurante)
            {
                await CargarEstadoCocina(db, hoy);
            }

            // Cargar productos y categor√≠as (solo los visibles en mesas)
            _productosDisponibles = await db.Productos
                .Include(p => p.Clasificacion)
                .Where(p => p.Activo && p.VisibleEnMesas)
                .OrderBy(p => p.Descripcion)
                .ToListAsync();

            // Solo cargar clasificaciones que tienen al menos un producto visible en mesas
            var idsClasificacionesConProductos = _productosDisponibles
                .Where(p => p.IdClasificacion.HasValue)
                .Select(p => p.IdClasificacion!.Value)
                .Distinct()
                .ToHashSet();
            
            _clasificaciones = await db.Clasificaciones
                .Where(c => c.Activo && idsClasificacionesConProductos.Contains(c.IdClasificacion))
                .OrderBy(c => c.Nombre)
                .ToListAsync();

            _productosFiltrados = _productosDisponibles.Take(24).ToList();

            AplicarFiltro();
            
            // Cargar reservas para la grilla visual (modo Complejo)
            if (_modoCanchas && _vistaGrilla)
            {
                await CargarReservasFechaGrilla();
            }
            
            // Cargar clientes para b√∫squeda en reserva r√°pida
            _clientesReserva = await db.Clientes
                .Where(c => c.Estado)
                .OrderBy(c => c.RazonSocial)
                .Take(500) // Limitar para rendimiento
                .ToListAsync();
        }
        finally
        {
            _cargando = false;
            StateHasChanged();
        }
    }

    /// <summary>
    /// Carga el estado de items en cocina para mostrar alertas al cajero
    /// </summary>
    private async Task CargarEstadoCocina(AppDbContext db, DateTime hoy)
    {
        try
        {
            // Items enviados a cocina del d√≠a
            var itemsCocina = await db.PedidosDetalles
                .Include(d => d.Pedido)
                    .ThenInclude(p => p!.Mesa)
                .Where(d => d.Pedido != null 
                    && d.Pedido.FechaApertura.Date == hoy
                    && d.EnviadoCocina
                    && d.Estado != "Entregado"
                    && d.Estado != "Cancelado")
                .AsNoTracking()
                .ToListAsync();

            _itemsPendientesCocina = itemsCocina.Count(i => i.Estado == "Pendiente");
            _itemsEnPreparacion = itemsCocina.Count(i => i.Estado == "EnPreparacion");
            _itemsListosServir = itemsCocina.Count(i => i.Estado == "Listo");

            // Detalle de items PENDIENTES (por mesa)
            _detallesPendientes = itemsCocina
                .Where(i => i.Estado == "Pendiente")
                .OrderBy(i => i.FechaEnvioCocina)
                .Select(i => new ItemCocinaDetalle
                {
                    Mesa = i.Pedido?.Mesa?.TextoMostrar ?? $"{_terminoEspacio} {i.Pedido?.IdMesa}",
                    Descripcion = $"{(int)i.Cantidad}x {i.Descripcion}",
                    Fecha = i.FechaEnvioCocina
                })
                .ToList();

            // Detalle de items EN PREPARACI√ìN (por mesa)
            _detallesEnPreparacion = itemsCocina
                .Where(i => i.Estado == "EnPreparacion")
                .OrderBy(i => i.FechaEnvioCocina)
                .Select(i => new ItemCocinaDetalle
                {
                    Mesa = i.Pedido?.Mesa?.TextoMostrar ?? $"{_terminoEspacio} {i.Pedido?.IdMesa}",
                    Descripcion = $"{(int)i.Cantidad}x {i.Descripcion}",
                    Fecha = i.FechaEnvioCocina
                })
                .ToList();

            // Detalle de items LISTOS para servir (por mesa)
            _detallesListosServir = itemsCocina
                .Where(i => i.Estado == "Listo")
                .OrderByDescending(i => i.FechaEntrega)
                .Select(i => new ItemCocinaDetalle
                {
                    Mesa = i.Pedido?.Mesa?.TextoMostrar ?? $"{_terminoEspacio} {i.Pedido?.IdMesa}",
                    Descripcion = $"{(int)i.Cantidad}x {i.Descripcion}",
                    Fecha = i.FechaEntrega
                })
                .ToList();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"[MesasPanel] Error cargando estado cocina: {ex.Message}");
        }
    }

    private async Task Refrescar()
    {
        await CargarDatos();
        if (_mesaSeleccionada != null)
        {
            await CargarPedidoMesa(_mesaSeleccionada);
        }
    }

    private void FiltrarPorZona(string? zona)
    {
        _zonaFiltro = zona;
        AplicarFiltro();
    }
    
    private void FiltrarPorTipoEspacio(string? tipo)
    {
        _tipoEspacioFiltro = tipo;
        AplicarFiltro();
    }

    private void AplicarFiltro()
    {
        var filtradas = _mesas.AsEnumerable();
        
        // Filtrar por zona si aplica
        if (!string.IsNullOrEmpty(_zonaFiltro))
        {
            filtradas = filtradas.Where(m => m.Zona == _zonaFiltro);
        }
        
        // Filtrar por tipo de espacio si aplica (modo Complejo)
        if (!string.IsNullOrEmpty(_tipoEspacioFiltro))
        {
            filtradas = filtradas.Where(m => m.Tipo == _tipoEspacioFiltro);
        }
        
        _mesasFiltradas = filtradas.ToList();
    }

    private string ObtenerEstiloMesaCard(Mesa mesa, string colorFondo)
    {
        var estilo = $"background-color: {colorFondo};";
        
        if (!string.IsNullOrEmpty(mesa.ImagenUrl))
        {
            estilo += $" background-image: linear-gradient(rgba(0,0,0,0.3), rgba(0,0,0,0.5)), url('{mesa.ImagenUrl}'); background-size: cover; background-position: center;";
        }
        
        return estilo;
    }

    // ========== SELECCI√ìN DE MESA ==========

    private async Task SeleccionarMesa(Mesa mesa)
    {
        _mesaSeleccionada = mesa;
        _itemsSeleccionados.Clear();
        
        // En m√≥vil, ocultar autom√°ticamente el panel de mesas al seleccionar
        try
        {
            var esMobile = await JS.InvokeAsync<bool>("eval", "window.innerWidth <= 768");
            if (esMobile)
            {
                _ocultarPanelMesas = true;
            }
        }
        catch
        {
            // Si falla la detecci√≥n, no hacer nada
        }
        
        await CargarPedidoMesa(mesa);
    }
    
    // ========== PANEL MESAS M√ìVIL ==========
    
    private void OcultarPanelMesas()
    {
        _ocultarPanelMesas = true;
    }
    
    private void MostrarPanelMesas()
    {
        _ocultarPanelMesas = false;
    }

    private async Task CargarPedidoMesa(Mesa mesa)
    {
        await using var db = await DbFactory.CreateDbContextAsync();

        // Buscar pedido activo - AsNoTracking para obtener datos frescos
        _pedidoActual = await db.Pedidos
            .AsNoTracking()
            .Include(p => p.Detalles)
            .Include(p => p.Pagos)
            .FirstOrDefaultAsync(p => p.IdMesa == mesa.IdMesa && 
                (p.Estado == "Abierto" || p.Estado == "EnCurso" || p.Estado == "PendientePago"));

        if (_pedidoActual != null)
        {
            // Recargar detalles frescos de la BD (incluir Producto y Clasificaci√≥n para comandas)
            _detallesPedido = await db.PedidosDetalles
                .AsNoTracking()
                .Include(d => d.Producto)
                    .ThenInclude(p => p!.Clasificacion)
                .Where(d => d.IdPedido == _pedidoActual.IdPedido)
                .ToListAsync();
            
            // Calcular monto facturado sumando:
            // 1. MontoPagado del pedido (consumiciones, anticipos)
            // 2. Ventas vinculadas a este pedido
            var ventasAnteriores = await db.Ventas
                .AsNoTracking()
                .Where(v => v.IdPedido == _pedidoActual.IdPedido && v.Estado != "Anulada")
                .SumAsync(v => v.Total);
            _montoFacturadoVentas = (_pedidoActual.MontoPagado) + ventasAnteriores;
        }
        else
        {
            // Crear nuevo pedido
            _pedidoActual = new Pedido
            {
                IdMesa = mesa.IdMesa,
                IdSucursal = _idSucursal,
                IdCaja = _idCaja,
                Turno = _turnoActual,
                FechaCaja = _fechaCaja,
                FechaApertura = DateTime.Now,
                HoraInicio = DateTime.Now,
                Estado = "Abierto"
            };
            _detallesPedido = new();
            _montoFacturadoVentas = 0;
        }

        StateHasChanged();
    }

    /// <summary>
    /// Actualiza los estados de cocina de los detalles del pedido actual y los contadores globales
    /// </summary>
    private async Task ActualizarEstadosCocinaAsync()
    {
        if (_disposed)
            return;

        try
        {
            await using var db = await DbFactory.CreateDbContextAsync();
            
            // ========== ACTUALIZAR CONTADORES GLOBALES (badge superior) ==========
            // Usar fecha de caja para filtrar items de cocina
            var itemsCocina = await db.PedidosDetalles
                .Include(d => d.Pedido)
                    .ThenInclude(p => p!.Mesa)
                .Where(d => d.Pedido != null 
                    && d.Pedido.FechaApertura.Date == _fechaCaja.Date
                    && d.EnviadoCocina
                    && d.Estado != "Entregado"
                    && d.Estado != "Cancelado")
                .AsNoTracking()
                .ToListAsync();

            var nuevosPendientes = itemsCocina.Count(i => i.Estado == "Pendiente");
            var nuevosEnPrep = itemsCocina.Count(i => i.Estado == "EnPreparacion");
            var nuevosListos = itemsCocina.Count(i => i.Estado == "Listo");

            bool contadoresCambiaron = _itemsPendientesCocina != nuevosPendientes 
                                     || _itemsEnPreparacion != nuevosEnPrep 
                                     || _itemsListosServir != nuevosListos;

            _itemsPendientesCocina = nuevosPendientes;
            _itemsEnPreparacion = nuevosEnPrep;
            _itemsListosServir = nuevosListos;

            // Actualizar detalle de items PENDIENTES (por mesa)
            _detallesPendientes = itemsCocina
                .Where(i => i.Estado == "Pendiente")
                .OrderBy(i => i.FechaEnvioCocina)
                .Select(i => new ItemCocinaDetalle
                {
                    Mesa = i.Pedido?.Mesa?.TextoMostrar ?? $"{_terminoEspacio} {i.Pedido?.IdMesa}",
                    Descripcion = $"{(int)i.Cantidad}x {i.Descripcion}",
                    Fecha = i.FechaEnvioCocina
                })
                .ToList();

            // Actualizar detalle de items EN PREPARACI√ìN (por mesa)
            _detallesEnPreparacion = itemsCocina
                .Where(i => i.Estado == "EnPreparacion")
                .OrderBy(i => i.FechaEnvioCocina)
                .Select(i => new ItemCocinaDetalle
                {
                    Mesa = i.Pedido?.Mesa?.TextoMostrar ?? $"{_terminoEspacio} {i.Pedido?.IdMesa}",
                    Descripcion = $"{(int)i.Cantidad}x {i.Descripcion}",
                    Fecha = i.FechaEnvioCocina
                })
                .ToList();

            // Actualizar detalle de items LISTOS (por mesa)
            _detallesListosServir = itemsCocina
                .Where(i => i.Estado == "Listo")
                .OrderByDescending(i => i.FechaEntrega)
                .Select(i => new ItemCocinaDetalle
                {
                    Mesa = i.Pedido?.Mesa?.TextoMostrar ?? $"{_terminoEspacio} {i.Pedido?.IdMesa}",
                    Descripcion = $"{(int)i.Cantidad}x {i.Descripcion}",
                    Fecha = i.FechaEntrega
                })
                .ToList();

            // ========== DETECTAR CAMBIOS PARA SONIDOS ==========
            bool hayNuevosListos = nuevosListos > _listosAnterior;
            _listosAnterior = nuevosListos;

            // ========== ACTUALIZAR DETALLES DEL PEDIDO ACTUAL ==========
            bool detallesCambiaron = false;
            if (_pedidoActual != null && _detallesPedido.Any())
            {
                var idsDetalles = _detallesPedido.Select(d => d.IdPedidoDetalle).ToList();
                var estadosActualizados = await db.PedidosDetalles
                    .AsNoTracking()
                    .Where(d => idsDetalles.Contains(d.IdPedidoDetalle))
                    .Select(d => new { d.IdPedidoDetalle, d.Estado, d.EnviadoCocina, d.FechaEnvioCocina, d.FechaEntrega })
                    .ToDictionaryAsync(d => d.IdPedidoDetalle);

                foreach (var det in _detallesPedido)
                {
                    if (estadosActualizados.TryGetValue(det.IdPedidoDetalle, out var actualizado))
                    {
                        if (det.Estado != actualizado.Estado || 
                            det.EnviadoCocina != actualizado.EnviadoCocina ||
                            det.FechaEntrega != actualizado.FechaEntrega)
                        {
                            det.Estado = actualizado.Estado;
                            det.EnviadoCocina = actualizado.EnviadoCocina;
                            det.FechaEnvioCocina = actualizado.FechaEnvioCocina;
                            det.FechaEntrega = actualizado.FechaEntrega;
                            detallesCambiaron = true;
                        }
                    }
                }
            }

            if (contadoresCambiaron || detallesCambiaron)
            {
                await InvokeAsync(StateHasChanged);
                
                // Reproducir sonido si hay nuevos items listos
                if (hayNuevosListos && _sonidosCocinaActivo)
                {
                    await ReproducirSonidoCocina("listo");
                }
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"[MesasPanel] Error actualizando estados cocina: {ex.Message}");
        }
    }

    /// <summary>
    /// Verifica si la caja cambi√≥ (por cierre de caja) y recarga los datos si es necesario
    /// </summary>
    private async Task VerificarCambioCajaAsync()
    {
        if (_disposed || _cajaActual == null)
            return;

        try
        {
            await using var db = await DbFactory.CreateDbContextAsync();
            
            // Obtener la caja actual desde la BD
            var cajaDb = await db.Cajas.AsNoTracking()
                .FirstOrDefaultAsync(c => c.IdCaja == _cajaActual.IdCaja);

            if (cajaDb == null)
                return;

            // Verificar si cambi√≥ la fecha o el turno
            var fechaCajaDb = cajaDb.FechaActualCaja ?? DateTime.Today;
            var turnoDb = cajaDb.TurnoActual ?? 1;

            bool cajaChanged = fechaCajaDb.Date != _fechaCaja.Date || turnoDb != _turnoActual;

            if (cajaChanged)
            {
                Console.WriteLine($"[MesasPanel] Cambio de caja detectado. Fecha: {_fechaCaja:dd/MM} ‚Üí {fechaCajaDb:dd/MM}, Turno: {_turnoActual} ‚Üí {turnoDb}");
                
                // Actualizar valores
                _fechaCaja = fechaCajaDb;
                _turnoActual = turnoDb;
                _cajaActual = cajaDb;

                // Recargar pedidos activos con la nueva fecha/turno
                await InvokeAsync(async () =>
                {
                    await CargarDatos();
                    StateHasChanged();
                });
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"[MesasPanel] Error verificando caja: {ex.Message}");
        }
    }

    // ========== DRAG & DROP - UNIR MESAS ==========
    
    private void OnDragStart(Mesa mesa)
    {
        // No permitir arrastrar deliverys
        if (mesa.Tipo == "Delivery")
            return;
            
        _mesaArrastrada = mesa;
        _mesaDestino = null;
    }
    
    private void OnDragEnd()
    {
        // Si no hay destino v√°lido, limpiar
        if (_mesaDestino == null)
        {
            _mesaArrastrada = null;
        }
    }
    
    private void OnDragEnter(Mesa mesa)
    {
        // No permitir soltar sobre s√≠ misma, sobre una mesa ya unida, o sobre delivery
        if (_mesaArrastrada != null && mesa.IdMesa != _mesaArrastrada.IdMesa 
            && !mesa.IdMesaPrincipal.HasValue && mesa.Tipo != "Delivery")
        {
            _mesaDestino = mesa;
            StateHasChanged();
        }
    }
    
    private void OnDragLeave()
    {
        // No limpiar el destino aqu√≠ para evitar parpadeo
    }
    
    private void OnDrop(Mesa mesa)
    {
        Console.WriteLine($"[MesasPanel] OnDrop: mesa={mesa.Numero}, arrastrada={_mesaArrastrada?.Numero ?? "null"}");
        
        if (_mesaArrastrada == null || mesa.IdMesa == _mesaArrastrada.IdMesa)
        {
            _mesaArrastrada = null;
            _mesaDestino = null;
            return;
        }
        
        // No permitir unir con delivery
        if (mesa.Tipo == "Delivery")
        {
            _mensajeError = "No se puede unir con una mesa de delivery";
            _ = LimpiarMensajeError();
            _mesaArrastrada = null;
            _mesaDestino = null;
            return;
        }
        
        // No permitir unir a una mesa que ya est√° unida a otra
        if (mesa.IdMesaPrincipal.HasValue)
        {
            _mesaArrastrada = null;
            _mesaDestino = null;
            return;
        }
        
        _mesaDestino = mesa;
        _mensajeUnion = "";
        _mostrarModalUnirMesas = true;
        Console.WriteLine($"[MesasPanel] Mostrando modal unir mesas: {_mesaArrastrada.Numero} -> {mesa.Numero}");
        StateHasChanged();
    }
    
    private void IniciarUnionDesdeContextMenu()
    {
        if (_mesaMenuContextual == null) return;
        
        _mesaArrastrada = _mesaMenuContextual;
        CerrarMenuContextual();
        _mostrarSelectorMesaDestino = true;
        StateHasChanged();
    }
    
    private void SeleccionarMesaDestino(Mesa mesa)
    {
        if (_mesaArrastrada == null || mesa.IdMesa == _mesaArrastrada.IdMesa)
            return;
            
        _mesaDestino = mesa;
        _mostrarSelectorMesaDestino = false;
        _mensajeUnion = "";
        _mostrarModalUnirMesas = true;
        StateHasChanged();
    }
    
    private void CancelarSelectorMesaDestino()
    {
        _mostrarSelectorMesaDestino = false;
        _mesaArrastrada = null;
    }
    
    private void CancelarUnion()
    {
        _mostrarModalUnirMesas = false;
        _mesaArrastrada = null;
        _mesaDestino = null;
        _mensajeUnion = "";
    }
    
    private async Task ConfirmarUnirMesas()
    {
        if (_mesaArrastrada == null || _mesaDestino == null)
            return;
            
        _uniendoMesas = true;
        _mensajeUnion = "";
        
        try
        {
            await using var db = await DbFactory.CreateDbContextAsync();
            
            var mesaOrigen = await db.Mesas.FindAsync(_mesaArrastrada.IdMesa);
            var mesaDestino = await db.Mesas.FindAsync(_mesaDestino.IdMesa);
            
            if (mesaOrigen == null || mesaDestino == null)
            {
                _mensajeUnion = "No se encontraron las mesas";
                return;
            }
            
            // Verificar pedidos activos
            var pedidoOrigen = await db.Pedidos
                .Include(p => p.Detalles)
                .FirstOrDefaultAsync(p => p.IdMesa == mesaOrigen.IdMesa 
                    && (p.Estado == "Abierto" || p.Estado == "EnCurso" || p.Estado == "PendientePago"));
                    
            var pedidoDestino = await db.Pedidos
                .Include(p => p.Detalles)
                .FirstOrDefaultAsync(p => p.IdMesa == mesaDestino.IdMesa 
                    && (p.Estado == "Abierto" || p.Estado == "EnCurso" || p.Estado == "PendientePago"));
            
            // Si ambas tienen pedido, fusionar los detalles al pedido destino
            if (pedidoOrigen != null && pedidoDestino != null)
            {
                // Mover todos los detalles del pedido origen al destino
                foreach (var detalle in pedidoOrigen.Detalles ?? new List<PedidoDetalle>())
                {
                    detalle.IdPedido = pedidoDestino.IdPedido;
                }
                
                // Actualizar totales del pedido destino
                pedidoDestino.Subtotal += pedidoOrigen.Subtotal;
                pedidoDestino.TotalDescuento += pedidoOrigen.TotalDescuento;
                pedidoDestino.TotalIva10 += pedidoOrigen.TotalIva10;
                pedidoDestino.TotalIva5 += pedidoOrigen.TotalIva5;
                pedidoDestino.TotalExenta += pedidoOrigen.TotalExenta;
                pedidoDestino.Total += pedidoOrigen.Total;
                pedidoDestino.MontoPagado += pedidoOrigen.MontoPagado;
                pedidoDestino.Comensales += pedidoOrigen.Comensales;
                
                // Agregar nota de fusi√≥n
                pedidoDestino.Observaciones = string.IsNullOrEmpty(pedidoDestino.Observaciones)
                    ? $"[Fusionado con Mesa {mesaOrigen.Numero}]"
                    : $"{pedidoDestino.Observaciones} [Fusionado con Mesa {mesaOrigen.Numero}]";
                
                // Cancelar el pedido origen
                pedidoOrigen.Estado = "Cancelado";
                pedidoOrigen.Observaciones = $"Fusionado con Mesa {mesaDestino.Numero} - Pedido #{pedidoDestino.IdPedido}";
                pedidoOrigen.FechaCierre = DateTime.Now;
            }
            else if (pedidoOrigen != null)
            {
                // Solo la mesa origen tiene pedido: moverlo a la mesa destino
                pedidoOrigen.IdMesa = mesaDestino.IdMesa;
                pedidoOrigen.Observaciones = string.IsNullOrEmpty(pedidoOrigen.Observaciones)
                    ? $"[Movido desde Mesa {mesaOrigen.Numero}]"
                    : $"{pedidoOrigen.Observaciones} [Movido desde Mesa {mesaOrigen.Numero}]";
            }
            
            // Marcar la mesa origen como unida a la destino
            mesaOrigen.IdMesaPrincipal = mesaDestino.IdMesa;
            mesaOrigen.Estado = "Libre";
            mesaOrigen.FechaModificacion = DateTime.Now;
            
            await db.SaveChangesAsync();
            
            // Recargar datos
            await CargarDatos();
            
            _mostrarModalUnirMesas = false;
            _mesaArrastrada = null;
            _mesaDestino = null;
            
            // Mostrar mensaje de √©xito
            _mensajeExito = $"Mesas unidas correctamente";
            _ = LimpiarMensajeExito();
            
            // Seleccionar la mesa destino
            _mesaSeleccionada = _mesas.FirstOrDefault(m => m.IdMesa == mesaDestino.IdMesa);
            if (_mesaSeleccionada != null)
            {
                await SeleccionarMesa(_mesaSeleccionada);
            }
        }
        catch (Exception ex)
        {
            _mensajeUnion = $"Error al unir mesas: {ex.Message}";
            Console.WriteLine($"[MesasPanel] Error uniendo mesas: {ex}");
        }
        finally
        {
            _uniendoMesas = false;
            StateHasChanged();
        }
    }
    
    private async Task SepararMesas()
    {
        if (_mesaSeleccionada == null)
            return;
            
        try
        {
            await using var db = await DbFactory.CreateDbContextAsync();
            
            // Buscar mesas unidas a esta principal
            var mesasUnidas = await db.Mesas
                .Where(m => m.IdMesaPrincipal == _mesaSeleccionada.IdMesa)
                .ToListAsync();
            
            if (!mesasUnidas.Any())
                return;
            
            // Separar todas las mesas
            foreach (var mesa in mesasUnidas)
            {
                mesa.IdMesaPrincipal = null;
                mesa.FechaModificacion = DateTime.Now;
            }
            
            await db.SaveChangesAsync();
            
            // Recargar datos
            await CargarDatos();
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"[MesasPanel] Error separando mesas: {ex}");
        }
    }

    // ========== MEN√ö CONTEXTUAL (CLIC DERECHO) ==========
    
    private void MostrarMenuContextual(MouseEventArgs e, Mesa mesa)
    {
        // Verificar si tiene mesas unidas usando la lista local _mesas
        var tieneMesasUnidas = _mesas.Any(m => m.IdMesaPrincipal == mesa.IdMesa);
        
        // Mostrar men√∫ con opciones disponibles
        _mesaMenuContextual = mesa;
        _menuContextualX = e.ClientX;
        _menuContextualY = e.ClientY;
        _mostrarMenuContextual = true;
        StateHasChanged();
    }
    
    private async Task CambiarFormaMesa(string nuevaForma)
    {
        if (_mesaMenuContextual == null) return;
        
        try
        {
            await using var db = await DbFactory.CreateDbContextAsync();
            var mesa = await db.Mesas.FindAsync(_mesaMenuContextual.IdMesa);
            if (mesa != null)
            {
                mesa.Forma = nuevaForma;
                mesa.FechaModificacion = DateTime.Now;
                await db.SaveChangesAsync();
                
                // Actualizar en la lista local
                var mesaLocal = _mesas.FirstOrDefault(m => m.IdMesa == _mesaMenuContextual.IdMesa);
                if (mesaLocal != null)
                {
                    mesaLocal.Forma = nuevaForma;
                }
                
                _mensajeExito = $"Forma de mesa {mesa.Numero} cambiada a {nuevaForma}";
                _ = LimpiarMensajeExito();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"[MesasPanel] Error cambiando forma: {ex}");
            _mensajeError = "Error al cambiar forma de mesa";
            _ = LimpiarMensajeError();
        }
        
        CerrarMenuContextual();
        StateHasChanged();
    }
    
    private void CerrarMenuContextual()
    {
        _mostrarMenuContextual = false;
        _mesaMenuContextual = null;
    }
    
    private async Task SepararMesasContextual()
    {
        if (_mesaMenuContextual == null)
        {
            CerrarMenuContextual();
            return;
        }
        
        try
        {
            await using var db = await DbFactory.CreateDbContextAsync();
            
            // Buscar mesas unidas a esta principal
            var mesasUnidas = await db.Mesas
                .Where(m => m.IdMesaPrincipal == _mesaMenuContextual.IdMesa)
                .ToListAsync();
            
            if (mesasUnidas.Any())
            {
                // Separar todas las mesas
                foreach (var mesa in mesasUnidas)
                {
                    mesa.IdMesaPrincipal = null;
                    mesa.FechaModificacion = DateTime.Now;
                }
                
                await db.SaveChangesAsync();
                
                // Recargar datos
                await CargarDatos();
                
                // Mostrar mensaje de √©xito
                _mensajeExito = "Mesas separadas correctamente";
                _ = LimpiarMensajeExito();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"[MesasPanel] Error separando mesas desde men√∫ contextual: {ex}");
            _mensajeError = "Error al separar mesas";
            _ = LimpiarMensajeError();
        }
        finally
        {
            CerrarMenuContextual();
            StateHasChanged();
        }
    }
    
    private async Task LimpiarMensajeExito()
    {
        await Task.Delay(3000);
        _mensajeExito = "";
        StateHasChanged();
    }
    
    private async Task LimpiarMensajeError()
    {
        await Task.Delay(5000);
        _mensajeError = "";
        StateHasChanged();
    }

    private void CerrarPanelPedido()
    {
        _mesaSeleccionada = null;
        _pedidoActual = null;
        _detallesPedido.Clear();
        _itemsSeleccionados.Clear();
        _ocultarPanelMesas = false; // Mostrar panel mesas al cerrar pedido
    }

    // ========== B√öSQUEDA DE PRODUCTOS ==========

    private void BuscarProductos()
    {
        FiltrarProductos();
    }

    private void FiltrarClasificacion(int? idClasificacion)
    {
        _clasificacionSeleccionada = idClasificacion;
        FiltrarProductos();
    }

    private void FiltrarProductos()
    {
        var query = _productosDisponibles.AsQueryable();

        if (!string.IsNullOrWhiteSpace(_busquedaProducto))
        {
            var busq = _busquedaProducto.ToLower();
            query = query.Where(p => 
                p.Descripcion.ToLower().Contains(busq) ||
                (p.CodigoBarras ?? "").ToLower().Contains(busq) ||
                p.CodigoInterno.ToLower().Contains(busq));
        }

        if (_clasificacionSeleccionada.HasValue)
        {
            query = query.Where(p => p.IdClasificacion == _clasificacionSeleccionada);
        }

        _productosFiltrados = query.OrderBy(p => p.Descripcion).Take(24).ToList();
        StateHasChanged();
    }

    private void LimpiarBusqueda()
    {
        _busquedaProducto = "";
        _clasificacionSeleccionada = null;
        _productosFiltrados = _productosDisponibles.Take(24).ToList();
    }

    // ========== AGREGAR/MODIFICAR PRODUCTOS ==========

    private void AgregarProducto(Producto producto)
    {
        var existente = _detallesPedido.FirstOrDefault(d => 
            d.IdProducto == producto.IdProducto && 
            !d.Facturado && 
            string.IsNullOrEmpty(d.NotasCocina));
        
        if (existente != null)
        {
            existente.Cantidad++;
            CalcularTotalesDetalle(existente, producto);
        }
        else
        {
            var detalle = new PedidoDetalle
            {
                IdProducto = producto.IdProducto,
                CodigoProducto = producto.CodigoInterno,
                Descripcion = producto.Descripcion,
                Cantidad = 1,
                PrecioUnitario = producto.PrecioUnitarioGs,
                IdTipoIva = producto.IdTipoIva,
                NumeroComensal = 1,
                Estado = "Pendiente",
                FechaCreacion = DateTime.Now,
                Facturado = false
            };
            CalcularTotalesDetalle(detalle, producto);
            _detallesPedido.Add(detalle);
        }

        StateHasChanged();
    }

    private void CalcularTotalesDetalle(PedidoDetalle detalle, Producto? producto = null)
    {
        var importe = detalle.Cantidad * detalle.PrecioUnitario;
        detalle.Importe = importe;

        var tipoIva = producto?.IdTipoIva ?? detalle.IdTipoIva ?? 1;
        
        if (tipoIva == 3) // Exenta
        {
            detalle.Exenta = importe;
            detalle.Grabado5 = 0;
            detalle.Grabado10 = 0;
            detalle.IVA5 = 0;
            detalle.IVA10 = 0;
        }
        else if (tipoIva == 2) // IVA 5%
        {
            detalle.Exenta = 0;
            detalle.Grabado5 = importe;
            detalle.Grabado10 = 0;
            detalle.IVA5 = Math.Round(importe / 21m, 0);
            detalle.IVA10 = 0;
        }
        else // IVA 10%
        {
            detalle.Exenta = 0;
            detalle.Grabado5 = 0;
            detalle.Grabado10 = importe;
            detalle.IVA5 = 0;
            detalle.IVA10 = Math.Round(importe / 11m, 0);
        }
    }

    private void CambiarCantidad(PedidoDetalle detalle, int cambio)
    {
        var nuevaCantidad = detalle.Cantidad + cambio;
        if (nuevaCantidad < 1) return;

        detalle.Cantidad = nuevaCantidad;
        CalcularTotalesDetalle(detalle);
        StateHasChanged();
    }

    private void EliminarDetalle(PedidoDetalle detalle)
    {
        _detallesPedido.Remove(detalle);
        _itemsSeleccionados.Remove(detalle.IdPedidoDetalle);
        StateHasChanged();
    }

    // ========== SELECCI√ìN DE ITEMS PARA COBRAR ==========

    // ========== HELPERS ESTADO COCINA ==========
    
    private string GetClaseEstadoCocina(PedidoDetalle det)
    {
        if (!det.EnviadoCocina) return "";
        return det.Estado switch
        {
            "Pendiente" => "estado-pendiente",
            "EnPreparacion" => "estado-preparando",
            "Listo" => "estado-listo",
            "Entregado" => "estado-entregado",
            _ => ""
        };
    }
    
    private string GetTituloEstadoCocina(PedidoDetalle det)
    {
        var tiempo = det.FechaEnvioCocina.HasValue 
            ? $" - Hace {(int)(DateTime.Now - det.FechaEnvioCocina.Value).TotalMinutes} min"
            : "";
        return det.Estado switch
        {
            "Pendiente" => $"Enviado a cocina, esperando{tiempo}",
            "EnPreparacion" => $"En preparaci√≥n{tiempo}",
            "Listo" => "¬°Listo para servir!",
            "Entregado" => "Ya entregado al cliente",
            _ => det.Estado
        };
    }
    
    private string GetTextoEstadoCocina(PedidoDetalle det)
    {
        return det.Estado switch
        {
            "Pendiente" => "‚è≥ En cola",
            "EnPreparacion" => "üî• Preparando...",
            "Listo" => "‚úÖ ¬°LISTO!",
            _ => ""
        };
    }

    // ========== SONIDOS COCINA ==========
    
    private void ToggleSonidosCocina() => _sonidosCocinaActivo = !_sonidosCocinaActivo;

    private async Task ReproducirSonidoCocina(string tipo)
    {
        if (!_sonidosCocinaActivo) return;
        
        try
        {
            var script = tipo switch
            {
                // Enviado a cocina: 2 beeps cortos (confirmaci√≥n env√≠o)
                "enviado" => @"
                    (function() {
                        const ctx = new (window.AudioContext || window.webkitAudioContext)();
                        [0, 150].forEach((delay) => {
                            setTimeout(() => {
                                const osc = ctx.createOscillator();
                                const gain = ctx.createGain();
                                osc.connect(gain);
                                gain.connect(ctx.destination);
                                osc.frequency.value = 880; // A5
                                osc.type = 'sine';
                                gain.gain.setValueAtTime(0.2, ctx.currentTime);
                                gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.1);
                                osc.start(ctx.currentTime);
                                osc.stop(ctx.currentTime + 0.1);
                            }, delay);
                        });
                    })();",
                
                // En preparaci√≥n: tono medio pulsante (cocina trabajando)
                "preparacion" => @"
                    (function() {
                        const ctx = new (window.AudioContext || window.webkitAudioContext)();
                        const osc = ctx.createOscillator();
                        const gain = ctx.createGain();
                        osc.connect(gain);
                        gain.connect(ctx.destination);
                        osc.frequency.value = 587.33; // D5
                        osc.type = 'triangle';
                        gain.gain.setValueAtTime(0.2, ctx.currentTime);
                        gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.4);
                        osc.start(ctx.currentTime);
                        osc.stop(ctx.currentTime + 0.4);
                    })();",
                
                // ¬°LISTO! Fanfarria alegre (llamar la atenci√≥n del mesero)
                "listo" => @"
                    (function() {
                        const ctx = new (window.AudioContext || window.webkitAudioContext)();
                        const melody = [
                            {freq: 659.25, time: 0, dur: 0.15},      // E5
                            {freq: 783.99, time: 0.15, dur: 0.15},   // G5
                            {freq: 987.77, time: 0.30, dur: 0.15},   // B5
                            {freq: 1318.51, time: 0.45, dur: 0.3}    // E6 (sostenido)
                        ];
                        melody.forEach(note => {
                            setTimeout(() => {
                                const osc = ctx.createOscillator();
                                const gain = ctx.createGain();
                                osc.connect(gain);
                                gain.connect(ctx.destination);
                                osc.frequency.value = note.freq;
                                osc.type = 'sine';
                                gain.gain.setValueAtTime(0.3, ctx.currentTime);
                                gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + note.dur);
                                osc.start(ctx.currentTime);
                                osc.stop(ctx.currentTime + note.dur);
                            }, note.time * 1000);
                        });
                    })();",
                
                _ => ""
            };

            if (!string.IsNullOrEmpty(script))
            {
                await JS.InvokeVoidAsync("eval", script);
            }
        }
        catch { }
    }

    private void ToggleSeleccionItem(int idDetalle)
    {
        if (_itemsSeleccionados.Contains(idDetalle))
            _itemsSeleccionados.Remove(idDetalle);
        else
            _itemsSeleccionados.Add(idDetalle);
        StateHasChanged();
    }

    private void SeleccionarTodos()
    {
        var noFacturados = _detallesPedido.Where(d => !d.Facturado).Select(d => d.IdPedidoDetalle);
        if (_itemsSeleccionados.Count == noFacturados.Count())
        {
            _itemsSeleccionados.Clear();
        }
        else
        {
            _itemsSeleccionados = noFacturados.ToHashSet();
        }
        StateHasChanged();
    }

    // ========== GUARDAR PEDIDO ==========

    private async Task GuardarPedido()
    {
        if (_guardando || _pedidoActual == null) return;
        _guardando = true;

        try
        {
            await using var db = await DbFactory.CreateDbContextAsync();

            // Actualizar totales
            _pedidoActual.TotalExenta = _detallesPedido.Sum(d => d.Exenta);
            _pedidoActual.TotalIva5 = _detallesPedido.Sum(d => d.Grabado5);
            _pedidoActual.TotalIva10 = _detallesPedido.Sum(d => d.Grabado10);
            _pedidoActual.Total = _detallesPedido.Sum(d => d.Importe);
            _pedidoActual.Subtotal = _pedidoActual.Total;

            if (_pedidoActual.IdPedido == 0)
            {
                _pedidoActual.Detalles = _detallesPedido;
                db.Pedidos.Add(_pedidoActual);
                await db.SaveChangesAsync();

                // Marcar mesa como ocupada
                var mesa = await db.Mesas.FindAsync(_mesaSeleccionada!.IdMesa);
                if (mesa != null)
                {
                    mesa.Estado = "Ocupada";
                    await db.SaveChangesAsync();
                }

                // Recargar para tener los IDs
                await CargarPedidoMesa(_mesaSeleccionada!);
            }
            else
            {
                var pedidoDb = await db.Pedidos
                    .Include(p => p.Detalles)
                    .FirstOrDefaultAsync(p => p.IdPedido == _pedidoActual.IdPedido);

                if (pedidoDb != null)
                {
                    pedidoDb.TotalExenta = _pedidoActual.TotalExenta;
                    pedidoDb.TotalIva5 = _pedidoActual.TotalIva5;
                    pedidoDb.TotalIva10 = _pedidoActual.TotalIva10;
                    pedidoDb.Total = _pedidoActual.Total;
                    pedidoDb.Subtotal = _pedidoActual.Subtotal;

                    // Eliminar detalles que ya no est√°n
                    var idsActuales = _detallesPedido.Where(d => d.IdPedidoDetalle > 0).Select(d => d.IdPedidoDetalle).ToList();
                    var aEliminar = pedidoDb.Detalles?.Where(d => !idsActuales.Contains(d.IdPedidoDetalle)).ToList();
                    if (aEliminar?.Any() == true)
                    {
                        db.PedidosDetalles.RemoveRange(aEliminar);
                    }

                    // Agregar o actualizar
                    foreach (var det in _detallesPedido)
                    {
                        if (det.IdPedidoDetalle == 0)
                        {
                            det.IdPedido = _pedidoActual.IdPedido;
                            db.PedidosDetalles.Add(det);
                        }
                        else
                        {
                            var detDb = pedidoDb.Detalles?.FirstOrDefault(d => d.IdPedidoDetalle == det.IdPedidoDetalle);
                            if (detDb != null)
                            {
                                detDb.Cantidad = det.Cantidad;
                                detDb.Importe = det.Importe;
                                detDb.Exenta = det.Exenta;
                                detDb.Grabado5 = det.Grabado5;
                                detDb.Grabado10 = det.Grabado10;
                                detDb.IVA5 = det.IVA5;
                                detDb.IVA10 = det.IVA10;
                                detDb.Facturado = det.Facturado;
                                detDb.IdVenta = det.IdVenta;
                            }
                        }
                    }

                    await db.SaveChangesAsync();
                }
            }

            // Refrescar lista de pedidos activos
            _pedidosActivos = await db.Pedidos
                .Where(p => p.IdSucursal == _idSucursal 
                         && (p.Estado == "Abierto" || p.Estado == "EnCurso" || p.Estado == "PendientePago"))
                .Include(p => p.Mesa)
                .Include(p => p.Detalles)
                .ToListAsync();
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("alert", $"Error al guardar: {ex.Message}");
        }
        finally
        {
            _guardando = false;
            StateHasChanged();
        }
    }

    // ========== MODAL VENTAS ==========

    private async Task AbrirModalCobrar()
    {
        // Primero guardar el pedido
        await GuardarPedido();

        if (_pedidoActual == null || _pedidoActual.IdPedido == 0) return;

        // Construir URL con par√°metros
        var idsItems = _itemsSeleccionados.Any() 
            ? string.Join(",", _itemsSeleccionados)
            : string.Join(",", _detallesPedido.Where(d => !d.Facturado).Select(d => d.IdPedidoDetalle));

        _urlVentas = $"/ventas?idPedido={_pedidoActual.IdPedido}&items={idsItems}&modal=1";
        _mostrarModalVentas = true;
    }

    private async Task CerrarModalVentas()
    {
        _mostrarModalVentas = false;
        _urlVentas = "";
        
        // Refrescar datos despu√©s de cerrar el modal
        await Refrescar();
    }

    // ========== CERRAR MESA ==========

    private async Task MostrarConfirmarCerrarMesa()
    {
        if (_pedidoActual == null) return;
        
        // Calcular saldo pendiente real usando la misma l√≥gica que la UI
        // _totalPedido = _totalPedidoGeneral - _montoFacturadoVentas (lo pendiente de facturar)
        var saldoPendienteReal = _totalPedido;
        
        // Validar que el pedido est√© completamente pagado
        if (saldoPendienteReal > 0)
        {
            // Ofrecer opci√≥n de cortes√≠a
            _saldoPendienteCortesia = saldoPendienteReal;
            var opcion = await JS.InvokeAsync<bool>("confirm", 
                $"Hay un saldo pendiente de Gs {saldoPendienteReal:N0}.\n\n¬øDesea declarar como CORTES√çA DE LA CASA?\n\n(Requiere autorizaci√≥n de un administrador)");
            
            if (opcion)
            {
                MostrarModalCortesia();
            }
            return;
        }
        
        _itemsNoFacturados = _detallesPedido.Where(d => !d.Facturado).ToList();
        _mostrarConfirmarCerrarMesa = true;
    }
    
    private void MostrarModalCortesia()
    {
        _usuarioCortesia = "";
        _passwordCortesia = "";
        _motivoCortesia = "";
        _errorCortesia = "";
        _validandoCortesia = false;
        _mostrarModalCortesia = true;
    }
    
    private void CerrarModalCortesia()
    {
        _mostrarModalCortesia = false;
        _usuarioCortesia = "";
        _passwordCortesia = "";
        _motivoCortesia = "";
        _errorCortesia = "";
    }
    
    private async Task ValidarYProcesarCortesia()
    {
        if (_pedidoActual == null) return;
        
        _validandoCortesia = true;
        _errorCortesia = "";
        StateHasChanged();
        
        try
        {
            await using var db = await DbFactory.CreateDbContextAsync();
            
            // Buscar usuario por nombre
            var usuario = await db.Usuarios
                .FirstOrDefaultAsync(u => u.UsuarioNombre.ToLower() == _usuarioCortesia.ToLower().Trim());
            
            if (usuario == null)
            {
                _errorCortesia = "Usuario no encontrado.";
                return;
            }
            
            // Validar contrase√±a
            using var sha = System.Security.Cryptography.SHA256.Create();
            var bytes = System.Text.Encoding.UTF8.GetBytes(_passwordCortesia);
            var hashIngresado = sha.ComputeHash(bytes);
            
            if (usuario.ContrasenaHash == null || !hashIngresado.SequenceEqual(usuario.ContrasenaHash))
            {
                _errorCortesia = "Contrase√±a incorrecta.";
                return;
            }
            
            // Verificar permisos de EDIT y DELETE en mesas Y pedidos
            var tienePermisoEditMesas = await PermisosService.TienePermisoAsync(usuario.Id_Usu, "/mesas", "EDIT");
            var tienePermisoDeleteMesas = await PermisosService.TienePermisoAsync(usuario.Id_Usu, "/mesas", "DELETE");
            var tienePermisoEditPedidos = await PermisosService.TienePermisoAsync(usuario.Id_Usu, "/mesas/panel", "EDIT");
            var tienePermisoDeletePedidos = await PermisosService.TienePermisoAsync(usuario.Id_Usu, "/mesas/panel", "DELETE");
            
            // Validar que tenga TODOS los permisos requeridos
            if (!tienePermisoEditMesas || !tienePermisoDeleteMesas || !tienePermisoEditPedidos || !tienePermisoDeletePedidos)
            {
                _errorCortesia = "El usuario no tiene permisos suficientes (requiere UPDATE y DELETE en Mesas y Pedidos).";
                return;
            }
            
            // ‚úÖ Usuario autorizado - procesar cortes√≠a
            await ProcesarCortesiaAsync(db, usuario);
            
            _mostrarModalCortesia = false;
            CerrarPanelPedido();
            await CargarDatos();
            
            await JS.InvokeVoidAsync("alert", "‚úÖ Mesa cerrada como cortes√≠a de la casa. Se enviaron los correos de notificaci√≥n.");
        }
        catch (Exception ex)
        {
            _errorCortesia = $"Error: {ex.Message}";
            Console.WriteLine($"[MesasPanel] Error en cortes√≠a: {ex}");
        }
        finally
        {
            _validandoCortesia = false;
            StateHasChanged();
        }
    }
    
    private async Task ProcesarCortesiaAsync(AppDbContext db, Usuario usuarioAutorizador)
    {
        if (_pedidoActual == null || _mesaSeleccionada == null) return;
        
        var ahora = DateTime.Now;
        var montoCondonado = _pedidoActual.SaldoPendiente;
        
        // Registrar el pago como cortes√≠a
        var pagoCortesia = new PedidoPago
        {
            IdPedido = _pedidoActual.IdPedido,
            FormaPago = "CORTESIA",
            Monto = montoCondonado,
            FechaPago = ahora,
            Observaciones = $"CORTES√çA autorizada por {usuarioAutorizador.UsuarioNombre}. Motivo: {_motivoCortesia}"
        };
        db.PedidosPagos.Add(pagoCortesia);
        
        // Actualizar el pedido
        var pedidoDb = await db.Pedidos.FindAsync(_pedidoActual.IdPedido);
        if (pedidoDb != null)
        {
            pedidoDb.Estado = "Cortesia";
            pedidoDb.FechaCierre = ahora;
            pedidoDb.MontoPagado = pedidoDb.Total; // Marcar como pagado
            pedidoDb.Observaciones = (pedidoDb.Observaciones ?? "") + 
                $"\n[CORTES√çA {ahora:dd/MM/yyyy HH:mm}] Monto condonado: Gs {montoCondonado:N0}. Autorizado por: {usuarioAutorizador.UsuarioNombre}. Motivo: {_motivoCortesia}";
        }
        
        // Descontar stock de items no facturados
        var itemsSinFacturar = _detallesPedido.Where(d => !d.Facturado).ToList();
        foreach (var item in itemsSinFacturar)
        {
            var producto = await db.Productos.FindAsync(item.IdProducto);
            if (producto != null)
            {
                producto.Stock -= item.Cantidad;
            }
        }
        
        // Liberar mesa
        var mesa = await db.Mesas.FindAsync(_mesaSeleccionada.IdMesa);
        if (mesa != null)
        {
            mesa.Estado = "Libre";
        }
        
        // Completar reservas en curso (usar fecha de caja)
        var reservasEnCurso = await db.Reservas
            .Where(r => r.IdMesa == _mesaSeleccionada.IdMesa 
                     && r.FechaReserva.Date == _fechaCaja.Date
                     && r.Estado == "EnCurso")
            .ToListAsync();
        
        foreach (var reserva in reservasEnCurso)
        {
            reserva.Estado = "Completada";
            reserva.HoraFinReal = ahora.TimeOfDay;
            reserva.FechaModificacion = ahora;
        }
        
        await db.SaveChangesAsync();
        
        // Enviar correos de notificaci√≥n
        await EnviarCorreosCortesiaAsync(pedidoDb, reservasEnCurso.FirstOrDefault(), usuarioAutorizador, montoCondonado);
    }
    
    private async Task EnviarCorreosCortesiaAsync(Pedido? pedido, Reserva? reserva, Usuario usuarioAutorizador, decimal montoCondonado)
    {
        try
        {
            await using var db = await DbFactory.CreateDbContextAsync();
            
            // Obtener configuraci√≥n de correo principal
            var configCorreo = await db.ConfiguracionesCorreo
                .Where(c => c.Activo && c.IdSucursal == _idSucursal)
                .FirstOrDefaultAsync();
            
            var correoAdmin = configCorreo?.CorreoRemitente;
            
            // Obtener email del cliente
            string? emailCliente = reserva?.Email;
            string nombreCliente = reserva?.NombreCliente ?? pedido?.NombreCliente ?? "Cliente";
            
            if (string.IsNullOrWhiteSpace(emailCliente) && pedido?.IdCliente != null)
            {
                var cliente = await db.Clientes.FindAsync(pedido.IdCliente);
                emailCliente = cliente?.Email;
                if (!string.IsNullOrWhiteSpace(cliente?.RazonSocial))
                    nombreCliente = cliente.RazonSocial;
            }
            
            var empresaNombre = _sucursalActual?.NombreEmpresa ?? "Restaurante";
            var mesaTexto = _mesaSeleccionada?.TextoMostrar ?? "Mesa";
            
            // Generar HTML del correo
            var htmlCortesia = $@"
            <html>
            <body style='font-family: Arial, sans-serif; padding: 20px;'>
                <div style='max-width: 600px; margin: 0 auto; border: 1px solid #ddd; border-radius: 10px; overflow: hidden;'>
                    <div style='background: linear-gradient(135deg, #f5a623, #f7931e); color: white; padding: 20px; text-align: center;'>
                        <h1 style='margin: 0;'>üéÅ Cortes√≠a de la Casa</h1>
                    </div>
                    <div style='padding: 20px;'>
                        <p>Estimado/a <strong>{nombreCliente}</strong>,</p>
                        <p>Le comunicamos que su consumo en <strong>{mesaTexto}</strong> ha sido declarado como <strong>Cortes√≠a de la Casa</strong>.</p>
                        
                        <div style='background: #fff3cd; border: 1px solid #ffc107; border-radius: 5px; padding: 15px; margin: 20px 0;'>
                            <h3 style='margin-top: 0; color: #856404;'>Detalle de la Cortes√≠a</h3>
                            <p><strong>Monto condonado:</strong> Gs {montoCondonado:N0}</p>
                            <p><strong>Motivo:</strong> {_motivoCortesia}</p>
                            <p><strong>Fecha:</strong> {DateTime.Now:dd/MM/yyyy HH:mm}</p>
                            <p><strong>Autorizado por:</strong> {usuarioAutorizador.Nombres} {usuarioAutorizador.Apellidos}</p>
                        </div>
                        
                        <p>¬°Esperamos que haya disfrutado de nuestro servicio y lo esperamos pronto!</p>
                        
                        <p style='color: #666; font-size: 12px; margin-top: 30px;'>
                            Atentamente,<br/>
                            <strong>{empresaNombre}</strong>
                        </p>
                    </div>
                </div>
            </body>
            </html>";
            
            var asunto = $"üéÅ Cortes√≠a de la Casa - {empresaNombre}";
            
            // Enviar al cliente si tiene email
            if (!string.IsNullOrWhiteSpace(emailCliente))
            {
                var (exitoCliente, _) = await CorreoService.EnviarCorreoAsync(emailCliente, asunto, htmlCortesia);
                Console.WriteLine($"[MesasPanel] Correo cortes√≠a a cliente {emailCliente}: {(exitoCliente ? "OK" : "Error")}");
            }
            
            // Enviar al correo principal de administraci√≥n
            if (!string.IsNullOrWhiteSpace(correoAdmin))
            {
                var htmlAdmin = $@"
                <html>
                <body style='font-family: Arial, sans-serif; padding: 20px;'>
                    <div style='max-width: 600px; margin: 0 auto; border: 1px solid #dc3545; border-radius: 10px; overflow: hidden;'>
                        <div style='background: #dc3545; color: white; padding: 20px; text-align: center;'>
                            <h1 style='margin: 0;'>‚ö†Ô∏è NOTIFICACI√ìN: Cortes√≠a Autorizada</h1>
                        </div>
                        <div style='padding: 20px;'>
                            <p>Se ha registrado una <strong>Cortes√≠a de la Casa</strong> en el sistema.</p>
                            
                            <table style='width: 100%; border-collapse: collapse; margin: 20px 0;'>
                                <tr style='background: #f8f9fa;'>
                                    <td style='padding: 10px; border: 1px solid #ddd;'><strong>Mesa:</strong></td>
                                    <td style='padding: 10px; border: 1px solid #ddd;'>{mesaTexto}</td>
                                </tr>
                                <tr>
                                    <td style='padding: 10px; border: 1px solid #ddd;'><strong>Cliente:</strong></td>
                                    <td style='padding: 10px; border: 1px solid #ddd;'>{nombreCliente}</td>
                                </tr>
                                <tr style='background: #f8f9fa;'>
                                    <td style='padding: 10px; border: 1px solid #ddd;'><strong>Monto Condonado:</strong></td>
                                    <td style='padding: 10px; border: 1px solid #ddd; color: #dc3545; font-weight: bold;'>Gs {montoCondonado:N0}</td>
                                </tr>
                                <tr>
                                    <td style='padding: 10px; border: 1px solid #ddd;'><strong>Motivo:</strong></td>
                                    <td style='padding: 10px; border: 1px solid #ddd;'>{_motivoCortesia}</td>
                                </tr>
                                <tr style='background: #f8f9fa;'>
                                    <td style='padding: 10px; border: 1px solid #ddd;'><strong>Autorizado por:</strong></td>
                                    <td style='padding: 10px; border: 1px solid #ddd;'>{usuarioAutorizador.Nombres} {usuarioAutorizador.Apellidos} ({usuarioAutorizador.UsuarioNombre})</td>
                                </tr>
                                <tr>
                                    <td style='padding: 10px; border: 1px solid #ddd;'><strong>Fecha y Hora:</strong></td>
                                    <td style='padding: 10px; border: 1px solid #ddd;'>{DateTime.Now:dd/MM/yyyy HH:mm:ss}</td>
                                </tr>
                                <tr style='background: #f8f9fa;'>
                                    <td style='padding: 10px; border: 1px solid #ddd;'><strong>Pedido #:</strong></td>
                                    <td style='padding: 10px; border: 1px solid #ddd;'>{pedido?.IdPedido}</td>
                                </tr>
                            </table>
                            
                            <p style='color: #666; font-size: 12px;'>
                                Este correo es una notificaci√≥n autom√°tica del sistema.
                            </p>
                        </div>
                    </div>
                </body>
                </html>";
                
                var (exitoAdmin, _) = await CorreoService.EnviarCorreoAsync(correoAdmin, $"‚ö†Ô∏è CORTES√çA: {mesaTexto} - Gs {montoCondonado:N0}", htmlAdmin);
                Console.WriteLine($"[MesasPanel] Correo cortes√≠a a admin {correoAdmin}: {(exitoAdmin ? "OK" : "Error")}");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"[MesasPanel] Error enviando correos de cortes√≠a: {ex.Message}");
        }
    }

    private async Task CerrarMesaConfirmado()
    {
        if (_pedidoActual == null) return;
        
        // Doble validaci√≥n de seguridad: verificar saldo pendiente usando misma l√≥gica que UI
        var saldoPendienteReal = _totalPedido;
        if (saldoPendienteReal > 0)
        {
            await JS.InvokeVoidAsync("alert", $"No se puede cerrar la mesa. Saldo pendiente: Gs {saldoPendienteReal:N0}");
            return;
        }
        
        _cerrando = true;
        StateHasChanged();

        try
        {
            await using var db = await DbFactory.CreateDbContextAsync();

            // Descontar stock de items NO facturados (que no pasaron por ventas)
            var itemsSinFacturar = _detallesPedido.Where(d => !d.Facturado).ToList();
            foreach (var item in itemsSinFacturar)
            {
                var producto = await db.Productos
                    .Include(p => p.Componentes!)
                        .ThenInclude(c => c.Componente)
                    .FirstOrDefaultAsync(p => p.IdProducto == item.IdProducto);
                    
                if (producto != null)
                {
                    if (producto.EsCombo && producto.Componentes?.Any() == true)
                    {
                        // Para combos: descontar stock de cada componente
                        foreach (var comp in producto.Componentes.Where(c => c.Activo))
                        {
                            var cantidadDescontar = comp.Cantidad * item.Cantidad;
                            if (comp.Componente != null)
                            {
                                comp.Componente.Stock -= cantidadDescontar;
                                Console.WriteLine($"[MesasPanel] Componente {comp.Componente.Descripcion}: -{cantidadDescontar}");
                            }
                        }
                        Console.WriteLine($"[MesasPanel] Stock componentes combo descontado: {producto.Descripcion} x{item.Cantidad}");
                    }
                    else
                    {
                        // Para productos normales: descontar stock directo
                        producto.Stock -= item.Cantidad;
                        Console.WriteLine($"[MesasPanel] Stock descontado: {producto.Descripcion} -{item.Cantidad}");
                    }
                }
            }

            // Cerrar pedido
            var pedidoDb = await db.Pedidos.FindAsync(_pedidoActual.IdPedido);
            if (pedidoDb != null)
            {
                pedidoDb.Estado = "Pagado";
                pedidoDb.FechaCierre = DateTime.Now;
            }

            // Liberar mesa
            var mesa = await db.Mesas.FindAsync(_mesaSeleccionada!.IdMesa);
            if (mesa != null)
            {
                mesa.Estado = "Libre";
            }

            // Completar reservas en curso de esta mesa (usar fecha de caja)
            var reservasEnCurso = await db.Reservas
                .Where(r => r.IdMesa == _mesaSeleccionada.IdMesa 
                         && r.FechaReserva.Date == _fechaCaja.Date
                         && r.Estado == "EnCurso")
                .ToListAsync();
            
            foreach (var reserva in reservasEnCurso)
            {
                reserva.Estado = "Completada";
                reserva.HoraFinReal = DateTime.Now.TimeOfDay;
                reserva.FechaModificacion = DateTime.Now;
            }

            await db.SaveChangesAsync();
            
            // Enviar correo de agradecimiento si hay email
            await EnviarCorreoAgradecimientoAsync(pedidoDb, reservasEnCurso.FirstOrDefault());

            _mostrarConfirmarCerrarMesa = false;
            CerrarPanelPedido();
            await CargarDatos();
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("alert", $"Error al cerrar mesa: {ex.Message}");
        }
        finally
        {
            _cerrando = false;
            StateHasChanged();
        }
    }

    /// <summary>
    /// Env√≠a correo de agradecimiento con el detalle de consumo al cliente
    /// </summary>
    private async Task EnviarCorreoAgradecimientoAsync(Pedido? pedido, Reserva? reserva)
    {
        try
        {
            // Obtener email del cliente (de la reserva o del pedido)
            string? emailCliente = reserva?.Email;
            string nombreCliente = reserva?.NombreCliente ?? pedido?.NombreCliente ?? "Cliente";
            
            if (string.IsNullOrWhiteSpace(emailCliente) && pedido?.IdCliente != null)
            {
                await using var db = await DbFactory.CreateDbContextAsync();
                var cliente = await db.Clientes.FindAsync(pedido.IdCliente);
                emailCliente = cliente?.Email;
                if (!string.IsNullOrWhiteSpace(cliente?.RazonSocial))
                    nombreCliente = cliente.RazonSocial;
            }
            
            if (string.IsNullOrWhiteSpace(emailCliente))
            {
                Console.WriteLine("[MesasPanel] No hay email para enviar agradecimiento");
                return;
            }
            
            // Generar HTML del correo
            var html = GenerarHtmlAgradecimiento(pedido, nombreCliente);
            
            var asunto = $"üôè ¬°Gracias por tu visita! - {_sucursalActual?.NombreEmpresa ?? "Restaurante"}";
            
            var (exito, mensaje) = await CorreoService.EnviarCorreoAsync(emailCliente, asunto, html);
            
            if (exito)
                Console.WriteLine($"[MesasPanel] Correo de agradecimiento enviado a {emailCliente}");
            else
                Console.WriteLine($"[MesasPanel] Error enviando correo: {mensaje}");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"[MesasPanel] Error en EnviarCorreoAgradecimientoAsync: {ex.Message}");
        }
    }

    /// <summary>
    /// Genera el HTML del correo de agradecimiento con el detalle del consumo
    /// </summary>
    private string GenerarHtmlAgradecimiento(Pedido? pedido, string nombreCliente)
    {
        var sb = new System.Text.StringBuilder();
        var empresa = _sucursalActual?.NombreEmpresa ?? "Restaurante";
        var mesaNum = _mesaSeleccionada?.Numero ?? "?";
        
        sb.Append($@"
<!DOCTYPE html>
<html>
<head>
    <meta charset='utf-8'>
    <style>
        body {{ font-family: 'Segoe UI', Arial, sans-serif; background-color: #f5f5f5; margin: 0; padding: 20px; }}
        .container {{ max-width: 600px; margin: 0 auto; background: white; border-radius: 10px; overflow: hidden; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }}
        .header {{ background: linear-gradient(135deg, #28a745 0%, #20c997 100%); color: white; padding: 30px; text-align: center; }}
        .header h1 {{ margin: 0 0 10px 0; font-size: 24px; }}
        .header p {{ margin: 0; opacity: 0.9; }}
        .content {{ padding: 30px; }}
        .greeting {{ font-size: 18px; color: #333; margin-bottom: 20px; }}
        .details {{ background: #f8f9fa; border-radius: 8px; padding: 20px; margin: 20px 0; }}
        .details h3 {{ margin: 0 0 15px 0; color: #495057; border-bottom: 2px solid #dee2e6; padding-bottom: 10px; }}
        .item-row {{ display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px dashed #dee2e6; }}
        .item-row:last-child {{ border-bottom: none; }}
        .item-name {{ color: #333; }}
        .item-qty {{ color: #6c757d; font-size: 0.9em; }}
        .item-price {{ font-weight: 600; color: #28a745; }}
        .total-row {{ display: flex; justify-content: space-between; padding: 15px 0 0 0; margin-top: 10px; border-top: 2px solid #28a745; }}
        .total-label {{ font-size: 18px; font-weight: bold; color: #333; }}
        .total-amount {{ font-size: 20px; font-weight: bold; color: #28a745; }}
        .footer {{ background: #f8f9fa; padding: 20px; text-align: center; color: #6c757d; font-size: 14px; }}
        .footer a {{ color: #28a745; text-decoration: none; }}
        .mesa-info {{ display: inline-block; background: #e9ecef; padding: 5px 15px; border-radius: 20px; margin-top: 10px; }}
    </style>
</head>
<body>
    <div class='container'>
        <div class='header'>
            <h1>üôè ¬°Gracias por tu visita!</h1>
            <p>{empresa}</p>
            <div class='mesa-info'>Mesa #{mesaNum}</div>
        </div>
        <div class='content'>
            <p class='greeting'>Hola <strong>{nombreCliente}</strong>,</p>
            <p>Fue un placer atenderte. Esperamos que hayas disfrutado tu experiencia con nosotros.</p>
            
            <div class='details'>
                <h3>üìã Detalle de tu consumo</h3>");

        // Agregar items del pedido
        foreach (var item in _detallesPedido)
        {
            sb.Append($@"
                <div class='item-row'>
                    <span class='item-name'>{item.Descripcion} <span class='item-qty'>x{item.Cantidad:N0}</span></span>
                    <span class='item-price'>Gs {item.Importe:N0}</span>
                </div>");
        }

        // Total
        sb.Append($@"
                <div class='total-row'>
                    <span class='total-label'>TOTAL</span>
                    <span class='total-amount'>Gs {_totalPedidoGeneral:N0}</span>
                </div>
            </div>
            
            <p style='text-align: center; color: #6c757d;'>
                ‚≠ê Tu opini√≥n es muy importante para nosotros<br>
                ¬°Esperamos verte pronto!
            </p>
        </div>
        <div class='footer'>
            <p><strong>{empresa}</strong></p>");
        
        if (!string.IsNullOrWhiteSpace(_sucursalActual?.Direccion))
            sb.Append($"<p>üìç {_sucursalActual.Direccion}</p>");
        if (!string.IsNullOrWhiteSpace(_sucursalActual?.Telefono))
            sb.Append($"<p>üìû {_sucursalActual.Telefono}</p>");
        
        sb.Append($@"
            <p style='margin-top: 15px; font-size: 12px;'>
                Este correo fue enviado autom√°ticamente el {DateTime.Now:dd/MM/yyyy HH:mm}
            </p>
        </div>
    </div>
</body>
</html>");

        return sb.ToString();
    }

    // ========== AGENDA ==========

    private void ToggleAgenda()
    {
        _mostrarAgenda = !_mostrarAgenda;
    }

    // ========== GRILLA DE DISPONIBILIDAD ==========
    
    /// <summary>
    /// Carga las reservas para la fecha seleccionada en la grilla
    /// </summary>
    private async Task CargarReservasFechaGrilla()
    {
        try
        {
            await using var db = await DbFactory.CreateDbContextAsync();
            var idsMesasValidas = _mesasFiltradas.Select(m => m.IdMesa).ToList();
            
            _reservasFechaGrilla = await db.Reservas
                .Where(r => r.FechaReserva.Date == _fechaGrilla.Date 
                         && r.IdSucursal == _idSucursal
                         && idsMesasValidas.Contains(r.IdMesa)
                         && r.Estado != "Cancelada")
                .ToListAsync();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error cargando reservas grilla: {ex.Message}");
            _reservasFechaGrilla = new List<Reserva>();
        }
    }
    
    /// <summary>
    /// Cambia la fecha de la grilla por +/- d√≠as
    /// </summary>
    private async Task CambiarFechaGrilla(int dias)
    {
        _fechaGrilla = _fechaGrilla.AddDays(dias);
        await CargarReservasFechaGrilla();
    }

    // ========== AGENDA (VISTA LISTA) ==========

    /// <summary>
    /// Carga las reservas para la fecha seleccionada en la agenda (Vista Lista)
    /// </summary>
    private async Task CargarReservasAgenda()
    {
        try
        {
            await using var db = await DbFactory.CreateDbContextAsync();
            _reservasHoy = await db.Reservas
                .Where(r => r.FechaReserva.Date == _fechaAgenda.Date 
                         && r.IdSucursal == _idSucursal
                         && r.Estado != "Cancelada")
                .OrderBy(r => r.HoraInicio)
                .ToListAsync();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error cargando reservas agenda: {ex.Message}");
            _reservasHoy = new List<Reserva>();
        }
    }

    /// <summary>
    /// Cambia la fecha de la agenda (Vista Lista) por +/- d√≠as
    /// </summary>
    private async Task CambiarFechaAgenda(int dias)
    {
        _fechaAgenda = _fechaAgenda.AddDays(dias);
        await CargarReservasAgenda();
    }
    
    /// <summary>
    /// Obtiene las mesas a mostrar en la grilla seg√∫n el filtro seleccionado
    /// </summary>
    private List<Mesa> ObtenerMesasParaGrilla()
    {
        if (_mesaSeleccionadaGrilla.HasValue)
            return _mesasFiltradas.Where(m => m.IdMesa == _mesaSeleccionadaGrilla.Value).ToList();
        
        return _mesasFiltradas.OrderBy(m => m.Nombre).ToList();
    }

    /// <summary>
    /// Obtiene la reserva que ocupa un horario espec√≠fico para una mesa
    /// </summary>
    private Reserva? GetReservaEnHorario(int idMesa, TimeSpan hora)
    {
        var horaFin = hora.Add(TimeSpan.FromMinutes(_intervaloMinutos));
        
        return _reservasFechaGrilla.FirstOrDefault(r => 
            r.IdMesa == idMesa && 
            r.HoraInicio < horaFin && 
            (r.HoraFin ?? r.HoraInicio.Add(TimeSpan.FromHours(1))) > hora);
    }
    
    /// <summary>
    /// Retorna la clase CSS seg√∫n el estado de la reserva
    /// </summary>
    private string GetClaseCeldaReserva(Reserva reserva)
    {
        return reserva.Estado switch
        {
            "EnCurso" => "en-curso",
            "Completada" => "completada",
            "Confirmada" => "confirmada",
            "Pendiente" => "pendiente",
            _ => "reservada"
        };
    }
    
    /// <summary>
    /// Genera el tooltip de una celda de la grilla
    /// </summary>
    private string GetTituloCelda(Mesa mesa, TimeSpan hora, Reserva? reserva)
    {
        if (reserva != null)
        {
            return $"{reserva.NombreCliente}\n{reserva.HoraInicio:hh\\:mm} - {(reserva.HoraFin?.ToString(@"hh\:mm") ?? "")}\n{reserva.Estado}\nDoble clic para ver";
        }
        
        var esPasado = _fechaGrilla.Date < DateTime.Today || 
                      (_fechaGrilla.Date == DateTime.Today && hora < DateTime.Now.TimeOfDay);
        
        if (esPasado)
            return $"{mesa.Nombre} - {hora:hh\\:mm}\nHorario pasado";
        
        return $"{mesa.Nombre} - {hora:hh\\:mm}\nDisponible - Doble clic para reservar";
    }
    
    /// <summary>
    /// Maneja el doble clic en una celda de la grilla
    /// </summary>
    private async Task CeldaGrillaDobleClick(Mesa mesa, TimeSpan hora, Reserva? reservaExistente)
    {
        if (reservaExistente != null)
        {
            // Ver/Editar reserva existente
            await VerReservaExistente(reservaExistente);
        }
        else
        {
            // Crear nueva reserva
            var esPasado = _fechaGrilla.Date < DateTime.Today || 
                          (_fechaGrilla.Date == DateTime.Today && hora < DateTime.Now.TimeOfDay);
            
            if (esPasado)
            {
                // No permitir reservas en el pasado
                return;
            }
            
            await CrearReservaDesdeCelda(mesa, hora);
        }
    }
    
    /// <summary>
    /// Abre modal para ver/editar reserva existente
    /// </summary>
    private async Task VerReservaExistente(Reserva reserva)
    {
        // Buscar la mesa de la reserva
        var mesa = _mesas.FirstOrDefault(m => m.IdMesa == reserva.IdMesa);
        if (mesa != null)
        {
            // Seleccionar la mesa
            await SeleccionarMesa(mesa);
            
            // Abrir el modal de detalle cancha con los datos de la reserva
            AbrirDetalleCancha(mesa, reserva);
        }
    }
    
    /// <summary>
    /// Abre modal para crear nueva reserva desde la grilla
    /// </summary>
    private async Task CrearReservaDesdeCelda(Mesa mesa, TimeSpan hora)
    {
        // Seleccionar la mesa y preparar la reserva
        await SeleccionarMesa(mesa);
        
        // Preparar nueva reserva con los datos de la celda
        _nuevaReserva = new Reserva
        {
            IdMesa = mesa.IdMesa,
            IdSucursal = _idSucursal,
            FechaReserva = _fechaGrilla,
            HoraInicio = hora,
            HoraFin = hora.Add(TimeSpan.FromMinutes(_intervaloMinutos)),
            Estado = "Confirmada",
            CantidadPersonas = mesa.Capacidad,
            FechaCreacion = DateTime.Now
        };
        
        _mostrarModalReserva = true;
        StateHasChanged();
    }
    
    /// <summary>
    /// Filtra clientes para el buscador de reserva r√°pida
    /// </summary>
    private void FiltrarClientesReserva()
    {
        var texto = (_buscarClienteReservaTexto ?? "").Trim().ToLowerInvariant();
        
        if (string.IsNullOrEmpty(texto))
        {
            _clientesFiltradosReserva.Clear();
            _mostrarSugerenciasClienteReserva = false;
            return;
        }
        
        _clientesFiltradosReserva = _clientesReserva
            .Where(c => 
                (c.RazonSocial?.ToLowerInvariant().Contains(texto) ?? false) ||
                (c.RUC?.ToLowerInvariant().Contains(texto) ?? false) ||
                (c.NumeroDocumento?.ToLowerInvariant().Contains(texto) ?? false) ||
                (c.Telefono?.Contains(texto) ?? false))
            .Take(15)
            .ToList();
        
        _mostrarSugerenciasClienteReserva = _clientesFiltradosReserva.Any();
    }
    
    /// <summary>
    /// Selecciona un cliente del dropdown de sugerencias
    /// </summary>
    private void SeleccionarClienteReservaGrilla(Cliente cliente)
    {
        if (_nuevaReserva != null)
        {
            _nuevaReserva.NombreCliente = cliente.RazonSocial;
            _nuevaReserva.Telefono = cliente.Telefono;
            _nuevaReserva.Email = cliente.Email; // Cargar email del cliente si tiene
            _nuevaReserva.IdCliente = cliente.IdCliente;
        }
        
        _buscarClienteReservaTexto = "";
        _mostrarSugerenciasClienteReserva = false;
        _mouseDownEnSugerenciaReserva = false;
        StateHasChanged();
    }
    
    /// <summary>
    /// Limpia el cliente seleccionado
    /// </summary>
    private void LimpiarClienteReservaGrilla()
    {
        if (_nuevaReserva != null)
        {
            _nuevaReserva.NombreCliente = "";
            _nuevaReserva.Telefono = null;
            _nuevaReserva.IdCliente = null;
        }
        _buscarClienteReservaTexto = "";
        _mostrarSugerenciasClienteReserva = false;
        StateHasChanged();
    }
    
    /// <summary>
    /// Maneja el blur del campo de b√∫squeda de cliente
    /// </summary>
    private async Task OnClienteBlurReservaGrilla()
    {
        // Esperar un poco por si fue clic en sugerencia
        await Task.Delay(200);
        if (!_mouseDownEnSugerenciaReserva)
        {
            _mostrarSugerenciasClienteReserva = false;
            StateHasChanged();
        }
        _mouseDownEnSugerenciaReserva = false;
    }
    
    /// <summary>
    /// Cierra el modal de crear reserva desde grilla
    /// </summary>
    private void CerrarModalReservaGrilla()
    {
        _mostrarModalReserva = false;
        _nuevaReserva = null;
        _mensajeReservaGrilla = "";
        _reservaGrillaExito = false;
        StateHasChanged();
    }
    
    /// <summary>
    /// Guarda la reserva creada desde la grilla
    /// </summary>
    private async Task GuardarReservaGrilla()
    {
        if (_nuevaReserva == null) return;
        
        // Validar nombre cliente
        if (string.IsNullOrWhiteSpace(_nuevaReserva.NombreCliente))
        {
            _mensajeReservaGrilla = "El nombre del cliente es obligatorio";
            _reservaGrillaExito = false;
            StateHasChanged();
            return;
        }
        
        _guardandoReservaGrilla = true;
        _mensajeReservaGrilla = "";
        StateHasChanged();
        
        try
        {
            await using var db = await DbFactory.CreateDbContextAsync();
            
            // Verificar que no exista otra reserva en el mismo horario
            var conflicto = await db.Reservas
                .AnyAsync(r => r.IdMesa == _nuevaReserva.IdMesa 
                    && r.FechaReserva.Date == _nuevaReserva.FechaReserva.Date
                    && r.Estado != "Cancelada" && r.Estado != "Finalizada"
                    && ((r.HoraInicio <= _nuevaReserva.HoraInicio && r.HoraFin > _nuevaReserva.HoraInicio)
                        || (r.HoraInicio < _nuevaReserva.HoraFin && r.HoraFin >= _nuevaReserva.HoraFin)
                        || (r.HoraInicio >= _nuevaReserva.HoraInicio && r.HoraFin <= _nuevaReserva.HoraFin)));
            
            if (conflicto)
            {
                _mensajeReservaGrilla = "Ya existe una reserva en ese horario";
                _reservaGrillaExito = false;
                _guardandoReservaGrilla = false;
                StateHasChanged();
                return;
            }
            
            // Si el cliente tiene IdCliente y el email cambi√≥, actualizar la ficha del cliente
            if (_nuevaReserva.IdCliente.HasValue && !string.IsNullOrWhiteSpace(_nuevaReserva.Email))
            {
                var clienteDb = await db.Clientes.FindAsync(_nuevaReserva.IdCliente.Value);
                if (clienteDb != null && clienteDb.Email != _nuevaReserva.Email)
                {
                    clienteDb.Email = _nuevaReserva.Email;
                    Console.WriteLine($"[MesasPanel] Email de cliente #{clienteDb.IdCliente} actualizado a: {_nuevaReserva.Email}");
                }
            }
            
            // Guardar la reserva
            db.Reservas.Add(_nuevaReserva);
            await db.SaveChangesAsync();
            
            // Enviar correo de confirmaci√≥n si tiene email
            if (!string.IsNullOrWhiteSpace(_nuevaReserva.Email))
            {
                try
                {
                    var (exito, mensaje) = await ReservaCorreoService.EnviarConfirmacionAsync(_nuevaReserva.IdReserva);
                    Console.WriteLine($"[MesasPanel] Correo confirmaci√≥n reserva #{_nuevaReserva.IdReserva}: {(exito ? "OK" : mensaje)}");
                    _mensajeReservaGrilla = exito 
                        ? "Reserva guardada y correo de confirmaci√≥n enviado"
                        : $"Reserva guardada. Correo: {mensaje}";
                }
                catch (Exception exCorreo)
                {
                    Console.WriteLine($"[MesasPanel] Error al enviar correo de reserva: {exCorreo.Message}");
                    _mensajeReservaGrilla = "Reserva guardada (no se pudo enviar correo)";
                }
            }
            else
            {
                _mensajeReservaGrilla = "Reserva guardada correctamente";
            }
            
            _reservaGrillaExito = true;
            StateHasChanged();
            
            // Esperar un momento y cerrar
            await Task.Delay(1000);
            CerrarModalReservaGrilla();
            
            // Recargar reservas de la grilla
            await CargarReservasFechaGrilla();
        }
        catch (Exception ex)
        {
            _mensajeReservaGrilla = $"Error al guardar: {ex.Message}";
            _reservaGrillaExito = false;
        }
        finally
        {
            _guardandoReservaGrilla = false;
            StateHasChanged();
        }
    }
    
    /// <summary>
    /// Trunca texto para mostrar en las celdas de la grilla
    /// </summary>
    private string TruncarTextoGrilla(string? texto, int maxLength)
    {
        if (string.IsNullOrEmpty(texto)) return "";
        if (texto.Length <= maxLength) return texto;
        return texto.Substring(0, maxLength - 2) + "..";
    }

    private async Task SeleccionarMesaDesdeReserva(Reserva reserva)
    {
        var mesa = _mesas.FirstOrDefault(m => m.IdMesa == reserva.IdMesa);
        if (mesa != null)
        {
            await SeleccionarMesa(mesa);
        }
    }

    private async Task IniciarReservaDesdeModal()
    {
        if (_canchaDetalleReserva != null)
        {
            await IniciarReserva(_canchaDetalleReserva);
            
            // Actualizar _reservasHoy
            var reservaLocal = _reservasHoy.FirstOrDefault(r => r.IdReserva == _canchaDetalleReserva.IdReserva);
            if (reservaLocal != null)
            {
                reservaLocal.Estado = "EnCurso";
                reservaLocal.HoraInicioReal = _canchaDetalleReserva.HoraInicioReal;
            }
            
            await CargarReservasFechaGrilla();
            StateHasChanged();
        }
    }

    /// <summary>
    /// Inicia una reserva (cliente lleg√≥) y la mesa asociada
    /// </summary>
    private async Task IniciarReserva(Reserva reserva)
    {
        await using var db = await DbFactory.CreateDbContextAsync();
        
        var reservaDb = await db.Reservas.FindAsync(reserva.IdReserva);
        if (reservaDb != null)
        {
            reservaDb.Estado = "EnCurso";
            reservaDb.HoraInicioReal = DateTime.Now.TimeOfDay;
            reservaDb.FechaModificacion = DateTime.Now;
            await db.SaveChangesAsync();
            
            // Actualizar local
            reserva.Estado = "EnCurso";
            reserva.HoraInicioReal = reservaDb.HoraInicioReal;
        }
        
        // Seleccionar la mesa autom√°ticamente
        var mesa = _mesas.FirstOrDefault(m => m.IdMesa == reserva.IdMesa);
        if (mesa != null)
        {
            await SeleccionarMesa(mesa);
        }
        
        StateHasChanged();
    }

    /// <summary>
    /// Completa una reserva (cliente se fue)
    /// </summary>
    private async Task CompletarReserva(Reserva reserva)
    {
        await using var db = await DbFactory.CreateDbContextAsync();
        
        var reservaDb = await db.Reservas.FindAsync(reserva.IdReserva);
        if (reservaDb != null)
        {
            reservaDb.Estado = "Completada";
            reservaDb.HoraFinReal = DateTime.Now.TimeOfDay;
            reservaDb.FechaModificacion = DateTime.Now;
            await db.SaveChangesAsync();
            
            // Actualizar local
            reserva.Estado = "Completada";
            reserva.HoraFinReal = reservaDb.HoraFinReal;
        }
        
        StateHasChanged();
    }

    /// <summary>
    /// Cancela una reserva
    /// </summary>
    private async Task CancelarReserva(Reserva reserva)
    {
        var confirmar = await JS.InvokeAsync<bool>("confirm", $"¬øCancelar la reserva de {reserva.NombreCliente}?");
        if (!confirmar) return;
        
        await using var db = await DbFactory.CreateDbContextAsync();
        
        var reservaDb = await db.Reservas.FindAsync(reserva.IdReserva);
        if (reservaDb != null)
        {
            reservaDb.Estado = "Cancelada";
            reservaDb.FechaModificacion = DateTime.Now;
            await db.SaveChangesAsync();
            
            // Remover de la lista local
            _reservasHoy.Remove(reserva);
        }
        
        StateHasChanged();
    }

    /// <summary>
    /// Abre el modal de detalle de cancha con cron√≥metro grande
    /// </summary>
    private void AbrirDetalleCancha(Mesa mesa, Reserva? reserva)
    {
        if (!_modoCanchas) return;
        
        _canchaDetalleMesa = mesa;
        _canchaDetalleReserva = reserva;
        _mostrarModalDetalleCancha = true;
        StateHasChanged();
    }

    /// <summary>
    /// Cierra el modal de detalle de cancha
    /// </summary>
    private void CerrarModalDetalleCancha()
    {
        _mostrarModalDetalleCancha = false;
        _canchaDetalleReserva = null;
        _canchaDetalleMesa = null;
        StateHasChanged();
    }

    // ========== M√âTODOS PAGO SE√ëA ==========

    /// <summary>
    /// Abre el modal para registrar el pago de una se√±a
    /// </summary>
    private void AbrirModalPagoSena()
    {
        _mostrarModalPagoSena = true;
        _mensajePagoSena = "";
        _pagoSenaExito = false;
        _guardandoPagoSena = false;
        _medioPagoSena = MedioPago.Efectivo;
        _numeroAutorizacionSena = null;
        _marcaTarjetaSena = null;
        _bancoTransferenciaSena = null;
        _numeroComprobanteSena = null;
        _tipoTarjetaSena = TipoTarjeta.Debito;
        StateHasChanged();
    }

    /// <summary>
    /// Cierra el modal de pago de se√±a
    /// </summary>
    private void CerrarModalPagoSena()
    {
        _mostrarModalPagoSena = false;
        _mensajePagoSena = "";
        StateHasChanged();
    }

    /// <summary>
    /// Registra el pago de se√±a en la tabla SenasReservas y actualiza la reserva
    /// </summary>
    private async Task RegistrarPagoSena()
    {
        if (_canchaDetalleReserva == null || !_canchaDetalleReserva.MontoSena.HasValue)
        {
            _mensajePagoSena = "No hay se√±a para registrar";
            _pagoSenaExito = false;
            return;
        }

        _guardandoPagoSena = true;
        _mensajePagoSena = "";
        StateHasChanged();

        try
        {
            await using var db = await DbFactory.CreateDbContextAsync();

            // Crear registro de SenaReserva
            var senaReserva = new SenaReserva
            {
                IdReserva = _canchaDetalleReserva.IdReserva,
                IdCliente = _canchaDetalleReserva.IdCliente,
                NombreCliente = _canchaDetalleReserva.NombreCliente,
                FechaPago = DateTime.Now,
                Monto = _canchaDetalleReserva.MontoSena.Value,
                MontoGs = _canchaDetalleReserva.MontoSena.Value, // Asumiendo guaran√≠es
                MedioPago = _medioPagoSena,
                TipoTarjeta = _medioPagoSena == MedioPago.Tarjeta ? _tipoTarjetaSena : null,
                MarcaTarjeta = _medioPagoSena == MedioPago.Tarjeta ? _marcaTarjetaSena : null,
                NumeroAutorizacion = _medioPagoSena == MedioPago.Tarjeta ? _numeroAutorizacionSena : null,
                BancoTransferencia = _medioPagoSena == MedioPago.Transferencia ? _bancoTransferenciaSena : null,
                NumeroComprobante = (_medioPagoSena == MedioPago.Transferencia || _medioPagoSena == MedioPago.QR) 
                    ? _numeroComprobanteSena : null,
                IdSucursal = _idSucursal,
                IdCaja = _idCaja,
                Turno = _turnoActual,
                FechaCaja = _fechaCaja,
                Estado = "Confirmado"
            };

            // Obtener usuario actual
            try
            {
                var authState = await AuthStateTask;
                var userIdClaim = authState?.User?.FindFirst("UserId");
                if (int.TryParse(userIdClaim?.Value, out int userId))
                {
                    senaReserva.IdUsuario = userId;
                }
            }
            catch { /* Usuario no disponible */ }

            db.SenasReservas.Add(senaReserva);

            // Actualizar la reserva para marcar se√±a como pagada
            var reserva = await db.Reservas.FindAsync(_canchaDetalleReserva.IdReserva);
            if (reserva != null)
            {
                reserva.SenaPagada = true;
                reserva.FechaPagoSena = DateTime.Now;
                db.Reservas.Update(reserva);
            }

            await db.SaveChangesAsync();

            // Actualizar objeto en memoria
            _canchaDetalleReserva.SenaPagada = true;
            _canchaDetalleReserva.FechaPagoSena = DateTime.Now;

            _mensajePagoSena = "‚úÖ Pago de se√±a registrado correctamente";
            _pagoSenaExito = true;

            // Cerrar modal despu√©s de un momento
            await Task.Delay(1500);
            CerrarModalPagoSena();
            
            // Refrescar datos
            await CargarDatos();
            StateHasChanged();
        }
        catch (Exception ex)
        {
            _mensajePagoSena = $"Error al registrar pago: {ex.Message}";
            _pagoSenaExito = false;
            Console.WriteLine($"[MesasPanel] Error RegistrarPagoSena: {ex}");
        }
        finally
        {
            _guardandoPagoSena = false;
            StateHasChanged();
        }
    }

    /// <summary>
    /// Finaliza una reserva de cancha (marca como completada)
    /// </summary>
    private async Task FinalizarReservaCancha(Reserva? reserva)
    {
        if (reserva == null) return;
        
        var confirmar = await JS.InvokeAsync<bool>("confirm", 
            $"¬øFinalizar la reserva de {reserva.NombreCliente}?\n\nEsto liberar√° la cancha.");
        if (!confirmar) return;
        
        await using var db = await DbFactory.CreateDbContextAsync();
        
        var reservaDb = await db.Reservas.FindAsync(reserva.IdReserva);
        if (reservaDb != null)
        {
            reservaDb.Estado = "Completada";
            reservaDb.FechaModificacion = DateTime.Now;
            await db.SaveChangesAsync();
            
            // Actualizar la reserva local
            reserva.Estado = "Completada";
            
            // Remover de las alertas activas
            _reservasFinalizadas.Remove(reserva.IdReserva);
        }
        
        CerrarModalDetalleCancha();
        await CargarDatos();
        StateHasChanged();
    }

    /// <summary>
    /// Extiende una reserva de cancha por 1 hora adicional
    /// </summary>
    private async Task ExtenderReservaCancha(Reserva? reserva)
    {
        if (reserva == null) return;
        
        var confirmar = await JS.InvokeAsync<bool>("confirm", 
            $"¬øExtender la reserva de {reserva.NombreCliente} por 1 hora adicional?");
        if (!confirmar) return;
        
        await using var db = await DbFactory.CreateDbContextAsync();
        
        var reservaDb = await db.Reservas.FindAsync(reserva.IdReserva);
        if (reservaDb != null)
        {
            reservaDb.HoraFin = (reservaDb.HoraFin ?? reservaDb.HoraInicio.Add(TimeSpan.FromHours(1))).Add(TimeSpan.FromHours(1));
            reservaDb.FechaModificacion = DateTime.Now;
            await db.SaveChangesAsync();
            
            // Actualizar la reserva local
            reserva.HoraFin = reservaDb.HoraFin;
            
            // Remover de alertas ya que se extendi√≥
            _reservasFinalizadas.Remove(reserva.IdReserva);
        }
        
        StateHasChanged();
    }
    
    /// <summary>
    /// Permite extensi√≥n de tiempo para una reserva que lleg√≥ tarde.
    /// Verifica que no haya conflicto con la siguiente reserva.
    /// </summary>
    private async Task PermitirExtensionReserva(Reserva? reserva)
    {
        if (reserva == null) return;
        
        await using var db = await DbFactory.CreateDbContextAsync();
        
        // Verificar si hay una reserva siguiente en la misma cancha/mesa que se solapar√≠a
        var horaFinOriginal = reserva.HoraFin ?? reserva.HoraInicio.Add(TimeSpan.FromHours(1));
        
        var siguienteReserva = await db.Reservas
            .Where(r => r.IdMesa == reserva.IdMesa 
                     && r.FechaReserva.Date == reserva.FechaReserva.Date
                     && r.HoraInicio >= horaFinOriginal
                     && r.Estado != "Cancelada" && r.Estado != "Completada"
                     && r.IdReserva != reserva.IdReserva)
            .OrderBy(r => r.HoraInicio)
            .FirstOrDefaultAsync();
        
        // Calcular los minutos que se extender√≠an
        var minutosExtension = reserva.MinutosPerdidos;
        var horaFinExtendida = horaFinOriginal.Add(TimeSpan.FromMinutes(minutosExtension));
        
        // Si hay reserva siguiente y hay conflicto
        if (siguienteReserva != null && horaFinExtendida > siguienteReserva.HoraInicio)
        {
            var tiempoDisponible = (siguienteReserva.HoraInicio - horaFinOriginal).TotalMinutes;
            
            await JS.InvokeVoidAsync("alert", 
                $"‚ö†Ô∏è No se puede extender {minutosExtension} minutos.\n\n" +
                $"Hay una reserva de {siguienteReserva.NombreCliente} a las {siguienteReserva.HoraInicio:hh\\:mm}.\n" +
                $"Tiempo disponible: {tiempoDisponible:0} minutos.\n\n" +
                $"Opciones:\n" +
                $"‚Ä¢ Puede extender m√°ximo hasta las {siguienteReserva.HoraInicio:hh\\:mm}\n" +
                $"‚Ä¢ O negociar con el cliente de la siguiente reserva");
            return;
        }
        
        // Confirmar extensi√≥n
        var mensaje = siguienteReserva != null 
            ? $"¬øPermitir extensi√≥n de {minutosExtension} min para {reserva.NombreCliente}?\n\nLa siguiente reserva ({siguienteReserva.NombreCliente}) es a las {siguienteReserva.HoraInicio:hh\\:mm}, hay tiempo disponible."
            : $"¬øPermitir extensi√≥n de {minutosExtension} min para {reserva.NombreCliente}?\n\nNo hay reserva siguiente que se vea afectada.";
        
        var confirmar = await JS.InvokeAsync<bool>("confirm", mensaje);
        if (!confirmar) return;
        
        // Aplicar la extensi√≥n
        var reservaDb = await db.Reservas.FindAsync(reserva.IdReserva);
        if (reservaDb != null)
        {
            reservaDb.ExtensionPermitida = true;
            reservaDb.FechaModificacion = DateTime.Now;
            await db.SaveChangesAsync();
            
            // Actualizar la reserva local
            reserva.ExtensionPermitida = true;
            
            await JS.InvokeVoidAsync("alert", 
                $"‚úÖ Extensi√≥n permitida.\n\n" +
                $"El cliente ahora puede usar el tiempo completo hasta las {horaFinOriginal:hh\\:mm}.");
        }
        
        StateHasChanged();
    }

    /// <summary>
    /// Calcula el tiempo transcurrido de una reserva en formato HH:MM:SS
    /// </summary>
    private string CalcularTiempoTranscurrido(Reserva reserva)
    {
        var ahora = DateTime.Now;
        var inicioReserva = reserva.FechaReserva.Date.Add(reserva.HoraInicio);
        
        if (ahora < inicioReserva) return "00:00:00";
        
        var transcurrido = ahora - inicioReserva;
        return $"{(int)transcurrido.TotalHours:00}:{transcurrido.Minutes:00}:{transcurrido.Seconds:00}";
    }

    /// <summary>
    /// Calcula el tiempo restante de una reserva en formato HH:MM:SS
    /// </summary>
    private string CalcularTiempoRestante(Reserva reserva)
    {
        var ahora = DateTime.Now;
        var horaFinCalculada = reserva.HoraFin ?? (reserva.DuracionMinutos.HasValue 
            ? reserva.HoraInicio.Add(TimeSpan.FromMinutes(reserva.DuracionMinutos.Value))
            : reserva.HoraInicio.Add(TimeSpan.FromHours(1)));
        var finReserva = reserva.FechaReserva.Date.Add(horaFinCalculada);
        
        if (ahora >= finReserva)
        {
            var excedido = ahora - finReserva;
            return $"-{(int)excedido.TotalHours:00}:{excedido.Minutes:00}:{excedido.Seconds:00}";
        }
        
        var restante = finReserva - ahora;
        return $"{(int)restante.TotalHours:00}:{restante.Minutes:00}:{restante.Seconds:00}";
    }

    /// <summary>
    /// Determina si una reserva est√° en estado de alerta (menos de X minutos)
    /// </summary>
    private bool EstaEnAlerta(Reserva reserva)
    {
        var ahora = DateTime.Now;
        var horaFinCalculada = reserva.HoraFin ?? (reserva.DuracionMinutos.HasValue 
            ? reserva.HoraInicio.Add(TimeSpan.FromMinutes(reserva.DuracionMinutos.Value))
            : reserva.HoraInicio.Add(TimeSpan.FromHours(1)));
        var finReserva = reserva.FechaReserva.Date.Add(horaFinCalculada);
        var minutosAlerta = _config?.CanchasMinutosAlerta ?? 5;
        
        var restante = finReserva - ahora;
        return restante.TotalMinutes <= minutosAlerta && restante.TotalMinutes > 0;
    }

    /// <summary>
    /// Determina si una reserva ya finaliz√≥ (tiempo agotado)
    /// </summary>
    private bool EstaFinalizada(Reserva reserva)
    {
        var ahora = DateTime.Now;
        var horaFinCalculada = reserva.HoraFin ?? (reserva.DuracionMinutos.HasValue 
            ? reserva.HoraInicio.Add(TimeSpan.FromMinutes(reserva.DuracionMinutos.Value))
            : reserva.HoraInicio.Add(TimeSpan.FromHours(1)));
        var finReserva = reserva.FechaReserva.Date.Add(horaFinCalculada);
        return ahora >= finReserva;
    }

    /// <summary>
    /// Obtiene clase CSS seg√∫n estado de la reserva
    /// </summary>
    private string GetBadgeClassReserva(string estado) => estado switch
    {
        "Confirmada" => "bg-info",
        "EnCurso" => "bg-success",
        "Completada" => "bg-secondary",
        "Cancelada" => "bg-danger",
        _ => "bg-warning"
    };
    
    /// <summary>
    /// Env√≠a los items del pedido a las impresoras de cocina y barra
    /// </summary>
    private async Task ImprimirComanda()
    {
        if (_pedidoActual == null || !_detallesPedido.Any())
            return;

        if (_cajaActual == null)
        {
            await JS.InvokeVoidAsync("alert", "No hay caja configurada para enviar comandas");
            return;
        }

        if (string.IsNullOrEmpty(_cajaActual.ImpresoraComandaCocina) && string.IsNullOrEmpty(_cajaActual.ImpresoraComandaBarra))
        {
            await JS.InvokeVoidAsync("alert", "Configure las impresoras de comanda en Configuraci√≥n de Cajas");
            return;
        }

        _imprimiendoComanda = true;
        StateHasChanged();

        try
        {
            await using var db = await DbFactory.CreateDbContextAsync();

            // ========== GUARDAR PEDIDO SI HAY ITEMS NUEVOS ==========
            // Si hay items con IdPedidoDetalle = 0, significa que no se han guardado en BD
            var itemsSinGuardar = _detallesPedido.Any(d => d.IdPedidoDetalle == 0);
            if (itemsSinGuardar || _pedidoActual.IdPedido == 0)
            {
                await GuardarPedido();
                // Recargar desde BD para tener los IDs correctos
                if (_mesaSeleccionada != null)
                {
                    await CargarPedidoMesa(_mesaSeleccionada);
                }
            }

            // Obtener el √∫ltimo n√∫mero de comanda del d√≠a (usar fecha de caja)
            var ultimaComanda = await db.PedidosDetalles
                .Where(d => d.Pedido != null && d.Pedido.FechaApertura.Date == _fechaCaja.Date && d.NumeroComanda.HasValue)
                .MaxAsync(d => (int?)d.NumeroComanda) ?? 0;
            _numeroComanda = ultimaComanda + 1;
            
            // Obtener IDs de tipos que son servicios para excluirlos de comandas
            var tiposServicioIds = await db.TiposItem
                .Where(t => t.EsServicio)
                .Select(t => t.IdTipoItem)
                .ToListAsync();

            // Items no enviados a√∫n (excluyendo servicios)
            var todosNoEnviados = _detallesPedido.Where(d => !d.EnviadoCocina).ToList();
            
            // Separar servicios de productos normales
            var itemsServicio = todosNoEnviados.Where(d => 
                d.Producto != null && tiposServicioIds.Contains(d.Producto.TipoItem)).ToList();
            var itemsNoEnviados = todosNoEnviados.Where(d => 
                d.Producto == null || !tiposServicioIds.Contains(d.Producto.TipoItem)).ToList();
            
            // Los servicios se marcan directamente como entregados (no van a cocina)
            if (itemsServicio.Any())
            {
                var ahora = DateTime.Now;
                foreach (var servicio in itemsServicio)
                {
                    servicio.EnviadoCocina = false; // No aplica para servicios
                    servicio.Estado = "Entregado"; // Servicios est√°n listos de inmediato
                    
                    var itemDb = await db.PedidosDetalles.FindAsync(servicio.IdPedidoDetalle);
                    if (itemDb != null)
                    {
                        itemDb.EnviadoCocina = false;
                        itemDb.Estado = "Entregado";
                        itemDb.FechaEntrega = ahora;
                    }
                }
                await db.SaveChangesAsync();
            }
            
            if (!itemsNoEnviados.Any())
            {
                if (itemsServicio.Any())
                {
                    _mensajeExito = "Los servicios se marcaron como entregados (no requieren preparaci√≥n)";
                    StateHasChanged();
                }
                else
                {
                    await JS.InvokeVoidAsync("alert", "Todos los items ya fueron enviados a cocina");
                }
                return;
            }

            // Separar items por destino (COCINA vs BARRA)
            var itemsCocina = new List<ComandaService.ItemComanda>();
            var itemsBarra = new List<ComandaService.ItemComanda>();

            foreach (var det in itemsNoEnviados)
            {
                var item = new ComandaService.ItemComanda
                {
                    Cantidad = (int)det.Cantidad,
                    // Usar det.Descripcion (snapshot guardado en PedidoDetalle) 
                    // en lugar de det.Producto?.Descripcion que requiere Include()
                    Descripcion = det.Descripcion ?? "",
                    Modificadores = det.Modificadores,
                    NotasCocina = det.NotasCocina,
                    EsUrgente = det.EsUrgente
                };

                // Para clasificar COCINA vs BARRA, usamos det.Descripcion
                var nombreProd = det.Descripcion?.ToUpper() ?? "";

                // Clasificar por nombre del producto (sin categor√≠a ya que no est√° en PedidoDetalle)
                bool esBebida = nombreProd.Contains("BEBIDA") ||
                                nombreProd.Contains("CERVEZA") ||
                                nombreProd.Contains("VINO") ||
                                nombreProd.Contains("AGUA") ||
                                nombreProd.Contains("GASEOSA") ||
                                nombreProd.Contains("REFRESCO") ||
                                nombreProd.Contains("JUGO") ||
                                nombreProd.Contains("COCTEL") ||
                                nombreProd.Contains("WHISKY") ||
                                nombreProd.Contains("RON") ||
                                nombreProd.Contains("VODKA") ||
                                nombreProd.Contains("DRINK") ||
                                nombreProd.Contains("BARRA");

                if (esBebida)
                    itemsBarra.Add(item);
                else
                    itemsCocina.Add(item);
            }

            bool envioExitoso = false;
            var errores = new List<string>();

            // Enviar a COCINA
            if (itemsCocina.Any() && !string.IsNullOrEmpty(_cajaActual.ImpresoraComandaCocina))
            {
                var comandaCocina = new ComandaService.DatosComanda
                {
                    NumeroComanda = _numeroComanda,
                    NumeroPedido = _pedidoActual?.IdPedido ?? 0,
                    NombreMesa = _mesaSeleccionada?.TextoMostrar,
                    NumeroMesa = _mesaSeleccionada?.Numero?.ToString(),
                    Mesero = _pedidoActual?.NombreMesero ?? "Mesero",
                    Comensales = _pedidoActual?.Comensales ?? 1,
                    Fecha = DateTime.Now,
                    TipoDestino = "COCINA",
                    Items = itemsCocina,
                    Observaciones = _pedidoActual?.Observaciones
                };

                var resultadoCocina = await ComandaService.ImprimirComandaAsync(comandaCocina, _cajaActual);
                if (resultadoCocina.Exitoso)
                    envioExitoso = true;
                else
                    errores.Add($"COCINA: {resultadoCocina.Mensaje}");
            }

            // Enviar a BARRA
            if (itemsBarra.Any() && !string.IsNullOrEmpty(_cajaActual.ImpresoraComandaBarra))
            {
                var comandaBarra = new ComandaService.DatosComanda
                {
                    NumeroComanda = _numeroComanda,
                    NumeroPedido = _pedidoActual?.IdPedido ?? 0,
                    NombreMesa = _mesaSeleccionada?.TextoMostrar,
                    NumeroMesa = _mesaSeleccionada?.Numero?.ToString(),
                    Mesero = _pedidoActual?.NombreMesero ?? "Mesero",
                    Comensales = _pedidoActual?.Comensales ?? 1,
                    Fecha = DateTime.Now,
                    TipoDestino = "BARRA",
                    Items = itemsBarra,
                    Observaciones = _pedidoActual?.Observaciones
                };

                var resultadoBarra = await ComandaService.ImprimirComandaAsync(comandaBarra, _cajaActual);
                if (resultadoBarra.Exitoso)
                    envioExitoso = true;
                else
                    errores.Add($"BARRA: {resultadoBarra.Mensaje}");
            }

            if (envioExitoso)
            {
                // Marcar items como enviados a cocina con estado "Pendiente"
                var ahora = DateTime.Now;
                foreach (var item in itemsNoEnviados)
                {
                    item.EnviadoCocina = true;
                    item.FechaEnvioCocina = ahora;
                    item.NumeroComanda = _numeroComanda;
                    item.Estado = "Pendiente"; // Estado inicial para cocina

                    // Actualizar en BD
                    var itemDb = await db.PedidosDetalles.FindAsync(item.IdPedidoDetalle);
                    if (itemDb != null)
                    {
                        itemDb.EnviadoCocina = true;
                        itemDb.FechaEnvioCocina = ahora;
                        itemDb.NumeroComanda = _numeroComanda;
                        itemDb.Estado = "Pendiente"; // Estado inicial para cocina
                    }
                }
                await db.SaveChangesAsync();
                
                // Reproducir sonido de confirmaci√≥n de env√≠o
                await ReproducirSonidoCocina("enviado");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error enviando comanda: {ex.Message}");
            await JS.InvokeVoidAsync("alert", $"Error al enviar comanda: {ex.Message}");
        }
        finally
        {
            _imprimiendoComanda = false;
            StateHasChanged();
        }
    }

    /// <summary>
    /// Reimprime la comanda de items ya enviados a cocina/barra
    /// </summary>
    private async Task ReimprimirComanda()
    {
        if (_pedidoActual == null || !_detallesPedido.Any())
            return;

        if (_cajaActual == null)
        {
            await JS.InvokeVoidAsync("alert", "No hay caja configurada para reimprimir comandas");
            return;
        }

        if (string.IsNullOrEmpty(_cajaActual.ImpresoraComandaCocina) && string.IsNullOrEmpty(_cajaActual.ImpresoraComandaBarra))
        {
            await JS.InvokeVoidAsync("alert", "Configure las impresoras de comanda en Configuraci√≥n de Cajas");
            return;
        }

        // Items ya enviados a cocina
        var itemsEnviados = _detallesPedido.Where(d => d.EnviadoCocina).ToList();
        if (!itemsEnviados.Any())
        {
            await JS.InvokeVoidAsync("alert", "No hay items enviados a cocina para reimprimir");
            return;
        }

        _reimprimiendoComanda = true;
        StateHasChanged();

        try
        {
            // Obtener el n√∫mero de comanda original del primer item
            var numeroComandaOriginal = itemsEnviados.FirstOrDefault()?.NumeroComanda ?? 0;

            // Separar items por destino (COCINA vs BARRA)
            var itemsCocina = new List<ComandaService.ItemComanda>();
            var itemsBarra = new List<ComandaService.ItemComanda>();

            foreach (var det in itemsEnviados)
            {
                var item = new ComandaService.ItemComanda
                {
                    Cantidad = (int)det.Cantidad,
                    Descripcion = det.Descripcion ?? "",
                    Modificadores = det.Modificadores,
                    NotasCocina = det.NotasCocina,
                    EsUrgente = det.EsUrgente
                };

                var nombreProd = det.Descripcion?.ToUpper() ?? "";

                // Clasificar por nombre del producto
                bool esBebida = nombreProd.Contains("BEBIDA") ||
                                nombreProd.Contains("CERVEZA") ||
                                nombreProd.Contains("VINO") ||
                                nombreProd.Contains("AGUA") ||
                                nombreProd.Contains("GASEOSA") ||
                                nombreProd.Contains("REFRESCO") ||
                                nombreProd.Contains("JUGO") ||
                                nombreProd.Contains("COCTEL") ||
                                nombreProd.Contains("WHISKY") ||
                                nombreProd.Contains("RON") ||
                                nombreProd.Contains("VODKA") ||
                                nombreProd.Contains("DRINK") ||
                                nombreProd.Contains("BARRA");

                if (esBebida)
                    itemsBarra.Add(item);
                else
                    itemsCocina.Add(item);
            }

            bool envioExitoso = false;
            var errores = new List<string>();

            // Reimprimir en COCINA
            if (itemsCocina.Any() && !string.IsNullOrEmpty(_cajaActual.ImpresoraComandaCocina))
            {
                var comandaCocina = new ComandaService.DatosComanda
                {
                    NumeroComanda = numeroComandaOriginal,
                    NumeroPedido = _pedidoActual?.IdPedido ?? 0,
                    NombreMesa = _mesaSeleccionada?.TextoMostrar,
                    NumeroMesa = _mesaSeleccionada?.Numero?.ToString(),
                    Mesero = _pedidoActual?.NombreMesero ?? "Mesero",
                    Comensales = _pedidoActual?.Comensales ?? 1,
                    Fecha = DateTime.Now,
                    TipoDestino = "COCINA (REIMPRESI√ìN)",
                    Items = itemsCocina,
                    Observaciones = _pedidoActual?.Observaciones
                };

                var resultadoCocina = await ComandaService.ImprimirComandaAsync(comandaCocina, _cajaActual);
                if (resultadoCocina.Exitoso)
                    envioExitoso = true;
                else
                    errores.Add($"COCINA: {resultadoCocina.Mensaje}");
            }

            // Reimprimir en BARRA
            if (itemsBarra.Any() && !string.IsNullOrEmpty(_cajaActual.ImpresoraComandaBarra))
            {
                var comandaBarra = new ComandaService.DatosComanda
                {
                    NumeroComanda = numeroComandaOriginal,
                    NumeroPedido = _pedidoActual?.IdPedido ?? 0,
                    NombreMesa = _mesaSeleccionada?.TextoMostrar,
                    NumeroMesa = _mesaSeleccionada?.Numero?.ToString(),
                    Mesero = _pedidoActual?.NombreMesero ?? "Mesero",
                    Comensales = _pedidoActual?.Comensales ?? 1,
                    Fecha = DateTime.Now,
                    TipoDestino = "BARRA (REIMPRESI√ìN)",
                    Items = itemsBarra,
                    Observaciones = _pedidoActual?.Observaciones
                };

                var resultadoBarra = await ComandaService.ImprimirComandaAsync(comandaBarra, _cajaActual);
                if (resultadoBarra.Exitoso)
                    envioExitoso = true;
                else
                    errores.Add($"BARRA: {resultadoBarra.Mensaje}");
            }

            if (envioExitoso)
            {
                _mensajeExito = "Comanda reimpresa correctamente";
                await ReproducirSonidoCocina("enviado");
            }
            else if (errores.Any())
            {
                _mensajeError = $"Error al reimprimir: {string.Join(", ", errores)}";
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error reimprimiendo comanda: {ex.Message}");
            await JS.InvokeVoidAsync("alert", $"Error al reimprimir comanda: {ex.Message}");
        }
        finally
        {
            _reimprimiendoComanda = false;
            StateHasChanged();
        }
    }
    
    /// <summary>
    /// Imprime un comprobante del pedido para el cliente en la impresora de facturaci√≥n de caja.
    /// </summary>
    private async Task ImprimirPedidoCliente()
    {
        if (_pedidoActual == null || !_detallesPedido.Any()) return;
        
        _imprimiendoPedido = true;
        StateHasChanged();
        
        try
        {
            await using var db = await DbFactory.CreateDbContextAsync();
            
            // Obtener datos de la empresa
            var sociedad = await db.Sociedades.FirstOrDefaultAsync();
            
            // Usar impresora de comprobante pedido si est√° configurada, sino usar impresora de facturaci√≥n
            var impresoraPedido = _cajaActual?.ImpresoraComprobantePedido ?? _cajaActual?.NombreImpresora;
            
            // Construir datos del pedido
            var datosPedido = new DatosPedidoTicket
            {
                // Logo de la sucursal
                LogoBytes = _sucursalActual?.Logo,
                
                // Datos de la empresa
                NombreEmpresa = sociedad?.Nombre ?? "EMPRESA",
                DireccionEmpresa = _sucursalActual?.Direccion ?? sociedad?.Direccion ?? "",
                TelefonoEmpresa = _sucursalActual?.Telefono ?? sociedad?.Telefono ?? "",
                
                // Datos del pedido
                NumeroPedido = _pedidoActual.IdPedido,
                NumeroComanda = _numeroComanda,
                FechaPedido = _pedidoActual.FechaApertura,
                NombreMesa = _mesaSeleccionada?.TextoMostrar ?? "MESA",
                NombreMesero = _pedidoActual.NombreMesero,
                NombreCliente = _pedidoActual.NombreCliente,
                CantidadComensales = _pedidoActual.Comensales,
                
                // Observaciones del pedido
                ObservacionesPedido = _pedidoActual.Observaciones,
                
                // Items del pedido
                Items = _detallesPedido.Select(d => new ItemPedidoTicket
                {
                    Descripcion = d.Descripcion ?? "",
                    Cantidad = d.Cantidad,
                    PrecioUnitario = d.PrecioUnitario,
                    Subtotal = d.Importe,
                    Modificadores = d.Modificadores,
                    NotasCocina = d.NotasCocina,
                    Categoria = d.Producto?.Clasificacion?.Descripcion,
                    EsUrgente = d.EsUrgente
                }).ToList(),
                
                // Totales
                Subtotal = _totalPedidoGeneral,
                Descuento = 0, // Puede implementarse si hay descuentos
                CargoServicio = 0, // Puede implementarse si hay cargo de servicio
                Total = _totalPedidoGeneral,
                
                // Opciones
                MostrarPrecios = true,
                EsComanda = false,
                MensajePie = "¬°Gracias por su preferencia!"
            };
            
            // Imprimir
            var resultado = await ImpresionDirectaService.ImprimirTicketPedido80mm(datosPedido, impresoraPedido);
            
            if (resultado.Exitoso)
            {
                _mensajeExito = "Comprobante de pedido impreso correctamente";
            }
            else
            {
                _mensajeError = $"Error al imprimir: {resultado.Mensaje}";
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error imprimiendo pedido: {ex.Message}");
            await JS.InvokeVoidAsync("alert", $"Error al imprimir comprobante: {ex.Message}");
        }
        finally
        {
            _imprimiendoPedido = false;
            StateHasChanged();
        }
    }

    // ========== MODO CANCHAS - ACTUALIZACI√ìN DE TIEMPOS ==========
    private async Task ActualizarTiemposCanchasAsync()
    {
        try
        {
            var reservasEnCurso = _reservasHoy.Where(r => r.Estado == "EnCurso" && r.HoraInicioReal.HasValue).ToList();
            var ahora = DateTime.Now.TimeOfDay;
            bool hayActualizacion = false;

            foreach (var reserva in reservasEnCurso)
            {
                // Calcular tiempo restante bas√°ndose en HoraFin o DuracionMinutos
                TimeSpan? horaFinProgramada = null;
                
                if (reserva.HoraFin.HasValue)
                {
                    horaFinProgramada = reserva.HoraFin.Value;
                }
                else if (reserva.DuracionMinutos.HasValue && reserva.HoraInicioReal.HasValue)
                {
                    horaFinProgramada = reserva.HoraInicioReal.Value.Add(TimeSpan.FromMinutes(reserva.DuracionMinutos.Value));
                }

                if (horaFinProgramada.HasValue)
                {
                    var tiempoRestante = horaFinProgramada.Value - ahora;
                    _tiemposRestantes[reserva.IdReserva] = tiempoRestante;

                    // Sonido de inicio cuando empieza la reserva (solo una vez)
                    if (!_reservasIniciadas.Contains(reserva.IdReserva))
                    {
                        _reservasIniciadas.Add(reserva.IdReserva);
                        await InvokeAsync(async () => await ReproducirSonidoCancha("inicio"));
                        hayActualizacion = true;
                    }

                    // Sonido de fin cuando termina el tiempo (solo una vez)
                    if (tiempoRestante <= TimeSpan.Zero && !_reservasFinalizadas.Contains(reserva.IdReserva))
                    {
                        _reservasFinalizadas.Add(reserva.IdReserva);
                        await InvokeAsync(async () => await ReproducirSonidoCancha("fin"));
                        hayActualizacion = true;
                    }
                }
            }

            // Limpiar reservas que ya no est√°n en curso
            var idsEnCurso = reservasEnCurso.Select(r => r.IdReserva).ToHashSet();
            _tiemposRestantes = _tiemposRestantes.Where(kv => idsEnCurso.Contains(kv.Key)).ToDictionary(kv => kv.Key, kv => kv.Value);

            if (reservasEnCurso.Any() || hayActualizacion)
            {
                await InvokeAsync(StateHasChanged);
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error actualizando tiempos de canchas: {ex.Message}");
        }
    }

    private async Task ReproducirSonidoCancha(string tipo)
    {
        try
        {
            // Usar Web Audio API o beep para sonidos
            if (tipo == "inicio")
            {
                // Sonido breve de inicio (beep suave)
                await JS.InvokeVoidAsync("eval", @"
                    (function() {
                        const ctx = new (window.AudioContext || window.webkitAudioContext)();
                        const osc = ctx.createOscillator();
                        const gain = ctx.createGain();
                        osc.connect(gain);
                        gain.connect(ctx.destination);
                        osc.frequency.value = 800;
                        osc.type = 'sine';
                        gain.gain.value = 0.3;
                        osc.start();
                        setTimeout(() => { gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.3); }, 200);
                        setTimeout(() => osc.stop(), 500);
                    })();
                ");
            }
            else if (tipo == "fin")
            {
                // Sonido m√°s pronunciado de fin (doble beep)
                await JS.InvokeVoidAsync("eval", @"
                    (function() {
                        const ctx = new (window.AudioContext || window.webkitAudioContext)();
                        function beep(freq, delay) {
                            const osc = ctx.createOscillator();
                            const gain = ctx.createGain();
                            osc.connect(gain);
                            gain.connect(ctx.destination);
                            osc.frequency.value = freq;
                            osc.type = 'square';
                            gain.gain.value = 0.5;
                            setTimeout(() => {
                                osc.start();
                                setTimeout(() => { gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.4); }, 300);
                                setTimeout(() => osc.stop(), 500);
                            }, delay);
                        }
                        beep(1000, 0);
                        beep(1200, 400);
                        beep(1400, 800);
                    })();
                ");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error reproduciendo sonido cancha: {ex.Message}");
        }
    }

    /// <summary>
    /// Obtiene el tiempo restante formateado para una reserva en modo cancha
    /// </summary>
    private string ObtenerTiempoRestanteCancha(Reserva reserva)
    {
        if (_tiemposRestantes.TryGetValue(reserva.IdReserva, out var tiempo))
        {
            if (tiempo <= TimeSpan.Zero)
            {
                // Tiempo negativo = tiempo extra
                var tiempoExtra = tiempo.Negate();
                return $"+{tiempoExtra:hh\\:mm\\:ss}";
            }
            return tiempo.ToString(@"hh\:mm\:ss");
        }
        return "--:--:--";
    }

    /// <summary>
    /// Verifica si una reserva de cancha ha finalizado (tiempo agotado)
    /// </summary>
    private bool ReservaFinalizada(Reserva reserva)
    {
        return _tiemposRestantes.TryGetValue(reserva.IdReserva, out var tiempo) && tiempo <= TimeSpan.Zero;
    }

    public void Dispose()
    {
        _disposed = true;
        _timerActualizacion?.Dispose();
        _timerEstadosCocina?.Dispose();
        _timerVerificarCaja?.Dispose();
        _dotNetRef?.Dispose();
    }
}
