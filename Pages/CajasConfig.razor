@page "/configuracion/cajas"
@using Microsoft.EntityFrameworkCore
@using Microsoft.AspNetCore.Components
@using Microsoft.AspNetCore.Components.Forms
@inject IDbContextFactory<SistemIA.Models.AppDbContext> DbFactory
@inject SistemIA.Services.ICajaService CajaService
@inject SistemIA.Services.ComandaService ComandaService
@inject SistemIA.Services.ImpresionDirectaService ImpresionDirectaService

<PageProtection Modulo="/configuracion" Permiso="VIEW">

<h3>Configuración de Cajas</h3>

@if (!string.IsNullOrEmpty(error))
{
    <div class="alert alert-danger">@error</div>
}

<div class="mb-3">
    <button class="btn btn-sm btn-primary" @onclick="CrearNueva">Nueva Caja</button>
    <button class="btn btn-sm btn-outline-secondary ms-2" @onclick="Cargar">Refrescar</button>
</div>

<div class="row g-3">
    <div class="col-12">
        <table class="table table-sm table-striped align-middle">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Nombre</th>
                    <th>Serie</th>
                    <th>Timbrado</th>
                    <th>Vigencia</th>
                    <th>Bloquear</th>
                    <th>Activa</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var c in cajas)
                {
                    <tr>
                        <td>@c.IdCaja</td>
                        <td>@(c.Nombre ?? $"Caja {c.IdCaja}")</td>
                        <td>@c.Serie</td>
                        <td>@c.Timbrado</td>
                        <td>@(c.VigenciaDel?.ToString("dd/MM/yyyy") ?? "") - @(c.VigenciaAl?.ToString("dd/MM/yyyy") ?? "")</td>
                        <td>@((c.BloquearFactura ?? false) ? "Sí" : "No")</td>
                        <td>@((c.CajaActual == 1) ? "Sí" : "No")</td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary" @onclick="() => Editar(c)">Editar</button>
                            <button class="btn btn-sm btn-outline-success ms-1" title="Establecer como caja actual" @onclick="() => EstablecerActual(c.IdCaja)" disabled="@(c.CajaActual == 1)">Activar</button>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
</div>

@if (editando != null)
{
    <!-- Datos de la Caja -->
    <div class="card mb-3 border-primary">
        <div class="card-header bg-primary text-white py-2">
            <i class="bi bi-cash-stack me-2"></i><strong>Datos de la Caja</strong>
        </div>
        <div class="card-body">
            <div class="row g-3">
                <div class="col-md-4">
                    <label class="form-label">Nombre de la Caja</label>
                    <input class="form-control" type="text" @bind="editando.Nombre" placeholder="Ej: Caja Principal, Caja 1" />
                </div>
                <div class="col-md-3">
                    <label class="form-label">Fecha Actual Caja</label>
                    <input class="form-control" type="date" @bind="editando.FechaActualCaja" />
                </div>
                <div class="col-md-2">
                    <div class="form-check mt-4">
                        <input id="chkBloqFecha" type="checkbox" class="form-check-input" @bind="BloqFechaCajaChecked" />
                        <label class="form-check-label" for="chkBloqFecha">Bloquear fecha</label>
                    </div>
                </div>
                <div class="col-md-2">
                    <label class="form-label">Cant. Turnos</label>
                    <input class="form-control" type="number" @bind="editando.CantTurnos" />
                </div>
                <div class="col-md-1">
                    <label class="form-label">Turno</label>
                    <input class="form-control" type="number" @bind="editando.TurnoActual" />
                </div>
            </div>
        </div>
    </div>

    <!-- Datos de la Factura -->
    <div class="card mb-3 border-success">
        <div class="card-header bg-success text-white py-2">
            <i class="bi bi-receipt me-2"></i><strong>Datos de la Factura</strong>
        </div>
        <div class="card-body">
            <div class="row g-3">
            <div class="col-md-2">
                <label class="form-label">Nivel 1</label>
                <input class="form-control" type="text" @bind="editando.Nivel1" />
            </div>
            <div class="col-md-2">
                <label class="form-label">Nivel 2</label>
                <input class="form-control" type="text" @bind="editando.Nivel2" />
            </div>
            <div class="col-md-3">
                <label class="form-label">Factura Inicial</label>
                <input class="form-control" type="text" @bind="editando.FacturaInicial" />
            </div>
            <div class="col-md-2">
                <label class="form-label">Serie</label>
                <input class="form-control" type="number" @bind="editando.Serie" />
            </div>
            <div class="col-md-3">
                <label class="form-label">Timbrado</label>
                <input class="form-control" type="text" @bind="editando.Timbrado" />
            </div>
            <div class="col-md-3">
                <label class="form-label">Vigencia Desde</label>
                <input class="form-control" type="date" @bind="editando.VigenciaDel" />
            </div>
            <div class="col-md-3">
                <label class="form-label">Vigencia Hasta</label>
                <input class="form-control" type="date" @bind="editando.VigenciaAl" />
            </div>
            <div class="col-md-4">
                <label class="form-label">Impresora (Factura)</label>
                <input class="form-control" type="text" @bind="editando.NombreImpresora" />
            </div>
            <div class="col-md-3">
                <div class="form-check mt-4">
                    <input id="chkBloqFactura" type="checkbox" class="form-check-input" @bind="BloqFacturaChecked" />
                    <label class="form-check-label" for="chkBloqFactura">Bloquear número</label>
                </div>
            </div>
            <div class="col-md-3">
                <div class="form-check mt-4">
                    <input id="chkImpFactura" type="checkbox" class="form-check-input" @bind="ImprimirFacturaChecked" />
                    <label class="form-check-label" for="chkImpFactura">Imprimir Facturas</label>
                </div>
            </div>
            <div class="col-md-3">
                <label class="form-label">Tipo de Facturación</label>
                <select class="form-select" @bind="editando.TipoFacturacion">
                    <option value="ELECTRONICA">Factura Electrónica</option>
                    <option value="AUTOIMPRESOR">Factura Autoimpresor</option>
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label">Formato de Impresión</label>
                <select class="form-select" @bind="editando.FormatoImpresion">
                    <option value="">-- Seleccione --</option>
                    <option value="TICKET">Ticket Térmico (80mm)</option>
                    <option value="A4">Láser A4</option>
                    <option value="MATRICIAL">Matricial (Carta)</option>
                </select>
            </div>
            <div class="col-md-2">
                <div class="form-check mt-4">
                    <input id="chkMostrarLogo" type="checkbox" class="form-check-input" @bind="MostrarLogoChecked" />
                    <label class="form-check-label" for="chkMostrarLogo">Con Logo</label>
                </div>
            </div>
            <div class="col-md-2">
                <label class="form-label">Ancho Ticket (caracteres)</label>
                <input class="form-control" type="number" @bind="editando.AnchoTicket" placeholder="42" />
            </div>
            </div>
        </div>
    </div>

    <!-- Datos de la Remisión -->
    <div class="card mb-3 border-info">
        <div class="card-header bg-info text-white py-2">
            <i class="bi bi-truck me-2"></i><strong>Datos de la Remisión</strong>
        </div>
        <div class="card-body">
            <div class="row g-3">
            <div class="col-md-2">
                <label class="form-label">Nivel 1</label>
                <input class="form-control" type="text" @bind="editando.Nivel1R" />
            </div>
            <div class="col-md-2">
                <label class="form-label">Nivel 2</label>
                <input class="form-control" type="text" @bind="editando.Nivel2R" />
            </div>
            <div class="col-md-3">
                <label class="form-label">Factura Inicial</label>
                <input class="form-control" type="text" @bind="editando.FacturaInicialR" />
            </div>
            <div class="col-md-2">
                <label class="form-label">Serie</label>
                <input class="form-control" type="number" @bind="editando.SerieR" />
            </div>
            <div class="col-md-3">
                <label class="form-label">Timbrado</label>
                <input class="form-control" type="text" @bind="editando.TimbradoR" />
            </div>
            <div class="col-md-3">
                <label class="form-label">Vigencia Desde</label>
                <input class="form-control" type="date" @bind="editando.VigenciaDelR" />
            </div>
            <div class="col-md-3">
                <label class="form-label">Vigencia Hasta</label>
                <input class="form-control" type="date" @bind="editando.VigenciaAlR" />
            </div>
            <div class="col-md-4">
                <label class="form-label">Impresora (Remisión)</label>
                <input class="form-control" type="text" @bind="editando.NombreImpresoraR" />
            </div>
            <div class="col-md-3">
                <div class="form-check mt-4">
                    <input id="chkBloqRem" type="checkbox" class="form-check-input" @bind="BloqRemisionChecked" />
                    <label class="form-check-label" for="chkBloqRem">Bloquear número</label>
                </div>
            </div>
            <div class="col-md-3">
                <div class="form-check mt-4">
                    <input id="chkImpRem" type="checkbox" class="form-check-input" @bind="ImprimirRemisionChecked" />
                    <label class="form-check-label" for="chkImpRem">Imprimir Remisión</label>
                </div>
            </div>
            </div>
        </div>
    </div>

    <!-- Datos de la Nota de Crédito -->
    <div class="card mb-3 border-warning">
        <div class="card-header bg-warning text-dark py-2">
            <i class="bi bi-file-earmark-minus me-2"></i><strong>Datos de la Nota de Crédito</strong>
        </div>
        <div class="card-body">
            <div class="row g-3">
            <div class="col-md-2">
                <label class="form-label">Nivel 1</label>
                <input class="form-control" type="text" @bind="editando.Nivel1NC" />
            </div>
            <div class="col-md-2">
                <label class="form-label">Nivel 2</label>
                <input class="form-control" type="text" @bind="editando.Nivel2NC" />
            </div>
            <div class="col-md-3">
                <label class="form-label">N° Nota Crédito</label>
                <input class="form-control" type="text" @bind="editando.NumeroNC" />
            </div>
            <div class="col-md-2">
                <label class="form-label">Serie</label>
                <input class="form-control" type="number" @bind="editando.SerieNC" />
            </div>
            <div class="col-md-3">
                <label class="form-label">Timbrado</label>
                <input class="form-control" type="text" @bind="editando.TimbradoNC" />
            </div>
            <div class="col-md-3">
                <label class="form-label">Vigencia Desde</label>
                <input class="form-control" type="date" @bind="editando.VigenciaDelNC" />
            </div>
            <div class="col-md-3">
                <label class="form-label">Vigencia Hasta</label>
                <input class="form-control" type="date" @bind="editando.VigenciaAlNC" />
            </div>
            <div class="col-md-4">
                <label class="form-label">Impresora (N. Crédito)</label>
                <input class="form-control" type="text" @bind="editando.NombreImpresoraNC" />
            </div>
            <div class="col-md-3">
                <div class="form-check mt-4">
                    <input id="chkBloqNC" type="checkbox" class="form-check-input" @bind="BloqNCChecked" />
                    <label class="form-check-label" for="chkBloqNC">Bloquear número NC</label>
                </div>
            </div>
            <div class="col-md-3">
                <div class="form-check mt-4">
                    <input id="chkImpNC" type="checkbox" class="form-check-input" @bind="ImprimirNCChecked" />
                    <label class="form-check-label" for="chkImpNC">Imprimir N. Crédito</label>
                </div>
            </div>
            </div>
        </div>
    </div>

    <!-- Datos del Recibo -->
    <div class="card mb-3 border-secondary">
        <div class="card-header bg-secondary text-white py-2">
            <i class="bi bi-journal-text me-2"></i><strong>Datos del Recibo</strong>
        </div>
        <div class="card-body">
            <div class="row g-3">
            <div class="col-md-2">
                <label class="form-label">Nivel 1</label>
                <input class="form-control" type="text" @bind="editando.Nivel1Recibo" />
            </div>
            <div class="col-md-2">
                <label class="form-label">Nivel 2</label>
                <input class="form-control" type="text" @bind="editando.Nivel2Recibo" />
            </div>
            <div class="col-md-3">
                <label class="form-label">N° Recibo</label>
                <input class="form-control" type="text" @bind="editando.NumeroRecibo" />
            </div>
            <div class="col-md-2">
                <label class="form-label">Serie</label>
                <input class="form-control" type="number" @bind="editando.SerieRecibo" />
            </div>
            <div class="col-md-3">
                <label class="form-label">Timbrado</label>
                <input class="form-control" type="text" @bind="editando.TimbradoRecibo" />
            </div>
            <div class="col-md-3">
                <label class="form-label">Vigencia Desde</label>
                <input class="form-control" type="date" @bind="editando.VigenciaDelRecibo" />
            </div>
            <div class="col-md-3">
                <label class="form-label">Vigencia Hasta</label>
                <input class="form-control" type="date" @bind="editando.VigenciaAlRecibo" />
            </div>
            <div class="col-md-4">
                <label class="form-label">Impresora (Recibo)</label>
                <input class="form-control" type="text" @bind="editando.NombreImpresoraRecibo" />
            </div>
            <div class="col-md-3">
                <div class="form-check mt-4">
                    <input id="chkBloqRec" type="checkbox" class="form-check-input" @bind="BloqReciboChecked" />
                    <label class="form-check-label" for="chkBloqRec">Bloquear número</label>
                </div>
            </div>
            <div class="col-md-3">
                <div class="form-check mt-4">
                    <input id="chkImpRec" type="checkbox" class="form-check-input" @bind="ImprimirReciboChecked" />
                    <label class="form-check-label" for="chkImpRec">Imprimir Recibo</label>
                </div>
            </div>
            </div>
        </div>
    </div>

    @* ========== SECCIÓN COMANDAS RESTAURANTE ========== *@
    <div class="card mb-3 border-danger">
        <div class="card-header bg-danger text-white py-2">
            <i class="bi bi-fire me-2"></i><strong>Impresoras de Comandas (Cocina/Barra)</strong>
        </div>
        <div class="card-body">
            <div class="row g-3">
                @* COCINA *@
                <div class="col-12">
                    <h6 class="text-danger"><i class="bi bi-egg-fried me-1"></i>Impresora Cocina</h6>
                </div>
                    <div class="col-md-4">
                        <label class="form-label">Impresora / IP Cocina</label>
                        <div class="input-group">
                            <input class="form-control" type="text" @bind="editando.ImpresoraComandaCocina" 
                                   placeholder="@(ComandaCocinaEsRedChecked ? "192.168.1.100" : "Nombre impresora")" />
                            @if (!string.IsNullOrEmpty(editando.ImpresoraComandaCocina))
                            {
                                <button class="btn btn-outline-secondary" type="button" @onclick="ProbarImpresoraCocina" 
                                        disabled="@_probandoCocina" title="Probar conexión">
                                    @if (_probandoCocina)
                                    {
                                        <span class="spinner-border spinner-border-sm"></span>
                                    }
                                    else
                                    {
                                        <i class="bi bi-lightning"></i>
                                    }
                                </button>
                            }
                        </div>
                        @if (!string.IsNullOrEmpty(_resultadoPruebaCocina))
                        {
                            <small class="@(_exitoPruebaCocina ? "text-success" : "text-danger")">
                                <i class="bi @(_exitoPruebaCocina ? "bi-check-circle" : "bi-x-circle") me-1"></i>@_resultadoPruebaCocina
                            </small>
                        }
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Puerto TCP</label>
                        <input class="form-control" type="number" @bind="editando.PuertoImpresoraCocina" placeholder="9100" 
                               disabled="@(!ComandaCocinaEsRedChecked)" />
                    </div>
                    <div class="col-md-2">
                        <div class="form-check mt-4">
                            <input id="chkCocinaRed" type="checkbox" class="form-check-input" @bind="ComandaCocinaEsRedChecked" />
                            <label class="form-check-label" for="chkCocinaRed">Es IP de Red</label>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Copias</label>
                        <input class="form-control" type="number" @bind="editando.CopiasComandaCocina" min="1" max="5" placeholder="1" />
                    </div>
                    <div class="col-md-2">
                        <button class="btn btn-outline-danger mt-4" type="button" @onclick="ImprimirPruebaCocina" 
                                disabled="@(string.IsNullOrEmpty(editando.ImpresoraComandaCocina) || _imprimiendoPruebaCocina)">
                            @if (_imprimiendoPruebaCocina)
                            {
                                <span class="spinner-border spinner-border-sm me-1"></span>
                            }
                            <i class="bi bi-printer me-1"></i>Prueba
                        </button>
                    </div>

                    <div class="col-12"><hr class="my-2" /></div>

                    @* BARRA *@
                    <div class="col-12">
                        <h6 class="text-info"><i class="bi bi-cup-straw me-1"></i>Impresora Barra</h6>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Impresora / IP Barra</label>
                        <div class="input-group">
                            <input class="form-control" type="text" @bind="editando.ImpresoraComandaBarra" 
                                   placeholder="@(ComandaBarraEsRedChecked ? "192.168.1.101" : "Nombre impresora")" />
                            @if (!string.IsNullOrEmpty(editando.ImpresoraComandaBarra))
                            {
                                <button class="btn btn-outline-secondary" type="button" @onclick="ProbarImpresoraBarra" 
                                        disabled="@_probandoBarra" title="Probar conexión">
                                    @if (_probandoBarra)
                                    {
                                        <span class="spinner-border spinner-border-sm"></span>
                                    }
                                    else
                                    {
                                        <i class="bi bi-lightning"></i>
                                    }
                                </button>
                            }
                        </div>
                        @if (!string.IsNullOrEmpty(_resultadoPruebaBarra))
                        {
                            <small class="@(_exitoPruebaBarra ? "text-success" : "text-danger")">
                                <i class="bi @(_exitoPruebaBarra ? "bi-check-circle" : "bi-x-circle") me-1"></i>@_resultadoPruebaBarra
                            </small>
                        }
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Puerto TCP</label>
                        <input class="form-control" type="number" @bind="editando.PuertoImpresoraBarra" placeholder="9100" 
                               disabled="@(!ComandaBarraEsRedChecked)" />
                    </div>
                    <div class="col-md-2">
                        <div class="form-check mt-4">
                            <input id="chkBarraRed" type="checkbox" class="form-check-input" @bind="ComandaBarraEsRedChecked" />
                            <label class="form-check-label" for="chkBarraRed">Es IP de Red</label>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Copias</label>
                        <input class="form-control" type="number" @bind="editando.CopiasComandaBarra" min="1" max="5" placeholder="1" />
                    </div>
                    <div class="col-md-2">
                        <button class="btn btn-outline-info mt-4" type="button" @onclick="ImprimirPruebaBarra" 
                                disabled="@(string.IsNullOrEmpty(editando.ImpresoraComandaBarra) || _imprimiendoPruebaBarra)">
                            @if (_imprimiendoPruebaBarra)
                            {
                                <span class="spinner-border spinner-border-sm me-1"></span>
                            }
                            <i class="bi bi-printer me-1"></i>Prueba
                        </button>
                    </div>

                    <div class="col-12"><hr class="my-2" /></div>

                    @* OPCIONES GENERALES *@
                    <div class="col-md-4">
                        <div class="form-check">
                            <input id="chkComandaAuto" type="checkbox" class="form-check-input" @bind="ImprimirComandaAutomaticaChecked" />
                            <label class="form-check-label" for="chkComandaAuto">
                                <i class="bi bi-lightning-charge text-warning me-1"></i>Imprimir comanda automáticamente al agregar items
                            </label>
                        </div>
                    </div>
                    <div class="col-md-8">
                        <div class="alert alert-info py-2 mb-0 small">
                            <i class="bi bi-info-circle me-1"></i>
                            <strong>Tip:</strong> Para impresoras de red, use la IP directa (ej: 192.168.1.100) con puerto 9100 (RAW printing).
                            Para impresoras Windows compartidas, use el nombre (ej: \\SERVIDOR\Cocina).
                        </div>
                    </div>

                    <div class="col-12"><hr class="my-2" /></div>

                    @* COMPROBANTE PEDIDO (CLIENTE) *@
                    <div class="col-12">
                        <h6 class="text-success"><i class="bi bi-receipt me-1"></i>Impresora Comprobante Pedido (Cliente)</h6>
                        <small class="text-muted">Imprime ticket de pedido para el cliente (diferente a la comanda de cocina)</small>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Impresora / IP Comprobante</label>
                        <div class="input-group">
                            <input class="form-control" type="text" @bind="editando.ImpresoraComprobantePedido" 
                                   placeholder="@(ComprobanteEsRedChecked ? "192.168.1.102" : "Nombre impresora")" />
                            @if (!string.IsNullOrEmpty(editando.ImpresoraComprobantePedido))
                            {
                                <button class="btn btn-outline-secondary" type="button" @onclick="ProbarImpresoraComprobante" 
                                        disabled="@_probandoComprobante" title="Probar conexión">
                                    @if (_probandoComprobante)
                                    {
                                        <span class="spinner-border spinner-border-sm"></span>
                                    }
                                    else
                                    {
                                        <i class="bi bi-lightning"></i>
                                    }
                                </button>
                            }
                        </div>
                        @if (!string.IsNullOrEmpty(_resultadoPruebaComprobante))
                        {
                            <small class="@(_exitoPruebaComprobante ? "text-success" : "text-danger")">
                                <i class="bi @(_exitoPruebaComprobante ? "bi-check-circle" : "bi-x-circle") me-1"></i>@_resultadoPruebaComprobante
                            </small>
                        }
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Puerto TCP</label>
                        <input class="form-control" type="number" @bind="editando.PuertoImpresoraComprobante" placeholder="9100" 
                               disabled="@(!ComprobanteEsRedChecked)" />
                    </div>
                    <div class="col-md-2">
                        <div class="form-check mt-4">
                            <input id="chkComprobanteRed" type="checkbox" class="form-check-input" @bind="ComprobanteEsRedChecked" />
                            <label class="form-check-label" for="chkComprobanteRed">Es IP de Red</label>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="form-check mt-4">
                            <input id="chkComprobanteAuto" type="checkbox" class="form-check-input" @bind="ImprimirComprobantePedidoAutoChecked" />
                            <label class="form-check-label" for="chkComprobanteAuto">Auto al confirmar</label>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <button class="btn btn-outline-success mt-4" type="button" @onclick="ImprimirPruebaComprobante" 
                                disabled="@(string.IsNullOrEmpty(editando.ImpresoraComprobantePedido) || _imprimiendoPruebaComprobante)">
                            @if (_imprimiendoPruebaComprobante)
                            {
                                <span class="spinner-border spinner-border-sm me-1"></span>
                            }
                            <i class="bi bi-printer me-1"></i>Prueba
                        </button>
                    </div>
                </div>
            </div>
        </div>

    <!-- Botones -->
    <div class="mt-3 d-flex gap-2">
        <button class="btn btn-success" type="button" @onclick="Guardar"><i class="bi bi-check-lg me-1"></i>Guardar</button>
        <button class="btn btn-secondary" type="button" @onclick="Cancelar"><i class="bi bi-x-lg me-1"></i>Cancelar</button>
    </div>
}

</PageProtection>

@code {
    private string? error;
    private List<SistemIA.Models.Caja> cajas = new();
    private SistemIA.Models.Caja? editando;
    private bool _modoRestauranteActivo = false;
    
    // Variables para pruebas de impresoras de comandas
    private bool _probandoCocina = false;
    private bool _probandoBarra = false;
    private bool _probandoComprobante = false;
    private bool _imprimiendoPruebaCocina = false;
    private bool _imprimiendoPruebaBarra = false;
    private bool _imprimiendoPruebaComprobante = false;
    private string? _resultadoPruebaCocina;
    private string? _resultadoPruebaBarra;
    private string? _resultadoPruebaComprobante;
    private bool _exitoPruebaCocina;
    private bool _exitoPruebaBarra;
    private bool _exitoPruebaComprobante;

    private bool BloqFacturaChecked
    {
        get => editando?.BloquearFactura ?? false;
        set { if (editando != null) editando.BloquearFactura = value; }
    }
    private bool BloqFechaCajaChecked
    {
        get => editando?.bloquear_fechaCaja ?? false;
        set { if (editando != null) editando.bloquear_fechaCaja = value; }
    }
    private bool ImprimirFacturaChecked
    {
        get => (editando?.Imprimir_Factura ?? 0) == 1;
        set { if (editando != null) editando.Imprimir_Factura = value ? 1 : 0; }
    }
    private bool BloqRemisionChecked
    {
        get => editando?.BloquearFacturaR ?? false;
        set { if (editando != null) editando.BloquearFacturaR = value; }
    }
    private bool ImprimirRemisionChecked
    {
        get => editando?.Imprimir_remisionR ?? false;
        set { if (editando != null) editando.Imprimir_remisionR = value; }
    }
    private bool BloqNCChecked
    {
        get => editando?.BloquearFacturaNC ?? false;
        set { if (editando != null) editando.BloquearFacturaNC = value; }
    }
    private bool ImprimirNCChecked
    {
        get => editando?.Imprimir_remisionNC ?? false;
        set { if (editando != null) editando.Imprimir_remisionNC = value; }
    }
    private bool BloqReciboChecked
    {
        get => editando?.BloquearFacturaRecibo ?? false;
        set { if (editando != null) editando.BloquearFacturaRecibo = value; }
    }
    private bool ImprimirReciboChecked
    {
        get => editando?.Imprimir_remisionRecibo ?? false;
        set { if (editando != null) editando.Imprimir_remisionRecibo = value; }
    }
    private bool MostrarLogoChecked
    {
        get => editando?.MostrarLogo ?? false;
        set { if (editando != null) editando.MostrarLogo = value; }
    }
    
    // Propiedades para configuración de comandas
    private bool ComandaCocinaEsRedChecked
    {
        get => editando?.ComandaCocinaEsRed ?? false;
        set { if (editando != null) editando.ComandaCocinaEsRed = value; }
    }
    private bool ComandaBarraEsRedChecked
    {
        get => editando?.ComandaBarraEsRed ?? false;
        set { if (editando != null) editando.ComandaBarraEsRed = value; }
    }
    private bool ImprimirComandaAutomaticaChecked
    {
        get => editando?.ImprimirComandaAutomatica ?? false;
        set { if (editando != null) editando.ImprimirComandaAutomatica = value; }
    }
    
    // Propiedades para comprobante de pedido
    private bool ComprobanteEsRedChecked
    {
        get => editando?.ComprobanteEsRed ?? false;
        set { if (editando != null) editando.ComprobanteEsRed = value; }
    }
    private bool ImprimirComprobantePedidoAutoChecked
    {
        get => editando?.ImprimirComprobantePedidoAuto ?? false;
        set { if (editando != null) editando.ImprimirComprobantePedidoAuto = value; }
    }

    protected override async Task OnInitializedAsync() => await Cargar();

    private async Task Cargar()
    {
        error = null;
        try
        {
            await using var ctx = await DbFactory.CreateDbContextAsync();
            await EnsureColumnasCajaAsync(ctx);
            cajas = await ctx.Cajas.AsNoTracking().OrderBy(c => c.IdCaja).ToListAsync();
            
            // Verificar si está activo el modo restaurante
            var config = await ctx.ConfiguracionSistema.FirstOrDefaultAsync();
            _modoRestauranteActivo = config?.RestauranteModoActivo ?? false;
        }
        catch (Exception ex)
        {
            error = ex.Message;
        }
    }

    private void CrearNueva()
    {
        editando = new SistemIA.Models.Caja { Nivel1 = "001", Nivel2 = "001", FacturaInicial = "0000001" };
    }

    private void Editar(SistemIA.Models.Caja c)
    {
        // Limpiar resultados de pruebas anteriores
        _resultadoPruebaCocina = null;
        _resultadoPruebaBarra = null;
        _resultadoPruebaComprobante = null;
        
        editando = new SistemIA.Models.Caja
        {
            IdCaja = c.IdCaja,
            Nombre = c.Nombre,
            CantTurnos = c.CantTurnos,
            TurnoActual = c.TurnoActual,
            Nivel1 = c.Nivel1,
            Nivel2 = c.Nivel2,
            FacturaInicial = c.FacturaInicial,
            Serie = c.Serie,
            Timbrado = c.Timbrado,
            NombreImpresora = c.NombreImpresora,
            FechaActualCaja = c.FechaActualCaja,
            VigenciaDel = c.VigenciaDel,
            VigenciaAl = c.VigenciaAl,
            BloquearFactura = c.BloquearFactura,
            Imprimir_Factura = c.Imprimir_Factura,
            bloquear_fechaCaja = c.bloquear_fechaCaja,
            TipoFacturacion = c.TipoFacturacion,
            FormatoImpresion = c.FormatoImpresion,
            MostrarLogo = c.MostrarLogo,
            AnchoTicket = c.AnchoTicket,
            // Remisión
            Nivel1R = c.Nivel1R,
            Nivel2R = c.Nivel2R,
            FacturaInicialR = c.FacturaInicialR,
            SerieR = c.SerieR,
            TimbradoR = c.TimbradoR,
            VigenciaDelR = c.VigenciaDelR,
            VigenciaAlR = c.VigenciaAlR,
            NombreImpresoraR = c.NombreImpresoraR,
            BloquearFacturaR = c.BloquearFacturaR,
            Imprimir_remisionR = c.Imprimir_remisionR,
            // Nota de Crédito
            Nivel1NC = c.Nivel1NC,
            Nivel2NC = c.Nivel2NC,
            NumeroNC = c.NumeroNC,
            SerieNC = c.SerieNC,
            TimbradoNC = c.TimbradoNC,
            VigenciaDelNC = c.VigenciaDelNC,
            VigenciaAlNC = c.VigenciaAlNC,
            NombreImpresoraNC = c.NombreImpresoraNC,
            BloquearFacturaNC = c.BloquearFacturaNC,
            Imprimir_remisionNC = c.Imprimir_remisionNC,
            // Recibo
            Nivel1Recibo = c.Nivel1Recibo,
            Nivel2Recibo = c.Nivel2Recibo,
            NumeroRecibo = c.NumeroRecibo,
            SerieRecibo = c.SerieRecibo,
            TimbradoRecibo = c.TimbradoRecibo,
            VigenciaDelRecibo = c.VigenciaDelRecibo,
            VigenciaAlRecibo = c.VigenciaAlRecibo,
            NombreImpresoraRecibo = c.NombreImpresoraRecibo,
            BloquearFacturaRecibo = c.BloquearFacturaRecibo,
            Imprimir_remisionRecibo = c.Imprimir_remisionRecibo,
            // Comandas Restaurante
            ImpresoraComandaCocina = c.ImpresoraComandaCocina,
            ImpresoraComandaBarra = c.ImpresoraComandaBarra,
            PuertoImpresoraCocina = c.PuertoImpresoraCocina,
            PuertoImpresoraBarra = c.PuertoImpresoraBarra,
            ComandaCocinaEsRed = c.ComandaCocinaEsRed,
            ComandaBarraEsRed = c.ComandaBarraEsRed,
            ImprimirComandaAutomatica = c.ImprimirComandaAutomatica,
            CopiasComandaCocina = c.CopiasComandaCocina,
            CopiasComandaBarra = c.CopiasComandaBarra,
            // Comprobante Pedido (Cliente)
            ImpresoraComprobantePedido = c.ImpresoraComprobantePedido,
            PuertoImpresoraComprobante = c.PuertoImpresoraComprobante,
            ComprobanteEsRed = c.ComprobanteEsRed,
            ImprimirComprobantePedidoAuto = c.ImprimirComprobantePedidoAuto
        };
    }

    private async Task Guardar()
    {
        if (editando == null) return;
        try
        {
            await using var ctx = await DbFactory.CreateDbContextAsync();
            await EnsureColumnasCajaAsync(ctx);
            if (editando.IdCaja == 0)
            {
                ctx.Cajas.Add(editando);
            }
            else
            {
                // Cargar la entidad original y actualizar sus propiedades
                var cajaOriginal = await ctx.Cajas.FindAsync(editando.IdCaja);
                if (cajaOriginal != null)
                {
                    // Actualizar todas las propiedades
                    cajaOriginal.Nombre = editando.Nombre;
                    cajaOriginal.CantTurnos = editando.CantTurnos;
                    cajaOriginal.TurnoActual = editando.TurnoActual;
                    cajaOriginal.Nivel1 = editando.Nivel1;
                    cajaOriginal.Nivel2 = editando.Nivel2;
                    cajaOriginal.FacturaInicial = editando.FacturaInicial;
                    cajaOriginal.Serie = editando.Serie;
                    cajaOriginal.Timbrado = editando.Timbrado;
                    cajaOriginal.NombreImpresora = editando.NombreImpresora;
                    cajaOriginal.FechaActualCaja = editando.FechaActualCaja;
                    cajaOriginal.VigenciaDel = editando.VigenciaDel;
                    cajaOriginal.VigenciaAl = editando.VigenciaAl;
                    cajaOriginal.BloquearFactura = editando.BloquearFactura;
                    cajaOriginal.Imprimir_Factura = editando.Imprimir_Factura;
                    cajaOriginal.bloquear_fechaCaja = editando.bloquear_fechaCaja;
                    cajaOriginal.TipoFacturacion = editando.TipoFacturacion;
                    cajaOriginal.FormatoImpresion = editando.FormatoImpresion;
                    cajaOriginal.MostrarLogo = editando.MostrarLogo;
                    cajaOriginal.AnchoTicket = editando.AnchoTicket;
                    // Remisión
                    cajaOriginal.Nivel1R = editando.Nivel1R;
                    cajaOriginal.Nivel2R = editando.Nivel2R;
                    cajaOriginal.FacturaInicialR = editando.FacturaInicialR;
                    cajaOriginal.SerieR = editando.SerieR;
                    cajaOriginal.TimbradoR = editando.TimbradoR;
                    cajaOriginal.VigenciaDelR = editando.VigenciaDelR;
                    cajaOriginal.VigenciaAlR = editando.VigenciaAlR;
                    cajaOriginal.NombreImpresoraR = editando.NombreImpresoraR;
                    cajaOriginal.BloquearFacturaR = editando.BloquearFacturaR;
                    cajaOriginal.Imprimir_remisionR = editando.Imprimir_remisionR;
                    // Nota de Crédito
                    cajaOriginal.Nivel1NC = editando.Nivel1NC;
                    cajaOriginal.Nivel2NC = editando.Nivel2NC;
                    cajaOriginal.NumeroNC = editando.NumeroNC;
                    cajaOriginal.SerieNC = editando.SerieNC;
                    cajaOriginal.TimbradoNC = editando.TimbradoNC;
                    cajaOriginal.VigenciaDelNC = editando.VigenciaDelNC;
                    cajaOriginal.VigenciaAlNC = editando.VigenciaAlNC;
                    cajaOriginal.NombreImpresoraNC = editando.NombreImpresoraNC;
                    cajaOriginal.BloquearFacturaNC = editando.BloquearFacturaNC;
                    cajaOriginal.Imprimir_remisionNC = editando.Imprimir_remisionNC;
                    // Recibo
                    cajaOriginal.Nivel1Recibo = editando.Nivel1Recibo;
                    cajaOriginal.Nivel2Recibo = editando.Nivel2Recibo;
                    cajaOriginal.NumeroRecibo = editando.NumeroRecibo;
                    cajaOriginal.SerieRecibo = editando.SerieRecibo;
                    cajaOriginal.TimbradoRecibo = editando.TimbradoRecibo;
                    cajaOriginal.VigenciaDelRecibo = editando.VigenciaDelRecibo;
                    cajaOriginal.VigenciaAlRecibo = editando.VigenciaAlRecibo;
                    cajaOriginal.NombreImpresoraRecibo = editando.NombreImpresoraRecibo;
                    cajaOriginal.BloquearFacturaRecibo = editando.BloquearFacturaRecibo;
                    cajaOriginal.Imprimir_remisionRecibo = editando.Imprimir_remisionRecibo;
                    // Comandas Restaurante
                    cajaOriginal.ImpresoraComandaCocina = editando.ImpresoraComandaCocina;
                    cajaOriginal.ImpresoraComandaBarra = editando.ImpresoraComandaBarra;
                    cajaOriginal.PuertoImpresoraCocina = editando.PuertoImpresoraCocina;
                    cajaOriginal.PuertoImpresoraBarra = editando.PuertoImpresoraBarra;
                    cajaOriginal.ComandaCocinaEsRed = editando.ComandaCocinaEsRed;
                    cajaOriginal.ComandaBarraEsRed = editando.ComandaBarraEsRed;
                    cajaOriginal.ImprimirComandaAutomatica = editando.ImprimirComandaAutomatica;
                    cajaOriginal.CopiasComandaCocina = editando.CopiasComandaCocina;
                    cajaOriginal.CopiasComandaBarra = editando.CopiasComandaBarra;
                    // Comprobante Pedido (Cliente)
                    cajaOriginal.ImpresoraComprobantePedido = editando.ImpresoraComprobantePedido;
                    cajaOriginal.PuertoImpresoraComprobante = editando.PuertoImpresoraComprobante;
                    cajaOriginal.ComprobanteEsRed = editando.ComprobanteEsRed;
                    cajaOriginal.ImprimirComprobantePedidoAuto = editando.ImprimirComprobantePedidoAuto;
                }
            }
            await ctx.SaveChangesAsync();
            CajaService.LimpiarCache(); // Limpiar caché para que los cambios se reflejen inmediatamente
            editando = null;
            await Cargar();
        }
        catch (Exception ex)
        {
            error = ex.Message;
        }
    }

    private static async Task EnsureColumnasCajaAsync(SistemIA.Models.AppDbContext ctx)
    {
        var sql = @"
IF NOT EXISTS (SELECT 1 FROM sys.columns WHERE Name = N'CantTurnos' AND object_id = OBJECT_ID(N'Cajas'))
    ALTER TABLE Cajas ADD CantTurnos INT NULL;
IF NOT EXISTS (SELECT 1 FROM sys.columns WHERE Name = N'TurnoActual' AND object_id = OBJECT_ID(N'Cajas'))
    ALTER TABLE Cajas ADD TurnoActual INT NULL;
IF NOT EXISTS (SELECT 1 FROM sys.columns WHERE Name = N'FechaActualCaja' AND object_id = OBJECT_ID(N'Cajas'))
    ALTER TABLE Cajas ADD FechaActualCaja DATETIME NULL;
IF NOT EXISTS (SELECT 1 FROM sys.columns WHERE Name = N'bloquear_fechaCaja' AND object_id = OBJECT_ID(N'Cajas'))
    ALTER TABLE Cajas ADD bloquear_fechaCaja BIT NULL;
 IF NOT EXISTS (SELECT 1 FROM sys.columns WHERE Name = N'CajaActual' AND object_id = OBJECT_ID(N'Cajas'))
    ALTER TABLE Cajas ADD CajaActual INT NULL;";
        try { await ctx.Database.ExecuteSqlRawAsync(sql); } catch { }
    }

    private async Task EstablecerActual(int idCaja)
    {
        try
        {
            await using var ctx = await DbFactory.CreateDbContextAsync();
            await EnsureColumnasCajaAsync(ctx);
            // Poner 0 a todas y 1 a la seleccionada
            await ctx.Database.ExecuteSqlRawAsync("UPDATE Cajas SET CajaActual = 0;");
            await ctx.Database.ExecuteSqlRawAsync("UPDATE Cajas SET CajaActual = 1 WHERE id_caja = {0};", idCaja);
            CajaService.LimpiarCache(); // Limpiar caché para que los cambios se reflejen inmediatamente
            await Cargar();
        }
        catch (Exception ex) { error = ex.Message; }
    }

    private void Cancelar() => editando = null;
    
    // ========== MÉTODOS PARA PRUEBA DE IMPRESORAS DE COMANDAS ==========
    
    private async Task ProbarImpresoraCocina()
    {
        if (editando == null || string.IsNullOrEmpty(editando.ImpresoraComandaCocina)) return;
        
        _probandoCocina = true;
        _resultadoPruebaCocina = null;
        StateHasChanged();
        
        try
        {
            if (ComandaCocinaEsRedChecked)
            {
                var resultado = await ComandaService.ProbarConexionAsync(
                    editando.ImpresoraComandaCocina, 
                    editando.PuertoImpresoraCocina ?? 9100);
                _exitoPruebaCocina = resultado.Exitoso;
                _resultadoPruebaCocina = resultado.Mensaje;
            }
            else
            {
                // Verificar si existe la impresora en Windows
                var impresoras = System.Drawing.Printing.PrinterSettings.InstalledPrinters;
                var existe = false;
                foreach (string imp in impresoras)
                {
                    if (imp.Equals(editando.ImpresoraComandaCocina, StringComparison.OrdinalIgnoreCase))
                    {
                        existe = true;
                        break;
                    }
                }
                _exitoPruebaCocina = existe;
                _resultadoPruebaCocina = existe ? "Impresora encontrada" : "Impresora no encontrada en el sistema";
            }
        }
        catch (Exception ex)
        {
            _exitoPruebaCocina = false;
            _resultadoPruebaCocina = ex.Message;
        }
        finally
        {
            _probandoCocina = false;
            StateHasChanged();
        }
    }
    
    private async Task ProbarImpresoraBarra()
    {
        if (editando == null || string.IsNullOrEmpty(editando.ImpresoraComandaBarra)) return;
        
        _probandoBarra = true;
        _resultadoPruebaBarra = null;
        StateHasChanged();
        
        try
        {
            if (ComandaBarraEsRedChecked)
            {
                var resultado = await ComandaService.ProbarConexionAsync(
                    editando.ImpresoraComandaBarra, 
                    editando.PuertoImpresoraBarra ?? 9100);
                _exitoPruebaBarra = resultado.Exitoso;
                _resultadoPruebaBarra = resultado.Mensaje;
            }
            else
            {
                var impresoras = System.Drawing.Printing.PrinterSettings.InstalledPrinters;
                var existe = false;
                foreach (string imp in impresoras)
                {
                    if (imp.Equals(editando.ImpresoraComandaBarra, StringComparison.OrdinalIgnoreCase))
                    {
                        existe = true;
                        break;
                    }
                }
                _exitoPruebaBarra = existe;
                _resultadoPruebaBarra = existe ? "Impresora encontrada" : "Impresora no encontrada en el sistema";
            }
        }
        catch (Exception ex)
        {
            _exitoPruebaBarra = false;
            _resultadoPruebaBarra = ex.Message;
        }
        finally
        {
            _probandoBarra = false;
            StateHasChanged();
        }
    }
    
    private async Task ImprimirPruebaCocina()
    {
        if (editando == null) return;
        
        _imprimiendoPruebaCocina = true;
        StateHasChanged();
        
        try
        {
            var resultado = await ComandaService.ImprimirPruebaAsync(editando, "COCINA");
            _exitoPruebaCocina = resultado.Exitoso;
            _resultadoPruebaCocina = resultado.Mensaje;
        }
        catch (Exception ex)
        {
            _exitoPruebaCocina = false;
            _resultadoPruebaCocina = ex.Message;
        }
        finally
        {
            _imprimiendoPruebaCocina = false;
            StateHasChanged();
        }
    }
    
    private async Task ImprimirPruebaBarra()
    {
        if (editando == null) return;
        
        _imprimiendoPruebaBarra = true;
        StateHasChanged();
        
        try
        {
            var resultado = await ComandaService.ImprimirPruebaAsync(editando, "BARRA");
            _exitoPruebaBarra = resultado.Exitoso;
            _resultadoPruebaBarra = resultado.Mensaje;
        }
        catch (Exception ex)
        {
            _exitoPruebaBarra = false;
            _resultadoPruebaBarra = ex.Message;
        }
        finally
        {
            _imprimiendoPruebaBarra = false;
            StateHasChanged();
        }
    }
    
    // ========== MÉTODOS PARA IMPRESORA COMPROBANTE PEDIDO ==========
    
    private async Task ProbarImpresoraComprobante()
    {
        if (editando == null || string.IsNullOrEmpty(editando.ImpresoraComprobantePedido)) return;
        
        _probandoComprobante = true;
        _resultadoPruebaComprobante = null;
        StateHasChanged();
        
        try
        {
            if (ComprobanteEsRedChecked)
            {
                var resultado = await ComandaService.ProbarConexionAsync(
                    editando.ImpresoraComprobantePedido, 
                    editando.PuertoImpresoraComprobante ?? 9100);
                _exitoPruebaComprobante = resultado.Exitoso;
                _resultadoPruebaComprobante = resultado.Mensaje;
            }
            else
            {
                var impresoras = System.Drawing.Printing.PrinterSettings.InstalledPrinters;
                var existe = false;
                foreach (string imp in impresoras)
                {
                    if (imp.Equals(editando.ImpresoraComprobantePedido, StringComparison.OrdinalIgnoreCase))
                    {
                        existe = true;
                        break;
                    }
                }
                _exitoPruebaComprobante = existe;
                _resultadoPruebaComprobante = existe ? "Impresora encontrada" : "Impresora no encontrada en el sistema";
            }
        }
        catch (Exception ex)
        {
            _exitoPruebaComprobante = false;
            _resultadoPruebaComprobante = ex.Message;
        }
        finally
        {
            _probandoComprobante = false;
            StateHasChanged();
        }
    }
    
    private async Task ImprimirPruebaComprobante()
    {
        if (editando == null || string.IsNullOrEmpty(editando.ImpresoraComprobantePedido)) return;
        
        _imprimiendoPruebaComprobante = true;
        StateHasChanged();
        
        try
        {
            // Crear datos de prueba para ticket de pedido
            var datosPrueba = new SistemIA.Services.DatosPedidoTicket
            {
                NombreEmpresa = "RESTAURANTE DEMO",
                DireccionEmpresa = "Av. Principal 123",
                TelefonoEmpresa = "(021) 555-1234",
                NumeroPedido = 1,
                NombreMesa = "MESA 5",
                NombreMesero = "Juan Pérez",
                FechaPedido = DateTime.Now,
                CantidadComensales = 2,
                Items = new List<SistemIA.Services.ItemPedidoTicket>
                {
                    new() { Descripcion = "HAMBURGUESA COMPLETA", Cantidad = 2, PrecioUnitario = 45000, Subtotal = 90000, Modificadores = "Sin cebolla, extra queso" },
                    new() { Descripcion = "PAPAS FRITAS GRANDES", Cantidad = 1, PrecioUnitario = 25000, Subtotal = 25000 },
                    new() { Descripcion = "COCA COLA 500ML", Cantidad = 2, PrecioUnitario = 15000, Subtotal = 30000 }
                },
                Subtotal = 145000,
                Total = 145000,
                MostrarPrecios = true,
                MensajePie = "¡Gracias por su pedido!"
            };
            
            var resultado = await ImpresionDirectaService.ImprimirTicketPedido80mm(
                datosPrueba,
                editando.ImpresoraComprobantePedido);
            
            _exitoPruebaComprobante = resultado.Exitoso;
            _resultadoPruebaComprobante = resultado.Mensaje;
        }
        catch (Exception ex)
        {
            _exitoPruebaComprobante = false;
            _resultadoPruebaComprobante = ex.Message;
        }
        finally
        {
            _imprimiendoPruebaComprobante = false;
            StateHasChanged();
        }
    }
}
