@page "/inventario/movimientos"
@using SistemIA.Models
@using Microsoft.EntityFrameworkCore
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize]
@inject IDbContextFactory<AppDbContext> DbFactory
@inject SistemIA.Services.IInventarioService Inventario
@inject SistemIA.Services.ICajaProvider CajaProvider
@inject SistemIA.Services.ICajaService CajaService
@inject SistemIA.Services.ISucursalProvider SucursalProvider
@inject NavigationManager Nav

<PageProtection Modulo="/inventario/movimientos" Permiso="VIEW">

<h3 class="mb-1">Registrar Movimiento de Inventario</h3>
<p class="text-muted mb-3">Use esta sección para registrar entradas y salidas de productos por depósito.</p>

@if (!string.IsNullOrEmpty(errorMsg))
{
    <div class="alert alert-danger py-2">@errorMsg</div>
}
@if (!string.IsNullOrEmpty(okMsg))
{
    <div class="alert alert-success py-2">@okMsg</div>
}

<div class="card mb-3">
  <div class="card-header d-flex justify-content-between align-items-center">
    <span>Registrar movimiento</span>
    <a href="/informes/movimientos-productos" class="btn btn-sm btn-outline-primary">
      <i class="bi bi-clipboard-data me-1"></i>Ver Informe Detallado
    </a>
  </div>
  <div class="card-body">
    <div class="row g-3 align-items-end">
      <div class="col-md-4">
        <label class="form-label">Producto</label>
        <select class="form-select" @bind="SelectedProductoId">
          <option value="0">-- Seleccione un producto --</option>
          @if(productos is not null)
          {
              @foreach(var p in productos)
              {
                  <option value="@p.IdProducto">@p.Descripcion (@p.CodigoInterno)</option>
              }
          }
        </select>
      </div>
      <div class="col-md-3">
        <label class="form-label">Depósito</label>
        <select class="form-select" @bind="SelectedDepositoId" disabled="@(depositos is null || !depositos.Any())">
          <option value="0">-- Seleccione un depósito --</option>
          @if(depositos is not null)
          {
              @foreach(var d in depositos)
              {
                  <option value="@d.IdDeposito">@d.Nombre (@d.IdSucursal)</option>
              }
          }
        </select>
        @if(depositos is not null && !depositos.Any())
        {
            <small class="text-muted">No hay depósitos. Cree uno en Configuración → Depósitos.</small>
        }
      </div>
      <div class="col-md-2">
        <label class="form-label">Tipo</label>
        <select class="form-select" @bind="tipo">
          <option value="1">Entrada</option>
          <option value="2">Salida</option>
        </select>
      </div>
      <div class="col-md-2">
        <label class="form-label">Cantidad</label>
        <input class="form-control" type="number" step="0.0001" @bind="cantidad" />
      </div>
      <div class="col-md-6">
        <label class="form-label">Motivo</label>
        <input class="form-control" @bind="motivo" placeholder="Ej: Compra, Ajuste, Devolución..." />
      </div>
      <div class="col-md-3 d-flex align-items-center">
        <div>
          <div class="small text-muted">Stock actual en depósito:</div>
          <div class="fw-semibold">@((stockActual.HasValue)? stockActual.Value.ToString("N4") : "-")</div>
        </div>
      </div>
      <div class="col-md-3 text-end">
        <button class="btn btn-success" @onclick="Registrar" disabled="@(selectedProductoId==0 || selectedDepositoId==0 || cantidad<=0)">Registrar</button>
      </div>
    </div>
  </div>
  <div class="card-footer small text-muted">Consejo: una Entrada suma stock; una Salida descuenta stock en el depósito seleccionado.</div>
</div>

<div class="d-flex justify-content-between align-items-center mt-4 mb-2">
  <h5 class="mb-0">Últimos 20 movimientos</h5>
  <a href="/informes/movimientos-productos" class="btn btn-outline-secondary btn-sm">
    <i class="bi bi-arrow-right me-1"></i>Ver todos los movimientos
  </a>
</div>

<table class="table table-sm table-striped">
  <thead>
    <tr>
      <th>Fecha</th>
      <th>Producto</th>
      <th>Depósito</th>
      <th class="text-center">Tipo</th>
      <th class="text-end">Cantidad</th>
      <th class="text-end">Saldo</th>
      <th>Usuario</th>
      <th>Motivo</th>
    </tr>
  </thead>
  <tbody>
    @if(movs is null)
    {
        <tr><td colspan="8">Cargando...</td></tr>
    }
    else if(!movs.Any())
    {
        <tr><td colspan="8">Sin movimientos</td></tr>
    }
    else
    {
        @foreach(var m in movs)
        {
            var esEntrada = m.Tipo == 1;
            <tr>
              <td>@m.Fecha.ToString("dd/MM/yyyy HH:mm")</td>
              <td>@(m.Producto?.Descripcion ?? m.IdProducto.ToString())</td>
              <td>@(m.Deposito?.Nombre ?? m.IdDeposito.ToString())</td>
              <td class="text-center">
                <span class="badge @(esEntrada ? "bg-success" : "bg-danger")">
                  @(esEntrada ? "Entrada" : "Salida")
                </span>
              </td>
              <td class="text-end @(esEntrada ? "text-success" : "text-danger")">
                @(esEntrada ? "+" : "-")@m.Cantidad.ToString("N4")
              </td>
              <td class="text-end fw-semibold">@(m.SaldoPosterior?.ToString("N4") ?? "—")</td>
              <td>@m.Usuario</td>
              <td>@m.Motivo</td>
            </tr>
        }
    }
  </tbody>
</table>

</PageProtection>

@code{
  private List<MovimientoInventario>? movs;
  private List<Producto>? productos;
  private List<Deposito>? depositos;
  private int selectedProductoId;
  private int selectedDepositoId;
  private int? _sucursalId;
  private Caja? _cajaActiva;

  private int SelectedProductoId
  {
    get => selectedProductoId;
    set
    {
      if (selectedProductoId != value)
      {
        selectedProductoId = value;
        try
        {
          var prod = productos?.FirstOrDefault(p => p.IdProducto == selectedProductoId);
          var depId = prod?.IdDepositoPredeterminado;
          if (depId.HasValue && depId.Value > 0 && (depositos?.Any(d => d.IdDeposito == depId.Value) ?? false))
          {
            SelectedDepositoId = depId.Value;
          }
        }
        catch { }
        _ = InvokeAsync(async () => await ActualizarStockActual());
      }
    }
  }
  
  private int SelectedDepositoId
  {
    get => selectedDepositoId;
    set
    {
      if (selectedDepositoId != value)
      {
        selectedDepositoId = value;
        _ = InvokeAsync(async () => await ActualizarStockActual());
      }
    }
  }
  
  private int tipo = 1;
  private decimal cantidad = 1;
  private string? motivo;
  private string? errorMsg;
  private string? okMsg;
  private decimal? stockActual;

  protected override async Task OnInitializedAsync()
  {
    _sucursalId = SucursalProvider.GetSucursalId();
    await CargarCombos();
    await CargarMovimientos();
    await CargarCajaActiva();
  }

  private async Task CargarCajaActiva()
  {
    // Primero intentar obtener del CajaProvider (claim del usuario)
    var cajaId = CajaProvider.GetCajaId();
    if (cajaId.HasValue)
    {
      await using var ctx = await DbFactory.CreateDbContextAsync();
      _cajaActiva = await ctx.Cajas.AsNoTracking().FirstOrDefaultAsync(c => c.IdCaja == cajaId.Value);
    }
    
    // Si no hay caja en el provider, usar CajaService como respaldo
    if (_cajaActiva == null)
    {
      _cajaActiva = await CajaService.ObtenerCajaActualAsync();
    }
  }

  private async Task CargarCombos()
  {
    await using var ctx = await DbFactory.CreateDbContextAsync();
    productos = await ctx.Productos.AsNoTracking()
      .Where(p => p.Activo)
      .OrderBy(p=>p.Descripcion)
      .Take(500)
      .ToListAsync();
    depositos = await ctx.Depositos.AsNoTracking()
      .Where(d => d.Activo)
      .OrderBy(d=>d.IdSucursal).ThenBy(d=>d.Nombre)
      .ToListAsync();
  }

  private async Task CargarMovimientos()
  {
    await using var ctx = await DbFactory.CreateDbContextAsync();
    movs = await ctx.MovimientosInventario.AsNoTracking()
      .Include(m=>m.Producto)
      .Include(m=>m.Deposito)
      .OrderByDescending(m=>m.Fecha)
      .Take(20)
      .ToListAsync();
  }

  private async Task ActualizarStockActual()
  {
    if (selectedProductoId == 0 || selectedDepositoId == 0)
    {
      stockActual = null;
      return;
    }
    try
    {
      stockActual = await Inventario.ObtenerStockAsync(selectedProductoId, selectedDepositoId);
    }
    catch { stockActual = null; }
    StateHasChanged();
  }

  private async Task Registrar()
  {
    errorMsg = okMsg = null;
    if (selectedProductoId == 0) { errorMsg = "Seleccione un producto"; return; }
    if (selectedDepositoId == 0) { errorMsg = "Seleccione un depósito"; return; }
    if (cantidad <= 0) { errorMsg = "La cantidad debe ser mayor a cero"; return; }

    try
    {
      // Obtener datos de contexto
      var dep = depositos?.FirstOrDefault(d => d.IdDeposito == selectedDepositoId);
      var sucursalId = _sucursalId ?? dep?.IdSucursal;
      var fechaCaja = _cajaActiva?.FechaActualCaja?.Date;
      var turno = _cajaActiva?.TurnoActual;
      var idCaja = _cajaActiva?.IdCaja;

      await Inventario.AjustarStockAsync(
        selectedProductoId, 
        selectedDepositoId, 
        cantidad, 
        tipo, 
        motivo, 
        "admin",
        sucursalId,
        idCaja,
        fechaCaja,
        turno);

      okMsg = tipo == 1 
        ? $"Entrada de {cantidad:N4} registrada correctamente" 
        : $"Salida de {cantidad:N4} registrada correctamente";
      
      // Recargar datos
      await CargarMovimientos();
      await ActualizarStockActual();
      
      // Limpiar campos
      cantidad = 1;
      motivo = null;
    }
    catch (Exception ex)
    {
      errorMsg = ex.Message;
    }
  }
}
