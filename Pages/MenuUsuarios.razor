@page "/menu-usuarios"
@using SistemIA.Models
@using Microsoft.EntityFrameworkCore
@using Microsoft.Data.SqlClient
@inject IDbContextFactory<SistemIA.Models.AppDbContext> DbFactory
@inject NavigationManager Navigation
@inject IConfiguration Configuration

<PageProtection Modulo="/personal" Permiso="VIEW">

<h3 class="mb-4">👤 Usuarios del Sistema</h3>

@if (!string.IsNullOrEmpty(errorMessage))
{
    <div class="alert alert-danger">@errorMessage</div>
}
else if (usuarios is null)
{
    <p><em>Cargando...</em></p>
}
else
{
    <div class="mb-3 d-flex justify-content-end">
        <button class="btn btn-success" @onclick="RegistrarUsuario">
            <i class="bi bi-person-plus"></i> Registrar Usuario
        </button>
    </div>
    <table class="table table-striped table-hover align-middle usuarios-table">
        <thead class="table-dark">
            <tr>
                <th>Id</th>
                <th>Nombres</th>
                <th>Apellidos</th>
                <th>Correo</th>
                <th>Usuario</th>
                <th>Rol</th>
                <th>Estado</th>
                <th class="text-center">Opciones</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var u in usuarios)
            {
                <tr>
                    <td>@u.Id_Usu</td>
                    <td class="col-nombres">@u.Nombres</td>
                    <td class="col-apellidos">@u.Apellidos</td>
                    <td class="col-correo">@u.Correo</td>
                    <td class="col-usuario">@u.UsuarioNombre</td>
                    <td class="col-rol">@u.Rol?.NombreRol</td>
                    <td>
                        @if (u.Estado_Usu)
                        {
                            <span class="badge bg-success">Activo</span>
                        }
                        else
                        {
                            <span class="badge bg-secondary">Inactivo</span>
                        }
                    </td>
                    <td class="text-center">
                        <button class="btn btn-sm btn-outline-primary me-1" @onclick="() => EditarUsuario(u.Id_Usu)">
                            <i class="bi bi-pencil"></i> Editar
                        </button>
                        <button class="btn btn-sm btn-outline-danger" @onclick="() => MostrarModalEliminar(u)">
                            <i class="bi bi-trash"></i> Eliminar
                        </button>
                    </td>
                </tr>
            }
        </tbody>
    </table>

    <!-- Paginación simple -->
    <div class="d-flex justify-content-between mt-3">
        <button class="btn btn-secondary" @onclick="PaginaAnterior" disabled="@(!puedeRetroceder)">
            ◀ Anterior
        </button>
        <span>Página @paginaActual de @totalPaginas</span>
        <button class="btn btn-secondary" @onclick="PaginaSiguiente" disabled="@(!puedeAvanzar)">
            Siguiente ▶
        </button>
    </div>
}

<!-- Modal de confirmación para eliminar usuario -->
@if (_mostrarModalEliminar)
{
    <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title"><i class="bi bi-exclamation-triangle me-2"></i>Confirmar Eliminación</h5>
                    <button type="button" class="btn-close btn-close-white" @onclick="CerrarModalEliminar"></button>
                </div>
                <div class="modal-body">
                    @if (!string.IsNullOrEmpty(_mensajeModal))
                    {
                        <div class="alert @(_exitoModal ? "alert-success" : "alert-danger")">
                            @_mensajeModal
                        </div>
                    }
                    
                    <div class="alert alert-warning">
                        <i class="bi bi-shield-lock me-2"></i>
                        <strong>Acción protegida:</strong> Se requiere la contraseña del usuario SA de SQL Server.
                    </div>
                    
                    <p>¿Está seguro que desea eliminar al usuario:</p>
                    <div class="card bg-light mb-3">
                        <div class="card-body py-2">
                            <strong>@_usuarioAEliminar?.Nombres @_usuarioAEliminar?.Apellidos</strong><br/>
                            <small class="text-muted">Usuario: @_usuarioAEliminar?.UsuarioNombre | Rol: @_usuarioAEliminar?.Rol?.NombreRol</small>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label"><strong>Contraseña SA:</strong></label>
                        <input type="password" class="form-control" @bind="_contrasenaSA" 
                               placeholder="Ingrese la contraseña del usuario SA" />
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="CerrarModalEliminar" disabled="@_eliminando">
                        Cancelar
                    </button>
                    <button type="button" class="btn btn-danger" @onclick="EliminarUsuario" 
                            disabled="@(string.IsNullOrEmpty(_contrasenaSA) || _eliminando)">
                        @if (_eliminando)
                        {
                            <span class="spinner-border spinner-border-sm me-2"></span>
                            <span>Eliminando...</span>
                        }
                        else
                        {
                            <i class="bi bi-trash me-2"></i>
                            <span>Eliminar Usuario</span>
                        }
                    </button>
                </div>
            </div>
        </div>
    </div>
}

</PageProtection>

@code {
    private List<Usuario>? usuarios;
    private string? errorMessage;

    private int paginaActual = 1;
    private int tamanioPagina = 15;
    private int totalRegistros = 0;
    private int totalPaginas = 1;

    private bool puedeAvanzar => paginaActual < totalPaginas;
    private bool puedeRetroceder => paginaActual > 1;

    // Variables para el modal de eliminar
    private bool _mostrarModalEliminar = false;
    private Usuario? _usuarioAEliminar;
    private string _contrasenaSA = "";
    private string? _mensajeModal;
    private bool _exitoModal = false;
    private bool _eliminando = false;

    protected override async Task OnInitializedAsync()
    {
        await CargarUsuariosAsync();
    }

    private async Task CargarUsuariosAsync()
    {
        await using var Db = await DbFactory.CreateDbContextAsync();
        try
        {
            totalRegistros = await Db.Usuarios.CountAsync();
            totalPaginas = (int)Math.Ceiling(totalRegistros / (double)tamanioPagina);

            usuarios = await Db.Usuarios
                .Include(u => u.Rol)
                .OrderBy(u => u.Nombres)
                .Skip((paginaActual - 1) * tamanioPagina)
                .Take(tamanioPagina)
                .ToListAsync();
        }
        catch (Exception ex)
        {
            errorMessage = "No se pudo cargar la lista de usuarios.";
            Console.WriteLine($"[ERROR] {ex.Message}");
        }
    }

    private async Task PaginaSiguiente()
    {
        if (puedeAvanzar)
        {
            paginaActual++;
            await CargarUsuariosAsync();
            StateHasChanged();
        }
    }

    private async Task PaginaAnterior()
    {
        if (puedeRetroceder)
        {
            paginaActual--;
            await CargarUsuariosAsync();
            StateHasChanged();
        }
    }

    private void RegistrarUsuario()
    {
        Navigation.NavigateTo("/Usuarios/CrearUsuario");
    }

    private void EditarUsuario(int id)
    {
        Navigation.NavigateTo($"/usuarios/editarUsu/{id}");
    }

    private void MostrarModalEliminar(Usuario usuario)
    {
        _usuarioAEliminar = usuario;
        _contrasenaSA = "";
        _mensajeModal = null;
        _exitoModal = false;
        _mostrarModalEliminar = true;
    }

    private void CerrarModalEliminar()
    {
        _mostrarModalEliminar = false;
        _usuarioAEliminar = null;
        _contrasenaSA = "";
        _mensajeModal = null;
        _exitoModal = false;
    }

    private async Task EliminarUsuario()
    {
        if (_usuarioAEliminar == null || string.IsNullOrEmpty(_contrasenaSA))
            return;

        _eliminando = true;
        _mensajeModal = null;
        StateHasChanged();

        try
        {
            // Validar credenciales SA conectándose a SQL Server
            var connectionString = Configuration.GetConnectionString("DefaultConnection");
            if (string.IsNullOrEmpty(connectionString))
            {
                _mensajeModal = "No se encontró la cadena de conexión";
                _exitoModal = false;
                return;
            }

            var builder = new SqlConnectionStringBuilder(connectionString);
            var servidor = builder.DataSource;
            var baseDatos = builder.InitialCatalog;

            // Crear conexión con credenciales SA proporcionadas
            var testConnectionString = $"Server={servidor};Database={baseDatos};User Id=sa;Password={_contrasenaSA};TrustServerCertificate=True;";
            
            try
            {
                using var testConnection = new SqlConnection(testConnectionString);
                await testConnection.OpenAsync();
                // Credenciales válidas - proceder con la eliminación
            }
            catch (SqlException)
            {
                _mensajeModal = "Contraseña SA incorrecta. Acceso denegado.";
                _exitoModal = false;
                return;
            }

            // Eliminar usuario de la base de datos
            await using var db = await DbFactory.CreateDbContextAsync();
            
            // Primero eliminar asignaciones de horario del usuario
            var asignaciones = await db.AsignacionesHorarios
                .Where(a => a.Id_Usuario == _usuarioAEliminar.Id_Usu)
                .ToListAsync();
            
            if (asignaciones.Any())
            {
                db.AsignacionesHorarios.RemoveRange(asignaciones);
            }

            // Luego eliminar el usuario
            var usuario = await db.Usuarios.FindAsync(_usuarioAEliminar.Id_Usu);
            if (usuario != null)
            {
                db.Usuarios.Remove(usuario);
                await db.SaveChangesAsync();

                _mensajeModal = $"Usuario '{_usuarioAEliminar.UsuarioNombre}' eliminado correctamente.";
                _exitoModal = true;
                
                // Recargar lista después de un breve delay
                await Task.Delay(1500);
                CerrarModalEliminar();
                await CargarUsuariosAsync();
            }
            else
            {
                _mensajeModal = "Usuario no encontrado.";
                _exitoModal = false;
            }
        }
        catch (Exception ex)
        {
            _mensajeModal = $"Error al eliminar: {ex.Message}";
            _exitoModal = false;
            Console.WriteLine($"[ERROR] Eliminar usuario: {ex}");
        }
        finally
        {
            _eliminando = false;
            StateHasChanged();
        }
    }
}
