@page "/inventario/ajustes/explorar"
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize]
@using Microsoft.EntityFrameworkCore
@inject IDbContextFactory<SistemIA.Models.AppDbContext> DbFactory
@inject Microsoft.JSInterop.IJSRuntime JS

<PageProtection Modulo="/inventario" Permiso="VIEW">

<h3 class="mb-3">Ajustes de Stock — Exploración</h3>

<div class="card mb-3">
  <div class="card-body">
    <div class="row g-3">
      <div class="col-md-3">
        <label class="form-label">Desde</label>
        <input class="form-control" type="date" @bind-value="desde" />
      </div>
      <div class="col-md-3">
        <label class="form-label">Hasta</label>
        <input class="form-control" type="date" @bind-value="hasta" />
      </div>
      <div class="col-md-3">
        <label class="form-label">Usuario</label>
        <input class="form-control" @bind="usuarioFiltro" />
      </div>
      <div class="col-md-3 d-flex align-items-end justify-content-end">
        <button class="btn btn-primary" @onclick="Cargar">Filtrar</button>
      </div>
    </div>
  </div>
</div>

<div class="table-responsive">
  <table class="table table-sm table-hover">
    <thead>
      <tr>
        <th>#</th>
        <th>Fecha</th>
        <th>Sucursal</th>
        <th>Usuario</th>
        <th class="text-end">Monto total</th>
        <th></th>
      </tr>
    </thead>
    <tbody>
      @if (cabeceras is null)
      {
        <tr><td colspan="6">Cargando…</td></tr>
      }
      else if (!cabeceras.Any())
      {
        <tr><td colspan="6">Sin resultados</td></tr>
      }
      else
      {
        foreach (var a in cabeceras)
        {
          <tr>
            <td>@a.IdAjusteStock</td>
            <td>@a.FechaAjuste.ToString("dd/MM/yyyy HH:mm")</td>
            <td>@a.IdSucursal</td>
            <td>@a.Usuario</td>
            <td class="text-end">@a.TotalMonto.ToString("N0")</td>
            <td class="text-end">
              <button class="btn btn-sm btn-outline-secondary" @onclick="(()=>Imprimir(a.IdAjusteStock))"><i class="bi bi-printer"></i></button>
            </td>
          </tr>
        }
      }
    </tbody>
  </table>
</div>

</PageProtection>

@code {
  private DateTime? desde = DateTime.Today.AddDays(-7);
  private DateTime? hasta = DateTime.Today;
  private string? usuarioFiltro;
  private List<SistemIA.Models.AjusteStock>? cabeceras;

  protected override async Task OnInitializedAsync() => await Cargar();

  private async Task Cargar()
  {
    await using var ctx = await DbFactory.CreateDbContextAsync();
    var q = ctx.AjustesStock.AsNoTracking().AsQueryable();
    if (desde.HasValue) q = q.Where(a => a.FechaAjuste >= desde.Value);
    if (hasta.HasValue) q = q.Where(a => a.FechaAjuste < hasta.Value.AddDays(1));
    if (!string.IsNullOrWhiteSpace(usuarioFiltro)) q = q.Where(a => a.Usuario.Contains(usuarioFiltro));
    cabeceras = await q.OrderByDescending(a => a.FechaAjuste).Take(200).ToListAsync();
  }

  private async Task Imprimir(int id)
  {
    await using var ctx = await DbFactory.CreateDbContextAsync();
    var cab = await ctx.AjustesStock.AsNoTracking().FirstOrDefaultAsync(a => a.IdAjusteStock == id);
    if (cab == null) return;
    var dets = await ctx.AjustesStockDetalles.AsNoTracking()
      .Include(d => d.Producto)
      .Include(d => d.Deposito)
      .Where(d => d.IdAjusteStock == id)
      .ToListAsync();

    // Estilos tipo "Compras"
    var head = new System.Text.StringBuilder();
    head.AppendLine("<meta charset=\"utf-8\"/>");
    head.AppendLine("<title>Ajuste de Stock</title>");
    head.AppendLine("<link rel=\"stylesheet\" href=\"/css/bootstrap/bootstrap.min.css\" />");
    head.AppendLine("<style>");
    head.AppendLine("@media print { @page { size: A4; margin: 14mm 12mm; } }");
    head.AppendLine("body{font-size:12px;color:#111;}");
    head.AppendLine(".factura-header{display:flex;align-items:center;gap:16px;border-bottom:2px solid #222;padding-bottom:8px;margin-bottom:12px;}");
    head.AppendLine(".factura-header .logo{max-width:120px;max-height:60px;object-fit:contain;display:block;border-radius:6px;border:1px solid #e5e7eb;background:#fff;padding:6px;}");
    head.AppendLine(".factura-header .logo-wrap{width:140px;display:flex;align-items:center;justify-content:center;}");
    head.AppendLine(".factura-header .empresa h2{margin:0;font-size:18px;}");
    head.AppendLine(".factura-header .empresa .small{color:#555;}");
    head.AppendLine(".table-ajuste th,.table-ajuste td{padding:.4rem;border-bottom:1px solid #e5e7eb;vertical-align:top;}");
    head.AppendLine(".footer{position:fixed;bottom:8mm;left:0;right:0;text-align:center;font-size:10px;color:#666;}");
    head.AppendLine("</style>");

    // Datos sucursal para cabecera/logo
  await using var ctxImp = await DbFactory.CreateDbContextAsync();
  var suc = await ctxImp.Sucursal.AsNoTracking().FirstOrDefaultAsync(s => s.Id == cab.IdSucursal);
    string empresa = suc?.NombreEmpresa ?? "Empresa";
    string sucursal = suc?.NombreSucursal ?? $"Suc. {cab.IdSucursal}";
    string ruc = suc != null ? $"{suc.RUC}-{suc.DV}" : "";
    string? logoDataUri = null;
    if (suc?.Logo != null && suc.Logo.Length > 0)
    {
      var b64 = Convert.ToBase64String(suc.Logo);
      logoDataUri = $"data:image/png;base64,{b64}";
    }

    var rows = string.Join("", dets.Select(l => $"<tr><td>{Escape(l.Producto?.CodigoInterno)}</td><td>{Escape(l.Producto?.Descripcion)}</td><td>{Escape(l.Deposito?.Nombre)}</td><td class='right'>{l.StockSistema:N2}</td><td class='right'>{l.StockAjuste:N2}</td><td class='right'>{l.Diferencia:N2}</td><td class='right'>{(l.Producto?.PrecioUnitarioGs ?? 0):N0}</td><td class='right'>{l.Monto:N0}</td></tr>"));
    var comentarioHtml = string.IsNullOrWhiteSpace(cab.Comentario) ? string.Empty : $"<div class='muted'>Comentario: {Escape(cab.Comentario!)}" + "</div>";
    var sb = new System.Text.StringBuilder();
    sb.AppendLine("<div class=\"container-fluid\">");
    sb.AppendLine("  <div class=\"factura-header\">");
    sb.AppendLine("    <div class=\"logo-wrap\">");
    if (!string.IsNullOrEmpty(logoDataUri)) sb.AppendLine($"      <img class=\"logo\" src=\"{logoDataUri}\" alt=\"Logo\"/>");
    else sb.AppendLine("      <div class=\"logo d-flex align-items-center justify-content-center\" style=\"font-size:10px;color:#999;min-height:40px;min-width:100px;\">LOGO</div>");
    sb.AppendLine("    </div>");
    sb.AppendLine("    <div class=\"empresa\">");
    sb.AppendLine($"      <h2>{empresa}</h2>");
    sb.AppendLine($"      <div class=\"small\">RUC: {ruc}</div>");
    sb.AppendLine($"      <div class=\"small\">{sucursal}</div>");
    sb.AppendLine("    </div>");
    sb.AppendLine("    <div class=\"ms-auto text-end\">");
    sb.AppendLine("      <div class=\"fw-bold\" style=\"font-size:18px\">Ajuste de Stock</div>");
    sb.AppendLine($"      <div>N°: {cab.IdAjusteStock}</div>");
    sb.AppendLine($"      <div>Fecha: {cab.FechaAjuste:dd/MM/yyyy HH:mm}</div>");
    sb.AppendLine($"      <div>Usuario: {Escape(cab.Usuario)}</div>");
    sb.AppendLine("    </div>");
    sb.AppendLine("  </div>");
    if (!string.IsNullOrEmpty(comentarioHtml)) sb.AppendLine($"  {comentarioHtml}");
    sb.AppendLine("  <table class=\"table table-sm table-ajuste\">");
    sb.AppendLine("    <thead><tr><th>Código</th><th>Descripción</th><th>Depósito</th><th class='right'>Stock sistema</th><th class='right'>Stock ajuste</th><th class='right'>Diferencia</th><th class='right'>Precio</th><th class='right'>Monto</th></tr></thead>");
    sb.AppendLine($"    <tbody>{rows}</tbody>");
    sb.AppendLine($"    <tfoot><tr><th colspan='7' class='right'>Total</th><th class='right'>{cab.TotalMonto:N0}</th></tr></tfoot>");
    sb.AppendLine("  </table>");
    sb.AppendLine("  <div class=\"footer\">** Ajuste generado por el sistema **</div>");
    sb.AppendLine("</div>");
    await JS.InvokeVoidAsync("printHtmlWithHead", head.ToString(), sb.ToString());
  }

  private static string Escape(string? s) => System.Net.WebUtility.HtmlEncode(s ?? string.Empty);
}
