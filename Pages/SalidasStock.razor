@page "/inventario/salidas-stock"
@using Microsoft.EntityFrameworkCore
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Web
@attribute [Authorize]
@inject IDbContextFactory<SistemIA.Models.AppDbContext> DbFactory
@inject SistemIA.Services.IInventarioService Inventario
@inject SistemIA.Services.ISucursalProvider SucursalProvider
@inject SistemIA.Services.ICajaProvider CajaProvider
@inject NavigationManager Navigation
@inject Microsoft.JSInterop.IJSRuntime JS
@inject Microsoft.AspNetCore.Components.Authorization.AuthenticationStateProvider AuthStateProvider

<PageProtection Modulo="/inventario/salidas-stock" Permiso="VIEW">

@if (sucursalId == 0)
{
  <div class="alert alert-warning">
    <i class="bi bi-exclamation-triangle me-2"></i>
    Debe seleccionar una sucursal para usar este módulo.
  </div>
}
else
{
<div class="d-flex justify-content-between align-items-center mb-3">
  <h3 class="mb-0"><i class="bi bi-box-arrow-right me-2"></i>Salidas de Stock</h3>
  <div class="d-flex align-items-center gap-3">
    <span class="badge bg-secondary fs-6">
      <i class="bi bi-building me-1"></i>@nombreSucursal
    </span>
    <span class="badge bg-info fs-6">
      <i class="bi bi-calendar-date me-1"></i>Fecha Caja: @fechaCaja.ToString("dd/MM/yyyy")
    </span>
  </div>
</div>

@if (!mostrarFormulario)
{
  <!-- Filtros de búsqueda -->
  <div class="card shadow-sm mb-3">
    <div class="card-body">
      <div class="row g-3 align-items-end">
        <div class="col-md-2">
          <label class="form-label">ID</label>
          <input type="number" class="form-control" @bind="filtroId" placeholder="Número" />
        </div>
        <div class="col-md-2">
          <label class="form-label">Fecha Desde</label>
          <input type="date" class="form-control" @bind="filtroFechaDesde" />
        </div>
        <div class="col-md-2">
          <label class="form-label">Fecha Hasta</label>
          <input type="date" class="form-control" @bind="filtroFechaHasta" />
        </div>
        <div class="col-md-2">
          <label class="form-label">Depósito</label>
          <select class="form-select" @bind="filtroDeposito">
            <option value="0">Todos</option>
            @if (depositos != null)
            {
              foreach (var d in depositos)
              {
                <option value="@d.IdDeposito">@d.Nombre</option>
              }
            }
          </select>
        </div>
        <div class="col-md-2">
          <label class="form-label">Motivo</label>
          <select class="form-select" @bind="filtroMotivo">
            <option value="">Todos</option>
            @foreach (var m in SistemIA.Models.MotivosSalidaStock.ObtenerTodos())
            {
              <option value="@m">@m</option>
            }
          </select>
        </div>
        <div class="col-md-2">
          <button class="btn btn-primary w-100" @onclick="BuscarSalidas">
            <i class="bi bi-search me-1"></i> Buscar
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Resultados de búsqueda -->
  <div class="card shadow-sm mb-3">
    <div class="card-body">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h5 class="mb-0">Salidas Registradas</h5>
        <RequirePermission Modulo="/inventario/salidas-stock" Permiso="CREATE">
          <button class="btn btn-success" @onclick="MostrarFormulario">
            <i class="bi bi-plus-circle me-1"></i> Nueva Salida
          </button>
        </RequirePermission>
      </div>
      
      <div class="table-responsive">
        <table class="table table-hover table-sm">
          <thead class="table-dark">
            <tr>
              <th>ID</th>
              <th>Fecha</th>
              <th>Depósito</th>
              <th>Motivo</th>
              <th>Usuario</th>
              <th>Estado</th>
              <th>Observación</th>
              <th style="width:150px;">Acciones</th>
            </tr>
          </thead>
          <tbody>
            @if (salidasFiltradas == null)
            {
              <tr><td colspan="8" class="text-center">Cargando...</td></tr>
            }
            else if (!salidasFiltradas.Any())
            {
              <tr><td colspan="8" class="text-center text-muted">No se encontraron salidas</td></tr>
            }
            else
            {
              foreach (var s in salidasFiltradas)
              {
                <tr style="cursor:pointer;" @onclick="() => MostrarVistaPrevia(s.IdSalidaStock)">
                  <td><strong>#@s.IdSalidaStock</strong></td>
                  <td>@s.FechaSalida.ToString("dd/MM/yyyy HH:mm")</td>
                  <td>@s.Deposito?.Nombre</td>
                  <td><span class="badge @ObtenerClaseMotivo(s.MotivoSalida)">@s.MotivoSalida</span></td>
                  <td>@s.UsuarioCreacion</td>
                  <td>
                    @if (s.Estado == "Confirmada")
                    {
                      <span class="badge bg-success">Confirmada</span>
                    }
                    else if (s.Estado == "Anulada")
                    {
                      <span class="badge bg-danger">Anulada</span>
                    }
                    else
                    {
                      <span class="badge bg-warning text-dark">Borrador</span>
                    }
                  </td>
                  <td><small>@TruncarTexto(s.Observacion, 30)</small></td>
                  <td @onclick:stopPropagation="true">
                    <button class="btn btn-sm btn-outline-info me-1" @onclick="() => MostrarVistaPrevia(s.IdSalidaStock)" title="Vista previa">
                      <i class="bi bi-eye"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-primary" @onclick="() => ImprimirSalida(s.IdSalidaStock)" title="Imprimir">
                      <i class="bi bi-printer"></i>
                    </button>
                  </td>
                </tr>
              }
            }
          </tbody>
        </table>
      </div>
    </div>
  </div>
  
  <!-- Modal de Vista Previa -->
  @if (mostrarVistaPrevia && salidaPreview != null)
  {
    <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.85);" @onclick="CerrarVistaPrevia">
      <div class="modal-dialog" style="max-width: 95vw; width: 95vw; margin: 1rem auto; resize: both; overflow: auto;" @onclick:stopPropagation="true">
        <div class="modal-content" style="height: calc(100vh - 2rem); resize: both; overflow: hidden;">
          <div class="modal-header bg-danger text-white">
            <h5 class="modal-title">
              <i class="bi bi-eye me-2"></i>
              Vista Previa - Salida de Stock #@salidaPreview.IdSalidaStock
            </h5>
            <button type="button" class="btn-close btn-close-white" @onclick="CerrarVistaPrevia"></button>
          </div>
          <div class="modal-body p-0" style="overflow-y: auto; overflow-x: auto;">
            <div style="background: #e0e0e0; padding: 30px; min-height: 100%;">
              <div style="background: white; width: 28cm; margin: 0 auto; padding: 2.5cm; box-shadow: 0 8px 24px rgba(0,0,0,0.3); border-radius: 0;">
                @((MarkupString)htmlVistaPrevia)
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button class="btn btn-lg btn-secondary" @onclick="CerrarVistaPrevia">
              <i class="bi bi-x-circle me-2"></i> Cerrar
            </button>
            <button class="btn btn-lg btn-primary" @onclick="() => ImprimirSalida(salidaPreview.IdSalidaStock)">
              <i class="bi bi-printer me-2"></i> Imprimir
            </button>
          </div>
        </div>
      </div>
    </div>
  }
}
else
{
  <!-- Formulario de nueva salida -->
  <div class="card shadow-sm mb-3">
    <div class="card-body">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h5 class="mb-0">
          @if (salidaEditandoId.HasValue)
          {
            <span>Editando Salida #@salidaEditandoId</span>
          }
          else
          {
            <span>Nueva Salida de Stock</span>
          }
        </h5>
        <button class="btn btn-outline-secondary btn-sm" @onclick="CancelarFormulario">
          <i class="bi bi-x-lg me-1"></i> Cancelar
        </button>
      </div>
      <div class="row g-3 align-items-end">
        <div class="col-md-3">
          <label class="form-label fw-semibold">Depósito</label>
          <select class="form-select" @bind="idDeposito" @bind:after="CargarStocksDeposito" disabled="@guardando">
            <option value="0">-- Seleccione depósito --</option>
            @if (depositos != null)
            {
              foreach (var d in depositos)
              {
                <option value="@d.IdDeposito">@d.Nombre</option>
              }
            }
          </select>
        </div>
        <div class="col-md-2">
          <label class="form-label fw-semibold">Motivo de Salida</label>
          <select class="form-select" @bind="motivoSalida" disabled="@guardando">
            @foreach (var m in SistemIA.Models.MotivosSalidaStock.ObtenerTodos())
            {
              <option value="@m">@m</option>
            }
          </select>
        </div>
        <div class="col-md-5">
          <label class="form-label">Observación</label>
          <input class="form-control" @bind="observacion" maxlength="1000" placeholder="Descripción detallada de la salida" disabled="@guardando" />
        </div>
        <div class="col-md-2 text-end">
          <button class="btn btn-danger w-100" @onclick="GuardarYConfirmar" disabled="@(idDeposito==0 || !lineas.Any() || guardando)">
            @if (guardando)
            {
              <span class="spinner-border spinner-border-sm me-1"></span>
              <span>Guardando...</span>
            }
            else
            {
              <i class="bi bi-check-circle me-1"></i>
              <span>Confirmar Salida</span>
            }
          </button>
        </div>
      </div>
    </div>
    @if (!string.IsNullOrWhiteSpace(errorMsg))
    {
      <div class="card-footer">
        <div class="alert alert-danger py-2 my-0">@errorMsg</div>
      </div>
    }
    @if (!string.IsNullOrWhiteSpace(okMsg))
    {
      <div class="card-footer">
        <div class="alert alert-success py-2 my-0">@okMsg</div>
      </div>
    }
    @if (salidaGeneradaId.HasValue)
    {
      <div class="card-footer d-flex gap-2">
        <button class="btn btn-outline-secondary" @onclick="Imprimir">
          <i class="bi bi-printer me-1"></i> Imprimir
        </button>
        <button class="btn btn-outline-primary" @onclick="NuevaSalidaDesdeFormulario">
          <i class="bi bi-plus-circle me-1"></i> Nueva salida
        </button>
        <button class="btn btn-outline-info" @onclick="VolverAListado">
          <i class="bi bi-list me-1"></i> Ver listado
        </button>
      </div>
    }
  </div>

  <!-- Agregar productos -->
  <div class="card shadow-sm">
    <div class="card-body">
      <div class="row g-3 align-items-end">
        <div class="col-md-5">
          <label class="form-label">Producto</label>
          <div class="position-relative">
            <div class="input-group">
              <span class="input-group-text"><i class="bi bi-search"></i></span>
              <input class="form-control" placeholder="Buscar por nombre o código" @bind="buscarProducto" @bind:event="oninput" @onkeyup="OnProductoKeyUp" @onfocus="OnProductoFocus" @onblur="OnProductoBlur" autocomplete="off" onkeydown="if(event.key==='Enter'){event.preventDefault();return false;}" disabled="@(idDeposito==0 || guardando)" />
            </div>
            @if (mostrarSugProductos && productosFiltrados.Any())
            {
              <div class="list-group position-absolute w-100 z-3" style="max-height: 300px; overflow:auto;">
                @foreach (var p in productosFiltrados.Take(15))
                {
                  <button type="button"
                          class="list-group-item list-group-item-action d-flex justify-content-between align-items-start"
                          tabindex="-1"
                          @onpointerdown="() => SeleccionarProducto(p)" @onpointerdown:preventDefault @onpointerdown:stopPropagation
                          @onmousedown="() => SeleccionarProducto(p)" @onmousedown:preventDefault @onmousedown:stopPropagation
                          @onclick="() => SeleccionarProducto(p)" @onclick:preventDefault @onclick:stopPropagation>
                    <div>
                      <div class="fw-semibold">@p.Descripcion</div>
                      <small class="text-muted">Código: @p.CodigoInterno</small>
                    </div>
                    <span class="badge bg-secondary">Stock: @ObtenerStockDisplay(p.IdProducto)</span>
                  </button>
                }
              </div>
            }
          </div>
        </div>
        
        @if (idProductoSeleccionado > 0 && lotesDisponibles.Any())
        {
          <div class="col-md-2">
            <label class="form-label">Lote</label>
            <select class="form-select" @bind="idLoteSeleccionado" @bind:after="OnLoteSeleccionado" disabled="@guardando">
              <option value="0">-- Sin lote --</option>
              @foreach (var lote in lotesDisponibles)
              {
                <option value="@lote.IdProductoLote">
                  @lote.NumeroLote 
                  @if (lote.FechaVencimiento.HasValue)
                  {
                    <text>- Venc: @lote.FechaVencimiento.Value.ToString("dd/MM/yyyy")</text>
                  }
                  (Stock: @lote.Stock.ToString("N2"))
                </option>
              }
            </select>
          </div>
        }
        
        <div class="col-md-2">
          <label class="form-label">Stock disponible</label>
          <input class="form-control" value="@stockDisponible.ToString("N2")" disabled />
        </div>
        <div class="col-md-2">
          <label class="form-label">Cantidad a dar salida</label>
          <input class="form-control" type="number" step="0.01" min="0" @bind-value="cantidad" @bind-value:event="oninput" disabled="@(idProductoSeleccionado==0 || guardando)" />
        </div>
        <div class="col-md-1 text-end">
          <button class="btn btn-success w-100" @onclick="AgregarLinea" disabled="@(idProductoSeleccionado==0 || idDeposito==0 || cantidad<=0 || guardando)">
            <i class="bi bi-plus-lg"></i>
          </button>
        </div>
      </div>

      <hr />

      <div class="table-responsive">
        <table class="table table-sm table-hover align-middle">
          <thead class="table-dark">
            <tr>
              <th style="width:50px;">#</th>
              <th>Código</th>
              <th>Producto</th>
              <th>Lote</th>
              <th>Vencimiento</th>
              <th class="text-end">Stock</th>
              <th class="text-end">Cantidad</th>
              <th class="text-end">Costo unit.</th>
              <th class="text-end">Costo total</th>
              <th style="width:80px;">Acciones</th>
            </tr>
          </thead>
          <tbody>
            @if (!lineas.Any())
            {
              <tr><td colspan="10" class="text-center text-muted py-4">Sin productos agregados</td></tr>
            }
            else
            {
              var idx = 0;
              foreach (var l in lineas)
              {
                <tr class="@(l.EstaVencido ? "table-danger" : l.EstaProximoAVencer ? "table-warning" : "")">
                  <td>@(++idx)</td>
                  <td><span class="badge bg-secondary">@l.CodigoInterno</span></td>
                  <td>
                    <div class="fw-semibold">@l.Descripcion</div>
                  </td>
                  <td>
                    @if (!string.IsNullOrEmpty(l.NumeroLote))
                    {
                      <span class="badge bg-info">@l.NumeroLote</span>
                    }
                    else
                    {
                      <span class="text-muted">-</span>
                    }
                  </td>
                  <td>
                    @if (l.FechaVencimiento.HasValue)
                    {
                      <span class="@(l.EstaVencido ? "text-danger fw-bold" : l.EstaProximoAVencer ? "text-warning fw-bold" : "")">
                        @l.FechaVencimiento.Value.ToString("dd/MM/yyyy")
                        @if (l.EstaVencido)
                        {
                          <i class="bi bi-exclamation-triangle-fill text-danger ms-1" title="Vencido"></i>
                        }
                      </span>
                    }
                    else
                    {
                      <span class="text-muted">-</span>
                    }
                  </td>
                  <td class="text-end">@l.StockActual.ToString("N2")</td>
                  <td class="text-end">
                    <input class="form-control form-control-sm text-end" style="max-width:100px; display:inline-block;" type="number" step="0.01" min="0.01" value="@l.Cantidad"
                           @oninput="(e)=>ActualizarCantidad(l, e.Value?.ToString())" disabled="@guardando" />
                  </td>
                  <td class="text-end">@l.CostoUnitario.ToString("N0")</td>
                  <td class="text-end fw-semibold">@l.CostoTotal.ToString("N0")</td>
                  <td class="text-center">
                    <button class="btn btn-sm btn-outline-danger" title="Quitar" @onclick="(()=>QuitarLinea(l))" disabled="@guardando"><i class="bi bi-x-lg"></i></button>
                  </td>
                </tr>
              }
            }
          </tbody>
          <tfoot>
            <tr class="table-secondary">
              <th colspan="8" class="text-end">Total Pérdida</th>
              <th class="text-end text-danger">@lineas.Sum(x=>x.CostoTotal).ToString("N0")</th>
              <th></th>
            </tr>
          </tfoot>
        </table>
      </div>
    </div>
  </div>
}
} @* Cierre del else sucursalId *@

</PageProtection>

@code {
  // Variables de sucursal y caja
  private int sucursalId;
  private string? nombreSucursal;
  private DateTime fechaCaja = DateTime.Today;
  
  private List<SistemIA.Models.Deposito>? depositos;
  private List<SistemIA.Models.Producto>? productos;
  private List<SistemIA.Models.Producto> productosFiltrados = new();
  private Dictionary<int, decimal> stocksPorProducto = new();
  private List<SistemIA.Models.ProductoLote> lotesDisponibles = new();
  
  // Variables de formulario
  private bool mostrarFormulario = false;
  private int? salidaEditandoId;
  private int idDeposito;
  private string motivoSalida = SistemIA.Models.MotivosSalidaStock.Vencimiento;
  private string? observacion;
  private int idProductoSeleccionado;
  private int idLoteSeleccionado;
  private decimal stockDisponible;
  private decimal cantidad;
  private string? buscarProducto;
  private bool mostrarSugProductos;
  
  private string? errorMsg;
  private string? okMsg;
  private bool guardando;
  private int? salidaGeneradaId;
  
  private List<LineaVM> lineas = new();
  
  // Variables de filtros
  private int? filtroId;
  private DateTime? filtroFechaDesde;
  private DateTime? filtroFechaHasta;
  private int filtroDeposito;
  private string? filtroMotivo;
  
  private List<SistemIA.Models.SalidaStock>? salidasFiltradas;
  
  // Variables de vista previa
  private bool mostrarVistaPrevia = false;
  private SistemIA.Models.SalidaStock? salidaPreview;
  private string htmlVistaPrevia = string.Empty;

  protected override async Task OnInitializedAsync()
  {
    // Cargar sucursal actual
    sucursalId = SucursalProvider.GetSucursalId() ?? 0;
    nombreSucursal = SucursalProvider.GetSucursalNombre();
    
    if (sucursalId == 0)
    {
      // Sin sucursal seleccionada, mostrar mensaje
      return;
    }
    
    await using var ctx = await DbFactory.CreateDbContextAsync();
    
    // Cargar fecha de caja
    var idCaja = CajaProvider.GetCajaId();
    if (idCaja > 0)
    {
      var caja = await ctx.Cajas.AsNoTracking().FirstOrDefaultAsync(c => c.IdCaja == idCaja);
      if (caja?.FechaActualCaja != null)
      {
        fechaCaja = caja.FechaActualCaja.Value;
      }
    }
    
    // Cargar depósitos SOLO de la sucursal actual
    depositos = await ctx.Depositos
      .Include(d => d.Sucursal)
      .Where(d => d.Activo && d.IdSucursal == sucursalId)
      .AsNoTracking()
      .OrderBy(d => d.Nombre)
      .ToListAsync();
    
    // Si solo hay un depósito, seleccionarlo automáticamente
    if (depositos.Count == 1)
    {
      idDeposito = depositos[0].IdDeposito;
    }
    
    productos = await ctx.Productos
      .AsNoTracking()
      .Where(p => p.Activo)
      .OrderBy(p => p.Descripcion)
      .ToListAsync();
    
    // Cargar últimas salidas
    await BuscarSalidas();
  }
  
  private void MostrarFormulario()
  {
    mostrarFormulario = true;
    Nuevo();
  }
  
  private void CancelarFormulario()
  {
    mostrarFormulario = false;
    Nuevo();
  }
  
  private void VolverAListado()
  {
    mostrarFormulario = false;
    Nuevo();
    _ = BuscarSalidas();
  }
  
  private void NuevaSalidaDesdeFormulario()
  {
    Nuevo();
  }
  
  private async Task BuscarSalidas()
  {
    await using var ctx = await DbFactory.CreateDbContextAsync();
    
    var query = ctx.SalidasStock
      .Include(s => s.Deposito)
      .AsNoTracking()
      .AsQueryable();
    
    if (filtroId.HasValue)
      query = query.Where(s => s.IdSalidaStock == filtroId.Value);
    
    if (filtroFechaDesde.HasValue)
      query = query.Where(s => s.FechaSalida >= filtroFechaDesde.Value);
    
    if (filtroFechaHasta.HasValue)
      query = query.Where(s => s.FechaSalida <= filtroFechaHasta.Value.AddDays(1));
    
    if (filtroDeposito > 0)
      query = query.Where(s => s.IdDeposito == filtroDeposito);
    
    if (!string.IsNullOrEmpty(filtroMotivo))
      query = query.Where(s => s.MotivoSalida == filtroMotivo);
    
    salidasFiltradas = await query
      .OrderByDescending(s => s.IdSalidaStock)
      .Take(100)
      .ToListAsync();
  }
  
  private async Task MostrarVistaPrevia(int idSalida)
  {
    try
    {
      await using var ctx = await DbFactory.CreateDbContextAsync();
      salidaPreview = await ctx.SalidasStock
        .Include(s => s.Deposito).ThenInclude(d => d!.Sucursal)
        .AsNoTracking()
        .FirstOrDefaultAsync(s => s.IdSalidaStock == idSalida);
      
      if (salidaPreview == null) return;
      
      var detalles = await ctx.SalidasStockDetalle
        .Include(d => d.Producto)
        .Include(d => d.ProductoLote)
        .AsNoTracking()
        .Where(d => d.IdSalidaStock == idSalida)
        .ToListAsync();
      
      htmlVistaPrevia = GenerarHtmlVistaPrevia(salidaPreview, detalles);
      mostrarVistaPrevia = true;
    }
    catch (Exception ex)
    {
      Console.Error.WriteLine($"Error al cargar vista previa: {ex.Message}");
    }
  }
  
  private void CerrarVistaPrevia()
  {
    mostrarVistaPrevia = false;
    salidaPreview = null;
    htmlVistaPrevia = string.Empty;
  }
  
  private string GenerarHtmlVistaPrevia(SistemIA.Models.SalidaStock salida, List<SistemIA.Models.SalidaStockDetalle> dets)
  {
    var suc = salida.Deposito?.Sucursal;
    string empresa = suc?.NombreEmpresa ?? "Empresa";
    string sucursal = suc?.NombreSucursal ?? "Sucursal";
    string ruc = suc != null ? $"{suc.RUC}-{suc.DV}" : "";
    string direccion = suc?.Direccion ?? "";
    
    // Logo
    string? logoDataUri = null;
    if (suc?.Logo != null && suc.Logo.Length > 0)
    {
      var b64 = Convert.ToBase64String(suc.Logo);
      logoDataUri = $"data:image/png;base64,{b64}";
    }
    
    var sb = new System.Text.StringBuilder();
    
    // Estilos inline para la vista previa
    sb.AppendLine("<style>");
    sb.AppendLine("body{font-size:14px;color:#000;line-height:1.5;}");
    sb.AppendLine(".header{display:flex;align-items:center;gap:20px;border-bottom:4px solid #dc3545;padding-bottom:14px;margin-bottom:20px;}");
    sb.AppendLine(".header .logo{max-width:160px;max-height:80px;object-fit:contain;border-radius:6px;border:2px solid #ddd;background:#fff;padding:10px;}");
    sb.AppendLine(".header .empresa h2{margin:0;font-size:22px;font-weight:700;color:#000;}");
    sb.AppendLine(".header .empresa .small{font-size:13px;color:#333;font-weight:600;}");
    sb.AppendLine(".meta{display:flex;justify-content:space-between;gap:20px;margin-bottom:20px;padding:16px;background:#fff3cd;border-radius:6px;border:2px solid #ffc107;}");
    sb.AppendLine(".meta .text-muted{color:#555!important;font-size:12px;font-weight:700;text-transform:uppercase;margin-bottom:6px;letter-spacing:0.5px;}");
    sb.AppendLine(".meta .fw-semibold{color:#000;font-size:16px;font-weight:700;}");
    sb.AppendLine(".table-salida{width:100%;border-collapse:collapse;margin-top:16px;}");
    sb.AppendLine(".table-salida th,.table-salida td{padding:.85rem;border:1.5px solid #dee2e6;}");
    sb.AppendLine(".table-salida thead th{background:#dc3545;color:white;font-weight:700;font-size:14px;text-align:left;padding:12px;}");
    sb.AppendLine(".table-salida tbody tr{background:#fff;}");
    sb.AppendLine(".table-salida tbody tr:hover{background:#f1f3f5;}");
    sb.AppendLine(".table-salida tbody tr.vencido{background:#ffebee;}");
    sb.AppendLine(".table-salida tbody td{color:#000;font-size:14px;font-weight:500;}");
    sb.AppendLine(".table-salida tfoot tr{background:#f8f9fa;border-top:4px solid #dc3545;}");
    sb.AppendLine(".table-salida tfoot td{font-weight:700;font-size:17px;color:#dc3545;padding:14px;}");
    sb.AppendLine(".alert-warning{background:#fff3cd;border:2px solid #ffc107;padding:14px;border-radius:6px;margin:16px 0;color:#856404;font-size:14px;font-weight:600;}");
    sb.AppendLine(".badge-motivo{background:#dc3545;color:white;padding:6px 12px;border-radius:4px;font-weight:700;}");
    sb.AppendLine(".fw-bold{font-weight:700;}");
    sb.AppendLine("</style>");
    
    // HEADER
    sb.AppendLine("<div class='header'>");
    if (!string.IsNullOrEmpty(logoDataUri))
      sb.AppendLine($"  <img class='logo' src='{logoDataUri}' alt='Logo'/>");
    sb.AppendLine("  <div class='empresa'>");
    sb.AppendLine($"    <h2>{System.Net.WebUtility.HtmlEncode(empresa)}</h2>");
    sb.AppendLine($"    <div class='small'>RUC: {System.Net.WebUtility.HtmlEncode(ruc)} · {System.Net.WebUtility.HtmlEncode(sucursal)}</div>");
    sb.AppendLine($"    <div class='small'>{System.Net.WebUtility.HtmlEncode(direccion)}</div>");
    sb.AppendLine("  </div>");
    sb.AppendLine("  <div style='margin-left:auto;text-align:right;'>");
    sb.AppendLine("    <div class='fw-bold' style='font-size:20px;color:#dc3545;'>SALIDA DE STOCK</div>");
    sb.AppendLine($"    <div style='font-size:16px;font-weight:600;color:#000;'>N°: {salida.IdSalidaStock:D6}</div>");
    sb.AppendLine($"    <div style='font-size:13px;color:#333;'>Fecha: {salida.FechaSalida:dd/MM/yyyy HH:mm}</div>");
    if (!string.IsNullOrWhiteSpace(salida.UsuarioCreacion))
      sb.AppendLine($"    <div style='font-size:13px;color:#333;'>Usuario: {System.Net.WebUtility.HtmlEncode(salida.UsuarioCreacion)}</div>");
    sb.AppendLine("  </div>");
    sb.AppendLine("</div>");
    
    // META (depósito y motivo)
    sb.AppendLine("<div class='meta'>");
    sb.AppendLine("  <div>");
    sb.AppendLine("    <div class='text-muted'>Depósito</div>");
    sb.AppendLine($"    <div class='fw-semibold'>{System.Net.WebUtility.HtmlEncode(salida.Deposito?.Nombre ?? "N/A")}</div>");
    sb.AppendLine($"    <div class='small'>{System.Net.WebUtility.HtmlEncode(salida.Deposito?.Sucursal?.NombreSucursal ?? "")}</div>");
    sb.AppendLine("  </div>");
    sb.AppendLine("  <div style='text-align:center;'>");
    sb.AppendLine("    <div class='text-muted'>Motivo de Salida</div>");
    sb.AppendLine($"    <div class='badge-motivo'>{System.Net.WebUtility.HtmlEncode(salida.MotivoSalida)}</div>");
    sb.AppendLine("  </div>");
    sb.AppendLine("  <div style='text-align:right;'>");
    sb.AppendLine("    <div class='text-muted'>Estado</div>");
    var estadoBadge = salida.Estado == "Confirmada" ? "background:#28a745;" : salida.Estado == "Anulada" ? "background:#6c757d;" : "background:#ffc107;color:#000;";
    sb.AppendLine($"    <div style='{estadoBadge}padding:6px 12px;border-radius:4px;font-weight:700;display:inline-block;'>{salida.Estado}</div>");
    sb.AppendLine("  </div>");
    sb.AppendLine("</div>");
    
    if (!string.IsNullOrWhiteSpace(salida.Observacion))
    {
      sb.AppendLine($"<div class='alert-warning'><strong>Observación:</strong> {System.Net.WebUtility.HtmlEncode(salida.Observacion)}</div>");
    }
    
    sb.AppendLine("<table class='table-salida'>");
    sb.AppendLine("  <thead><tr><th>#</th><th>Código</th><th>Descripción</th><th>Lote</th><th>Vencimiento</th><th style='text-align:right;width:100px;'>Cantidad</th><th style='text-align:right;width:110px;'>Costo unit.</th><th style='text-align:right;width:110px;'>Costo total</th></tr></thead>");
    sb.AppendLine("  <tbody>");
    var idx = 0;
    foreach (var d in dets)
    {
      idx++;
      var desc = d.Producto?.Descripcion ?? $"Producto #{d.IdProducto}";
      var codigo = d.Producto?.CodigoInterno ?? "-";
      var costoTotal = d.Cantidad * (d.CostoUnitario ?? 0);
      var loteStr = !string.IsNullOrEmpty(d.NumeroLote) ? d.NumeroLote : "-";
      var vencStr = d.FechaVencimientoLote.HasValue ? d.FechaVencimientoLote.Value.ToString("dd/MM/yyyy") : "-";
      var esVencido = d.FechaVencimientoLote.HasValue && d.FechaVencimientoLote.Value.Date < DateTime.Today;
      var rowClass = esVencido ? "vencido" : "";
      
      sb.AppendLine($"    <tr class='{rowClass}'><td style='font-weight:600;'>{idx}</td><td style='font-weight:600;'>{System.Net.WebUtility.HtmlEncode(codigo)}</td><td>{System.Net.WebUtility.HtmlEncode(desc)}</td><td><span style='background:#17a2b8;color:white;padding:2px 6px;border-radius:3px;'>{System.Net.WebUtility.HtmlEncode(loteStr)}</span></td><td style='color:{(esVencido ? "#dc3545;font-weight:700;" : "#000;")}'>{vencStr}{(esVencido ? " ⚠️" : "")}</td><td style='text-align:right;font-weight:600;'>{d.Cantidad:N2}</td><td style='text-align:right;'>{(d.CostoUnitario ?? 0):N0}</td><td style='text-align:right;font-weight:700;'>{costoTotal:N0}</td></tr>");
    }
    sb.AppendLine("  </tbody>");
    sb.AppendLine("  <tfoot>");
    var totalCosto = dets.Sum(d => d.Cantidad * (d.CostoUnitario ?? 0));
    sb.AppendLine($"    <tr><td colspan='7' style='text-align:right;font-size:16px;'>TOTAL PÉRDIDA</td><td style='text-align:right;font-size:16px;'>{totalCosto:N0}</td></tr>");
    sb.AppendLine("  </tfoot>");
    sb.AppendLine("</table>");
    
    sb.AppendLine("<div style='text-align:center;margin-top:2rem;color:#dc3545;font-size:11px;font-weight:600;'>** Comprobante de Salida de Stock - Uso Interno **</div>");
    
    return sb.ToString();
  }

  private async Task CargarStockDisponible()
  {
    if (idProductoSeleccionado == 0 || idDeposito == 0)
    {
      stockDisponible = 0;
      return;
    }
    
    try
    {
      if (idLoteSeleccionado > 0)
      {
        // Stock del lote específico
        var lote = lotesDisponibles.FirstOrDefault(l => l.IdProductoLote == idLoteSeleccionado);
        stockDisponible = lote?.Stock ?? 0;
      }
      else
      {
        // Stock general del depósito
        stockDisponible = await Inventario.ObtenerStockAsync(idProductoSeleccionado, idDeposito);
      }
    }
    catch
    {
      stockDisponible = 0;
    }
  }

  private string ObtenerStockDisplay(int idProducto)
  {
    if (idDeposito == 0) return "-";
    if (stocksPorProducto.ContainsKey(idProducto))
      return stocksPorProducto[idProducto].ToString("N2");
    return "-";
  }

  private async Task CargarStocksDeposito()
  {
    if (idDeposito == 0 || productos == null) return;
    
    stocksPorProducto.Clear();
    await using var ctx = await DbFactory.CreateDbContextAsync();
    var stocks = await ctx.ProductosDepositos
      .AsNoTracking()
      .Where(pd => pd.IdDeposito == idDeposito && pd.Stock > 0)
      .ToListAsync();
    
    foreach (var s in stocks)
    {
      stocksPorProducto[s.IdProducto] = s.Stock;
    }
  }

  private void AplicarFiltroProductos()
  {
    var texto = (buscarProducto ?? string.Empty).Trim().ToLowerInvariant();
    mostrarSugProductos = !string.IsNullOrWhiteSpace(texto);
    if (!mostrarSugProductos)
    {
      productosFiltrados = new List<SistemIA.Models.Producto>();
      return;
    }
    
    productosFiltrados = productos!
      .Where(p => (p.Descripcion ?? string.Empty).ToLower().Contains(texto) || 
                  (p.CodigoInterno ?? string.Empty).ToLower().Contains(texto))
      .Take(50)
      .ToList();
  }

  private async Task SeleccionarProducto(SistemIA.Models.Producto p)
  {
    idProductoSeleccionado = p.IdProducto;
    buscarProducto = p.Descripcion ?? string.Empty;
    mostrarSugProductos = false;
    idLoteSeleccionado = 0;
    
    // Cargar lotes disponibles para este producto en este depósito
    await CargarLotesDisponibles();
    
    await CargarStockDisponible();
    cantidad = 1;
    StateHasChanged();
  }
  
  private async Task CargarLotesDisponibles()
  {
    if (idProductoSeleccionado == 0)
    {
      lotesDisponibles.Clear();
      return;
    }
    
    await using var ctx = await DbFactory.CreateDbContextAsync();
    
    // Buscar lotes del depósito seleccionado con stock disponible
    lotesDisponibles = await ctx.ProductosLotes
      .AsNoTracking()
      .Where(l => l.IdProducto == idProductoSeleccionado 
                && l.IdDeposito == idDeposito 
                && l.Stock > 0
                && l.Estado == "Activo")
      .OrderBy(l => l.FechaVencimiento) // FEFO: primero los que vencen antes
      .ToListAsync();
  }
  
  private async Task OnLoteSeleccionado()
  {
    await CargarStockDisponible();
    StateHasChanged();
  }

  private void OnProductoKeyUp(KeyboardEventArgs e)
  {
    if (e.Key == "Escape")
    {
      mostrarSugProductos = false;
    }
    else
    {
      AplicarFiltroProductos();
    }
  }

  private void OnProductoFocus(FocusEventArgs _)
  {
    if (!string.IsNullOrEmpty(buscarProducto))
    {
      AplicarFiltroProductos();
      mostrarSugProductos = true;
    }
  }

  private void OnProductoBlur(FocusEventArgs _)
  {
    // Manejado por onpointerdown
  }

  private async Task AgregarLinea()
  {
    errorMsg = okMsg = null;
    if (idDeposito == 0) { errorMsg = "Seleccione depósito"; return; }
    if (idProductoSeleccionado == 0) { errorMsg = "Seleccione un producto"; return; }
    if (cantidad <= 0) { errorMsg = "Ingrese cantidad mayor a 0"; return; }
    
    await CargarStockDisponible();
    if (cantidad > stockDisponible)
    {
      errorMsg = $"Stock insuficiente. Disponible: {stockDisponible:N2}";
      return;
    }
    
    var p = productos!.First(x => x.IdProducto == idProductoSeleccionado);
    
    // Verificar si ya existe una línea con el mismo producto y lote
    var existente = lineas.FirstOrDefault(x => x.IdProducto == p.IdProducto && x.IdProductoLote == (idLoteSeleccionado > 0 ? idLoteSeleccionado : (int?)null));
    
    if (existente != null)
    {
      existente.Cantidad = cantidad;
      existente.StockActual = stockDisponible;
      RecalcularLinea(existente);
    }
    else
    {
      var lote = idLoteSeleccionado > 0 ? lotesDisponibles.FirstOrDefault(l => l.IdProductoLote == idLoteSeleccionado) : null;
      
      var l = new LineaVM
      {
        IdProducto = p.IdProducto,
        IdProductoLote = idLoteSeleccionado > 0 ? idLoteSeleccionado : null,
        CodigoInterno = p.CodigoInterno,
        Descripcion = p.Descripcion,
        NumeroLote = lote?.NumeroLote,
        FechaVencimiento = lote?.FechaVencimiento,
        StockActual = stockDisponible,
        Cantidad = cantidad,
        CostoUnitario = lote?.CostoUnitario ?? p.CostoUnitarioGs ?? 0
      };
      RecalcularLinea(l);
      lineas.Add(l);
    }
    
    // Limpiar
    idProductoSeleccionado = 0;
    idLoteSeleccionado = 0;
    stockDisponible = 0;
    cantidad = 0;
    buscarProducto = string.Empty;
    mostrarSugProductos = false;
    lotesDisponibles.Clear();
  }

  private void RecalcularLinea(LineaVM l)
  {
    l.CostoTotal = l.Cantidad * l.CostoUnitario;
  }

  private void ActualizarCantidad(LineaVM l, string? valor)
  {
    if (decimal.TryParse(valor, out var cant) && cant > 0)
    {
      l.Cantidad = cant;
      RecalcularLinea(l);
    }
    else if (string.IsNullOrWhiteSpace(valor))
    {
      return;
    }
    else
    {
      l.Cantidad = 1;
      RecalcularLinea(l);
    }
  }

  private void QuitarLinea(LineaVM l)
  {
    lineas.Remove(l);
  }

  private async Task GuardarYConfirmar()
  {
    // ========== PROTECCIÓN CONTRA DOBLE GUARDADO ==========
    if (guardando)
    {
      Console.WriteLine("[SalidasStock] Clic duplicado en Guardar ignorado - operación en curso");
      return;
    }
    
    errorMsg = okMsg = null;
    guardando = true;
    StateHasChanged();
    
    try
    {
      if (idDeposito == 0)
      {
        errorMsg = "Seleccione un depósito";
        return;
      }
      
      if (!lineas.Any())
      {
        errorMsg = "Agregue al menos un producto";
        return;
      }
      
      // Validar stocks
      foreach (var l in lineas)
      {
        decimal stockActual;
        if (l.IdProductoLote.HasValue)
        {
          await using var ctxVal = await DbFactory.CreateDbContextAsync();
          var lote = await ctxVal.ProductosLotes.FindAsync(l.IdProductoLote.Value);
          stockActual = lote?.Stock ?? 0;
        }
        else
        {
          stockActual = await Inventario.ObtenerStockAsync(l.IdProducto, idDeposito);
        }
        
        if (l.Cantidad > stockActual)
        {
          errorMsg = $"Stock insuficiente para {l.Descripcion}. Disponible: {stockActual:N2}";
          return;
        }
      }
      
      await using var ctx = await DbFactory.CreateDbContextAsync();
      
      // Obtener usuario
      var authState = await AuthStateProvider.GetAuthenticationStateAsync();
      var usuario = authState.User.Identity?.Name ?? "Sistema";
      
      // Crear salida - usar fecha de caja
      var salida = new SistemIA.Models.SalidaStock
      {
        IdDeposito = idDeposito,
        FechaSalida = fechaCaja.Date.Add(DateTime.Now.TimeOfDay), // Fecha caja + hora actual
        MotivoSalida = motivoSalida,
        Observacion = observacion,
        UsuarioCreacion = usuario,
        Estado = "Confirmada",
        FechaConfirmacion = fechaCaja.Date.Add(DateTime.Now.TimeOfDay),
        UsuarioConfirmacion = usuario
      };
      
      ctx.SalidasStock.Add(salida);
      await ctx.SaveChangesAsync();
      
      // Crear detalles
      foreach (var l in lineas)
      {
        var detalle = new SistemIA.Models.SalidaStockDetalle
        {
          IdSalidaStock = salida.IdSalidaStock,
          IdProducto = l.IdProducto,
          IdProductoLote = l.IdProductoLote,
          NumeroLote = l.NumeroLote,
          FechaVencimientoLote = l.FechaVencimiento,
          Cantidad = l.Cantidad,
          CostoUnitario = l.CostoUnitario,
          Observacion = l.ObservacionLinea
        };
        ctx.SalidasStockDetalle.Add(detalle);
      }
      
      await ctx.SaveChangesAsync();
      
      // Ajustar stocks: salida de todos los productos
      foreach (var l in lineas)
      {
        // Si tiene lote, descontar del lote específico
        if (l.IdProductoLote.HasValue)
        {
          var lote = await ctx.ProductosLotes.FindAsync(l.IdProductoLote.Value);
          if (lote != null)
          {
            var stockAnterior = lote.Stock;
            lote.Stock -= l.Cantidad;
            if (lote.Stock <= 0)
            {
              lote.Estado = "Agotado";
            }
            
            // Registrar movimiento de lote
            var movLote = new SistemIA.Models.MovimientoLote
            {
              IdProductoLote = l.IdProductoLote.Value,
              TipoMovimiento = SistemIA.Models.TipoMovimientoLote.Salida,
              Cantidad = -l.Cantidad,
              StockAnterior = stockAnterior,
              StockPosterior = lote.Stock,
              TipoDocumento = "SalidaStock",
              IdDocumento = salida.IdSalidaStock,
              ReferenciaDocumento = $"Salida #{salida.IdSalidaStock} - {motivoSalida}",
              Motivo = $"{motivoSalida}: {observacion ?? "Sin observación"}",
              FechaMovimiento = fechaCaja.Date.Add(DateTime.Now.TimeOfDay),
              Usuario = usuario
            };
            ctx.MovimientosLotes.Add(movLote);
            await ctx.SaveChangesAsync();
          }
        }
        
        // Siempre ajustar el stock general del depósito
        await Inventario.AjustarStockAsync(l.IdProducto, idDeposito, l.Cantidad, 2, $"Salida #{salida.IdSalidaStock} - {motivoSalida}", usuario);
      }
      
      salidaGeneradaId = salida.IdSalidaStock;
      okMsg = $"Salida #{salida.IdSalidaStock} registrada y confirmada exitosamente";
      
      // Limpiar formulario
      lineas.Clear();
      idProductoSeleccionado = 0;
      idLoteSeleccionado = 0;
      stockDisponible = 0;
      cantidad = 0;
      buscarProducto = null;
      mostrarSugProductos = false;
      observacion = null;
      lotesDisponibles.Clear();
    }
    catch (Exception ex)
    {
      errorMsg = $"Error al guardar: {ex.Message}";
      if (ex.InnerException != null)
      {
        errorMsg += $" | Detalle: {ex.InnerException.Message}";
      }
      Console.Error.WriteLine($"Error completo en salida de stock: {ex}");
    }
    finally
    {
      guardando = false;
      StateHasChanged();
    }
  }

  private void Nuevo()
  {
    idDeposito = depositos?.FirstOrDefault()?.IdDeposito ?? 0;
    motivoSalida = SistemIA.Models.MotivosSalidaStock.Vencimiento;
    observacion = null;
    lineas.Clear();
    errorMsg = okMsg = null;
    salidaGeneradaId = null;
    salidaEditandoId = null;
    idProductoSeleccionado = 0;
    idLoteSeleccionado = 0;
    stockDisponible = 0;
    cantidad = 0;
    buscarProducto = null;
    mostrarSugProductos = false;
    lotesDisponibles.Clear();
  }

  private async Task Imprimir()
  {
    if (!salidaGeneradaId.HasValue) return;
    await ImprimirSalida(salidaGeneradaId.Value);
  }
  
  private async Task ImprimirSalida(int idSalida)
  {
    try
    {
      await using var ctx = await DbFactory.CreateDbContextAsync();
      var salida = await ctx.SalidasStock
        .Include(s => s.Deposito).ThenInclude(d => d!.Sucursal)
        .AsNoTracking()
        .FirstOrDefaultAsync(s => s.IdSalidaStock == idSalida);
      
      if (salida == null) return;
      
      var detalles = await ctx.SalidasStockDetalle
        .Include(d => d.Producto)
        .Include(d => d.ProductoLote)
        .AsNoTracking()
        .Where(d => d.IdSalidaStock == idSalida)
        .ToListAsync();
      
      await ImprimirComprobante(salida, detalles);
    }
    catch (Exception ex)
    {
      Console.Error.WriteLine($"Error al imprimir: {ex.Message}");
    }
  }

  private async Task ImprimirComprobante(SistemIA.Models.SalidaStock salida, List<SistemIA.Models.SalidaStockDetalle> dets)
  {
    try
    {
      var suc = salida.Deposito?.Sucursal;
      string empresa = suc?.NombreEmpresa ?? "Empresa";
      string sucursal = suc?.NombreSucursal ?? "Sucursal";
      string ruc = suc != null ? $"{suc.RUC}-{suc.DV}" : "";
      string direccion = suc?.Direccion ?? "";
      
      // Logo
      string? logoDataUri = null;
      if (suc?.Logo != null && suc.Logo.Length > 0)
      {
        var b64 = Convert.ToBase64String(suc.Logo);
        logoDataUri = $"data:image/png;base64,{b64}";
      }
      
      // HEAD
      var head = new System.Text.StringBuilder();
      head.AppendLine("<meta charset=\"utf-8\"/>");
      head.AppendLine("<title>Salida de Stock</title>");
      head.AppendLine("<link rel=\"stylesheet\" href=\"/css/bootstrap/bootstrap.min.css\" />");
      head.AppendLine("<style>");
      head.AppendLine("@media print { @page { size: A4; margin: 14mm 12mm; } }");
      head.AppendLine("body{font-size:12px;color:#111;}");
      head.AppendLine(".header{display:flex;align-items:center;gap:16px;border-bottom:2px solid #dc3545;padding-bottom:8px;margin-bottom:12px;}");
      head.AppendLine(".header .logo{max-width:120px;max-height:60px;object-fit:contain;border-radius:6px;border:1px solid #e5e7eb;background:#fff;padding:6px;}");
      head.AppendLine(".header .empresa h2{margin:0;font-size:18px;}");
      head.AppendLine(".meta{display:flex;justify-content:space-between;gap:12px;margin-bottom:10px;background:#fff3cd;padding:10px;border-radius:6px;}");
      head.AppendLine(".table-salida th,.table-salida td{padding:.4rem;border-bottom:1px solid #e5e7eb;}");
      head.AppendLine(".table-salida thead th{background:#dc3545;color:white;}");
      head.AppendLine(".totales{background:#f8fafc;border-radius:6px;padding:10px;}");
      head.AppendLine(".vencido{background:#ffebee;}");
      head.AppendLine("</style>");
      
      // BODY
      var sb = new System.Text.StringBuilder();
      sb.AppendLine("<div class=\"container-fluid\">");
      sb.AppendLine("  <div class=\"header\">");
      if (!string.IsNullOrEmpty(logoDataUri))
        sb.AppendLine($"    <img class=\"logo\" src=\"{logoDataUri}\" alt=\"Logo\"/>");
      sb.AppendLine("    <div class=\"empresa\">");
      sb.AppendLine($"      <h2>{empresa}</h2>");
      sb.AppendLine($"      <div class=\"small\">RUC: {ruc} · {sucursal}</div>");
      sb.AppendLine($"      <div class=\"small\">{direccion}</div>");
      sb.AppendLine("    </div>");
      sb.AppendLine("    <div class=\"ms-auto text-end\">");
      sb.AppendLine("      <div class=\"fw-bold text-danger\" style=\"font-size:18px\">SALIDA DE STOCK</div>");
      sb.AppendLine($"      <div>N°: {salida.IdSalidaStock:D6}</div>");
      sb.AppendLine($"      <div>Fecha: {salida.FechaSalida:dd/MM/yyyy HH:mm}</div>");
      if (!string.IsNullOrWhiteSpace(salida.UsuarioCreacion))
        sb.AppendLine($"      <div>Usuario: {salida.UsuarioCreacion}</div>");
      sb.AppendLine("    </div>");
      sb.AppendLine("  </div>");
      
      sb.AppendLine("  <div class=\"meta\">");
      sb.AppendLine("    <div>");
      sb.AppendLine("      <div class=\"text-muted\">Depósito</div>");
      sb.AppendLine($"      <div class=\"fw-semibold\">{salida.Deposito?.Nombre ?? "N/A"}</div>");
      sb.AppendLine($"      <div class=\"small\">{salida.Deposito?.Sucursal?.NombreSucursal ?? ""}</div>");
      sb.AppendLine("    </div>");
      sb.AppendLine("    <div class=\"text-center\">");
      sb.AppendLine("      <div class=\"text-muted\">Motivo</div>");
      sb.AppendLine($"      <div class=\"fw-semibold text-danger\">{salida.MotivoSalida}</div>");
      sb.AppendLine("    </div>");
      sb.AppendLine("    <div class=\"text-end\">");
      sb.AppendLine("      <div class=\"text-muted\">Estado</div>");
      sb.AppendLine($"      <div class=\"fw-semibold\">{salida.Estado}</div>");
      sb.AppendLine("    </div>");
      sb.AppendLine("  </div>");
      
      if (!string.IsNullOrWhiteSpace(salida.Observacion))
      {
        sb.AppendLine($"  <div class=\"alert alert-warning\"><strong>Observación:</strong> {System.Net.WebUtility.HtmlEncode(salida.Observacion)}</div>");
      }
      
      sb.AppendLine("  <table class=\"table table-sm table-salida\">");
      sb.AppendLine("    <thead><tr><th>#</th><th>Código</th><th>Descripción</th><th>Lote</th><th>Vencimiento</th><th class=\"text-end\">Cantidad</th><th class=\"text-end\">Costo unit.</th><th class=\"text-end\">Costo total</th></tr></thead>");
      sb.AppendLine("    <tbody>");
      var idx = 0;
      foreach (var d in dets)
      {
        idx++;
        var desc = d.Producto?.Descripcion ?? $"Producto #{d.IdProducto}";
        var codigo = d.Producto?.CodigoInterno ?? "-";
        var costoTotal = d.Cantidad * (d.CostoUnitario ?? 0);
        var loteStr = !string.IsNullOrEmpty(d.NumeroLote) ? d.NumeroLote : "-";
        var vencStr = d.FechaVencimientoLote.HasValue ? d.FechaVencimientoLote.Value.ToString("dd/MM/yyyy") : "-";
        var esVencido = d.FechaVencimientoLote.HasValue && d.FechaVencimientoLote.Value.Date < DateTime.Today;
        var rowClass = esVencido ? "vencido" : "";
        
        sb.AppendLine($"      <tr class=\"{rowClass}\"><td>{idx}</td><td>{System.Net.WebUtility.HtmlEncode(codigo)}</td><td>{System.Net.WebUtility.HtmlEncode(desc)}</td><td><span class=\"badge bg-info\">{System.Net.WebUtility.HtmlEncode(loteStr)}</span></td><td class=\"{(esVencido ? "text-danger fw-bold" : "")}\">{vencStr}</td><td class=\"text-end\">{d.Cantidad:N2}</td><td class=\"text-end\">{(d.CostoUnitario ?? 0):N0}</td><td class=\"text-end\">{costoTotal:N0}</td></tr>");
      }
      sb.AppendLine("    </tbody>");
      sb.AppendLine("    <tfoot>");
      var totalCosto = dets.Sum(d => d.Cantidad * (d.CostoUnitario ?? 0));
      sb.AppendLine($"      <tr class=\"fw-bold\"><td colspan=\"7\" class=\"text-end text-danger\">TOTAL PÉRDIDA</td><td class=\"text-end text-danger\">{totalCosto:N0}</td></tr>");
      sb.AppendLine("    </tfoot>");
      sb.AppendLine("  </table>");
      
      // Sección de firmas
      sb.AppendLine("  <div class=\"row mt-5\">");
      sb.AppendLine("    <div class=\"col-4 text-center\">");
      sb.AppendLine("      <div style=\"border-top:1px solid #000;padding-top:5px;margin:0 20px;\">Responsable de Depósito</div>");
      sb.AppendLine("    </div>");
      sb.AppendLine("    <div class=\"col-4 text-center\">");
      sb.AppendLine("      <div style=\"border-top:1px solid #000;padding-top:5px;margin:0 20px;\">Supervisor</div>");
      sb.AppendLine("    </div>");
      sb.AppendLine("    <div class=\"col-4 text-center\">");
      sb.AppendLine("      <div style=\"border-top:1px solid #000;padding-top:5px;margin:0 20px;\">Gerencia</div>");
      sb.AppendLine("    </div>");
      sb.AppendLine("  </div>");
      
      sb.AppendLine("  <div class=\"text-center mt-4\" style=\"color:#dc3545;font-size:10px;\">** Comprobante de Salida de Stock - Uso Interno **</div>");
      sb.AppendLine("</div>");
      
      await JS.InvokeVoidAsync("printHtmlWithHead", head.ToString(), sb.ToString());
    }
    catch (Exception ex)
    {
      Console.Error.WriteLine($"Error al generar comprobante: {ex.Message}");
    }
  }

  private string ObtenerClaseMotivo(string motivo) => motivo switch
  {
    "Vencimiento" => "bg-danger",
    "Merma" => "bg-warning text-dark",
    "Rotura" => "bg-secondary",
    "Daño" => "bg-secondary",
    "Robo" => "bg-dark",
    "Donación" => "bg-info",
    "Muestrario" => "bg-primary",
    "Autoconsumo" => "bg-success",
    "Devolución Proveedor" => "bg-info",
    _ => "bg-secondary"
  };
  
  private string TruncarTexto(string? texto, int maxLength)
  {
    if (string.IsNullOrEmpty(texto)) return "";
    return texto.Length <= maxLength ? texto : texto.Substring(0, maxLength) + "...";
  }

  private class LineaVM
  {
    public int IdProducto { get; set; }
    public int? IdProductoLote { get; set; }
    public string CodigoInterno { get; set; } = string.Empty;
    public string Descripcion { get; set; } = string.Empty;
    public string? NumeroLote { get; set; }
    public DateTime? FechaVencimiento { get; set; }
    public decimal StockActual { get; set; }
    public decimal Cantidad { get; set; }
    public decimal CostoUnitario { get; set; }
    public decimal CostoTotal { get; set; }
    public string? ObservacionLinea { get; set; }
    
    public bool EstaVencido => FechaVencimiento.HasValue && FechaVencimiento.Value.Date < DateTime.Today;
    public bool EstaProximoAVencer => FechaVencimiento.HasValue 
        && FechaVencimiento.Value.Date >= DateTime.Today 
        && FechaVencimiento.Value.Date <= DateTime.Today.AddDays(30);
  }
}
