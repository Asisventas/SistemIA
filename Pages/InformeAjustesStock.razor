@page "/informes/ajustes-stock"
@using Microsoft.EntityFrameworkCore
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize]
@inject IDbContextFactory<SistemIA.Models.AppDbContext> DbFactory
@inject Microsoft.JSInterop.IJSRuntime JS
@inject SistemIA.Services.ISucursalProvider SucursalProvider
@inject NavigationManager Nav
@inject Microsoft.AspNetCore.Components.Authorization.AuthenticationStateProvider AuthStateProvider
@using ClosedXML.Excel

<PageProtection Modulo="/reportes" Permiso="VIEW">

<h3 class="mb-3">Listado de Ajustes de Stock</h3>

<div class="card mb-3">
  <div class="card-body">
    <div class="row g-3 align-items-end">
      <div class="col-md-1">
        <label class="form-label">ID</label>
        <input type="number" class="form-control" placeholder="#" @bind="fIdAjuste" min="1" />
      </div>
      <div class="col-md-2">
        <label class="form-label">Desde</label>
        <input type="date" class="form-control" @bind="fDesde" />
      </div>
      <div class="col-md-2">
        <label class="form-label">Hasta</label>
        <input type="date" class="form-control" @bind="fHasta" />
      </div>
      <div class="col-md-2">
        <label class="form-label">Producto</label>
        <input class="form-control" placeholder="Código/Nombre" @bind="fProducto" />
      </div>
      <div class="col-md-2">
        <label class="form-label">Depósito</label>
        <select class="form-select" @bind="fIdDeposito">
          <option value="0">Todos</option>
          @foreach (var d in depositos)
          {
            <option value="@d.IdDeposito">@d.Nombre</option>
          }
        </select>
      </div>
      <div class="col-md-2">
        <label class="form-label">Usuario</label>
        <input class="form-control" @bind="fUsuario" />
      </div>
    </div>
    <div class="row g-3 mt-1 align-items-end">
      <div class="col-md-2">
        <label class="form-label">Tipo diferencia</label>
        <select class="form-select" @bind="fTipoDiferencia">
          <option value="0">Todas</option>
          <option value="1">Sobrantes (+)</option>
          <option value="-1">Faltantes (-)</option>
        </select>
      </div>
      <div class="col-md-2">
        <label class="form-label">Caja desde</label>
        <input class="form-control" type="number" @bind-value="fCajaDesde" @bind-value:event="oninput" />
      </div>
      <div class="col-md-2">
        <label class="form-label">Caja hasta</label>
        <input class="form-control" type="number" @bind-value="fCajaHasta" @bind-value:event="oninput" />
      </div>
      <div class="col-md-2">
        <label class="form-label">Turno desde</label>
        <input class="form-control" type="number" @bind-value="fTurnoDesde" @bind-value:event="oninput" />
      </div>
      <div class="col-md-2">
        <label class="form-label">Turno hasta</label>
        <input class="form-control" type="number" @bind-value="fTurnoHasta" @bind-value:event="oninput" />
      </div>
      <div class="col-md-2 d-flex gap-2 justify-content-end">
        <button class="btn btn-primary" @onclick="Buscar"><i class="bi bi-search"></i> Buscar</button>
        <button class="btn btn-outline-success" title="Exportar CSV" @onclick="Exportar"><i class="bi bi-filetype-csv"></i></button>
        <button class="btn btn-success" title="Exportar XLSX" @onclick="ExportarXlsx"><i class="bi bi-file-earmark-excel"></i></button>
        <button class="btn btn-outline-secondary" @onclick="Imprimir"><i class="bi bi-printer"></i></button>
        <EnviarInformeCorreo 
          TituloInforme="Ajustes de Stock" 
          OnGenerarHtml="GenerarTablaHtml" 
          FiltrosAplicados="@ObtenerFiltrosTexto()" />
      </div>
    </div>
  </div>
</div>

<div class="card">
  <div class="card-body p-0">
    <div class="table-responsive">
      <table class="table table-sm table-hover align-middle mb-0">
        <thead class="table-light">
          <tr>
            <th style="width:50px;">ID</th>
            <th>Fecha</th>
            <th>Producto</th>
            <th>Depósito</th>
            <th class="text-end">Stock Sistema</th>
            <th class="text-end">Stock Ajuste</th>
            <th class="text-end">Diferencia</th>
            <th class="text-end">Monto</th>
            <th>Comentario</th>
            <th>Usuario</th>
            <th>Caja</th>
            <th>Turno</th>
          </tr>
        </thead>
        <tbody>
          @if (!filas.Any())
          {
            <tr><td colspan="12" class="text-muted text-center py-3">Sin resultados</td></tr>
          }
          else
          {
            foreach (var r in filas)
            {
              var colorDif = r.Diferencia > 0 ? "text-success" : (r.Diferencia < 0 ? "text-danger" : "");
              var iconDif = r.Diferencia > 0 ? "bi-arrow-up-circle-fill" : (r.Diferencia < 0 ? "bi-arrow-down-circle-fill" : "bi-dash-circle");
              <tr>
                <td>@r.IdAjuste</td>
                <td>@r.Fecha.ToString("dd/MM/yyyy HH:mm")</td>
                <td>
                  <div class="fw-semibold">@r.Producto</div>
                  <div class="small text-muted">Cod: @r.Codigo</div>
                </td>
                <td>@r.Deposito</td>
                <td class="text-end">@r.StockSistema.ToString("N2")</td>
                <td class="text-end">@r.StockAjuste.ToString("N2")</td>
                <td class="text-end @colorDif">
                  <i class="bi @iconDif me-1"></i>@r.Diferencia.ToString("N2")
                </td>
                <td class="text-end @colorDif">@r.Monto.ToString("N0")</td>
                <td class="small">@(string.IsNullOrEmpty(r.Comentario) ? "-" : r.Comentario)</td>
                <td>@r.Usuario</td>
                <td>@(r.IdCaja?.ToString() ?? "-")</td>
                <td>@(r.Turno?.ToString() ?? "-")</td>
              </tr>
            }
          }
        </tbody>
        <tfoot>
          <tr class="table-secondary fw-bold">
            <th colspan="4" class="text-end">Totales</th>
            <th class="text-end">@filas.Sum(x=>x.StockSistema).ToString("N2")</th>
            <th class="text-end">@filas.Sum(x=>x.StockAjuste).ToString("N2")</th>
            <th class="text-end @(filas.Sum(x=>x.Diferencia) >= 0 ? "text-success" : "text-danger")">@filas.Sum(x=>x.Diferencia).ToString("N2")</th>
            <th class="text-end @(filas.Sum(x=>x.Monto) >= 0 ? "text-success" : "text-danger")">@filas.Sum(x=>x.Monto).ToString("N0")</th>
            <th colspan="4"></th>
          </tr>
          <tr class="small text-muted">
            <td colspan="12">
              <i class="bi bi-arrow-up-circle-fill text-success me-1"></i> Sobrantes: @filas.Where(x=>x.Diferencia>0).Sum(x=>x.Diferencia).ToString("N2") unidades (@filas.Where(x=>x.Diferencia>0).Sum(x=>x.Monto).ToString("N0") Gs)
              &nbsp;&nbsp;|&nbsp;&nbsp;
              <i class="bi bi-arrow-down-circle-fill text-danger me-1"></i> Faltantes: @filas.Where(x=>x.Diferencia<0).Sum(x=>x.Diferencia).ToString("N2") unidades (@filas.Where(x=>x.Diferencia<0).Sum(x=>x.Monto).ToString("N0") Gs)
            </td>
          </tr>
        </tfoot>
      </table>
    </div>
  </div>
</div>

</PageProtection>

@code {
  private int? fIdAjuste;
  private DateTime? fDesde;
  private DateTime? fHasta;
  private string? fProducto;
  private int fIdDeposito = 0;
  private string? fUsuario;
  private int fTipoDiferencia = 0; // 0=todas, 1=sobrantes, -1=faltantes
  private int? fCajaDesde;
  private int? fCajaHasta;
  private int? fTurnoDesde;
  private int? fTurnoHasta;

  private List<SistemIA.Models.Deposito> depositos = new();
  private List<Fila> filas = new();

  protected override async Task OnInitializedAsync()
  {
    var sucId = SucursalProvider.GetSucursalId();
    if (!sucId.HasValue)
    {
      var ret = System.Net.WebUtility.UrlEncode(Nav.Uri);
      Nav.NavigateTo($"/seleccionar-sucursal?returnUrl={ret}", forceLoad: true);
      return;
    }

    await using var ctx = await DbFactory.CreateDbContextAsync();
    
    // Obtener fecha de caja como predeterminada
    var caja = await ctx.Cajas.AsNoTracking().FirstOrDefaultAsync(c => c.CajaActual == 1);
    var fechaCaja = caja?.FechaActualCaja ?? DateTime.Today;
    fDesde = fechaCaja;
    fHasta = fechaCaja;
    
    depositos = await ctx.Depositos.AsNoTracking().OrderBy(d=>d.Nombre).ToListAsync();
    
    await Buscar();
  }

  private async Task Buscar()
  {
    await using var ctx = await DbFactory.CreateDbContextAsync();

    var q = from d in ctx.AjustesStockDetalles.AsNoTracking()
            join a in ctx.AjustesStock.AsNoTracking() on d.IdAjusteStock equals a.IdAjusteStock
            join p in ctx.Productos.AsNoTracking() on d.IdProducto equals p.IdProducto
            join dep in ctx.Depositos.AsNoTracking() on d.IdDeposito equals dep.IdDeposito into depJoin
            from dep in depJoin.DefaultIfEmpty()
            select new {
              a.IdAjusteStock,
              d.FechaAjuste,
              a.Comentario,
              d.IdSucursal,
              d.IdCaja,
              d.Turno,
              d.Usuario,
              d.StockSistema,
              d.StockAjuste,
              d.Diferencia,
              d.Monto,
              p.Descripcion,
              p.CodigoInterno,
              d.IdDeposito,
              Deposito = dep != null ? dep.Nombre : ""
            };

    // Filtrar por sucursal
    var sucSel = SucursalProvider.GetSucursalId();
    if (sucSel.HasValue)
      q = q.Where(x => x.IdSucursal == sucSel.Value);

    if (fIdAjuste.HasValue) q = q.Where(x => x.IdAjusteStock == fIdAjuste.Value);
    if (fDesde.HasValue) q = q.Where(x => x.FechaAjuste >= fDesde.Value);
    if (fHasta.HasValue) q = q.Where(x => x.FechaAjuste < fHasta.Value.AddDays(1));
    if (!string.IsNullOrWhiteSpace(fProducto))
    {
      var t = fProducto!.Trim();
      q = q.Where(x => (x.Descripcion ?? "").Contains(t) || (x.CodigoInterno ?? "").Contains(t));
    }
    if (fIdDeposito != 0) q = q.Where(x => x.IdDeposito == fIdDeposito);
    if (!string.IsNullOrWhiteSpace(fUsuario))
    {
      var t = fUsuario!.Trim();
      q = q.Where(x => (x.Usuario ?? "").Contains(t));
    }
    if (fTipoDiferencia == 1) q = q.Where(x => x.Diferencia > 0);
    else if (fTipoDiferencia == -1) q = q.Where(x => x.Diferencia < 0);
    if (fCajaDesde.HasValue) q = q.Where(x => (x.IdCaja ?? int.MinValue) >= fCajaDesde.Value);
    if (fCajaHasta.HasValue) q = q.Where(x => (x.IdCaja ?? int.MaxValue) <= fCajaHasta.Value);
    if (fTurnoDesde.HasValue) q = q.Where(x => (x.Turno ?? int.MinValue) >= fTurnoDesde.Value);
    if (fTurnoHasta.HasValue) q = q.Where(x => (x.Turno ?? int.MaxValue) <= fTurnoHasta.Value);

    var data = await q.OrderByDescending(x => x.FechaAjuste).ThenByDescending(x => x.IdAjusteStock).Take(5000).ToListAsync();

    filas = data.Select(x => new Fila {
      IdAjuste = x.IdAjusteStock,
      Fecha = x.FechaAjuste,
      Producto = x.Descripcion ?? "",
      Codigo = x.CodigoInterno ?? "",
      Deposito = x.Deposito ?? "",
      StockSistema = x.StockSistema,
      StockAjuste = x.StockAjuste,
      Diferencia = x.Diferencia,
      Monto = x.Monto,
      Comentario = x.Comentario ?? "",
      Usuario = x.Usuario ?? "",
      IdCaja = x.IdCaja,
      Turno = x.Turno
    }).ToList();
  }

  private async Task Imprimir()
  {
    if (!filas.Any()) return;

    var head = new System.Text.StringBuilder();
    head.AppendLine("<meta charset=\"utf-8\"/>");
    head.AppendLine("<title>Listado Ajustes de Stock</title>");
    head.AppendLine("<link rel=\"stylesheet\" href=\"/css/bootstrap/bootstrap.min.css\" />");
    head.AppendLine("<style>");
    head.AppendLine("@media print { @page { size: A4 landscape; margin: 10mm 10mm; } }");
    head.AppendLine("body{font-size:11px;color:#111;}");
    head.AppendLine(".factura-header{display:flex;align-items:center;gap:16px;border-bottom:2px solid #222;padding-bottom:8px;margin-bottom:12px;}");
    head.AppendLine(".factura-header .logo{max-width:120px;max-height:60px;object-fit:contain;display:block;border-radius:6px;border:1px solid #e5e7eb;background:#fff;padding:6px;}");
    head.AppendLine(".factura-header .logo-wrap{width:140px;display:flex;align-items:center;justify-content:center;}");
    head.AppendLine(".factura-header .empresa h2{margin:0;font-size:18px;}");
    head.AppendLine(".factura-header .empresa .small{color:#555;}");
    head.AppendLine(".tabla th,.tabla td{padding:.35rem;border-bottom:1px solid #e5e7eb;vertical-align:top;}");
    head.AppendLine(".right{text-align:right}");
    head.AppendLine(".muted{color:#666}");
    head.AppendLine(".text-success{color:#198754!important}");
    head.AppendLine(".text-danger{color:#dc3545!important}");
    head.AppendLine("</style>");

    await using var ctx = await DbFactory.CreateDbContextAsync();
    var suc = await ctx.Sucursal.AsNoTracking().OrderBy(s=>s.Id).FirstOrDefaultAsync();
    var sucIdSel = SucursalProvider.GetSucursalId();
    if (sucIdSel.HasValue)
    {
      var s2 = await ctx.Sucursal.AsNoTracking().FirstOrDefaultAsync(s => s.Id == sucIdSel.Value);
      if (s2 != null) suc = s2;
    }
    string empresa = suc?.NombreEmpresa ?? "Empresa";
    string sucursal = suc?.NombreSucursal ?? "Sucursal";
    string ruc = suc != null ? $"{suc.RUC}-{suc.DV}" : "";
    string? logoDataUri = null;
    if (suc?.Logo != null && suc.Logo.Length>0) logoDataUri = $"data:image/png;base64,{Convert.ToBase64String(suc.Logo)}";

    var filtros = System.Net.WebUtility.HtmlEncode($"Depósito: {(fIdDeposito==0?"Todos":depositos.FirstOrDefault(d=>d.IdDeposito==fIdDeposito)?.Nombre)} | Prod: {fProducto} | Usu: {fUsuario} | Tipo: {(fTipoDiferencia==0?"Todas":(fTipoDiferencia==1?"Sobrantes":"Faltantes"))} | Caja: {fCajaDesde}-{fCajaHasta} | Turno: {fTurnoDesde}-{fTurnoHasta}");

    var sb = new System.Text.StringBuilder();
    sb.AppendLine("<div class=\"container-fluid\">");
    sb.AppendLine("  <div class=\"factura-header\">");
    sb.AppendLine("    <div class=\"logo-wrap\">");
    if (!string.IsNullOrEmpty(logoDataUri)) sb.AppendLine($"      <img class=\"logo\" src=\"{logoDataUri}\" alt=\"Logo\"/>");
    else sb.AppendLine("      <div class=\"logo d-flex align-items-center justify-content-center\" style=\"font-size:10px;color:#999;min-height:40px;min-width:100px;\">LOGO</div>");
    sb.AppendLine("    </div>");
    sb.AppendLine("    <div class=\"empresa\">");
    sb.AppendLine($"      <h2>{empresa}</h2>");
    sb.AppendLine($"      <div class=\"small\">RUC: {ruc}</div>");
    sb.AppendLine($"      <div class=\"small\">{sucursal}</div>");
    sb.AppendLine("    </div>");
    sb.AppendLine("    <div class=\"ms-auto text-end\">");
    sb.AppendLine("      <div class=\"fw-bold\" style=\"font-size:18px\">Listado Ajustes de Stock</div>");
    sb.AppendLine($"      <div>Desde: {fDesde:dd/MM/yyyy} &nbsp; Hasta: {fHasta:dd/MM/yyyy}</div>");
    sb.AppendLine($"      <div class=\"small muted\">{filtros}</div>");
    sb.AppendLine("    </div>");
    sb.AppendLine("  </div>");

    sb.AppendLine("  <table class=\"table table-sm tabla\">");
    sb.AppendLine("    <thead><tr><th>#</th><th>Fecha</th><th>Producto</th><th>Depósito</th><th class='right'>Stock Sistema</th><th class='right'>Stock Ajuste</th><th class='right'>Diferencia</th><th class='right'>Monto</th><th>Comentario</th><th>Usu</th><th>Caja</th><th>Turno</th></tr></thead>");
    sb.AppendLine("    <tbody>");
    int n = 0;
    foreach (var r in filas)
    {
      var colorDif = r.Diferencia > 0 ? "text-success" : (r.Diferencia < 0 ? "text-danger" : "");
      sb.AppendLine($"      <tr><td>{++n}</td><td>{r.Fecha:dd/MM/yyyy HH:mm}</td><td>{System.Net.WebUtility.HtmlEncode(r.Producto)}<br/><small class='muted'>Cod: {r.Codigo}</small></td><td>{System.Net.WebUtility.HtmlEncode(r.Deposito)}</td><td class='right'>{r.StockSistema:N2}</td><td class='right'>{r.StockAjuste:N2}</td><td class='right {colorDif}'>{r.Diferencia:N2}</td><td class='right {colorDif}'>{r.Monto:N0}</td><td>{System.Net.WebUtility.HtmlEncode(r.Comentario)}</td><td>{System.Net.WebUtility.HtmlEncode(r.Usuario)}</td><td>{(r.IdCaja?.ToString() ?? "-")}</td><td>{(r.Turno?.ToString() ?? "-")}</td></tr>");
    }
    sb.AppendLine("    </tbody>");
    var colorTotal = filas.Sum(x=>x.Diferencia) >= 0 ? "text-success" : "text-danger";
    sb.AppendLine($"    <tfoot><tr><th colspan='4' class='right'>Totales</th><th class='right'>{filas.Sum(x=>x.StockSistema):N2}</th><th class='right'>{filas.Sum(x=>x.StockAjuste):N2}</th><th class='right {colorTotal}'>{filas.Sum(x=>x.Diferencia):N2}</th><th class='right {colorTotal}'>{filas.Sum(x=>x.Monto):N0}</th><th colspan='4'></th></tr></tfoot>");
    sb.AppendLine("  </table>");
    sb.AppendLine($"  <p class='small muted'>Sobrantes: {filas.Where(x=>x.Diferencia>0).Sum(x=>x.Diferencia):N2} u ({filas.Where(x=>x.Diferencia>0).Sum(x=>x.Monto):N0} Gs) &nbsp;|&nbsp; Faltantes: {filas.Where(x=>x.Diferencia<0).Sum(x=>x.Diferencia):N2} u ({filas.Where(x=>x.Diferencia<0).Sum(x=>x.Monto):N0} Gs)</p>");
    sb.AppendLine("</div>");

    await JS.InvokeVoidAsync("printHtmlWithHead", head.ToString(), sb.ToString());
  }

  private async Task Exportar()
  {
    if (!filas.Any()) return;
    var sep = ';';
    var sb = new System.Text.StringBuilder();
    var auth = await AuthStateProvider.GetAuthenticationStateAsync();
    var usuario = auth.User?.Identity?.Name ?? "";
    var suc = SucursalProvider.GetSucursalNombre() ?? "";
    sb.AppendLine($"Generado={DateTime.Now:yyyy-MM-dd HH:mm};Usuario={usuario};Sucursal={suc}");
    sb.AppendLine(string.Join(sep, new[]{"Nro","ID Ajuste","Fecha","Producto","Código","Depósito","Stock Sistema","Stock Ajuste","Diferencia","Monto","Comentario","Usuario","Caja","Turno"}));
    int n=0;
    foreach (var r in filas)
    {
      string[] cols = new[]
      {
        (++n).ToString(),
        r.IdAjuste.ToString(),
        r.Fecha.ToString("yyyy-MM-dd HH:mm"),
        r.Producto,
        r.Codigo,
        r.Deposito,
        r.StockSistema.ToString(System.Globalization.CultureInfo.InvariantCulture),
        r.StockAjuste.ToString(System.Globalization.CultureInfo.InvariantCulture),
        r.Diferencia.ToString(System.Globalization.CultureInfo.InvariantCulture),
        r.Monto.ToString(System.Globalization.CultureInfo.InvariantCulture),
        r.Comentario,
        r.Usuario,
        r.IdCaja?.ToString() ?? "",
        r.Turno?.ToString() ?? ""
      };
      var line = string.Join(sep, cols.Select(v => !string.IsNullOrEmpty(v) && (v.Contains(sep) || v.Contains('"') || v.Contains('\n')) ? $"\"{v.Replace("\"","\"\"")}\"" : v ?? ""));
      sb.AppendLine(line);
    }
    var utf8bom = new System.Text.UTF8Encoding(encoderShouldEmitUTF8Identifier: true);
    var bytes = utf8bom.GetBytes(sb.ToString());
    var b64 = Convert.ToBase64String(bytes);
    var file = $"AjustesStock_{DateTime.Now:yyyyMMdd_HHmmss}.csv";
    await JS.InvokeVoidAsync("downloadFile", b64, file, "text/csv;charset=utf-8");
  }

  private async Task ExportarXlsx()
  {
    if (!filas.Any()) return;
    var auth = await AuthStateProvider.GetAuthenticationStateAsync();
    var usuario = auth.User?.Identity?.Name ?? "";
    var suc = SucursalProvider.GetSucursalNombre() ?? "";

    using var wb = new XLWorkbook();
    var ws = wb.AddWorksheet("AjustesStock");
    int row = 1;
    ws.Cell(row, 1).Value = "Generado"; ws.Cell(row, 2).Value = DateTime.Now; ws.Cell(row, 2).Style.DateFormat.Format = "yyyy-MM-dd HH:mm"; row++;
    ws.Cell(row, 1).Value = "Usuario"; ws.Cell(row, 2).Value = usuario; row++;
    ws.Cell(row, 1).Value = "Sucursal"; ws.Cell(row, 2).Value = suc; row += 2;

    var headers = new[]{"#","ID Ajuste","Fecha","Producto","Código","Depósito","Stock Sistema","Stock Ajuste","Diferencia","Monto","Comentario","Usuario","Caja","Turno"};
    for (int c=0;c<headers.Length;c++) ws.Cell(row, c+1).Value = headers[c];
    ws.Range(row,1,row,headers.Length).Style.Font.Bold = true; row++;

    int n = 0;
    decimal totalStockSistema = 0, totalStockAjuste = 0, totalDif = 0, totalMonto = 0;
    foreach (var r in filas)
    {
      ws.Cell(row,1).Value = ++n;
      ws.Cell(row,2).Value = r.IdAjuste;
      ws.Cell(row,3).Value = r.Fecha; ws.Cell(row,3).Style.DateFormat.Format = "yyyy-MM-dd HH:mm";
      ws.Cell(row,4).Value = r.Producto;
      ws.Cell(row,5).Value = r.Codigo;
      ws.Cell(row,6).Value = r.Deposito;
      ws.Cell(row,7).Value = r.StockSistema; ws.Cell(row,7).Style.NumberFormat.Format = "#,##0.00";
      ws.Cell(row,8).Value = r.StockAjuste; ws.Cell(row,8).Style.NumberFormat.Format = "#,##0.00";
      ws.Cell(row,9).Value = r.Diferencia; ws.Cell(row,9).Style.NumberFormat.Format = "#,##0.00";
      if (r.Diferencia > 0) ws.Cell(row,9).Style.Font.FontColor = XLColor.Green;
      else if (r.Diferencia < 0) ws.Cell(row,9).Style.Font.FontColor = XLColor.Red;
      ws.Cell(row,10).Value = r.Monto; ws.Cell(row,10).Style.NumberFormat.Format = "#,##0";
      if (r.Monto > 0) ws.Cell(row,10).Style.Font.FontColor = XLColor.Green;
      else if (r.Monto < 0) ws.Cell(row,10).Style.Font.FontColor = XLColor.Red;
      ws.Cell(row,11).Value = r.Comentario;
      ws.Cell(row,12).Value = r.Usuario;
      ws.Cell(row,13).Value = r.IdCaja;
      ws.Cell(row,14).Value = r.Turno;
      totalStockSistema += r.StockSistema;
      totalStockAjuste += r.StockAjuste;
      totalDif += r.Diferencia;
      totalMonto += r.Monto;
      row++;
    }

    ws.Cell(row,6).Value = "Totales"; ws.Cell(row,6).Style.Font.Bold = true;
    ws.Cell(row,7).Value = totalStockSistema; ws.Cell(row,7).Style.NumberFormat.Format = "#,##0.00"; ws.Cell(row,7).Style.Font.Bold = true;
    ws.Cell(row,8).Value = totalStockAjuste; ws.Cell(row,8).Style.NumberFormat.Format = "#,##0.00"; ws.Cell(row,8).Style.Font.Bold = true;
    ws.Cell(row,9).Value = totalDif; ws.Cell(row,9).Style.NumberFormat.Format = "#,##0.00"; ws.Cell(row,9).Style.Font.Bold = true;
    ws.Cell(row,10).Value = totalMonto; ws.Cell(row,10).Style.NumberFormat.Format = "#,##0"; ws.Cell(row,10).Style.Font.Bold = true;
    ws.Columns().AdjustToContents();
    using var ms = new System.IO.MemoryStream();
    wb.SaveAs(ms);
    var b64 = Convert.ToBase64String(ms.ToArray());
    var file = $"AjustesStock_{DateTime.Now:yyyyMMdd_HHmmss}.xlsx";
    await JS.InvokeVoidAsync("downloadFile", b64, file, "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet");
  }

  private class Fila
  {
    public int IdAjuste { get; set; }
    public DateTime Fecha { get; set; }
    public string Producto { get; set; } = string.Empty;
    public string Codigo { get; set; } = string.Empty;
    public string Deposito { get; set; } = string.Empty;
    public decimal StockSistema { get; set; }
    public decimal StockAjuste { get; set; }
    public decimal Diferencia { get; set; }
    public decimal Monto { get; set; }
    public string Comentario { get; set; } = string.Empty;
    public string Usuario { get; set; } = string.Empty;
    public int? IdCaja { get; set; }
    public int? Turno { get; set; }
  }

  private string ObtenerFiltrosTexto()
  {
    var filtros = new List<string>();
    if (fDesde.HasValue) filtros.Add($"Desde: {fDesde:dd/MM/yyyy}");
    if (fHasta.HasValue) filtros.Add($"Hasta: {fHasta:dd/MM/yyyy}");
    if (fIdDeposito > 0) filtros.Add($"Depósito: {depositos.FirstOrDefault(d => d.IdDeposito == fIdDeposito)?.Nombre}");
    if (!string.IsNullOrWhiteSpace(fProducto)) filtros.Add($"Producto: {fProducto}");
    if (!string.IsNullOrWhiteSpace(fUsuario)) filtros.Add($"Usuario: {fUsuario}");
    if (fTipoDiferencia != 0) filtros.Add($"Tipo: {(fTipoDiferencia == 1 ? "Sobrantes" : "Faltantes")}");
    return string.Join(" | ", filtros);
  }

  private Task<string> GenerarTablaHtml()
  {
    if (!filas.Any()) return Task.FromResult("<p>Sin datos para mostrar</p>");
    var sb = new System.Text.StringBuilder();
    sb.AppendLine("<table border='1' cellpadding='5' cellspacing='0' style='border-collapse:collapse;width:100%;font-size:12px;'>");
    sb.AppendLine("<thead><tr style='background:#f0f0f0;'><th>#</th><th>Fecha</th><th>Producto</th><th>Código</th><th>Depósito</th><th style='text-align:right'>Stock Sistema</th><th style='text-align:right'>Stock Ajuste</th><th style='text-align:right'>Diferencia</th><th style='text-align:right'>Monto</th><th>Usuario</th></tr></thead>");
    sb.AppendLine("<tbody>");
    int n = 0;
    foreach (var r in filas)
    {
      var colorDif = r.Diferencia > 0 ? "color:green" : (r.Diferencia < 0 ? "color:red" : "");
      sb.AppendLine($"<tr><td>{++n}</td><td>{r.Fecha:dd/MM/yyyy HH:mm}</td><td>{System.Net.WebUtility.HtmlEncode(r.Producto)}</td><td>{r.Codigo}</td><td>{System.Net.WebUtility.HtmlEncode(r.Deposito)}</td><td style='text-align:right'>{r.StockSistema:N2}</td><td style='text-align:right'>{r.StockAjuste:N2}</td><td style='text-align:right;{colorDif}'>{r.Diferencia:N2}</td><td style='text-align:right;{colorDif}'>{r.Monto:N0}</td><td>{System.Net.WebUtility.HtmlEncode(r.Usuario)}</td></tr>");
    }
    sb.AppendLine("</tbody>");
    var totalColor = filas.Sum(x => x.Diferencia) >= 0 ? "color:green" : "color:red";
    sb.AppendLine($"<tfoot><tr style='background:#e0e0e0;font-weight:bold;'><td colspan='5'>Totales</td><td style='text-align:right'>{filas.Sum(x => x.StockSistema):N2}</td><td style='text-align:right'>{filas.Sum(x => x.StockAjuste):N2}</td><td style='text-align:right;{totalColor}'>{filas.Sum(x => x.Diferencia):N2}</td><td style='text-align:right;{totalColor}'>{filas.Sum(x => x.Monto):N0}</td><td></td></tr></tfoot>");
    sb.AppendLine("</table>");
    sb.AppendLine($"<p style='margin-top:10px;font-size:11px;'>Sobrantes: {filas.Where(x => x.Diferencia > 0).Sum(x => x.Diferencia):N2} uds | Faltantes: {filas.Where(x => x.Diferencia < 0).Sum(x => x.Diferencia):N2} uds</p>");
    return Task.FromResult(sb.ToString());
  }
}
