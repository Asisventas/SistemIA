@page "/asistente-ia"
@using SistemIA.Models.AsistenteIA
@using SistemIA.Services
@using Microsoft.AspNetCore.Components.Server.ProtectedBrowserStorage
@inject IAsistenteIAService AsistenteService
@inject AppDbContext _context
@inject ProtectedSessionStorage SessionStorage
@inject NavigationManager NavigationManager

<PageTitle>Asistente IA - SistemIA</PageTitle>

<SaProtection TituloPagina="Asistente IA" UrlRetorno="/">
<div class="container-fluid py-4">
    <div class="row">
        @* Panel principal del chat *@
        <div class="col-lg-8">
            <div class="card shadow-sm border-0" style="height: calc(100vh - 160px);">
                <div class="card-header bg-gradient text-white py-3" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                    <div class="d-flex align-items-center">
                        <div class="avatar-grande me-3">
                            <i class="bi bi-robot"></i>
                        </div>
                        <div>
                            <h4 class="mb-0">Asistente SistemIA</h4>
                            <small class="opacity-75">Tu ayudante inteligente para el sistema</small>
                        </div>
                        <div class="ms-auto">
                            <span class="badge bg-success"><i class="bi bi-circle-fill me-1" style="font-size: 0.5rem;"></i>En línea</span>
                        </div>
                    </div>
                </div>

                <div class="card-body p-0 d-flex flex-column" style="height: calc(100% - 70px);">
                    @* Área de mensajes *@
                    <div class="mensajes-area flex-grow-1 p-4" style="overflow-y: auto; background: var(--bg-page);">
                        @foreach (var msg in mensajes)
                        {
                            <div class="mensaje-wrapper @(msg.EsUsuario ? "justify-content-end" : "justify-content-start") d-flex mb-3">
                                @if (!msg.EsUsuario)
                                {
                                    <div class="avatar-chat me-2">
                                        <i class="bi bi-robot"></i>
                                    </div>
                                }
                                <div class="mensaje-contenido @(msg.EsUsuario ? "usuario" : "asistente")">
                                    <div class="mensaje-texto">
                                        @((MarkupString)FormatearMensaje(msg.Texto))
                                    </div>
                                    @if (msg.RutaNavegacion != null)
                                    {
                                        <button class="btn btn-sm btn-outline-primary mt-2" @onclick="() => Navegar(msg.RutaNavegacion)">
                                            <i class="bi @(msg.Icono ?? "bi-arrow-right") me-1"></i>Ir a @ObtenerNombreRuta(msg.RutaNavegacion)
                                        </button>
                                    }
                                    @if (msg.Sugerencias?.Any() == true)
                                    {
                                        <div class="sugerencias-lista mt-2">
                                            @foreach (var sug in msg.Sugerencias.Take(4))
                                            {
                                                <button class="btn btn-sm btn-light me-1 mb-1" @onclick="() => UsarSugerencia(sug)">
                                                    <i class="bi bi-chat-dots me-1"></i>@sug
                                                </button>
                                            }
                                        </div>
                                    }
                                    <small class="mensaje-hora d-block mt-1">@msg.Hora.ToString("HH:mm")</small>
                                </div>
                                @if (msg.EsUsuario)
                                {
                                    <div class="avatar-chat usuario ms-2">
                                        <i class="bi bi-person"></i>
                                    </div>
                                }
                            </div>
                        }
                        @if (escribiendo)
                        {
                            <div class="mensaje-wrapper d-flex mb-3">
                                <div class="avatar-chat me-2">
                                    <i class="bi bi-robot"></i>
                                </div>
                                <div class="mensaje-contenido asistente">
                                    <div class="escribiendo-indicador">
                                        <span></span><span></span><span></span>
                                    </div>
                                </div>
                            </div>
                        }
                    </div>

                    @* Input de mensaje *@
                    <div class="input-area p-3 border-top">
                        <div class="input-group">
                            <input type="text" 
                                   class="form-control form-control-lg rounded-pill pe-5" 
                                   placeholder="Escribe tu pregunta aquí..."
                                   @bind="consultaActual"
                                   @bind:event="oninput"
                                   @onkeypress="OnKeyPress"
                                   disabled="@enviando" />
                            <button class="btn btn-primary rounded-pill ms-2 px-4" 
                                    @onclick="EnviarConsulta" 
                                    disabled="@(enviando || string.IsNullOrWhiteSpace(consultaActual))">
                                <i class="bi bi-send me-1"></i>Enviar
                            </button>
                        </div>
                        <div class="text-center mt-2">
                            <small class="text-muted">
                                <i class="bi bi-info-circle me-1"></i>
                                Puedo ayudarte con ventas, compras, stock, SIFEN, caja y más
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        @* Panel lateral - Información y ayuda rápida *@
        <div class="col-lg-4">
            @* Tarjeta de capacidades *@
            <div class="card shadow-sm border-0 mb-3">
                <div class="card-header bg-light">
                    <h6 class="mb-0"><i class="bi bi-lightbulb me-2 text-warning"></i>¿Qué puedo hacer?</h6>
                </div>
                <div class="card-body">
                    <div class="capacidad-item mb-3">
                        <div class="d-flex align-items-center">
                            <div class="icono-capacidad bg-primary-subtle text-primary">
                                <i class="bi bi-question-circle"></i>
                            </div>
                            <div class="ms-3">
                                <strong>Responder consultas</strong>
                                <p class="mb-0 small text-muted">Sobre cómo usar el sistema</p>
                            </div>
                        </div>
                    </div>
                    <div class="capacidad-item mb-3">
                        <div class="d-flex align-items-center">
                            <div class="icono-capacidad bg-success-subtle text-success">
                                <i class="bi bi-signpost-2"></i>
                            </div>
                            <div class="ms-3">
                                <strong>Navegación rápida</strong>
                                <p class="mb-0 small text-muted">Te llevo a cualquier módulo</p>
                            </div>
                        </div>
                    </div>
                    <div class="capacidad-item mb-3">
                        <div class="d-flex align-items-center">
                            <div class="icono-capacidad bg-info-subtle text-info">
                                <i class="bi bi-graph-up"></i>
                            </div>
                            <div class="ms-3">
                                <strong>Informes</strong>
                                <p class="mb-0 small text-muted">Accede a reportes fácilmente</p>
                            </div>
                        </div>
                    </div>
                    <div class="capacidad-item">
                        <div class="d-flex align-items-center">
                            <div class="icono-capacidad bg-warning-subtle text-warning">
                                <i class="bi bi-bookmark-star"></i>
                            </div>
                            <div class="ms-3">
                                <strong>Consejos</strong>
                                <p class="mb-0 small text-muted">Tips para usar mejor el sistema</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            @* Preguntas frecuentes *@
            <div class="card shadow-sm border-0 mb-3">
                <div class="card-header bg-light">
                    <h6 class="mb-0"><i class="bi bi-chat-square-text me-2 text-primary"></i>Preguntas frecuentes</h6>
                </div>
                <div class="card-body p-0">
                    <div class="list-group list-group-flush">
                        @foreach (var pregunta in preguntasFrecuentes)
                        {
                            <button class="list-group-item list-group-item-action d-flex align-items-center" 
                                    @onclick="() => UsarSugerencia(pregunta)">
                                <i class="bi bi-chevron-right text-primary me-2"></i>
                                @pregunta
                            </button>
                        }
                    </div>
                </div>
            </div>

            @* Estadísticas (para desarrollador) *@
            @if (esAdmin)
            {
                <div class="card shadow-sm border-0">
                    <div class="card-header bg-light">
                        <h6 class="mb-0"><i class="bi bi-bar-chart me-2 text-secondary"></i>Estadísticas (Admin)</h6>
                    </div>
                    <div class="card-body">
                        <div class="row text-center">
                            <div class="col-6 mb-2">
                                <div class="h4 mb-0 text-primary">@totalConversaciones</div>
                                <small class="text-muted">Consultas hoy</small>
                            </div>
                            <div class="col-6 mb-2">
                                <div class="h4 mb-0 text-danger">@totalErrores</div>
                                <small class="text-muted">Errores recientes</small>
                            </div>
                        </div>
                        <hr />
                        <button class="btn btn-outline-secondary btn-sm w-100" @onclick="VerErrores">
                            <i class="bi bi-bug me-1"></i>Ver registro de errores
                        </button>
                    </div>
                </div>
            }
        </div>
    </div>
</div>

<style>
    .avatar-grande {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.2);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
    }

    .avatar-chat {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
    }

    .avatar-chat.usuario {
        background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
    }

    .mensaje-contenido {
        max-width: 70%;
    }

    .mensaje-texto {
        padding: 12px 16px;
        border-radius: 18px;
        background: var(--bg-surface, white);
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        line-height: 1.5;
    }

    .mensaje-contenido.asistente .mensaje-texto {
        border-top-left-radius: 4px;
    }

    .mensaje-contenido.usuario .mensaje-texto {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-top-right-radius: 4px;
    }

    .mensaje-hora {
        font-size: 0.7rem;
        color: var(--text-muted, #888);
    }

    .mensaje-contenido.usuario .mensaje-hora {
        text-align: right;
    }

    .escribiendo-indicador {
        display: flex;
        gap: 4px;
        padding: 12px 16px;
    }

    .escribiendo-indicador span {
        width: 8px;
        height: 8px;
        background: #667eea;
        border-radius: 50%;
        animation: bounce 1.4s infinite ease-in-out both;
    }

    .escribiendo-indicador span:nth-child(1) { animation-delay: -0.32s; }
    .escribiendo-indicador span:nth-child(2) { animation-delay: -0.16s; }

    @@keyframes bounce {
        0%, 80%, 100% { transform: scale(0); }
        40% { transform: scale(1); }
    }

    .icono-capacidad {
        width: 40px;
        height: 40px;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.1rem;
    }

    .sugerencias-lista .btn {
        font-size: 0.8rem;
        border-radius: 20px;
    }

    .list-group-item-action:hover {
        background-color: var(--bg-page, #f8f9fa);
    }
</style>
</SaProtection>

@code {
    private string consultaActual = "";
    private bool enviando = false;
    private bool escribiendo = false;
    private string nombreUsuario = "Usuario";
    private int? idUsuario;
    private bool esAdmin = false;
    private int totalConversaciones = 0;
    private int totalErrores = 0;
    
    private List<MensajeChat> mensajes = new();

    private List<string> preguntasFrecuentes = new()
    {
        "¿Cómo crear una venta?",
        "¿Cómo funciona SIFEN?",
        "¿Cómo cerrar la caja?",
        "¿Cómo agregar un producto?",
        "¿Cómo ver el stock?",
        "¿Cómo crear una nota de crédito?"
    };

    private class MensajeChat
    {
        public string Texto { get; set; } = "";
        public bool EsUsuario { get; set; }
        public DateTime Hora { get; set; } = DateTime.Now;
        public string? RutaNavegacion { get; set; }
        public string? Icono { get; set; }
        public List<string>? Sugerencias { get; set; }
    }

    protected override async Task OnInitializedAsync()
    {
        try
        {
            var result = await SessionStorage.GetAsync<int>("IdUsuario");
            if (result.Success)
            {
                idUsuario = result.Value;
                var usuario = await _context.Usuarios.FindAsync(idUsuario);
                if (usuario != null)
                {
                    nombreUsuario = usuario.Nombres.Split(' ')[0];
                    esAdmin = usuario.Id_Rol == 1; // Asumiendo rol 1 = Admin
                }
            }
        }
        catch { }

        // Mensaje de bienvenida
        var saludo = AsistenteService.ObtenerSaludoPersonalizado(nombreUsuario);
        mensajes.Add(new MensajeChat
        {
            Texto = saludo,
            EsUsuario = false,
            Sugerencias = new List<string>
            {
                "¿Cómo crear una venta?",
                "Ver informes",
                "¿Qué es SIFEN?",
                "Dame un consejo"
            }
        });

        if (esAdmin)
        {
            await CargarEstadisticas();
        }
    }

    private async Task CargarEstadisticas()
    {
        try
        {
            var hoy = DateTime.Today;
            totalConversaciones = await _context.Set<ConversacionAsistente>()
                .CountAsync(c => c.Fecha.Date == hoy);
            totalErrores = await _context.Set<RegistroError>()
                .CountAsync(e => !e.Analizado);
        }
        catch { }
    }

    private async Task OnKeyPress(KeyboardEventArgs e)
    {
        if (e.Key == "Enter" && !string.IsNullOrWhiteSpace(consultaActual))
        {
            await EnviarConsulta();
        }
    }

    private async Task EnviarConsulta()
    {
        if (string.IsNullOrWhiteSpace(consultaActual) || enviando) return;

        var consulta = consultaActual.Trim();
        consultaActual = "";
        enviando = true;

        mensajes.Add(new MensajeChat { Texto = consulta, EsUsuario = true });
        
        escribiendo = true;
        StateHasChanged();
        await Task.Delay(500 + new Random().Next(800));
        
        try
        {
            var respuesta = await AsistenteService.ProcesarConsultaAsync(
                consulta, 
                idUsuario, 
                NavigationManager.Uri);

            escribiendo = false;
            
            mensajes.Add(new MensajeChat
            {
                Texto = respuesta.Mensaje,
                EsUsuario = false,
                RutaNavegacion = respuesta.RutaNavegacion,
                Icono = respuesta.Icono,
                Sugerencias = respuesta.Sugerencias
            });
        }
        catch (Exception)
        {
            escribiendo = false;
            mensajes.Add(new MensajeChat
            {
                Texto = $"Disculpa {nombreUsuario}, ocurrió un error. Por favor intenta de nuevo.",
                EsUsuario = false
            });
        }
        finally
        {
            enviando = false;
        }
    }

    private async Task UsarSugerencia(string sugerencia)
    {
        consultaActual = sugerencia;
        await EnviarConsulta();
    }

    private void Navegar(string ruta)
    {
        NavigationManager.NavigateTo(ruta);
    }

    private string ObtenerNombreRuta(string ruta)
    {
        var nombres = new Dictionary<string, string>
        {
            { "/ventas", "Ventas" },
            { "/compras", "Compras" },
            { "/productos", "Productos" },
            { "/clientes", "Clientes" },
            { "/caja", "Caja" },
            { "/caja/cierre", "Cierre de Caja" },
            { "/informes", "Informes" },
            { "/stock", "Stock" },
            { "/configuracion", "Configuración" }
        };
        return nombres.GetValueOrDefault(ruta, ruta.TrimStart('/'));
    }

    private string FormatearMensaje(string texto)
    {
        texto = System.Text.RegularExpressions.Regex.Replace(
            texto, 
            @"\*\*(.+?)\*\*", 
            "<strong>$1</strong>");
        texto = texto.Replace("\n", "<br/>");
        return texto;
    }

    private void VerErrores()
    {
        // Podría navegar a una página de errores o mostrar modal
        NavigationManager.NavigateTo("/admin/errores-ia");
    }
}
