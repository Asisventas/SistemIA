@page "/inventario/transferencias"
@using Microsoft.EntityFrameworkCore
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Web
@attribute [Authorize]
@inject IDbContextFactory<SistemIA.Models.AppDbContext> DbFactory
@inject SistemIA.Services.IInventarioService Inventario
@inject SistemIA.Services.ILoteService LoteService
@inject Microsoft.JSInterop.IJSRuntime JS
@inject Microsoft.AspNetCore.Components.Authorization.AuthenticationStateProvider AuthStateProvider

<PageProtection Modulo="/inventario/transferencias" Permiso="VIEW">

<h3 class="mb-3"><i class="bi bi-arrow-left-right me-2"></i>Transferencias entre Dep贸sitos</h3>

@if (!mostrarFormulario)
{
  <!-- Filtros de b煤squeda -->
  <div class="card shadow-sm mb-3">
    <div class="card-body">
      <div class="row g-3 align-items-end">
        <div class="col-md-2">
          <label class="form-label">ID</label>
          <input type="number" class="form-control" @bind="filtroId" placeholder="N煤mero" />
        </div>
        <div class="col-md-2">
          <label class="form-label">Fecha Desde</label>
          <input type="date" class="form-control" @bind="filtroFechaDesde" />
        </div>
        <div class="col-md-2">
          <label class="form-label">Fecha Hasta</label>
          <input type="date" class="form-control" @bind="filtroFechaHasta" />
        </div>
        <div class="col-md-2">
          <label class="form-label">Dep贸sito Origen</label>
          <select class="form-select" @bind="filtroDepositoOrigen">
            <option value="0">Todos</option>
            @if (depositos != null)
            {
              foreach (var d in depositos)
              {
                <option value="@d.IdDeposito">@d.Nombre</option>
              }
            }
          </select>
        </div>
        <div class="col-md-2">
          <label class="form-label">Dep贸sito Destino</label>
          <select class="form-select" @bind="filtroDepositoDestino">
            <option value="0">Todos</option>
            @if (depositos != null)
            {
              foreach (var d in depositos)
              {
                <option value="@d.IdDeposito">@d.Nombre</option>
              }
            }
          </select>
        </div>
        <div class="col-md-2">
          <button class="btn btn-primary w-100" @onclick="BuscarTransferencias">
            <i class="bi bi-search me-1"></i> Buscar
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Resultados de b煤squeda -->
  <div class="card shadow-sm mb-3">
    <div class="card-body">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h5 class="mb-0">Transferencias Registradas</h5>
        <button class="btn btn-success" @onclick="MostrarFormulario">
          <i class="bi bi-plus-circle me-1"></i> Nueva Transferencia
        </button>
      </div>
      
      <div class="table-responsive">
        <table class="table table-hover table-sm">
          <thead class="table-dark">
            <tr>
              <th>ID</th>
              <th>Fecha</th>
              <th>Origen</th>
              <th>Destino</th>
              <th>Usuario</th>
              <th>Comentario</th>
              <th style="width:150px;">Acciones</th>
            </tr>
          </thead>
          <tbody>
            @if (transferenciasFiltradas == null)
            {
              <tr><td colspan="7" class="text-center">Cargando...</td></tr>
            }
            else if (!transferenciasFiltradas.Any())
            {
              <tr><td colspan="7" class="text-center text-muted">No se encontraron transferencias</td></tr>
            }
            else
            {
              foreach (var t in transferenciasFiltradas)
              {
                <tr style="cursor:pointer;" @onclick="() => MostrarVistaPrevia(t.IdTransferencia)">
                  <td><strong>#@t.IdTransferencia</strong></td>
                  <td>@t.FechaTransferencia.ToString("dd/MM/yyyy HH:mm")</td>
                  <td>@t.DepositoOrigen?.Nombre</td>
                  <td>@t.DepositoDestino?.Nombre</td>
                  <td>@t.UsuarioCreacion</td>
                  <td>@t.Comentario</td>
                  <td @onclick:stopPropagation="true">
                    <button class="btn btn-sm btn-outline-info me-1" @onclick="() => MostrarVistaPrevia(t.IdTransferencia)" title="Vista previa">
                      <i class="bi bi-eye"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-primary" @onclick="() => ImprimirTransferencia(t.IdTransferencia)" title="Imprimir">
                      <i class="bi bi-printer"></i>
                    </button>
                  </td>
                </tr>
              }
            }
          </tbody>
        </table>
      </div>
    </div>
  </div>
  
  <!-- Modal de Vista Previa -->
  @if (mostrarVistaPrevia && transferenciaPreview != null)
  {
    <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.85);" @onclick="CerrarVistaPrevia">
      <div class="modal-dialog" style="max-width: 95vw; width: 95vw; margin: 1rem auto; resize: both; overflow: auto;" @onclick:stopPropagation="true">
        <div class="modal-content" style="height: calc(100vh - 2rem); resize: both; overflow: hidden;">
          <div class="modal-header bg-primary text-white">
            <h5 class="modal-title">
              <i class="bi bi-eye me-2"></i>
              Vista Previa - Transferencia #@transferenciaPreview.IdTransferencia
            </h5>
            <button type="button" class="btn-close btn-close-white" @onclick="CerrarVistaPrevia"></button>
          </div>
          <div class="modal-body p-0" style="overflow-y: auto; overflow-x: auto;">
            <div style="background: #e0e0e0; padding: 30px; min-height: 100%;">
              <div style="background: white; width: 28cm; margin: 0 auto; padding: 2.5cm; box-shadow: 0 8px 24px rgba(0,0,0,0.3); border-radius: 0;">
                @((MarkupString)htmlVistaPrevia)
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button class="btn btn-lg btn-secondary" @onclick="CerrarVistaPrevia">
              <i class="bi bi-x-circle me-2"></i> Cerrar
            </button>
            <button class="btn btn-lg btn-primary" @onclick="() => ImprimirTransferencia(transferenciaPreview.IdTransferencia)">
              <i class="bi bi-printer me-2"></i> Imprimir
            </button>
          </div>
        </div>
      </div>
    </div>
  }
}
else
{
  <!-- Formulario de nueva transferencia -->

  <!-- Formulario de nueva transferencia -->
<div class="card shadow-sm mb-3">
  <div class="card-body">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h5 class="mb-0">Nueva Transferencia</h5>
      <button class="btn btn-outline-secondary btn-sm" @onclick="CancelarFormulario">
        <i class="bi bi-x-lg me-1"></i> Cancelar
      </button>
    </div>
    <div class="row g-3 align-items-end">
      <div class="col-md-3">
        <label class="form-label fw-semibold">Dep贸sito Origen</label>
        <select class="form-select" @bind="idDepositoOrigen" @bind:after="CargarStocksOrigen" disabled="@guardando">
          <option value="0">-- Seleccione origen --</option>
          @if (depositos != null)
          {
            foreach (var d in depositos)
            {
              <option value="@d.IdDeposito">@d.Nombre (@d.Sucursal?.NombreSucursal)</option>
            }
          }
        </select>
      </div>
      <div class="col-md-3">
        <label class="form-label fw-semibold">Dep贸sito Destino</label>
        <select class="form-select" @bind="idDepositoDestino" disabled="@guardando">
          <option value="0">-- Seleccione destino --</option>
          @if (depositos != null)
          {
            foreach (var d in depositos.Where(x => x.IdDeposito != idDepositoOrigen))
            {
              <option value="@d.IdDeposito">@d.Nombre (@d.Sucursal?.NombreSucursal)</option>
            }
          }
        </select>
      </div>
      <div class="col-md-4">
        <label class="form-label">Comentario</label>
        <input class="form-control" @bind="comentario" maxlength="500" placeholder="Opcional" disabled="@guardando" />
      </div>
      <div class="col-md-2 text-end">
        <button class="btn btn-primary w-100" @onclick="Guardar" disabled="@(idDepositoOrigen==0 || idDepositoDestino==0 || !lineas.Any() || guardando)">
          <i class="bi bi-save me-1"></i> @(guardando?"Guardando...":"Guardar")
        </button>
      </div>
    </div>
  </div>
  @if (!string.IsNullOrWhiteSpace(errorMsg))
  {
    <div class="card-footer">
      <div class="alert alert-danger py-2 my-0">@errorMsg</div>
    </div>
  }
  @if (!string.IsNullOrWhiteSpace(okMsg))
  {
    <div class="card-footer">
      <div class="alert alert-success py-2 my-0">@okMsg</div>
    </div>
  }
  @if (transferenciaGeneradaId.HasValue)
  {
    <div class="card-footer d-flex gap-2">
      <button class="btn btn-outline-secondary" @onclick="Imprimir">
        <i class="bi bi-printer me-1"></i> Imprimir
      </button>
      <button class="btn btn-outline-primary" @onclick="NuevaTransferenciaDesdeFormulario">
        <i class="bi bi-plus-circle me-1"></i> Nueva transferencia
      </button>
      <button class="btn btn-outline-info" @onclick="VolverAListado">
        <i class="bi bi-list me-1"></i> Ver listado
      </button>
    </div>
  }
</div>
}

<div class="card shadow-sm">
  <div class="card-body">
    <div class="row g-3 align-items-end">
      <div class="col-md-6">
        <label class="form-label">Producto</label>
        <div class="position-relative">
          <div class="input-group">
            <span class="input-group-text"><i class="bi bi-search"></i></span>
            <input class="form-control" placeholder="Buscar por nombre o c贸digo" @bind="buscarProducto" @bind:event="oninput" @onkeyup="OnProductoKeyUp" @onfocus="OnProductoFocus" @onblur="OnProductoBlur" autocomplete="off" onkeydown="if(event.key==='Enter'){event.preventDefault();return false;}" disabled="@(idDepositoOrigen==0 || guardando)" />
          </div>
          @if (mostrarSugProductos && productosFiltrados.Any())
          {
            <div class="list-group position-absolute w-100 z-3" style="max-height: 300px; overflow:auto;">
              @foreach (var p in productosFiltrados.Take(15))
              {
                <button type="button"
                        class="list-group-item list-group-item-action d-flex justify-content-between align-items-start"
                        tabindex="-1"
                        @onpointerdown="() => SeleccionarProducto(p)" @onpointerdown:preventDefault @onpointerdown:stopPropagation
                        @onmousedown="() => SeleccionarProducto(p)" @onmousedown:preventDefault @onmousedown:stopPropagation
                        @onclick="() => SeleccionarProducto(p)" @onclick:preventDefault @onclick:stopPropagation>
                  <div>
                    <div class="fw-semibold">@p.Descripcion</div>
                    <small class="text-muted">C贸digo: @p.CodigoInterno</small>
                  </div>
                  <span class="badge bg-secondary">Stock: @ObtenerStockDisplay(p.IdProducto)</span>
                </button>
              }
            </div>
          }
        </div>
      </div>
      
      @* ========== SELECTOR DE LOTE (SI EL PRODUCTO CONTROLA LOTES) ========== *@
      @if (productoControlaLote && idProductoSeleccionado > 0)
      {
        <div class="col-md-3">
          <label class="form-label">
            <i class="bi bi-box-seam text-primary me-1"></i>Lote
            <span class="text-danger">*</span>
          </label>
          @if (!lotesOrigen.Any())
          {
            <div class="alert alert-warning py-2 mb-0 small">
              <i class="bi bi-exclamation-triangle me-1"></i>No hay lotes con stock en el dep贸sito origen
            </div>
          }
          else
          {
            <select class="form-select" value="@selectedLoteOrigenId" @onchange="OnLoteOrigenChanged" disabled="@guardando">
              <option value="">-- Seleccione lote --</option>
              @foreach (var lote in lotesOrigen)
              {
                <option value="@lote.IdProductoLote">
                  @lote.NumeroLote 
                  @if (lote.FechaVencimiento.HasValue)
                  {
                    @:- Vence: @lote.FechaVencimiento.Value.ToString("dd/MM/yyyy")
                  }
                  (Stock: @lote.Stock.ToString("N0"))
                </option>
              }
            </select>
          }
        </div>
      }
      
      <div class="col-md-2">
        <label class="form-label">Stock disponible</label>
        <input class="form-control" value="@stockDisponible.ToString("N2")" disabled />
      </div>
      @* ========== CANTIDAD CON SELECTOR PAQUETE/UNIDAD ========== *@
      @if (productoEsPaquete)
      {
        <div class="col-md-1">
          <label class="form-label">Modo</label>
          <select class="form-select form-select-sm" value="@modoIngresoTransferencia" @onchange="OnModoIngresoTransferenciaChanged">
            <option value="paquete">@nombreUnidadTransferencia</option>
            <option value="unidad">Unidad</option>
          </select>
        </div>
        <div class="col-md-1">
          <label class="form-label">Cant.</label>
          <input class="form-control" type="number" step="1" min="1" 
                 value="@cantidadIngresada" 
                 @oninput="OnCantidadIngresadaChanged" 
                 disabled="@(idProductoSeleccionado==0 || guardando)" />
          @if (modoIngresoTransferencia == "paquete" && cantidadPorPaqueteActual > 1)
          {
            <small class="text-muted">= @((cantidadIngresada * (cantidadPorPaqueteActual ?? 1)).ToString("N0")) und.</small>
          }
        </div>
      }
      else
      {
        <div class="col-md-2">
          <label class="form-label">Cantidad a transferir</label>
          <input class="form-control" type="number" step="0.01" min="0" @bind-value="cantidad" @bind-value:event="oninput" disabled="@(idProductoSeleccionado==0 || guardando)" />
        </div>
      }
      <div class="col-md-2 text-end">
        <button class="btn btn-success w-100" @onclick="AgregarLinea" disabled="@(idProductoSeleccionado==0 || idDepositoOrigen==0 || cantidad<=0 || guardando)">
          <i class="bi bi-plus-lg"></i> Agregar
        </button>
      </div>
    </div>

    <hr />

    <div class="table-responsive">
      <table class="table table-sm table-hover align-middle">
        <thead class="table-dark">
          <tr>
            <th style="width:50px;">#</th>
            <th>C贸digo</th>
            <th>Producto</th>
            <th>Lote</th>
            <th class="text-end">Paq.</th>
            <th class="text-end">Stock origen</th>
            <th class="text-end">Cantidad</th>
            <th class="text-end">Costo unit.</th>
            <th class="text-end">Costo total</th>
            <th style="width:80px;">Acciones</th>
          </tr>
        </thead>
        <tbody>
          @if (!lineas.Any())
          {
            <tr><td colspan="10" class="text-center text-muted py-4">Sin productos agregados</td></tr>
          }
          else
          {
            var idx = 0;
            foreach (var l in lineas)
            {
              var esPaq = (l.UnidadMedidaCodigo == "006" || l.UnidadMedidaCodigo == "005") && l.CantidadPorPaquete > 1;
              var paqStock = esPaq ? Math.Floor(l.StockOrigen / l.CantidadPorPaquete) : 0m;
              var paqSueltas = esPaq ? l.StockOrigen % l.CantidadPorPaquete : 0m;
              <tr>
                <td>@(++idx)</td>
                <td><span class="badge bg-secondary">@l.CodigoInterno</span></td>
                <td>
                  <div class="fw-semibold">@l.Descripcion</div>
                  @if (esPaq)
                  {
                    <small class="text-info"> @l.CantidadPorPaquete u/paq</small>
                  }
                </td>
                <td>
                  @if (l.ControlaLote && !string.IsNullOrEmpty(l.NumeroLote))
                  {
                    <div class="small">
                      <span class="badge bg-primary">@l.NumeroLote</span>
                      @if (l.FechaVencimiento.HasValue)
                      {
                        <br/><small class="text-muted">Vence: @l.FechaVencimiento.Value.ToString("dd/MM/yy")</small>
                      }
                    </div>
                  }
                  else
                  {
                    <span class="text-muted">-</span>
                  }
                </td>
                <td class="text-end">
                  @if (esPaq)
                  {
                    <span class="text-info fw-semibold" title="@paqStock paquetes + @paqSueltas unidades sueltas">
                      @paqStock.ToString("N0")@(paqSueltas > 0 ? $" +{paqSueltas:N0}" : "")
                    </span>
                  }
                  else
                  {
                    <span class="text-muted">-</span>
                  }
                </td>
                <td class="text-end">@l.StockOrigen.ToString("N2")</td>
                <td class="text-end">
                  <input class="form-control form-control-sm text-end" style="max-width:120px; display:inline-block;" type="number" step="0.01" min="0.01" value="@l.Cantidad"
                         @oninput="(e)=>ActualizarCantidad(l, e.Value?.ToString())" disabled="@guardando" />
                </td>
                <td class="text-end">@l.CostoUnitario.ToString("N0")</td>
                <td class="text-end fw-semibold">@l.CostoTotal.ToString("N0")</td>
                <td class="text-center">
                  <button class="btn btn-sm btn-outline-danger" title="Quitar" @onclick="(()=>QuitarLinea(l))" disabled="@guardando"><i class="bi bi-x-lg"></i></button>
                </td>
              </tr>
            }
          }
        </tbody>
        <tfoot>
          <tr class="table-secondary">
            <th colspan="7" class="text-end">Total</th>
            <th class="text-end">@lineas.Sum(x=>x.CostoTotal).ToString("N0")</th>
            <th></th>
          </tr>
        </tfoot>
      </table>
    </div>
  </div>
</div>

@code {
  private List<SistemIA.Models.Deposito>? depositos;
  private List<SistemIA.Models.Producto>? productos;
  private List<SistemIA.Models.Producto> productosFiltrados = new();
  private Dictionary<int, decimal> stocksPorProducto = new();
  
  // Variables de formulario
  private bool mostrarFormulario = false;
  private int idDepositoOrigen;
  private int idDepositoDestino;
  private string? comentario;
  private int idProductoSeleccionado;
  private decimal stockDisponible;
  private decimal cantidad;
  private string? buscarProducto;
  private bool mostrarSugProductos;
  
  // ========== VARIABLES PARA TRANSFERENCIA POR PAQUETE/UNIDAD ==========
  private string modoIngresoTransferencia = "paquete"; // "paquete" o "unidad"
  private decimal cantidadIngresada = 1;
  private int? cantidadPorPaqueteActual = null;
  private string nombreUnidadTransferencia = "Paquete";
  private bool productoEsPaquete = false;
  
  // ========== VARIABLES PARA LOTES ==========
  private bool productoControlaLote = false;
  private List<SistemIA.Models.ProductoLote> lotesOrigen = new();  // Lotes con stock en dep贸sito origen
  private int? selectedLoteOrigenId = null;  // Lote seleccionado del origen
  
  private string? errorMsg;
  private string? okMsg;
  private bool guardando;
  private int? transferenciaGeneradaId;
  
  private List<LineaVM> lineas = new();
  
  // Variables de filtros
  private int? filtroId;
  private DateTime? filtroFechaDesde;
  private DateTime? filtroFechaHasta;
  private int filtroDepositoOrigen;
  private int filtroDepositoDestino;
  
  private List<SistemIA.Models.TransferenciaDeposito>? transferenciasFiltradas;
  
  // Variables de vista previa
  private bool mostrarVistaPrevia = false;
  private SistemIA.Models.TransferenciaDeposito? transferenciaPreview;
  private string htmlVistaPrevia = string.Empty;

  protected override async Task OnInitializedAsync()
  {
    await using var ctx = await DbFactory.CreateDbContextAsync();
    depositos = await ctx.Depositos
      .Include(d => d.Sucursal)
      .Where(d => d.Activo)
      .AsNoTracking()
      .OrderBy(d => d.IdSucursal)
      .ThenBy(d => d.Nombre)
      .ToListAsync();
    productos = await ctx.Productos
      .AsNoTracking()
      .Where(p => p.Activo)
      .OrderBy(p => p.Descripcion)
      .ToListAsync();
    
    // Cargar 煤ltimas transferencias
    await BuscarTransferencias();
  }
  
  private void MostrarFormulario()
  {
    mostrarFormulario = true;
    Nuevo();
  }
  
  private void CancelarFormulario()
  {
    mostrarFormulario = false;
    Nuevo();
  }
  
  private void VolverAListado()
  {
    mostrarFormulario = false;
    Nuevo();
    _ = BuscarTransferencias();
  }
  
  private void NuevaTransferenciaDesdeFormulario()
  {
    Nuevo();
  }
  
  private async Task BuscarTransferencias()
  {
    await using var ctx = await DbFactory.CreateDbContextAsync();
    
    var query = ctx.TransferenciasDeposito
      .Include(t => t.DepositoOrigen)
      .Include(t => t.DepositoDestino)
      .AsNoTracking()
      .AsQueryable();
    
    if (filtroId.HasValue)
      query = query.Where(t => t.IdTransferencia == filtroId.Value);
    
    if (filtroFechaDesde.HasValue)
      query = query.Where(t => t.FechaTransferencia >= filtroFechaDesde.Value);
    
    if (filtroFechaHasta.HasValue)
      query = query.Where(t => t.FechaTransferencia <= filtroFechaHasta.Value.AddDays(1));
    
    if (filtroDepositoOrigen > 0)
      query = query.Where(t => t.IdDepositoOrigen == filtroDepositoOrigen);
    
    if (filtroDepositoDestino > 0)
      query = query.Where(t => t.IdDepositoDestino == filtroDepositoDestino);
    
    transferenciasFiltradas = await query
      .OrderByDescending(t => t.IdTransferencia)
      .Take(100)
      .ToListAsync();
  }
  
  private async Task MostrarVistaPrevia(int idTransferencia)
  {
    try
    {
      await using var ctx = await DbFactory.CreateDbContextAsync();
      transferenciaPreview = await ctx.TransferenciasDeposito
        .Include(t => t.DepositoOrigen).ThenInclude(d => d!.Sucursal)
        .Include(t => t.DepositoDestino).ThenInclude(d => d!.Sucursal)
        .AsNoTracking()
        .FirstOrDefaultAsync(t => t.IdTransferencia == idTransferencia);
      
      if (transferenciaPreview == null) return;
      
      var detalles = await ctx.TransferenciasDepositoDetalle
        .Include(d => d.Producto)
        .AsNoTracking()
        .Where(d => d.IdTransferencia == idTransferencia)
        .ToListAsync();
      
      htmlVistaPrevia = GenerarHtmlVistaPrevia(transferenciaPreview, detalles);
      mostrarVistaPrevia = true;
    }
    catch (Exception ex)
    {
      Console.Error.WriteLine($"Error al cargar vista previa: {ex.Message}");
    }
  }
  
  private void CerrarVistaPrevia()
  {
    mostrarVistaPrevia = false;
    transferenciaPreview = null;
    htmlVistaPrevia = string.Empty;
  }
  
  private string GenerarHtmlVistaPrevia(SistemIA.Models.TransferenciaDeposito trans, List<SistemIA.Models.TransferenciaDepositoDetalle> dets)
  {
    var suc = trans.DepositoOrigen?.Sucursal;
    string empresa = suc?.NombreEmpresa ?? "Empresa";
    string sucursal = suc?.NombreSucursal ?? "Sucursal";
    string ruc = suc != null ? $"{suc.RUC}-{suc.DV}" : "";
    string direccion = suc?.Direccion ?? "";
    
    // Logo
    string? logoDataUri = null;
    if (suc?.Logo != null && suc.Logo.Length > 0)
    {
      var b64 = Convert.ToBase64String(suc.Logo);
      logoDataUri = $"data:image/png;base64,{b64}";
    }
    
    var sb = new System.Text.StringBuilder();
    
    // Estilos inline para la vista previa (id茅nticos a la impresi贸n)
    sb.AppendLine("<style>");
    sb.AppendLine("body{font-size:14px;color:#000;line-height:1.5;}");
    sb.AppendLine(".header{display:flex;align-items:center;gap:20px;border-bottom:4px solid #000;padding-bottom:14px;margin-bottom:20px;}");
    sb.AppendLine(".header .logo{max-width:160px;max-height:80px;object-fit:contain;border-radius:6px;border:2px solid #ddd;background:#fff;padding:10px;}");
    sb.AppendLine(".header .empresa h2{margin:0;font-size:22px;font-weight:700;color:#000;}");
    sb.AppendLine(".header .empresa .small{font-size:13px;color:#333;font-weight:600;}");
    sb.AppendLine(".meta{display:flex;justify-content:space-between;gap:20px;margin-bottom:20px;padding:16px;background:#f8f9fa;border-radius:6px;border:2px solid #dee2e6;}");
    sb.AppendLine(".meta .text-muted{color:#555!important;font-size:12px;font-weight:700;text-transform:uppercase;margin-bottom:6px;letter-spacing:0.5px;}");
    sb.AppendLine(".meta .fw-semibold{color:#000;font-size:16px;font-weight:700;}");
    sb.AppendLine(".table-trans{width:100%;border-collapse:collapse;margin-top:16px;}");
    sb.AppendLine(".table-trans th,.table-trans td{padding:.85rem;border:1.5px solid #dee2e6;}");
    sb.AppendLine(".table-trans thead th{background:#000;color:white;font-weight:700;font-size:14px;text-align:left;padding:12px;}");
    sb.AppendLine(".table-trans tbody tr{background:#fff;}");
    sb.AppendLine(".table-trans tbody tr:hover{background:#f1f3f5;}");
    sb.AppendLine(".table-trans tbody td{color:#000;font-size:14px;font-weight:500;}");
    sb.AppendLine(".table-trans tfoot tr{background:#f8f9fa;border-top:4px solid #000;}");
    sb.AppendLine(".table-trans tfoot td{font-weight:700;font-size:17px;color:#000;padding:14px;}");
    sb.AppendLine(".alert-info{background:#d1ecf1;border:2px solid #0c5460;padding:14px;border-radius:6px;margin:16px 0;color:#0c5460;font-size:14px;font-weight:600;}");
    sb.AppendLine(".fw-bold{font-weight:700;}");
    sb.AppendLine("</style>");
    
    // HEADER (igual que la impresi贸n)
    sb.AppendLine("<div class='header'>");
    if (!string.IsNullOrEmpty(logoDataUri))
      sb.AppendLine($"  <img class='logo' src='{logoDataUri}' alt='Logo'/>");
    sb.AppendLine("  <div class='empresa'>");
    sb.AppendLine($"    <h2>{System.Net.WebUtility.HtmlEncode(empresa)}</h2>");
    sb.AppendLine($"    <div class='small'>RUC: {System.Net.WebUtility.HtmlEncode(ruc)} 路 {System.Net.WebUtility.HtmlEncode(sucursal)}</div>");
    sb.AppendLine($"    <div class='small'>{System.Net.WebUtility.HtmlEncode(direccion)}</div>");
    sb.AppendLine("  </div>");
    sb.AppendLine("  <div style='margin-left:auto;text-align:right;'>");
    sb.AppendLine("    <div class='fw-bold' style='font-size:20px;color:#000;'>Transferencia entre Dep贸sitos</div>");
    sb.AppendLine($"    <div style='font-size:16px;font-weight:600;color:#000;'>N掳: {trans.IdTransferencia:D6}</div>");
    sb.AppendLine($"    <div style='font-size:13px;color:#333;'>Fecha: {trans.FechaTransferencia:dd/MM/yyyy HH:mm}</div>");
    if (!string.IsNullOrWhiteSpace(trans.UsuarioCreacion))
      sb.AppendLine($"    <div style='font-size:13px;color:#333;'>Usuario: {System.Net.WebUtility.HtmlEncode(trans.UsuarioCreacion)}</div>");
    sb.AppendLine("  </div>");
    sb.AppendLine("</div>");
    
    // META (dep贸sitos origen/destino - igual que la impresi贸n)
    sb.AppendLine("<div class='meta'>");
    sb.AppendLine("  <div>");
    sb.AppendLine("    <div class='text-muted'>Dep贸sito Origen</div>");
    sb.AppendLine($"    <div class='fw-semibold'>{System.Net.WebUtility.HtmlEncode(trans.DepositoOrigen?.Nombre ?? "N/A")}</div>");
    sb.AppendLine($"    <div class='small'>{System.Net.WebUtility.HtmlEncode(trans.DepositoOrigen?.Sucursal?.NombreSucursal ?? "")}</div>");
    sb.AppendLine("  </div>");
    sb.AppendLine("  <div style='text-align:right;'>");
    sb.AppendLine("    <div class='text-muted'>Dep贸sito Destino</div>");
    sb.AppendLine($"    <div class='fw-semibold'>{System.Net.WebUtility.HtmlEncode(trans.DepositoDestino?.Nombre ?? "N/A")}</div>");
    sb.AppendLine($"    <div class='small'>{System.Net.WebUtility.HtmlEncode(trans.DepositoDestino?.Sucursal?.NombreSucursal ?? "")}</div>");
    sb.AppendLine("  </div>");
    sb.AppendLine("</div>");
    
    if (!string.IsNullOrWhiteSpace(trans.Comentario))
    {
      sb.AppendLine($"<div class='alert alert-info'><strong>Comentario:</strong> {System.Net.WebUtility.HtmlEncode(trans.Comentario)}</div>");
    }
    
    sb.AppendLine("<table class='table-trans'>");
    sb.AppendLine("  <thead><tr><th>#</th><th>C贸digo</th><th>Descripci贸n</th><th style='text-align:right;width:70px;'>Paq.</th><th style='text-align:right;width:100px;'>Cantidad</th><th style='text-align:right;width:110px;'>Costo unit.</th><th style='text-align:right;width:110px;'>Costo total</th></tr></thead>");
    sb.AppendLine("  <tbody>");
    var idx = 0;
    foreach (var d in dets)
    {
      idx++;
      var desc = d.Producto?.Descripcion ?? $"Producto #{d.IdProducto}";
      var codigo = d.Producto?.CodigoInterno ?? "-";
      var costoTotal = d.Cantidad * (d.CostoUnitario ?? 0);
      // Calcular paquetes transferidos
      var cantPaq = d.Producto?.CantidadPorPaquete ?? 1;
      var uniMed = d.Producto?.UnidadMedidaCodigo;
      var esPaq = (uniMed == "006" || uniMed == "005") && cantPaq > 1;
      var paqTransf = esPaq ? Math.Floor(d.Cantidad / cantPaq) : 0m;
      var sueltas = esPaq ? d.Cantidad % cantPaq : 0m;
      var paqDisplay = esPaq ? (paqTransf > 0 ? $"{paqTransf:N0}{(sueltas > 0 ? $" +{sueltas:N0}" : "")}" : (sueltas > 0 ? $"+{sueltas:N0}" : "0")) : "-";
      var descHtml = System.Net.WebUtility.HtmlEncode(desc) + (esPaq ? $"<br/><small style='color:#17a2b8;'> {cantPaq} u/paq</small>" : "");
      sb.AppendLine($"    <tr><td style='font-weight:600;'>{idx}</td><td style='font-weight:600;'>{System.Net.WebUtility.HtmlEncode(codigo)}</td><td>{descHtml}</td><td style='text-align:right;color:#17a2b8;font-weight:600;'>{paqDisplay}</td><td style='text-align:right;font-weight:600;'>{d.Cantidad:N2}</td><td style='text-align:right;'>{(d.CostoUnitario ?? 0):N0}</td><td style='text-align:right;font-weight:700;'>{costoTotal:N0}</td></tr>");
    }
    sb.AppendLine("  </tbody>");
    sb.AppendLine("  <tfoot>");
    var totalCosto = dets.Sum(d => d.Cantidad * (d.CostoUnitario ?? 0));
    sb.AppendLine($"    <tr><td colspan='6' style='text-align:right;font-size:16px;'>TOTAL</td><td style='text-align:right;font-size:16px;'>{totalCosto:N0}</td></tr>");
    sb.AppendLine("  </tfoot>");
    sb.AppendLine("</table>");
    
    sb.AppendLine("<div style='text-align:center;margin-top:2rem;color:#000;font-size:11px;font-weight:600;'>** Comprobante de Transferencia **</div>");
    
    return sb.ToString();
  }

  private async Task CargarStockDisponible()
  {
    if (idProductoSeleccionado == 0 || idDepositoOrigen == 0)
    {
      stockDisponible = 0;
      return;
    }
    
    try
    {
      stockDisponible = await Inventario.ObtenerStockAsync(idProductoSeleccionado, idDepositoOrigen);
    }
    catch
    {
      stockDisponible = 0;
    }
  }

  private string ObtenerStockDisplay(int idProducto)
  {
    if (idDepositoOrigen == 0) return "-";
    if (stocksPorProducto.ContainsKey(idProducto))
      return stocksPorProducto[idProducto].ToString("N2");
    return "-";
  }

  private async Task CargarStocksOrigen()
  {
    if (idDepositoOrigen == 0 || productos == null) return;
    
    stocksPorProducto.Clear();
    await using var ctx = await DbFactory.CreateDbContextAsync();
    var stocks = await ctx.ProductosDepositos
      .AsNoTracking()
      .Where(pd => pd.IdDeposito == idDepositoOrigen && pd.Stock > 0)
      .ToListAsync();
    
    foreach (var s in stocks)
    {
      stocksPorProducto[s.IdProducto] = s.Stock;
    }
    
    // Si hay un producto con control de lote seleccionado, recargar lotes del nuevo dep贸sito
    if (productoControlaLote && idProductoSeleccionado > 0)
    {
      lotesOrigen = await LoteService.ObtenerLotesProductoAsync(idProductoSeleccionado, idDepositoOrigen, soloConStock: true);
      if (lotesOrigen.Any())
      {
        selectedLoteOrigenId = lotesOrigen.First().IdProductoLote;
        stockDisponible = lotesOrigen.First().Stock;
      }
      else
      {
        selectedLoteOrigenId = 0;
        stockDisponible = 0;
      }
    }
  }

  private void AplicarFiltroProductos()
  {
    var texto = (buscarProducto ?? string.Empty).Trim().ToLowerInvariant();
    mostrarSugProductos = !string.IsNullOrWhiteSpace(texto);
    if (!mostrarSugProductos)
    {
      productosFiltrados = new List<SistemIA.Models.Producto>();
      return;
    }
    
    productosFiltrados = productos!
      .Where(p => (p.Descripcion ?? string.Empty).ToLower().Contains(texto) || 
                  (p.CodigoInterno ?? string.Empty).ToLower().Contains(texto))
      .Take(50)
      .ToList();
  }

  private async Task SeleccionarProducto(SistemIA.Models.Producto p)
  {
    idProductoSeleccionado = p.IdProducto;
    buscarProducto = p.Descripcion ?? string.Empty;
    mostrarSugProductos = false;
    
    // Configurar modo paquete/unidad
    cantidadPorPaqueteActual = (int?)(p.CantidadPorPaquete ?? 1);
    productoEsPaquete = (p.UnidadMedidaCodigo == "006" || p.UnidadMedidaCodigo == "005") && (cantidadPorPaqueteActual ?? 1) > 1;
    
    if (productoEsPaquete)
    {
      // Determinar nombre de la unidad de empaque
      if (p.UnidadMedidaCodigo == "006") nombreUnidadTransferencia = "Paquete";
      else if (p.UnidadMedidaCodigo == "005") nombreUnidadTransferencia = "Caja";
      else nombreUnidadTransferencia = "Paquete";
      
      // Por defecto, iniciar en modo paquete con 1 paquete
      modoIngresoTransferencia = "paquete";
      cantidadIngresada = 1;
      cantidad = cantidadPorPaqueteActual ?? 1; // La cantidad real es 1 paquete = X unidades
    }
    else
    {
      // Producto normal, sin paquetes
      modoIngresoTransferencia = "unidad";
      cantidadIngresada = 1;
      cantidad = 1;
    }
    
    // ========== CARGAR LOTES SI EL PRODUCTO LOS CONTROLA ==========
    productoControlaLote = p.ControlaLote;
    lotesOrigen = new();
    selectedLoteOrigenId = null;
    
    if (productoControlaLote && idDepositoOrigen > 0)
    {
      try
      {
        // Obtener lotes con stock en el dep贸sito ORIGEN (solo con stock para transferir)
        lotesOrigen = await LoteService.ObtenerLotesProductoAsync(p.IdProducto, idDepositoOrigen, soloConStock: true);
        lotesOrigen = lotesOrigen.OrderBy(l => l.FechaVencimiento ?? DateTime.MaxValue).ToList();
        
        if (lotesOrigen.Any())
        {
          // Seleccionar autom谩ticamente el primer lote (FEFO - primero en vencer, primero en salir)
          selectedLoteOrigenId = lotesOrigen.First().IdProductoLote;
          stockDisponible = lotesOrigen.First().Stock;
        }
        else
        {
          stockDisponible = 0;
        }
      }
      catch
      {
        lotesOrigen = new();
        stockDisponible = 0;
      }
    }
    else
    {
      await CargarStockDisponible();
    }
    
    StateHasChanged();
  }
  
  /// <summary>
  /// Cambio de lote seleccionado - actualiza el stock disponible
  /// </summary>
  private void OnLoteOrigenChanged(ChangeEventArgs e)
  {
    if (int.TryParse(e.Value?.ToString(), out var id))
    {
      selectedLoteOrigenId = id;
      var lote = lotesOrigen.FirstOrDefault(l => l.IdProductoLote == id);
      if (lote != null)
      {
        stockDisponible = lote.Stock;
        
        // Si est谩 en modo paquete, recalcular cantidad
        if (productoEsPaquete)
        {
          RecalcularCantidadPorModo();
        }
      }
    }
    else
    {
      selectedLoteOrigenId = null;
      stockDisponible = 0;
    }
  }

  private void OnProductoKeyUp(KeyboardEventArgs e)
  {
    if (e.Key == "Escape")
    {
      mostrarSugProductos = false;
    }
    else
    {
      AplicarFiltroProductos();
    }
  }

  private void OnProductoFocus(FocusEventArgs _)
  {
    if (!string.IsNullOrEmpty(buscarProducto))
    {
      AplicarFiltroProductos();
      mostrarSugProductos = true;
    }
  }

  private void OnProductoBlur(FocusEventArgs _)
  {
    // Manejado por onpointerdown
  }

  // ========== MTODOS PARA MODO PAQUETE/UNIDAD ==========
  private void OnModoIngresoTransferenciaChanged(ChangeEventArgs e)
  {
    modoIngresoTransferencia = e.Value?.ToString() ?? "paquete";
    RecalcularCantidadPorModo();
  }

  private void OnCantidadIngresadaChanged(ChangeEventArgs e)
  {
    if (decimal.TryParse(e.Value?.ToString(), out var val) && val >= 0)
    {
      cantidadIngresada = val;
      RecalcularCantidadPorModo();
    }
  }

  private void RecalcularCantidadPorModo()
  {
    if (!productoEsPaquete)
    {
      cantidad = cantidadIngresada;
      return;
    }
    
    var cantPorPaq = cantidadPorPaqueteActual ?? 1;
    
    if (modoIngresoTransferencia == "paquete" && cantPorPaq > 1)
    {
      // Modo paquete: cantidad = paquetes * unidades por paquete
      cantidad = cantidadIngresada * cantPorPaq;
    }
    else
    {
      // Modo unidad: cantidad directa
      cantidad = cantidadIngresada;
    }
  }

  private async Task AgregarLinea()
  {
    errorMsg = okMsg = null;
    if (idDepositoOrigen == 0) { errorMsg = "Seleccione dep贸sito origen"; return; }
    if (idDepositoDestino == 0) { errorMsg = "Seleccione dep贸sito destino"; return; }
    if (idProductoSeleccionado == 0) { errorMsg = "Seleccione un producto"; return; }
    if (cantidad <= 0) { errorMsg = "Ingrese cantidad mayor a 0"; return; }
    
    // ========== VALIDACIN DE LOTE ==========
    if (productoControlaLote)
    {
      if (!lotesOrigen.Any())
      {
        errorMsg = "Este producto requiere lote pero no hay lotes con stock en el dep贸sito origen";
        return;
      }
      if (!selectedLoteOrigenId.HasValue || selectedLoteOrigenId == 0)
      {
        errorMsg = "Debe seleccionar un lote para este producto";
        return;
      }
    }
    
    // Verificar stock del lote o general
    if (productoControlaLote && selectedLoteOrigenId.HasValue)
    {
      var loteSeleccionado = lotesOrigen.FirstOrDefault(l => l.IdProductoLote == selectedLoteOrigenId);
      if (loteSeleccionado == null)
      {
        errorMsg = "Lote seleccionado no v谩lido";
        return;
      }
      stockDisponible = loteSeleccionado.Stock;
    }
    else
    {
      await CargarStockDisponible();
    }
    
    if (cantidad > stockDisponible)
    {
      errorMsg = $"Stock insuficiente. Disponible: {stockDisponible:N2}";
      return;
    }
    
    var p = productos!.First(x => x.IdProducto == idProductoSeleccionado);
    
    // Para productos con lote, verificar si ya existe una l铆nea con el mismo lote
    LineaVM? existente = null;
    if (productoControlaLote && selectedLoteOrigenId.HasValue)
    {
      existente = lineas.FirstOrDefault(x => x.IdProducto == p.IdProducto && x.IdLoteOrigen == selectedLoteOrigenId);
    }
    else
    {
      existente = lineas.FirstOrDefault(x => x.IdProducto == p.IdProducto && x.IdLoteOrigen == null);
    }
    
    if (existente != null)
    {
      existente.Cantidad = cantidad;
      existente.StockOrigen = stockDisponible;
      RecalcularLinea(existente);
    }
    else
    {
      // Obtener datos del lote si corresponde
      string? numeroLote = null;
      DateTime? fechaVencimiento = null;
      
      if (productoControlaLote && selectedLoteOrigenId.HasValue)
      {
        var loteInfo = lotesOrigen.FirstOrDefault(l => l.IdProductoLote == selectedLoteOrigenId);
        if (loteInfo != null)
        {
          numeroLote = loteInfo.NumeroLote;
          fechaVencimiento = loteInfo.FechaVencimiento;
        }
      }
      
      var l = new LineaVM
      {
        IdProducto = p.IdProducto,
        CodigoInterno = p.CodigoInterno,
        Descripcion = p.Descripcion,
        StockOrigen = stockDisponible,
        Cantidad = cantidad,
        CostoUnitario = p.CostoUnitarioGs ?? 0,
        CantidadPorPaquete = (int)(p.CantidadPorPaquete ?? 1),
        UnidadMedidaCodigo = p.UnidadMedidaCodigo,
        // Datos del lote
        ControlaLote = productoControlaLote,
        IdLoteOrigen = selectedLoteOrigenId,
        NumeroLote = numeroLote,
        FechaVencimiento = fechaVencimiento
      };
      RecalcularLinea(l);
      lineas.Add(l);
    }
    
    // Limpiar
    idProductoSeleccionado = 0;
    stockDisponible = 0;
    cantidad = 0;
    buscarProducto = string.Empty;
    mostrarSugProductos = false;
    // Limpiar variables de paquete
    productoEsPaquete = false;
    cantidadPorPaqueteActual = null;
    modoIngresoTransferencia = "paquete";
    cantidadIngresada = 1;
    // Limpiar variables de lote
    productoControlaLote = false;
    lotesOrigen = new();
    selectedLoteOrigenId = null;
  }

  private void RecalcularLinea(LineaVM l)
  {
    l.CostoTotal = l.Cantidad * l.CostoUnitario;
  }

  private void ActualizarCantidad(LineaVM l, string? valor)
  {
    if (decimal.TryParse(valor, out var cant) && cant > 0)
    {
      l.Cantidad = cant;
      RecalcularLinea(l);
    }
    else if (string.IsNullOrWhiteSpace(valor))
    {
      // Si est谩 vac铆o, dejar el valor actual
      return;
    }
    else
    {
      // Si es inv谩lido o <= 0, resetear a 1
      l.Cantidad = 1;
      RecalcularLinea(l);
    }
  }

  private void QuitarLinea(LineaVM l)
  {
    lineas.Remove(l);
  }

  private async Task Guardar()
  {
    // ========== PROTECCIN CONTRA DOBLE GUARDADO ==========
    if (guardando)
    {
      Console.WriteLine("[TransferenciasDeposito] Clic duplicado en Guardar ignorado - operaci贸n en curso");
      return;
    }
    
    errorMsg = okMsg = null;
    guardando = true;
    StateHasChanged();
    
    try
    {
      if (idDepositoOrigen == 0 || idDepositoDestino == 0)
      {
        errorMsg = "Seleccione dep贸sitos origen y destino";
        return;
      }
      
      if (idDepositoOrigen == idDepositoDestino)
      {
        errorMsg = "El dep贸sito origen debe ser diferente al destino";
        return;
      }
      
      if (!lineas.Any())
      {
        errorMsg = "Agregue al menos un producto";
        return;
      }
      
      // Validar stocks
      foreach (var l in lineas)
      {
        var stockActual = await Inventario.ObtenerStockAsync(l.IdProducto, idDepositoOrigen);
        if (l.Cantidad > stockActual)
        {
          errorMsg = $"Stock insuficiente para {l.Descripcion}. Disponible: {stockActual:N2}";
          return;
        }
      }
      
      await using var ctx = await DbFactory.CreateDbContextAsync();
      
      // Obtener usuario
      var authState = await AuthStateProvider.GetAuthenticationStateAsync();
      var usuario = authState.User.Identity?.Name ?? "Sistema";
      
      // Crear transferencia
      var transferencia = new SistemIA.Models.TransferenciaDeposito
      {
        IdDepositoOrigen = idDepositoOrigen,
        IdDepositoDestino = idDepositoDestino,
        FechaTransferencia = DateTime.Now,
        Comentario = comentario,
        UsuarioCreacion = usuario
      };
      
      ctx.TransferenciasDeposito.Add(transferencia);
      await ctx.SaveChangesAsync();
      
      // Crear detalles
      foreach (var l in lineas)
      {
        var detalle = new SistemIA.Models.TransferenciaDepositoDetalle
        {
          IdTransferencia = transferencia.IdTransferencia,
          IdProducto = l.IdProducto,
          Cantidad = l.Cantidad,
          CostoUnitario = l.CostoUnitario,
          // Datos del lote
          IdProductoLoteOrigen = l.IdLoteOrigen,
          NumeroLote = l.NumeroLote,
          FechaVencimientoLote = l.FechaVencimiento
        };
        ctx.TransferenciasDepositoDetalle.Add(detalle);
      }
      
      await ctx.SaveChangesAsync();
      
      // Validar que todas las cantidades sean v谩lidas antes de procesar
      foreach (var l in lineas)
      {
        if (l.Cantidad <= 0)
        {
          errorMsg = $"La cantidad para {l.Descripcion} debe ser mayor a 0";
          return;
        }
      }
      
      // Ajustar stocks: salida del origen, entrada al destino
      foreach (var l in lineas)
      {
        Console.WriteLine($"DEBUG: Ajustando stock - Producto: {l.IdProducto}, Deposito Origen: {idDepositoOrigen}, Cantidad: {l.Cantidad}, Lote: {l.IdLoteOrigen}");
        
        // Salida del origen (tipo 2 = salida, cantidad siempre positiva)
        // Si tiene lote, descontar del lote espec铆fico
        await Inventario.AjustarStockAsync(l.IdProducto, idDepositoOrigen, l.Cantidad, 2, $"Transferencia #{transferencia.IdTransferencia}", usuario, l.IdLoteOrigen);
        
        Console.WriteLine($"DEBUG: Stock origen actualizado. Ahora depositando en destino: {idDepositoDestino}");
        
        // Entrada al destino (tipo 1 = entrada)
        // Si el producto controla lotes, necesitamos crear o encontrar el lote en el dep贸sito destino
        if (l.ControlaLote && !string.IsNullOrEmpty(l.NumeroLote))
        {
          // Buscar si existe el lote en el dep贸sito destino
          var loteDestino = await LoteService.ObtenerOCrearLoteAsync(l.IdProducto, idDepositoDestino, l.NumeroLote, l.FechaVencimiento);
          
          // Actualizar el detalle con el lote destino
          var detalleActualizar = ctx.TransferenciasDepositoDetalle.FirstOrDefault(d => 
            d.IdTransferencia == transferencia.IdTransferencia && d.IdProducto == l.IdProducto && d.IdProductoLoteOrigen == l.IdLoteOrigen);
          if (detalleActualizar != null)
          {
            detalleActualizar.IdProductoLoteDestino = loteDestino.IdProductoLote;
          }
          
          await Inventario.AjustarStockAsync(l.IdProducto, idDepositoDestino, l.Cantidad, 1, $"Transferencia #{transferencia.IdTransferencia}", usuario, loteDestino.IdProductoLote);
        }
        else
        {
          // Producto sin lote - ajuste normal
          await Inventario.AjustarStockAsync(l.IdProducto, idDepositoDestino, l.Cantidad, 1, $"Transferencia #{transferencia.IdTransferencia}", usuario);
        }
      }
      
      await ctx.SaveChangesAsync();
      
      transferenciaGeneradaId = transferencia.IdTransferencia;
      okMsg = $"Transferencia #{transferencia.IdTransferencia} guardada exitosamente";
      
      // Limpiar formulario para nueva transferencia
      lineas.Clear();
      idProductoSeleccionado = 0;
      stockDisponible = 0;
      cantidad = 0;
      buscarProducto = null;
      mostrarSugProductos = false;
      comentario = null;
    }
    catch (Exception ex)
    {
      errorMsg = $"Error al guardar: {ex.Message}";
      if (ex.InnerException != null)
      {
        errorMsg += $" | Detalle: {ex.InnerException.Message}";
      }
      Console.Error.WriteLine($"Error completo en transferencia: {ex}");
    }
    finally
    {
      guardando = false;
      StateHasChanged();
    }
  }

  private void Nuevo()
  {
    idDepositoOrigen = depositos?.FirstOrDefault()?.IdDeposito ?? 0;
    idDepositoDestino = 0;
    comentario = null;
    lineas.Clear();
    errorMsg = okMsg = null;
    transferenciaGeneradaId = null;
    idProductoSeleccionado = 0;
    stockDisponible = 0;
    cantidad = 0;
    buscarProducto = null;
    mostrarSugProductos = false;
    // Reset variables de paquete/unidad
    productoEsPaquete = false;
    cantidadPorPaqueteActual = null;
    modoIngresoTransferencia = "paquete";
    cantidadIngresada = 1;
    nombreUnidadTransferencia = null;
    // Reset variables de lote
    productoControlaLote = false;
    lotesOrigen = new();
    selectedLoteOrigenId = null;
  }

  private async Task Imprimir()
  {
    if (!transferenciaGeneradaId.HasValue) return;
    await ImprimirTransferencia(transferenciaGeneradaId.Value);
  }
  
  private async Task ImprimirTransferencia(int idTransferencia)
  {
    try
    {
      await using var ctx = await DbFactory.CreateDbContextAsync();
      var trans = await ctx.TransferenciasDeposito
        .Include(t => t.DepositoOrigen).ThenInclude(d => d!.Sucursal)
        .Include(t => t.DepositoDestino).ThenInclude(d => d!.Sucursal)
        .AsNoTracking()
        .FirstOrDefaultAsync(t => t.IdTransferencia == idTransferencia);
      
      if (trans == null) return;
      
      var detalles = await ctx.TransferenciasDepositoDetalle
        .Include(d => d.Producto)
        .Include(d => d.LoteOrigen)   // Incluir datos del lote origen
        .Include(d => d.LoteDestino)  // Incluir datos del lote destino
        .AsNoTracking()
        .Where(d => d.IdTransferencia == idTransferencia)
        .ToListAsync();
      
      await ImprimirComprobante(trans, detalles);
    }
    catch (Exception ex)
    {
      Console.Error.WriteLine($"Error al imprimir: {ex.Message}");
    }
  }

  private async Task ImprimirComprobante(SistemIA.Models.TransferenciaDeposito trans, List<SistemIA.Models.TransferenciaDepositoDetalle> dets)
  {
    try
    {
      var suc = trans.DepositoOrigen?.Sucursal;
      string empresa = suc?.NombreEmpresa ?? "Empresa";
      string sucursal = suc?.NombreSucursal ?? "Sucursal";
      string ruc = suc != null ? $"{suc.RUC}-{suc.DV}" : "";
      string direccion = suc?.Direccion ?? "";
      
      // Logo
      string? logoDataUri = null;
      if (suc?.Logo != null && suc.Logo.Length > 0)
      {
        var b64 = Convert.ToBase64String(suc.Logo);
        logoDataUri = $"data:image/png;base64,{b64}";
      }
      
      // HEAD
      var head = new System.Text.StringBuilder();
      head.AppendLine("<meta charset=\"utf-8\"/>");
      head.AppendLine("<title>Transferencia entre Dep贸sitos</title>");
      head.AppendLine("<link rel=\"stylesheet\" href=\"/css/bootstrap/bootstrap.min.css\" />");
      head.AppendLine("<style>");
      head.AppendLine("@media print { @page { size: A4; margin: 14mm 12mm; } }");
      head.AppendLine("body{font-size:12px;color:#111;}");
      head.AppendLine(".header{display:flex;align-items:center;gap:16px;border-bottom:2px solid #222;padding-bottom:8px;margin-bottom:12px;}");
      head.AppendLine(".header .logo{max-width:120px;max-height:60px;object-fit:contain;border-radius:6px;border:1px solid #e5e7eb;background:#fff;padding:6px;}");
      head.AppendLine(".header .empresa h2{margin:0;font-size:18px;}");
      head.AppendLine(".meta{display:flex;justify-content:space-between;gap:12px;margin-bottom:10px;}");
      head.AppendLine(".table-trans th,.table-trans td{padding:.4rem;border-bottom:1px solid #e5e7eb;}");
      head.AppendLine(".totales{background:#f8fafc;border-radius:6px;padding:10px;}");
      head.AppendLine("</style>");
      
      // BODY
      var sb = new System.Text.StringBuilder();
      sb.AppendLine("<div class=\"container-fluid\">");
      sb.AppendLine("  <div class=\"header\">");
      if (!string.IsNullOrEmpty(logoDataUri))
        sb.AppendLine($"    <img class=\"logo\" src=\"{logoDataUri}\" alt=\"Logo\"/>");
      sb.AppendLine("    <div class=\"empresa\">");
      sb.AppendLine($"      <h2>{empresa}</h2>");
      sb.AppendLine($"      <div class=\"small\">RUC: {ruc} 路 {sucursal}</div>");
      sb.AppendLine($"      <div class=\"small\">{direccion}</div>");
      sb.AppendLine("    </div>");
      sb.AppendLine("    <div class=\"ms-auto text-end\">");
      sb.AppendLine("      <div class=\"fw-bold\" style=\"font-size:18px\">Transferencia entre Dep贸sitos</div>");
      sb.AppendLine($"      <div>N掳: {trans.IdTransferencia}</div>");
      sb.AppendLine($"      <div>Fecha: {trans.FechaTransferencia:dd/MM/yyyy HH:mm}</div>");
      if (!string.IsNullOrWhiteSpace(trans.UsuarioCreacion))
        sb.AppendLine($"      <div>Usuario: {trans.UsuarioCreacion}</div>");
      sb.AppendLine("    </div>");
      sb.AppendLine("  </div>");
      
      sb.AppendLine("  <div class=\"meta\">");
      sb.AppendLine("    <div>");
      sb.AppendLine("      <div class=\"text-muted\">Dep贸sito Origen</div>");
      sb.AppendLine($"      <div class=\"fw-semibold\">{trans.DepositoOrigen?.Nombre ?? "N/A"}</div>");
      sb.AppendLine($"      <div class=\"small\">{trans.DepositoOrigen?.Sucursal?.NombreSucursal ?? ""}</div>");
      sb.AppendLine("    </div>");
      sb.AppendLine("    <div class=\"text-end\">");
      sb.AppendLine("      <div class=\"text-muted\">Dep贸sito Destino</div>");
      sb.AppendLine($"      <div class=\"fw-semibold\">{trans.DepositoDestino?.Nombre ?? "N/A"}</div>");
      sb.AppendLine($"      <div class=\"small\">{trans.DepositoDestino?.Sucursal?.NombreSucursal ?? ""}</div>");
      sb.AppendLine("    </div>");
      sb.AppendLine("  </div>");
      
      if (!string.IsNullOrWhiteSpace(trans.Comentario))
      {
        sb.AppendLine($"  <div class=\"alert alert-info\"><strong>Comentario:</strong> {System.Net.WebUtility.HtmlEncode(trans.Comentario)}</div>");
      }
      
      sb.AppendLine("  <table class=\"table table-sm table-trans\">");
      sb.AppendLine("    <thead><tr><th>#</th><th>C贸digo</th><th>Descripci贸n</th><th>Lote</th><th class=\"text-end\">Paq.</th><th class=\"text-end\">Cantidad</th><th class=\"text-end\">Costo unit.</th><th class=\"text-end\">Costo total</th></tr></thead>");
      sb.AppendLine("    <tbody>");
      var idx = 0;
      foreach (var d in dets)
      {
        idx++;
        var desc = d.Producto?.Descripcion ?? $"Producto #{d.IdProducto}";
        var codigo = d.Producto?.CodigoInterno ?? "-";
        var costoTotal = d.Cantidad * (d.CostoUnitario ?? 0);
        // Calcular paquetes transferidos
        var cantPaq = d.Producto?.CantidadPorPaquete ?? 1;
        var uniMed = d.Producto?.UnidadMedidaCodigo;
        var esPaq = (uniMed == "006" || uniMed == "005") && cantPaq > 1;
        var paqTransf = esPaq ? Math.Floor(d.Cantidad / cantPaq) : 0m;
        var sueltas = esPaq ? d.Cantidad % cantPaq : 0m;
        var paqDisplay = esPaq ? (paqTransf > 0 ? $"{paqTransf:N0}{(sueltas > 0 ? $" +{sueltas:N0}" : "")}" : (sueltas > 0 ? $"+{sueltas:N0}" : "0")) : "-";
        var descHtml = System.Net.WebUtility.HtmlEncode(desc) + (esPaq ? $" <small style='color:#17a2b8;'>x{cantPaq}</small>" : "");
        
        // Info de lote - Priorizar datos del lote origen, luego datos guardados en el detalle
        var loteDisplay = "-";
        var numeroLote = d.LoteOrigen?.NumeroLote ?? d.NumeroLote;
        var fechaVenc = d.LoteOrigen?.FechaVencimiento ?? d.FechaVencimientoLote;
        
        if (!string.IsNullOrWhiteSpace(numeroLote))
        {
          var loteHtml = System.Net.WebUtility.HtmlEncode(numeroLote);
          if (fechaVenc.HasValue)
          {
            // Determinar color seg煤n proximidad de vencimiento
            var diasParaVencer = (fechaVenc.Value.Date - DateTime.Today).TotalDays;
            var colorVenc = diasParaVencer <= 0 ? "#dc3545" : (diasParaVencer <= 30 ? "#ffc107" : "#6c757d");
            loteHtml += $"<br/><small style='color:{colorVenc};'>Vence: {fechaVenc:dd/MM/yyyy}</small>";
          }
          loteDisplay = loteHtml;
        }
        
        sb.AppendLine($"      <tr><td>{idx}</td><td>{System.Net.WebUtility.HtmlEncode(codigo)}</td><td>{descHtml}</td><td>{loteDisplay}</td><td class=\"text-end\" style=\"color:#17a2b8;\">{paqDisplay}</td><td class=\"text-end\">{d.Cantidad:N2}</td><td class=\"text-end\">{(d.CostoUnitario ?? 0):N0}</td><td class=\"text-end\">{costoTotal:N0}</td></tr>");
      }
      sb.AppendLine("    </tbody>");
      sb.AppendLine("    <tfoot>");
      var totalCosto = dets.Sum(d => d.Cantidad * (d.CostoUnitario ?? 0));
      sb.AppendLine($"      <tr class=\"fw-bold\"><td colspan=\"7\" class=\"text-end\">Total</td><td class=\"text-end\">{totalCosto:N0}</td></tr>");
      sb.AppendLine("    </tfoot>");
      sb.AppendLine("  </table>");
      
      sb.AppendLine("  <div class=\"text-center mt-4\" style=\"color:#666;font-size:10px;\">** Comprobante de Transferencia **</div>");
      sb.AppendLine("</div>");
      
      await JS.InvokeVoidAsync("printHtmlWithHead", head.ToString(), sb.ToString());
    }
    catch (Exception ex)
    {
      Console.Error.WriteLine($"Error al generar comprobante: {ex.Message}");
    }
  }

  private class LineaVM
  {
    public int IdProducto { get; set; }
    public string CodigoInterno { get; set; } = string.Empty;
    public string Descripcion { get; set; } = string.Empty;
    public decimal StockOrigen { get; set; }
    public decimal Cantidad { get; set; }
    public decimal CostoUnitario { get; set; }
    public decimal CostoTotal { get; set; }
    public int CantidadPorPaquete { get; set; } = 1;
    public string? UnidadMedidaCodigo { get; set; }
    // ========== SOPORTE PARA LOTES ==========
    public bool ControlaLote { get; set; }
    public int? IdLoteOrigen { get; set; }  // Lote del dep贸sito origen
    public string? NumeroLote { get; set; }
    public DateTime? FechaVencimiento { get; set; }
  }
}

</PageProtection>
