@page "/compras"
@using Microsoft.AspNetCore.Components.Forms
@using Microsoft.AspNetCore.Components
@using Microsoft.EntityFrameworkCore
@using System.Text
@inject NavigationManager Nav
@using Microsoft.AspNetCore.WebUtilities
@inject IDbContextFactory<SistemIA.Models.AppDbContext> DbFactory
@inject IJSRuntime JS
@inject IInventarioService Inventario
@inject SistemIA.Services.ISucursalProvider SucursalProvider
@inject Sifen SifenService
@inject PermisosService PermisosService
@inject SistemIA.Services.ICajaService CajaService
@inject SistemIA.Services.IRucDnitService RucService
@inject SistemIA.Services.ITrackingService TrackingService
@inject AuditoriaService AuditoriaService
@using Microsoft.AspNetCore.Components.Authorization
@using static SistemIA.Models.AsistenteIA.TipoAccionTracking
@using static SistemIA.Models.AsistenteIA.CategoriaAccion

<PageProtection Modulo="/compras" Permiso="VIEW">

<div class="d-flex align-items-center justify-content-between mb-2">
    <h3 class="m-0">Registro de Compras</h3>
    <div class="d-flex gap-2">
        <button type="button" class="btn btn-outline-secondary btn-sm" title="Reimprimir √∫ltima compra" @onclick="ReimprimirUltimaAsync">
            <i class="bi bi-printer"></i> <span class="d-none d-sm-inline">Reimprimir</span>
        </button>
        <a class="btn btn-outline-primary btn-sm" href="/compras/explorar" title="Explorar compras">
            <i class="bi bi-journal-text"></i> <span class="d-none d-sm-inline">Explorar</span>
        </a>
    </div>
</div>

@if (!string.IsNullOrEmpty(Error))
{
    <div class="alert alert-danger">@Error</div>
}
@if (!string.IsNullOrEmpty(Ok))
{
    <div class="alert alert-success">@Ok</div>
}

@if (ModoSoloVista)
{
    <div class="alert alert-info d-flex align-items-center justify-content-between mb-3">
        <span><i class="bi bi-eye"></i> <strong>Modo Visualizaci√≥n</strong> - Las compras confirmadas no pueden ser editadas.</span>
        <div class="d-flex gap-2">
            <button type="button" class="btn btn-sm btn-outline-secondary" @onclick="RefrescarPaginaAsync" title="Refrescar">
                <i class="bi bi-arrow-clockwise"></i>
            </button>
            <button type="button" class="btn btn-sm btn-primary" @onclick="NuevaCompraAsync">
                <i class="bi bi-plus-circle"></i> Nueva Compra
            </button>
        </div>
    </div>
}

<fieldset disabled="@ModoSoloVista">
<EditForm Model="Compra" OnValidSubmit="GuardarAsync">
    <DataAnnotationsValidator />
    <ValidationSummary />

    <div class="row g-3">
    <div class="col-md-6">
        <div class="alert alert-info py-2">
                <div class="d-flex flex-wrap gap-3 align-items-center">
            <div class="d-flex align-items-center gap-1">
                <strong>Caja:</strong>
                @if (PuedeCambiarCaja && !ModoSoloVista && Cajas.Any())
                {
                    <select class="form-select form-select-sm" style="width: auto; min-width: 120px;" 
                            @bind="Compra.IdCaja" @bind:after="OnCajaChanged">
                        <option value="">-- Seleccionar --</option>
                        @foreach (var c in Cajas)
                        {
                            <option value="@c.IdCaja">@(string.IsNullOrWhiteSpace(c.Nombre) ? $"Caja #{c.IdCaja}" : $"{c.Nombre} (#{c.IdCaja})")</option>
                        }
                    </select>
                }
                else
                {
                    <span>@(CajaActiva != null ? (string.IsNullOrWhiteSpace(CajaActiva.Nombre) ? $"Caja #{CajaActiva.IdCaja}" : CajaActiva.Nombre) : "‚Äî")</span>
                }
            </div>
            <div><strong>Fecha Caja:</strong> @(FechaCajaActual?.ToString("dd/MM/yyyy") ?? "‚Äî")</div>
            <div><strong>Turno actual:</strong> @(TurnoActual?.ToString() ?? "‚Äî")</div>
                </div>
            </div>
        </div>
        <div class="col-md-5">
            <label class="form-label d-flex align-items-center justify-content-between">
                <span>Proveedor</span>
                <span class="d-flex gap-1">
                    <button type="button" class="btn btn-sm btn-outline-secondary" title="Refrescar proveedores" @onclick="RefrescarProveedoresAsync">
                        <i class="bi bi-arrow-clockwise"></i>
                    </button>
                    <button type="button" class="btn btn-sm btn-outline-primary" title="Nuevo proveedor r√°pido" @onclick="AbrirModalNuevoProveedor">
                        <i class="bi bi-plus-circle"></i>
                    </button>
                </span>
            </label>
            <div class="position-relative">
                <div class="input-group">
                    <span class="input-group-text"><i class="bi bi-search"></i></span>
                    <input class="form-control @(_buscandoRucAuto ? "border-info" : "")" placeholder="Buscar por nombre o RUC" @bind="BuscarProveedor" @bind:event="oninput" @onkeydown="OnProveedorKeyDown" @onfocus="OnProveedorFocus" @onblur="OnProveedorBlur" autocomplete="off" />
                    @if (_buscandoRucAuto)
                    {
                        <span class="input-group-text bg-info border-info">
                            <div class="spinner-border spinner-border-sm text-white" role="status"></div>
                        </span>
                    }
                </div>
                @if (!string.IsNullOrEmpty(_mensajeRucAuto))
                {
                    <div class="small mt-1 @(_esRucAutoError ? "text-warning" : "text-success")">
                        @_mensajeRucAuto
                    </div>
                }
                @if (MostrarSugProveedores && ProveedoresFiltrados.Any())
                {
                    <div class="list-group position-absolute w-100 z-3" style="max-height: 260px; overflow:auto;">
            @foreach (var p in ProveedoresFiltrados.Take(12))
                        {
                            <button type="button" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center" @onclick="() => SeleccionarProveedor(p)">
                                <span>@p.RazonSocial</span>
                <small class="text-muted">@p.RUC@(p.DV > 0 ? ("-" + p.DV.ToString()) : string.Empty)</small>
                            </button>
                        }
                    </div>
                }
            </div>
        </div>
        
    <div class="col-md-2">
            <label class="form-label">Moneda</label>
            <InputSelect class="form-select" @bind-Value="Compra.IdMoneda" TValue="int?" @onchange="OnMonedaChangedAsync">
                <option value="">-- Seleccione --</option>
                @foreach (var m in Monedas)
                {
            <option value="@m.IdMoneda">@GetCurrencyFlag(m.CodigoISO) @m.Nombre (@m.CodigoISO)</option>
                }
            </InputSelect>
        </div>
        @if (Compra.IdMoneda.HasValue && Monedas.FirstOrDefault(m => m.IdMoneda == Compra.IdMoneda.Value)?.EsMonedaBase == false)
        {
            <div class="col-md-2">
                <label class="form-label">Tipo de Cambio</label>
                <div class="input-group">
                    <span class="input-group-text">@(Monedas.FirstOrDefault(m => m.EsMonedaBase)?.Simbolo ?? "Gs.")</span>
                    <input type="number" class="form-control" step="0.01" min="0" 
                           @bind="Compra.CambioDelDia" 
                           @bind:after="@(() => OnCambioManualChangedAsync())" 
                           placeholder="6850" />
                </div>
                <small class="text-muted">Editable para ajustar precio</small>
            </div>
        }
        <div class="col-md-3">
            <label class="form-label">Fecha</label>
            <InputDate TValue="DateTime" class="form-control" @bind-Value="Compra.Fecha" />
        </div>
    </div>

    <div class="row g-3 mt-2">
        <div class="col-md-2">
            <label class="form-label">Nivel 1</label>
            <InputText class="form-control" @bind-Value="Compra.Establecimiento" />
        </div>
        <div class="col-md-2">
            <label class="form-label">Nivel 2</label>
            <InputText class="form-control" @bind-Value="Compra.PuntoExpedicion" />
        </div>
        <div class="col-md-3">
            <label class="form-label">Nro. Factura (7)</label>
            <InputText class="form-control" @bind-Value="Compra.NumeroFactura" />
        </div>
    <div class="col-md-2">
            <label class="form-label">Timbrado</label>
            <InputText class="form-control" @bind-Value="Compra.Timbrado" />
        </div>
    <div class="col-md-3">
            <label class="form-label">Venc. timbrado (proveedor)</label>
            <InputDate TValue="DateTime?" class="form-control" @bind-Value="VencimientoTimbradoProveedorSel" />
        </div>
        <div class="col-md-3">
            <label class="form-label d-flex align-items-center justify-content-between">
                <span>Tipo Doc.</span>
                @if (!ModoSoloVista)
                {
                    <a href="/configuracion/tipos-documento" class="btn btn-sm btn-outline-secondary" title="Configurar tipos" target="_blank">
                        <i class="bi bi-gear"></i>
                    </a>
                }
            </label>
            <InputSelect class="form-select" @bind-Value="Compra.IdTipoDocumentoOperacion" TValue="int?" @onchange="OnTipoDocumentoChanged">
                <option value="">-- Seleccione --</option>
                @foreach (var t in TiposDocumento)
                {
                    <option value="@t.IdTipoDocumentoOperacion">@t.Nombre</option>
                }
            </InputSelect>
        </div>
    <div class="col-md-2">
            <label class="form-label">Tipo de pago</label>
            <InputSelect class="form-select" @bind-Value="Compra.IdTipoPago" @bind-Value:after="OnTipoPagoChanged">
                <option value="">-- Seleccione --</option>
                @foreach (var t in TiposPago)
                {
                    <option value="@t.IdTipoPago">@t.Nombre</option>
                }
            </InputSelect>
        </div>
        @if (MostrarCamposCredito)
        {
            <div class="col-md-1">
                <label class="form-label">N¬∫ Cuotas</label>
                <input type="number" class="form-control" @bind="NumeroCuotasCompra" min="1" max="60" placeholder="1" />
            </div>
            <div class="col-md-1">
                <label class="form-label">Plazo</label>
                <input type="number" class="form-control" @bind="Compra.PlazoDias" @bind:after="OnPlazoChanged" min="1" placeholder="30" />
            </div>
            <div class="col-md-2">
                <label class="form-label">Vencimiento</label>
                <InputDate TValue="DateTime?" class="form-control" @bind-Value="Compra.FechaVencimiento" />
            </div>
        }
        <div class="col-md-2">
            <label class="form-label">Medio de pago</label>
            @if (EsTipoPagoContado())
            {
                <InputSelect class="form-select" @bind-Value="Compra.MedioPago">
                    @foreach (var mp in MediosPago)
                    {
                        <option value="@mp">@mp</option>
                    }
                </InputSelect>
            }
            else
            {
                <InputText class="form-control" @bind-Value="Compra.MedioPago" readonly />
            }
        </div>
    <div class="col-md-2">
            <label class="form-label">Estado</label>
            <InputText class="form-control" @bind-Value="Compra.Estado" />
        </div>
    </div>

    <hr />
    <h5>Detalle</h5>

    <div class="row g-2 align-items-end">
        <div class="col-md-4">
            <label class="form-label d-flex align-items-center justify-content-between">
                <span>Producto</span>
                <span class="d-flex gap-1">
                    <button type="button" class="btn btn-sm btn-outline-secondary" title="Refrescar productos" @onclick="RefrescarProductosAsync">
                        <i class="bi bi-arrow-clockwise"></i>
                    </button>
                    <button type="button" class="btn btn-sm btn-outline-primary" title="Nuevo producto" @onclick="AbrirModalNuevoProducto">
                        <i class="bi bi-plus-circle"></i>
                    </button>
                </span>
            </label>
            <div class="position-relative">
                <div class="input-group">
                    <span class="input-group-text"><i class="bi bi-search"></i></span>
                    <input id="inputBuscarProductoCompras" class="form-control" placeholder="Buscar por parte del nombre" @bind="BuscarProducto" @bind:event="oninput" @onkeyup="OnProductoKeyUp" @onfocus="OnProductoFocus" @onblur="OnProductoBlur" autocomplete="off" />
                </div>
                @if (MostrarSugProductos && ProductosFiltrados.Any())
                {
                    <div class="list-group position-absolute w-100 z-3" style="max-height: 260px; overflow:auto;">
                        @foreach (var p in ProductosFiltrados.Take(12))
                        {
                            <button type="button"
                                    class="list-group-item list-group-item-action"
                                    tabindex="-1"
                                    @onpointerdown="() => OnProductoSuggestionMouseDownAsync(p)" @onpointerdown:preventDefault @onpointerdown:stopPropagation
                                    @onmousedown="() => OnProductoSuggestionMouseDownAsync(p)" @onmousedown:preventDefault @onmousedown:stopPropagation
                                    @onclick="() => OnProductoSuggestionMouseDownAsync(p)" @onclick:preventDefault @onclick:stopPropagation>
                                @p.Descripcion
                            </button>
                        }
                    </div>
                }
            </div>
        </div>
        <div class="col-md-1">
            <label class="form-label">Cantidad</label>
            <input id="inputCantidadCompras" type="number" step="@(NuevoDetalle.PermiteDecimal ? "0.01" : "1")" min="@(NuevoDetalle.PermiteDecimal ? "0.01" : "1")" class="form-control" @bind="CantidadInput" @bind:event="oninput" @onfocusout="ValidarCantidadCompra" />
        </div>
        <div class="col-md-1">
            <label class="form-label">Precio</label>
            <input id="inputPrecioCompras" type="number" step="0.01" class="form-control" @bind="PrecioInput" @bind:event="oninput" />
        </div>
        <div class="col-md-1">
            <label class="form-label">Factor</label>
            <input id="inputFactorCompras" type="number" step="any" class="form-control" 
                   value="@(FactorMultiplicador?.ToString(System.Globalization.CultureInfo.InvariantCulture))" 
                   @onchange="OnFactorInputChanged" placeholder="1.30" />
        </div>
        <div class="col-md-1">
            <label class="form-label">% Mark-up</label>
            <input id="inputMarkupCompras" type="number" step="any" class="form-control" 
                   value="@(PorcentajeMargen?.ToString(System.Globalization.CultureInfo.InvariantCulture))" 
                   @onchange="OnPorcentajeInputChanged" placeholder="30" title="Porcentaje sobre el costo" />
        </div>
        <div class="col-md-1">
            <label class="form-label">Pre. Venta <span class="text-danger">*</span></label>
            <input id="inputPrecioVentaCompras" type="number" step="1" class="form-control" 
                   value="@(PrecioVentaCalculado?.ToString(System.Globalization.CultureInfo.InvariantCulture))" 
                   @onchange="OnPrecioVentaInputChanged" placeholder="0" title="Precio de venta al p√∫blico" />
        </div>
        <div class="col-md-1">
            <label class="form-label">Dep√≥sito</label>
            <select id="inputDepositoCompras" class="form-select" @bind="IdDepositoItemSeleccionado">
                <option value="">-- Seleccione --</option>
                @foreach (var d in Depositos)
                {
                    <option value="@d.IdDeposito">@d.Nombre</option>
                }
            </select>
        </div>
        @if (MostrarPrecioMinisterioEnCompras)
        {
            <div class="col-md-1">
                <label class="form-label">üè• P.Min.</label>
                <input id="inputPrecioMinisterioCompras" type="number" step="1" class="form-control" @bind="PrecioMinisterioInput" @bind:event="oninput" placeholder="0" title="Precio Ministerio (m√°ximo regulado)" />
            </div>
        }
        @{
            var productoSeleccionado = Productos.FirstOrDefault(p => p.IdProducto == NuevoDetalle.IdProducto);
            var productoRequiereVencimiento = productoSeleccionado?.ControlarVencimiento == true;
        }
        @if (productoRequiereVencimiento)
        {
            <div class="col-md-2">
                <label class="form-label">
                    <i class="bi bi-calendar-x me-1 text-warning"></i>Vencimiento
                </label>
                <input id="inputVencimientoCompras" type="date" class="form-control" @bind="FechaVencimientoItemSeleccionada" />
            </div>
        }
        <div class="col-md-1 d-flex flex-column">
            <label class="form-label">&nbsp;</label>
            <button id="btnAgregarDetalleCompras" type="button" class="btn btn-primary" @onclick="AgregarDetalleAsync" @onkeydown="OnBtnAgregarKeyDown" @onkeydown:preventDefault="@_prevenirTabEnAgregar">
                <i class="bi bi-plus-circle me-1"></i>Agregar
            </button>
        </div>
    </div>

    <div class="row mt-1">
        <div class="col-md-12">
            <div class="d-flex gap-2 align-items-center text-muted small">
                <span>Stock: <strong>@(StockActualSeleccion.HasValue ? StockActualSeleccion.Value.ToString("N2") : "‚Äî")</strong></span>
                <span>|</span>
                <span>Grav. 10%: <strong>@FormatearPrecio(NuevoDetalle.Grabado10)</strong></span>
                <span>IVA 10%: <strong>@FormatearPrecio(NuevoDetalle.IVA10)</strong></span>
                <span>|</span>
                <span>Grav. 5%: <strong>@FormatearPrecio(NuevoDetalle.Grabado5)</strong></span>
                <span>IVA 5%: <strong>@FormatearPrecio(NuevoDetalle.IVA5)</strong></span>
                <span>|</span>
                <span>Exenta: <strong>@FormatearPrecio(NuevoDetalle.Exenta)</strong></span>
                <span>|</span>
                <span>Total l√≠nea: <strong class="text-primary">@FormatearPrecio(NuevoDetalle.Importe)</strong></span>
                @{
                    decimal? pctUtilidadCompra = null;
                    if (PrecioInput > 0 && PrecioVentaCalculado.HasValue && PrecioVentaCalculado.Value > 0)
                    {
                        pctUtilidadCompra = ((PrecioVentaCalculado.Value - PrecioInput) / PrecioVentaCalculado.Value) * 100;
                    }
                    var colorUtilidadCompra = pctUtilidadCompra.HasValue ? (pctUtilidadCompra.Value >= 30 ? "text-success" : "text-danger") : "text-muted";
                }
                @if (pctUtilidadCompra.HasValue)
                {
                    <span>|</span>
                    <span class="@colorUtilidadCompra" title="% Utilidad (sobre precio venta)"><strong>Util: @pctUtilidadCompra.Value.ToString("N1")%</strong></span>
                }
                @if (FactorMultiplicador.HasValue && FactorMultiplicador.Value > 0 && PrecioVentaCalculado.HasValue)
                {
                    <span>|</span>
                    <span>Precio Venta: <strong class="text-success">@FormatearPrecio(PrecioVentaCalculado.Value)</strong></span>
                }
                @{
                    var prodSel = Productos.FirstOrDefault(p => p.IdProducto == NuevoDetalle.IdProducto);
                    var codOri = Monedas.FirstOrDefault(m => m.IdMoneda == (prodSel?.IdMonedaPrecio ?? Compra.IdMoneda))?.CodigoISO ?? string.Empty;
                    var codDes = Monedas.FirstOrDefault(m => m.IdMoneda == Compra.IdMoneda)?.CodigoISO ?? string.Empty;
                }
                @if (NuevoDetalle.CambioDelDia.HasValue)
                {
                    <span>|</span>
                    <span>TC: <strong>@GetCurrencyFlag(codOri)@codOri/@codDes@GetCurrencyFlag(codDes) @NuevoDetalle.CambioDelDia.Value.ToString("N4")</strong></span>
                }
            </div>
        </div>
    </div>

    <div class="row g-3 mt-2">
        <div class="col-lg-8">
            <table class="table table-sm">
                <thead>
                <tr>
                    <th>Producto</th>
                    <th>Dep√≥sito</th>
                    @if (AlgunDetalleConVencimiento)
                    {
                        <th>Vencimiento</th>
                    }
                    <th class="text-end">Cantidad</th>
                    <th class="text-end">Pre. Unit. Compra</th>
                    <th class="text-end">Importe Compra</th>
                    <th class="text-end">Factor</th>
                    <th class="text-end">% Mark-up</th>
                    <th class="text-end">Pre. Unit. Venta</th>
                    @if (MostrarPrecioMinisterioEnCompras)
                    {
                        <th class="text-end">üè• P.Ministerio</th>
                    }
                    <th class="text-end">TC</th>
                    <th>IVA</th>
                    <th></th>
                </tr>
                </thead>
                <tbody>
        @foreach (var d in Detalles)
        {
            var prod = Productos.FirstOrDefault(x => x.IdProducto == d.IdProducto);
            var deposito = Depositos.FirstOrDefault(dep => dep.IdDeposito == d.IdDepositoItem);
            <tr @onclick="() => SeleccionarDetalleCompra(prod)" style="cursor: pointer;" class="@(ProductoImagenUrl == prod?.Foto ? "table-active" : "")" title="Clic para ver imagen">
                <td>@prod?.Descripcion</td>
                <td>
                    @if (d.IdDepositoItem.HasValue)
                    {
                        var nombreDeposito = deposito?.Nombre ?? "(Otro)";
                        <span class="badge bg-primary">@nombreDeposito</span>
                    }
                    else
                    {
                        <span class="text-muted small">(Sin dep√≥sito)</span>
                    }
                </td>
                @if (AlgunDetalleConVencimiento)
                {
                    <td>
                        @if (d.FechaVencimientoItem.HasValue)
                        {
                            var diasRestantes = (d.FechaVencimientoItem.Value - DateTime.Now).Days;
                            var claseColor = diasRestantes < 0 ? "text-danger" : diasRestantes <= 30 ? "text-warning" : "text-success";
                            <span class="@claseColor small">@d.FechaVencimientoItem.Value.ToString("dd/MM/yyyy")</span>
                        }
                        else
                        {
                            <span class="text-muted small">-</span>
                        }
                    </td>
                }
                <td class="text-end"><strong>@d.Cantidad</strong></td>
                <td class="text-end text-primary fw-semibold">@FormatearPrecio(d.PrecioUnitario)</td>
                <td class="text-end text-success fw-bold">@FormatearPrecio(d.Importe)</td>
                <td class="text-end">
                    @if (d.FactorMultiplicador.HasValue && d.FactorMultiplicador.Value > 0)
                    {
                        <span class="badge bg-secondary">@d.FactorMultiplicador.Value.ToString("N2")</span>
                    }
                    else
                    {
                        <span class="text-muted">‚Äî</span>
                    }
                </td>
                <td class="text-end">
                    @if (d.PorcentajeMargen.HasValue)
                    {
                        <span class="badge bg-secondary text-white">@d.PorcentajeMargen.Value.ToString("N1")%</span>
                    }
                    else
                    {
                        <span class="text-muted">‚Äî</span>
                    }
                    @{
                      decimal? pctUtilidadDet = null;
                      if (d.PrecioUnitario > 0 && d.PrecioVentaRef > 0)
                      {
                        pctUtilidadDet = ((d.PrecioVentaRef - d.PrecioUnitario) / d.PrecioVentaRef) * 100;
                      }
                      var colorUtilidadDet = pctUtilidadDet.HasValue ? (pctUtilidadDet.Value >= 30m ? "text-primary" : "text-danger") : "text-muted";
                    }
                    <br/><small class="@colorUtilidadDet">Ut: @(pctUtilidadDet.HasValue ? $"{pctUtilidadDet.Value:N1}%" : "‚Äî")</small>
                </td>
                <td class="text-end text-info fw-semibold">@FormatearPrecio(d.PrecioVentaRef)</td>
                @if (MostrarPrecioMinisterioEnCompras)
                {
                    // Usar precio ministerio del detalle si existe, sino del producto
                    var precioMin = d.PrecioMinisterio ?? prod?.PrecioMinisterio;
                    var precioVenta = d.PrecioVentaRef;
                    var superaPrecio = ValidarPrecioMinisterio && precioMin.HasValue && precioVenta > precioMin.Value;
                    <td class="text-end">
                        @if (precioMin.HasValue)
                        {
                            <span class="@(superaPrecio ? "text-danger fw-bold" : "text-warning")">
                                @FormatearPrecio(precioMin.Value)
                                @if (superaPrecio)
                                {
                                    <i class="bi bi-exclamation-triangle-fill" title="El precio de venta supera el precio ministerio"></i>
                                }
                            </span>
                        }
                        else
                        {
                            <span class="text-muted">‚Äî</span>
                        }
                    </td>
                }
                @{ var codOriTc = Monedas.FirstOrDefault(m => m.IdMoneda == (prod?.IdMonedaPrecio ?? Compra.IdMoneda))?.CodigoISO ?? string.Empty;
                    var codDesTc = Monedas.FirstOrDefault(m => m.IdMoneda == Compra.IdMoneda)?.CodigoISO ?? string.Empty;
                    var txTxt = d.CambioDelDia.HasValue ? ($"{GetCurrencyFlag(codOriTc)} {codOriTc}/{codDesTc} {GetCurrencyFlag(codDesTc)} {d.CambioDelDia.Value.ToString("N4")}") : "‚Äî"; }
                <td class="text-end"><span class="text-muted">@txTxt</span></td>
                <td>@(prod?.TipoIva?.Descripcion ?? prod?.TipoIva?.CodigoAbreviado)</td>
                <td>
                    <button type="button" class="btn btn-sm btn-outline-danger" @onclick="() => QuitarDetalle(d)">Quitar</button>
                </td>
            </tr>
        }
        </tbody>
    </table>
        </div>
        <div class="col-lg-4">
            @if (!string.IsNullOrWhiteSpace(ProductoImagenUrl))
            {
                <div class="card mb-3 border-primary">
                    <div class="card-header bg-primary text-white py-2">
                        <small><i class="bi bi-image"></i> Imagen del Producto</small>
                    </div>
                    <div class="card-body p-2 text-center bg-white">
                        <img src="@ProductoImagenUrl" alt="Producto" class="img-fluid rounded" style="max-height: 200px; object-fit: contain;" />
                    </div>
                </div>
            }
            <div class="card">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <span>Gravado 10%</span>
                        <strong>@FormatearPrecio(Gravado10)</strong>
                    </div>
                    <div class="d-flex justify-content-between">
                        <span>Gravado 5%</span>
                        <strong>@FormatearPrecio(Gravado5)</strong>
                    </div>
                    <div class="d-flex justify-content-between">
                        <span>IVA 10%</span>
                        <strong>@FormatearPrecio(IVATotal10)</strong>
                    </div>
                    <div class="d-flex justify-content-between">
                        <span>IVA 5%</span>
                        <strong>@FormatearPrecio(IVATotal5)</strong>
                    </div>
                    <div class="d-flex justify-content-between">
                        <span>Exentas</span>
                        <strong>@FormatearPrecio(Exenta)</strong>
                    </div>
                    <hr />
                    <div class="d-flex justify-content-between">
                        <span>Total</span>
                        <strong>@SimboloMonedaActual @FormatearPrecio(Compra.Total)</strong>
                    </div>
                </div>
            </div>
            @if (!ModoSoloVista)
            {
                <div class="d-flex justify-content-end gap-2 mt-3 align-items-center">
                    <small class="text-muted me-2" title="Atajo de teclado"><kbd>F2</kbd> Guardar</small>
                    <button class="btn btn-success" type="submit"><i class="bi bi-check2-circle"></i> Guardar</button>
                    <button class="btn btn-secondary" type="button" @onclick="Limpiar">Limpiar</button>
                </div>
            }
            <div class="mt-3 text-muted small">
                <span title="Total en letras seg√∫n moneda seleccionada">@TotalActualEnLetras</span>
            </div>
        </div>
    </div>
</EditForm>
</fieldset>

@* Secci√≥n de administraci√≥n avanzada (solo visible en modo visualizaci√≥n para usuarios con permisos de editar y eliminar) *@
@if (ModoSoloVista && PuedeReciclar)
{
    <div class="mt-4">
        <details class="border rounded p-2 bg-light">
            <summary class="text-muted small cursor-pointer" style="cursor:pointer;">
                <i class="bi bi-gear"></i> Opciones avanzadas de administraci√≥n
            </summary>
            <div class="mt-3 p-2">
                <div class="alert alert-warning py-2 small">
                    <i class="bi bi-exclamation-triangle"></i> <strong>Precauci√≥n:</strong> 
                    Esta acci√≥n eliminar√° la compra de la base de datos y preparar√° los datos para editar y guardar como nueva.
                </div>
                <button type="button" class="btn btn-sm btn-outline-warning" @onclick="MostrarModalReciclarCompraAsync">
                    <i class="bi bi-recycle"></i> Reciclar Compra #@Compra.IdCompra
                </button>
            </div>
        </details>
    </div>
}

@* Modal para crear nuevo proveedor r√°pido *@
@if (_mostrarModalProveedor)
{
    <div class="modal fade show d-block" tabindex="-1" style="background:rgba(0,0,0,0.5);" @onclick="CerrarModalProveedor">
        <div class="modal-dialog modal-dialog-centered" @onclick:stopPropagation="true">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title"><i class="bi bi-building-add"></i> Nuevo Proveedor R√°pido</h5>
                    <button type="button" class="btn-close btn-close-white" @onclick="CerrarModalProveedor"></button>
                </div>
                <div class="modal-body">
                    @if (!string.IsNullOrEmpty(_errorProveedor))
                    {
                        <div class="alert alert-danger py-2">@_errorProveedor</div>
                    }
                    @if (!string.IsNullOrEmpty(_successProveedor))
                    {
                        <div class="alert alert-success py-2">@_successProveedor</div>
                    }

                    <div class="row g-3">
                        <div class="col-8">
                            <label class="form-label">RUC <span class="text-danger">*</span></label>
                            <div class="input-group">
                                <input type="text" class="form-control" @bind="_nuevoProvRuc" @bind:event="oninput" @onblur="CalcularDvProveedor" placeholder="Ej: 80012345" maxlength="10" />
                                <button type="button" class="btn btn-outline-primary" @onclick="BuscarProveedorEnSifenAsync" disabled="@_buscandoProveedorSifen" title="Buscar en BD local y SIFEN">
                                    @if (_buscandoProveedorSifen)
                                    {
                                        <span class="spinner-border spinner-border-sm"></span>
                                    }
                                    else
                                    {
                                        <i class="bi bi-search"></i>
                                    }
                                </button>
                            </div>
                            <small class="text-muted">Sin gui√≥n ni DV</small>
                            @if (!string.IsNullOrEmpty(_mensajeSifenProveedor))
                            {
                                <div class="@(_esSifenProveedorError ? "text-danger" : "text-success") small mt-1">@_mensajeSifenProveedor</div>
                            }
                        </div>
                        <div class="col-4">
                            <label class="form-label">DV</label>
                            <input type="text" class="form-control" value="@_nuevoProvDv" readonly />
                            <small class="text-muted">Calculado</small>
                        </div>
                        <div class="col-12">
                            <label class="form-label">Raz√≥n Social <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" @bind="_nuevoProvRazonSocial" placeholder="Nombre de la empresa" />
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Timbrado <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" @bind="_nuevoProvTimbrado" placeholder="8 d√≠gitos" maxlength="8" />
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Venc. Timbrado <span class="text-danger">*</span></label>
                            <input type="date" class="form-control" @bind="_nuevoProvVencTimbrado" />
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="CerrarModalProveedor">Cancelar</button>
                    <button type="button" class="btn btn-primary" @onclick="GuardarNuevoProveedorAsync" disabled="@_guardandoProveedor">
                        @if (_guardandoProveedor)
                        {
                            <span class="spinner-border spinner-border-sm me-1"></span>
                        }
                        <i class="bi bi-check-lg"></i> Guardar
                    </button>
                </div>
            </div>
        </div>
    </div>
}

@* Modal para crear nuevo producto r√°pido *@
@if (_mostrarModalProducto)
{
    <div class="modal fade show d-block" tabindex="-1" style="background:rgba(0,0,0,0.5);" @onclick="CerrarModalProducto">
        <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable" @onclick:stopPropagation="true">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title"><i class="bi bi-box-seam-fill me-2"></i>Nuevo Producto R√°pido</h5>
                    <button type="button" class="btn-close btn-close-white" @onclick="CerrarModalProducto"></button>
                </div>
                <div class="modal-body">
                    @if (!string.IsNullOrEmpty(_errorProducto))
                    {
                        <div class="alert alert-danger py-2">@_errorProducto</div>
                    }
                    @if (!string.IsNullOrEmpty(_successProducto))
                    {
                        <div class="alert alert-success py-2">@_successProducto</div>
                    }

                    <div class="row g-3">
                        @* Informaci√≥n B√°sica *@
                        <div class="col-12">
                            <h6 class="text-success border-bottom pb-1 mb-2"><i class="bi bi-info-circle me-1"></i>Informaci√≥n B√°sica</h6>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">C√≥digo (dCodInt)</label>
                            <input type="text" class="form-control form-control-sm bg-secondary-subtle" value="Se generar√° autom√°ticamente" readonly />
                            <small class="text-muted">El sistema asignar√° el c√≥digo al guardar.</small>
                        </div>
                        <div class="col-md-5">
                            <label class="form-label">Descripci√≥n (dDesProSer) <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" @bind="_nuevoProducto.Descripcion" placeholder="Nombre del producto" maxlength="200" />
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">C√≥digo de Barras</label>
                            <input type="text" class="form-control" @bind="_nuevoProducto.CodigoBarras" placeholder="GTIN-8/12/13/14" maxlength="14" />
                        </div>

                        @* Clasificaci√≥n *@
                        <div class="col-12 mt-3">
                            <h6 class="text-success border-bottom pb-1 mb-2"><i class="bi bi-tags me-1"></i>Clasificaci√≥n</h6>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Tipo √çtem</label>
                            <select class="form-select" @bind="_nuevoProducto.TipoItem">
                                <option value="1">Producto</option>
                                <option value="2">Servicio</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Marca</label>
                            <select class="form-select" @bind="_nuevoProducto.IdMarca">
                                <option value="">(Sin marca)</option>
                                @foreach (var m in _marcasModal)
                                {
                                    <option value="@m.IdMarca">@m.NombreMarca</option>
                                }
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Clasificaci√≥n</label>
                            <select class="form-select" @bind="_nuevoProducto.IdClasificacion">
                                <option value="">(Sin clasificaci√≥n)</option>
                                @foreach (var c in _clasificacionesModal)
                                {
                                    <option value="@c.IdClasificacion">@c.Nombre</option>
                                }
                            </select>
                        </div>

                        @* Unidad e Impuestos *@
                        <div class="col-12 mt-3">
                            <h6 class="text-success border-bottom pb-1 mb-2"><i class="bi bi-percent me-1"></i>Unidad e Impuestos</h6>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Tipo de IVA <span class="text-danger">*</span></label>
                            <select class="form-select" @bind="_nuevoProducto.IdTipoIva">
                                @foreach (var iva in _tiposIvaModal)
                                {
                                    <option value="@iva.IdTipoIva">@iva.Descripcion (@iva.Porcentaje%)</option>
                                }
                            </select>
                        </div>

                        @* Opciones de Venta *@
                        <div class="col-12 mt-3">
                            <h6 class="text-success border-bottom pb-1 mb-2"><i class="bi bi-toggles me-1"></i>Opciones de Venta</h6>
                        </div>
                        <div class="col-md-3">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="npPermiteDecimal" @bind="_nuevoProducto.PermiteDecimal" />
                                <label class="form-check-label" for="npPermiteDecimal">
                                    <i class="bi bi-123 me-1"></i>Permite Venta Decimal
                                </label>
                            </div>
                            <small class="text-muted">Ej: 0.5 kg</small>
                        </div>
                        <div class="col-md-3">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="npControladoReceta" @bind="_nuevoProducto.ControladoReceta" />
                                <label class="form-check-label" for="npControladoReceta">
                                    <i class="bi bi-file-medical me-1"></i>Controlado con Receta
                                </label>
                            </div>
                            <small class="text-muted">Requiere receta m√©dica</small>
                        </div>
                        <div class="col-md-3">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="npControlarVenc" @bind="_nuevoProducto.ControlarVencimiento" />
                                <label class="form-check-label" for="npControlarVenc">
                                    <i class="bi bi-calendar-x me-1"></i>Controlar Vencimiento
                                </label>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="npActivo" @bind="_nuevoProducto.Activo" />
                                <label class="form-check-label" for="npActivo">
                                    <i class="bi bi-check-circle me-1"></i>Activo
                                </label>
                            </div>
                            <small class="text-muted">Disponible para venta</small>
                        </div>

                        @* Imagen *@
                        <div class="col-12 mt-3">
                            <h6 class="text-success border-bottom pb-1 mb-2"><i class="bi bi-image me-1"></i>Imagen</h6>
                        </div>
                        <div class="col-12">
                            <div class="d-flex align-items-center gap-3">
                                <div class="border rounded p-2 bg-light" style="width:80px;height:80px;display:flex;align-items:center;justify-content:center;">
                                    @if (!string.IsNullOrEmpty(_previewImagenProducto))
                                    {
                                        <img src="@_previewImagenProducto" style="max-width:100%;max-height:100%;object-fit:contain;" />
                                    }
                                    else
                                    {
                                        <i class="bi bi-image text-muted" style="font-size:2rem;"></i>
                                    }
                                </div>
                                <div>
                                    <InputFile OnChange="OnImagenProductoChange" accept="image/png,image/jpeg,image/webp" class="form-control form-control-sm" style="max-width:250px;" />
                                    <small class="text-muted d-block">PNG/JPG/WEBP hasta 2 MB.</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="CerrarModalProducto">Cancelar</button>
                    <button type="button" class="btn btn-success" @onclick="GuardarNuevoProductoAsync" disabled="@_guardandoProducto">
                        @if (_guardandoProducto)
                        {
                            <span class="spinner-border spinner-border-sm me-1"></span>
                        }
                        <i class="bi bi-check-lg me-1"></i>Guardar
                    </button>
                </div>
            </div>
        </div>
    </div>
}

@* Modal para reciclar compra (eliminar y editar) *@
@if (_mostrarModalReciclar)
{
    <div class="modal fade show d-block" tabindex="-1" style="background:rgba(0,0,0,0.6);" @onclick="CerrarModalReciclar">
        <div class="modal-dialog modal-dialog-centered" @onclick:stopPropagation="true">
            <div class="modal-content">
                <div class="modal-header bg-warning text-dark">
                    <h5 class="modal-title"><i class="bi bi-recycle"></i> Reciclar Compra #@Compra.IdCompra</h5>
                    <button type="button" class="btn-close" @onclick="CerrarModalReciclar"></button>
                </div>
                <div class="modal-body">
                    @if (!string.IsNullOrEmpty(_errorReciclar))
                    {
                        <div class="alert alert-danger py-2">@_errorReciclar</div>
                    }
                    
                    <div class="alert alert-warning">
                        <h6><i class="bi bi-exclamation-triangle"></i> Esta acci√≥n:</h6>
                        <ul class="mb-0">
                            <li><strong>Eliminar√° permanentemente</strong> la compra #@Compra.IdCompra</li>
                            <li><strong>Revertir√° el stock</strong> de todos los productos</li>
                            <li>Mantendr√° los datos en pantalla para <strong>editar y guardar como nueva</strong></li>
                        </ul>
                    </div>
                    
                    <p class="text-muted small">Requiere: perfil <strong>administrador</strong> con permisos de <strong>Editar</strong> y <strong>Eliminar</strong> en Compras.</p>
                    
                    <div class="mb-3">
                        <label class="form-label">Ingrese su contrase√±a para confirmar</label>
                        <input type="password" class="form-control" @bind="_passwordReciclar" placeholder="Su contrase√±a" />
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="CerrarModalReciclar">Cancelar</button>
                    <button type="button" class="btn btn-warning" @onclick="EjecutarReciclarCompraAsync" disabled="@_procesandoReciclar">
                        @if (_procesandoReciclar)
                        {
                            <span class="spinner-border spinner-border-sm me-1"></span>
                        }
                        <i class="bi bi-recycle"></i> Reciclar Compra
                    </button>
                </div>
            </div>
        </div>
    </div>
}

@code {
    private string? Error;
    private string? Ok;

    [CascadingParameter]
    private Task<AuthenticationState> AuthStateTask { get; set; } = default!;
    private int? _usuarioId;
    private string? _usuarioNombre;
    private bool _esUsuarioAdmin; // Si el usuario actual tiene rol administrador
    private bool _tienePermisoEditar; // Permiso EDIT en m√≥dulo Compras
    private bool _tienePermisoEliminar; // Permiso DELETE en m√≥dulo Compras
    private bool PuedeReciclar => _esUsuarioAdmin && _tienePermisoEditar && _tienePermisoEliminar;
    
    // Configuraci√≥n de farmacia (Precio Ministerio)
    private SistemIA.Models.ConfiguracionSistema? _configSistema;
    private bool MostrarPrecioMinisterioEnCompras => _configSistema?.FarmaciaModoActivo == true && _configSistema?.FarmaciaMostrarPrecioMinisterioEnCompras == true;
    private bool ValidarPrecioMinisterio => _configSistema?.FarmaciaModoActivo == true && _configSistema?.FarmaciaValidarPrecioMinisterio == true;

    private SistemIA.Models.Compra Compra = new() { Fecha = DateTime.Today, TipoDocumento = "FACTURA" };
    private List<SistemIA.Models.CompraDetalle> Detalles = new();
    private SistemIA.Models.CompraDetalle NuevoDetalle = new() { Cantidad = 1, PrecioUnitario = 0 };

    // Obtener la fecha de caja o fecha de hoy como fallback
    private DateTime FechaParaNuevaCompra => CajaActiva?.FechaActualCaja?.Date ?? DateTime.Today;

    private List<SistemIA.Models.Producto> Productos = new();
    // Item ligero para sugerencias de proveedores (usa tabla legada Proveedores)
    private class ProvSifenItem { public int IdProveedor { get; set; } public string RazonSocial { get; set; } = string.Empty; public string RUC { get; set; } = string.Empty; public int DV { get; set; } }
    private List<ProvSifenItem> Proveedores = new();
    private List<ProvSifenItem> ProveedoresFiltrados = new();
    private List<SistemIA.Models.Deposito> Depositos = new();
    // Lista de cajas disponibles para seleccionar
    private List<SistemIA.Models.Caja> Cajas = new();
    private List<SistemIA.Models.Moneda> Monedas = new();
    private List<SistemIA.Models.TipoPago> TiposPago = new();
    private List<SistemIA.Models.TipoDocumentoOperacion> TiposDocumento = new();
    private List<TipoIngresoItem> TiposIngreso = new();
    private List<SistemIA.Models.Producto> ProductosFiltrados = new();
    private static readonly string[] MediosPago = new[] { "EFECTIVO", "TARJETA", "CHEQUE", "TRANSFERENCIA", "QR" };

    // Datos de caja activa
    private SistemIA.Models.Caja? CajaActiva;
    private string CajaActivaInfo => CajaActiva == null ? "‚Äî" : $"Caja #{CajaActiva.IdCaja}";
    private int? TurnoActual => CajaActiva?.TurnoActual;
    private DateTime? FechaCajaActual => CajaActiva?.FechaActualCaja;

    private string? _buscarProveedor;
    private string BuscarProveedor { get => _buscarProveedor ?? string.Empty; set { _buscarProveedor = value; AplicarFiltroProveedores(); } }
    private string? _buscarProducto;
    private string BuscarProducto { get => _buscarProducto ?? string.Empty; set { _buscarProducto = value; AplicarFiltroProductos(); } }

    private bool MostrarSugProveedores;
    private bool MostrarSugProductos;
    private bool _mouseDownEnSugerenciaProducto;
    private bool _mouseDownEnSugerenciaProveedor;
    private DateTime? VencimientoTimbradoProveedorSel;
    private string? ProductoImagenUrl;

    // Variables para modal de nuevo proveedor r√°pido
    private bool _mostrarModalProveedor;
    private bool _guardandoProveedor;
    private string? _errorProveedor;
    private string? _successProveedor;
    private string _nuevoProvRazonSocial = string.Empty;
    private string _nuevoProvRuc = string.Empty;
    private int _nuevoProvDv;
    private string _nuevoProvTimbrado = string.Empty;
    private DateTime _nuevoProvVencTimbrado = DateTime.Today.AddYears(2);
    // SIFEN b√∫squeda de proveedor
    private bool _buscandoProveedorSifen;
    private string? _mensajeSifenProveedor;
    private bool _esSifenProveedorError;
    
    // UI: B√∫squeda autom√°tica de RUC (al Tab)
    private bool _buscandoRucAuto;
    private string? _mensajeRucAuto;
    private bool _esRucAutoError;
    private RucBusquedaResultado? _resultadoRucAuto;

    // Variables para modal de reciclar compra
    private bool _mostrarModalReciclar;
    private bool _procesandoReciclar;
    private string? _errorReciclar;
    private string _passwordReciclar = string.Empty;
    private int _idCompraOriginalReciclar; // ID de la compra que se est√° reciclando

    // Variables para modal de nuevo producto r√°pido
    private bool _mostrarModalProducto;
    private bool _guardandoProducto;
    private string? _errorProducto;
    private string? _successProducto;
    private SistemIA.Models.Producto _nuevoProducto = new();
    private List<SistemIA.Models.Marca> _marcasModal = new();
    private List<SistemIA.Models.Clasificacion> _clasificacionesModal = new();
    private List<SistemIA.Models.TiposIva> _tiposIvaModal = new();
    private IBrowserFile? _imagenProductoPendiente;
    private string? _previewImagenProducto;

    private decimal Gravado10; private decimal Gravado5; private decimal Exenta; private decimal IVATotal10; private decimal IVATotal5;
    private decimal CantidadInput { get => NuevoDetalle.Cantidad; set { NuevoDetalle.Cantidad = value; RecalcularNuevoDetalle(); } }
    private decimal PrecioInput { get => NuevoDetalle.PrecioUnitario; set { NuevoDetalle.PrecioUnitario = value; RecalcularNuevoDetalle(); } }

    // Variables para cr√©dito y cuotas
    private int NumeroCuotasCompra { get; set; } = 1;
    private bool MostrarCamposCredito { get; set; } = false;
    private bool TipoPagoEsCredito => Compra.IdTipoPago.HasValue && TiposPago.FirstOrDefault(t => t.IdTipoPago == Compra.IdTipoPago)?.EsCredito == true;

    // Variables para dep√≥sito y vencimiento del item
    private int? IdDepositoItemSeleccionado;
    private DateTime? FechaVencimientoItemSeleccionada;
    
    // Factor multiplicador para calcular precio de venta
    private decimal? FactorMultiplicador;
    private decimal? PorcentajeMargen;
    private decimal? PrecioVentaCalculado;
    private bool _actualizandoFactorPorcentaje = false;
    
    // Precio Ministerio para el producto actual (entrada)
    private decimal? PrecioMinisterioInput;
    
    // Control para prevenir el comportamiento por defecto de Tab en el bot√≥n Agregar
    private bool _prevenirTabEnAgregar = false;
    
    // Indica si alg√∫n detalle tiene producto con control de vencimiento
    private bool AlgunDetalleConVencimiento => Detalles.Any(d => 
        Productos.FirstOrDefault(p => p.IdProducto == d.IdProducto)?.ControlarVencimiento == true);
    
    // Diccionario para guardar el factor aplicado a cada producto (para actualizar al guardar)
    private Dictionary<int, decimal> _factoresPorProducto = new();
    
    // Diccionario para guardar el precio ministerio aplicado a cada producto (para actualizar al guardar)
    private Dictionary<int, decimal> _preciosMinisterioPorProducto = new();
    
    // Diccionario para guardar el precio de venta ingresado directamente (para actualizar al guardar)
    private Dictionary<int, decimal> _preciosVentaPorProducto = new();

    private string FormatoMonedaActual
    {
        get
        {
            var codigo = Monedas.FirstOrDefault(m => m.IdMoneda == Compra.IdMoneda)?.CodigoISO ?? "PYG";
            return codigo == "PYG" ? "N0" : "N2";
        }
    }

    private string SimboloMonedaActual
    {
        get
        {
            var mon = Monedas.FirstOrDefault(m => m.IdMoneda == Compra.IdMoneda);
            return mon?.Simbolo ?? "‚Ç≤";
        }
    }

    // Control de carga por par√°metro de consulta
    private bool _compraDesdeQueryCargada = false;
    private int? _idCompraParam = null;
    
    /// <summary>
    /// Modo solo vista: cuando se carga una compra existente, los controles se bloquean
    /// </summary>
    private bool ModoSoloVista = false;
    
    /// <summary>
    /// Permiso para cambiar caja (solo roles con permiso EDIT pueden cambiar la caja)
    /// </summary>
    private bool PuedeCambiarCaja = false;

    protected override async Task OnInitializedAsync()
    {
        // Forzar selecci√≥n de sucursal antes de cargar compras
        var sucId = SucursalProvider.GetSucursalId();
        if (!sucId.HasValue)
        {
            var ret = System.Net.WebUtility.UrlEncode(Nav.Uri);
            Nav.NavigateTo($"/seleccionar-sucursal?returnUrl={ret}", true);
            return;
        }
        // Capturar usuario autenticado para auditor√≠a
        try
        {
            var auth = await AuthStateTask;
            var u = auth.User;
            if (u?.Identity?.IsAuthenticated == true)
            {
                if (int.TryParse(u.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value, out var idu))
                    _usuarioId = idu;
                _usuarioNombre = u.FindFirst(System.Security.Claims.ClaimTypes.Name)?.Value ?? u.Identity?.Name;
            }
        }
        catch { }
        
        // Verificar permisos EDIT y DELETE para cambiar caja y reciclar
        if (_usuarioId.HasValue)
        {
            PuedeCambiarCaja = await PermisosService.TienePermisoAsync(_usuarioId.Value, "/compras", "EDIT");
            _tienePermisoEditar = PuedeCambiarCaja; // EDIT ya se verific√≥
            _tienePermisoEliminar = await PermisosService.TienePermisoAsync(_usuarioId.Value, "/compras", "DELETE");
            
            // Verificar si el usuario tiene rol de administrador (Id_Rol = 1 t√≠picamente)
            await using var ctxUser = await DbFactory.CreateDbContextAsync();
            var usuarioActual = await ctxUser.Usuarios
                .Include(u => u.Rol)
                .AsNoTracking()
                .FirstOrDefaultAsync(u => u.Id_Usu == _usuarioId.Value);
            _esUsuarioAdmin = usuarioActual?.Rol?.NombreRol?.ToLower() == "administrador" 
                           || usuarioActual?.Rol?.NombreRol?.ToLower() == "admin"
                           || usuarioActual?.Id_Rol == 1;
        }
        
        await using var ctx = await DbFactory.CreateDbContextAsync();
        
        // Cargar configuraci√≥n del sistema (farmacia)
        _configSistema = await ctx.ConfiguracionSistema.AsNoTracking().FirstOrDefaultAsync();

        // Opcional: asegurar monedas EUR/CLP/UYU/COP/MXN
    await EnsureMonedasAsync(ctx);
    await EnsureTiposPagoAsync(ctx);
    await EnsureTiposDocumentoOperacionAsync(ctx);
    await EnsureTiposIngresoAsync(ctx);
    await EnsureColumnaMedioPagoAsync(ctx);
    await EnsureColumnaTipoIngresoAsync(ctx);

    // Asegurar columna IdMonedaPrecio en Productos (por compatibilidad si a√∫n no se migr√≥)
    await EnsureColumnaMonedaProductoAsync(ctx);
    // Asegurar columna CambioDelDia en ComprasDetalles
    await EnsureColumnaCambioDetalleAsync(ctx);

    Productos = await ctx.Productos.Include(p => p.TipoIva).Include(p => p.DepositoPredeterminado).AsNoTracking().OrderBy(p => p.Descripcion).ToListAsync();
        // Cargar proveedores desde tabla legada Proveedores (evita conflicto de FK)
        Proveedores = await ctx.Database
            .SqlQuery<ProvSifenItem>(
                $"SELECT IdProveedor, RazonSocial, RUC, DV FROM ProveedoresSifen ORDER BY RazonSocial")
            .ToListAsync();
    // Cargar todos los dep√≥sitos activos, ordenados por ID
    Depositos = await ctx.Depositos.AsNoTracking()
        .OrderBy(d => d.IdDeposito)
        .ToListAsync();
    // Solo mostrar ARS, USD, BRL y PYG
    var codsMonedas = new[] { "ARS", "USD", "BRL", "PYG" };
    Monedas = await ctx.Monedas.AsNoTracking()
        .Where(m => codsMonedas.Contains(m.CodigoISO))
        .OrderBy(m => m.CodigoISO)
        .ToListAsync();
    // Excluir "Remisi√≥n Interna" de las opciones de tipo de pago
    TiposPago = await ctx.TiposPago.AsNoTracking()
        .Where(t => t.Activo && !t.Nombre.Contains("Interna"))
        .OrderBy(t => t.Orden).ThenBy(t => t.Nombre)
        .ToListAsync();
    TiposDocumento = await ctx.TiposDocumentoOperacion.AsNoTracking().Where(t => t.Activo).OrderBy(t => t.Orden).ThenBy(t => t.Nombre).ToListAsync();
    await CargarTiposIngresoAsync(ctx);

    // Usar sucursal seleccionada del usuario
    var suc = await ctx.Sucursal.AsNoTracking().FirstOrDefaultAsync(s => s.Id == sucId.Value) 
          ?? await ctx.Sucursal.AsNoTracking().OrderBy(s => s.Id).FirstOrDefaultAsync();
    if (suc != null) Compra.IdSucursal = suc.Id;

    // Predeterminar dep√≥sito: usamos el primero por simplicidad
        Compra.IdDeposito = Depositos.FirstOrDefault()?.IdDeposito;

    // Predeterminar moneda PYG si existe
    var pyg = Monedas.FirstOrDefault(m => m.CodigoISO == "PYG");
    if (pyg != null) Compra.IdMoneda = pyg.IdMoneda;

    // Predeterminar tipo de pago Contado si existe
    SeleccionarPagoContadoPorDefecto();
    // Predeterminar medio de pago EFECTIVO si no se ha definido
    if (string.IsNullOrWhiteSpace(Compra.MedioPago)) Compra.MedioPago = "EFECTIVO";

    // Predeterminar tipo de documento FACTURA si existe
    var factura = TiposDocumento.FirstOrDefault(t => t.Nombre == "FACTURA");
    if (factura != null) { Compra.IdTipoDocumentoOperacion = factura.IdTipoDocumentoOperacion; Compra.TipoDocumento = factura.Nombre; }

    // Inicializar listas filtradas
        ProductosFiltrados = new(Productos);
        ProveedoresFiltrados = new(Proveedores);
    MostrarSugProveedores = false;
    MostrarSugProductos = false;

    // Campos de fiscalizaci√≥n quedan libres en Compras

    // Cargar cajas de la sucursal actual (sucId ya est√° definida)
    Cajas = await ctx.Cajas.AsNoTracking()
        .Where(c => c.IdSucursal == sucId || c.IdSucursal == null)
        .OrderBy(c => c.IdCaja).ToListAsync();
    CajaActiva = Cajas.FirstOrDefault(c => c.CajaActual == 1) ?? Cajas.FirstOrDefault();
    
    // Asignar IdCaja a la compra
    if (CajaActiva != null)
    {
        Compra.IdCaja = CajaActiva.IdCaja;
    }
    
    // Siempre usar la fecha de caja como fecha predeterminada para nuevas compras
    if (CajaActiva?.FechaActualCaja.HasValue == true)
    {
        Compra.Fecha = CajaActiva.FechaActualCaja.Value.Date;
    }

        // Si la URL trae ?id=..., cargar la compra para edici√≥n
        try
        {
            var uri = Nav.ToAbsoluteUri(Nav.Uri);
            var q = QueryHelpers.ParseQuery(uri.Query);
            if (q.TryGetValue("id", out var idVal) && int.TryParse(idVal, out var idParam))
            {
                _idCompraParam = idParam;
                await CargarCompraPorIdAsync(idParam);
                _compraDesdeQueryCargada = true;
                ModoSoloVista = true; // Compras cargadas son solo lectura
            }
        }
        catch { }
    }

    private async Task CargarCompraPorIdAsync(int id)
    {
        try
        {
            await using var ctx = await DbFactory.CreateDbContextAsync();
            var compDb = await ctx.Compras.AsNoTracking().FirstOrDefaultAsync(c => c.IdCompra == id);
            if (compDb == null)
            {
                Error = $"No se encontr√≥ la compra #{id}";
                return;
            }

            var detsDb = await ctx.ComprasDetalles.AsNoTracking()
                .Where(d => d.IdCompra == id)
                .ToListAsync();

            // Reemplazar cabecera y detalle en UI
            // Asegurar moneda predeterminada si la compra no tiene moneda asignada
            var idMonedaCompra = compDb.IdMoneda ?? Monedas.FirstOrDefault(m => m.CodigoISO == "PYG")?.IdMoneda;
            Compra = new SistemIA.Models.Compra
            {
                IdCompra = compDb.IdCompra,
                Establecimiento = compDb.Establecimiento,
                PuntoExpedicion = compDb.PuntoExpedicion,
                NumeroFactura = compDb.NumeroFactura,
                Timbrado = compDb.Timbrado,
                IdSucursal = compDb.IdSucursal,
                IdProveedor = compDb.IdProveedor,
                IdMoneda = idMonedaCompra,
                IdDeposito = compDb.IdDeposito,
                IdTipoPago = compDb.IdTipoPago,
                IdTipoDocumentoOperacion = compDb.IdTipoDocumentoOperacion,
                Fecha = compDb.Fecha,
                FechaVencimiento = compDb.FechaVencimiento,
                Total = compDb.Total,
                FormaPago = compDb.FormaPago,
                Estado = compDb.Estado,
                TipoDocumento = compDb.TipoDocumento,
                TipoIngreso = compDb.TipoIngreso ?? "COMPRA",
                MedioPago = compDb.MedioPago,
                TotalEnLetras = compDb.TotalEnLetras,
                SimboloMoneda = compDb.SimboloMoneda,
                Turno = compDb.Turno,
                IdCaja = compDb.IdCaja
            };

            Detalles = detsDb.Select(d => new SistemIA.Models.CompraDetalle
            {
                IdCompraDetalle = d.IdCompraDetalle,
                IdProducto = d.IdProducto,
                Cantidad = d.Cantidad,
                PrecioUnitario = d.PrecioUnitario,
                Importe = d.Importe,
                IVA10 = d.IVA10,
                IVA5 = d.IVA5,
                Exenta = d.Exenta,
                Grabado10 = d.Grabado10,
                Grabado5 = d.Grabado5,
                CambioDelDia = d.CambioDelDia,
                IdDepositoItem = d.IdDepositoItem,
                FechaVencimientoItem = d.FechaVencimientoItem,
                FactorMultiplicador = d.FactorMultiplicador,
                PorcentajeMargen = d.PorcentajeMargen,
                PrecioVentaRef = d.PrecioVentaRef,
                // Asociar el producto para mostrar descripci√≥n en grilla
                Producto = Productos.FirstOrDefault(p => p.IdProducto == d.IdProducto)
            }).ToList();

            // Mostrar proveedor en el buscador
            var provInfo = Proveedores.FirstOrDefault(p => p.IdProveedor == Compra.IdProveedor);
            if (provInfo == null)
            {
                var provS = await ctx.ProveedoresSifen.AsNoTracking().FirstOrDefaultAsync(p => p.IdProveedor == Compra.IdProveedor);
                if (provS != null)
                {
                    provInfo = new ProvSifenItem { IdProveedor = provS.IdProveedor, RazonSocial = provS.RazonSocial, RUC = provS.RUC, DV = provS.DV };
                    Proveedores.Add(provInfo);
                }
            }
            if (provInfo != null)
            {
                BuscarProveedor = $"{provInfo.RazonSocial}";
                MostrarSugProveedores = false;
                // Cargar vencimiento del timbrado del proveedor para mostrarlo
                try
                {
                    var provSifen = await ctx.ProveedoresSifen.AsNoTracking().FirstOrDefaultAsync(p => p.IdProveedor == provInfo.IdProveedor);
                    VencimientoTimbradoProveedorSel = provSifen?.VencimientoTimbrado;
                }
                catch { }
            }

            // Verificar si es cr√©dito y cargar datos de CuentaPorPagar
            var tipoPagoSel = TiposPago.FirstOrDefault(t => t.IdTipoPago == Compra.IdTipoPago);
            MostrarCamposCredito = tipoPagoSel?.EsCredito == true;
            
            if (MostrarCamposCredito)
            {
                // Buscar la cuenta por pagar asociada para obtener n√∫mero de cuotas, plazo y fecha vencimiento
                var cuentaPorPagar = await ctx.CuentasPorPagar
                    .AsNoTracking()
                    .FirstOrDefaultAsync(c => c.IdCompra == id);
                
                if (cuentaPorPagar != null)
                {
                    NumeroCuotasCompra = cuentaPorPagar.NumeroCuotas > 0 ? cuentaPorPagar.NumeroCuotas : 1;
                    Compra.PlazoDias = cuentaPorPagar.PlazoDias > 0 ? cuentaPorPagar.PlazoDias : Compra.PlazoDias;
                    // Cargar la fecha de vencimiento guardada en la cuenta por pagar (puede ser diferente a la calculada)
                    if (cuentaPorPagar.FechaVencimiento != default)
                    {
                        Compra.FechaVencimiento = cuentaPorPagar.FechaVencimiento;
                    }
                }
                else
                {
                    // Si no hay cuenta pero es cr√©dito, usar valores por defecto
                    NumeroCuotasCompra = 1;
                    if (!Compra.PlazoDias.HasValue || Compra.PlazoDias <= 0)
                        Compra.PlazoDias = 30;
                }
            }
            else
            {
                NumeroCuotasCompra = 1;
                Compra.PlazoDias = null;
            }

            // Recalcular totales en UI
            RecalcularTotales();
            RecalcularNuevoDetalle();
            // Asegurar que el TipoIngreso cargado existe en el cat√°logo; si no, mapear a COMPRA
            if (!string.IsNullOrWhiteSpace(Compra.TipoIngreso))
            {
                var existe = TiposIngreso.Any(t => string.Equals(t.Codigo, Compra.TipoIngreso, StringComparison.OrdinalIgnoreCase));
                if (!existe)
                {
                    // Mapas comunes legacy ‚Üí actuales
                    var val = (Compra.TipoIngreso ?? "").Trim().ToUpperInvariant();
                    if (val is "COMPRAS" or "FACTURA" or "FACT") Compra.TipoIngreso = "COMPRA";
                    else if (val.Contains("ENTR")) Compra.TipoIngreso = "ENTRADA";
                    else if (val.Contains("TRANS")) Compra.TipoIngreso = "TRANSF";
                    else
                    {
                        // Si no se puede mapear, usar COMPRA
                        Compra.TipoIngreso = "COMPRA";
                    }
                }
            }
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Error = $"Error al cargar compra #{id}: {ex.Message}";
        }
    }

    private void OnCajaChanged()
    {
        // Actualizar la caja activa y la fecha cuando se cambia el selector
        CajaActiva = Cajas.FirstOrDefault(c => c.IdCaja == Compra.IdCaja);
        if (CajaActiva?.FechaActualCaja.HasValue == true)
        {
            Compra.Fecha = CajaActiva.FechaActualCaja.Value.Date;
        }
    }

    private void SeleccionarPagoContadoPorDefecto()
    {
        var contado = TiposPago.FirstOrDefault(t => string.Equals(t.Nombre, "Contado", StringComparison.OrdinalIgnoreCase)
                                                 || string.Equals(t.Nombre, "CONTADO", StringComparison.OrdinalIgnoreCase));
        if (contado != null)
        {
            Compra.IdTipoPago = contado.IdTipoPago;
            Compra.FormaPago = contado.Nombre;
        }
    }

    private static async Task EnsureColumnaMonedaProductoAsync(SistemIA.Models.AppDbContext ctx)
    {
        // Crea la columna si falta; no falla si ya existe
        var sql = @"
IF NOT EXISTS (
    SELECT 1 FROM sys.columns 
    WHERE Name = N'IdMonedaPrecio' AND Object_ID = Object_ID(N'Productos')
)
BEGIN
    ALTER TABLE [Productos] ADD [IdMonedaPrecio] INT NULL;
END
";
        try
        {
            await ctx.Database.ExecuteSqlRawAsync(sql);
        }
        catch
        {
            // Ignorar errores si el usuario no tiene permisos ALTER; la p√°gina de Productos tambi√©n lo intenta al cargar
        }
    }

    private static async Task EnsureColumnaCambioDetalleAsync(SistemIA.Models.AppDbContext ctx)
    {
        var sql = @"
IF NOT EXISTS (
    SELECT 1 FROM sys.columns 
    WHERE Name = N'CambioDelDia' AND Object_ID = Object_ID(N'ComprasDetalles')
)
BEGIN
    ALTER TABLE [ComprasDetalles] ADD [CambioDelDia] DECIMAL(18,4) NULL;
END
";
        try { await ctx.Database.ExecuteSqlRawAsync(sql); }
        catch { }
    }

    private static async Task EnsureColumnaMedioPagoAsync(SistemIA.Models.AppDbContext ctx)
    {
        var sql = @"
IF NOT EXISTS (
    SELECT 1 FROM sys.columns 
    WHERE Name = N'MedioPago' AND Object_ID = Object_ID(N'Compras')
)
BEGIN
    ALTER TABLE [Compras] ADD [MedioPago] NVARCHAR(13) NULL;
END
IF EXISTS (
    SELECT 1 FROM sys.columns 
    WHERE Name = N'MedioPago' AND Object_ID = Object_ID(N'Compras')
)
BEGIN
    UPDATE [Compras] SET [MedioPago] = 'EFECTIVO' WHERE [MedioPago] IS NULL OR LTRIM(RTRIM([MedioPago])) = '';
END
";
        try { await ctx.Database.ExecuteSqlRawAsync(sql); }
        catch { }
    }

    private static async Task EnsureColumnaTipoIngresoAsync(SistemIA.Models.AppDbContext ctx)
    {
        var sql = @"
IF NOT EXISTS (
    SELECT 1 FROM sys.columns 
    WHERE Name = N'TipoIngreso' AND Object_ID = Object_ID(N'Compras')
)
BEGIN
    ALTER TABLE [Compras] ADD [TipoIngreso] NVARCHAR(13) NOT NULL CONSTRAINT DF_Compras_TipoIngreso DEFAULT('COMPRA');
END
IF EXISTS (
    SELECT 1 FROM sys.columns 
    WHERE Name = N'TipoIngreso' AND Object_ID = Object_ID(N'Compras')
)
BEGIN
    -- Inicializar filas existentes y normalizar
    UPDATE [Compras] SET [TipoIngreso] = 'COMPRA' WHERE [TipoIngreso] IS NULL OR LTRIM(RTRIM([TipoIngreso])) = '';
    UPDATE [Compras]
    SET [TipoIngreso] = 'COMPRA'
    WHERE UPPER(LTRIM(RTRIM([TipoIngreso]))) IN ('COMPRAS','COMPRA CON FACTURA','FACTURA','FACT');
END
";
        try { await ctx.Database.ExecuteSqlRawAsync(sql); }
        catch { }
    }

    // Sin selector de Caja en Compras.

    private static async Task EnsureMonedasAsync(SistemIA.Models.AppDbContext ctx)
    {
        // Limitar cat√°logo base a ARS, USD, BRL y PYG
        var faltantes = new (string codigo, string nombre, string simbolo)[]
        {
            ("ARS", "Peso Argentino", "$"),
            ("USD", "D√≥lar Estadounidense", "US$"),
            ("BRL", "Real Brasile√±o", "R$"),
            ("PYG", "Guaran√≠ Paraguayo", "‚Ç≤")
        };

        var existentes = await ctx.Monedas.AsNoTracking().Select(m => m.CodigoISO).ToListAsync();
        var nuevos = faltantes.Where(f => !existentes.Contains(f.codigo))
            .Select(f => new SistemIA.Models.Moneda
            {
                CodigoISO = f.codigo,
                Nombre = f.nombre,
                Simbolo = f.simbolo,
                EsMonedaBase = false,
                Estado = true,
                Orden = 0,
                FechaCreacion = DateTime.Now,
                UsuarioCreacion = "Sistema"
            }).ToList();
        if (nuevos.Count > 0)
        {
            await ctx.Monedas.AddRangeAsync(nuevos);
            await ctx.SaveChangesAsync();
        }
    }

    private static async Task EnsureTiposPagoAsync(SistemIA.Models.AppDbContext ctx)
    {
        var faltantes = new (string nombre, bool esCredito, int orden)[]
        {
            ("Contado", false, 1),
            ("Cr√©dito", true, 2),
            ("Remisi√≥n", false, 3)
            // "Remisi√≥n Interna" eliminado seg√∫n requerimiento
        };

        foreach (var f in faltantes)
        {
            // Inserta solo si no existe (a prueba de concurrencia)
            await ctx.Database.ExecuteSqlRawAsync(
                "IF NOT EXISTS (SELECT 1 FROM [TiposPago] WHERE [Nombre] = {0}) " +
                "INSERT INTO [TiposPago] ([Nombre], [EsCredito], [Activo], [Orden]) VALUES ({0}, {1}, 1, {2});",
                f.nombre, f.esCredito, f.orden);
        }
    }

    private static async Task EnsureTiposDocumentoOperacionAsync(SistemIA.Models.AppDbContext ctx)
    {
        var faltantes = new (string nombre, int orden)[]
        {
            ("FACTURA", 1),
            ("NOTA DE CR√âDITO", 2),
            ("NOTA DE D√âBITO", 3),
            ("REMISI√ìN", 4)
        };

        foreach (var f in faltantes)
        {
            await ctx.Database.ExecuteSqlRawAsync(
                "IF NOT EXISTS (SELECT 1 FROM [TiposDocumentoOperacion] WHERE UPPER([Nombre]) = UPPER({0})) " +
                "INSERT INTO [TiposDocumentoOperacion] ([Nombre], [Activo], [Orden]) VALUES ({0}, 1, {1});",
                f.nombre, f.orden);
        }
    }

    private class TipoIngresoItem
    {
        public int IdTipoIngreso { get; set; }
        public string Codigo { get; set; } = string.Empty; // se guarda en Compra.TipoIngreso (m√°x 13)
        public string Nombre { get; set; } = string.Empty; // etiqueta visible (libre)
        public bool Activo { get; set; } = true;
        public int Orden { get; set; } = 0;
    }

    private static async Task EnsureTiposIngresoAsync(SistemIA.Models.AppDbContext ctx)
    {
        // Crear tabla TiposIngreso si no existe y sembrar b√°sicos
        var crear = @"
IF OBJECT_ID('TiposIngreso','U') IS NULL
BEGIN
    CREATE TABLE TiposIngreso(
        IdTipoIngreso INT IDENTITY(1,1) PRIMARY KEY,
        Codigo NVARCHAR(13) NOT NULL UNIQUE,
        Nombre NVARCHAR(120) NOT NULL,
        Activo BIT NOT NULL DEFAULT 1,
        Orden INT NOT NULL DEFAULT 0,
        FechaCreacion DATETIME2 NULL,
        UsuarioCreacion NVARCHAR(50) NULL,
        FechaModificacion DATETIME2 NULL,
        UsuarioModificacion NVARCHAR(50) NULL
    );
END
";
        await ctx.Database.ExecuteSqlRawAsync(crear);

        // Semillas: COMPRA, ENTRADA, TRANSF
        var seeds = new (string codigo, string nombre, int orden)[]
        {
            ("COMPRA", "Compra con Factura", 1),
            ("ENTRADA", "Entrada", 2),
            ("TRANSF", "Transferencia", 3)
        };
        foreach (var s in seeds)
        {
            await ctx.Database.ExecuteSqlRawAsync(
                "IF NOT EXISTS (SELECT 1 FROM TiposIngreso WHERE Codigo = {0}) " +
                "INSERT INTO TiposIngreso (Codigo, Nombre, Activo, Orden, FechaCreacion, UsuarioCreacion) VALUES ({0}, {1}, 1, {2}, SYSUTCDATETIME(), 'Sistema');",
                s.codigo, s.nombre, s.orden);
        }
    }

    private async Task CargarTiposIngresoAsync(SistemIA.Models.AppDbContext ctx)
    {
        // Cargar activos; si Compra.TipoIngreso es vac√≠o, preseleccionar COMPRA
        TiposIngreso = await ctx.Database
            .SqlQuery<TipoIngresoItem>(
                $"SELECT IdTipoIngreso, Codigo, Nombre, Activo, Orden FROM TiposIngreso WHERE Activo = 1 ORDER BY Orden, Nombre")
            .ToListAsync();
        if (string.IsNullOrWhiteSpace(Compra.TipoIngreso))
        {
            var def = TiposIngreso.FirstOrDefault(t => t.Codigo == "COMPRA") ?? TiposIngreso.FirstOrDefault();
            if (def != null) Compra.TipoIngreso = def.Codigo;
        }
    }

    private async Task AgregarTipoIngresoAsync()
    {
        // Solicitar datos m√≠nimos al usuario
        var nombre = await JS.InvokeAsync<string>("prompt", "Nuevo tipo de movimiento (nombre visible):");
        if (string.IsNullOrWhiteSpace(nombre)) return;
        var sugerido = new string(nombre.Trim().ToUpperInvariant().Where(char.IsLetterOrDigit).ToArray());
        if (sugerido.Length > 10) sugerido = sugerido.Substring(0, 10);
        var codigo = await JS.InvokeAsync<string>("prompt", $"C√≥digo interno (m√°x 13, sin espacios), sugerido: {sugerido}", sugerido);
        if (string.IsNullOrWhiteSpace(codigo)) return;
        codigo = new string(codigo.Trim().ToUpperInvariant().Where(char.IsLetterOrDigit).ToArray());
        if (codigo.Length > 13) codigo = codigo.Substring(0, 13);

        try
        {
            await using var ctx = await DbFactory.CreateDbContextAsync();
            await EnsureTiposIngresoAsync(ctx);
            await ctx.Database.ExecuteSqlRawAsync(
                "IF NOT EXISTS (SELECT 1 FROM TiposIngreso WHERE Codigo = {0}) " +
                "INSERT INTO TiposIngreso (Codigo, Nombre, Activo, Orden, FechaCreacion, UsuarioCreacion) VALUES ({0}, {1}, 1, 0, SYSUTCDATETIME(), 'Usuario');",
                codigo, nombre.Trim());
            await CargarTiposIngresoAsync(ctx);
            // Si coincide con el reci√©n agregado, seleccionarlo
            if (TiposIngreso.Any(t => t.Codigo == codigo)) Compra.TipoIngreso = codigo;
            StateHasChanged();
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("alert", $"No se pudo agregar el tipo: {ex.Message}");
        }
    }

    private async Task AgregarDetalleAsync()
    {
        Error = null; Ok = null;
        if (NuevoDetalle.IdProducto == 0 || NuevoDetalle.Cantidad <= 0) { Error = "Producto y cantidad requeridos"; return; }
        var prod = Productos.FirstOrDefault(p => p.IdProducto == NuevoDetalle.IdProducto);
        if (prod == null) { Error = "Producto no v√°lido"; return; }

        // Determinar dep√≥sito: usuario > predeterminado del producto (si est√° en la lista) > dep√≥sito 1 como predeterminado
        int? depositoItem = IdDepositoItemSeleccionado;
        if (!depositoItem.HasValue && prod.IdDepositoPredeterminado.HasValue)
        {
            // Solo usar el predeterminado del producto si est√° en la lista de dep√≥sitos permitidos
            if (Depositos.Any(d => d.IdDeposito == prod.IdDepositoPredeterminado.Value))
                depositoItem = prod.IdDepositoPredeterminado;
        }
        if (!depositoItem.HasValue)
            depositoItem = Depositos.FirstOrDefault(d => d.IdDeposito == 1)?.IdDeposito ?? Depositos.FirstOrDefault()?.IdDeposito;

        var det = new SistemIA.Models.CompraDetalle
        {
            IdProducto = prod.IdProducto,
            Cantidad = NuevoDetalle.Cantidad,
            PrecioUnitario = NuevoDetalle.PrecioUnitario,
            CambioDelDia = NuevoDetalle.CambioDelDia,
            IdDepositoItem = depositoItem,
            FechaVencimientoItem = prod.ControlarVencimiento ? FechaVencimientoItemSeleccionada : null
        };
        // Precio de venta de referencia convertido a moneda de la compra
    try
        {
            var precioVentaBase = prod.PrecioUnitarioGs;
            
            // Si el producto no tiene precio de venta pero tiene factor, calcularlo
            if (precioVentaBase == 0 && prod.FactorMultiplicador.HasValue && prod.FactorMultiplicador.Value > 0)
            {
                precioVentaBase = Math.Round(det.PrecioUnitario * prod.FactorMultiplicador.Value, 0);
            }
            
            var idMonCompra = Compra.IdMoneda;
            var idMonProd = prod.IdMonedaPrecio;
            decimal precioVentaConv = precioVentaBase;
            if (idMonCompra.HasValue && idMonProd.HasValue && idMonCompra.Value != idMonProd.Value)
            {
                // Convertimos desde la moneda del producto a la moneda de la compra
        precioVentaConv = await ConvertirMonedaAsync(precioVentaBase, idMonProd.Value, idMonCompra.Value);
            }
            det.PrecioVentaRef = precioVentaConv;
        }
        catch { det.PrecioVentaRef = prod.PrecioUnitarioGs > 0 ? prod.PrecioUnitarioGs : Math.Round(det.PrecioUnitario * (prod.FactorMultiplicador ?? 1.3m), 0); }
        // Total l√≠nea con IVA incluido
        det.Importe = Math.Round(det.Cantidad * det.PrecioUnitario, 4);

        // IVA incluido: base = total / 1.10 o / 1.05; iva = total - base
        var porc = prod.TipoIva?.Porcentaje ?? 0m;
        if (porc == 10)
        {
            var base10 = Math.Round(det.Importe / 1.10m, 4);
            det.Grabado10 = base10;
            det.IVA10 = Math.Round(det.Importe - base10, 4);
        }
        else if (porc == 5)
        {
            var base5 = Math.Round(det.Importe / 1.05m, 4);
            det.Grabado5 = base5;
            det.IVA5 = Math.Round(det.Importe - base5, 4);
        }
        else
        {
            det.Exenta = det.Importe;
        }

        Detalles.Add(det);
        RecalcularTotales();
    
    // Guardar el factor y porcentaje en el detalle para este producto si se especific√≥
    if (FactorMultiplicador.HasValue && FactorMultiplicador.Value > 0)
    {
        det.FactorMultiplicador = FactorMultiplicador.Value;
        det.PorcentajeMargen = PorcentajeMargen;
        _factoresPorProducto[prod.IdProducto] = FactorMultiplicador.Value;
        
        // Actualizar el precio de venta de referencia con el nuevo factor
        det.PrecioVentaRef = Math.Round(det.PrecioUnitario * FactorMultiplicador.Value, 0);
    }
    
    // Guardar precio de venta ingresado directamente (para actualizar al guardar)
    if (PrecioVentaCalculado.HasValue && PrecioVentaCalculado.Value > 0)
    {
        _preciosVentaPorProducto[prod.IdProducto] = PrecioVentaCalculado.Value;
        det.PrecioVentaRef = PrecioVentaCalculado.Value;
    }
    
    // Guardar precio ministerio en el detalle y en el diccionario para actualizar al guardar
    if (MostrarPrecioMinisterioEnCompras && PrecioMinisterioInput.HasValue && PrecioMinisterioInput.Value > 0)
    {
        det.PrecioMinisterio = PrecioMinisterioInput.Value;
        _preciosMinisterioPorProducto[prod.IdProducto] = PrecioMinisterioInput.Value;
    }
    else if (prod.PrecioMinisterio.HasValue)
    {
        // Si no se ingres√≥, usar el del producto
        det.PrecioMinisterio = prod.PrecioMinisterio;
    }
    
    // Validar si el precio de venta supera el precio ministerio (solo si est√° activa la validaci√≥n)
    var precioMinValidar = det.PrecioMinisterio ?? prod.PrecioMinisterio;
    if (ValidarPrecioMinisterio && precioMinValidar.HasValue && det.PrecioVentaRef > 0)
    {
        if (det.PrecioVentaRef > precioMinValidar.Value)
        {
            Error = $"‚ö†Ô∏è Advertencia: El precio de venta ({det.PrecioVentaRef:N0} Gs) supera el Precio Ministerio ({precioMinValidar.Value:N0} Gs) para '{prod.Descripcion}'";
        }
    }
    
    // Resetear el editor de l√≠nea
    NuevoDetalle = new SistemIA.Models.CompraDetalle { Cantidad = 1, PrecioUnitario = 0 };
    IdDepositoItemSeleccionado = null;
    FechaVencimientoItemSeleccionada = null;
    FactorMultiplicador = null;
    PorcentajeMargen = null;
    PrecioVentaCalculado = null;
    PrecioMinisterioInput = null;
    RecalcularNuevoDetalle();
    // Limpiar el buscador y cerrar sugerencias al agregar
    BuscarProducto = string.Empty;
    MostrarSugProductos = false;
    
    // Hacer foco en el input de b√∫squeda de producto para agregar otro
    await JS.InvokeVoidAsync("eval", "document.getElementById('inputBuscarProductoCompras')?.focus()");
    }

    private void QuitarDetalle(SistemIA.Models.CompraDetalle det)
    {
        Detalles.Remove(det);
        RecalcularTotales();
    }

    private void RecalcularTotales()
    {
        Gravado10 = Detalles.Sum(d => d.Grabado10);
        Gravado5 = Detalles.Sum(d => d.Grabado5);
        Exenta = Detalles.Sum(d => d.Exenta);
    IVATotal10 = Detalles.Sum(d => d.IVA10);
    IVATotal5 = Detalles.Sum(d => d.IVA5);
        Compra.Total = Detalles.Sum(d => d.Importe);
        StateHasChanged();
    }

    private void ValidarCantidadCompra()
    {
        // Si el producto no permite decimales, redondear a entero
        if (!NuevoDetalle.PermiteDecimal)
        {
            NuevoDetalle.Cantidad = Math.Max(1, Math.Round(NuevoDetalle.Cantidad, 0));
        }
        else
        {
            NuevoDetalle.Cantidad = Math.Max(0.01m, NuevoDetalle.Cantidad);
        }
        RecalcularNuevoDetalle();
    }

    private void RecalcularNuevoDetalle()
    {
        var cant = NuevoDetalle.Cantidad <= 0 ? 0 : NuevoDetalle.Cantidad;
        var precio = NuevoDetalle.PrecioUnitario;
        var totalLinea = Math.Round(cant * precio, 4);

        NuevoDetalle.IVA10 = 0; NuevoDetalle.IVA5 = 0; NuevoDetalle.Exenta = 0; NuevoDetalle.Grabado10 = 0; NuevoDetalle.Grabado5 = 0; NuevoDetalle.Importe = 0;
        var prod = Productos.FirstOrDefault(p => p.IdProducto == NuevoDetalle.IdProducto);
        var porc = prod?.TipoIva?.Porcentaje ?? 0m;
        if (porc == 10)
        {
            var base10 = Math.Round(totalLinea / 1.10m, 4);
            NuevoDetalle.Grabado10 = base10;
            NuevoDetalle.IVA10 = Math.Round(totalLinea - base10, 4);
        }
        else if (porc == 5)
        {
            var base5 = Math.Round(totalLinea / 1.05m, 4);
            NuevoDetalle.Grabado5 = base5;
            NuevoDetalle.IVA5 = Math.Round(totalLinea - base5, 4);
        }
        else
        {
            NuevoDetalle.Exenta = totalLinea;
        }
        NuevoDetalle.Importe = totalLinea;
        // Recalcular precio de venta si hay factor
        RecalcularPrecioVentaPorFactor();
        StateHasChanged();
    }

    private void RecalcularPrecioVentaPorFactor()
    {
        if (FactorMultiplicador.HasValue && FactorMultiplicador.Value > 0 && NuevoDetalle.PrecioUnitario > 0)
        {
            PrecioVentaCalculado = Math.Round(NuevoDetalle.PrecioUnitario * FactorMultiplicador.Value, 0);
        }
        else
        {
            PrecioVentaCalculado = null;
        }
    }

    private void OnFactorInputChanged(ChangeEventArgs e)
    {
        var valor = e.Value?.ToString();
        if (decimal.TryParse(valor, System.Globalization.NumberStyles.Any, System.Globalization.CultureInfo.InvariantCulture, out var factor))
        {
            FactorMultiplicador = factor;
        }
        else
        {
            FactorMultiplicador = null;
        }
        OnFactorChanged();
    }

    private void OnPorcentajeInputChanged(ChangeEventArgs e)
    {
        var valor = e.Value?.ToString();
        if (decimal.TryParse(valor, System.Globalization.NumberStyles.Any, System.Globalization.CultureInfo.InvariantCulture, out var porcentaje))
        {
            PorcentajeMargen = porcentaje;
        }
        else
        {
            PorcentajeMargen = null;
        }
        OnPorcentajeChanged();
    }

    private void OnFactorChanged()
    {
        if (_actualizandoFactorPorcentaje) return;
        _actualizandoFactorPorcentaje = true;
        
        if (FactorMultiplicador.HasValue && FactorMultiplicador.Value > 0)
        {
            // Calcular porcentaje equivalente: (factor - 1) * 100
            PorcentajeMargen = Math.Round((FactorMultiplicador.Value - 1) * 100, 2);
        }
        else
        {
            PorcentajeMargen = null;
        }
        RecalcularPrecioVentaPorFactor();
        _actualizandoFactorPorcentaje = false;
    }

    private void OnPorcentajeChanged()
    {
        if (_actualizandoFactorPorcentaje) return;
        _actualizandoFactorPorcentaje = true;
        
        if (PorcentajeMargen.HasValue)
        {
            // Calcular factor equivalente: 1 + porcentaje/100
            FactorMultiplicador = Math.Round(1 + PorcentajeMargen.Value / 100, 4);
        }
        else
        {
            FactorMultiplicador = null;
        }
        RecalcularPrecioVentaPorFactor();
        _actualizandoFactorPorcentaje = false;
    }

    private void OnPrecioVentaInputChanged(ChangeEventArgs e)
    {
        var valor = e.Value?.ToString();
        if (decimal.TryParse(valor, System.Globalization.NumberStyles.Any, System.Globalization.CultureInfo.InvariantCulture, out var precioVenta) && precioVenta > 0)
        {
            PrecioVentaCalculado = precioVenta;
            
            // Calcular Factor y Markup basados en el precio de venta
            if (NuevoDetalle.PrecioUnitario > 0)
            {
                _actualizandoFactorPorcentaje = true;
                
                // Factor = PrecioVenta / Costo
                FactorMultiplicador = Math.Round(precioVenta / NuevoDetalle.PrecioUnitario, 4);
                
                // Markup = (Factor - 1) * 100
                PorcentajeMargen = Math.Round((FactorMultiplicador.Value - 1) * 100, 2);
                
                _actualizandoFactorPorcentaje = false;
            }
        }
        else
        {
            PrecioVentaCalculado = null;
            FactorMultiplicador = null;
            PorcentajeMargen = null;
        }
        StateHasChanged();
    }

    /// <summary>
    /// Maneja el Tab en el bot√≥n Agregar: agrega el detalle y vuelve al campo de producto.
    /// </summary>
    private async Task OnBtnAgregarKeyDown(KeyboardEventArgs e)
    {
        if (e.Key != "Tab") 
        {
            _prevenirTabEnAgregar = false;
            return;
        }
        
        _prevenirTabEnAgregar = true;
        
        // Agregar el detalle
        await AgregarDetalleAsync();
        
        // El foco ya se mueve autom√°ticamente en AgregarDetalleAsync al input de b√∫squeda
    }

    private async Task OnMonedaChangedAsync(ChangeEventArgs e)
    {
        // Cargar tipo de cambio autom√°ticamente del d√≠a al cambiar moneda
        if (Compra.IdMoneda.HasValue)
        {
            var mon = Monedas.FirstOrDefault(m => m.IdMoneda == Compra.IdMoneda.Value);
            if (mon != null && !mon.EsMonedaBase)
            {
                // Cargar TC del d√≠a (precio COMPRA para compras al proveedor)
                try
                {
                    await using var ctx = await DbFactory.CreateDbContextAsync();
                    var monedaBase = Monedas.FirstOrDefault(m => m.EsMonedaBase);
                    if (monedaBase != null)
                    {
                        var tc = await ctx.TiposCambio
                            .Where(t => t.IdMonedaOrigen == mon.IdMoneda
                                     && t.IdMonedaDestino == monedaBase.IdMoneda
                                     && t.Estado
                                     && t.FechaTipoCambio.Date == DateTime.Today)
                            .OrderByDescending(t => t.FechaCreacion)
                            .FirstOrDefaultAsync();
                        
                        Compra.CambioDelDia = (tc?.TasaCompra ?? tc?.TasaCambio) ?? 1m;
                    }
                }
                catch { Compra.CambioDelDia = 1m; }
            }
            else
            {
                Compra.CambioDelDia = 1m;
            }
        }
        
        // Si hay un producto seleccionado y cambia la moneda, reconvertir el precio unitario mostrado
        var prod = Productos.FirstOrDefault(p => p.IdProducto == NuevoDetalle.IdProducto);
        if (prod != null)
        {
            // CostoUnitarioGs y PrecioUnitarioGs SIEMPRE est√°n en Guaran√≠es
            var precioBaseEnGs = prod.CostoUnitarioGs ?? prod.PrecioUnitarioGs;
            var idMonedaCompra = Compra.IdMoneda;
            decimal precio = precioBaseEnGs;
            
            // Solo convertir si la compra est√° en moneda extranjera
            if (idMonedaCompra.HasValue)
            {
                var monCompra = Monedas.FirstOrDefault(m => m.IdMoneda == idMonedaCompra.Value);
                if (monCompra?.EsMonedaBase == false)
                {
                    var cambio = Compra.CambioDelDia ?? 1m;
                    precio = Math.Round(precioBaseEnGs / cambio, 4);
                    NuevoDetalle.CambioDelDia = cambio;
                }
            }
            
            NuevoDetalle.PrecioUnitario = precio;
            
            // Tambi√©n reconvertir el precio de venta de referencia
            try
            {
                var precioVentaEnGs = prod.PrecioUnitarioGs;
                decimal precioVentaConv = precioVentaEnGs;
                
                if (idMonedaCompra.HasValue)
                {
                    var monCompra = Monedas.FirstOrDefault(m => m.IdMoneda == idMonedaCompra.Value);
                    if (monCompra?.EsMonedaBase == false)
                    {
                        var cambio = Compra.CambioDelDia ?? 1m;
                        precioVentaConv = Math.Round(precioVentaEnGs / cambio, 4);
                    }
                }
                
                NuevoDetalle.PrecioVentaRef = precioVentaConv;
            }
            catch { NuevoDetalle.PrecioVentaRef = prod.PrecioUnitarioGs; }
            RecalcularNuevoDetalle();
        }
        
        // Reconvertir los ya agregados
        foreach (var d in Detalles)
        {
            var p = Productos.FirstOrDefault(x => x.IdProducto == d.IdProducto);
            if (p == null) continue;
            try
            {
                // PrecioUnitarioGs SIEMPRE est√° en Guaran√≠es
                var precioVentaEnGs = p.PrecioUnitarioGs;
                decimal precioVentaConv = precioVentaEnGs;
                
                if (Compra.IdMoneda.HasValue)
                {
                    var monCompra = Monedas.FirstOrDefault(m => m.IdMoneda == Compra.IdMoneda.Value);
                    if (monCompra?.EsMonedaBase == false)
                    {
                        var cambio = Compra.CambioDelDia ?? 1m;
                        precioVentaConv = Math.Round(precioVentaEnGs / cambio, 4);
                    }
                }
                
                d.PrecioVentaRef = precioVentaConv;
            }
            catch { d.PrecioVentaRef = p.PrecioUnitarioGs; }
        }
        StateHasChanged();
    }
    
    private async Task OnCambioManualChangedAsync()
    {
        // Recalcular precio del producto actual al cambiar TC manual
        if (NuevoDetalle.IdProducto > 0)
        {
            var prod = Productos.FirstOrDefault(p => p.IdProducto == NuevoDetalle.IdProducto);
            if (prod != null)
            {
                // CostoUnitarioGs SIEMPRE est√° en Guaran√≠es
                var precioBaseEnGs = prod.CostoUnitarioGs ?? prod.PrecioUnitarioGs;
                var idMonedaCompra = Compra.IdMoneda;
                decimal precio = precioBaseEnGs;
                
                // Solo convertir si la compra est√° en moneda extranjera
                if (idMonedaCompra.HasValue)
                {
                    var monCompra = Monedas.FirstOrDefault(m => m.IdMoneda == idMonedaCompra.Value);
                    if (monCompra?.EsMonedaBase == false)
                    {
                        var cambioCompra = Compra.CambioDelDia ?? 1m;
                        precio = Math.Round(precioBaseEnGs / cambioCompra, 4);
                        NuevoDetalle.CambioDelDia = cambioCompra;
                    }
                }
                
                NuevoDetalle.PrecioUnitario = precio;
                RecalcularNuevoDetalle();
            }
        }
        StateHasChanged();
    }

    private async Task GuardarAsync()
    {
        Error = null; Ok = null;
        // Si el usuario escribi√≥ texto pero no hizo clic en la sugerencia, intentar resolver autom√°ticamente
        if (Compra.IdProveedor == 0)
        {
            var texto = (BuscarProveedor ?? string.Empty).Trim().ToLowerInvariant();
            if (!string.IsNullOrWhiteSpace(texto))
            {
                var digitos = new string(texto.Where(char.IsDigit).ToArray());
                var candidatos = Proveedores
                    .Where(p => p.RazonSocial.ToLowerInvariant().Contains(texto)
                             || (!string.IsNullOrEmpty(digitos) && p.RUC.Contains(digitos)))
                    .ToList();
                if (candidatos.Count == 1)
                {
                    Compra.IdProveedor = candidatos[0].IdProveedor;
                }
            }
        }
        if (Compra.IdProveedor == 0) { Error = "Seleccione un proveedor"; return; }
        if (!Detalles.Any()) { Error = "Agregue al menos un √≠tem"; return; }

        // Validar que los datos de factura est√©n completos
        var nivel1 = (Compra.Establecimiento ?? string.Empty).Trim();
        var nivel2 = (Compra.PuntoExpedicion ?? string.Empty).Trim();
        var nroFact = (Compra.NumeroFactura ?? string.Empty).Trim();
        var timbrado = (Compra.Timbrado ?? string.Empty).Trim();
        
        if (string.IsNullOrEmpty(nivel1) || string.IsNullOrEmpty(nivel2) || 
            string.IsNullOrEmpty(nroFact) || string.IsNullOrEmpty(timbrado))
        {
            Error = "Complete los datos de factura: Nivel 1, Nivel 2, Nro. Factura y Timbrado son obligatorios";
            return;
        }

        // Validar que no exista otra compra con la misma combinaci√≥n de factura
        await using var ctxValidacion = await DbFactory.CreateDbContextAsync();
        var existeDuplicado = await ctxValidacion.Compras.AsNoTracking()
            .AnyAsync(c => c.Establecimiento == nivel1 
                        && c.PuntoExpedicion == nivel2 
                        && c.NumeroFactura == nroFact 
                        && c.Timbrado == timbrado
                        && c.IdCompra != Compra.IdCompra); // Excluir la compra actual si es edici√≥n
        
        if (existeDuplicado)
        {
            Error = $"Ya existe una compra registrada con la factura {nivel1}-{nivel2}-{nroFact} y timbrado {timbrado}. No se permiten duplicados.";
            return;
        }

    // Sin validaci√≥n de Caja en Compras

        await using var ctx = await DbFactory.CreateDbContextAsync();
        using var trx = await ctx.Database.BeginTransactionAsync();
        try
        {
            Compra.FechaCreacion = DateTime.Now;
            // Asignar usuario autenticado a la operaci√≥n
            if (_usuarioId.HasValue) Compra.IdUsuario = _usuarioId.Value;
            Compra.UsuarioCreacion = _usuarioNombre ?? Compra.UsuarioCreacion ?? "Sistema";

            // Asegurar estado y datos operativos para evitar NULLs
            // Estado: confirmar autom√°ticamente al guardar
            Compra.Estado = "Confirmado";

            // Forma de pago y condici√≥n derivadas del cat√°logo seleccionado
            if (Compra.IdTipoPago.HasValue && string.IsNullOrWhiteSpace(Compra.FormaPago))
            {
                var sel = TiposPago.FirstOrDefault(t => t.IdTipoPago == Compra.IdTipoPago);
                if (sel != null) Compra.FormaPago = sel.Nombre;
            }
            // Determinar condici√≥n en base al tipo de pago seleccionado
            var tipoPagoSel = Compra.IdTipoPago.HasValue ? TiposPago.FirstOrDefault(t => t.IdTipoPago == Compra.IdTipoPago) : null;
            if (string.IsNullOrWhiteSpace(Compra.CodigoCondicion))
            {
                if (tipoPagoSel != null)
                {
                    Compra.CodigoCondicion = tipoPagoSel.EsCredito ? "CREDITO" : "CONTADO";
                }
                else
                {
                    var fp = (Compra.FormaPago ?? string.Empty).Trim().ToUpperInvariant();
                    Compra.CodigoCondicion = fp.Contains("CRED") ? "CREDITO" : "CONTADO";
                }
            }
            // Plazos y vencimiento seg√∫n condici√≥n
            if (Compra.CodigoCondicion == "CONTADO")
            {
                Compra.PlazoDias = 0;
                Compra.FechaVencimiento = Compra.Fecha.Date;
            }
            else if (Compra.CodigoCondicion == "CREDITO")
            {
                var dias = Compra.PlazoDias ?? 30; // suponer 30 si no se carg√≥
                Compra.PlazoDias = dias;
                // Solo calcular FechaVencimiento si el usuario no la ingres√≥ manualmente
                if (!Compra.FechaVencimiento.HasValue)
                {
                    Compra.FechaVencimiento = Compra.Fecha.Date.AddDays(dias);
                }
            }

            // C√≥digo de documento: mapear al Id del cat√°logo si est√° presente
            if (!Compra.CodigoDocumento.HasValue && Compra.IdTipoDocumentoOperacion.HasValue)
            {
                Compra.CodigoDocumento = Compra.IdTipoDocumentoOperacion.Value;
            }
            // Tipo de registro y TipoIngreso siempre COMPRA (las entradas se manejan en otra ventana)
            Compra.TipoRegistro = "COMPRA";
            Compra.TipoIngreso = "COMPRA";
            // Imputaciones por defecto
            if (!Compra.ImputarIVA.HasValue)
            {
                // Imputar IVA si hay alg√∫n IVA en los detalles
                Compra.ImputarIVA = Detalles.Any(d => d.IVA10 > 0 || d.IVA5 > 0);
            }
            Compra.ImputarIRP ??= false;
            Compra.ImputarIRE ??= false;
            Compra.NoImputar ??= false;

            // Validar que el proveedor exista en tabla Proveedores (legada)
            var existeProveedor = await ctx.ProveedoresSifen.AsNoTracking().AnyAsync(pp => pp.IdProveedor == Compra.IdProveedor);
            if (!existeProveedor)
            {
                Error = "El proveedor seleccionado no existe en ProveedoresSifen. Revise la selecci√≥n.";
                return;
            }
            // Capturar datos de caja
            if (CajaActiva != null)
            {
                Compra.IdCaja = CajaActiva.IdCaja;
                Compra.Turno = CajaActiva.TurnoActual;
                if (CajaActiva.FechaActualCaja.HasValue && (CajaActiva.bloquear_fechaCaja ?? false))
                {
                    Compra.Fecha = CajaActiva.FechaActualCaja.Value.Date;
                }
            }
            // Sincronizar Timbrado/VencimientoTimbrado con el proveedor seleccionado
            var provSel = await ctx.ProveedoresSifen.FirstOrDefaultAsync(pp => pp.IdProveedor == Compra.IdProveedor);
            if (provSel != null)
            {
                if (string.IsNullOrWhiteSpace(Compra.Timbrado))
                {
                    // Si no se carg√≥ en la compra, tomar del proveedor
                    Compra.Timbrado = provSel.Timbrado;
                }
                else if (!string.Equals(Compra.Timbrado, provSel.Timbrado))
                {
                    // Si difiere, actualizar proveedor
                    provSel.Timbrado = Compra.Timbrado;
                    provSel.FechaModificacion = DateTime.Now;
                    provSel.UsuarioModificacion = _usuarioNombre ?? provSel.UsuarioModificacion ?? "Sistema";
                }
                // Actualizar vencimiento del timbrado del proveedor si fue provisto en la UI
                if (VencimientoTimbradoProveedorSel.HasValue && provSel.VencimientoTimbrado != VencimientoTimbradoProveedorSel.Value.Date)
                {
                    provSel.VencimientoTimbrado = VencimientoTimbradoProveedorSel.Value.Date;
                    provSel.FechaModificacion = DateTime.Now;
                    provSel.UsuarioModificacion = _usuarioNombre ?? provSel.UsuarioModificacion ?? "Sistema";
                }
            }

            // Datos de moneda para la compra
            var monedaSel = Monedas.FirstOrDefault(m => m.IdMoneda == Compra.IdMoneda);
            Compra.SimboloMoneda = monedaSel?.Simbolo ?? "‚Ç≤";
            Compra.EsMonedaExtranjera = (monedaSel?.CodigoISO ?? "PYG") != "PYG";
            Compra.TotalEnLetras = NumeroEnLetras(Compra.Total, monedaSel?.CodigoISO ?? "PYG");
            
            // Evitar adjuntar entidades navegadas (EF tracking conflict)
            Compra.Proveedor = null;
            Compra.Sucursal = null;
            Compra.Deposito = null;
            Compra.Moneda = null;
            Compra.TipoPago = null;
            Compra.TipoDocumentoOperacion = null;
            
            // Asegurar que IdCompra sea 0 para que EF genere uno nuevo
            Compra.IdCompra = 0;
            ctx.Compras.Add(Compra);
            await ctx.SaveChangesAsync();

            foreach (var d in Detalles)
            {
                d.IdCompraDetalle = 0; // Asegurar que EF genere un nuevo ID
                d.IdCompra = Compra.IdCompra;
                d.Producto = null; // Evitar tracking conflict
                d.UsuarioCreacion = _usuarioNombre ?? d.UsuarioCreacion ?? "Sistema";
                ctx.ComprasDetalles.Add(d);
            }
            await ctx.SaveChangesAsync();

            // Ingreso a inventario por dep√≥sito (usar dep√≥sito espec√≠fico del item si est√° definido)
            // Obtener datos de caja actual para trazabilidad
            var cajaActual = await CajaService.ObtenerCajaActualAsync();
            var fechaCajaActual = cajaActual?.FechaActualCaja ?? DateTime.Today;
            var turnoActual = cajaActual?.TurnoActual ?? 1;
            var idCajaActual = cajaActual?.IdCaja;
            
            foreach (var d in Detalles)
            {
                var depositoAUsar = d.IdDepositoItem ?? Compra.IdDeposito!.Value;
                await Inventario.AjustarStockAsync(d.IdProducto, depositoAUsar, d.Cantidad, 1, $"Compra #{Compra.IdCompra}", _usuarioNombre ?? "Sistema",
                    Compra.IdSucursal, idCajaActual, fechaCajaActual, turnoActual);
            }

            // Actualizar costo del producto, factor, precio de venta y fecha de vencimiento si aplica
            foreach (var d in Detalles)
            {
                var prod = await ctx.Productos.FirstOrDefaultAsync(x => x.IdProducto == d.IdProducto);
                if (prod == null) continue;
                
                // Actualizar fecha de vencimiento del producto si se especific√≥ en el item
                if (d.FechaVencimientoItem.HasValue)
                {
                    prod.ControlarVencimiento = true;
                    prod.FechaVencimiento = d.FechaVencimientoItem.Value;
                }
                
                var idMonProd = prod.IdMonedaPrecio ?? Compra.IdMoneda!.Value;
                var idMonCompra = Compra.IdMoneda!.Value;
                var costoOrigen = d.PrecioUnitario; // en moneda de la compra
                decimal costoParaProducto = costoOrigen;
                if (idMonCompra != idMonProd)
                {
                    try { costoParaProducto = await ConvertirMonedaAsync(costoOrigen, idMonCompra, idMonProd); }
                    catch { costoParaProducto = costoOrigen; }
                }
                prod.CostoUnitarioGs = Math.Round(costoParaProducto, 4);
                
                // Si se ingres√≥ precio de venta directamente, usarlo y calcular factor
                if (_preciosVentaPorProducto.TryGetValue(d.IdProducto, out var precioVentaGuardado) && precioVentaGuardado > 0)
                {
                    prod.PrecioUnitarioGs = Math.Round(precioVentaGuardado, 0);
                    // Calcular y guardar el factor basado en el precio de venta
                    if (costoParaProducto > 0)
                    {
                        prod.FactorMultiplicador = Math.Round(precioVentaGuardado / costoParaProducto, 4);
                    }
                }
                // Si se especific√≥ factor multiplicador, actualizar Factor y PrecioUnitarioGs
                else if (_factoresPorProducto.TryGetValue(d.IdProducto, out var factorGuardado) && factorGuardado > 0)
                {
                    prod.FactorMultiplicador = factorGuardado;
                    prod.PrecioUnitarioGs = Math.Round(costoParaProducto * factorGuardado, 0);
                }
                
                // Actualizar Precio Ministerio si se especific√≥ en el detalle
                if (_preciosMinisterioPorProducto.TryGetValue(d.IdProducto, out var precioMinGuardado) && precioMinGuardado > 0)
                {
                    prod.PrecioMinisterio = precioMinGuardado;
                }
                
                prod.FechaModificacion = DateTime.Now;
                prod.UsuarioModificacion = _usuarioNombre ?? "Sistema";
            }
            await ctx.SaveChangesAsync();

            // *** CREAR CUENTA POR PAGAR Y CUOTAS SI ES CR√âDITO ***
            if (Compra.CodigoCondicion == "CREDITO" && TipoPagoEsCredito)
            {
                var numeroCuotasCredito = NumeroCuotasCompra > 0 ? NumeroCuotasCompra : 1;
                var plazoDias = Compra.PlazoDias ?? 30;
                
                var cuentaPorPagar = new SistemIA.Models.CuentaPorPagar
                {
                    IdCompra = Compra.IdCompra,
                    IdProveedor = Compra.IdProveedor,
                    IdSucursal = Compra.IdSucursal,
                    IdMoneda = Compra.IdMoneda,
                    FechaCredito = Compra.Fecha,
                    FechaVencimiento = Compra.FechaVencimiento ?? Compra.Fecha.AddDays(plazoDias),
                    MontoTotal = Compra.Total,
                    SaldoPendiente = Compra.Total,
                    NumeroCuotas = numeroCuotasCredito,
                    PlazoDias = plazoDias,
                    Estado = "Abierta"
                };
                ctx.CuentasPorPagar.Add(cuentaPorPagar);
                await ctx.SaveChangesAsync();

                // Generar cuotas autom√°ticamente
                // La primera cuota vence en la FechaVencimiento ingresada por el usuario
                // Las siguientes cuotas se calculan sumando plazoDias desde la primera
                var montoPorCuota = Math.Round(cuentaPorPagar.MontoTotal / numeroCuotasCredito, 2);
                var acumulado = 0m;
                var fechaPrimerVencimiento = cuentaPorPagar.FechaVencimiento ?? cuentaPorPagar.FechaCredito.AddDays(plazoDias);
                for (int i = 1; i <= numeroCuotasCredito; i++)
                {
                    var monto = (i == numeroCuotasCredito) ? (cuentaPorPagar.MontoTotal - acumulado) : montoPorCuota;
                    // Primera cuota: fecha de vencimiento ingresada, las siguientes cada "plazoDias" d√≠as desde la primera
                    var fechaVencimientoCuota = fechaPrimerVencimiento.AddDays((i - 1) * plazoDias);
                    var cuota = new SistemIA.Models.CuentaPorPagarCuota
                    {
                        IdCuentaPorPagar = cuentaPorPagar.IdCuentaPorPagar,
                        NumeroCuota = i,
                        MontoCuota = monto,
                        SaldoCuota = monto, // Inicialmente el saldo es igual al monto
                        FechaVencimiento = fechaVencimientoCuota,
                        Estado = "Pendiente"
                    };
                    ctx.CuentasPorPagarCuotas.Add(cuota);
                    acumulado += monto;
                }
                await ctx.SaveChangesAsync();
            }

            // Sin incremento autom√°tico de numeraci√≥n de Caja en Compras

            await trx.CommitAsync();

            // Registrar en auditor√≠a con contexto completo
            var sucAudit = await ctx.Sucursal.AsNoTracking().FirstOrDefaultAsync(s => s.Id == Compra.IdSucursal);
            var rolUsuario = await ctx.Usuarios.AsNoTracking()
                .Where(u => u.Id_Usu == _usuarioId)
                .Select(u => u.Rol != null ? u.Rol.NombreRol : null)
                .FirstOrDefaultAsync();
            
            _ = AuditoriaService.RegistrarAccionAsync(
                idUsuario: _usuarioId,
                nombreUsuario: _usuarioNombre ?? "Sistema",
                rolUsuario: rolUsuario,
                accion: "Crear Compra",
                tipoAccion: "CREATE",
                modulo: "Compras",
                entidad: "Compra",
                idRegistroAfectado: Compra.IdCompra,
                descripcion: $"Compra #{Compra.IdCompra} - Fact #{Compra.Establecimiento}-{Compra.PuntoExpedicion}-{Compra.NumeroFactura} - {Compra.SimboloMoneda} {Compra.Total:N0} - Proveedor: {BuscarProveedor} - Items: {Detalles.Count}",
                datosDespues: new { 
                    Compra.IdCompra,
                    Factura = $"{Compra.Establecimiento}-{Compra.PuntoExpedicion}-{Compra.NumeroFactura}",
                    Compra.Total, 
                    Proveedor = BuscarProveedor, 
                    Items = Detalles.Count,
                    Compra.FormaPago
                },
                fechaHoraEquipo: DateTime.Now,
                fechaCaja: CajaActiva?.FechaActualCaja,
                turno: CajaActiva?.TurnoActual,
                idSucursal: Compra.IdSucursal,
                nombreSucursal: sucAudit?.NombreSucursal,
                idCaja: CajaActiva?.IdCaja,
                nombreCaja: CajaActiva?.Nombre
            );

            // Imprimir en formato Factura General con los datos cargados
            var compraCopia = new SistemIA.Models.Compra
            {
                IdCompra = Compra.IdCompra,
                Establecimiento = Compra.Establecimiento,
                PuntoExpedicion = Compra.PuntoExpedicion,
                NumeroFactura = Compra.NumeroFactura,
                Timbrado = Compra.Timbrado,
                IdSucursal = Compra.IdSucursal,
                IdProveedor = Compra.IdProveedor,
                IdMoneda = Compra.IdMoneda,
                IdDeposito = Compra.IdDeposito,
                Fecha = Compra.Fecha,
                Total = Compra.Total,
                FormaPago = Compra.FormaPago,
                MedioPago = Compra.MedioPago,
                Estado = Compra.Estado,
                TipoDocumento = Compra.TipoDocumento,
                TipoIngreso = Compra.TipoIngreso,
                TotalEnLetras = Compra.TotalEnLetras,
                SimboloMoneda = Compra.SimboloMoneda,
                Turno = Compra.Turno,
                IdCaja = Compra.IdCaja
            };
            var detallesCopia = Detalles.Select(d => new SistemIA.Models.CompraDetalle
            {
                IdProducto = d.IdProducto,
                PrecioUnitario = d.PrecioUnitario,
                Cantidad = d.Cantidad,
                Importe = d.Importe,
                IVA10 = d.IVA10,
                IVA5 = d.IVA5,
                Exenta = d.Exenta,
                Grabado10 = d.Grabado10,
                Grabado5 = d.Grabado5,
                PrecioVentaRef = d.PrecioVentaRef,
                PrecioMinisterio = d.PrecioMinisterio
            }).ToList();

            Ok = $"Compra #{Compra.IdCompra} guardada";

            // Disparar impresi√≥n de factura (no bloquear la UI)
            _ = ImprimirFacturaAsync(compraCopia, detallesCopia);

            // Limpiar UI para siguiente carga
            Detalles.Clear();
            RecalcularTotales();

            // Preparar nueva compra manteniendo la misma caja y numeraci√≥n estirada
            var idDepPrev = Compra.IdDeposito;
            var idSucPrev = Compra.IdSucursal;
            var idCajaPrev = Compra.IdCaja;
            var idMonPyg = Monedas.FirstOrDefault(m => m.CodigoISO == "PYG")?.IdMoneda;
            Compra = new SistemIA.Models.Compra { Fecha = FechaParaNuevaCompra, TipoDocumento = "FACTURA", TipoIngreso = "COMPRA", MedioPago = "EFECTIVO", IdSucursal = idSucPrev, IdDeposito = idDepPrev, IdCaja = idCajaPrev, IdMoneda = idMonPyg };
            VencimientoTimbradoProveedorSel = null;
            SeleccionarPagoContadoPorDefecto();
            
            // Resetear campos de cr√©dito
            MostrarCamposCredito = false;
            NumeroCuotasCompra = 1;
            
            // Limpiar factores y precios guardados
            _factoresPorProducto.Clear();
            _preciosVentaPorProducto.Clear();
            _preciosMinisterioPorProducto.Clear();
            
            // Predeterminar tipo de documento FACTURA
            var factura = TiposDocumento.FirstOrDefault(t => t.Nombre == "FACTURA");
            if (factura != null) 
            { 
                Compra.IdTipoDocumentoOperacion = factura.IdTipoDocumentoOperacion; 
                Compra.TipoDocumento = factura.Nombre; 
            }
            
            // Limpiar datos del producto para evitar imagen residual
            BuscarProducto = string.Empty;
            MostrarSugProductos = false;
            ProductoImagenUrl = null;
            NuevoDetalle = new SistemIA.Models.CompraDetalle { Cantidad = 1, PrecioUnitario = 0 };
            
            // Importante: limpiar el buscador de proveedor y cerrar sugerencias para evitar texto desincronizado
            BuscarProveedor = string.Empty;
            MostrarSugProveedores = false;
            ProveedoresFiltrados = new(Proveedores);
            StateHasChanged();
        }
        catch (Exception ex)
        {
            await trx.RollbackAsync();
            Error = (ex.InnerException?.Message ?? ex.Message);
            
            // Registrar error para tracking IA
            _ = TrackingService.RegistrarErrorAsync(
                descripcion: $"Error al guardar compra: {Error}",
                mensajeError: ex.Message,
                stackTrace: ex.StackTrace,
                componente: "Compras");
        }
    }

    // Genera e imprime una factura general elegante en A4
    private async Task ImprimirFacturaAsync(SistemIA.Models.Compra comp, List<SistemIA.Models.CompraDetalle> dets)
    {
        try
        {
            await using var ctx = await DbFactory.CreateDbContextAsync();

            // Datos de Sucursal/Empresa
            var suc = await ctx.Sucursal.AsNoTracking().FirstOrDefaultAsync(s => s.Id == comp.IdSucursal);
            string empresa = suc?.NombreEmpresa ?? "Empresa";
            string sucursal = suc?.NombreSucursal ?? "Sucursal";
            string ruc = suc != null ? $"{suc.RUC}-{suc.DV}" : "";
            string direccion = suc?.Direccion ?? "";
            string telefono = suc?.Telefono ?? "";
            string correo = suc?.Correo ?? "";
            string timbrado = comp.Timbrado ?? suc?.Timbrado ?? "";
            string nroFactura = (!string.IsNullOrWhiteSpace(comp.NumeroFactura) &&
                                 !string.IsNullOrWhiteSpace(comp.Establecimiento) &&
                                 !string.IsNullOrWhiteSpace(comp.PuntoExpedicion))
                                ? $"{comp.Establecimiento}-{comp.PuntoExpedicion}-{comp.NumeroFactura}"
                                : (comp.NumeroFactura ?? "");

            // Logo a Base64 si existe
            string? logoDataUri = null;
            if (suc?.Logo != null && suc.Logo.Length > 0)
            {
                var b64 = Convert.ToBase64String(suc.Logo);
                // Asumimos PNG; si se requiere, detectar por cabecera de bytes
                logoDataUri = $"data:image/png;base64,{b64}";
            }

            // Proveedor (usamos la tabla SIFEN mejorada si es posible)
            // Buscar proveedor principalmente en tabla Proveedores (legada) por Id
            var provSifen = await ctx.ProveedoresSifen.AsNoTracking().FirstOrDefaultAsync(p => p.IdProveedor == comp.IdProveedor);
            DateTime? vencTimProv = provSifen?.VencimientoTimbrado;
            string provNombre = provSifen?.RazonSocial ?? Proveedores.FirstOrDefault(p => p.IdProveedor == comp.IdProveedor)?.RazonSocial ?? "Proveedor";
            string provRuc = provSifen != null ? $"{provSifen.RUC}-{provSifen.DV}" : (Proveedores.FirstOrDefault(p => p.IdProveedor == comp.IdProveedor) is var pi && pi != null ? $"{pi.RUC}-{pi.DV}" : "");

            // Moneda
            var mon = Monedas.FirstOrDefault(m => m.IdMoneda == comp.IdMoneda);
            string codMon = mon?.CodigoISO ?? "PYG";
            string simb = mon?.Simbolo ?? comp.SimboloMoneda ?? "‚Ç≤";
            string formato = codMon == "PYG" ? "N0" : "N2";

            // Totales IVA
            decimal grab10 = dets.Sum(x => x.Grabado10);
            decimal grab5 = dets.Sum(x => x.Grabado5);
            decimal exen = dets.Sum(x => x.Exenta);
            decimal iva10 = dets.Sum(x => x.IVA10);
            decimal iva5 = dets.Sum(x => x.IVA5);

            // HEAD con estilos de impresi√≥n
            var head = new StringBuilder();
            head.AppendLine("<meta charset=\"utf-8\"/>");
            head.AppendLine("<title>Factura de Compra</title>");
            head.AppendLine("<link rel=\"stylesheet\" href=\"/css/bootstrap/bootstrap.min.css\" />");
            head.AppendLine("<style>");
            head.AppendLine("@media print { @page { size: A4; margin: 14mm 12mm; } }");
            head.AppendLine("body{font-size:12px;color:#111;}");
            head.AppendLine(".factura-header{display:flex;align-items:center;gap:16px;border-bottom:2px solid #222;padding-bottom:8px;margin-bottom:12px;}");
            head.AppendLine(".factura-header .logo{max-width:120px;max-height:60px;object-fit:contain;display:block;border-radius:6px;border:1px solid #e5e7eb;background:#fff;padding:6px;}");
            head.AppendLine(".factura-header .logo-wrap{width:140px;display:flex;align-items:center;justify-content:center;}");
            head.AppendLine(".factura-header .empresa h2{margin:0;font-size:18px;}");
            head.AppendLine(".factura-header .empresa .small{color:#555;}");
            head.AppendLine(".factura-meta{display:flex;justify-content:space-between;gap:12px;margin-bottom:10px;}");
            head.AppendLine(".table-factura th,.table-factura td{padding:.4rem;border-bottom:1px solid #e5e7eb;vertical-align:top;}");
            head.AppendLine(".totales .line{display:flex;justify-content:space-between;}");
            head.AppendLine(".totales .total{font-size:16px;font-weight:700;}");
            head.AppendLine(".enletras{background:#f8fafc;border:1px solid #e5e7eb;border-radius:6px;padding:8px 10px;margin-top:8px;}");
            head.AppendLine(".footer{position:fixed;bottom:8mm;left:0;right:0;text-align:center;font-size:10px;color:#666;}");
            head.AppendLine("</style>");

            // BODY
            var sb = new StringBuilder();
            sb.AppendLine("<div class=\"container-fluid\">");
            sb.AppendLine("  <div class=\"factura-header\">");
            sb.AppendLine("    <div class=\"logo-wrap\">");
            if (!string.IsNullOrEmpty(logoDataUri))
                sb.AppendLine($"      <img class=\"logo\" src=\"{logoDataUri}\" alt=\"Logo\"/>");
            else
                sb.AppendLine("      <div class=\"logo d-flex align-items-center justify-content-center\" style=\"font-size:10px;color:#999;min-height:40px;min-width:100px;\">LOGO</div>");
            sb.AppendLine("    </div>");
            sb.AppendLine("    <div class=\"empresa\">");
            sb.AppendLine($"      <h2>{empresa}</h2>");
            sb.AppendLine($"      <div class=\"small\">RUC: {ruc}</div>");
            sb.AppendLine($"      <div class=\"small\">{sucursal} ¬∑ {direccion}</div>");
            if (!string.IsNullOrWhiteSpace(telefono) || !string.IsNullOrWhiteSpace(correo))
                sb.AppendLine($"      <div class=\"small\">{telefono} {(string.IsNullOrWhiteSpace(telefono)||string.IsNullOrWhiteSpace(correo) ? "" : "¬∑")} {correo}</div>");
            sb.AppendLine("    </div>");
            sb.AppendLine("    <div class=\"ms-auto text-end\">");
            sb.AppendLine("      <div class=\"fw-bold\" style=\"font-size:18px\">Factura de Compra</div>");
            sb.AppendLine($"      <div class=\"text-muted small\">N¬∫ Interno: {comp.IdCompra}</div>");
            if (!string.IsNullOrEmpty(nroFactura)) sb.AppendLine($"      <div>N¬∞: {nroFactura}</div>");
            if (!string.IsNullOrEmpty(timbrado))
            {
                var venceTxt = vencTimProv.HasValue ? $" (vence: {vencTimProv:dd/MM/yyyy})" : string.Empty;
                sb.AppendLine($"      <div>Timbrado: {timbrado}{venceTxt}</div>");
            }
            sb.AppendLine($"      <div>Fecha: {comp.Fecha:dd/MM/yyyy}</div>");
            if (comp.IdCaja.HasValue) sb.AppendLine($"      <div>Caja: {comp.IdCaja} ¬∑ Turno: {(comp.Turno?.ToString() ?? "-")}</div>");
            sb.AppendLine("    </div>");
            sb.AppendLine("  </div>");

            sb.AppendLine("  <div class=\"factura-meta\">");
            sb.AppendLine("    <div>");
            sb.AppendLine("      <div class=\"text-muted\">Proveedor</div>");
            sb.AppendLine($"      <div class=\"fw-semibold\">{provNombre}</div>");
            if (!string.IsNullOrWhiteSpace(provRuc)) sb.AppendLine($"      <div class=\"small\">RUC: {provRuc}</div>");
            sb.AppendLine("    </div>");
            sb.AppendLine("    <div class=\"text-end\">");
            sb.AppendLine($"      <div class=\"text-muted\">Moneda</div><div class=\"fw-semibold\">{codMon} ({simb})</div>");
            sb.AppendLine($"      <div class=\"text-muted\">Forma de pago</div><div>{(comp.FormaPago ?? "-")}</div>");
            if (!string.IsNullOrWhiteSpace(comp.MedioPago)) sb.AppendLine($"      <div class=\"text-muted\">Medio</div><div>{comp.MedioPago}</div>");
            sb.AppendLine("    </div>");
            sb.AppendLine("  </div>");

            // Encabezados de tabla (incluir P.Ministerio si modo farmacia activo)
            var mostrarPMinImpresion = _configSistema?.FarmaciaModoActivo == true && _configSistema?.FarmaciaMostrarPrecioMinisterioEnCompras == true;
            sb.AppendLine("  <table class=\"table table-sm table-factura\">");
            if (mostrarPMinImpresion)
            {
                sb.AppendLine("    <thead><tr><th>Descripci√≥n</th><th class=\"text-end\">Cant.</th><th class=\"text-end\">Precio</th><th class=\"text-end\">P.Venta</th><th class=\"text-end\">P.Ministerio</th><th class=\"text-end\">Exenta</th><th class=\"text-end\">Grab. 5%</th><th class=\"text-end\">Grab. 10%</th><th class=\"text-end\">Subtotal</th></tr></thead>");
            }
            else
            {
                sb.AppendLine("    <thead><tr><th>Descripci√≥n</th><th class=\"text-end\">Cant.</th><th class=\"text-end\">Precio</th><th class=\"text-end\">Exenta</th><th class=\"text-end\">Grab. 5%</th><th class=\"text-end\">Grab. 10%</th><th class=\"text-end\">Subtotal</th></tr></thead>");
            }
            sb.AppendLine("    <tbody>");
            foreach (var d in dets)
            {
                var prod = Productos.FirstOrDefault(p => p.IdProducto == d.IdProducto);
                var desc = prod?.Descripcion ?? $"Producto #{d.IdProducto}";
                if (mostrarPMinImpresion)
                {
                    var pMinStr = d.PrecioMinisterio.HasValue ? d.PrecioMinisterio.Value.ToString(formato) : (prod?.PrecioMinisterio.HasValue == true ? prod.PrecioMinisterio.Value.ToString(formato) : "-");
                    sb.AppendLine($"      <tr><td>{System.Net.WebUtility.HtmlEncode(desc)}</td><td class=\"text-end\">{d.Cantidad:N2}</td><td class=\"text-end\">{d.PrecioUnitario.ToString(formato)}</td><td class=\"text-end\">{d.PrecioVentaRef.ToString(formato)}</td><td class=\"text-end\">{pMinStr}</td><td class=\"text-end\">{d.Exenta.ToString(formato)}</td><td class=\"text-end\">{d.Grabado5.ToString(formato)}</td><td class=\"text-end\">{d.Grabado10.ToString(formato)}</td><td class=\"text-end\">{d.Importe.ToString(formato)}</td></tr>");
                }
                else
                {
                    sb.AppendLine($"      <tr><td>{System.Net.WebUtility.HtmlEncode(desc)}</td><td class=\"text-end\">{d.Cantidad:N2}</td><td class=\"text-end\">{d.PrecioUnitario.ToString(formato)}</td><td class=\"text-end\">{d.Exenta.ToString(formato)}</td><td class=\"text-end\">{d.Grabado5.ToString(formato)}</td><td class=\"text-end\">{d.Grabado10.ToString(formato)}</td><td class=\"text-end\">{d.Importe.ToString(formato)}</td></tr>");
                }
            }
            sb.AppendLine("    </tbody>");
            sb.AppendLine("  </table>");

            sb.AppendLine("  <div class=\"row\">");
            sb.AppendLine("    <div class=\"col-7\">");
            var totLetras = comp.TotalEnLetras ?? NumeroEnLetras(comp.Total, codMon);
            sb.AppendLine($"      <div class=\"enletras\"><span class=\"text-muted\">Total en letras:</span> <span class=\"fw-semibold\">{System.Net.WebUtility.HtmlEncode(totLetras)}</span></div>");
            sb.AppendLine("    </div>");
            sb.AppendLine("    <div class=\"col-5\">");
            sb.AppendLine("      <div class=\"card\"><div class=\"card-body p-3 totales\">");
            sb.AppendLine($"        <div class=\"line\"><span>Exentas</span><strong>{exen.ToString(formato)}</strong></div>");
            sb.AppendLine($"        <div class=\"line\"><span>Gravadas 5%</span><strong>{grab5.ToString(formato)}</strong></div>");
            sb.AppendLine($"        <div class=\"line\"><span>Gravadas 10%</span><strong>{grab10.ToString(formato)}</strong></div>");
            sb.AppendLine($"        <hr class=\"my-2\"/>");
            sb.AppendLine($"        <div class=\"line\"><span>IVA 5%</span><strong>{iva5.ToString(formato)}</strong></div>");
            sb.AppendLine($"        <div class=\"line\"><span>IVA 10%</span><strong>{iva10.ToString(formato)}</strong></div>");
            sb.AppendLine($"        <div class=\"line total\"><span>Total {simb}</span><span>{comp.Total.ToString(formato)}</span></div>");
            sb.AppendLine("      </div></div>");
            sb.AppendLine("    </div>");
            sb.AppendLine("  </div>");

            sb.AppendLine("  <div class=\"footer\">** Gracias por su compra **</div>");
            sb.AppendLine("</div>");

            await JS.InvokeVoidAsync("printHtmlWithHead", head.ToString(), sb.ToString());
        }
        catch (Exception ex)
        {
            Console.Error.WriteLine($"Error al generar impresi√≥n de factura: {ex.Message}");
        }
    }

    // Reimpresi√≥n desde otro componente por Id
    private async Task ReimprimirPorIdAsync(int idCompra)
    {
        try
        {
            await using var ctx = await DbFactory.CreateDbContextAsync();
            var comp = await ctx.Compras.AsNoTracking().FirstOrDefaultAsync(c => c.IdCompra == idCompra);
            if (comp == null) return;
            var dets = await ctx.ComprasDetalles.AsNoTracking().Where(d => d.IdCompra == idCompra).ToListAsync();
            await ImprimirFacturaAsync(comp, dets);
        }
        catch (Exception ex)
        {
            Console.Error.WriteLine($"Error reimprimiendo compra #{idCompra}: {ex.Message}");
        }
    }

    private async Task ReimprimirUltimaAsync()
    {
        try
        {
            await using var ctx = await DbFactory.CreateDbContextAsync();
            var ultima = await ctx.Compras.AsNoTracking()
                .OrderByDescending(c => c.FechaCreacion)
                .FirstOrDefaultAsync();
            if (ultima == null) { return; }
            var dets = await ctx.ComprasDetalles.AsNoTracking()
                .Where(d => d.IdCompra == ultima.IdCompra)
                .ToListAsync();
            await ImprimirFacturaAsync(ultima, dets);
        }
        catch (Exception ex)
        {
            Console.Error.WriteLine($"Error reimprimiendo √∫ltima compra: {ex.Message}");
        }
    }

    // Helpers: FX y total en letras
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            // Prevenir submit al presionar Enter en cualquier campo (evitar errores accidentales)
            await JS.InvokeVoidAsync("eval", @"
                if (!window._comprasEnterHandler) {
                    window._comprasEnterHandler = function(e) {
                        if (e.key === 'Enter' && e.target.tagName !== 'TEXTAREA' && !e.target.classList.contains('allow-enter')) {
                            var form = e.target.closest('form');
                            if (form) {
                                e.preventDefault();
                            }
                        }
                    };
                    document.addEventListener('keydown', window._comprasEnterHandler, true);
                }
            ");
            
            // Registrar atajo de teclado F2 para guardar la compra
            await JS.InvokeVoidAsync("eval", @"
                if (!window._comprasF2Handler) {
                    window._comprasF2Handler = function(e) {
                        if (e.key === 'F2') {
                            e.preventDefault();
                            var btnGuardar = document.querySelector('button.btn-success[type=""submit""]');
                            if (btnGuardar) btnGuardar.click();
                        }
                    };
                    document.addEventListener('keydown', window._comprasF2Handler);
                }
            ");
            
            // Si venimos desde el explorador con ?id=..&print=1, dispara reimpresi√≥n
            var uri = Nav.ToAbsoluteUri(Nav.Uri);
            var query = QueryHelpers.ParseQuery(uri.Query);
            if (query.TryGetValue("id", out var idVal) && query.TryGetValue("print", out var printVal))
            {
                if (int.TryParse(idVal, out var idCompra) && printVal == "1")
                {
                    await ReimprimirPorIdAsync(idCompra);
                }
            }
        }
    }

    private async Task<decimal> ConvertirMonedaAsync(decimal monto, int idMonedaOrigen, int idMonedaDestino)
    {
        if (idMonedaOrigen == idMonedaDestino) return monto;
        await using var ctx = await DbFactory.CreateDbContextAsync();
        var hoy = DateTime.Today;
        // Obtener c√≥digos de moneda para aplicar preferencia de tasa
        var monOri = await ctx.Monedas.AsNoTracking().FirstOrDefaultAsync(m => m.IdMoneda == idMonedaOrigen);
        var monDes = await ctx.Monedas.AsNoTracking().FirstOrDefaultAsync(m => m.IdMoneda == idMonedaDestino);

        var tc = await ctx.TiposCambio.AsNoTracking()
            .Where(t => t.IdMonedaOrigen == idMonedaOrigen && t.IdMonedaDestino == idMonedaDestino)
            .OrderByDescending(t => t.FechaTipoCambio)
            .FirstOrDefaultAsync();
        if (tc != null && tc.FechaTipoCambio.Date == hoy)
        {
            // Preferir la tasa de "venta" cuando el destino es PYG (en BD se guarda en TasaCompra)
            var tasa = (monDes?.CodigoISO == "PYG") ? (tc.TasaCompra ?? tc.TasaCambio) : tc.TasaCambio;
            if (tasa != 0)
                return Math.Round(monto * tasa, 4);
        }
        var tcInv = await ctx.TiposCambio.AsNoTracking()
            .Where(t => t.IdMonedaOrigen == idMonedaDestino && t.IdMonedaDestino == idMonedaOrigen)
            .OrderByDescending(t => t.FechaTipoCambio)
            .FirstOrDefaultAsync();
        if (tcInv != null && tcInv.FechaTipoCambio.Date == hoy)
        {
            var tasaInv = (monOri?.CodigoISO == "PYG") ? (tcInv.TasaCompra ?? tcInv.TasaCambio) : tcInv.TasaCambio;
            if (tasaInv != 0)
                return Math.Round(monto / tasaInv, 4);
        }
        // Fallback con √∫ltimo registro disponible
        if (tc != null)
        {
            var tasa = (monDes?.CodigoISO == "PYG") ? (tc.TasaCompra ?? tc.TasaCambio) : tc.TasaCambio;
            if (tasa != 0)
                return Math.Round(monto * tasa, 4);
        }
        if (tcInv != null)
        {
            var tasaInv = (monOri?.CodigoISO == "PYG") ? (tcInv.TasaCompra ?? tcInv.TasaCambio) : tcInv.TasaCambio;
            if (tasaInv != 0)
                return Math.Round(monto / tasaInv, 4);
        }
        return monto;
    }

    private string NumeroEnLetras(decimal total, string codigoMoneda)
    {
        var entero = Math.Floor(total);
        var centavos = (int)Math.Round((total - entero) * 100, 0);
        var palabras = ToSpanishWords((long)entero);
        var nombreMoneda = codigoMoneda switch
        {
            "USD" => "d√≥lares",
            "ARS" => "pesos argentinos",
            "BRL" => "reales",
            _ => "guaran√≠es"
        };
        return centavos > 0
            ? $"{palabras} {nombreMoneda} con {centavos:00}/100"
            : $"{palabras} {nombreMoneda}";
    }

    private static string ToSpanishWords(long number)
    {
        if (number == 0) return "cero";
        if (number < 0) return "menos " + ToSpanishWords(-number);
        string[] unidades = { "", "uno", "dos", "tres", "cuatro", "cinco", "seis", "siete", "ocho", "nueve", "diez", "once", "doce", "trece", "catorce", "quince", "diecis√©is", "diecisiete", "dieciocho", "diecinueve" };
        string[] decenas = { "", "diez", "veinte", "treinta", "cuarenta", "cincuenta", "sesenta", "setenta", "ochenta", "noventa" };
        string[] centenas = { "", "cien", "doscientos", "trescientos", "cuatrocientos", "quinientos", "seiscientos", "setecientos", "ochocientos", "novecientos" };
        string ConvertGroup(long n)
        {
            if (n == 0) return "";
            if (n < 20) return unidades[n];
            if (n < 100)
            {
                var d = n / 10; var u = n % 10;
                if (n < 30) return n == 20 ? "veinte" : "veinti" + unidades[u];
                return u == 0 ? decenas[d] : decenas[d] + " y " + unidades[u];
            }
            var c = n / 100; var r = n % 100;
            if (n == 100) return "cien";
            return centenas[c] + (r == 0 ? "" : " " + ConvertGroup(r));
        }
        string ConvertThousands(long n)
        {
            if (n < 1000) return ConvertGroup(n);
            var miles = n / 1000; var resto = n % 1000;
            var pref = miles == 1 ? "mil" : ConvertGroup(miles) + " mil";
            var suf = resto == 0 ? "" : " " + ConvertGroup(resto);
            return pref + suf;
        }
        string ConvertMillions(long n)
        {
            if (n < 1_000_000) return ConvertThousands(n);
            var mill = n / 1_000_000; var resto = n % 1_000_000;
            var pref = mill == 1 ? "un mill√≥n" : ConvertThousands(mill) + " millones";
            var suf = resto == 0 ? "" : " " + ConvertThousands(resto);
            return pref + suf;
        }
        string ConvertBillions(long n)
        {
            if (n < 1_000_000_000) return ConvertMillions(n);
            var bill = n / 1_000_000_000; var resto = n % 1_000_000_000;
            var pref = bill == 1 ? "mil millones" : ConvertMillions(bill) + " mil millones";
            var suf = resto == 0 ? "" : " " + ConvertMillions(resto);
            return pref + suf;
        }
        return ConvertBillions(number);
    }

    private void Limpiar()
    {
        var idDepPrev = Compra.IdDeposito;
        var idSucPrev = Compra.IdSucursal;
        var idCajaPrev = Compra.IdCaja;
        var idMonPyg = Monedas.FirstOrDefault(m => m.CodigoISO == "PYG")?.IdMoneda;
        
        // Crear nueva instancia de Compra (evita conflictos con IdCompra ya asignado)
        Compra = new SistemIA.Models.Compra 
        { 
            Fecha = FechaParaNuevaCompra, 
            TipoDocumento = "FACTURA", 
            TipoIngreso = "COMPRA", 
            MedioPago = "EFECTIVO", 
            IdSucursal = idSucPrev, 
            IdDeposito = idDepPrev, 
            IdCaja = idCajaPrev,
            IdMoneda = idMonPyg 
        };
        
        Detalles.Clear();
        RecalcularTotales();
        SeleccionarPagoContadoPorDefecto();
        
        // Limpiar datos del proveedor
        BuscarProveedor = string.Empty;
        MostrarSugProveedores = false;
        VencimientoTimbradoProveedorSel = null;
        
        // Limpiar datos del producto
        BuscarProducto = string.Empty;
        MostrarSugProductos = false;
        ProductoImagenUrl = null;
        NuevoDetalle = new SistemIA.Models.CompraDetalle { Cantidad = 1, PrecioUnitario = 0 };
        
        // Limpiar factores y precios guardados
        _factoresPorProducto.Clear();
        _preciosVentaPorProducto.Clear();
        _preciosMinisterioPorProducto.Clear();
        
        // Predeterminar tipo documento FACTURA
        var factura = TiposDocumento.FirstOrDefault(t => t.Nombre == "FACTURA");
        if (factura != null) 
        { 
            Compra.IdTipoDocumentoOperacion = factura.IdTipoDocumentoOperacion; 
            Compra.TipoDocumento = factura.Nombre; 
        }
        
        // Refrescar productos para actualizar stock despu√©s de la compra
        _ = RefrescarProductosAsync();
        
        StateHasChanged();
    }
    
    private async Task RefrescarProductosAsync()
    {
        try
        {
            await using var ctx = await DbFactory.CreateDbContextAsync();
            Productos = await ctx.Productos
                .Include(p => p.TipoIva)
                .Include(p => p.MonedaPrecio)
                .AsNoTracking()
                .OrderBy(p => p.Descripcion)
                .ToListAsync();
            
            // Cargar stocks por dep√≥sito
            var stocks = await ctx.ProductosDepositos
                .AsNoTracking()
                .ToListAsync();
            
            foreach (var p in Productos)
            {
                p.Stock = stocks.Where(s => s.IdProducto == p.IdProducto).Sum(s => s.Stock);
            }
            
            ProductosFiltrados = new(Productos);
            await InvokeAsync(StateHasChanged);
        }
        catch { /* Ignorar errores de refresco */ }
    }

    private void IrANuevaCompra()
    {
        Nav.NavigateTo("/compras", forceLoad: true);
    }

    private async Task NuevaCompraAsync()
    {
        var confirmar = await JS.InvokeAsync<bool>("confirm", 
            "¬øEst√° seguro de crear una nueva compra?\n\n" +
            "Los datos no guardados de la compra actual se perder√°n.");
        
        if (!confirmar) return;
        
        Nav.NavigateTo("/compras", forceLoad: true);
    }

    private async Task RefrescarPaginaAsync()
    {
        // Recargar la p√°gina actual con el mismo ID de compra si existe
        if (Compra.IdCompra > 0)
        {
            await CargarCompraPorIdAsync(Compra.IdCompra);
            StateHasChanged();
        }
        else
        {
            Nav.NavigateTo("/compras", forceLoad: true);
        }
    }

    // ========== RECICLAR COMPRA ==========
    
    private async Task MostrarModalReciclarCompraAsync()
    {
        // Verificar si hay pagos/√≥rdenes de pago asociadas ANTES de mostrar el modal
        await using var ctx = await DbFactory.CreateDbContextAsync();
        var pagosAsociados = await ctx.PagosProveedores
            .Where(p => p.IdCompra == Compra.IdCompra && p.Estado != "Anulado")
            .CountAsync();
        
        if (pagosAsociados > 0)
        {
            await JS.InvokeVoidAsync("alert", 
                $"‚ö†Ô∏è No se puede reciclar esta compra.\n\n" +
                $"Hay {pagosAsociados} orden(es) de pago asociada(s).\n\n" +
                $"Primero debe eliminar o anular las √≥rdenes de pago desde:\n" +
                $"‚Ä¢ Historial de Pagos a Proveedores");
            return;
        }
        
        _mostrarModalReciclar = true;
        _errorReciclar = null;
        _passwordReciclar = string.Empty;
        _idCompraOriginalReciclar = Compra.IdCompra;
        StateHasChanged();
    }
    
    private void CerrarModalReciclar()
    {
        _mostrarModalReciclar = false;
        _errorReciclar = null;
        _passwordReciclar = string.Empty;
        StateHasChanged();
    }
    
    private async Task EjecutarReciclarCompraAsync()
    {
        _errorReciclar = null;
        
        if (string.IsNullOrWhiteSpace(_passwordReciclar))
        {
            _errorReciclar = "Debe ingresar su contrase√±a para confirmar.";
            return;
        }
        
        // Verificar que el usuario tiene los permisos necesarios (admin + editar + eliminar)
        if (!PuedeReciclar)
        {
            _errorReciclar = "No tiene los permisos necesarios para realizar esta acci√≥n. Requiere: perfil administrador + permisos de Editar y Eliminar en Compras.";
            return;
        }
        
        _procesandoReciclar = true;
        StateHasChanged();
        
        try
        {
            await using var ctx = await DbFactory.CreateDbContextAsync();
            
            // 1. Validar la contrase√±a del usuario actual (que ya verificamos tiene permisos)
            if (!_usuarioId.HasValue)
            {
                _errorReciclar = "No se pudo identificar al usuario actual.";
                return;
            }
            
            var usuarioActual = await ctx.Usuarios.AsNoTracking()
                .FirstOrDefaultAsync(u => u.Id_Usu == _usuarioId.Value);
            
            if (usuarioActual == null)
            {
                _errorReciclar = "No se encontr√≥ el usuario actual en el sistema.";
                return;
            }
            
            // Validar contrase√±a con SHA256 (comparar bytes)
            if (usuarioActual.ContrasenaHash == null || usuarioActual.ContrasenaHash.Length == 0)
            {
                _errorReciclar = "Su usuario no tiene contrase√±a configurada.";
                return;
            }
            
            using var sha256 = System.Security.Cryptography.SHA256.Create();
            var passwordHashBytes = sha256.ComputeHash(System.Text.Encoding.UTF8.GetBytes(_passwordReciclar));
            
            if (!passwordHashBytes.SequenceEqual(usuarioActual.ContrasenaHash))
            {
                _errorReciclar = "‚ùå Contrase√±a incorrecta.";
                return;
            }
            
            // 2. Verificar que la compra existe
            var compraDb = await ctx.Compras
                .Include(c => c.Detalles)
                .FirstOrDefaultAsync(c => c.IdCompra == _idCompraOriginalReciclar);
            
            if (compraDb == null)
            {
                _errorReciclar = $"La compra #{_idCompraOriginalReciclar} no existe.";
                return;
            }
            
            // 3. Verificar si hay Notas de Cr√©dito asociadas
            var notasCreditoAsociadas = await ctx.NotasCreditoCompras
                .Where(nc => nc.IdCompraAsociada == _idCompraOriginalReciclar && nc.Estado != "Anulada")
                .Select(nc => new { nc.Establecimiento, nc.PuntoExpedicion, nc.NumeroNota, nc.Estado })
                .ToListAsync();
            
            if (notasCreditoAsociadas.Any())
            {
                var ncList = string.Join(", ", notasCreditoAsociadas.Select(nc => $"{nc.Establecimiento}-{nc.PuntoExpedicion}-{nc.NumeroNota}"));
                _errorReciclar = $"No se puede reciclar: hay {notasCreditoAsociadas.Count} NC asociada(s): {ncList}. An√∫lelas primero.";
                return;
            }
            
            // 4. Verificar si hay pagos confirmados
            var pagosConfirmados = await ctx.PagosProveedores
                .Where(p => p.IdCompra == _idCompraOriginalReciclar && p.Estado != "Anulado")
                .CountAsync();
            
            if (pagosConfirmados > 0)
            {
                _errorReciclar = $"No se puede reciclar: hay {pagosConfirmados} pago(s) confirmado(s). An√∫lelos primero desde el historial de pagos.";
                return;
            }
            
            // 4. Revertir el stock (tipo 2 = salida para quitar lo que se hab√≠a ingresado)
            if (compraDb.IdDeposito.HasValue && compraDb.Detalles.Any())
            {
                foreach (var d in compraDb.Detalles)
                {
                    var depositoAUsar = d.IdDepositoItem ?? compraDb.IdDeposito.Value;
                    await Inventario.AjustarStockAsync(
                        d.IdProducto,
                        depositoAUsar,
                        d.Cantidad,
                        2, // SALIDA
                        $"Reciclaje Compra #{_idCompraOriginalReciclar}",
                        "admin");
                }
            }
            
            // 5. Eliminar registros relacionados (similar a ComprasExplorar.Eliminar)
            var cuentaPorPagar = await ctx.CuentasPorPagar
                .Include(c => c.Cuotas)
                .FirstOrDefaultAsync(c => c.IdCompra == _idCompraOriginalReciclar);
            
            if (cuentaPorPagar != null)
            {
                // Eliminar pagos anulados y sus detalles
                var pagosAnulados = await ctx.PagosProveedores
                    .Include(p => p.Detalles)
                    .Where(p => p.IdCompra == _idCompraOriginalReciclar)
                    .ToListAsync();
                
                foreach (var pago in pagosAnulados)
                {
                    if (pago.Detalles != null && pago.Detalles.Any())
                        ctx.PagosProveedoresDetalles.RemoveRange(pago.Detalles);
                    ctx.PagosProveedores.Remove(pago);
                }
                
                // Eliminar cuotas
                if (cuentaPorPagar.Cuotas != null && cuentaPorPagar.Cuotas.Any())
                    ctx.CuentasPorPagarCuotas.RemoveRange(cuentaPorPagar.Cuotas);
                
                ctx.CuentasPorPagar.Remove(cuentaPorPagar);
            }
            
            // Eliminar detalles y compra de la BD
            ctx.ComprasDetalles.RemoveRange(compraDb.Detalles);
            ctx.Compras.Remove(compraDb);
            
            await ctx.SaveChangesAsync();
            
            // 6. Preparar la UI para edici√≥n (resetear IdCompra a 0 para que se guarde como nueva)
            Compra.IdCompra = 0;
            Compra.Estado = "Borrador";
            Compra.Fecha = FechaParaNuevaCompra; // Usar fecha de caja actual
            
            // Los detalles ya est√°n en memoria, solo resetear sus IDs
            foreach (var d in Detalles)
            {
                d.IdCompraDetalle = 0;
                d.IdCompra = 0;
            }
            
            // 7. Desactivar modo solo vista y cerrar modal
            ModoSoloVista = false;
            _mostrarModalReciclar = false;
            
            Ok = $"‚úÖ Compra #{_idCompraOriginalReciclar} eliminada. Datos listos para editar y guardar como nueva compra.";
            Error = null;
            
            StateHasChanged();
        }
        catch (Exception ex)
        {
            _errorReciclar = $"Error al reciclar: {ex.Message}";
        }
        finally
        {
            _procesandoReciclar = false;
            StateHasChanged();
        }
    }
    
    // ========== FIN RECICLAR COMPRA ==========

    private void IrAlExplorador()
    {
        Nav.NavigateTo("/compras/explorar", forceLoad: true);
    }

    private void OnTipoPagoChanged()
    {
        // Reflejar el nombre en FormaPago para compatibilidad
        var id = Compra.IdTipoPago;
        var sel = TiposPago.FirstOrDefault(t => t.IdTipoPago == id);
        Compra.FormaPago = sel?.Nombre;
        
        // Actualizar visibilidad de campos de cr√©dito
        MostrarCamposCredito = TipoPagoEsCredito;
        
        // Si es cr√©dito, establecer valores por defecto
        if (MostrarCamposCredito)
        {
            if (!Compra.PlazoDias.HasValue || Compra.PlazoDias <= 0)
                Compra.PlazoDias = 30;
            if (NumeroCuotasCompra <= 0)
                NumeroCuotasCompra = 1;
            // Solo calcular FechaVencimiento si no tiene valor (primera vez que selecciona cr√©dito)
            if (!Compra.FechaVencimiento.HasValue)
            {
                Compra.FechaVencimiento = Compra.Fecha.Date.AddDays(Compra.PlazoDias ?? 30);
            }
        }
        
        // Si es CONTADO, poner EFECTIVO por defecto
        if (EsTipoPagoContado())
        {
            Compra.MedioPago = "EFECTIVO";
        }
        else
        {
            // Si no es CONTADO, el medio de pago es el mismo que el tipo de pago (CREDITO, REMISION, etc.)
            Compra.MedioPago = sel?.Nombre?.ToUpperInvariant() ?? string.Empty;
        }
        StateHasChanged();
    }

    private void OnPlazoChanged()
    {
        // Recalcular fecha de vencimiento seg√∫n el plazo
        if (Compra.PlazoDias.HasValue && Compra.PlazoDias > 0)
        {
            Compra.FechaVencimiento = Compra.Fecha.Date.AddDays(Compra.PlazoDias.Value);
        }
        StateHasChanged();
    }

    private bool EsTipoPagoContado()
    {
        if (!Compra.IdTipoPago.HasValue) return true; // Si no hay selecci√≥n, consideramos contado por defecto
        var sel = TiposPago.FirstOrDefault(t => t.IdTipoPago == Compra.IdTipoPago);
        if (sel == null) return true;
        var nombre = (sel.Nombre ?? "").Trim().ToUpperInvariant();
        return nombre == "CONTADO";
    }

    private void OnTipoDocumentoChanged(ChangeEventArgs e)
    {
        var id = Compra.IdTipoDocumentoOperacion;
        var sel = TiposDocumento.FirstOrDefault(t => t.IdTipoDocumentoOperacion == id);
        Compra.TipoDocumento = sel?.Nombre ?? Compra.TipoDocumento;
    }

    private void AplicarFiltroProveedores()
    {
        var texto = (BuscarProveedor ?? string.Empty).Trim().ToLowerInvariant();
    if (string.IsNullOrWhiteSpace(texto)) { ProveedoresFiltrados = new(Proveedores); MostrarSugProveedores = false; StateHasChanged(); return; }

        // Separar criterio por nombre y por RUC (solo d√≠gitos)
        var digitos = new string(texto.Where(char.IsDigit).ToArray());

        ProveedoresFiltrados = Proveedores
            .Where(p => p.RazonSocial.ToLowerInvariant().Contains(texto)
                     || (!string.IsNullOrEmpty(digitos) && p.RUC.Contains(digitos)))
            .OrderBy(p => p.RazonSocial)
            .ToList();
    MostrarSugProveedores = ProveedoresFiltrados.Any();
        StateHasChanged();
    }

    private void AplicarFiltroProductos()
    {
        var texto = (BuscarProducto ?? string.Empty).Trim().ToLowerInvariant();
        if (string.IsNullOrWhiteSpace(texto)) { ProductosFiltrados = new(Productos); MostrarSugProductos = false; StateHasChanged(); return; }

        ProductosFiltrados = Productos
            .Where(p => (p.Descripcion ?? string.Empty).ToLowerInvariant().Contains(texto)
                     || (p.CodigoInterno ?? string.Empty).ToLowerInvariant().Contains(texto))
            .OrderBy(p => p.Descripcion)
            .ToList();
        MostrarSugProductos = ProductosFiltrados.Any();
        StateHasChanged();
    }

    private void SeleccionarProveedor(ProvSifenItem p)
    {
        Compra.IdProveedor = p.IdProveedor;
        BuscarProveedor = p.RazonSocial;
        MostrarSugProveedores = false;
        _ = CargarDatosProveedorAsync(p.IdProveedor);
    }

    private async Task CargarDatosProveedorAsync(int idProveedor)
    {
        try
        {
            await using var ctx = await DbFactory.CreateDbContextAsync();
            var prov = await ctx.ProveedoresSifen.AsNoTracking()
                .FirstOrDefaultAsync(x => x.IdProveedor == idProveedor);
            if (prov != null)
            {
                Compra.Timbrado = prov.Timbrado;
                VencimientoTimbradoProveedorSel = prov.VencimientoTimbrado;
                StateHasChanged();
            }
        }
        catch { }
    }

    private async Task SeleccionarProductoAsync(SistemIA.Models.Producto p)
    {
        NuevoDetalle.IdProducto = p.IdProducto;
        NuevoDetalle.PermiteDecimal = p.PermiteDecimal;
        // Mostrar el producto seleccionado en el buscador (no limpiar para mantener la lista abierta)
        BuscarProducto = p.Descripcion ?? string.Empty;
        
        // Mostrar imagen del producto seleccionado
        ProductoImagenUrl = p.Foto;
        
        // IMPORTANTE: CostoUnitarioGs y PrecioUnitarioGs SIEMPRE est√°n en Guaran√≠es por definici√≥n del campo
        // No importa qu√© moneda tenga asignada el producto en IdMonedaPrecio
        var precioBaseEnGs = p.CostoUnitarioGs ?? p.PrecioUnitarioGs;
        
        var idMonedaCompra = Compra.IdMoneda;
        decimal precio = precioBaseEnGs;
        
        // Solo convertir si la compra est√° en moneda extranjera (no en Gs)
        if (idMonedaCompra.HasValue)
        {
            var monCompra = Monedas.FirstOrDefault(m => m.IdMoneda == idMonedaCompra.Value);
            
            // Si la compra est√° en moneda extranjera (USD), convertir de Gs ‚Üí USD
            if (monCompra?.EsMonedaBase == false)
            {
                try {
                    // Prioridad 1: Usar TC manual si existe
                    if (Compra.CambioDelDia.HasValue && Compra.CambioDelDia.Value > 0)
                    {
                        var tasaManual = Compra.CambioDelDia.Value;
                        precio = Math.Round(precioBaseEnGs / tasaManual, 4);
                        NuevoDetalle.CambioDelDia = tasaManual;
                    }
                    else
                    {
                        // Prioridad 2: Buscar TC del d√≠a usando TasaCompra
                        await using var ctx = await DbFactory.CreateDbContextAsync();
                        var monedaBase = Monedas.FirstOrDefault(m => m.EsMonedaBase);
                        
                        if (monedaBase != null)
                        {
                            var tc = await ctx.TiposCambio
                                .Where(t => t.IdMonedaOrigen == idMonedaCompra.Value 
                                         && t.IdMonedaDestino == monedaBase.IdMoneda
                                         && t.Estado
                                         && t.FechaTipoCambio.Date == DateTime.Today)
                                .OrderByDescending(t => t.FechaCreacion)
                                .FirstOrDefaultAsync();
                            
                            if (tc != null)
                            {
                                var tasaCompra = tc.TasaCompra ?? tc.TasaCambio;
                                precio = Math.Round(precioBaseEnGs / tasaCompra, 4);
                                NuevoDetalle.CambioDelDia = tasaCompra;
                            }
                            else
                            {
                                // Fallback si no hay TC del d√≠a
                                var tasa = await ObtenerTasaAplicadaAsync(monedaBase.IdMoneda, idMonedaCompra.Value);
                                NuevoDetalle.CambioDelDia = tasa;
                                precio = Math.Round(precioBaseEnGs / tasa, 4);
                            }
                        }
                    }
                }
                catch { precio = precioBaseEnGs; NuevoDetalle.CambioDelDia = null; }
            }
        }
        // Si la compra est√° en Gs, usar el precio directamente sin conversi√≥n
        NuevoDetalle.PrecioUnitario = precio;

        // Precio de venta de referencia convertido (para margen)
        // PrecioUnitarioGs tambi√©n siempre est√° en Guaran√≠es
        try
        {
            var precioVentaEnGs = p.PrecioUnitarioGs;
            decimal precioVentaConv = precioVentaEnGs;
            
            if (idMonedaCompra.HasValue)
            {
                var monCompra = Monedas.FirstOrDefault(m => m.IdMoneda == idMonedaCompra.Value);
                
                // Solo convertir si la compra est√° en moneda extranjera
                if (monCompra?.EsMonedaBase == false)
                {
                    var cambio = NuevoDetalle.CambioDelDia ?? Compra.CambioDelDia ?? 1m;
                    precioVentaConv = Math.Round(precioVentaEnGs / cambio, 4);
                }
            }
            
            NuevoDetalle.PrecioVentaRef = precioVentaConv;
        }
        catch { NuevoDetalle.PrecioVentaRef = p.PrecioUnitarioGs; }

        // Calcular IVA incluido seg√∫n el tipo del producto (0/5/10)
        var porc = p.TipoIva?.Porcentaje ?? 0m;
        var cant = NuevoDetalle.Cantidad <= 0 ? 1 : NuevoDetalle.Cantidad;
        var totalLinea = Math.Round(cant * precio, 4);
        NuevoDetalle.IVA10 = 0; NuevoDetalle.IVA5 = 0; NuevoDetalle.Exenta = 0; NuevoDetalle.Grabado10 = 0; NuevoDetalle.Grabado5 = 0; NuevoDetalle.Importe = 0;
        if (porc == 10)
        {
            var base10 = Math.Round(totalLinea / 1.10m, 4);
            NuevoDetalle.Grabado10 = base10;
            NuevoDetalle.IVA10 = Math.Round(totalLinea - base10, 4);
        }
        else if (porc == 5)
        {
            var base5 = Math.Round(totalLinea / 1.05m, 4);
            NuevoDetalle.Grabado5 = base5;
            NuevoDetalle.IVA5 = Math.Round(totalLinea - base5, 4);
        }
        else
        {
            NuevoDetalle.Exenta = totalLinea;
        }
        NuevoDetalle.Importe = totalLinea;

        // Precargar Precio Ministerio del producto si existe y el modo farmacia est√° activo
        if (MostrarPrecioMinisterioEnCompras && p.PrecioMinisterio.HasValue)
        {
            PrecioMinisterioInput = p.PrecioMinisterio.Value;
        }
        else
        {
            PrecioMinisterioInput = null;
        }

        // Asignar dep√≥sito predeterminado del producto por ID (no por nombre)
        if (p.IdDepositoPredeterminado.HasValue && Depositos.Any(d => d.IdDeposito == p.IdDepositoPredeterminado.Value))
        {
            IdDepositoItemSeleccionado = p.IdDepositoPredeterminado.Value;
        }
        else if (Depositos.Any())
        {
            // Si el producto no tiene dep√≥sito predeterminado, usar el primero (ID 1 si existe)
            IdDepositoItemSeleccionado = Depositos.FirstOrDefault(d => d.IdDeposito == 1)?.IdDeposito ?? Depositos.First().IdDeposito;
        }

        // Cargar precio de venta actual del producto y calcular factor/markup
        if (NuevoDetalle.PrecioVentaRef > 0 && NuevoDetalle.PrecioUnitario > 0)
        {
            PrecioVentaCalculado = Math.Round(NuevoDetalle.PrecioVentaRef, 0);
            FactorMultiplicador = Math.Round(NuevoDetalle.PrecioVentaRef / NuevoDetalle.PrecioUnitario, 4);
            PorcentajeMargen = Math.Round((FactorMultiplicador.Value - 1) * 100, 2);
        }
        else
        {
            PrecioVentaCalculado = null;
            FactorMultiplicador = null;
            PorcentajeMargen = null;
        }

        // No cerrar la lista aqu√≠; se cerrar√° solo cuando se haga blur fuera del control
        await ActualizarStockSeleccionadoAsync();
    }

    // M√©todo para cambiar la imagen al hacer clic en un √≠tem del detalle
    private void SeleccionarDetalleCompra(SistemIA.Models.Producto? prod)
    {
        if (prod != null)
        {
            ProductoImagenUrl = prod.Foto;
        }
    }

    private async Task RefrescarProveedoresAsync()
    {
        await using var ctx = await DbFactory.CreateDbContextAsync();
        Proveedores = await ctx.Database
            .SqlQuery<ProvSifenItem>(
                $"SELECT IdProveedor, RazonSocial, RUC, DV FROM ProveedoresSifen ORDER BY RazonSocial")
            .ToListAsync();
        AplicarFiltroProveedores();
    }

    // Indicador de stock del producto seleccionado en el dep√≥sito elegido
    private decimal? StockActualSeleccion;
    private async Task OnDepositoChanged(ChangeEventArgs e)
    {
        await ActualizarStockSeleccionadoAsync();
    }
    private async Task ActualizarStockSeleccionadoAsync()
    {
        try
        {
            if (NuevoDetalle.IdProducto > 0 && Compra.IdDeposito.HasValue)
            {
                StockActualSeleccion = await Inventario.ObtenerStockAsync(NuevoDetalle.IdProducto, Compra.IdDeposito.Value);
            }
            else
            {
                StockActualSeleccion = null;
            }
        }
        catch { StockActualSeleccion = null; }
        StateHasChanged();
    }

    private async Task OnProveedorKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Enter" || e.Key == "Tab")
        {
            var texto = (BuscarProveedor ?? string.Empty).Trim();
            if (string.IsNullOrWhiteSpace(texto))
            {
                ProveedoresFiltrados = new(Proveedores);
                MostrarSugProveedores = ProveedoresFiltrados.Any();
                StateHasChanged();
                return;
            }
            
            // Buscar por RUC exacto primero en lista local
            var soloDigitos = new string(texto.Where(char.IsDigit).ToArray());
            if (!string.IsNullOrEmpty(soloDigitos))
            {
                var provPorRuc = Proveedores.FirstOrDefault(p => 
                    !string.IsNullOrEmpty(p.RUC) && (p.RUC.Equals(soloDigitos, StringComparison.OrdinalIgnoreCase) || p.RUC.StartsWith(soloDigitos)));
                
                if (provPorRuc != null)
                {
                    SeleccionarProveedor(provPorRuc);
                    _mensajeRucAuto = null;
                    StateHasChanged();
                    return;
                }
                
                // Si parece ser un RUC (>= 5 d√≠gitos), hacer b√∫squeda autom√°tica
                if (soloDigitos.Length >= 5)
                {
                    await BuscarRucAutoProveedorAsync(soloDigitos);
                    return;
                }
            }
            
            // Si no hay coincidencia por RUC exacto, seleccionar el primero de la lista
            var p = ProveedoresFiltrados.FirstOrDefault();
            if (p != null)
            {
                SeleccionarProveedor(p);
                StateHasChanged();
            }
        }
        else if (e.Key == "Escape")
        {
            MostrarSugProveedores = false;
            _mensajeRucAuto = null;
            StateHasChanged();
        }
    }
    
    /// <summary>
    /// B√∫squeda autom√°tica de RUC: Proveedor local ‚Üí RucDnit ‚Üí SIFEN
    /// </summary>
    private async Task BuscarRucAutoProveedorAsync(string ruc)
    {
        _buscandoRucAuto = true;
        _mensajeRucAuto = "üîç Buscando RUC...";
        _esRucAutoError = false;
        MostrarSugProveedores = false;
        StateHasChanged();

        try
        {
            var resultado = await RucService.BuscarRucUnificadoProveedorAsync(ruc);
            _resultadoRucAuto = resultado;

            if (resultado.Encontrado)
            {
                if (resultado.YaRegistrado && resultado.IdExistente.HasValue)
                {
                    // Ya existe en la BD - seleccionarlo directamente
                    var provExistente = Proveedores.FirstOrDefault(p => p.IdProveedor == resultado.IdExistente.Value);
                    if (provExistente != null)
                    {
                        SeleccionarProveedor(provExistente);
                        _mensajeRucAuto = $"‚úì {resultado.Mensaje}";
                        _esRucAutoError = false;
                    }
                }
                else
                {
                    // Encontrado pero no registrado - registrar autom√°ticamente
                    _mensajeRucAuto = $"üìù {resultado.Mensaje} - Registrando...";
                    StateHasChanged();
                    
                    var nuevoProveedor = await RegistrarProveedorDesdeRucAsync(resultado);
                    if (nuevoProveedor != null)
                    {
                        var item = new ProvSifenItem
                        {
                            IdProveedor = nuevoProveedor.IdProveedor,
                            RazonSocial = nuevoProveedor.RazonSocial,
                            RUC = nuevoProveedor.RUC,
                            DV = nuevoProveedor.DV
                        };
                        Proveedores.Add(item);
                        SeleccionarProveedor(item);
                        _mensajeRucAuto = $"‚úì Proveedor registrado: {nuevoProveedor.RazonSocial}";
                        _esRucAutoError = false;
                    }
                    else
                    {
                        _mensajeRucAuto = "‚ö†Ô∏è Error al registrar proveedor";
                        _esRucAutoError = true;
                    }
                }
            }
            else
            {
                // No encontrado - abrir modal de creaci√≥n r√°pida con datos prellenados
                _mensajeRucAuto = resultado.Mensaje;
                _esRucAutoError = true;
                
                // Precargar datos en el modal
                _nuevoProvRuc = ruc;
                _nuevoProvDv = resultado.DV;
                _nuevoProvRazonSocial = string.Empty;
                AbrirModalNuevoProveedor();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"[ERROR BuscarRucAutoProveedorAsync] {ex.Message}");
            _mensajeRucAuto = "‚ö†Ô∏è Error de conexi√≥n";
            _esRucAutoError = true;
        }
        finally
        {
            _buscandoRucAuto = false;
            StateHasChanged();
            
            // Limpiar mensaje despu√©s de 4 segundos
            _ = Task.Run(async () =>
            {
                await Task.Delay(4000);
                await InvokeAsync(() =>
                {
                    if (!_esRucAutoError) _mensajeRucAuto = null;
                    StateHasChanged();
                });
            });
        }
    }
    
    /// <summary>
    /// Registra un proveedor autom√°ticamente desde el resultado de b√∫squeda
    /// </summary>
    private async Task<ProveedorSifenMejorado?> RegistrarProveedorDesdeRucAsync(RucBusquedaResultado resultado)
    {
        try
        {
            await using var ctx = await DbFactory.CreateDbContextAsync();
            
            // Verificar que no exista el RUC (evitar duplicados)
            var rucSinGuion = (resultado.RUC ?? "").Replace("-", "").Trim();
            var existente = await ctx.ProveedoresSifen.AsNoTracking()
                .FirstOrDefaultAsync(p => p.RUC == rucSinGuion || p.RUC == resultado.RUC);
            
            if (existente != null)
            {
                Console.WriteLine($"[INFO] Proveedor con RUC {resultado.RUC} ya existe (ID: {existente.IdProveedor})");
                return existente; // Retornar el existente en lugar de crear duplicado
            }
            
            // Generar c√≥digo de proveedor autom√°tico
            var maxCodigo = await ctx.ProveedoresSifen
                .Where(p => p.CodigoProveedor != null)
                .Select(p => p.CodigoProveedor)
                .OrderByDescending(c => c)
                .FirstOrDefaultAsync();
            
            int siguienteCodigo = 1;
            if (!string.IsNullOrEmpty(maxCodigo))
            {
                // Extraer n√∫mero del c√≥digo (puede ser "01", "02", etc.)
                var soloNumeros = new string(maxCodigo.Where(char.IsDigit).ToArray());
                if (int.TryParse(soloNumeros, out var ultimoCodigo))
                {
                    siguienteCodigo = ultimoCodigo + 1;
                }
            }
            
            var nuevoProveedor = new ProveedorSifenMejorado
            {
                CodigoProveedor = siguienteCodigo.ToString().PadLeft(2, '0'),
                RazonSocial = resultado.RazonSocial ?? "SIN NOMBRE",
                NombreFantasia = resultado.RazonSocial ?? "SIN NOMBRE",
                RUC = rucSinGuion,
                DV = resultado.DV,
                TipoContribuyente = 2, // 2 = Persona Jur√≠dica (t√≠pico para RUC empresarial)
                SaldoPendiente = 0,
                Estado = true,
                CodigoCiudad = 1, // Asunci√≥n por defecto
                CodigoDepartamento = "01",
                DescripcionDepartamento = "CAPITAL"
            };
            
            ctx.ProveedoresSifen.Add(nuevoProveedor);
            await ctx.SaveChangesAsync();
            
            // Refrescar lista de proveedores
            await RefrescarProveedoresAsync();
            
            return nuevoProveedor;
        }
        catch (Exception ex)
        {
            Console.WriteLine($"[ERROR RegistrarProveedorDesdeRucAsync] {ex.Message}");
            return null;
        }
    }

    private async Task OnProductoKeyUp(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            var texto = (BuscarProducto ?? string.Empty).Trim();
            if (string.IsNullOrWhiteSpace(texto))
            {
                // Enter con buscador vac√≠o: mostrar todos los productos en sugerencias
                ProductosFiltrados = new(Productos);
                MostrarSugProductos = ProductosFiltrados.Any();
                StateHasChanged();
                return;
            }
            var p = ProductosFiltrados.FirstOrDefault();
            if (p != null) await SeleccionarProductoAsync(p);
        }
        else if (e.Key == "Escape")
        {
            MostrarSugProductos = false;
        }
    }

    private void OnProveedorFocus(FocusEventArgs _)
    {
        MostrarSugProveedores = ProveedoresFiltrados.Any();
    }

    private async Task OnProveedorBlur(FocusEventArgs _)
    {
        await Task.Delay(120);
        if (!_mouseDownEnSugerenciaProveedor)
        {
            // Si hay texto que parece RUC y no hay proveedor seleccionado, buscar autom√°ticamente
            var texto = (BuscarProveedor ?? string.Empty).Trim();
            var soloDigitos = new string(texto.Where(char.IsDigit).ToArray());
            
            if (Compra.IdProveedor == 0 && soloDigitos.Length >= 5 && !_buscandoRucAuto)
            {
                // Verificar si el RUC ya existe en la lista local
                var provExistente = Proveedores.FirstOrDefault(p => 
                    !string.IsNullOrEmpty(p.RUC) && p.RUC.Equals(soloDigitos, StringComparison.OrdinalIgnoreCase));
                
                if (provExistente != null)
                {
                    SeleccionarProveedor(provExistente);
                }
                else
                {
                    // Buscar en RucDnit y SIFEN
                    await BuscarRucAutoProveedorAsync(soloDigitos);
                }
            }
            
            MostrarSugProveedores = false;
            StateHasChanged();
        }
    }

    private void OnProductoFocus(FocusEventArgs _)
    {
        // Solo mostrar sugerencias al enfocar si hay texto; de lo contrario, no abrir
        if (!string.IsNullOrWhiteSpace(BuscarProducto))
        {
            MostrarSugProductos = ProductosFiltrados.Any();
        }
        else
        {
            MostrarSugProductos = false;
        }
    }

    private async Task OnProductoBlur(FocusEventArgs _)
    {
        // Ocultar sugerencias al perder foco, pero permitir seleccionar con pointerdown/mousedown primero
        await Task.Delay(120);
        if (!_mouseDownEnSugerenciaProducto)
        {
            MostrarSugProductos = false;
            StateHasChanged();
        }
    }

    private async Task OnProductoSuggestionMouseDownAsync(SistemIA.Models.Producto p)
    {
        _mouseDownEnSugerenciaProducto = true;
        await SeleccionarProductoAsync(p);
        // Resetear bandera un instante despu√©s
        _ = Task.Run(async () =>
        {
            await Task.Delay(150);
            _mouseDownEnSugerenciaProducto = false;
        });
    }

    private string TotalActualEnLetras
    {
        get
        {
            var monedaSel = Monedas.FirstOrDefault(m => m.IdMoneda == Compra.IdMoneda);
            var codigo = monedaSel?.CodigoISO ?? "PYG";
            var texto = NumeroEnLetras(Compra.Total, codigo);
            // Capitalizar la primera letra y mostrar c√≥digo de moneda
            if (!string.IsNullOrWhiteSpace(texto))
            {
                texto = char.ToUpper(texto[0]) + texto.Substring(1);
            }
            return texto;
        }
    }

    // Devuelve la tasa directa aplicada origen‚Üídestino considerando preferencia de venta si destino es PYG
    private async Task<decimal> ObtenerTasaAplicadaAsync(int idMonedaOrigen, int idMonedaDestino)
    {
        if (idMonedaOrigen == idMonedaDestino) return 1m;
        await using var ctx = await DbFactory.CreateDbContextAsync();
        var hoy = DateTime.Today;
        var monOri = await ctx.Monedas.AsNoTracking().FirstOrDefaultAsync(m => m.IdMoneda == idMonedaOrigen);
        var monDes = await ctx.Monedas.AsNoTracking().FirstOrDefaultAsync(m => m.IdMoneda == idMonedaDestino);

        var tc = await ctx.TiposCambio.AsNoTracking()
            .Where(t => t.IdMonedaOrigen == idMonedaOrigen && t.IdMonedaDestino == idMonedaDestino)
            .OrderByDescending(t => t.FechaTipoCambio)
            .FirstOrDefaultAsync();
        if (tc != null && tc.FechaTipoCambio.Date == hoy)
        {
            var tasa = (monDes?.CodigoISO == "PYG") ? (tc.TasaCompra ?? tc.TasaCambio) : tc.TasaCambio;
            if (tasa != 0) return tasa;
        }
        var tcInv = await ctx.TiposCambio.AsNoTracking()
            .Where(t => t.IdMonedaOrigen == idMonedaDestino && t.IdMonedaDestino == idMonedaOrigen)
            .OrderByDescending(t => t.FechaTipoCambio)
            .FirstOrDefaultAsync();
        if (tcInv != null && tcInv.FechaTipoCambio.Date == hoy)
        {
            var tasaInv = (monOri?.CodigoISO == "PYG") ? (tcInv.TasaCompra ?? tcInv.TasaCambio) : tcInv.TasaCambio;
            if (tasaInv != 0) return 1m / tasaInv;
        }
        // Fallback √∫ltimos
        if (tc != null)
        {
            var tasa = (monDes?.CodigoISO == "PYG") ? (tc.TasaCompra ?? tc.TasaCambio) : tc.TasaCambio;
            if (tasa != 0) return tasa;
        }
        if (tcInv != null)
        {
            var tasaInv = (monOri?.CodigoISO == "PYG") ? (tcInv.TasaCompra ?? tcInv.TasaCambio) : tcInv.TasaCambio;
            if (tasaInv != 0) return 1m / tasaInv;
        }
        return 1m;
    }

    private string GetCurrencyFlag(string? codigoISO)
    {
        switch ((codigoISO ?? string.Empty).ToUpperInvariant())
        {
            case "USD": return "\U0001F1FA\U0001F1F8"; // üá∫üá∏
            case "ARS": return "\U0001F1E6\U0001F1F7"; // üá¶üá∑
            case "BRL": return "\U0001F1E7\U0001F1F7"; // üáßüá∑
            case "PYG": return "\U0001F1F5\U0001F1FE"; // üáµüáæ
            case "EUR": return "\U0001F1EA\U0001F1FA"; // üá™üá∫
            default: return "\U0001F4B1"; // üí±
        }
    }
    
    private string FormatearPrecio(decimal valor)
    {
        // Si la compra es en moneda extranjera, mostrar decimales
        if (Compra.IdMoneda.HasValue)
        {
            var mon = Monedas.FirstOrDefault(m => m.IdMoneda == Compra.IdMoneda.Value);
            if (mon?.EsMonedaBase == false)
            {
                return valor.ToString("N2"); // 2 decimales para USD, etc.
            }
        }
        return valor.ToString("N0"); // Sin decimales para Guaran√≠es
    }

    // ============ M√©todos para modal de nuevo proveedor r√°pido ============
    private void AbrirModalNuevoProveedor()
    {
        _mostrarModalProveedor = true;
        _errorProveedor = null;
        _successProveedor = null;
        _nuevoProvRazonSocial = string.Empty;
        _nuevoProvRuc = string.Empty;
        _nuevoProvDv = 0;
        _nuevoProvTimbrado = string.Empty;
        _nuevoProvVencTimbrado = DateTime.Today.AddYears(2);
        _mensajeSifenProveedor = null;
        _esSifenProveedorError = false;
    }

    private void CerrarModalProveedor()
    {
        _mostrarModalProveedor = false;
    }

    private void CalcularDvProveedor()
    {
        if (!string.IsNullOrWhiteSpace(_nuevoProvRuc) && _nuevoProvRuc.All(char.IsDigit))
        {
            _nuevoProvDv = SistemIA.Utils.RucHelper.CalcularDvRuc(_nuevoProvRuc);
        }
        else
        {
            _nuevoProvDv = 0;
        }
    }

    private async Task BuscarProveedorEnSifenAsync()
    {
        if (string.IsNullOrWhiteSpace(_nuevoProvRuc) || _nuevoProvRuc.Length < 6)
        {
            _mensajeSifenProveedor = "Ingrese un RUC v√°lido (m√≠nimo 6 d√≠gitos)";
            _esSifenProveedorError = true;
            return;
        }

        _buscandoProveedorSifen = true;
        _mensajeSifenProveedor = null;
        _esSifenProveedorError = false;
        StateHasChanged();

        try
        {
            await using var ctx = await DbFactory.CreateDbContextAsync();
            
            // Primero buscar en BD local
            var proveedorLocal = await ctx.ProveedoresSifen.FirstOrDefaultAsync(p => p.RUC == _nuevoProvRuc);
            if (proveedorLocal != null)
            {
                _nuevoProvRazonSocial = proveedorLocal.RazonSocial ?? string.Empty;
                _nuevoProvDv = proveedorLocal.DV;
                _nuevoProvTimbrado = proveedorLocal.Timbrado ?? string.Empty;
                _nuevoProvVencTimbrado = proveedorLocal.VencimientoTimbrado != default ? proveedorLocal.VencimientoTimbrado : DateTime.Today.AddYears(2);
                _mensajeSifenProveedor = $"‚úì Proveedor encontrado en BD local: {proveedorLocal.RazonSocial}";
                _esSifenProveedorError = false;
                return;
            }

            // Calcular DV
            _nuevoProvDv = SistemIA.Utils.RucHelper.CalcularDvRuc(_nuevoProvRuc);

            // Si no est√° en BD local, consultar SIFEN
            var sociedad = await ctx.Sociedades.FirstOrDefaultAsync();
            if (sociedad == null || string.IsNullOrEmpty(sociedad.PathCertificadoP12))
            {
                _mensajeSifenProveedor = "‚ö†Ô∏è No hay certificado SIFEN configurado";
                _esSifenProveedorError = true;
                return;
            }

            var url = sociedad.DeUrlConsultaRuc ?? SifenConfig.GetConsultaRucUrl("test");
            var xmlRespuesta = await SifenService.Consulta(url, _nuevoProvRuc, "1", sociedad.PathCertificadoP12 ?? "", sociedad.PasswordCertificadoP12 ?? "");

            if (string.IsNullOrEmpty(xmlRespuesta))
            {
                _mensajeSifenProveedor = "‚ö†Ô∏è Sin respuesta de SIFEN. Intente nuevamente.";
                _esSifenProveedorError = true;
                return;
            }

            if (xmlRespuesta.Contains("0160") || xmlRespuesta.Contains("XML Mal Formado"))
            {
                _mensajeSifenProveedor = "‚ö†Ô∏è Error de conexi√≥n con SIFEN. Intente nuevamente.";
                _esSifenProveedorError = true;
                return;
            }

            var xmlDoc = new System.Xml.XmlDocument();
            xmlDoc.LoadXml(xmlRespuesta);

            var codRes = xmlDoc.SelectSingleNode("//*[local-name()='dCodRes']")?.InnerText ?? "";
            var msgRes = xmlDoc.SelectSingleNode("//*[local-name()='dMsgRes']")?.InnerText ?? "";

            if (codRes == "0502")
            {
                var xContRUC = xmlDoc.SelectSingleNode("//*[local-name()='xContRUC']");
                if (xContRUC != null)
                {
                    var dRazCons = xContRUC.SelectSingleNode(".//*[local-name()='dRazCons']")?.InnerText;
                    var dDesEstCons = xContRUC.SelectSingleNode(".//*[local-name()='dDesEstCons']")?.InnerText;
                    
                    if (!string.IsNullOrEmpty(dRazCons))
                    {
                        _nuevoProvRazonSocial = dRazCons.Trim();
                    }
                    
                    _mensajeSifenProveedor = $"‚úì SIFEN: {dRazCons?.Trim()} - {dDesEstCons}";
                    _esSifenProveedorError = false;
                }
            }
            else if (codRes == "0501")
            {
                _mensajeSifenProveedor = "RUC no encontrado en SIFEN. Puede ingresarlo manualmente.";
                _esSifenProveedorError = true;
            }
            else
            {
                _mensajeSifenProveedor = $"SIFEN: [{codRes}] {msgRes}";
                _esSifenProveedorError = codRes != "0500";
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"[ERROR BuscarProveedorEnSifenAsync] {ex.Message}");
            _mensajeSifenProveedor = "‚ö†Ô∏è Error de conexi√≥n. Intente nuevamente.";
            _esSifenProveedorError = true;
        }
        finally
        {
            _buscandoProveedorSifen = false;
            StateHasChanged();
        }
    }

    private async Task GuardarNuevoProveedorAsync()
    {
        _errorProveedor = null;
        _successProveedor = null;

        // Validaciones b√°sicas
        if (string.IsNullOrWhiteSpace(_nuevoProvRazonSocial))
        {
            _errorProveedor = "La Raz√≥n Social es obligatoria.";
            return;
        }

        if (string.IsNullOrWhiteSpace(_nuevoProvRuc) || !_nuevoProvRuc.All(char.IsDigit) || _nuevoProvRuc.Length < 6)
        {
            _errorProveedor = "El RUC debe contener al menos 6 d√≠gitos num√©ricos.";
            return;
        }

        if (string.IsNullOrWhiteSpace(_nuevoProvTimbrado) || _nuevoProvTimbrado.Length != 8 || !_nuevoProvTimbrado.All(char.IsDigit))
        {
            _errorProveedor = "El Timbrado debe tener exactamente 8 d√≠gitos num√©ricos.";
            return;
        }

        if (_nuevoProvVencTimbrado < DateTime.Today)
        {
            _errorProveedor = "La fecha de vencimiento del timbrado no puede ser anterior a hoy.";
            return;
        }

        _guardandoProveedor = true;
        StateHasChanged();

        try
        {
            await using var ctx = await DbFactory.CreateDbContextAsync();

            // Verificar si ya existe el RUC
            var existe = await ctx.ProveedoresSifen.AnyAsync(p => p.RUC == _nuevoProvRuc);
            if (existe)
            {
                _errorProveedor = "Ya existe un proveedor con este RUC.";
                _guardandoProveedor = false;
                return;
            }

            // Calcular DV si no se ha calculado
            if (_nuevoProvDv == 0)
            {
                _nuevoProvDv = SistemIA.Utils.RucHelper.CalcularDvRuc(_nuevoProvRuc);
            }

            // Usar transacci√≥n para evitar c√≥digos duplicados en concurrencia
            using var transaction = await ctx.Database.BeginTransactionAsync(System.Data.IsolationLevel.Serializable);
            try
            {
                // Generar c√≥digo de proveedor autom√°tico
                var maxCodigo = await ctx.ProveedoresSifen
                    .Where(p => p.CodigoProveedor != null)
                    .Select(p => p.CodigoProveedor)
                    .OrderByDescending(c => c)
                    .FirstOrDefaultAsync();
                
                int siguienteCodigo = 1;
                if (!string.IsNullOrEmpty(maxCodigo) && int.TryParse(maxCodigo, out var ultimoCodigo))
                {
                    siguienteCodigo = ultimoCodigo + 1;
                }

                // Crear el nuevo proveedor con campos m√≠nimos
                var nuevoProveedor = new SistemIA.Models.ProveedorSifenMejorado
                {
                    CodigoProveedor = siguienteCodigo.ToString().PadLeft(2, '0'),
                    RazonSocial = _nuevoProvRazonSocial.Trim(),
                    RUC = _nuevoProvRuc.Trim(),
                    DV = _nuevoProvDv,
                    Timbrado = _nuevoProvTimbrado.Trim(),
                    VencimientoTimbrado = _nuevoProvVencTimbrado,
                    Estado = true,
                    FechaCreacion = DateTime.Now,
                    UsuarioCreacion = _usuarioNombre ?? "Sistema",
                    Ambiente = "prod", // Por defecto producci√≥n
                    TipoContribuyente = 2, // Persona Jur√≠dica por defecto
                    TipoRegimen = 1 // R√©gimen General por defecto
                };

                ctx.ProveedoresSifen.Add(nuevoProveedor);
                await ctx.SaveChangesAsync();
                await transaction.CommitAsync();

            _successProveedor = $"Proveedor '{_nuevoProvRazonSocial}' creado exitosamente.";
            
            // Agregar a la lista local y seleccionar
            var nuevoItem = new ProvSifenItem
            {
                IdProveedor = nuevoProveedor.IdProveedor,
                RazonSocial = nuevoProveedor.RazonSocial,
                RUC = nuevoProveedor.RUC,
                DV = nuevoProveedor.DV
            };
            Proveedores.Add(nuevoItem);
            ProveedoresFiltrados = new(Proveedores);

            // Seleccionar autom√°ticamente el nuevo proveedor
            SeleccionarProveedor(nuevoItem);

            // Cerrar modal despu√©s de un momento
            await Task.Delay(1000);
            _mostrarModalProveedor = false;
            }
            catch
            {
                await transaction.RollbackAsync();
                throw;
            }
        }
        catch (Exception ex)
        {
            _errorProveedor = $"Error al guardar: {ex.Message}";
        }
        finally
        {
            _guardandoProveedor = false;
            StateHasChanged();
        }
    }

    // ============ M√©todos para modal de nuevo producto r√°pido ============
    private async Task AbrirModalNuevoProducto()
    {
        _mostrarModalProducto = true;
        _errorProducto = null;
        _successProducto = null;
        _imagenProductoPendiente = null;
        _previewImagenProducto = null;
        
        // Inicializar producto con valores por defecto
        _nuevoProducto = new SistemIA.Models.Producto
        {
            TipoItem = 1, // Producto
            Activo = true,
            UnidadMedidaCodigo = "77", // Unidad
            UndMedida = "UNIDAD",
            IdDepositoPredeterminado = 1 // Dep√≥sito predeterminado oculto
        };
        
        // Cargar cat√°logos si no est√°n cargados
        if (!_marcasModal.Any() || !_tiposIvaModal.Any())
        {
            try
            {
                await using var ctx = await DbFactory.CreateDbContextAsync();
                _marcasModal = await ctx.Marcas.OrderBy(m => m.NombreMarca).ToListAsync();
                _clasificacionesModal = await ctx.Clasificaciones.Where(c => c.Activo).OrderBy(c => c.Nombre).ToListAsync();
                _tiposIvaModal = await ctx.TiposIva.OrderBy(t => t.Porcentaje).ToListAsync();
                
                // Seleccionar IVA 10% por defecto si existe
                var iva10 = _tiposIvaModal.FirstOrDefault(i => i.Porcentaje == 10);
                if (iva10 != null)
                {
                    _nuevoProducto.IdTipoIva = iva10.IdTipoIva;
                }
                else if (_tiposIvaModal.Any())
                {
                    _nuevoProducto.IdTipoIva = _tiposIvaModal.First().IdTipoIva;
                }
            }
            catch (Exception ex)
            {
                _errorProducto = $"Error al cargar cat√°logos: {ex.Message}";
            }
        }
        else
        {
            // Ya est√°n cargados, solo establecer IVA por defecto
            var iva10 = _tiposIvaModal.FirstOrDefault(i => i.Porcentaje == 10);
            _nuevoProducto.IdTipoIva = iva10?.IdTipoIva ?? _tiposIvaModal.FirstOrDefault()?.IdTipoIva ?? 0;
        }
    }

    private void CerrarModalProducto()
    {
        _mostrarModalProducto = false;
        _imagenProductoPendiente = null;
        _previewImagenProducto = null;
    }

    private async Task OnImagenProductoChange(InputFileChangeEventArgs e)
    {
        var file = e.File;
        if (file == null) return;

        // Validar tama√±o (2MB)
        if (file.Size > 2 * 1024 * 1024)
        {
            _errorProducto = "La imagen no puede superar 2 MB.";
            return;
        }

        // Validar tipo
        var allowedTypes = new[] { "image/png", "image/jpeg", "image/webp" };
        if (!allowedTypes.Contains(file.ContentType.ToLower()))
        {
            _errorProducto = "Solo se permiten im√°genes PNG, JPG o WEBP.";
            return;
        }

        _imagenProductoPendiente = file;
        _errorProducto = null;

        // Generar preview
        try
        {
            using var stream = file.OpenReadStream(2 * 1024 * 1024);
            using var ms = new MemoryStream();
            await stream.CopyToAsync(ms);
            var base64 = Convert.ToBase64String(ms.ToArray());
            _previewImagenProducto = $"data:{file.ContentType};base64,{base64}";
        }
        catch
        {
            _previewImagenProducto = null;
        }
    }

    private async Task GuardarNuevoProductoAsync()
    {
        _errorProducto = null;
        _successProducto = null;

        // Validaciones
        if (string.IsNullOrWhiteSpace(_nuevoProducto.Descripcion))
        {
            _errorProducto = "La descripci√≥n es obligatoria.";
            return;
        }

        if (_nuevoProducto.IdTipoIva == 0)
        {
            _errorProducto = "Debe seleccionar un tipo de IVA.";
            return;
        }

        _guardandoProducto = true;
        StateHasChanged();

        try
        {
            await using var ctx = await DbFactory.CreateDbContextAsync();
            
            // Obtener sucursal actual
            var sucId = SucursalProvider.GetSucursalId();
            if (!sucId.HasValue)
            {
                _errorProducto = "No hay sucursal seleccionada.";
                return;
            }
            _nuevoProducto.IdSucursal = sucId.Value;

            // C√≥digo temporal - se actualizar√° despu√©s del SaveChanges con el IdProducto real
            _nuevoProducto.CodigoInterno = "AUTO";

            // Guardar imagen si hay una pendiente
            if (_imagenProductoPendiente != null)
            {
                try
                {
                    var uploadsPath = Path.Combine(Directory.GetCurrentDirectory(), "wwwroot", "uploads", "productos");
                    Directory.CreateDirectory(uploadsPath);

                    var ext = Path.GetExtension(_imagenProductoPendiente.Name).ToLowerInvariant();
                    if (string.IsNullOrEmpty(ext)) ext = ".jpg";
                    var fileName = $"{Guid.NewGuid()}{ext}";
                    var filePath = Path.Combine(uploadsPath, fileName);

                    using var stream = _imagenProductoPendiente.OpenReadStream(2 * 1024 * 1024);
                    using var fs = new FileStream(filePath, FileMode.Create);
                    await stream.CopyToAsync(fs);

                    _nuevoProducto.Foto = $"/uploads/productos/{fileName}";
                }
                catch (Exception exImg)
                {
                    // No fallar por la imagen, solo loguear
                    Console.WriteLine($"Error guardando imagen: {exImg.Message}");
                }
            }

            // Valores por defecto adicionales
            _nuevoProducto.CostoUnitarioGs = 0;
            _nuevoProducto.PrecioUnitarioGs = 0;
            _nuevoProducto.Stock = 0;
            _nuevoProducto.StockMinimo = 0;

            ctx.Productos.Add(_nuevoProducto);
            await ctx.SaveChangesAsync();

            // Generar c√≥digo definitivo basado en el Id y sucursal (garantiza correlatividad)
            _nuevoProducto.CodigoInterno = $"PROD-{_nuevoProducto.IdSucursal:000}-{_nuevoProducto.IdProducto:000000}";
            ctx.Productos.Update(_nuevoProducto);
            await ctx.SaveChangesAsync();

            _successProducto = $"‚úì Producto '{_nuevoProducto.CodigoInterno}' creado exitosamente.";

            // Agregar a la lista local de productos
            var productoCreado = await ctx.Productos
                .Include(p => p.TipoIva)
                .Include(p => p.Marca)
                .FirstOrDefaultAsync(p => p.IdProducto == _nuevoProducto.IdProducto);

            if (productoCreado != null)
            {
                Productos.Add(productoCreado);
            }

            // Seleccionar autom√°ticamente el producto en el buscador
            if (productoCreado != null)
            {
                await Task.Delay(500);
                await SeleccionarProductoAsync(productoCreado);
                _mostrarModalProducto = false;
            }
        }
        catch (Exception ex)
        {
            _errorProducto = $"Error al guardar: {ex.Message}";
        }
        finally
        {
            _guardandoProducto = false;
            StateHasChanged();
        }
    }
}

</PageProtection>
