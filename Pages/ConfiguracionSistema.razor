@page "/configuracion-sistema"
@inject IDbContextFactory<AppDbContext> DbFactory
@inject IJSRuntime JS
@inject NavigationManager Nav
@inject IConfiguration Configuration
@using Microsoft.EntityFrameworkCore
@using Microsoft.AspNetCore.Components.Authorization
@using Models = SistemIA.Models

<PageProtection Modulo="/configuracion" Permiso="VIEW">

@* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê *@
@* MODAL DE AUTENTICACI√ìN - Requiere contrase√±a SA para acceder                  *@
@* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê *@
@if (!_accesoAutorizado)
{
    <div class="d-flex justify-content-center align-items-center" style="min-height: 70vh;">
        <div class="card shadow-lg" style="max-width: 450px; width: 100%;">
            <div class="card-header bg-warning text-dark text-center">
                <h5 class="mb-0"><i class="bi bi-shield-lock me-2"></i>Acceso Restringido</h5>
            </div>
            <div class="card-body p-4">
                <div class="text-center mb-4">
                    <i class="bi bi-database-lock text-warning" style="font-size: 4rem;"></i>
                    <p class="mt-3 text-muted">
                        Esta secci√≥n contiene configuraciones cr√≠ticas del sistema.
                        Por seguridad, ingrese la contrase√±a del administrador de base de datos (SA).
                    </p>
                </div>
                
                <div class="mb-3">
                    <label class="form-label fw-bold">Contrase√±a SA</label>
                    <div class="input-group">
                        <input type="@(_mostrarPasswordInput ? "text" : "password")" 
                               class="form-control form-control-lg @(_errorPassword ? "is-invalid" : "")" 
                               @bind="_passwordIngresada" 
                               @bind:event="oninput"
                               @onkeypress="OnKeyPressPassword"
                               placeholder="Ingrese la contrase√±a..." />
                        <button class="btn btn-outline-secondary" type="button" @onclick="() => _mostrarPasswordInput = !_mostrarPasswordInput">
                            <i class="bi @(_mostrarPasswordInput ? "bi-eye-slash" : "bi-eye")"></i>
                        </button>
                    </div>
                    @if (_errorPassword)
                    {
                        <div class="invalid-feedback d-block">
                            <i class="bi bi-x-circle me-1"></i>Contrase√±a incorrecta. Intente nuevamente.
                        </div>
                    }
                </div>
                
                <div class="d-grid gap-2">
                    <button class="btn btn-primary btn-lg" @onclick="VerificarPassword" disabled="@(string.IsNullOrEmpty(_passwordIngresada))">
                        <i class="bi bi-unlock me-2"></i>Acceder
                    </button>
                    <button class="btn btn-outline-secondary" @onclick="VolverAlInicio">
                        <i class="bi bi-arrow-left me-2"></i>Volver al Inicio
                    </button>
                </div>
            </div>
            <div class="card-footer text-center text-muted small">
                <i class="bi bi-info-circle me-1"></i>
                Si olvid√≥ la contrase√±a, contacte al administrador del sistema.
            </div>
        </div>
    </div>
}
else
{

<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="text-primary mb-0"><i class="bi bi-gear me-2"></i>Configuraci√≥n del Sistema</h2>
    </div>

    @if (!string.IsNullOrEmpty(_mensaje))
    {
        <div class="alert @(_esError ? "alert-danger" : "alert-success") alert-dismissible fade show" role="alert">
            @_mensaje
            <button type="button" class="btn-close" @onclick="() => _mensaje = null"></button>
        </div>
    }

    <div class="row">
        <!-- Secci√≥n Farmacia -->
        <div class="col-lg-6 mb-4">
            <div class="card h-100">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="bi bi-capsule me-2"></i>Configuraci√≥n de Farmacia</h5>
                </div>
                <div class="card-body">
                    <p class="text-muted small mb-3">
                        Estas opciones habilitan funcionalidades espec√≠ficas para farmacias, 
                        como el control de precios regulados por el Ministerio de Salud.
                    </p>

                    <div class="mb-3">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="farmaciaActivo" 
                                   @bind="_config.FarmaciaModoActivo" />
                            <label class="form-check-label fw-bold" for="farmaciaActivo">
                                üè• Modo Farmacia Activo
                            </label>
                        </div>
                        <div class="form-text">Habilita todas las funcionalidades espec√≠ficas para farmacias.</div>
                    </div>

                    @if (_config.FarmaciaModoActivo)
                    {
                        <div class="ps-4 border-start border-primary border-3">
                            <div class="mb-3">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="mostrarPrecioMinisterio" 
                                           @bind="_config.FarmaciaMostrarPrecioMinisterio" />
                                    <label class="form-check-label" for="mostrarPrecioMinisterio">
                                        Mostrar campo "Precio Ministerio" en Productos
                                    </label>
                                </div>
                                <div class="form-text">Muestra el campo para ingresar el precio m√°ximo regulado.</div>
                            </div>

                            <div class="mb-3">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="validarPrecioMinisterio" 
                                           @bind="_config.FarmaciaValidarPrecioMinisterio" />
                                    <label class="form-check-label" for="validarPrecioMinisterio">
                                        <i class="bi bi-shield-check text-success"></i> Validar que el precio no supere el Precio Ministerio
                                    </label>
                                </div>
                                <div class="form-text text-warning">
                                    <i class="bi bi-exclamation-triangle"></i> 
                                    Si est√° activo, no se podr√° guardar un producto con precio mayor al regulado.
                                </div>
                            </div>

                            <div class="mb-3">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="mostrarPrecioMinisterioCompras" 
                                           @bind="_config.FarmaciaMostrarPrecioMinisterioEnCompras" />
                                    <label class="form-check-label" for="mostrarPrecioMinisterioCompras">
                                        Mostrar "Precio Ministerio" en Compras
                                    </label>
                                </div>
                                <div class="form-text">Muestra el precio ministerio en los detalles de compra para referencia.</div>
                            </div>

                            <div class="mb-3">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="descuentoBasadoPrecioMinisterio" 
                                           @bind="_config.FarmaciaDescuentoBasadoEnPrecioMinisterio" />
                                    <label class="form-check-label" for="descuentoBasadoPrecioMinisterio">
                                        <i class="bi bi-percent text-info"></i> Calcular descuento basado en Precio Ministerio
                                    </label>
                                </div>
                                <div class="form-text text-info">
                                    <i class="bi bi-info-circle"></i> 
                                    Si est√° activo, el descuento en ventas se mostrar√° como: ((Precio Ministerio - Precio Venta) / Precio Ministerio) √ó 100
                                </div>
                            </div>
                        </div>
                    }
                </div>
            </div>
        </div>

        <!-- Secci√≥n Restaurante/Bar -->
        <div class="col-lg-6 mb-4">
            <div class="card h-100">
                <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0"><i class="bi bi-cup-straw me-2"></i>Configuraci√≥n Restaurante / Bar</h5>
                </div>
                <div class="card-body">
                    <p class="text-muted small mb-3">
                        Habilita funcionalidades para restaurantes, bares y cafeter√≠as: 
                        gesti√≥n de mesas, pedidos, comandas y divisi√≥n de cuentas.
                    </p>

                    <div class="mb-3">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="restauranteActivo" 
                                   @bind="_config.RestauranteModoActivo" />
                            <label class="form-check-label fw-bold" for="restauranteActivo">
                                @(_config.TipoNegocioMesas switch {
                                    "Taller" => "üöó",
                                    "Complejo" => "‚öΩ",
                                    _ => "üçΩÔ∏è"
                                }) Modo @ObtenerNombreModulo() Activo
                            </label>
                        </div>
                        <div class="form-text">Habilita gesti√≥n de @ObtenerNombreEspacios().ToLower(), pedidos y reservas.</div>
                    </div>

                    @if (_config.RestauranteModoActivo)
                    {
                        <div class="ps-4 border-start border-warning border-3">
                            <!-- Selector de Tipo de Negocio -->
                            <div class="mb-3">
                                <label class="form-label small fw-bold">
                                    <i class="bi bi-building text-primary me-1"></i>Tipo de Negocio
                                </label>
                                <select class="form-select form-select-sm" @bind="_config.TipoNegocioMesas">
                                    <option value="Restaurante">üçΩÔ∏è Restaurante / Bar / Cafeter√≠a</option>
                                    <option value="Complejo">‚öΩ Complejo Deportivo / Canchas</option>
                                    <option value="Taller">üöó Taller Mec√°nico / Servicio Automotriz</option>
                                </select>
                                <div class="form-text">Define la terminolog√≠a usada en el sistema (Mesas, Canchas, Bah√≠as).</div>
                            </div>

                            <div class="mb-3">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="permitirDivision" 
                                           @bind="_config.RestaurantePermitirDivisionCuenta" />
                                    <label class="form-check-label" for="permitirDivision">
                                        <i class="bi bi-scissors text-info"></i> Permitir divisi√≥n de cuenta
                                    </label>
                                </div>
                                <div class="form-text">Permite dividir la cuenta entre varios clientes.</div>
                            </div>

                            <div class="mb-3">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="permitirParciales" 
                                           @bind="_config.RestaurantePermitirPagosParciales" />
                                    <label class="form-check-label" for="permitirParciales">
                                        <i class="bi bi-cash-stack text-success"></i> Permitir pagos parciales
                                    </label>
                                </div>
                                <div class="form-text">Permite que el cliente vaya pagando de a poco.</div>
                            </div>

                            <div class="mb-3">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="mostrarTiempo" 
                                           @bind="_config.RestauranteMostrarTiempo" />
                                    <label class="form-check-label" for="mostrarTiempo">
                                        <i class="bi bi-clock text-primary"></i> Mostrar tiempo en mesa
                                    </label>
                                </div>
                                <div class="form-text">Muestra el tiempo transcurrido desde que se abri√≥ el pedido.</div>
                            </div>

                            <div class="mb-3">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="imprimirComandaAuto" 
                                           @bind="_config.RestauranteImprimirComandaAuto" />
                                    <label class="form-check-label" for="imprimirComandaAuto">
                                        <i class="bi bi-printer text-secondary"></i> Imprimir comanda autom√°ticamente
                                    </label>
                                </div>
                                <div class="form-text">Imprime la comanda al agregar productos al pedido.</div>
                            </div>

                            <div class="mb-3">
                                <label class="form-label small">Cargo por servicio (%)</label>
                                <input type="number" class="form-control form-control-sm" 
                                       @bind="_config.RestauranteCargoServicio" 
                                       min="0" max="100" step="0.5" placeholder="Ej: 10" />
                                <div class="form-text">Porcentaje de propina/servicio sugerido (opcional).</div>
                            </div>
                            
                            <div class="alert alert-info small py-2 mb-0">
                                <i class="bi bi-info-circle me-1"></i>
                                Las impresoras de cocina y barra se configuran en cada <strong>Caja</strong> individual.
                            </div>
                        </div>
                    }
                </div>
            </div>
        </div>

    </div>

    <div class="row">
        <!-- Secci√≥n Canchas/Alquileres -->
        <div class="col-lg-6 mb-4">
            <div class="card h-100">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0"><i class="bi bi-dribbble me-2"></i>Configuraci√≥n Canchas / Alquileres</h5>
                </div>
                <div class="card-body">
                    <p class="text-muted small mb-3">
                        Habilita funcionalidades para canchas deportivas, salas de eventos 
                        o espacios que se alquilan por tiempo.
                    </p>

                    <div class="mb-3">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="canchasActivo" 
                                   @bind="_config.CanchasModoActivo" />
                            <label class="form-check-label fw-bold" for="canchasActivo">
                                ‚öΩ Modo Canchas/Alquileres Activo
                            </label>
                        </div>
                        <div class="form-text">Habilita gesti√≥n de espacios con cobro por tiempo.</div>
                    </div>

                    @if (_config.CanchasModoActivo)
                    {
                        <div class="ps-4 border-start border-success border-3">
                            <div class="mb-3">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="reservasHabilitadas" 
                                           @bind="_config.ReservasHabilitadas" />
                                    <label class="form-check-label" for="reservasHabilitadas">
                                        <i class="bi bi-calendar-check text-primary"></i> Habilitar reservas
                                    </label>
                                </div>
                                <div class="form-text">Permite realizar reservas anticipadas.</div>
                            </div>

                            @if (_config.ReservasHabilitadas)
                            {
                                <div class="mb-3">
                                    <label class="form-label small">Recordatorio antes de la reserva (minutos)</label>
                                    <input type="number" class="form-control form-control-sm" 
                                           @bind="_config.ReservasRecordatorioMinutos" 
                                           min="15" max="1440" step="15" placeholder="Ej: 60" />
                                    <div class="form-text">Cu√°ntos minutos antes enviar recordatorio (WhatsApp/Email).</div>
                                </div>
                            }
                        </div>
                    }
                </div>
            </div>
        </div>

        <!-- Secci√≥n General -->
        <div class="col-lg-6 mb-4">
            <div class="card h-100">
                <div class="card-header bg-secondary text-white">
                    <h5 class="mb-0"><i class="bi bi-building me-2"></i>Informaci√≥n General</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label class="form-label">Nombre del Negocio</label>
                        <input type="text" class="form-control" @bind="_config.NombreNegocio" placeholder="Nombre de la empresa" />
                        <div class="form-text">Se mostrar√° en reportes e impresiones.</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- NUEVA FILA: Gimnasio -->
    <div class="row">
        <div class="col-lg-6 mb-4">
            <div class="card h-100">
                <div class="card-header bg-danger text-white">
                    <h5 class="mb-0"><i class="bi bi-heart-pulse me-2"></i>Configuraci√≥n Gimnasio</h5>
                </div>
                <div class="card-body">
                    <p class="text-muted small mb-3">
                        Habilita funcionalidades para gimnasios: membres√≠as, control de acceso 
                        con reconocimiento facial, planes y seguimiento de clientes.
                    </p>

                    <div class="mb-3">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="gimnasioActivo" 
                                   @bind="_config.GimnasioModoActivo" />
                            <label class="form-check-label fw-bold" for="gimnasioActivo">
                                üí™ Modo Gimnasio Activo
                            </label>
                        </div>
                        <div class="form-text">Habilita gesti√≥n de membres√≠as, acceso y control de asistencia.</div>
                    </div>

                    @if (_config.GimnasioModoActivo)
                    {
                        <div class="ps-4 border-start border-danger border-3">
                            <div class="mb-3">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="reconocimientoFacial" 
                                           @bind="_config.GimnasioReconocimientoFacialActivo" />
                                    <label class="form-check-label" for="reconocimientoFacial">
                                        <i class="bi bi-camera text-primary"></i> Reconocimiento facial activo
                                    </label>
                                </div>
                                <div class="form-text">Permite identificar clientes por c√°mara al ingresar.</div>
                            </div>

                            @if (_config.GimnasioReconocimientoFacialActivo)
                            {
                                <div class="mb-3">
                                    <label class="form-label small">Umbral de coincidencia (%)</label>
                                    <input type="number" class="form-control form-control-sm" 
                                           @bind="_config.GimnasioUmbralCoincidenciaFacial" 
                                           min="50" max="100" step="5" placeholder="Ej: 85" />
                                    <div class="form-text">Porcentaje m√≠nimo para reconocer al cliente (85% recomendado).</div>
                                </div>
                            }

                            <div class="mb-3">
                                <label class="form-label small">D√≠as de gracia despu√©s de vencimiento</label>
                                <input type="number" class="form-control form-control-sm" 
                                       @bind="_config.GimnasioDiasGracia" 
                                       min="0" max="15" step="1" placeholder="Ej: 3" />
                                <div class="form-text">D√≠as que puede acceder despu√©s de vencer su membres√≠a.</div>
                            </div>

                            <div class="mb-3">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="permitirDiasGracia" 
                                           @bind="_config.GimnasioPermitirAccesoDiasGracia" />
                                    <label class="form-check-label" for="permitirDiasGracia">
                                        <i class="bi bi-door-open text-success"></i> Permitir acceso en d√≠as de gracia
                                    </label>
                                </div>
                            </div>

                            <div class="mb-3">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="habilitarVozGimnasio" 
                                           @bind="_config.GimnasioHabilitarVoz" />
                                    <label class="form-check-label" for="habilitarVozGimnasio">
                                        <i class="bi bi-megaphone text-info"></i> Habilitar voz de bienvenida/despedida
                                    </label>
                                </div>
                            </div>

                            <hr class="my-3"/>
                            <h6 class="mb-2"><i class="bi bi-chat-quote me-1"></i> Mensajes Personalizados</h6>

                            <div class="mb-2">
                                <label class="form-label small">Mensaje de bienvenida</label>
                                <input type="text" class="form-control form-control-sm" 
                                       @bind="_config.GimnasioMensajeBienvenida" 
                                       placeholder="¬°Bienvenido/a {nombre}!" />
                            </div>

                            <div class="mb-2">
                                <label class="form-label small">Mensaje de despedida</label>
                                <input type="text" class="form-control form-control-sm" 
                                       @bind="_config.GimnasioMensajeDespedida" 
                                       placeholder="¬°Hasta pronto {nombre}!" />
                            </div>

                            <div class="mb-2">
                                <label class="form-label small">Mensaje cuando est√° por vencer</label>
                                <input type="text" class="form-control form-control-sm" 
                                       @bind="_config.GimnasioMensajeVencimientoProximo" 
                                       placeholder="Tu membres√≠a vence en {dias} d√≠as" />
                            </div>

                            <div class="mb-0">
                                <label class="form-label small">Mensaje cuando est√° vencido</label>
                                <input type="text" class="form-control form-control-sm" 
                                       @bind="_config.GimnasioMensajeVencido" 
                                       placeholder="Tu membres√≠a est√° vencida" />
                            </div>
                        </div>
                    }
                </div>
            </div>
        </div>

        <!-- Secci√≥n Agenda -->
        <div class="col-lg-6 mb-4">
            <div class="card h-100">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0"><i class="bi bi-calendar3 me-2"></i>Configuraci√≥n de Agenda</h5>
                </div>
                <div class="card-body">
                    <p class="text-muted small mb-3">
                        Habilita el m√≥dulo de agenda para gestionar citas, visitas y recordatorios autom√°ticos.
                    </p>

                    <div class="mb-3">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="agendaActivo" 
                                   @bind="_config.AgendaModoActivo" />
                            <label class="form-check-label fw-bold" for="agendaActivo">
                                üìÖ Modo Agenda Activo
                            </label>
                        </div>
                        <div class="form-text">Habilita el calendario con citas, visitas y recordatorios por email.</div>
                    </div>

                    @if (_config.AgendaModoActivo)
                    {
                        <div class="ps-4 border-start border-info border-3">
                            <div class="mb-3">
                                <label class="form-label small">Recordatorio por defecto (minutos antes)</label>
                                <input type="number" class="form-control form-control-sm" 
                                       @bind="_config.AgendaRecordatorioMinutos" 
                                       min="5" max="1440" step="5" placeholder="30" />
                            </div>

                            <div class="mb-3">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="agendaEmail" 
                                           @bind="_config.AgendaEnviarRecordatoriosEmail" />
                                    <label class="form-check-label" for="agendaEmail">
                                        <i class="bi bi-envelope text-primary"></i> Enviar recordatorios por email
                                    </label>
                                </div>
                                <div class="form-text">Requiere configuraci√≥n de correo en cada sucursal.</div>
                            </div>

                            <div class="mb-3">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="agendaColores" 
                                           @bind="_config.AgendaColoresPorCliente" />
                                    <label class="form-check-label" for="agendaColores">
                                        <i class="bi bi-palette text-warning"></i> Colores personalizados por cliente
                                    </label>
                                </div>
                                <div class="form-text">Permite asignar un color distinto a cada cliente en el calendario.</div>
                            </div>

                            <div class="mb-0">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="agendaGPS" 
                                           @bind="_config.AgendaMostrarUbicacionGPS" />
                                    <label class="form-check-label" for="agendaGPS">
                                        <i class="bi bi-geo-alt text-success"></i> Mostrar ubicaci√≥n GPS en citas
                                    </label>
                                </div>
                                <div class="form-text">Habilita integraci√≥n con Google Maps en las citas.</div>
                            </div>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Secci√≥n Acceso Administrativo -->
        <div class="col-lg-6 mb-4">
            <div class="card h-100">
                <div class="card-header bg-dark text-white">
                    <h5 class="mb-0"><i class="bi bi-database-lock me-2"></i>Acceso Administrativo</h5>
                </div>
                <div class="card-body">
                    <p class="text-muted small mb-3">
                        Credenciales de acceso administrativo al sistema y base de datos.
                        <strong class="text-danger">Proteja esta informaci√≥n.</strong>
                    </p>

                    <div class="mb-3">
                        <label class="form-label small fw-bold">
                            <i class="bi bi-server text-primary me-1"></i>Servidor SQL
                        </label>
                        <div class="input-group input-group-sm">
                            <span class="input-group-text"><i class="bi bi-hdd-network"></i></span>
                            <input type="text" class="form-control" value="@_servidorSql" readonly />
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label small fw-bold">
                            <i class="bi bi-database text-info me-1"></i>Base de Datos
                        </label>
                        <div class="input-group input-group-sm">
                            <span class="input-group-text"><i class="bi bi-archive"></i></span>
                            <input type="text" class="form-control" value="@_baseDatos" readonly />
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label small fw-bold">
                            <i class="bi bi-person-badge text-success me-1"></i>Usuario SA
                        </label>
                        <div class="input-group input-group-sm">
                            <span class="input-group-text"><i class="bi bi-person-fill-lock"></i></span>
                            <input type="text" class="form-control" value="@_usuarioSa" readonly />
                        </div>
                    </div>

                    <div class="mb-0">
                        <label class="form-label small fw-bold">
                            <i class="bi bi-key text-warning me-1"></i>Contrase√±a SA
                        </label>
                        <div class="input-group input-group-sm">
                            <span class="input-group-text"><i class="bi bi-shield-lock"></i></span>
                            <input type="@(_mostrarPasswordSa ? "text" : "password")" class="form-control" value="@_passwordSa" readonly />
                            <button class="btn btn-outline-secondary" type="button" @onclick="() => _mostrarPasswordSa = !_mostrarPasswordSa">
                                <i class="bi @(_mostrarPasswordSa ? "bi-eye-slash" : "bi-eye")"></i>
                            </button>
                        </div>
                        <div class="form-text text-danger">
                            <i class="bi bi-exclamation-triangle"></i> No comparta esta contrase√±a con personal no autorizado.
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Secci√≥n Configuraci√≥n de Ventas -->
        <div class="col-lg-6 mb-4">
            <div class="card h-100">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0"><i class="bi bi-cart me-2"></i>Configuraci√≥n de Ventas</h5>
                </div>
                <div class="card-body">
                    <p class="text-muted small mb-3">
                        Opciones que afectan el comportamiento del m√≥dulo de ventas.
                    </p>

                    <div class="mb-3">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="agregarProductoAlEscanear" 
                                   @bind="_config.AgregarProductoAlEscanear" />
                            <label class="form-check-label fw-bold" for="agregarProductoAlEscanear">
                                üì¶ Agregar producto autom√°ticamente al escanear c√≥digo de barras
                            </label>
                        </div>
                        <div class="form-text">
                            <i class="bi bi-info-circle"></i> 
                            <strong>Si est√° activo:</strong> Al escanear un c√≥digo de barras, el producto se agrega directamente con cantidad 1.<br />
                            <strong>Si est√° desactivado:</strong> El producto se selecciona en el formulario, permitiendo modificar cantidad, descuento, etc. antes de agregar.
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Botones de acci√≥n -->
    <div class="card">
        <div class="card-body d-flex justify-content-between align-items-center">
            <div class="text-muted small">
                @if (_config.FechaModificacion.HasValue)
                {
                    <span>√öltima modificaci√≥n: @_config.FechaModificacion.Value.ToString("dd/MM/yyyy HH:mm") por @_config.UsuarioModificacion</span>
                }
            </div>
            <div class="d-flex gap-2">
                <button class="btn btn-outline-secondary" @onclick="Cargar">
                    <i class="bi bi-arrow-clockwise me-1"></i> Recargar
                </button>
                <button class="btn btn-success" @onclick="Guardar" disabled="@_guardando">
                    @if (_guardando)
                    {
                        <span class="spinner-border spinner-border-sm me-1"></span>
                    }
                    <i class="bi bi-check-lg me-1"></i> Guardar Cambios
                </button>
            </div>
        </div>
    </div>
</div>

}

</PageProtection>

@code {
    private Models.ConfiguracionSistema _config = new();
    private string? _mensaje;
    private bool _esError;
    private bool _guardando;
    private bool _mostrarPasswordSa = false;
    
    // Control de acceso con contrase√±a SA
    private bool _accesoAutorizado = false;
    private string _passwordIngresada = "";
    private bool _errorPassword = false;
    private bool _mostrarPasswordInput = false;
    
    // Credenciales de BD le√≠das de appsettings.json
    private string _servidorSql = "";
    private string _baseDatos = "";
    private string _usuarioSa = "";
    private string _passwordSa = "";
    
    [CascadingParameter]
    private Task<AuthenticationState> AuthStateTask { get; set; } = default!;
    private string? _usuarioNombre;

    protected override async Task OnInitializedAsync()
    {
        // Obtener usuario actual
        try
        {
            var authState = await AuthStateTask;
            _usuarioNombre = authState.User?.Identity?.Name;
        }
        catch { }
        
        // Leer credenciales de la cadena de conexi√≥n (necesario para verificar password)
        CargarCredencialesBD();
        
        // NO cargar config hasta que se autentique
        // await Cargar(); - Se llama despu√©s de verificar password
    }
    
    private async Task OnKeyPressPassword(KeyboardEventArgs e)
    {
        if (e.Key == "Enter" && !string.IsNullOrEmpty(_passwordIngresada))
        {
            await VerificarPassword();
        }
    }
    
    private async Task VerificarPassword()
    {
        _errorPassword = false;
        
        if (_passwordIngresada == _passwordSa)
        {
            _accesoAutorizado = true;
            await Cargar();
        }
        else
        {
            _errorPassword = true;
            _passwordIngresada = "";
        }
    }
    
    private void VolverAlInicio()
    {
        Nav.NavigateTo("/");
    }
    
    private void CargarCredencialesBD()
    {
        try
        {
            var connectionString = Configuration.GetConnectionString("DefaultConnection") ?? "";
            
            // Parsear la cadena de conexi√≥n
            var builder = new Microsoft.Data.SqlClient.SqlConnectionStringBuilder(connectionString);
            _servidorSql = builder.DataSource;
            _baseDatos = builder.InitialCatalog;
            _usuarioSa = builder.UserID;
            _passwordSa = builder.Password;
        }
        catch (Exception ex)
        {
            _servidorSql = "Error al leer configuraci√≥n";
            Console.WriteLine($"Error leyendo cadena de conexi√≥n: {ex.Message}");
        }
    }

    private async Task Cargar()
    {
        await using var db = await DbFactory.CreateDbContextAsync();
        
        // Asegurar que existe la tabla (crear si no existe)
        try
        {
            await db.Database.ExecuteSqlRawAsync(@"
                IF NOT EXISTS (SELECT * FROM sys.tables WHERE name = 'ConfiguracionSistema')
                BEGIN
                    CREATE TABLE ConfiguracionSistema (
                        IdConfiguracion INT IDENTITY(1,1) PRIMARY KEY,
                        FarmaciaModoActivo BIT NOT NULL DEFAULT 0,
                        FarmaciaValidarPrecioMinisterio BIT NOT NULL DEFAULT 0,
                        FarmaciaMostrarPrecioMinisterio BIT NOT NULL DEFAULT 0,
                        FarmaciaMostrarPrecioMinisterioEnCompras BIT NOT NULL DEFAULT 0,
                        NombreNegocio NVARCHAR(200) NULL,
                        FechaModificacion DATETIME NULL,
                        UsuarioModificacion NVARCHAR(50) NULL
                    );
                    INSERT INTO ConfiguracionSistema (FarmaciaModoActivo) VALUES (0);
                END
            ");
        }
        catch { }
        
        var config = await db.ConfiguracionSistema.FirstOrDefaultAsync();
        if (config == null)
        {
            // Crear registro inicial si no existe
            config = new Models.ConfiguracionSistema();
            db.ConfiguracionSistema.Add(config);
            await db.SaveChangesAsync();
        }
        
        _config = config;
    }

    private async Task Guardar()
    {
        _guardando = true;
        _mensaje = null;
        StateHasChanged();
        
        try
        {
            await using var db = await DbFactory.CreateDbContextAsync();
            
            var configDb = await db.ConfiguracionSistema.FirstOrDefaultAsync();
            if (configDb == null)
            {
                configDb = new Models.ConfiguracionSistema();
                db.ConfiguracionSistema.Add(configDb);
            }
            
            // Actualizar valores - Farmacia
            configDb.FarmaciaModoActivo = _config.FarmaciaModoActivo;
            configDb.FarmaciaValidarPrecioMinisterio = _config.FarmaciaValidarPrecioMinisterio;
            configDb.FarmaciaMostrarPrecioMinisterio = _config.FarmaciaMostrarPrecioMinisterio;
            configDb.FarmaciaMostrarPrecioMinisterioEnCompras = _config.FarmaciaMostrarPrecioMinisterioEnCompras;
            configDb.FarmaciaDescuentoBasadoEnPrecioMinisterio = _config.FarmaciaDescuentoBasadoEnPrecioMinisterio;
            
            // Actualizar valores - Restaurante
            configDb.RestauranteModoActivo = _config.RestauranteModoActivo;
            configDb.RestaurantePermitirDivisionCuenta = _config.RestaurantePermitirDivisionCuenta;
            configDb.RestaurantePermitirPagosParciales = _config.RestaurantePermitirPagosParciales;
            configDb.RestauranteMostrarTiempo = _config.RestauranteMostrarTiempo;
            configDb.RestauranteImprimirComandaAuto = _config.RestauranteImprimirComandaAuto;
            configDb.RestauranteCargoServicio = _config.RestauranteCargoServicio;
            configDb.RestauranteImpresoraCocina = _config.RestauranteImpresoraCocina;
            configDb.RestauranteImpresoraBarra = _config.RestauranteImpresoraBarra;
            configDb.TipoNegocioMesas = _config.TipoNegocioMesas;
            
            // Actualizar valores - Canchas
            configDb.CanchasModoActivo = _config.CanchasModoActivo;
            configDb.ReservasHabilitadas = _config.ReservasHabilitadas;
            configDb.ReservasRecordatorioMinutos = _config.ReservasRecordatorioMinutos;
            
            // Actualizar valores - Gimnasio
            configDb.GimnasioModoActivo = _config.GimnasioModoActivo;
            configDb.GimnasioMensajeBienvenida = _config.GimnasioMensajeBienvenida;
            configDb.GimnasioMensajeDespedida = _config.GimnasioMensajeDespedida;
            configDb.GimnasioMensajeVencimientoProximo = _config.GimnasioMensajeVencimientoProximo;
            configDb.GimnasioMensajeVencido = _config.GimnasioMensajeVencido;
            configDb.GimnasioReconocimientoFacialActivo = _config.GimnasioReconocimientoFacialActivo;
            configDb.GimnasioUmbralCoincidenciaFacial = _config.GimnasioUmbralCoincidenciaFacial;
            configDb.GimnasioDiasGracia = _config.GimnasioDiasGracia;
            configDb.GimnasioPermitirAccesoDiasGracia = _config.GimnasioPermitirAccesoDiasGracia;
            configDb.GimnasioHabilitarVoz = _config.GimnasioHabilitarVoz;
            configDb.GimnasioHorasAutoSalida = _config.GimnasioHorasAutoSalida;
            
            // Actualizar valores - Agenda
            configDb.AgendaModoActivo = _config.AgendaModoActivo;
            configDb.AgendaRecordatorioMinutos = _config.AgendaRecordatorioMinutos;
            configDb.AgendaEnviarRecordatoriosEmail = _config.AgendaEnviarRecordatoriosEmail;
            configDb.AgendaColoresPorCliente = _config.AgendaColoresPorCliente;
            configDb.AgendaMostrarUbicacionGPS = _config.AgendaMostrarUbicacionGPS;
            
            // General
            configDb.NombreNegocio = _config.NombreNegocio;
            configDb.FechaModificacion = DateTime.Now;
            configDb.UsuarioModificacion = _usuarioNombre;
            
            // Ventas - C√≥digo de barras
            configDb.AgregarProductoAlEscanear = _config.AgregarProductoAlEscanear;
            
            await db.SaveChangesAsync();
            
            _config = configDb;
            _mensaje = "‚úÖ Configuraci√≥n guardada correctamente";
            _esError = false;
        }
        catch (Exception ex)
        {
            _mensaje = $"‚ùå Error al guardar: {ex.Message}";
            _esError = true;
        }
        finally
        {
            _guardando = false;
        }
    }

    // M√©todos helper para nombres seg√∫n tipo de negocio
    private string ObtenerNombreModulo() => _config.TipoNegocioMesas switch
    {
        "Taller" => "Taller",
        "Complejo" => "Complejo",
        _ => "Restaurante"
    };

    private string ObtenerNombreEspacios() => _config.TipoNegocioMesas switch
    {
        "Taller" => "Bah√≠as",
        "Complejo" => "Canchas",
        _ => "Mesas"
    };

    private string ObtenerNombreEspacio() => _config.TipoNegocioMesas switch
    {
        "Taller" => "Bah√≠a",
        "Complejo" => "Cancha",
        _ => "Mesa"
    };
}
