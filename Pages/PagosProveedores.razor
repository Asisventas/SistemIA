@page "/pagos-proveedores"
@inject IDbContextFactory<SistemIA.Models.AppDbContext> DbFactory
@inject NavigationManager Nav
@inject IJSRuntime JS
@inject Microsoft.AspNetCore.Components.Authorization.AuthenticationStateProvider AuthStateProvider
@inject PagoProveedorService PagoProveedorSvc
@inject SistemIA.Services.ICajaProvider CajaProvider
@inject SistemIA.Services.ISucursalProvider SucursalProvider
@inject SistemIA.Services.ITrackingService TrackingService
@using Microsoft.EntityFrameworkCore
@using static SistemIA.Models.AsistenteIA.TipoAccionTracking
@using static SistemIA.Models.AsistenteIA.CategoriaAccion
@using SistemIA.Models

<PageProtection Modulo="/pagos" Permiso="VIEW">

<PageTitle>Pagos a Proveedores</PageTitle>

<div class="page-header">
    <div class="d-flex align-items-center gap-3">
        <button class="btn btn-outline-secondary" @onclick="Volver">
            <i class="bi bi-arrow-left"></i>
        </button>
        <h3 class="mb-0">
            <i class="bi bi-cash-coin text-warning me-2"></i>
            Pagos a Proveedores
        </h3>
    </div>
    <div class="text-muted">
        <i class="bi bi-clock me-1"></i>
        Total pendiente: <span class="fw-bold text-danger">@totalPorPagar.ToString("N0") Gs.</span>
    </div>
</div>

<div class="card mb-3 shadow-sm">
    <div class="card-header bg-light">
        <h6 class="mb-0">
            <i class="bi bi-funnel me-2"></i>
            Filtros de Búsqueda
        </h6>
    </div>
    <div class="card-body">
        <div class="row g-3">
            <div class="col-md-4">
                <label class="form-label small text-muted">Proveedor</label>
                <input class="form-control" placeholder="RUC o Razón Social" @bind="filtroProveedor" />
            </div>
            <div class="col-md-3">
                <label class="form-label small text-muted">Estado</label>
                <select class="form-select" @bind="filtroEstado">
                    <option value="">Todos los estados</option>
                    <option value="PENDIENTE">Pendiente</option>
                    <option value="VENCIDO">Vencido</option>
                    <option value="PAGADO">Pagado</option>
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label small text-muted">Acciones</label>
                <div class="d-flex gap-2">
                    <button class="btn btn-primary" @onclick="Buscar">
                        <i class="bi bi-search me-1"></i>Buscar
                    </button>
                    <button class="btn btn-outline-secondary" @onclick="LimpiarFiltros">
                        <i class="bi bi-arrow-clockwise"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="card shadow-sm">
    <div class="card-header bg-white border-bottom">
        <h6 class="mb-0">
            <i class="bi bi-table me-2"></i>
            Cuentas por Pagar
        </h6>
    </div>
    <div class="table-responsive">
        <table class="table table-hover align-middle mb-0">
            <thead class="table-light">
                <tr>
                    <th style="width: 15%">Proveedor</th>
                    <th style="width: 10%">Compra</th>
                    <th style="width: 10%">Fecha Crédito</th>
                    <th class="text-end" style="width: 10%">Monto Total</th>
                    <th class="text-end" style="width: 10%">Saldo Pendiente</th>
                    <th style="width: 10%">Estado</th>
                    <th style="width: 10%">Cuotas</th>
                    <th class="text-end" style="width: 15%">Acciones</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var cuenta in cuentas)
                {
                    <tr>
                        <td>
                            <div class="fw-semibold">@cuenta.ProveedorNombre</div>
                            <div class="text-muted small">@cuenta.ProveedorRuc</div>
                        </td>
                        <td>
                            <span class="badge bg-info">Compra #@cuenta.IdCompra</span>
                        </td>
                        <td>
                            <div>@cuenta.FechaCredito.ToString("dd/MM/yyyy")</div>
                            @if (cuenta.FechaVencimiento.HasValue)
                            {
                                <div class="text-muted small">Vence: @cuenta.FechaVencimiento.Value.ToString("dd/MM/yyyy")</div>
                            }
                        </td>
                        <td class="text-end">
                            <div class="fw-bold">@FormatearPrecio(cuenta.MontoTotal, cuenta.IdMoneda)</div>
                            <div class="text-muted small">@cuenta.MonedaSimbolo</div>
                        </td>
                        <td class="text-end">
                            <div class="fw-bold text-danger">@FormatearPrecio(cuenta.SaldoPendiente, cuenta.IdMoneda)</div>
                            <div class="text-muted small">@cuenta.MonedaSimbolo</div>
                        </td>
                        <td>
                            @if (cuenta.Estado == "PAGADO" || cuenta.Estado == "Pagada")
                            {
                                <span class="badge bg-success">
                                    <i class="bi bi-check-circle me-1"></i>Pagado
                                </span>
                            }
                            else if (cuenta.Estado == "VENCIDO")
                            {
                                <span class="badge bg-danger">
                                    <i class="bi bi-exclamation-triangle me-1"></i>Vencido
                                </span>
                            }
                            else if (cuenta.Estado == "PENDIENTE" || cuenta.Estado == "Abierta")
                            {
                                <span class="badge bg-warning text-dark">
                                    <i class="bi bi-clock me-1"></i>Pendiente
                                </span>
                            }
                            else
                            {
                                <span class="badge bg-secondary">@cuenta.Estado</span>
                            }
                        </td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary" @onclick="() => ToggleCuotas(cuenta.IdCuentaPorPagar)">
                                <i class="bi bi-list-ol me-1"></i>
                                Ver @cuenta.NumeroCuotas
                            </button>
                        </td>
                        <td class="text-end">
                            <button class="btn btn-sm btn-warning" 
                                    disabled="@(cuenta.Estado == "PAGADO" || cuenta.Estado == "Pagada")"
                                    @onclick="() => AbrirModalPago(cuenta)">
                                <i class="bi bi-cash-coin me-1"></i>Pagar
                            </button>
                            <button class="btn btn-sm btn-outline-secondary" 
                                    @onclick="() => VerHistorial(cuenta.IdCompra)">
                                <i class="bi bi-clock-history me-1"></i>Historial
                            </button>
                        </td>
                    </tr>
                    @if (cuotasExpandidas.Contains(cuenta.IdCuentaPorPagar) && cuenta.Cuotas != null)
                    {
                        <tr>
                            <td colspan="8" class="bg-light">
                                <div class="p-3">
                                    <h6 class="mb-3">Detalle de Cuotas</h6>
                                    <table class="table table-sm table-bordered mb-0">
                                        <thead>
                                            <tr>
                                                <th>Cuota #</th>
                                                <th>Vencimiento</th>
                                                <th class="text-end">Monto</th>
                                                <th class="text-end">Saldo</th>
                                                <th>Estado</th>
                                                <th>Fecha Pago</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            @foreach (var cuota in cuenta.Cuotas.OrderBy(c => c.NumeroCuota))
                                            {
                                                <tr class="@(cuota.Estado == "Pagada" ? "table-success" : cuota.FechaVencimiento < DateTime.Today ? "table-danger" : "")">
                                                    <td>Cuota @cuota.NumeroCuota</td>
                                                    <td>@cuota.FechaVencimiento.ToString("dd/MM/yyyy")</td>
                                                    <td class="text-end">@FormatearPrecio(cuota.MontoCuota, cuenta.IdMoneda) @cuenta.MonedaSimbolo</td>
                                                    <td class="text-end">@FormatearPrecio(cuota.SaldoCuota, cuenta.IdMoneda) @cuenta.MonedaSimbolo</td>
                                                    <td>
                                                        <span class="badge bg-@(cuota.Estado == "Pagada" ? "success" : cuota.FechaVencimiento < DateTime.Today ? "danger" : "warning")">
                                                            @(cuota.Estado == "Pagada" ? "PAGADO" : cuota.FechaVencimiento < DateTime.Today ? "VENCIDO" : "PENDIENTE")
                                                        </span>
                                                    </td>
                                                    <td>@(cuota.FechaPago?.ToString("dd/MM/yyyy") ?? "-")</td>
                                                </tr>
                                            }
                                        </tbody>
                                    </table>
                                </div>
                            </td>
                        </tr>
                    }
                }
            </tbody>
        </table>
    </div>
</div>

@* Modal de pago *@
@if (mostrarModalPago && cuentaSeleccionada != null)
{
    <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-warning text-dark">
                    <h5 class="modal-title">
                        <i class="bi bi-cash-coin me-2"></i>
                        Registrar Pago a Proveedor
                    </h5>
                    <button type="button" class="btn-close" @onclick="CerrarModalPago"></button>
                </div>
                <div class="modal-body">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label fw-bold">Proveedor</label>
                            <input class="form-control" value="@cuentaSeleccionada.ProveedorNombre" readonly />
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-bold">Saldo Pendiente</label>
                            <input class="form-control text-danger fw-bold" value="@(FormatearPrecio(cuentaSeleccionada.SaldoPendiente, cuentaSeleccionada.IdMoneda) + " " + ObtenerSimboloMoneda(cuentaSeleccionada.IdMoneda))" readonly />
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-bold">Saldo después del pago</label>
                            <input class="form-control text-info fw-bold" value="@(FormatearPrecio(CalcularSaldoRestante(), cuentaSeleccionada.IdMoneda) + " " + ObtenerSimboloMoneda(cuentaSeleccionada.IdMoneda))" readonly />
                        </div>
                        @if (cuentaSeleccionada.EsMonedaExtranjera || (detallesPago.Any(d => d.IdMoneda != cuentaSeleccionada.IdMoneda && d.IdMoneda != null)))
                        {
                            <div class="col-md-6">
                                <label class="form-label fw-bold">Tipo de Cambio</label>
                                <div class="input-group">
                                    <span class="input-group-text">@(Monedas.FirstOrDefault(m => m.EsMonedaBase)?.Simbolo ?? "Gs.")</span>
                                    <input type="number" step="0.01" class="form-control" @bind="tipoCambioPago" @bind:after="OnTipoCambioChanged" />
                                </div>
                                <small class="text-muted">TC del día: @tipoCambioDia.ToString("N2")</small>
                            </div>
                        }
                        <div class="col-12">
                            <hr />
                            <h6 class="mb-3">Caja y Medios de Pago</h6>
                        </div>
                        <!-- Fecha del Pago -->
                        <div class="col-md-6">
                            <label class="form-label fw-bold">
                                <i class="bi bi-calendar-event me-1"></i>Fecha del Pago
                            </label>
                            <input type="date" class="form-control" @bind="fechaPago" />
                        </div>
                        <!-- Selector de Caja -->
                        <div class="col-md-6">
                            <label class="form-label fw-bold">
                                <i class="bi bi-cash-stack me-1"></i>Caja
                            </label>
                            <select class="form-select" value="@cajaSeleccionadaId" @onchange="OnCajaSeleccionadaChanged">
                                <option value="0">-- Sin caja (no afecta resumen) --</option>
                                @foreach (var caja in CajasDisponibles)
                                {
                                    <option value="@caja.IdCaja">Caja @caja.IdCaja @(caja.CajaActual == 1 ? "(Activa)" : "")</option>
                                }
                            </select>
                            @if (!afectaCaja)
                            {
                                <small class="text-warning"><i class="bi bi-exclamation-triangle"></i> Este pago no afectará el resumen de caja</small>
                            }
                        </div>
                        <!-- Selector de Turno -->
                        @if (afectaCaja && CajaActiva?.CantTurnos > 0)
                        {
                            <div class="col-md-6">
                                <label class="form-label fw-bold">
                                    <i class="bi bi-clock-history me-1"></i>Turno
                                </label>
                                <select class="form-select" @bind="turnoSeleccionado">
                                    @for (int t = 1; t <= (CajaActiva?.CantTurnos ?? 1); t++)
                                    {
                                        <option value="@t">Turno @t @(t == CajaActiva?.TurnoActual ? "(Actual)" : "")</option>
                                    }
                                </select>
                            </div>
                        }
                        @for (int i = 0; i < detallesPago.Count; i++)
                        {
                            var detalle = detallesPago[i];
                            var index = i;
                            <div class="col-12">
                                <div class="card mb-2">
                                    <div class="card-body">
                                        <div class="row g-2">
                                            <div class="col-md-3">
                                                <label class="form-label small">Medio de Pago</label>
                                                <select class="form-select form-select-sm" @bind="detalle.MedioPago">
                                                    <option value="EFECTIVO">Efectivo</option>
                                                    <option value="CHEQUE">Cheque</option>
                                                    <option value="TRANSFERENCIA">Transferencia</option>
                                                    <option value="TARJETA">Tarjeta</option>
                                                </select>
                                            </div>
                                            <div class="col-md-3">
                                                <label class="form-label small">Monto</label>
                                                <input type="number" class="form-control form-control-sm" @bind="detalle.Monto" @bind:after="StateHasChanged" />
                                            </div>
                                            <div class="col-md-3">
                                                <label class="form-label small">Moneda</label>
                                                <select class="form-select form-select-sm" @bind="detalle.IdMoneda" @bind:after="@(async () => { await CargarTipoCambioSiNecesario(); StateHasChanged(); })">
                                                    @foreach (var mon in Monedas)
                                                    {
                                                        <option value="@mon.IdMoneda">@mon.Nombre (@mon.Simbolo)</option>
                                                    }
                                                </select>
                                            </div>
                                            @if (detalle.MedioPago == "CHEQUE")
                                            {
                                                <div class="col-md-3">
                                                    <label class="form-label small">Nro. Cheque</label>
                                                    <input class="form-control form-control-sm" @bind="detalle.NumeroCheque" />
                                                </div>
                                                <div class="col-md-2">
                                                    <label class="form-label small">Banco</label>
                                                    <input class="form-control form-control-sm" @bind="detalle.BancoCheque" />
                                                </div>
                                            }
                                            else if (detalle.MedioPago == "TRANSFERENCIA")
                                            {
                                                <div class="col-md-5">
                                                    <label class="form-label small">Nro. Transacción</label>
                                                    <input class="form-control form-control-sm" @bind="detalle.NumeroTransferencia" />
                                                </div>
                                            }
                                            else if (detalle.MedioPago == "TARJETA")
                                            {
                                                <div class="col-md-3">
                                                    <label class="form-label small">Banco/Tarjeta</label>
                                                    <input class="form-control form-control-sm" @bind="detalle.BancoTarjeta" />
                                                </div>
                                                <div class="col-md-2">
                                                    <label class="form-label small">Últimos 4</label>
                                                    <input class="form-control form-control-sm" maxlength="4" @bind="detalle.Ultimos4Tarjeta" />
                                                </div>
                                            }
                                            <div class="col-md-1 d-flex align-items-end">
                                                @if (detallesPago.Count > 1)
                                                {
                                                    <button type="button" class="btn btn-sm btn-outline-danger" @onclick="() => EliminarDetalle(index)">
                                                        <i class="bi bi-trash"></i>
                                                    </button>
                                                }
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        }
                        <div class="col-12">
                            <button type="button" class="btn btn-sm btn-outline-primary" @onclick="AgregarDetalle">
                                <i class="bi bi-plus-circle me-1"></i>Agregar medio de pago
                            </button>
                        </div>
                        <div class="col-12">
                            <hr />
                            <div class="alert alert-info">
                                @if (detallesPago.Any(d => d.IdMoneda != cuentaSeleccionada.IdMoneda))
                                {
                                    var simboloCuenta = ObtenerSimboloMoneda(cuentaSeleccionada.IdMoneda);
                                    var totalConvertido = CalcularTotalPagoConvertido();
                                    <div class="mb-2">
                                        <strong>Detalles del pago:</strong>
                                        <ul class="mb-0">
                                            @foreach (var det in detallesPago.Where(d => d.Monto > 0))
                                            {
                                                var simboloPago = ObtenerSimboloMoneda(det.IdMoneda);
                                                <li>@det.MedioPago: @FormatearPrecio(det.Monto, det.IdMoneda) @simboloPago</li>
                                            }
                                        </ul>
                                    </div>
                                    <div class="mt-2 pt-2 border-top">
                                        <strong>Total convertido a @simboloCuenta:</strong>
                                        <span class="text-success fw-bold ms-1">@FormatearPrecio(totalConvertido, cuentaSeleccionada.IdMoneda) @simboloCuenta</span>
                                        @if (tipoCambioPago.HasValue)
                                        {
                                            <span class="text-muted ms-2">(TC: @tipoCambioPago.Value.ToString("N2"))</span>
                                        }
                                    </div>
                                }
                                else
                                {
                                    var simboloCuenta = ObtenerSimboloMoneda(cuentaSeleccionada.IdMoneda);
                                    <strong>Total a pagar:</strong>
                                    <span class="text-success fw-bold ms-1">@FormatearPrecio(CalcularTotalPago(), cuentaSeleccionada.IdMoneda) @simboloCuenta</span>
                                }
                            </div>
                        </div>
                        <div class="col-12">
                            <label class="form-label">Observaciones</label>
                            <textarea class="form-control" rows="2" @bind="observacionesPago"></textarea>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="CerrarModalPago">Cancelar</button>
                    <button type="button" class="btn btn-warning" @onclick="ConfirmarPago">
                        <i class="bi bi-check-circle me-1"></i>Confirmar Pago
                    </button>
                </div>
            </div>
        </div>
    </div>
}

</PageProtection>

@code {
    private string filtroProveedor = string.Empty;
    private string filtroEstado = string.Empty;
    private List<CuentaDto> cuentas = new();
    private decimal totalPorPagar = 0;
    private HashSet<int> cuotasExpandidas = new();

    private void Volver()
    {
        Nav.NavigateTo("/compras/explorar");
    }
    
    // Modal de pago
    private bool mostrarModalPago = false;
    private CuentaDto? cuentaSeleccionada = null;
    private List<DetallePagoDto> detallesPago = new();
    private string observacionesPago = string.Empty;
    
    // Monedas y tipos de cambio
    private List<Moneda> Monedas = new();
    private decimal? tipoCambioPago = null;
    private decimal tipoCambioDia = 1m;
    
    // Caja y Sucursal
    private SistemIA.Models.Caja? CajaActiva;
    private int? _sucursalId;
    private List<SistemIA.Models.Caja> CajasDisponibles = new();
    private int? cajaSeleccionadaId;
    private bool afectaCaja = true;
    private DateTime fechaPago = DateTime.Now;
    private int? turnoSeleccionado;

    protected override async Task OnInitializedAsync()
    {
        _sucursalId = SucursalProvider.GetSucursalId();
        await CargarCajasDisponiblesAsync();
        
        var cajaId = CajaProvider.GetCajaId();
        if (cajaId.HasValue)
        {
            CajaActiva = CajasDisponibles.FirstOrDefault(c => c.IdCaja == cajaId.Value);
        }
        if (CajaActiva == null)
        {
            CajaActiva = CajasDisponibles.FirstOrDefault(c => c.CajaActual == 1) 
                      ?? CajasDisponibles.FirstOrDefault();
        }
        cajaSeleccionadaId = CajaActiva?.IdCaja;
        
        if (CajaActiva?.FechaActualCaja.HasValue == true)
        {
            fechaPago = CajaActiva.FechaActualCaja.Value;
        }
        
        turnoSeleccionado = CajaActiva?.TurnoActual ?? 1;
        
        await CargarMonedasAsync();
        await Buscar();
    }
    
    private async Task CargarCajasDisponiblesAsync()
    {
        await using var ctx = await DbFactory.CreateDbContextAsync();
        var query = ctx.Cajas.AsNoTracking().AsQueryable();
        
        if (_sucursalId.HasValue)
        {
            query = query.Where(c => c.IdSucursal == _sucursalId.Value || c.IdSucursal == null);
        }
        
        CajasDisponibles = await query.OrderBy(c => c.IdCaja).ToListAsync();
    }
    
    private void OnCajaSeleccionadaChanged(ChangeEventArgs e)
    {
        if (int.TryParse(e.Value?.ToString(), out var id) && id > 0)
        {
            cajaSeleccionadaId = id;
            CajaActiva = CajasDisponibles.FirstOrDefault(c => c.IdCaja == id);
            afectaCaja = true;
            if (CajaActiva?.FechaActualCaja.HasValue == true)
            {
                fechaPago = CajaActiva.FechaActualCaja.Value;
            }
            turnoSeleccionado = CajaActiva?.TurnoActual ?? 1;
        }
        else
        {
            cajaSeleccionadaId = null;
            CajaActiva = null;
            afectaCaja = false;
            fechaPago = DateTime.Now;
            turnoSeleccionado = null;
        }
    }
    
    private async Task CargarMonedasAsync()
    {
        await using var ctx = await DbFactory.CreateDbContextAsync();
        Monedas = await ctx.Monedas.Where(m => m.Estado).OrderBy(m => m.Nombre).ToListAsync();
    }

    private async Task Buscar()
    {
        await using var ctx = await DbFactory.CreateDbContextAsync();
        
        // Obtener cuentas por pagar con cuotas
        var queryCuentas = ctx.CuentasPorPagar
            .Include(c => c.Compra)
                .ThenInclude(c => c!.Proveedor)
            .Include(c => c.Compra)
                .ThenInclude(c => c!.Moneda)
            .Include(c => c.Cuotas)
            .AsNoTracking()
            .Where(c => c.Estado != "Anulada");

        if (!string.IsNullOrWhiteSpace(filtroProveedor))
        {
            queryCuentas = queryCuentas.Where(c => c.Compra!.Proveedor!.RazonSocial.Contains(filtroProveedor) || 
                                                   c.Compra.Proveedor.RUC.Contains(filtroProveedor));
        }

        if (!string.IsNullOrWhiteSpace(filtroEstado))
        {
            if (filtroEstado == "PENDIENTE")
                queryCuentas = queryCuentas.Where(c => c.Estado == "Abierta" || c.Estado == "PENDIENTE");
            else if (filtroEstado == "PAGADO")
                queryCuentas = queryCuentas.Where(c => c.Estado == "Pagada" || c.Estado == "PAGADO");
            else
                queryCuentas = queryCuentas.Where(c => c.Estado == filtroEstado);
        }

        var datosCuentas = await queryCuentas.OrderByDescending(c => c.FechaCredito).ToListAsync();
        
        // También obtener compras a crédito sin cuenta por pagar (para compatibilidad)
        var comprasConCuenta = datosCuentas.Where(c => c.IdCompra > 0).Select(c => c.IdCompra).ToHashSet();
        
        var comprasSinCuenta = await ctx.Compras
            .Include(c => c.Proveedor)
            .Include(c => c.Moneda)
            .Include(c => c.TipoPago)
            .Where(c => c.Estado == "Confirmado" 
                && c.IdTipoPago.HasValue 
                && c.TipoPago!.EsCredito == true
                && !comprasConCuenta.Contains(c.IdCompra))
            .ToListAsync();

        // Obtener pagos realizados para calcular saldos de compras sin cuenta
        var idComprasSinCuenta = comprasSinCuenta.Select(c => c.IdCompra).ToList();
        var pagosRealizados = await ctx.PagosProveedores
            .Where(p => idComprasSinCuenta.Contains(p.IdCompra) && p.Estado == "Pagado")
            .GroupBy(p => p.IdCompra)
            .Select(g => new { IdCompra = g.Key, TotalPagado = g.Sum(p => p.MontoTotal) })
            .ToDictionaryAsync(x => x.IdCompra, x => x.TotalPagado);

        cuentas = new List<CuentaDto>();

        // Agregar cuentas por pagar
        foreach (var c in datosCuentas)
        {
            var moneda = c.Compra?.Moneda ?? Monedas.FirstOrDefault(m => m.EsMonedaBase);
            var simbolo = moneda?.Simbolo ?? "Gs.";
            
            cuentas.Add(new CuentaDto
            {
                IdCuentaPorPagar = c.IdCuentaPorPagar,
                IdCompra = c.IdCompra,
                IdProveedor = c.Compra?.IdProveedor ?? c.IdProveedor,
                ProveedorNombre = c.Compra?.Proveedor?.RazonSocial ?? "",
                ProveedorRuc = c.Compra?.Proveedor?.RUC ?? "",
                FechaCredito = c.FechaCredito,
                FechaVencimiento = c.FechaVencimiento,
                MontoTotal = c.MontoTotal,
                SaldoPendiente = c.SaldoPendiente,
                NumeroCuotas = c.Cuotas?.Count ?? 0,
                Estado = c.Estado,
                IdMoneda = c.Compra?.IdMoneda,
                MonedaSimbolo = simbolo,
                EsMonedaExtranjera = moneda != null && !moneda.EsMonedaBase,
                Cuotas = c.Cuotas?.ToList()
            });
        }

        // Agregar compras sin cuenta por pagar (saldo calculado)
        foreach (var compra in comprasSinCuenta)
        {
            var pagado = pagosRealizados.GetValueOrDefault(compra.IdCompra, 0);
            var saldo = compra.Total - pagado;
            if (saldo <= 0) continue; // Ya está pagada
            
            var moneda = compra.Moneda ?? Monedas.FirstOrDefault(m => m.EsMonedaBase);
            var simbolo = moneda?.Simbolo ?? "Gs.";
            
            cuentas.Add(new CuentaDto
            {
                IdCuentaPorPagar = 0, // Sin cuenta formal
                IdCompra = compra.IdCompra,
                IdProveedor = compra.IdProveedor,
                ProveedorNombre = compra.Proveedor?.RazonSocial ?? "",
                ProveedorRuc = compra.Proveedor?.RUC ?? "",
                FechaCredito = compra.Fecha,
                FechaVencimiento = compra.FechaVencimiento,
                MontoTotal = compra.Total,
                SaldoPendiente = saldo,
                NumeroCuotas = 0,
                Estado = "Abierta",
                IdMoneda = compra.IdMoneda,
                MonedaSimbolo = simbolo,
                EsMonedaExtranjera = moneda != null && !moneda.EsMonedaBase,
                Cuotas = null
            });
        }

        // Ordenar todas las cuentas por fecha de crédito descendente (más recientes primero)
        cuentas = cuentas.OrderByDescending(c => c.FechaCredito)
                         .ThenByDescending(c => c.IdCompra)
                         .ToList();

        totalPorPagar = cuentas.Where(c => c.Estado != "PAGADO" && c.Estado != "Pagada").Sum(c => c.SaldoPendiente);
        StateHasChanged();
    }

    private void LimpiarFiltros()
    {
        filtroProveedor = string.Empty;
        filtroEstado = string.Empty;
    }

    private void ToggleCuotas(int idCuenta)
    {
        if (cuotasExpandidas.Contains(idCuenta))
            cuotasExpandidas.Remove(idCuenta);
        else
            cuotasExpandidas.Add(idCuenta);
    }

    private async Task AbrirModalPago(CuentaDto cuenta)
    {
        cuentaSeleccionada = cuenta;
        
        var idMonedaPago = cuenta.IdMoneda ?? Monedas.FirstOrDefault(m => m.EsMonedaBase)?.IdMoneda;
        
        detallesPago = new List<DetallePagoDto>
        {
            new DetallePagoDto 
            { 
                MedioPago = "EFECTIVO", 
                Monto = cuenta.SaldoPendiente,
                IdMoneda = idMonedaPago
            }
        };
        
        await CargarTipoCambioDelDiaAsync();
        
        observacionesPago = string.Empty;
        mostrarModalPago = true;
    }
    
    private async Task CargarTipoCambioDelDiaAsync()
    {
        if (cuentaSeleccionada == null)
        {
            tipoCambioPago = null;
            tipoCambioDia = 1m;
            return;
        }

        await using var ctx = await DbFactory.CreateDbContextAsync();
        var monedaBase = Monedas.FirstOrDefault(m => m.EsMonedaBase);
        var monedaExtranjera = Monedas.FirstOrDefault(m => !m.EsMonedaBase);
        
        if (monedaBase == null || monedaExtranjera == null) 
        {
            tipoCambioDia = 1m;
            tipoCambioPago = 1m;
            return;
        }

        var tc = await ctx.TiposCambio
            .Where(t => t.IdMonedaOrigen == monedaExtranjera.IdMoneda
                     && t.IdMonedaDestino == monedaBase.IdMoneda
                     && t.Estado
                     && t.FechaTipoCambio.Date == DateTime.Today)
            .OrderByDescending(t => t.FechaCreacion)
            .FirstOrDefaultAsync();

        tipoCambioDia = tc?.TasaCompra ?? tc?.TasaCambio ?? 1m;
        tipoCambioPago = tipoCambioDia;
    }
    
    private async Task CargarTipoCambioSiNecesario()
    {
        if (cuentaSeleccionada != null && detallesPago.Any(d => d.IdMoneda != cuentaSeleccionada.IdMoneda && d.IdMoneda != null))
        {
            await CargarTipoCambioDelDiaAsync();
        }
    }

    private void CerrarModalPago()
    {
        mostrarModalPago = false;
        cuentaSeleccionada = null;
        detallesPago.Clear();
    }

    private void AgregarDetalle()
    {
        var idMonedaDefault = cuentaSeleccionada?.IdMoneda ?? Monedas.FirstOrDefault(m => m.EsMonedaBase)?.IdMoneda;
        detallesPago.Add(new DetallePagoDto 
        { 
            MedioPago = "EFECTIVO", 
            Monto = 0,
            IdMoneda = idMonedaDefault
        });
    }

    private void EliminarDetalle(int index)
    {
        detallesPago.RemoveAt(index);
    }

    private decimal CalcularTotalPago()
    {
        return detallesPago.Sum(d => d.Monto);
    }
    
    private decimal CalcularSaldoRestante()
    {
        if (cuentaSeleccionada == null) return 0;
        
        var totalPagado = detallesPago.All(d => d.IdMoneda == cuentaSeleccionada.IdMoneda)
            ? CalcularTotalPago()
            : CalcularTotalPagoConvertido();
        
        return Math.Max(0, cuentaSeleccionada.SaldoPendiente - totalPagado);
    }

    private async Task ConfirmarPago()
    {
        if (cuentaSeleccionada == null) return;

        var totalPago = (detallesPago.All(d => d.IdMoneda == cuentaSeleccionada.IdMoneda))
            ? CalcularTotalPago()
            : CalcularTotalPagoConvertido();
        if (totalPago <= 0)
        {
            await JS.InvokeVoidAsync("alert", "El monto a pagar debe ser mayor a cero");
            return;
        }

        if (totalPago > cuentaSeleccionada.SaldoPendiente)
        {
            var confirmar = await JS.InvokeAsync<bool>("confirm", 
                $"El monto a pagar ({FormatearPrecio(totalPago, cuentaSeleccionada.IdMoneda)}) es mayor al saldo pendiente ({FormatearPrecio(cuentaSeleccionada.SaldoPendiente, cuentaSeleccionada.IdMoneda)}). ¿Desea continuar?");
            if (!confirmar) return;
        }

        try
        {
            await using var ctx = await DbFactory.CreateDbContextAsync();
            var auth = await AuthStateProvider.GetAuthenticationStateAsync();
            var username = auth.User?.Identity?.Name;
            var usuario = await ctx.Usuarios.FirstOrDefaultAsync(u => u.UsuarioNombre == username);

            var pago = new PagoProveedor
            {
                IdCompra = cuentaSeleccionada.IdCompra,
                IdProveedor = cuentaSeleccionada.IdProveedor,
                IdSucursal = _sucursalId ?? 1,
                IdMoneda = cuentaSeleccionada.IdMoneda ?? 1,
                IdCaja = afectaCaja ? cajaSeleccionadaId : null,
                Turno = afectaCaja ? turnoSeleccionado : null,
                IdUsuario = usuario?.Id_Usu ?? 1,
                FechaPago = fechaPago,
                MontoTotal = totalPago,
                CambioDelDia = tipoCambioPago ?? tipoCambioDia,
                Estado = "Pagado",
                NumeroRecibo = await GenerarNumeroRecibo(ctx),
                Observaciones = observacionesPago
            };

            var detalles = detallesPago
                .Where(d => d.Monto > 0)
                .Select(d => new PagoProveedorDetalle
                {
                    MedioPago = d.MedioPago,
                    Monto = d.Monto,
                    CambioDelDia = tipoCambioPago ?? tipoCambioDia,
                    NumeroCheque = d.NumeroCheque,
                    BancoCheque = d.BancoCheque,
                    BancoTransferencia = d.BancoTransferencia,
                    NumeroTransferencia = d.NumeroTransferencia,
                    BancoTarjeta = d.BancoTarjeta,
                    Ultimos4Tarjeta = d.Ultimos4Tarjeta
                }).ToList();

            await PagoProveedorSvc.RegistrarPagoAsync(pago, detalles);
            
            // Actualizar cuotas si existe cuenta por pagar
            if (cuentaSeleccionada.IdCuentaPorPagar > 0)
            {
                await ActualizarCuotasPagadasAsync(ctx, pago, cuentaSeleccionada.IdCuentaPorPagar);
            }
            
            // Actualizar estado de la compra si quedó pagada
            var saldoRestante = cuentaSeleccionada.SaldoPendiente - totalPago;
            if (saldoRestante <= 0)
            {
                var compra = await ctx.Compras.FindAsync(cuentaSeleccionada.IdCompra);
                if (compra != null)
                {
                    compra.Estado = "Pagada";
                    await ctx.SaveChangesAsync();
                }
            }

            var imprimirA4 = await JS.InvokeAsync<bool>("confirm", 
                $"✅ Pago registrado exitosamente.\nRecibo: {pago.NumeroRecibo}\nSaldo restante: {FormatearPrecio(Math.Max(0, saldoRestante), cuentaSeleccionada.IdMoneda)}\n\n¿Desea imprimir en formato A4?\n\n• Aceptar = Comprobante A4\n• Cancelar = Recibo térmico");
            
            // Registrar acción para tracking IA
            _ = TrackingService.RegistrarOperacionAsync(
                tipoAccion: Creacion,
                categoria: "Pagos",
                descripcion: $"Pago {pago.NumeroRecibo} - {FormatearPrecio(totalPago, cuentaSeleccionada.IdMoneda)} {ObtenerSimboloMoneda(cuentaSeleccionada.IdMoneda)}",
                entidadId: pago.IdPagoProveedor,
                entidadTipo: "PagoProveedor",
                datos: new { Proveedor = cuentaSeleccionada.ProveedorNombre, IdCompra = cuentaSeleccionada.IdCompra });
            
            var url = imprimirA4 
                ? $"/pagos-proveedores/comprobante-a4/{pago.IdPagoProveedor}"
                : $"/pagos-proveedores/recibo/{pago.IdPagoProveedor}";
            await JS.InvokeVoidAsync("open", url, "_blank");

            CerrarModalPago();
            await Buscar();
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("alert", $"Error al registrar el pago: {ex.Message}");
            
            // Registrar error para tracking IA
            _ = TrackingService.RegistrarErrorAsync(
                descripcion: $"Error al registrar pago proveedor: {ex.Message}",
                mensajeError: ex.Message,
                stackTrace: ex.StackTrace,
                componente: "PagosProveedores");
        }
    }

    private async Task<string> GenerarNumeroRecibo(AppDbContext ctx)
    {
        var ultimoPago = await ctx.PagosProveedores
            .OrderByDescending(p => p.IdPagoProveedor)
            .FirstOrDefaultAsync();
        
        var numero = (ultimoPago?.IdPagoProveedor ?? 0) + 1;
        return $"OP-{numero:D6}";
    }
    
    private async Task ActualizarCuotasPagadasAsync(AppDbContext _, PagoProveedor pago, int idCuentaPorPagar)
    {
        await using var ctx = await DbFactory.CreateDbContextAsync();
        
        var cuotas = await ctx.CuentasPorPagarCuotas
            .Where(c => c.IdCuentaPorPagar == idCuentaPorPagar && c.Estado != "Pagada" && c.SaldoCuota > 0)
            .OrderBy(c => c.NumeroCuota)
            .ToListAsync();
        
        var montoRestante = pago.MontoTotal;
        foreach (var cuota in cuotas)
        {
            if (montoRestante <= 0) break;
            
            if (montoRestante >= cuota.SaldoCuota)
            {
                montoRestante -= cuota.SaldoCuota;
                cuota.SaldoCuota = 0;
                cuota.Estado = "Pagada";
                cuota.FechaPago = pago.FechaPago;
            }
            else
            {
                cuota.SaldoCuota -= montoRestante;
                cuota.Estado = "Parcial";
                montoRestante = 0;
            }
        }
        
        var cuenta = await ctx.CuentasPorPagar.FindAsync(idCuentaPorPagar);
        if (cuenta != null)
        {
            cuenta.SaldoPendiente = Math.Max(0, cuenta.SaldoPendiente - pago.MontoTotal);
            
            var cuotasPendientes = await ctx.CuentasPorPagarCuotas
                .Where(c => c.IdCuentaPorPagar == cuenta.IdCuentaPorPagar && c.SaldoCuota > 0)
                .CountAsync();
            
            if (cuotasPendientes == 0)
            {
                cuenta.Estado = "Pagada";
            }
        }
        
        await ctx.SaveChangesAsync();
    }

    private void VerHistorial(int idCompra)
    {
        Nav.NavigateTo($"/pagos-proveedores/historial/{idCompra}");
    }

    private string FormatearPrecio(decimal valor, int? idMoneda)
    {
        if (idMoneda.HasValue)
        {
            var mon = Monedas.FirstOrDefault(m => m.IdMoneda == idMoneda.Value);
            if (mon != null && !mon.EsMonedaBase)
                return valor.ToString("N2");
        }
        return valor.ToString("N0");
    }
    
    private string ObtenerSimboloMoneda(int? idMoneda)
    {
        if (!idMoneda.HasValue) return "Gs.";
        var mon = Monedas.FirstOrDefault(m => m.IdMoneda == idMoneda.Value);
        if (mon != null) return mon.Simbolo ?? "$";
        
        var monedaExtranjera = Monedas.FirstOrDefault(m => !m.EsMonedaBase);
        var monedaBase = Monedas.FirstOrDefault(m => m.EsMonedaBase);
        
        if (monedaBase != null && idMoneda.Value != monedaBase.IdMoneda)
            return monedaExtranjera?.Simbolo ?? "$";
        
        return monedaBase?.Simbolo ?? "Gs.";
    }

    private void OnTipoCambioChanged()
    {
        StateHasChanged();
    }

    private decimal CalcularTotalPagoConvertido()
    {
        if (cuentaSeleccionada == null) return 0;
        if (detallesPago.All(d => d.IdMoneda == cuentaSeleccionada.IdMoneda))
            return CalcularTotalPago();
        
        decimal total = 0;
        foreach (var det in detallesPago)
        {
            if (det.IdMoneda == cuentaSeleccionada.IdMoneda)
            {
                total += det.Monto;
            }
            else
            {
                var monCuenta = Monedas.FirstOrDefault(m => m.IdMoneda == cuentaSeleccionada.IdMoneda);
                var monPago = Monedas.FirstOrDefault(m => m.IdMoneda == det.IdMoneda);
                if (monCuenta != null && monPago != null && tipoCambioPago.HasValue)
                {
                    if (!monCuenta.EsMonedaBase && monPago.EsMonedaBase)
                    {
                        total += Math.Round(det.Monto / tipoCambioPago.Value, 4);
                    }
                    else if (monCuenta.EsMonedaBase && !monPago.EsMonedaBase)
                    {
                        total += Math.Round(det.Monto * tipoCambioPago.Value, 0);
                    }
                    else
                    {
                        total += det.Monto;
                    }
                }
                else
                {
                    total += det.Monto;
                }
            }
        }
        return total;
    }

    // DTOs
    private class CuentaDto
    {
        public int IdCuentaPorPagar { get; set; }
        public int IdCompra { get; set; }
        public int IdProveedor { get; set; }
        public string ProveedorNombre { get; set; } = string.Empty;
        public string ProveedorRuc { get; set; } = string.Empty;
        public DateTime FechaCredito { get; set; }
        public DateTime? FechaVencimiento { get; set; }
        public decimal MontoTotal { get; set; }
        public decimal SaldoPendiente { get; set; }
        public int NumeroCuotas { get; set; }
        public string Estado { get; set; } = string.Empty;
        public int? IdMoneda { get; set; }
        public string? MonedaSimbolo { get; set; }
        public bool EsMonedaExtranjera { get; set; }
        public List<CuentaPorPagarCuota>? Cuotas { get; set; }
    }

    private class DetallePagoDto
    {
        public string MedioPago { get; set; } = "EFECTIVO";
        public decimal Monto { get; set; }
        public int? IdMoneda { get; set; }
        public string? BancoTarjeta { get; set; }
        public string? Ultimos4Tarjeta { get; set; }
        public string? NumeroCheque { get; set; }
        public string? BancoCheque { get; set; }
        public string? BancoTransferencia { get; set; }
        public string? NumeroTransferencia { get; set; }
    }
}
