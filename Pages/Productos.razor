@page "/productos"
@inject IDbContextFactory<AppDbContext> DbFactory
@inject IJSRuntime JS
@inject IWebHostEnvironment Env
@using Microsoft.AspNetCore.Components.Forms
@using Microsoft.EntityFrameworkCore
@using System.Linq
@using System.IO
@using Models = SistemIA.Models
@using Microsoft.AspNetCore.Components.Web
@inject SistemIA.Services.IInventarioService Inventario

<PageProtection Modulo="/inventario" Permiso="VIEW">

<div class="container-fluid">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2 class="text-primary mb-0"><i class="bi bi-box-seam me-2"></i>Productos</h2>
    <div class="d-flex gap-2">
      <button class="btn btn-primary" @onclick="NuevoProducto"><i class="bi bi-plus-circle me-2"></i>Nuevo</button>
      <button class="btn btn-success" @onclick="Cargar"><i class="bi bi-arrow-clockwise me-2"></i>Actualizar</button>
    </div>
  </div>

  <div class="card mb-3">
    <div class="card-header">Filtros</div>
    <div class="card-body">
      <div class="row g-2">
        <div class="col-md-3"><input class="form-control" placeholder="Buscar por descripci√≥n o c√≥digo" @bind="filtro" @bind:after="Filtrar" /></div>
        <div class="col-md-2">
          <select class="form-select" @bind="filtroDeposito" @bind:after="Filtrar">
            <option value="">Todos los dep√≥sitos</option>
            @foreach (var dep in depositos)
            {
              <option value="@dep.IdDeposito">@dep.Nombre</option>
            }
          </select>
        </div>
        <div class="col-md-2">
          <select class="form-select" @bind="filtroIva" @bind:after="Filtrar">
            <option value="">Todos los IVA</option>
            @foreach (var iva in tiposIva)
            {
              <option value="@iva.IdTipoIva">@iva.DescripcionCompleta</option>
            }
          </select>
        </div>
        <div class="col-md-2">
          <select class="form-select" @bind="soloActivos" @bind:after="Filtrar">
            <option value="true">Activos</option>
            <option value="false">Todos</option>
          </select>
        </div>
        <div class="col-md-3 text-end"><span class="badge bg-primary">@filtrados.Count registro(s)</span></div>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="table-responsive">
      <table class="table table-hover align-middle mb-0 productos-table">
        <thead class="table-dark">
          <tr>
            <th class="col-foto" style="width:64px">Foto</th>
            <th class="col-codigo">C√≥digo</th>
            <th class="col-descripcion">Descripci√≥n</th>
            <th class="col-unidad">Unidad</th>
            <th class="col-iva">IVA</th>
            <th class="col-costo text-end">Costo Gs</th>
            <th class="col-precio text-end">Precio Gs</th>
            @if (MostrarPrecioMinisterio)
            {
              <th class="col-pmin text-end">P.Min.</th>
            }
            <th class="col-stock text-end">Stock</th>
            <th class="col-marca">Marca</th>
            <th class="col-sucursal">Sucursal</th>
            <th class="col-vencimiento">Vencimiento</th>
            <th class="col-estado">Estado</th>
            <th class="col-acciones" style="width:120px">Acciones</th>
          </tr>
        </thead>
        <tbody>
          @foreach (var p in filtrados.Take(100))
          {
            <tr>
              <td class="col-foto">
                <img src="@(string.IsNullOrWhiteSpace(p.Foto) ? "/images/placeholder-product.svg" : p.Foto)" alt="img" style="width:48px;height:48px;object-fit:cover;border-radius:6px;border:1px solid #ddd" />
              </td>
              <td class="col-codigo"><span class="badge bg-secondary">@p.CodigoInterno</span></td>
              <td class="col-descripcion">
                <strong>@p.Descripcion</strong>
                @if (!string.IsNullOrWhiteSpace(p.CodigoBarras))
                {
                  <div class="text-muted small">C√≥digo de barras: @p.CodigoBarras</div>
                }
              </td>
              <td class="col-unidad">@p.UnidadMedidaCodigo</td>
              <td class="col-iva">@p.TipoIva?.DescripcionCompleta</td>
              <td class="col-costo text-end">@(p.CostoUnitarioGs.HasValue ? p.CostoUnitarioGs.Value.ToString("N0") : "-")</td>
        <td class="col-precio text-end">@p.PrecioUnitarioGs.ToString("N0")</td>
        @if (MostrarPrecioMinisterio)
        {
          <td class="col-pmin text-end">@(p.PrecioMinisterio?.ToString("N0") ?? "‚Äî")</td>
        }
        <td class="col-stock text-end">
          @{
            var stocksDeposito = stocksPorProductoDeposito.ContainsKey(p.IdProducto) ? stocksPorProductoDeposito[p.IdProducto] : new List<(string Deposito, decimal Stock)>();
            
            // Si hay filtro de dep√≥sito, mostrar solo el stock de ese dep√≥sito
            decimal stockMostrar;
            string tooltip;
            bool mostrarIconoMultiple = false;
            
            if (!string.IsNullOrEmpty(filtroDeposito))
            {
              var depositoSel = depositos.FirstOrDefault(d => d.IdDeposito.ToString() == filtroDeposito);
              var stockDelDeposito = stocksDeposito.FirstOrDefault(s => s.Deposito == depositoSel?.Nombre);
              stockMostrar = stockDelDeposito.Stock;
              tooltip = $"{depositoSel?.Nombre ?? "Dep√≥sito"}: {stockMostrar:N2}";
            }
            else
            {
              stockMostrar = stocksDeposito.Sum(s => s.Stock);
              tooltip = string.Join("\n", stocksDeposito.Where(s => s.Stock != 0).Select(s => $"{s.Deposito}: {s.Stock:N2}"));
              mostrarIconoMultiple = stocksDeposito.Count(s => s.Stock > 0) > 1;
            }
          }
          <span class="@(stockMostrar < p.StockMinimo ? "text-danger fw-semibold" : stockMostrar == 0 ? "text-muted" : null)" 
                title="@tooltip" 
                style="cursor: help;">
            @stockMostrar.ToString("N2")
            @if (mostrarIconoMultiple)
            {
              <i class="bi bi-info-circle-fill text-info ms-1" style="font-size: 0.8em;"></i>
            }
          </span>
        </td>
              <td class="col-marca">@p.Marca?.NombreMarca</td>
              <td class="col-sucursal">@p.Sucursal?.NombreSucursal</td>
              <td class="col-vencimiento">
                @if (p.ControlarVencimiento && p.FechaVencimiento.HasValue)
                {
                  var diasRestantes = (p.FechaVencimiento.Value - DateTime.Now).Days;
                  var claseColor = diasRestantes < 0 ? "text-danger" : diasRestantes <= 30 ? "text-warning" : "text-success";
                  <span class="@claseColor fw-semibold">
                    @p.FechaVencimiento.Value.ToString("dd/MM/yyyy")
                    @if (diasRestantes < 0)
                    {
                      <span class="badge bg-danger ms-1">Vencido</span>
                    }
                    else if (diasRestantes <= 30)
                    {
                      <span class="badge bg-warning ms-1">@diasRestantes d√≠as</span>
                    }
                  </span>
                }
                else
                {
                  <span class="text-muted">-</span>
                }
              </td>
              <td class="col-estado">@(p.Activo ? "Activo" : "Inactivo")</td>
              <td class="col-acciones">
                <div class="btn-group btn-group-sm">
          <button class="btn btn-outline-info" title="Ver stock por dep√≥sito" @onclick="() => AbrirStocks(p)"><i class="bi bi-boxes"></i></button>
                  <button class="btn btn-outline-secondary" title="Etiqueta" @onclick="() => AbrirEtiqueta(p)"><i class="bi bi-upc"></i></button>
                  <button class="btn btn-warning" title="Editar" @onclick="() => Editar(p)"><i class="bi bi-pencil-square"></i></button>
                  <button class="btn btn-danger" title="Eliminar" @onclick="() => Eliminar(p)"><i class="bi bi-trash"></i></button>
                </div>
              </td>
            </tr>
          }
        </tbody>
      </table>
    </div>
    @if (filtrados.Count > 100)
    {
      <div class="alert alert-info m-3"><i class="bi bi-info-circle me-2"></i>Mostrando 100 de @filtrados.Count. Use filtros para refinar.</div>
    }
  </div>

  <!-- Modal -->
  <div class="modal fade @(mostrarModal ? "show" : "")" style="display:@(mostrarModal?"block":"none")" tabindex="-1">
    <div class="modal-dialog modal-xl">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">@(editando.IdProducto > 0 ? "Editar Producto" : "Nuevo Producto")</h5>
          <button type="button" class="btn-close" @onclick="Cerrar"></button>
        </div>
        <div class="modal-body">
          <EditForm Model="editando" OnValidSubmit="@Guardar">
            <DataAnnotationsValidator />
            <ValidationSummary />
            <div class="row g-3">
              
              @* ========== SECCI√ìN: INFORMACI√ìN B√ÅSICA ========== *@
              <div class="col-12"><h6 class="text-primary border-bottom pb-1 mb-0"><i class="bi bi-info-circle me-1"></i>Informaci√≥n B√°sica</h6></div>
              
              <div class="col-md-3">
                <label class="form-label">C√≥digo (dCodInt)</label>
                <input type="text" class="form-control" value="@(string.IsNullOrEmpty(editando.CodigoInterno) ? "Se generar√° autom√°ticamente" : editando.CodigoInterno)" disabled style="background-color: var(--bs-secondary-bg); cursor: not-allowed;" />
                <div class="form-text">El sistema asignar√° el c√≥digo al guardar.</div>
              </div>
              <div class="col-md-6">
                <label class="form-label">Descripci√≥n (dDesProSer) *</label>
                <InputText class="form-control" @bind-Value="editando.Descripcion" />
              </div>
              <div class="col-md-3">
                <label class="form-label">C√≥digo de Barras</label>
                <InputText class="form-control" @bind-Value="editando.CodigoBarras" placeholder="GTIN-8/12/13/14" />
              </div>
              
              @* ========== SECCI√ìN: CLASIFICACI√ìN ========== *@
              <div class="col-12 mt-3"><h6 class="text-primary border-bottom pb-1 mb-0"><i class="bi bi-tags me-1"></i>Clasificaci√≥n</h6></div>
              
              <div class="col-md-3">
                <label class="form-label">Tipo √çtem</label>
                <div class="input-group">
                  <select class="form-select" @bind="editando.TipoItem">
                    @foreach (var t in tiposItem)
                    {
                      <option value="@t.IdTipoItem">@t.Nombre@(t.EsGasto ? " (Gasto)" : string.Empty)</option>
                    }
                  </select>
                  <button class="btn btn-outline-secondary" type="button" title="Nuevo tipo" @onclick="AbrirNuevoTipoItem">+</button>
                </div>
              </div>
              <div class="col-md-3">
                <label class="form-label">Marca</label>
                <div class="input-group">
                  <select class="form-select" @bind="editando.IdMarca">
                    <option value="">(Sin marca)</option>
                    @foreach (var m in marcas)
                    {
                      <option value="@m.IdMarca">@m.NombreMarca</option>
                    }
                  </select>
                  <button class="btn btn-outline-secondary" type="button" title="Nueva marca" @onclick="AbrirNuevaMarca">+</button>
                </div>
              </div>
              <div class="col-md-3">
                <label class="form-label">Clasificaci√≥n</label>
                <div class="input-group">
                  <select class="form-select" @bind="editando.IdClasificacion">
                    <option value="">(Sin clasificaci√≥n)</option>
                    @foreach (var c in clasificaciones)
                    {
                      <option value="@c.IdClasificacion">@c.Nombre</option>
                    }
                  </select>
                  <button class="btn btn-outline-secondary" type="button" title="Nueva clasificaci√≥n" @onclick="AbrirNuevaClasificacion">+</button>
                </div>
              </div>
              <div class="col-md-3">
                <label class="form-label">Dep√≥sito Predeterminado</label>
                <select class="form-select" @bind="editando.IdDepositoPredeterminado">
                  <option value="">(Ninguno)</option>
                  @foreach (var d in depositosCombo)
                  {
                    <option value="@d.IdDeposito">@d.Nombre (@(d.Sucursal?.NombreSucursal ?? $"Suc {d.IdSucursal}"))</option>
                  }
                </select>
              </div>
              
              @* ========== SECCI√ìN: UNIDAD E IMPUESTOS ========== *@
              <div class="col-12 mt-3"><h6 class="text-primary border-bottom pb-1 mb-0"><i class="bi bi-percent me-1"></i>Unidad e Impuestos</h6></div>
              
              <div class="col-md-4">
                <label class="form-label">Unidad de Medida (cUniMed) *</label>
                <select class="form-select" value="@editando.UnidadMedidaCodigo" @onchange="OnUnidadMedidaChanged">
                  <option value="77">77 - Unidad</option>
                  <option value="005">005 - Caja</option>
                  <option value="003">003 - Kilogramo</option>
                  <option value="001">001 - Metro</option>
                  <option value="002">002 - Litro</option>
                  <option value="006">006 - Paquete</option>
                </select>
                <div class="form-text">C√≥digos SIFEN m√°s usados.</div>
              </div>
              
              @* Campo Cantidad por Paquete - solo visible cuando UnidadMedida = Paquete o Caja *@
              @if (editando.UnidadMedidaCodigo == "006" || editando.UnidadMedidaCodigo == "005")
              {
                <div class="col-md-4">
                  <label class="form-label">üì¶ Cantidad por @(editando.UnidadMedidaCodigo == "006" ? "Paquete" : "Caja") *</label>
                  <input type="number" class="form-control" min="1" step="1" 
                         value="@(editando.CantidadPorPaquete?.ToString(System.Globalization.CultureInfo.InvariantCulture) ?? "")" 
                         @onchange="OnCantidadPorPaqueteChanged" placeholder="Ej: 10" />
                  <div class="form-text">Cu√°ntas unidades trae un @(editando.UnidadMedidaCodigo == "006" ? "paquete" : "caja").</div>
                </div>
                <div class="col-md-4">
                  <div class="form-check form-switch mb-2">
                    <input class="form-check-input" type="checkbox" id="permiteVentaUnidadSwitch" @bind="editando.PermiteVentaPorUnidad" />
                    <label class="form-check-label" for="permiteVentaUnidadSwitch">üõí Permitir Venta por Unidad</label>
                  </div>
                  <div class="form-text">Permite vender unidades sueltas del @(editando.UnidadMedidaCodigo == "006" ? "paquete" : "caja").</div>
                </div>
              }
              <div class="col-md-4">
                <label class="form-label">Tipo de IVA *</label>
                <select class="form-select" @bind="editando.IdTipoIva">
                  @foreach (var iva in tiposIva)
                  {
                    <option value="@iva.IdTipoIva">@iva.DescripcionCompleta</option>
                  }
                </select>
              </div>
              <div class="col-md-4">
                <label class="form-label">Moneda Predeterminada</label>
                <select class="form-select" @bind="editando.IdMonedaPrecio">
                  <option value="">(PYG por defecto)</option>
                  @foreach (var m in monedas)
                  {
                    <option value="@m.IdMoneda">@m.Nombre (@m.CodigoISO)</option>
                  }
                </select>
              </div>
              
              @* ========== SECCI√ìN: PRECIOS ========== *@
              <div class="col-12 mt-3"><h6 class="text-primary border-bottom pb-1 mb-0"><i class="bi bi-currency-dollar me-1"></i>Precios</h6></div>
              
              <div class="col-md-3">
                <label class="form-label">Costo Unitario Gs</label>
                <input type="text" inputmode="numeric" class="form-control" value="@(editando.CostoUnitarioGs.HasValue ? ((long)editando.CostoUnitarioGs.Value).ToString(System.Globalization.CultureInfo.InvariantCulture) : "")" @onchange="OnCostoChanged" />
                <div class="form-text">Costo de compra (referencial).</div>
              </div>
              <div class="col-md-2">
                <label class="form-label">Factor</label>
                <input type="text" inputmode="decimal" class="form-control" value="@(factorPrecio?.ToString(System.Globalization.CultureInfo.InvariantCulture))" @onchange="OnFactorChanged" placeholder="ej: 1.30" />
                <div class="form-text">Multiplicador</div>
              </div>
              <div class="col-md-2">
                <label class="form-label">% Mark-up</label>
                <input type="text" inputmode="decimal" class="form-control" value="@(porcentajePrecio?.ToString(System.Globalization.CultureInfo.InvariantCulture))" @onchange="OnPorcentajeChanged" placeholder="ej: 30" />
                @{
                  decimal? pctUtilidad = null;
                  if (editando.CostoUnitarioGs.HasValue && editando.CostoUnitarioGs.Value > 0 && editando.PrecioUnitarioGs > 0)
                  {
                    pctUtilidad = ((editando.PrecioUnitarioGs - editando.CostoUnitarioGs.Value) / editando.PrecioUnitarioGs) * 100;
                  }
                  var colorUtilidad = pctUtilidad.HasValue ? (pctUtilidad.Value >= 30 ? "text-primary" : "text-danger") : "text-muted";
                }
                <small class="@colorUtilidad" title="% Utilidad (sobre precio venta)">Util: @(pctUtilidad.HasValue ? $"{pctUtilidad.Value:N1}%" : "‚Äî")</small>
              </div>
              <div class="col-md-3">
                <label class="form-label">Precio Unitario Gs *</label>
                <input type="text" inputmode="numeric" class="form-control @(ValidarPrecioMinisterio && editando.PrecioMinisterio.HasValue && editando.PrecioUnitarioGs > editando.PrecioMinisterio ? "is-invalid" : "")" value="@((long)editando.PrecioUnitarioGs)" @onchange="OnPrecioChanged" />
                @if (ValidarPrecioMinisterio && editando.PrecioMinisterio.HasValue && editando.PrecioUnitarioGs > editando.PrecioMinisterio)
                {
                  <div class="invalid-feedback">El precio no puede superar el Precio Ministerio (@editando.PrecioMinisterio.Value.ToString("N0") Gs)</div>
                }
              </div>
              @if (MostrarPrecioMinisterio)
              {
                <div class="col-md-2">
                  <label class="form-label">üè• P. Ministerio</label>
                  <input type="text" inputmode="numeric" class="form-control" value="@(editando.PrecioMinisterio.HasValue ? ((long)editando.PrecioMinisterio.Value).ToString() : "")" @onchange="OnPrecioMinisterioChanged" placeholder="M√°x. regulado" />
                </div>
              }
              
              @* ========== SECCI√ìN: OPCIONES DE VENTA ========== *@
              <div class="col-12 mt-3"><h6 class="text-primary border-bottom pb-1 mb-0"><i class="bi bi-cart-check me-1"></i>Opciones de Venta</h6></div>
              
              <div class="col-md-3">
                <div class="form-check form-switch mb-2">
                  <input class="form-check-input" type="checkbox" id="permiteDecimalSwitch" @bind="editando.PermiteDecimal" />
                  <label class="form-check-label" for="permiteDecimalSwitch">‚öñÔ∏è Permite Venta Decimal</label>
                </div>
                <div class="form-text">Permite vender fracciones (ej: 0.5 kg).</div>
              </div>
              <div class="col-md-3">
                <div class="form-check form-switch mb-2">
                  <input class="form-check-input" type="checkbox" id="controladoRecetaSwitch" @bind="editando.ControladoReceta" />
                  <label class="form-check-label" for="controladoRecetaSwitch">üè• Controlado con Receta</label>
                </div>
                <div class="form-text">Requiere datos de receta m√©dica.</div>
              </div>
              <div class="col-md-3">
                <div class="form-check form-switch mb-2">
                  <input class="form-check-input" type="checkbox" id="controlarVencimientoSwitch" @bind="editando.ControlarVencimiento" />
                  <label class="form-check-label" for="controlarVencimientoSwitch">üìÖ Controlar Vencimiento</label>
                </div>
                @if (editando.ControlarVencimiento)
                {
                  <InputDate class="form-control form-control-sm" @bind-Value="editando.FechaVencimiento" />
                }
              </div>
              <div class="col-md-3">
                <div class="form-check form-switch mb-2">
                  <input class="form-check-input" type="checkbox" role="switch" id="activoSwitch" @bind="editando.Activo" />
                  <label class="form-check-label" for="activoSwitch">‚úÖ Activo</label>
                </div>
                <div class="form-text">Producto disponible para venta.</div>
              </div>
              <div class="col-md-3">
                <div class="form-check form-switch mb-2">
                  <input class="form-check-input" type="checkbox" id="permiteVentaBajoCostoSwitch" @bind="editando.PermiteVentaBajoCosto" />
                  <label class="form-check-label" for="permiteVentaBajoCostoSwitch">üí∞ Permite Venta Bajo Costo</label>
                </div>
                <div class="form-text">Permite vender por debajo del precio de costo.</div>
              </div>
              
              @* ========== SECCI√ìN: IMAGEN ========== *@
              <div class="col-12 mt-3"><h6 class="text-primary border-bottom pb-1 mb-0"><i class="bi bi-image me-1"></i>Imagen</h6></div>
              
              <div class="col-md-4">
                <div class="d-flex align-items-center gap-3">
                  <img src="@(previewDataUrl ?? (string.IsNullOrWhiteSpace(editando.Foto) ? "/images/placeholder-product.svg" : editando.Foto))" alt="preview" style="width:80px;height:80px;object-fit:cover;border-radius:6px;border:1px solid #ddd" />
                  <div>
                    <InputFile class="form-control form-control-sm file-no-text" OnChange="OnFileSelected" accept="image/*" />
                    <div class="form-text">PNG/JPG/WEBP hasta 2 MB.</div>
                  </div>
                </div>
              </div>
              
              @* ========== SECCI√ìN: COMBO ========== *@
              <div class="col-12 mt-3"><h6 class="text-primary border-bottom pb-1 mb-0"><i class="bi bi-boxes me-1"></i>Combo</h6></div>
              
              <div class="col-md-12">
                <div class="form-check form-switch mb-2">
                  <input class="form-check-input" type="checkbox" id="esComboSwitch" @bind="editando.EsCombo" />
                  <label class="form-check-label" for="esComboSwitch">üì¶ Es un Combo</label>
                </div>
                @if (editando.EsCombo)
                {
                  @if (editando.IdProducto == 0)
                  {
                    <div class="alert alert-info py-2">Guarde el producto para poder agregar componentes del combo.</div>
                  }
                  else
                  {
                    <div class="card mb-2">
                      <div class="card-header py-2">Componentes del combo</div>
                      <div class="card-body">
                        <div class="row g-2 align-items-end mb-2">
                          <div class="col-md-6">
                            <label class="form-label">Producto componente</label>
                            <div class="position-relative">
                              <input class="form-control" placeholder="Escriba nombre o c√≥digo..." value="@componenteSearch" @oninput="OnComponenteSearchChanged" @onfocus="ShowComponenteOpciones" @onblur="OnComponenteBlur" @onkeydown="OnComponenteKeyDown" />
                              @if (mostrandoOpciones && componenteOpciones.Count > 0)
                              {
                                <div class="list-group position-absolute w-100 shadow-sm bg-white" style="z-index:1000; max-height:260px; overflow:auto;">
                                  @for (int i = 0; i < componenteOpciones.Count; i++)
                                  {
                                    var pr = componenteOpciones[i];
                                    var itemClass = $"list-group-item list-group-item-action d-flex justify-content-between align-items-center {(i == selectedOptionIndex ? "active" : string.Empty)}";
                                    <button type="button" class="@itemClass" @onmousedown="(() => SeleccionarComponente(pr))" @onclick="(() => SeleccionarComponente(pr))">
                                      <span>@pr.Descripcion</span>
                                      <small class="text-muted">ID: @pr.IdProducto ¬∑ @pr.UnidadMedidaCodigo</small>
                                    </button>
                                  }
                                </div>
                              }
                              else if (mostrandoOpciones && !string.IsNullOrWhiteSpace(componenteSearch) && componenteOpciones.Count == 0)
                              {
                                <div class="list-group position-absolute w-100 shadow-sm bg-white" style="z-index:1000; max-height:260px; overflow:auto;">
                                  <div class="list-group-item text-muted">Sin resultados</div>
                                </div>
                              }
                            </div>
                          </div>
                          <div class="col-md-3">
                            <label class="form-label">Cantidad a descontar</label>
                            <input class="form-control" type="number" step="0.0001" @bind="cantidadComponente" />
                            <div class="form-text">Se descuenta por cada unidad del combo vendida.</div>
                          </div>
                          <div class="col-md-3 text-end">
                            <button type="button" class="btn btn-outline-primary" @onclick="AgregarComponente" disabled="@(selectedComponenteId==0 || cantidadComponente<=0)">Agregar</button>
                          </div>
                        </div>
                        <div class="table-responsive">
                          <table class="table table-sm table-striped">
                            <thead>
                              <tr>
                                <th style="width:80px">ID</th>
                                <th>Nombre</th>
                                <th class="text-end" style="width:140px">Cant. Descontar</th>
                                <th style="width:120px">Unidad</th>
                                <th style="width:70px"></th>
                              </tr>
                            </thead>
                            <tbody>
                              @if (componentesCombo.Count == 0)
                              {
                                <tr><td colspan="5" class="text-muted">Sin componentes</td></tr>
                              }
                              else
                              {
                                @foreach (var pc in componentesCombo)
                                {
                                  <tr>
                                    <td>@pc.IdComponente</td>
                                    <td>@pc.Componente?.Descripcion</td>
                                    <td class="text-end">@pc.Cantidad.ToString("N4")</td>
                                    <td>@(pc.Componente?.UndMedida?.Trim())</td>
                                    <td class="text-end">
                                      <button type="button" class="btn btn-sm btn-outline-danger" title="Quitar" @onclick="() => QuitarComponente(pc.IdProductoComponente)"><i class="bi bi-trash"></i></button>
                                    </td>
                                  </tr>
                                }
                              }
                            </tbody>
                          </table>
                        </div>
                      </div>
                    </div>
                  }
                }
              </div>
            </div>
          </EditForm>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" @onclick="Cerrar">Cancelar</button>
          <button class="btn btn-primary" @onclick="SubmitForm"><i class="bi bi-save me-2"></i>Guardar</button>
        </div>
      </div>
    </div>
  </div>
  @if (mostrarModal)
  {
    <div class="modal-backdrop fade show"></div>
  }

  <!-- Modal Etiqueta de c√≥digo de barras -->
  <div class="modal fade @(mostrarEtiqueta ? "show" : "")" style="display:@(mostrarEtiqueta?"block":"none")" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Etiqueta de c√≥digo de barras</h5>
          <button type="button" class="btn-close" @onclick="CerrarEtiqueta"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">Formato</label>
            <select class="form-select" @bind="barcodeFormat">
              <option value="CODE128">Code128 (universal)</option>
              <option value="EAN13">EAN-13 (retail)</option>
              <option value="UPC">UPC-A (US/CA)</option>
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label">C√≥digo</label>
            <div class="input-group">
              <input class="form-control" @bind="barcodeCode" @bind:event="oninput" />
              <button type="button" class="btn btn-outline-secondary" @onclick="GenerarEanAutoClick">Auto</button>
            </div>
            <div class="form-text">
              @if (barcodeFormat == "EAN13") {<text>13 d√≠gitos (√∫ltimo es d√≠gito verificador).</text>}
              else if (barcodeFormat == "UPC") {<text>12 d√≠gitos (√∫ltimo es d√≠gito verificador).</text>}
              else {<text>Libre: letras y n√∫meros.</text>}
            </div>
          </div>
          <div class="row g-2 mb-2">
            <div class="col-4">
              <label class="form-label">Ancho barra</label>
              <input type="number" min="1" max="6" class="form-control" @bind="barcodeWidth" @bind:event="oninput" />
            </div>
            <div class="col-4">
              <label class="form-label">Alto (px)</label>
              <input type="number" min="40" max="200" class="form-control" @bind="barcodeHeight" @bind:event="oninput" />
            </div>
            <div class="col-4">
              <label class="form-label">Margen (px)</label>
              <input type="number" min="0" max="30" class="form-control" @bind="barcodeMargin" @bind:event="oninput" />
            </div>
          </div>
          <div class="form-check form-switch mb-2">
            <input id="showText" class="form-check-input" type="checkbox" @bind="barcodeShowText" />
            <label class="form-check-label" for="showText">Mostrar texto</label>
          </div>
          <div class="form-check form-switch mb-2">
            <input id="showName" class="form-check-input" type="checkbox" @bind="barcodeShowName" />
            <label class="form-check-label" for="showName">Mostrar nombre del producto</label>
          </div>
          <svg id="barcodePreview" style="width:100%"></svg>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" @onclick="CerrarEtiqueta">Cerrar</button>
          <button type="button" class="btn btn-primary" @onclick="ImprimirEtiqueta"><i class="bi bi-printer me-2"></i>Imprimir</button>
        </div>
      </div>
    </div>
  </div>
  @if (mostrarEtiqueta)
  {
    <div class="modal-backdrop fade show"></div>
  }

  <!-- Modal: Stock por dep√≥sito -->
  <div class="modal fade @(mostrarStocks ? "show" : "")" style="display:@(mostrarStocks?"block":"none")" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Stock por dep√≥sito @((productoStocks?.Descripcion is null ? string.Empty : $"- {productoStocks.Descripcion}"))</h5>
          <button type="button" class="btn-close" @onclick="CerrarStocks"></button>
        </div>
        <div class="modal-body">
          <div class="table-responsive">
            <table class="table table-sm table-striped">
              <thead>
                <tr>
                  <th>Dep√≥sito</th>
                  <th class="text-end">Stock</th>
                </tr>
              </thead>
              <tbody>
                @if (stocksDepositos is null)
                {
                  <tr><td colspan="2" class="text-muted">Cargando...</td></tr>
                }
                else if (!stocksDepositos.Any())
                {
                  <tr><td colspan="2" class="text-muted">Sin filas</td></tr>
                }
                else
                {
                  @foreach (var s in stocksDepositos)
                  {
                    <tr>
                      <td>@(s.Deposito?.Nombre ?? s.IdDeposito.ToString())</td>
                      <td class="text-end">@s.Stock.ToString("N4")</td>
                    </tr>
                  }
                }
              </tbody>
            </table>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" @onclick="CerrarStocks">Cerrar</button>
        </div>
      </div>
    </div>
  </div>
  @if (mostrarStocks)
  {
    <div class="modal-backdrop fade show"></div>
  }
</div>

@code {
  private List<Models.Producto> productos = new();
  private List<Models.Producto> filtrados = new();
  private List<Models.TiposIva> tiposIva = new();
  private List<Models.Marca> marcas = new();
  private List<Models.Sucursal> sucursales = new();
  private List<Models.Moneda> monedas = new();
  private List<Models.Deposito> depositosCombo = new();
  private List<Models.Clasificacion> clasificaciones = new();
  private List<Models.TiposItem> tiposItem = new();
  private List<Models.ProductoComponente> componentesCombo = new();
  private int selectedComponenteId = 0;
  private decimal cantidadComponente = 1m;
  private string filtro = string.Empty;
  private string filtroIva = string.Empty;
  private string filtroDeposito = string.Empty;
  private bool soloActivos = true;
  private bool mostrarModal = false;
  private Models.Producto editando = new Models.Producto();
  private List<Models.Deposito> depositos = new();
  private Dictionary<int, List<(string Deposito, decimal Stock)>> stocksPorProductoDeposito = new();
  private IBrowserFile? pendingImage;
  private string? previewDataUrl;
  private bool mostrarEtiqueta = false;
  private Models.Producto? etiquetaProducto;
  private string ean13 = string.Empty; // legado
  private string _barcodeCode = string.Empty;
  private string barcodeCode { get => _barcodeCode; set { if (_barcodeCode != value) { _barcodeCode = value; if(!_suspendRenderEtiqueta) { _ = RenderEtiqueta(); } } } }
  private string _barcodeFormat = "CODE128";
  private string barcodeFormat { get => _barcodeFormat; set { if (_barcodeFormat != value) { _barcodeFormat = value; if(!_suspendRenderEtiqueta) { _ = RenderEtiqueta(); } } } }
  private int _barcodeWidth = 2;
  private int barcodeWidth { get => _barcodeWidth; set { if (_barcodeWidth != value) { _barcodeWidth = value; if(!_suspendRenderEtiqueta) { _ = RenderEtiqueta(); } } } }
  private int _barcodeHeight = 80;
  private int barcodeHeight { get => _barcodeHeight; set { if (_barcodeHeight != value) { _barcodeHeight = value; if(!_suspendRenderEtiqueta) { _ = RenderEtiqueta(); } } } }
  private int _barcodeMargin = 10;
  private int barcodeMargin { get => _barcodeMargin; set { if (_barcodeMargin != value) { _barcodeMargin = value; if(!_suspendRenderEtiqueta) { _ = RenderEtiqueta(); } } } }
  private bool _barcodeShowText = true;
  private bool barcodeShowText { get => _barcodeShowText; set { if (_barcodeShowText != value) { _barcodeShowText = value; if(!_suspendRenderEtiqueta) { _ = RenderEtiqueta(); } } } }
  private bool _barcodeShowName = true;
  private bool barcodeShowName { get => _barcodeShowName; set { if (_barcodeShowName != value) { _barcodeShowName = value; if(!_suspendRenderEtiqueta) { _ = RenderEtiqueta(); } } } }
  private bool _etiquetaRenderizada = false;
  private bool _suspendRenderEtiqueta = false;
  private string nuevaClasificacionNombre = string.Empty;
  private string undMedidaValue = "UNIDAD"; // valor intermedio TRIM para evitar padding de CHAR(10)
  // Variables para c√°lculo de precio desde costo
  private decimal? factorPrecio = null;
  private decimal? porcentajePrecio = null;
  private bool actualizandoPrecio = false; // evita recursi√≥n
  // Autocompletado de componentes
  private string componenteSearch = string.Empty;
  private List<Models.Producto> componenteOpciones = new();
  private bool mostrandoOpciones = false;
  private CancellationTokenSource? _searchCts;
  private int selectedOptionIndex = -1;
  
  // Configuraci√≥n de farmacia (Precio Ministerio)
  private Models.ConfiguracionSistema? _config;
  private bool MostrarPrecioMinisterio => _config?.FarmaciaModoActivo == true && _config?.FarmaciaMostrarPrecioMinisterio == true;
  private bool ValidarPrecioMinisterio => _config?.FarmaciaModoActivo == true && _config?.FarmaciaValidarPrecioMinisterio == true;

  protected override async Task OnInitializedAsync()
  {
    await Cargar();
  }

  protected override async Task OnAfterRenderAsync(bool firstRender)
  {
    if (mostrarEtiqueta && !_etiquetaRenderizada)
    {
      for (var i = 0; i < 5 && !_etiquetaRenderizada; i++)
      {
        await RenderEtiqueta();
        if (_etiquetaRenderizada) break;
        await Task.Delay(50);
      }
    }
  }

  private async Task Cargar()
  {
    await using var db = await DbFactory.CreateDbContextAsync();
    
    // Cargar configuraci√≥n del sistema (farmacia)
    _config = await db.ConfiguracionSistema.FirstOrDefaultAsync();
    
  // Asegurar columna de moneda predeterminada del producto (si no existe)
  try
  {
    await db.Database.ExecuteSqlRawAsync(@"IF COL_LENGTH('Productos','IdMonedaPrecio') IS NULL
BEGIN
  ALTER TABLE Productos ADD IdMonedaPrecio INT NULL;
END");
  }
  catch { }
    tiposIva = await db.TiposIva.OrderBy(t => t.Porcentaje).ToListAsync();
    marcas = await db.Marcas.OrderBy(m => m.NombreMarca).ToListAsync();
    sucursales = await db.Sucursal.OrderBy(s => s.NombreSucursal).ToListAsync();
  // Limitar a ARS, USD, BRL y PYG como en Compras
  var cods = new[] { "ARS", "USD", "BRL", "PYG" };
  monedas = await db.Monedas.Where(m => cods.Contains(m.CodigoISO)).OrderBy(m => m.CodigoISO).ToListAsync();
    clasificaciones = await db.Clasificaciones.Where(c => c.Activo).OrderBy(c => c.Nombre).ToListAsync();
  tiposItem = await db.TiposItem.OrderBy(t => t.Nombre).ToListAsync();
  depositosCombo = await db.Depositos.Include(d => d.Sucursal).OrderBy(d => d.IdSucursal).ThenBy(d => d.Nombre).ToListAsync();
  depositos = await db.Depositos.Where(d => d.Activo).OrderBy(d => d.Nombre).ToListAsync();
    productos = await db.Productos
      .Include(p => p.TipoIva)
      .Include(p => p.Marca)
      .Include(p => p.Sucursal)
      .Include(p => p.Clasificacion)
      .OrderBy(p => p.Descripcion)
      .ToListAsync();
    
    // Cargar stocks por producto y dep√≥sito (incluir todos los registros, no solo stock > 0)
    var productosDeposito = await db.ProductosDepositos
      .Include(pd => pd.Deposito)
      .ToListAsync();
    
    stocksPorProductoDeposito.Clear();
    foreach (var pd in productosDeposito)
    {
      if (!stocksPorProductoDeposito.ContainsKey(pd.IdProducto))
      {
        stocksPorProductoDeposito[pd.IdProducto] = new List<(string, decimal)>();
      }
      var nombreDeposito = pd.Deposito?.Nombre ?? "Sin nombre";
      stocksPorProductoDeposito[pd.IdProducto].Add((nombreDeposito, pd.Stock));
    }
    
    Filtrar();
  }

  private void Filtrar()
  {
    filtrados = productos.Where(p =>
      (string.IsNullOrWhiteSpace(filtro) ||
        p.Descripcion.Contains(filtro, StringComparison.OrdinalIgnoreCase) ||
        p.CodigoInterno.Contains(filtro, StringComparison.OrdinalIgnoreCase)) &&
      (string.IsNullOrEmpty(filtroIva) || p.IdTipoIva.ToString() == filtroIva) &&
      (!soloActivos || p.Activo)
    ).ToList();
    
    // Aplicar filtro por dep√≥sito: mostrar productos que tienen registro en ese dep√≥sito
    if (!string.IsNullOrEmpty(filtroDeposito))
    {
      var depositoSeleccionado = depositos.FirstOrDefault(d => d.IdDeposito.ToString() == filtroDeposito);
      if (depositoSeleccionado != null)
      {
        filtrados = filtrados.Where(p => 
          stocksPorProductoDeposito.ContainsKey(p.IdProducto) && 
          stocksPorProductoDeposito[p.IdProducto].Any(s => s.Deposito == depositoSeleccionado.Nombre)
        ).ToList();
      }
    }
  }

  private void NuevoProducto()
  {
    editando = new Models.Producto
    {
      CodigoInterno = string.Empty,
      Descripcion = string.Empty,
      UnidadMedidaCodigo = "77",
      IdTipoIva = tiposIva.FirstOrDefault()?.IdTipoIva ?? 0,
      PrecioUnitarioGs = 0,
      Activo = true,
      UndMedida = "UNIDAD",
      IdSucursal = sucursales.FirstOrDefault()?.Id ?? 0,
  IdClasificacion = null,
  IdDepositoPredeterminado = 1,
  IdMonedaPrecio = monedas.FirstOrDefault(m => m.CodigoISO == "PYG")?.IdMoneda
    };
    undMedidaValue = "UNIDAD";
    pendingImage = null;
    previewDataUrl = null;
    factorPrecio = null;
    porcentajePrecio = null;
  componentesCombo = new();
  selectedComponenteId = 0;
  cantidadComponente = 1m;
  componenteSearch = string.Empty;
  componenteOpciones.Clear();
  mostrandoOpciones = false;
  selectedOptionIndex = -1;
    mostrarModal = true;
  }

  private void Editar(Models.Producto p)
  {
    editando = new Models.Producto
    {
      IdProducto = p.IdProducto,
      CodigoInterno = p.CodigoInterno,
      Descripcion = p.Descripcion,
      UnidadMedidaCodigo = p.UnidadMedidaCodigo,
      IdTipoIva = p.IdTipoIva,
      PrecioUnitarioGs = p.PrecioUnitarioGs,
      PrecioUnitarioUsd = p.PrecioUnitarioUsd,
      CostoUnitarioGs = p.CostoUnitarioGs,
      CodigoBarras = p.CodigoBarras,
      IdMarca = p.IdMarca,
      TipoItem = p.TipoItem,
      EsCombo = p.EsCombo,
      Activo = p.Activo,
      Foto = p.Foto,
      UndMedida = p.UndMedida,
      IP = p.IP,
      IdSucursal = p.IdSucursal,
      IdClasificacion = p.IdClasificacion,
      IdDepositoPredeterminado = p.IdDepositoPredeterminado ?? depositosCombo.FirstOrDefault()?.IdDeposito ?? 1,
      IdMonedaPrecio = p.IdMonedaPrecio,
      ControladoReceta = p.ControladoReceta,
      PermiteDecimal = p.PermiteDecimal,
      // Campos de paquete/caja
      CantidadPorPaquete = p.CantidadPorPaquete,
      PermiteVentaPorUnidad = p.PermiteVentaPorUnidad,
      // Campos que faltaban - CR√çTICOS para no perder datos al guardar
      ControlarVencimiento = p.ControlarVencimiento,
      FechaVencimiento = p.FechaVencimiento,
      FactorMultiplicador = p.FactorMultiplicador,
      Stock = p.Stock,
      StockMinimo = p.StockMinimo,
      FechaCreacion = p.FechaCreacion,
      UsuarioCreacion = p.UsuarioCreacion,
      FechaModificacion = p.FechaModificacion,
      UsuarioModificacion = p.UsuarioModificacion,
      // Campo Precio Ministerio (farmacia)
      PrecioMinisterio = p.PrecioMinisterio,
      // Campos de descuentos y opciones de venta
      PermiteDescuento = p.PermiteDescuento,
      PermiteVentaBajoCosto = p.PermiteVentaBajoCosto,
      UsaDescuentoEspecifico = p.UsaDescuentoEspecifico,
      DescuentoAutomaticoProducto = p.DescuentoAutomaticoProducto,
      DescuentoMaximoProducto = p.DescuentoMaximoProducto,
      MargenAdicionalCajeroProducto = p.MargenAdicionalCajeroProducto
    };
    undMedidaValue = (p.UndMedida ?? "UNIDAD").Trim();
    pendingImage = null;
    previewDataUrl = null;
    // Calcular factor y porcentaje inicial si hay costo
    CalcularFactorYPorcentajeDesdePrecios();
    mostrarModal = true;
    _ = CargarComponentesAsync(editando.IdProducto);
  }

  private async Task AbrirNuevaMarca()
  {
    var nombre = await JS.InvokeAsync<string>("prompt", "Nueva marca (nombre):");
    if (string.IsNullOrWhiteSpace(nombre)) return;
    await using var db = await DbFactory.CreateDbContextAsync();
    var nueva = new Models.Marca { NombreMarca = nombre.Trim() };
    db.Marcas.Add(nueva);
    await db.SaveChangesAsync();
    marcas = await db.Marcas.OrderBy(m => m.NombreMarca).ToListAsync();
    editando.IdMarca = nueva.IdMarca;
    StateHasChanged();
  }

  private async Task AbrirNuevaClasificacion()
  {
    var nombre = await JS.InvokeAsync<string>("prompt", "Nueva clasificaci√≥n (nombre):");
    if (string.IsNullOrWhiteSpace(nombre)) return;
    await using var db = await DbFactory.CreateDbContextAsync();
    var nueva = new Models.Clasificacion { Nombre = nombre.Trim(), Activo = true };
    db.Clasificaciones.Add(nueva);
    await db.SaveChangesAsync();
    clasificaciones = await db.Clasificaciones.Where(c => c.Activo).OrderBy(c => c.Nombre).ToListAsync();
    editando.IdClasificacion = nueva.IdClasificacion;
    StateHasChanged();
  }

  private async Task AbrirNuevoTipoItem()
  {
    var nombre = await JS.InvokeAsync<string>("prompt", "Nuevo tipo de √≠tem (nombre):");
    if (string.IsNullOrWhiteSpace(nombre)) return;
    var esGasto = await JS.InvokeAsync<bool>("confirm", "¬øMarcar este tipo como 'Gasto'? Esto se usar√° para reportes.");
    await using var db = await DbFactory.CreateDbContextAsync();
    var nuevo = new Models.TiposItem { Nombre = nombre.Trim(), EsGasto = esGasto };
    db.TiposItem.Add(nuevo);
    await db.SaveChangesAsync();
    tiposItem = await db.TiposItem.OrderBy(t => t.Nombre).ToListAsync();
    editando.TipoItem = nuevo.IdTipoItem;
    StateHasChanged();
  }

  // ========== M√âTODOS PARA UNIDAD DE MEDIDA / PAQUETE ==========
  
  private void OnUnidadMedidaChanged(ChangeEventArgs e)
  {
    editando.UnidadMedidaCodigo = e.Value?.ToString() ?? "77";
    
    // Si cambia a Paquete (006) o Caja (005), inicializar valores por defecto
    if (editando.UnidadMedidaCodigo == "006" || editando.UnidadMedidaCodigo == "005")
    {
      if (!editando.CantidadPorPaquete.HasValue || editando.CantidadPorPaquete <= 0)
      {
        editando.CantidadPorPaquete = 1; // Valor por defecto
      }
    }
    else
    {
      // Si cambia a otra unidad, limpiar campos de paquete
      editando.CantidadPorPaquete = null;
      editando.PermiteVentaPorUnidad = true;
    }
    StateHasChanged();
  }
  
  private void OnCantidadPorPaqueteChanged(ChangeEventArgs e)
  {
    var valorStr = e.Value?.ToString()?.Replace(',', '.') ?? "";
    if (decimal.TryParse(valorStr, System.Globalization.NumberStyles.Any, System.Globalization.CultureInfo.InvariantCulture, out var cantidad) && cantidad > 0)
    {
      editando.CantidadPorPaquete = cantidad;
    }
    else
    {
      editando.CantidadPorPaquete = 1; // M√≠nimo 1
    }
  }

  // ========== M√âTODOS PARA C√ÅLCULO BIDIRECCIONAL DE PRECIO ==========
  
  private void OnCostoChanged(ChangeEventArgs e)
  {
    if (actualizandoPrecio) return;
    var valorStr = e.Value?.ToString()?.Replace(',', '.') ?? "";
    if (decimal.TryParse(valorStr, System.Globalization.NumberStyles.Any, System.Globalization.CultureInfo.InvariantCulture, out var costo))
    {
      editando.CostoUnitarioGs = costo;
      // Si hay factor, recalcular precio
      if (factorPrecio.HasValue && factorPrecio.Value > 0 && costo > 0)
      {
        actualizandoPrecio = true;
        editando.PrecioUnitarioGs = Math.Round(costo * factorPrecio.Value, 0);
        actualizandoPrecio = false;
      }
      // Si hay porcentaje, recalcular precio
      else if (porcentajePrecio.HasValue && costo > 0)
      {
        actualizandoPrecio = true;
        editando.PrecioUnitarioGs = Math.Round(costo * (1 + porcentajePrecio.Value / 100), 0);
        actualizandoPrecio = false;
      }
    }
    else
    {
      editando.CostoUnitarioGs = null;
    }
  }

  private void OnFactorChanged(ChangeEventArgs e)
  {
    if (actualizandoPrecio) return;
    var valorStr = e.Value?.ToString()?.Replace(',', '.') ?? "";
    if (decimal.TryParse(valorStr, System.Globalization.NumberStyles.Any, System.Globalization.CultureInfo.InvariantCulture, out var factor) && factor > 0)
    {
      factorPrecio = factor;
      actualizandoPrecio = true;
      // Calcular porcentaje equivalente: (factor - 1) * 100
      porcentajePrecio = Math.Round((factor - 1) * 100, 2);
      // Calcular precio si hay costo
      if (editando.CostoUnitarioGs.HasValue && editando.CostoUnitarioGs.Value > 0)
      {
        editando.PrecioUnitarioGs = Math.Round(editando.CostoUnitarioGs.Value * factor, 0);
      }
      actualizandoPrecio = false;
    }
    else
    {
      factorPrecio = null;
    }
  }

  private void OnPorcentajeChanged(ChangeEventArgs e)
  {
    if (actualizandoPrecio) return;
    var valorStr = e.Value?.ToString()?.Replace(',', '.') ?? "";
    if (decimal.TryParse(valorStr, System.Globalization.NumberStyles.Any, System.Globalization.CultureInfo.InvariantCulture, out var porcentaje))
    {
      porcentajePrecio = porcentaje;
      actualizandoPrecio = true;
      // Calcular factor equivalente: 1 + porcentaje/100
      factorPrecio = Math.Round(1 + porcentaje / 100, 4);
      // Calcular precio si hay costo
      if (editando.CostoUnitarioGs.HasValue && editando.CostoUnitarioGs.Value > 0)
      {
        editando.PrecioUnitarioGs = Math.Round(editando.CostoUnitarioGs.Value * (1 + porcentaje / 100), 0);
      }
      actualizandoPrecio = false;
    }
    else
    {
      porcentajePrecio = null;
    }
  }

  private void OnPrecioChanged(ChangeEventArgs e)
  {
    if (actualizandoPrecio) return;
    var valorStr = e.Value?.ToString()?.Replace(',', '.') ?? "";
    if (decimal.TryParse(valorStr, System.Globalization.NumberStyles.Any, System.Globalization.CultureInfo.InvariantCulture, out var precio))
    {
      editando.PrecioUnitarioGs = precio;
      // Si hay costo, recalcular factor y porcentaje
      if (editando.CostoUnitarioGs.HasValue && editando.CostoUnitarioGs.Value > 0)
      {
        actualizandoPrecio = true;
        var costo = editando.CostoUnitarioGs.Value;
        factorPrecio = Math.Round(precio / costo, 4);
        porcentajePrecio = Math.Round((precio / costo - 1) * 100, 2);
        actualizandoPrecio = false;
      }
    }
  }

  private void OnPrecioMinisterioChanged(ChangeEventArgs e)
  {
    var valorStr = e.Value?.ToString()?.Replace(',', '.') ?? "";
    if (string.IsNullOrWhiteSpace(valorStr))
    {
      editando.PrecioMinisterio = null;
    }
    else if (decimal.TryParse(valorStr, System.Globalization.NumberStyles.Any, System.Globalization.CultureInfo.InvariantCulture, out var precio))
    {
      editando.PrecioMinisterio = precio;
    }
  }

  private void CalcularFactorYPorcentajeDesdePrecios()
  {
    if (editando.CostoUnitarioGs.HasValue && editando.CostoUnitarioGs.Value > 0 && editando.PrecioUnitarioGs > 0)
    {
      var costo = editando.CostoUnitarioGs.Value;
      var precio = editando.PrecioUnitarioGs;
      factorPrecio = Math.Round(precio / costo, 4);
      porcentajePrecio = Math.Round((precio / costo - 1) * 100, 2);
    }
    else
    {
      factorPrecio = null;
      porcentajePrecio = null;
    }
  }
  // ========== FIN M√âTODOS C√ÅLCULO PRECIO ==========

  private async Task Guardar()
  {
    if (string.IsNullOrWhiteSpace(editando.Descripcion) || string.IsNullOrWhiteSpace(editando.UnidadMedidaCodigo) || string.IsNullOrWhiteSpace(undMedidaValue) || editando.IdSucursal <= 0)
    {
      await JS.InvokeVoidAsync("alert", "Complete Descripci√≥n, Unidad SIFEN, UndMedida y Sucursal");
      return;
    }
    
    // Validar cantidad por paquete cuando la unidad es Paquete o Caja
    if ((editando.UnidadMedidaCodigo == "006" || editando.UnidadMedidaCodigo == "005") 
        && (!editando.CantidadPorPaquete.HasValue || editando.CantidadPorPaquete <= 0))
    {
      await JS.InvokeVoidAsync("alert", "Ingrese la cantidad de unidades por " + (editando.UnidadMedidaCodigo == "006" ? "paquete" : "caja"));
      return;
    }
    
    // Validar Precio Ministerio (solo si est√° activa la validaci√≥n en configuraci√≥n)
    if (ValidarPrecioMinisterio && editando.PrecioMinisterio.HasValue && editando.PrecioUnitarioGs > editando.PrecioMinisterio.Value)
    {
      await JS.InvokeVoidAsync("alert", $"El Precio Unitario ({editando.PrecioUnitarioGs:N0} Gs) no puede superar el Precio Ministerio ({editando.PrecioMinisterio.Value:N0} Gs)");
      return;
    }
    
    editando.UndMedida = undMedidaValue.Trim();
    await using var db = await DbFactory.CreateDbContextAsync();

    // Validar c√≥digo de barras √∫nico (si se proporcion√≥)
    if (!string.IsNullOrWhiteSpace(editando.CodigoBarras))
    {
      var codigoBarrasDuplicado = await db.Productos
        .AnyAsync(p => p.CodigoBarras == editando.CodigoBarras && p.IdProducto != editando.IdProducto);
      if (codigoBarrasDuplicado)
      {
        await JS.InvokeVoidAsync("alert", "Ya existe otro producto con ese c√≥digo de barras");
        return;
      }
    }

    // Guardar imagen pendiente si existe
    var savedImg = await GuardarImagenPendienteAsync();
    if (!string.IsNullOrWhiteSpace(savedImg))
    {
      editando.Foto = savedImg;
    }
    
    // Guardar el factor multiplicador si se especific√≥
    if (factorPrecio.HasValue && factorPrecio.Value > 0)
    {
      editando.FactorMultiplicador = factorPrecio.Value;
    }
    
    // Actualizar fecha de modificaci√≥n
    editando.FechaModificacion = DateTime.Now;
    
    if (editando.IdProducto == 0)
    {
      // Si no se seleccion√≥ dep√≥sito predeterminado, usar el dep√≥sito 1 (Principal)
      if (!editando.IdDepositoPredeterminado.HasValue)
      {
        editando.IdDepositoPredeterminado = 1;
      }
      // Asegurar que el campo requerido no quede vac√≠o antes del primer Save
      if (string.IsNullOrWhiteSpace(editando.CodigoInterno)) editando.CodigoInterno = "AUTO";
      db.Productos.Add(editando);
      await db.SaveChangesAsync();

      // Generar c√≥digo definitivo basado en el Id y sucursal
      editando.CodigoInterno = $"PROD-{editando.IdSucursal:000}-{editando.IdProducto:000000}";
      db.Productos.Update(editando);
      await db.SaveChangesAsync();
    }
    else
    {
      db.Productos.Update(editando);
      await db.SaveChangesAsync();
    }
  // Limpiar estado de imagen temporal
  pendingImage = null;
  previewDataUrl = null;
  await JS.InvokeVoidAsync("alert", "Producto guardado");
    mostrarModal = false;
    await Cargar();
  }

  private async Task CargarComponentesAsync(int idProducto)
  {
    await using var db = await DbFactory.CreateDbContextAsync();
    componentesCombo = await db.ProductosComponentes
      .Include(pc => pc.Componente)
      .Where(pc => pc.IdProducto == idProducto && pc.Activo)
      .OrderBy(pc => pc.Componente!.Descripcion)
      .ToListAsync();
    StateHasChanged();
  }

  private async Task AgregarComponente()
  {
    if (editando.IdProducto <= 0) { await JS.InvokeVoidAsync("alert", "Guarde primero el producto"); return; }
    if (selectedComponenteId <= 0 || cantidadComponente <= 0) { return; }
    if (selectedComponenteId == editando.IdProducto) { await JS.InvokeVoidAsync("alert", "No puede agregarse a s√≠ mismo"); return; }
    await using var db = await DbFactory.CreateDbContextAsync();
    var existe = await db.ProductosComponentes.AnyAsync(pc => pc.IdProducto == editando.IdProducto && pc.IdComponente == selectedComponenteId);
    if (existe) { await JS.InvokeVoidAsync("alert", "Ese componente ya est√° en el combo"); return; }
    var comp = await db.Productos.FindAsync(selectedComponenteId);
    if (comp is null) { await JS.InvokeVoidAsync("alert", "Componente no encontrado"); return; }
    db.ProductosComponentes.Add(new Models.ProductoComponente
    {
      IdProducto = editando.IdProducto,
      IdComponente = selectedComponenteId,
      Cantidad = cantidadComponente,
      UnidadMedida = comp.UndMedida?.Trim(),
      Activo = true,
      FechaCreacion = DateTime.Now,
      UsuarioCreacion = "Sistema"
    });
    await db.SaveChangesAsync();
    selectedComponenteId = 0;
    cantidadComponente = 1m;
  componenteSearch = string.Empty;
  componenteOpciones.Clear();
  mostrandoOpciones = false;
  selectedOptionIndex = -1;
    await CargarComponentesAsync(editando.IdProducto);
  }

  private async Task QuitarComponente(int idProductoComponente)
  {
    await using var db = await DbFactory.CreateDbContextAsync();
    var pc = await db.ProductosComponentes.FirstOrDefaultAsync(x => x.IdProductoComponente == idProductoComponente);
    if (pc is null) return;
    db.ProductosComponentes.Remove(pc);
    await db.SaveChangesAsync();
    await CargarComponentesAsync(editando.IdProducto);
  }

  private void ShowComponenteOpciones()
  {
    mostrandoOpciones = true;
  if (componenteOpciones.Count > 0 && selectedOptionIndex < 0) selectedOptionIndex = 0;
  }

  private async Task BuscarComponentesAsync(string term, CancellationToken ct)
  {
    term = (term ?? string.Empty).Trim();
    if (string.IsNullOrWhiteSpace(term))
    {
      componenteOpciones = new();
      selectedOptionIndex = -1;
      StateHasChanged();
      return;
    }
    await using var db = await DbFactory.CreateDbContextAsync();
    var q = db.Productos.AsNoTracking()
      .Where(p => !p.EsCombo && p.IdProducto != editando.IdProducto && (
        p.Descripcion.Contains(term) || p.CodigoInterno.Contains(term)))
      .OrderBy(p => p.Descripcion)
      .Take(20);
    componenteOpciones = await q.ToListAsync(ct);
    selectedOptionIndex = componenteOpciones.Count > 0 ? 0 : -1;
    StateHasChanged();
  }

  private async Task OnComponenteSearchChanged(ChangeEventArgs e)
  {
    componenteSearch = e.Value?.ToString() ?? string.Empty;
    selectedComponenteId = 0;
    mostrandoOpciones = true;
  selectedOptionIndex = -1;
    _searchCts?.Cancel();
    _searchCts = new CancellationTokenSource();
    var token = _searchCts.Token;
    try
    {
      await Task.Delay(200, token); // debounce
      await BuscarComponentesAsync(componenteSearch, token);
    }
    catch (TaskCanceledException) { }
  }

  private void SeleccionarComponente(Models.Producto pr)
  {
    selectedComponenteId = pr.IdProducto;
    componenteSearch = pr.Descripcion;
    mostrandoOpciones = false;
    selectedOptionIndex = -1;
  }

  private async Task OnComponenteBlur(FocusEventArgs e)
  {
    // Peque√±o retraso para permitir click en una opci√≥n antes de cerrar
    await Task.Delay(150);
    mostrandoOpciones = false;
    StateHasChanged();
  }

  private void OnComponenteKeyDown(KeyboardEventArgs e)
  {
    if (!mostrandoOpciones) return;
    if (e.Key == "ArrowDown")
    {
      if (componenteOpciones.Count == 0) return;
      selectedOptionIndex = (selectedOptionIndex + 1 + componenteOpciones.Count) % componenteOpciones.Count;
    }
    else if (e.Key == "ArrowUp")
    {
      if (componenteOpciones.Count == 0) return;
      selectedOptionIndex = (selectedOptionIndex - 1 + componenteOpciones.Count) % componenteOpciones.Count;
    }
    else if (e.Key == "Enter")
    {
      if (selectedOptionIndex >= 0 && selectedOptionIndex < componenteOpciones.Count)
      {
        SeleccionarComponente(componenteOpciones[selectedOptionIndex]);
      }
    }
    else if (e.Key == "Escape")
    {
      mostrandoOpciones = false;
    }
  }

  private async Task Eliminar(Models.Producto p)
  {
    if (!await JS.InvokeAsync<bool>("confirm", $"¬øEliminar {p.Descripcion}?") ) return;
    await using var db = await DbFactory.CreateDbContextAsync();
    db.Productos.Remove(p);
    await db.SaveChangesAsync();
    await Cargar();
  }

  private void Cerrar()
  {
    pendingImage = null;
    previewDataUrl = null;
    mostrarModal = false;
  }
  private async Task SubmitForm() => await Guardar();

  private async Task OnFileSelected(InputFileChangeEventArgs e)
  {
    try
    {
      var file = e.File;
      if (file is null) return;
      var allowed = new[] { "image/png", "image/jpeg", "image/webp", "image/gif", "image/svg+xml" };
      if (!allowed.Contains(file.ContentType))
      {
        await JS.InvokeVoidAsync("alert", "Formato no permitido. Use PNG/JPG/WEBP/GIF/SVG");
        return;
      }
      pendingImage = file;
      using var ms = new MemoryStream();
      await file.OpenReadStream(maxAllowedSize: 2 * 1024 * 1024).CopyToAsync(ms);
      var base64 = Convert.ToBase64String(ms.ToArray());
      previewDataUrl = $"data:{file.ContentType};base64,{base64}";
      StateHasChanged();
    }
    catch (Exception ex)
    {
      await JS.InvokeVoidAsync("alert", $"Error al cargar la imagen: {ex.Message}");
    }
  }

  private void AbrirEtiqueta(Models.Producto p)
  {
  _suspendRenderEtiqueta = true; // evitar render hasta que el modal est√© visible
    etiquetaProducto = p;
    if (!string.IsNullOrWhiteSpace(p.CodigoBarras))
    {
      if (p.CodigoBarras.Length == 13) { barcodeFormat = "EAN13"; barcodeCode = p.CodigoBarras; }
      else if (p.CodigoBarras.Length == 12) { barcodeFormat = "UPC"; barcodeCode = p.CodigoBarras; }
      else { barcodeFormat = "CODE128"; barcodeCode = p.CodigoBarras; }
    }
    else
    {
      barcodeFormat = "CODE128";
      barcodeCode = GenerarCodigoAuto();
    }
    mostrarEtiqueta = true;
    _etiquetaRenderizada = false; // se renderizar√° en OnAfterRenderAsync
  _suspendRenderEtiqueta = false;
  }

  private void CerrarEtiqueta()
  {
    mostrarEtiqueta = false;
    etiquetaProducto = null;
    _etiquetaRenderizada = false;
  }

  private async Task RenderEtiqueta()
  {
    try
    {
      if (!mostrarEtiqueta || _suspendRenderEtiqueta) return;
      await Task.Delay(10); // peque√±o retraso para asegurar DOM listo
      // Verificar readiness del wrapper y JsBarcode
      var ready = await JS.InvokeAsync<bool>("BarcodeInterop.isReady");
      if (!ready) return;
      var fmt = barcodeFormat; // JsBarcode: EAN13 | UPC | CODE128
      var code = barcodeCode;
      if (string.IsNullOrWhiteSpace(code)) code = ean13; // compat
  var sub = barcodeShowName ? (etiquetaProducto?.Descripcion ?? editando?.Descripcion ?? "") : null;
  var ok = await JS.InvokeAsync<bool>("BarcodeInterop.render", "#barcodePreview", code, new { format = fmt, width = barcodeWidth, height = barcodeHeight, displayValue = barcodeShowText, margin = barcodeMargin, subText = sub, subTextFontSize = 10, subTextMarginTop = 0 });
      if (ok) _etiquetaRenderizada = true;
    }
    catch (JSException)
    {
      // Si el script a√∫n no est√° cargado, intenta silenciosamente m√°s tarde
    }
  }

  private async Task ImprimirEtiqueta()
  {
    try
    {
      var ready = await JS.InvokeAsync<bool>("BarcodeInterop.isReady");
      if (!ready)
      {
        await RenderEtiqueta();
        ready = await JS.InvokeAsync<bool>("BarcodeInterop.isReady");
        if (!ready) return;
      }
      await JS.InvokeAsync<bool>("BarcodeInterop.print", "#barcodePreview");
    }
    catch (JSException)
    {
      // Ignora si no est√° listo
    }
  }

  private string GenerarEan13()
  {
    // Generar 12 d√≠gitos base a partir del Id y sucursal si existen, completando con aleatorio
    var rnd = Random.Shared;
    string base12;
    if (etiquetaProducto != null && etiquetaProducto.IdProducto > 0)
    {
      base12 = $"{(etiquetaProducto.IdSucursal % 100):00}{(etiquetaProducto.IdProducto % 1000000000):0000000000}";
      base12 = base12.Substring(0, 12);
    }
    else
    {
      base12 = string.Concat(Enumerable.Range(0, 12).Select(_ => rnd.Next(0, 10).ToString()));
    }
    int check = CalcularDigitoVerificadorEan13(base12);
    return base12 + check.ToString();
  }

  private int CalcularDigitoVerificadorEan13(string base12)
  {
    // Algoritmo est√°ndar EAN-13: suma impares + 3*suma pares; d√≠gito = (10 - (sum % 10)) % 10
    int sum = 0;
    for (int i = 0; i < 12; i++)
    {
      int digit = base12[i] - '0';
      if ((i % 2) == 0) sum += digit; else sum += 3 * digit;
    }
    int check = (10 - (sum % 10)) % 10;
    return check;
  }

  private async Task GenerarEanAutoClick()
  {
  barcodeCode = GenerarCodigoAuto();
    for (var i = 0; i < 5 && !_etiquetaRenderizada; i++)
    {
      await RenderEtiqueta();
      if (_etiquetaRenderizada) break;
      await Task.Delay(50);
    }
  }

  private string GenerarCodigoAuto()
  {
    return barcodeFormat switch
    {
      "EAN13" => GenerarEan13(),
      "UPC" => GenerarUpcA(),
      _ => GenerarCode128()
    };
  }

  private string GenerarUpcA()
  {
    // UPC-A: 12 d√≠gitos con DV
    var rnd = Random.Shared;
    string base11;
    if (etiquetaProducto != null && etiquetaProducto.IdProducto > 0)
    {
      base11 = $"{(etiquetaProducto.IdSucursal % 100):00}{(etiquetaProducto.IdProducto % 1000000000):0000000000}".Substring(0, 11);
    }
    else
    {
      base11 = string.Concat(Enumerable.Range(0, 11).Select(_ => rnd.Next(0, 10).ToString()));
    }
    int sumOdd = 0, sumEven = 0;
    for (int i = 0; i < 11; i++)
    {
      int d = base11[i] - '0';
      if ((i % 2) == 0) sumOdd += d; else sumEven += d;
    }
    int total = sumOdd * 3 + sumEven;
    int dv = (10 - (total % 10)) % 10;
    return base11 + dv.ToString();
  }

  private string GenerarCode128()
  {
    if (etiquetaProducto != null)
    {
      if (!string.IsNullOrWhiteSpace(etiquetaProducto.CodigoInterno)) return etiquetaProducto.CodigoInterno;
      if (etiquetaProducto.IdProducto > 0) return $"PROD-{etiquetaProducto.IdSucursal:000}-{etiquetaProducto.IdProducto:000000}";
    }
    return $"PROD-{DateTime.UtcNow:yyyyMMddHHmmss}";
  }

  private async Task<string?> GuardarImagenPendienteAsync()
  {
    if (pendingImage is null) return null;
    var file = pendingImage;
    var uploads = Path.Combine(Env.WebRootPath, "uploads", "productos");
    Directory.CreateDirectory(uploads);
    var ext = Path.GetExtension(file.Name);
    if (string.IsNullOrWhiteSpace(ext))
    {
      ext = file.ContentType switch
      {
        "image/png" => ".png",
        "image/jpeg" => ".jpg",
        "image/webp" => ".webp",
        "image/gif" => ".gif",
        "image/svg+xml" => ".svg",
        _ => ".img"
      };
    }
    var name = $"{Guid.NewGuid():N}{ext.ToLower()}";
    var path = Path.Combine(uploads, name);
    await using (var stream = File.Create(path))
    {
      await file.OpenReadStream(maxAllowedSize: 2 * 1024 * 1024).CopyToAsync(stream);
    }
    return $"/uploads/productos/{name}";
  }

  // Stocks por dep√≥sito
  private bool mostrarStocks = false;
  private Models.Producto? productoStocks;
  private IReadOnlyList<Models.ProductoDeposito>? stocksDepositos;
  private async Task AbrirStocks(Models.Producto p)
  {
    productoStocks = p;
    mostrarStocks = true;
    stocksDepositos = null;
    try
    {
      stocksDepositos = await Inventario.ObtenerStocksPorProductoAsync(p.IdProducto);
    }
    catch { stocksDepositos = Array.Empty<Models.ProductoDeposito>(); }
    StateHasChanged();
  }
  private void CerrarStocks()
  {
    mostrarStocks = false;
    productoStocks = null;
    stocksDepositos = null;
  }
}

</PageProtection>
}
