@page "/productos"
@inject IDbContextFactory<AppDbContext> DbFactory
@inject IJSRuntime JS
@inject IWebHostEnvironment Env
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject SistemIA.Services.PermisosService PermisosService
@using Microsoft.AspNetCore.Components.Forms
@using Microsoft.EntityFrameworkCore
@using System.Linq
@using System.IO
@using Models = SistemIA.Models
@using Microsoft.AspNetCore.Components.Web
@inject SistemIA.Services.IInventarioService Inventario

<PageProtection Modulo="/productos" Permiso="VIEW">

<div class="container-fluid">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2 class="text-primary mb-0"><i class="bi bi-box-seam me-2"></i>Productos</h2>
    <div class="d-flex gap-2">
      <button class="btn btn-primary" @onclick="NuevoProducto"><i class="bi bi-plus-circle me-2"></i>Nuevo</button>
      <button class="btn btn-success" @onclick="Cargar"><i class="bi bi-arrow-clockwise me-2"></i>Actualizar</button>
    </div>
  </div>

  <div class="card mb-3">
    <div class="card-header">Filtros</div>
    <div class="card-body">
      <div class="row g-2">
        <div class="col-md-3"><input class="form-control" placeholder="Buscar por descripci√≥n, c√≥digo o barras" @bind="filtro" @bind:after="Filtrar" /></div>
        <div class="col-md-2">
          <select class="form-select" @bind="filtroDeposito" @bind:after="Filtrar">
            <option value="">Todos los dep√≥sitos</option>
            @foreach (var dep in depositos)
            {
              <option value="@dep.IdDeposito">@dep.Nombre</option>
            }
          </select>
        </div>
        <div class="col-md-2">
          <select class="form-select" @bind="filtroIva" @bind:after="Filtrar">
            <option value="">Todos los IVA</option>
            @foreach (var iva in tiposIva)
            {
              <option value="@iva.IdTipoIva">@iva.DescripcionCompleta</option>
            }
          </select>
        </div>
        <div class="col-md-2">
          <select class="form-select" @bind="filtroTipoItem" @bind:after="Filtrar">
            <option value="">Todos los tipos</option>
            @foreach (var tipo in tiposItem)
            {
              <option value="@tipo.IdTipoItem">@tipo.Nombre</option>
            }
          </select>
        </div>
        <div class="col-md-1">
          <select class="form-select" @bind="soloActivos" @bind:after="Filtrar">
            <option value="true">Activos</option>
            <option value="false">Todos</option>
          </select>
        </div>
        <div class="col-md-2">
          <div class="form-check mt-2">
            <input class="form-check-input" type="checkbox" id="filtroStockBajo" @bind="soloStockBajo" @bind:after="Filtrar" />
            <label class="form-check-label text-warning small" for="filtroStockBajo">
              <i class="bi bi-exclamation-triangle-fill me-1"></i>Solo stock bajo
            </label>
          </div>
        </div>
        <div class="col-md-1 text-end"><span class="badge bg-primary">@filtrados.Count registro(s)</span></div>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="table-responsive">
      <table class="table table-hover align-middle mb-0 productos-table">
        <thead class="table-dark">
          <tr>
            <th class="col-foto" style="width:64px">Foto</th>
            <th class="col-codigo">C√≥digo</th>
            <th class="col-descripcion">Descripci√≥n</th>
            <th class="col-unidad">Unidad</th>
            <th class="col-iva">IVA</th>
            <th class="col-costo text-end">Costo Gs</th>
            <th class="col-precio text-end">Precio Gs</th>
            @if (MostrarPrecioMinisterio)
            {
              <th class="col-pmin text-end">P.Min.</th>
            }
            <th class="col-stock text-end">Stock</th>
            <th class="col-marca">Marca</th>
            <th class="col-sucursal">Sucursal</th>
            <th class="col-vencimiento">Vencimiento</th>
            <th class="col-estado">Estado</th>
            <th class="col-acciones" style="width:120px">Acciones</th>
          </tr>
        </thead>
        <tbody>
          @foreach (var p in ProductosPagina)
          {
            <tr>
              <td class="col-foto">
                <img src="@(string.IsNullOrWhiteSpace(p.Foto) ? "/images/placeholder-product.svg" : p.Foto)" alt="img" style="width:48px;height:48px;object-fit:cover;border-radius:6px;border:1px solid #ddd" />
              </td>
              <td class="col-codigo"><span class="badge bg-secondary">@p.CodigoInterno</span></td>
              <td class="col-descripcion">
                <strong>@p.Descripcion</strong>
                @if (!string.IsNullOrWhiteSpace(p.CodigoBarras))
                {
                  <div class="text-muted small">C√≥digo de barras: @p.CodigoBarras</div>
                }
              </td>
              <td class="col-unidad">
                @p.UnidadMedidaCodigo
                @if ((p.UnidadMedidaCodigo == "006" || p.UnidadMedidaCodigo == "005") && p.CantidadPorPaquete.HasValue && p.CantidadPorPaquete > 1)
                {
                  <br/><small class="text-muted">(@p.CantidadPorPaquete.Value.ToString("N0") u/paq)</small>
                }
              </td>
              <td class="col-iva">@p.TipoIva?.DescripcionCompleta</td>
              <td class="col-costo text-end">
                @(p.CostoUnitarioGs.HasValue ? p.CostoUnitarioGs.Value.ToString("N0") : "-")
                @if ((p.UnidadMedidaCodigo == "006") && p.CantidadPorPaquete.HasValue && p.CantidadPorPaquete > 1 && p.CostoPaqueteGs.HasValue && p.CostoPaqueteGs > 0)
                {
                  <br/><small class="text-success">Paq: @p.CostoPaqueteGs.Value.ToString("N0")</small>
                }
              </td>
        <td class="col-precio text-end">
          @p.PrecioUnitarioGs.ToString("N0")
          @if ((p.UnidadMedidaCodigo == "006") && p.CantidadPorPaquete.HasValue && p.CantidadPorPaquete > 1 && p.PrecioPaqueteGs.HasValue && p.PrecioPaqueteGs > 0)
          {
            <br/><small class="text-primary fw-semibold">Paq: @p.PrecioPaqueteGs.Value.ToString("N0")</small>
          }
        </td>
        @if (MostrarPrecioMinisterio)
        {
          <td class="col-pmin text-end">
            @(p.PrecioMinisterio?.ToString("N0") ?? "‚Äî")
            @if ((p.UnidadMedidaCodigo == "006") && p.CantidadPorPaquete.HasValue && p.CantidadPorPaquete > 1 && p.PrecioMinisterioPaquete.HasValue && p.PrecioMinisterioPaquete > 0)
            {
              <br/><small class="text-info">Paq: @p.PrecioMinisterioPaquete.Value.ToString("N0")</small>
            }
          </td>
        }
        <td class="col-stock text-end">
          @{
            var stocksDeposito = stocksPorProductoDeposito.ContainsKey(p.IdProducto) ? stocksPorProductoDeposito[p.IdProducto] : new List<(string Deposito, decimal Stock)>();
            
            // Si hay filtro de dep√≥sito, mostrar solo el stock de ese dep√≥sito
            decimal stockMostrar;
            string tooltip;
            bool mostrarIconoMultiple = false;
            
            if (!string.IsNullOrEmpty(filtroDeposito))
            {
              var depositoSel = depositos.FirstOrDefault(d => d.IdDeposito.ToString() == filtroDeposito);
              var stockDelDeposito = stocksDeposito.FirstOrDefault(s => s.Deposito == depositoSel?.Nombre);
              stockMostrar = stockDelDeposito.Stock;
              tooltip = $"{depositoSel?.Nombre ?? "Dep√≥sito"}: {stockMostrar:N2}";
            }
            else
            {
              stockMostrar = stocksDeposito.Sum(s => s.Stock);
              tooltip = string.Join("\n", stocksDeposito.Where(s => s.Stock != 0).Select(s => $"{s.Deposito}: {s.Stock:N2}"));
              mostrarIconoMultiple = stocksDeposito.Count(s => s.Stock > 0) > 1;
            }
            
            // Calcular paquetes si aplica
            var esPaqueteProd = (p.UnidadMedidaCodigo == "006" || p.UnidadMedidaCodigo == "005") && p.CantidadPorPaquete.HasValue && p.CantidadPorPaquete > 1;
            var cantPaqProd = p.CantidadPorPaquete ?? 1;
          }
          <span class="@(stockMostrar < p.StockMinimo ? "text-danger fw-semibold" : stockMostrar == 0 ? "text-muted" : "text-success fw-semibold")" 
                title="@tooltip" 
                style="cursor: help;">
            @if (p.StockMinimo > 0 && stockMostrar <= p.StockMinimo)
            {
              <i class="bi bi-exclamation-triangle-fill text-warning me-1" title="Stock bajo m√≠nimo (@p.StockMinimo.ToString("N0"))"></i>
            }
            @stockMostrar.ToString("N0")
            @if (mostrarIconoMultiple)
            {
              <i class="bi bi-info-circle-fill text-info ms-1" style="font-size: 0.8em;"></i>
            }
          </span>
          @if (esPaqueteProd && stockMostrar > 0)
          {
            var numPaq = Math.Floor(stockMostrar / cantPaqProd);
            var unidadesSuel = stockMostrar % cantPaqProd;
            <br/><small class="text-muted">@numPaq.ToString("N0") paq.@(unidadesSuel > 0 ? $" + {unidadesSuel:N0} u." : "")</small>
          }
        </td>
              <td class="col-marca">@p.Marca?.NombreMarca</td>
              <td class="col-sucursal">@p.Sucursal?.NombreSucursal</td>
              <td class="col-vencimiento">
                @if (p.ControlarVencimiento && p.FechaVencimiento.HasValue)
                {
                  var diasRestantes = (p.FechaVencimiento.Value - DateTime.Now).Days;
                  var claseColor = diasRestantes < 0 ? "text-danger" : diasRestantes <= 30 ? "text-warning" : "text-success";
                  <span class="@claseColor fw-semibold">
                    @p.FechaVencimiento.Value.ToString("dd/MM/yyyy")
                    @if (diasRestantes < 0)
                    {
                      <span class="badge bg-danger ms-1">Vencido</span>
                    }
                    else if (diasRestantes <= 30)
                    {
                      <span class="badge bg-warning ms-1">@diasRestantes d√≠as</span>
                    }
                  </span>
                }
                else
                {
                  <span class="text-muted">-</span>
                }
              </td>
              <td class="col-estado">@(p.Activo ? "Activo" : "Inactivo")</td>
              <td class="col-acciones">
                <div class="btn-group btn-group-sm">
                  @if (p.ControlaLote)
                  {
                    <button class="btn btn-outline-success" title="Ver Lotes" @onclick="() => AbrirLotesDesdeExplorador(p)"><i class="bi bi-collection"></i></button>
                  }
                  <button class="btn btn-outline-info" title="Ver stock por dep√≥sito" @onclick="() => AbrirStocks(p)"><i class="bi bi-box-seam"></i></button>
                  <button class="btn btn-outline-secondary" title="Etiqueta" @onclick="() => AbrirEtiqueta(p)"><i class="bi bi-upc"></i></button>
                  <button class="btn btn-warning" title="Editar" @onclick="() => Editar(p)"><i class="bi bi-pencil-square"></i></button>
                  <button class="btn btn-danger" title="Eliminar" @onclick="() => Eliminar(p)"><i class="bi bi-trash"></i></button>
                </div>
              </td>
            </tr>
          }
        </tbody>
      </table>
    </div>
    
    @* ========== PAGINACI√ìN ========== *@
    @if (TotalPaginas > 1)
    {
      <div class="card-footer d-flex justify-content-between align-items-center py-2">
        <small class="text-muted">
          Mostrando @((paginaActual - 1) * registrosPorPagina + 1)-@Math.Min(paginaActual * registrosPorPagina, filtrados.Count) de @filtrados.Count productos
        </small>
        <nav>
          <ul class="pagination pagination-sm mb-0">
            <li class="page-item @(paginaActual == 1 ? "disabled" : "")">
              <button class="page-link" @onclick="() => IrPagina(1)" disabled="@(paginaActual == 1)">
                <i class="bi bi-chevron-double-left"></i>
              </button>
            </li>
            <li class="page-item @(paginaActual == 1 ? "disabled" : "")">
              <button class="page-link" @onclick="() => IrPagina(paginaActual - 1)" disabled="@(paginaActual == 1)">
                <i class="bi bi-chevron-left"></i>
              </button>
            </li>
            @for (int i = Math.Max(1, paginaActual - 2); i <= Math.Min(TotalPaginas, paginaActual + 2); i++)
            {
              var pagina = i;
              <li class="page-item @(pagina == paginaActual ? "active" : "")">
                <button class="page-link" @onclick="() => IrPagina(pagina)">@pagina</button>
              </li>
            }
            <li class="page-item @(paginaActual == TotalPaginas ? "disabled" : "")">
              <button class="page-link" @onclick="() => IrPagina(paginaActual + 1)" disabled="@(paginaActual == TotalPaginas)">
                <i class="bi bi-chevron-right"></i>
              </button>
            </li>
            <li class="page-item @(paginaActual == TotalPaginas ? "disabled" : "")">
              <button class="page-link" @onclick="() => IrPagina(TotalPaginas)" disabled="@(paginaActual == TotalPaginas)">
                <i class="bi bi-chevron-double-right"></i>
              </button>
            </li>
          </ul>
        </nav>
      </div>
    }
    else if (filtrados.Count > 0)
    {
      <div class="card-footer py-2">
        <small class="text-muted">Mostrando @filtrados.Count producto(s)</small>
      </div>
    }
  </div>

  <!-- Modal Producto -->
  <div class="modal fade @(mostrarModal ? "show" : "")" style="display:@(mostrarModal?"block":"none")" tabindex="-1">
    <div class="modal-dialog" style="max-width: 95%; width: 1400px;">
      <div class="modal-content">
        <div class="modal-header bg-primary text-white py-2">
          <h5 class="modal-title">
            <i class="bi @(editando.IdProducto > 0 ? "bi-pencil-square" : "bi-plus-circle") me-2"></i>
            @(editando.IdProducto > 0 ? "Editar Producto" : "Nuevo Producto")
            @if (editando.IdProducto > 0)
            {
              <span class="badge bg-light text-primary ms-2">ID: @editando.IdProducto</span>
            }
          </h5>
          <button type="button" class="btn-close btn-close-white" @onclick="Cerrar"></button>
        </div>
        <div class="modal-body p-4">
          <EditForm Model="editando" OnValidSubmit="@Guardar">
            <DataAnnotationsValidator />
            <ValidationSummary />
            
            <div class="row">
              <!-- COLUMNA IZQUIERDA: Informaci√≥n principal -->
              <div class="col-lg-8">
                
                @* ========== CARD: INFORMACI√ìN B√ÅSICA ========== *@
                <div class="card mb-3 border-primary">
                  <div class="card-header bg-primary bg-opacity-10 py-2">
                    <h6 class="mb-0 text-primary"><i class="bi bi-info-circle me-2"></i>Informaci√≥n B√°sica</h6>
                  </div>
                  <div class="card-body">
                    <div class="row g-3">
                      <div class="col-md-3">
                        <label class="form-label small fw-semibold">C√≥digo (dCodInt)</label>
                        <input type="text" class="form-control form-control-sm" value="@(string.IsNullOrEmpty(editando.CodigoInterno) ? "Autom√°tico" : editando.CodigoInterno)" disabled style="background-color: var(--bs-secondary-bg);" />
                      </div>
                      <div class="col-md-6">
                        <label class="form-label small fw-semibold">Descripci√≥n *</label>
                        <InputText class="form-control" @bind-Value="editando.Descripcion" placeholder="Nombre del producto o servicio" />
                      </div>
                      <div class="col-md-3">
                        <label class="form-label small fw-semibold">C√≥digo de Barras</label>
                        <InputText class="form-control form-control-sm" @bind-Value="editando.CodigoBarras" placeholder="GTIN-8/12/13/14" />
                      </div>
                    </div>
                  </div>
                </div>
              
                @* ========== CARD: CLASIFICACI√ìN Y UNIDADES ========== *@
                <div class="card mb-3">
                  <div class="card-header bg-light py-2">
                    <h6 class="mb-0"><i class="bi bi-tags me-2"></i>Clasificaci√≥n y Unidades</h6>
                  </div>
                  <div class="card-body">
                    <div class="row g-3">
                      <div class="col-md-3">
                        <label class="form-label small fw-semibold">Tipo √çtem</label>
                        <div class="input-group input-group-sm">
                          <select class="form-select" @bind="editando.TipoItem">
                            @foreach (var t in tiposItem)
                            {
                              <option value="@t.IdTipoItem">@t.Nombre@(t.EsGasto ? " (Gasto)" : string.Empty)</option>
                            }
                          </select>
                          <button class="btn btn-outline-secondary" type="button" title="Nuevo tipo" @onclick="AbrirNuevoTipoItem">+</button>
                        </div>
                      </div>
                      <div class="col-md-3">
                        <label class="form-label small fw-semibold">Marca</label>
                        <div class="input-group input-group-sm">
                          <select class="form-select" @bind="editando.IdMarca">
                            <option value="">(Sin marca)</option>
                            @foreach (var m in marcas)
                            {
                              <option value="@m.IdMarca">@m.NombreMarca</option>
                            }
                          </select>
                          <button class="btn btn-outline-secondary" type="button" title="Nueva marca" @onclick="AbrirNuevaMarca">+</button>
                        </div>
                      </div>
                      <div class="col-md-3">
                        <label class="form-label small fw-semibold">Clasificaci√≥n</label>
                        <div class="input-group input-group-sm">
                          <select class="form-select" @bind="editando.IdClasificacion">
                            <option value="">(Sin clasificaci√≥n)</option>
                            @foreach (var c in clasificaciones)
                            {
                              <option value="@c.IdClasificacion">@c.Nombre</option>
                            }
                          </select>
                          <button class="btn btn-outline-secondary" type="button" title="Nueva clasificaci√≥n" @onclick="AbrirNuevaClasificacion">+</button>
                        </div>
                      </div>
                      <div class="col-md-3">
                        <label class="form-label small fw-semibold">Dep√≥sito Predeterminado</label>
                        <select class="form-select form-select-sm" @bind="editando.IdDepositoPredeterminado">
                          <option value="">(Ninguno)</option>
                          @foreach (var d in depositosCombo)
                          {
                            <option value="@d.IdDeposito">@d.Nombre (@(d.Sucursal?.NombreSucursal ?? $"Suc {d.IdSucursal}"))</option>
                          }
                        </select>
                      </div>

                      <div class="col-md-3">
                        <label class="form-label small fw-semibold">Unidad de Medida *</label>
                        <select class="form-select form-select-sm" value="@editando.UnidadMedidaCodigo" @onchange="OnUnidadMedidaChanged">
                          <option value="77">77 - Unidad</option>
                          <option value="006">006 - Paquete</option>
                        </select>
                      </div>
                      <div class="col-md-3">
                        <label class="form-label small fw-semibold">Tipo de IVA *</label>
                        <select class="form-select form-select-sm" @bind="editando.IdTipoIva">
                          @foreach (var iva in tiposIva)
                          {
                            <option value="@iva.IdTipoIva">@iva.DescripcionCompleta</option>
                          }
                        </select>
                      </div>
                      <div class="col-md-3">
                        <label class="form-label small fw-semibold">Moneda Precio</label>
                        <select class="form-select form-select-sm" @bind="editando.IdMonedaPrecio">
                          <option value="">(PYG por defecto)</option>
                          @foreach (var m in monedas)
                          {
                            <option value="@m.IdMoneda">@m.Nombre (@m.CodigoISO)</option>
                          }
                        </select>
                      </div>
                      @if (editando.UnidadMedidaCodigo == "006" || editando.UnidadMedidaCodigo == "005")
                      {
                        <div class="col-md-3">
                          <label class="form-label small fw-semibold">üì¶ Cant. por @(editando.UnidadMedidaCodigo == "006" ? "Paquete" : "Caja") *</label>
                          <input type="number" class="form-control form-control-sm" min="1" step="1" 
                                 value="@(editando.CantidadPorPaquete?.ToString(System.Globalization.CultureInfo.InvariantCulture) ?? "")" 
                                 @onchange="OnCantidadPorPaqueteChanged" placeholder="Ej: 10" />
                        </div>
                      }
                    </div>
                  </div>
                </div>
              
                @* ========== CARD: PRECIOS ========== *@
                <div class="card mb-3 border-success">
                  <div class="card-header bg-success bg-opacity-10 py-2">
                    <h6 class="mb-0 text-success"><i class="bi bi-currency-dollar me-2"></i>Precios y Costos</h6>
                  </div>
                  <div class="card-body">
                    @* Precios por Paquete - solo si es Paquete o Caja *@
                    @if (editando.UnidadMedidaCodigo == "006" || editando.UnidadMedidaCodigo == "005")
                    {
                      <div class="row g-2 mb-3 pb-3 border-bottom">
                        <div class="col-12">
                          <span class="badge bg-success">
                            üì¶ @(editando.UnidadMedidaCodigo == "006" ? "PAQUETE" : "CAJA")
                            @if (editando.CantidadPorPaquete.HasValue && editando.CantidadPorPaquete > 1)
                            {
                              <text> (@editando.CantidadPorPaquete.Value u/paq)</text>
                            }
                          </span>
                        </div>
                        <div class="col-md-3">
                          <label class="form-label small">Costo Paq. Gs</label>
                          <input type="text" inputmode="numeric" class="form-control form-control-sm" 
                                 value="@(editando.CostoPaqueteGs.HasValue ? ((long)editando.CostoPaqueteGs.Value).ToString(System.Globalization.CultureInfo.InvariantCulture) : "")" 
                                 @onchange="OnCostoPaqueteChanged" />
                        </div>
                        <div class="col-md-2">
                          <label class="form-label small">Factor</label>
                          <input type="text" inputmode="decimal" class="form-control form-control-sm" 
                                 value="@(factorPrecioPaquete?.ToString(System.Globalization.CultureInfo.InvariantCulture))" 
                                 @onchange="OnFactorPaqueteChanged" placeholder="1.25" />
                        </div>
                        <div class="col-md-2">
                          <label class="form-label small">% Mark-up</label>
                          <input type="text" inputmode="decimal" class="form-control form-control-sm" 
                                 value="@(porcentajePrecioPaquete?.ToString(System.Globalization.CultureInfo.InvariantCulture))" 
                                 @onchange="OnPorcentajePaqueteChanged" placeholder="25" />
                          @{
                            decimal? pctUtilidadPaq = null;
                            if (editando.CostoPaqueteGs.HasValue && editando.CostoPaqueteGs.Value > 0 && editando.PrecioPaqueteGs.HasValue && editando.PrecioPaqueteGs > 0)
                            {
                              pctUtilidadPaq = ((editando.PrecioPaqueteGs.Value - editando.CostoPaqueteGs.Value) / editando.PrecioPaqueteGs.Value) * 100;
                            }
                            var colorUtilidadPaq = pctUtilidadPaq.HasValue ? (pctUtilidadPaq.Value >= 25 ? "text-success" : "text-danger") : "text-muted";
                          }
                          <small class="@colorUtilidadPaq">Util: @(pctUtilidadPaq.HasValue ? $"{pctUtilidadPaq.Value:N1}%" : "‚Äî")</small>
                        </div>
                        <div class="col-md-3">
                          <label class="form-label small">Precio Paq. Gs</label>
                          <input type="text" inputmode="numeric" class="form-control form-control-sm @(ValidarPrecioMinisterio && editando.PrecioMinisterioPaquete.HasValue && editando.PrecioPaqueteGs.HasValue && editando.PrecioPaqueteGs > editando.PrecioMinisterioPaquete ? "is-invalid" : "")" 
                                 value="@(editando.PrecioPaqueteGs.HasValue ? ((long)editando.PrecioPaqueteGs.Value).ToString() : "")" 
                                 @onchange="OnPrecioPaqueteChanged" />
                          @if (ValidarPrecioMinisterio && editando.PrecioMinisterioPaquete.HasValue && editando.PrecioPaqueteGs.HasValue && editando.PrecioPaqueteGs > editando.PrecioMinisterioPaquete)
                          {
                            <div class="invalid-feedback">M√°x: @editando.PrecioMinisterioPaquete.Value.ToString("N0")</div>
                          }
                        </div>
                        @if (MostrarPrecioMinisterio)
                        {
                          <div class="col-md-2">
                            <label class="form-label small">P.Min. Paq.</label>
                            <input type="text" inputmode="numeric" class="form-control form-control-sm" 
                                   value="@(editando.PrecioMinisterioPaquete.HasValue ? ((long)editando.PrecioMinisterioPaquete.Value).ToString() : "")" 
                                   @onchange="OnPrecioMinisterioPaqueteChanged" />
                          </div>
                        }
                      </div>
                    }
                    
                    @* Precios Unitarios *@
                    <div class="row g-2">
                      <div class="col-12">
                        <span class="badge bg-primary">üè∑Ô∏è UNITARIO</span>
                        @if (editando.EsCombo && costoCalculadoComponentes.HasValue)
                        {
                          <small class="text-success ms-2"><i class="bi bi-boxes me-1"></i>Combo: costo calculado desde componentes = Gs @costoCalculadoComponentes.Value.ToString("N0")</small>
                        }
                        else if ((editando.UnidadMedidaCodigo == "006" || editando.UnidadMedidaCodigo == "005") && editando.CantidadPorPaquete.HasValue)
                        {
                          <small class="text-muted ms-2">(costo calculado desde paquete)</small>
                        }
                      </div>
                      <div class="col-md-3">
                        <label class="form-label small">Costo Unit. Gs @(editando.EsCombo ? "(editable)" : "")</label>
                        <input type="text" inputmode="numeric" class="form-control form-control-sm @(editando.UnidadMedidaCodigo == "006" || editando.UnidadMedidaCodigo == "005" ? "bg-light" : "") @(editando.EsCombo && costoCalculadoComponentes.HasValue && editando.CostoUnitarioGs != costoCalculadoComponentes ? "border-warning" : "")" 
                               value="@(editando.CostoUnitarioGs.HasValue ? editando.CostoUnitarioGs.Value.ToString("N2", System.Globalization.CultureInfo.InvariantCulture) : "")" 
                               @onchange="OnCostoChanged" 
                               readonly="@(editando.UnidadMedidaCodigo == "006" || editando.UnidadMedidaCodigo == "005")" />
                        @if ((editando.UnidadMedidaCodigo == "006" || editando.UnidadMedidaCodigo == "005") && editando.CostoPaqueteGs.HasValue && editando.CantidadPorPaquete.HasValue && editando.CantidadPorPaquete > 0)
                        {
                          <small class="text-info">= @editando.CostoPaqueteGs.Value.ToString("N0") √∑ @editando.CantidadPorPaquete.Value</small>
                        }
                        @if (editando.EsCombo && costoCalculadoComponentes.HasValue && editando.CostoUnitarioGs != costoCalculadoComponentes)
                        {
                          <small class="text-warning d-block"><i class="bi bi-exclamation-triangle me-1"></i>Difiere del calculado</small>
                        }
                      </div>
                      <div class="col-md-2">
                        <label class="form-label small">Factor</label>
                        <input type="text" inputmode="decimal" class="form-control form-control-sm" 
                               value="@(factorPrecio?.ToString(System.Globalization.CultureInfo.InvariantCulture))" 
                               @onchange="OnFactorChanged" placeholder="1.30" />
                      </div>
                      <div class="col-md-2">
                        <label class="form-label small">% Mark-up</label>
                        <input type="text" inputmode="decimal" class="form-control form-control-sm" 
                               value="@(porcentajePrecio?.ToString(System.Globalization.CultureInfo.InvariantCulture))" 
                               @onchange="OnPorcentajeChanged" placeholder="30" />
                        @{
                          decimal? pctUtilidad = null;
                          if (editando.CostoUnitarioGs.HasValue && editando.CostoUnitarioGs.Value > 0 && editando.PrecioUnitarioGs > 0)
                          {
                            pctUtilidad = ((editando.PrecioUnitarioGs - editando.CostoUnitarioGs.Value) / editando.PrecioUnitarioGs) * 100;
                          }
                          var colorUtilidad = pctUtilidad.HasValue ? (pctUtilidad.Value >= 30 ? "text-primary" : "text-danger") : "text-muted";
                        }
                        <small class="@colorUtilidad">Util: @(pctUtilidad.HasValue ? $"{pctUtilidad.Value:N1}%" : "‚Äî")</small>
                      </div>
                      <div class="col-md-3">
                        <label class="form-label small">Precio Unit. Gs *</label>
                        <input type="text" inputmode="numeric" class="form-control form-control-sm @(ValidarPrecioMinisterio && editando.PrecioMinisterio.HasValue && editando.PrecioUnitarioGs > editando.PrecioMinisterio ? "is-invalid" : "")" 
                               value="@((long)editando.PrecioUnitarioGs)" 
                               @onchange="OnPrecioChanged" />
                        @if (ValidarPrecioMinisterio && editando.PrecioMinisterio.HasValue && editando.PrecioUnitarioGs > editando.PrecioMinisterio)
                        {
                          <div class="invalid-feedback">M√°x: @editando.PrecioMinisterio.Value.ToString("N0")</div>
                        }
                        @if ((editando.UnidadMedidaCodigo == "006" || editando.UnidadMedidaCodigo == "005") && editando.PrecioPaqueteGs.HasValue && editando.CantidadPorPaquete.HasValue && editando.CantidadPorPaquete > 0)
                        {
                          <small class="text-muted">Sug: @(Math.Round(editando.PrecioPaqueteGs.Value / editando.CantidadPorPaquete.Value, 0).ToString("N0"))</small>
                        }
                      </div>
                      @if (MostrarPrecioMinisterio)
                      {
                        <div class="col-md-2">
                          <label class="form-label small">P. Ministerio</label>
                          <input type="text" inputmode="numeric" class="form-control form-control-sm" 
                                 value="@(editando.PrecioMinisterio.HasValue ? ((long)editando.PrecioMinisterio.Value).ToString() : "")" 
                                 @onchange="OnPrecioMinisterioChanged" />
                          @if ((editando.UnidadMedidaCodigo == "006" || editando.UnidadMedidaCodigo == "005") && editando.PrecioMinisterioPaquete.HasValue && editando.CantidadPorPaquete.HasValue && editando.CantidadPorPaquete > 0)
                          {
                            <small class="text-muted">Sug: @(Math.Round(editando.PrecioMinisterioPaquete.Value / editando.CantidadPorPaquete.Value, 0).ToString("N0"))</small>
                          }
                        </div>
                      }
                    </div>
                  </div>
                </div>
                
                @* ========== CARD: COMBO ========== *@
                @if (editando.EsCombo)
                {
                  <div class="card mb-3">
                    <div class="card-header bg-light py-2">
                      <h6 class="mb-0"><i class="bi bi-boxes me-2"></i>Combo - Componentes</h6>
                    </div>
                    <div class="card-body">
                      @if (editando.IdProducto == 0)
                      {
                        <div class="alert alert-info py-2 mb-0">Guarde el producto para poder agregar componentes.</div>
                      }
                      else
                      {
                        <div class="row g-2 align-items-end mb-2">
                          <div class="col-md-5">
                            <label class="form-label small">Producto componente</label>
                            <div class="position-relative">
                              <input class="form-control form-control-sm" placeholder="Escriba nombre o c√≥digo..." value="@componenteSearch" @oninput="OnComponenteSearchChanged" @onfocus="ShowComponenteOpciones" @onblur="OnComponenteBlur" @onkeydown="OnComponenteKeyDown" />
                              @if (mostrandoOpciones && componenteOpciones.Count > 0)
                              {
                                <div class="list-group position-absolute w-100 shadow-sm bg-white" style="z-index:1000; max-height:200px; overflow:auto;">
                                  @for (int i = 0; i < componenteOpciones.Count; i++)
                                  {
                                    var pr = componenteOpciones[i];
                                    var itemClass = $"list-group-item list-group-item-action py-1 d-flex justify-content-between align-items-center {(i == selectedOptionIndex ? "active" : string.Empty)}";
                                    <button type="button" class="@itemClass" @onmousedown="(() => SeleccionarComponente(pr))" @onclick="(() => SeleccionarComponente(pr))">
                                      <span class="small">@pr.Descripcion</span>
                                      <small class="text-muted">@pr.UnidadMedidaCodigo</small>
                                    </button>
                                  }
                                </div>
                              }
                            </div>
                          </div>
                          <div class="col-md-3">
                            <label class="form-label small">Cantidad</label>
                            <input class="form-control form-control-sm" type="number" step="0.0001" @bind="cantidadComponente" />
                          </div>
                          <div class="col-md-4 text-end">
                            <button type="button" class="btn btn-outline-primary btn-sm" @onclick="AgregarComponente" disabled="@(selectedComponenteId==0 || cantidadComponente<=0)">
                              <i class="bi bi-plus-circle me-1"></i>Agregar
                            </button>
                          </div>
                        </div>
                        @if (componentesCombo.Count > 0)
                        {
                          <div class="table-responsive">
                            <table class="table table-sm table-striped mb-0">
                              <thead class="table-light">
                                <tr>
                                  <th>Componente</th>
                                  <th class="text-end">Cantidad</th>
                                  <th class="text-end">Costo Unit.</th>
                                  <th class="text-end">Subtotal</th>
                                  <th style="width:40px"></th>
                                </tr>
                              </thead>
                              <tbody>
                                @foreach (var pc in componentesCombo)
                                {
                                  var costoComp = pc.Componente?.CostoUnitarioGs ?? 0;
                                  var subtotalComp = costoComp * pc.Cantidad;
                                  <tr>
                                    <td class="small">@pc.Componente?.Descripcion</td>
                                    <td class="text-end small">@pc.Cantidad.ToString("N4") @(pc.Componente?.UndMedida?.Trim())</td>
                                    <td class="text-end small">@costoComp.ToString("N0")</td>
                                    <td class="text-end small fw-bold">@subtotalComp.ToString("N0")</td>
                                    <td>
                                      <button type="button" class="btn btn-sm btn-outline-danger py-0 px-1" @onclick="() => QuitarComponente(pc.IdProductoComponente)"><i class="bi bi-trash"></i></button>
                                    </td>
                                  </tr>
                                }
                              </tbody>
                              <tfoot class="table-light">
                                <tr>
                                  <td colspan="3" class="text-end fw-bold">Costo Total Calculado:</td>
                                  <td class="text-end fw-bold text-primary">Gs @(costoCalculadoComponentes?.ToString("N0") ?? "0")</td>
                                  <td></td>
                                </tr>
                              </tfoot>
                            </table>
                          </div>
                          <div class="d-flex justify-content-between align-items-center mt-2">
                            <small class="text-muted">El costo del combo se calcula sumando el costo de los componentes √ó cantidad</small>
                            <button type="button" class="btn btn-sm btn-outline-success" @onclick="AplicarCostoCalculado" title="Aplicar costo calculado al producto">
                              <i class="bi bi-calculator me-1"></i>Aplicar Costo
                            </button>
                          </div>
                        }
                      }
                    </div>
                  </div>
                }
                
              </div><!-- Fin columna izquierda -->
              
              <!-- COLUMNA DERECHA: Opciones y configuraci√≥n -->
              <div class="col-lg-4">
                
                @* ========== CARD: IMAGEN ========== *@
                <div class="card mb-3">
                  <div class="card-header bg-light py-2">
                    <h6 class="mb-0"><i class="bi bi-image me-2"></i>Imagen</h6>
                  </div>
                  <div class="card-body text-center">
                    <img src="@(previewDataUrl ?? (string.IsNullOrWhiteSpace(editando.Foto) ? "/images/placeholder-product.svg" : editando.Foto))" 
                         alt="preview" class="img-thumbnail mb-2" style="width:120px;height:120px;object-fit:cover;" />
                    <InputFile class="form-control form-control-sm" OnChange="OnFileSelected" accept="image/*" />
                    <small class="text-muted d-block mt-1">PNG/JPG/WEBP hasta 2 MB</small>
                  </div>
                </div>
                
                @* ========== CARD: ESTADO Y OPCIONES ========== *@
                <div class="card mb-3">
                  <div class="card-header bg-light py-2">
                    <h6 class="mb-0"><i class="bi bi-toggles me-2"></i>Estado y Opciones</h6>
                  </div>
                  <div class="card-body">
                    <div class="form-check form-switch mb-2">
                      <input class="form-check-input" type="checkbox" id="activoSwitch2" @bind="editando.Activo" />
                      <label class="form-check-label" for="activoSwitch2"><i class="bi bi-check-circle text-success me-1"></i>Activo</label>
                    </div>
                    <div class="form-check form-switch mb-2">
                      <input class="form-check-input" type="checkbox" id="permiteDecimalSwitch2" @bind="editando.PermiteDecimal" />
                      <label class="form-check-label" for="permiteDecimalSwitch2"><i class="bi bi-distribute-vertical me-1"></i>Permite Decimal</label>
                    </div>
                    @{
                      var esPaqueteOCaja = editando.UnidadMedidaCodigo?.Trim() == "006" || editando.UnidadMedidaCodigo?.Trim() == "005";
                    }
                    @if (esPaqueteOCaja)
                    {
                      <div class="form-check form-switch mb-2">
                        <input class="form-check-input" type="checkbox" id="permiteVentaUnidadSwitch2" @bind="editando.PermiteVentaPorUnidad" />
                        <label class="form-check-label" for="permiteVentaUnidadSwitch2"><i class="bi bi-box2 text-primary me-1"></i>Permite Venta por Unidad</label>
                      </div>
                    }
                    <div class="form-check form-switch mb-2">
                      <input class="form-check-input" type="checkbox" id="permiteVentaBajoCostoSwitch2" @bind="editando.PermiteVentaBajoCosto" />
                      <label class="form-check-label" for="permiteVentaBajoCostoSwitch2"><i class="bi bi-exclamation-triangle text-warning me-1"></i>Bajo Costo</label>
                    </div>
                    @if (ModoFarmaciaActivo)
                    {
                      <div class="form-check form-switch mb-2">
                        <input class="form-check-input" type="checkbox" id="controladoRecetaSwitch2" @bind="editando.ControladoReceta" />
                        <label class="form-check-label" for="controladoRecetaSwitch2"><i class="bi bi-file-medical text-danger me-1"></i>Con Receta</label>
                      </div>
                    }
                    <div class="form-check form-switch">
                      <input class="form-check-input" type="checkbox" id="esComboSwitch2" @bind="editando.EsCombo" />
                      <label class="form-check-label" for="esComboSwitch2"><i class="bi bi-collection me-1"></i>Es Combo</label>
                    </div>
                    <div class="form-check form-switch mt-2">
                      <input class="form-check-input" type="checkbox" id="visibleMesasSwitch2" @bind="editando.VisibleEnMesas" />
                      <label class="form-check-label" for="visibleMesasSwitch2"><i class="bi bi-grid-3x3-gap text-success me-1"></i>Visible en Panel Mesas</label>
                    </div>
                    @if (ModoGimnasioActivo)
                    {
                      <div class="form-check form-switch mt-2">
                        <input class="form-check-input" type="checkbox" id="esMembresiaSwitch2" @bind="editando.EsMembresia" />
                        <label class="form-check-label" for="esMembresiaSwitch2"><i class="bi bi-person-badge text-info me-1"></i>Es Membres√≠a Gimnasio</label>
                      </div>
                    }
                  </div>
                </div>
                
                @* ========== CARD: CONFIGURACI√ìN MEMBRES√çA (GIMNASIO) ========== *@
                @if (ModoGimnasioActivo && editando.EsMembresia)
                {
                  <div class="card mb-3 border-info">
                    <div class="card-header bg-info bg-opacity-10 py-2">
                      <h6 class="mb-0 text-info"><i class="bi bi-person-badge me-2"></i>Configuraci√≥n Membres√≠a</h6>
                    </div>
                    <div class="card-body">
                      <div class="row g-2">
                        <div class="col-6">
                          <label class="form-label small">Duraci√≥n (d√≠as)</label>
                          <input type="number" class="form-control form-control-sm" @bind="editando.DuracionDiasMembresia" min="1" placeholder="30" />
                        </div>
                        <div class="col-6">
                          <label class="form-label small">Tipo Per√≠odo</label>
                          <select class="form-select form-select-sm" @bind="editando.TipoPeriodoMembresia">
                            <option value="">Seleccionar...</option>
                            <option value="Diario">Diario</option>
                            <option value="Semanal">Semanal</option>
                            <option value="Quincenal">Quincenal</option>
                            <option value="Mensual">Mensual</option>
                            <option value="Trimestral">Trimestral</option>
                            <option value="Semestral">Semestral</option>
                            <option value="Anual">Anual</option>
                          </select>
                        </div>
                      </div>
                      <div class="row g-2 mt-2">
                        <div class="col-6">
                          <label class="form-label small">Inscripci√≥n (Gs)</label>
                          <input type="number" class="form-control form-control-sm" @bind="editando.PrecioInscripcionMembresia" min="0" placeholder="0" />
                        </div>
                        <div class="col-6">
                          <label class="form-label small">D√≠as Gracia</label>
                          <input type="number" class="form-control form-control-sm" @bind="editando.DiasGraciaMembresia" min="0" placeholder="0" />
                        </div>
                      </div>
                      <hr class="my-2" />
                      <div class="form-check form-switch mb-2">
                        <input class="form-check-input" type="checkbox" id="permiteCongelarSwitch" @bind="editando.PermiteCongelarMembresia" />
                        <label class="form-check-label small" for="permiteCongelarSwitch"><i class="bi bi-snow me-1"></i>Permite Congelar</label>
                      </div>
                      @if (editando.PermiteCongelarMembresia)
                      {
                        <div class="mb-2">
                          <label class="form-label small">M√°x. D√≠as Congelar</label>
                          <input type="number" class="form-control form-control-sm" @bind="editando.DiasMaxCongelarMembresia" min="1" placeholder="30" />
                        </div>
                      }
                      <hr class="my-2" />
                      <div class="row g-2">
                        <div class="col-6">
                          <label class="form-label small">Clases Incluidas</label>
                          <input type="number" class="form-control form-control-sm" @bind="editando.ClasesIncluidasMembresia" min="0" placeholder="0 = ilimitado" />
                        </div>
                        <div class="col-6">
                          <div class="form-check form-switch mt-4">
                            <input class="form-check-input" type="checkbox" id="incluyePTSwitch" @bind="editando.IncluyePTMembresia" />
                            <label class="form-check-label small" for="incluyePTSwitch">Incluye PT</label>
                          </div>
                        </div>
                      </div>
                      @if (editando.IncluyePTMembresia)
                      {
                        <div class="mt-2">
                          <label class="form-label small">Sesiones PT</label>
                          <input type="number" class="form-control form-control-sm" @bind="editando.SesionesPTMembresia" min="1" placeholder="4" />
                        </div>
                      }
                      <hr class="my-2" />
                      <div class="row g-2">
                        <div class="col-6">
                          <label class="form-label small">Horario Acceso</label>
                          <select class="form-select form-select-sm" @bind="editando.HorarioAccesoMembresia">
                            <option value="">Sin restricci√≥n</option>
                            <option value="Ma√±ana">Ma√±ana (06:00-12:00)</option>
                            <option value="Tarde">Tarde (12:00-18:00)</option>
                            <option value="Noche">Noche (18:00-23:00)</option>
                            <option value="Todo">Todo el d√≠a</option>
                          </select>
                        </div>
                        <div class="col-6">
                          <label class="form-label small">D√≠as Acceso</label>
                          <select class="form-select form-select-sm" @bind="editando.DiasAccesoMembresia">
                            <option value="">Sin restricci√≥n</option>
                            <option value="L-V">Lunes a Viernes</option>
                            <option value="L-S">Lunes a S√°bado</option>
                            <option value="Todos">Todos los d√≠as</option>
                          </select>
                        </div>
                      </div>
                      <hr class="my-2" />
                      @* ========== √ÅREAS DE ACCESO ========== *@
                      <div class="form-check form-switch mb-2">
                        <input class="form-check-input" type="checkbox" id="accesoTodasAreasSwitch" @bind="editando.AccesoTodasAreasMembresia" />
                        <label class="form-check-label small" for="accesoTodasAreasSwitch"><i class="bi bi-door-open me-1"></i>Acceso a Todas las √Åreas</label>
                      </div>
                      @if (!editando.AccesoTodasAreasMembresia)
                      {
                        <div class="mb-2">
                          <label class="form-label small">√Åreas Incluidas (separar con coma)</label>
                          <input type="text" class="form-control form-control-sm" @bind="editando.AreasIncluidasMembresia" placeholder="Pesas, Cardio, Piscina..." />
                        </div>
                      }
                      <hr class="my-2" />
                      @* ========== RENOVACI√ìN AUTOM√ÅTICA ========== *@
                      <div class="form-check form-switch mb-2">
                        <input class="form-check-input" type="checkbox" id="renovacionAutoSwitch" @bind="editando.RenovacionAutomaticaMembresia" />
                        <label class="form-check-label small" for="renovacionAutoSwitch"><i class="bi bi-arrow-repeat me-1"></i>Renovaci√≥n Autom√°tica</label>
                      </div>
                      <div class="mb-2">
                        <label class="form-label small">D√≠as Recordatorio Vencimiento</label>
                        <input type="number" class="form-control form-control-sm" @bind="editando.DiasRecordatorioMembresia" min="0" placeholder="7" />
                      </div>
                      <hr class="my-2" />
                      <div class="mt-2">
                        <label class="form-label small"><i class="bi bi-palette me-1"></i>Color Identificativo</label>
                        <input type="color" class="form-control form-control-sm form-control-color" @bind="editando.ColorMembresia" />
                      </div>
                    </div>
                  </div>
                } @* Fin if ModoGimnasioActivo && EsMembresia *@
                
                @* ========== CARD: CONTROL LOTES (FARMACIA) ========== *@
                @if (ModoFarmaciaActivo)
                {
                  <div class="card mb-3 border-info">
                    <div class="card-header bg-info bg-opacity-10 py-2">
                      <h6 class="mb-0 text-info"><i class="bi bi-boxes me-2"></i>Control Lotes</h6>
                    </div>
                    <div class="card-body">
                      <div class="form-check form-switch mb-2">
                        <input class="form-check-input" type="checkbox" id="controlaLoteSwitch2" @bind="editando.ControlaLote" @bind:after="OnControlaLoteChanged" />
                        <label class="form-check-label" for="controlaLoteSwitch2"><i class="bi bi-upc me-1"></i>Controla Lote</label>
                      </div>
                      <div class="form-check form-switch mb-2">
                        <input class="form-check-input" type="checkbox" id="controlaVencimientoLoteSwitch2" @bind="editando.ControlaVencimiento" />
                        <label class="form-check-label" for="controlaVencimientoLoteSwitch2"><i class="bi bi-calendar-event me-1"></i>Controla Vencimiento</label>
                      </div>
                      @if (editando.ControlaVencimiento)
                      {
                      <div class="row g-2 mt-2">
                        <div class="col-6">
                          <label class="form-label small">D√≠as Alerta</label>
                          <input type="number" class="form-control form-control-sm" @bind="editando.DiasAlertaVencimiento" min="1" max="365" />
                        </div>
                        <div class="col-6">
                          <div class="form-check form-switch mt-4">
                            <input class="form-check-input" type="checkbox" id="permiteVentaVencidoSwitch2" @bind="editando.PermiteVentaVencido" />
                            <label class="form-check-label small" for="permiteVentaVencidoSwitch2">Venta Vencido</label>
                          </div>
                        </div>
                      </div>
                    }
                    @if (editando.ControlaLote && editando.IdProducto > 0)
                    {
                      <button type="button" class="btn btn-outline-info btn-sm w-100 mt-2" @onclick="AbrirModalLotes">
                        <i class="bi bi-list-ul me-1"></i>Ver Lotes (@lotesProducto.Count)
                      </button>
                    }
                    </div>
                  </div>
                } @* Fin if ModoFarmaciaActivo para Control Lotes *@
                
                @* ========== CARD: VENCIMIENTO SIMPLE ========== *@
                @if (!editando.ControlaLote && editando.ControlarVencimiento)
                {
                  <div class="card mb-3">
                    <div class="card-header bg-light py-2">
                      <h6 class="mb-0"><i class="bi bi-calendar-x me-2"></i>Vencimiento</h6>
                    </div>
                    <div class="card-body">
                      <InputDate class="form-control form-control-sm" @bind-Value="editando.FechaVencimiento" />
                    </div>
                  </div>
                }
                
                @* ========== CARD: CONTROL STOCK M√çNIMO ========== *@
                <div class="card mb-3 border-warning">
                  <div class="card-header bg-warning bg-opacity-10 py-2">
                    <h6 class="mb-0 text-warning"><i class="bi bi-exclamation-triangle me-2"></i>Control Stock M√≠nimo</h6>
                  </div>
                  <div class="card-body">
                    <div class="row g-2">
                      <div class="col-12">
                        <label class="form-label small"><i class="bi bi-box-seam me-1"></i>Stock M√≠nimo</label>
                        <div class="input-group input-group-sm">
                          <input type="number" class="form-control" @bind="editando.StockMinimo" min="0" step="0.01" placeholder="0" />
                          <span class="input-group-text">unidades</span>
                        </div>
                        <small class="text-muted">Si el stock llega a este valor, se mostrar√° una alerta.</small>
                      </div>
                    </div>
                    @if (editando.IdProducto > 0 && editando.Stock <= editando.StockMinimo && editando.StockMinimo > 0)
                    {
                      <div class="alert alert-warning mt-2 mb-0 py-2 small">
                        <i class="bi bi-exclamation-triangle-fill me-1"></i>
                        <strong>Stock bajo:</strong> Actualmente @editando.Stock.ToString("N2") unidades (m√≠nimo: @editando.StockMinimo.ToString("N2"))
                      </div>
                    }
                  </div>
                </div>
                
              </div><!-- Fin columna derecha -->
            </div><!-- Fin row principal -->
          </EditForm>
        </div>
        <div class="modal-footer bg-light py-2">
          <button class="btn btn-outline-secondary" @onclick="Cerrar" disabled="@_guardando"><i class="bi bi-x-lg me-1"></i>Cancelar</button>
          <button class="btn btn-primary" @onclick="SubmitForm" disabled="@_guardando">
            @if (_guardando)
            {
              <span class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span>
              <span>Guardando...</span>
            }
            else
            {
              <i class="bi bi-check-lg me-1"></i>
              <span>Guardar</span>
            }
          </button>
        </div>
      </div>
    </div>
  </div>
  @if (mostrarModal)
  {
    <div class="modal-backdrop fade show"></div>
  }

  <!-- Modal Etiqueta de c√≥digo de barras -->
  <div class="modal fade @(mostrarEtiqueta ? "show" : "")" style="display:@(mostrarEtiqueta?"block":"none")" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Etiqueta de c√≥digo de barras</h5>
          <button type="button" class="btn-close" @onclick="CerrarEtiqueta"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">Formato</label>
            <select class="form-select" @bind="barcodeFormat">
              <option value="CODE128">Code128 (universal)</option>
              <option value="EAN13">EAN-13 (retail)</option>
              <option value="UPC">UPC-A (US/CA)</option>
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label">C√≥digo</label>
            <div class="input-group">
              <input class="form-control" @bind="barcodeCode" @bind:event="oninput" />
              <button type="button" class="btn btn-outline-secondary" @onclick="GenerarEanAutoClick">Auto</button>
            </div>
            <div class="form-text">
              @if (barcodeFormat == "EAN13") {<text>13 d√≠gitos (√∫ltimo es d√≠gito verificador).</text>}
              else if (barcodeFormat == "UPC") {<text>12 d√≠gitos (√∫ltimo es d√≠gito verificador).</text>}
              else {<text>Libre: letras y n√∫meros.</text>}
            </div>
          </div>
          <div class="row g-2 mb-2">
            <div class="col-4">
              <label class="form-label">Ancho barra</label>
              <input type="number" min="1" max="6" class="form-control" @bind="barcodeWidth" @bind:event="oninput" />
            </div>
            <div class="col-4">
              <label class="form-label">Alto (px)</label>
              <input type="number" min="40" max="200" class="form-control" @bind="barcodeHeight" @bind:event="oninput" />
            </div>
            <div class="col-4">
              <label class="form-label">Margen (px)</label>
              <input type="number" min="0" max="30" class="form-control" @bind="barcodeMargin" @bind:event="oninput" />
            </div>
          </div>
          <div class="form-check form-switch mb-2">
            <input id="showText" class="form-check-input" type="checkbox" @bind="barcodeShowText" />
            <label class="form-check-label" for="showText">Mostrar texto</label>
          </div>
          <div class="form-check form-switch mb-2">
            <input id="showName" class="form-check-input" type="checkbox" @bind="barcodeShowName" />
            <label class="form-check-label" for="showName">Mostrar nombre del producto</label>
          </div>
          <svg id="barcodePreview" style="width:100%"></svg>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" @onclick="CerrarEtiqueta">Cerrar</button>
          <button type="button" class="btn btn-primary" @onclick="ImprimirEtiqueta"><i class="bi bi-printer me-2"></i>Imprimir</button>
        </div>
      </div>
    </div>
  </div>
  @if (mostrarEtiqueta)
  {
    <div class="modal-backdrop fade show"></div>
  }

  <!-- Modal: Stock por dep√≥sito -->
  <div class="modal fade @(mostrarStocks ? "show" : "")" style="display:@(mostrarStocks?"block":"none")" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Stock por dep√≥sito @((productoStocks?.Descripcion is null ? string.Empty : $"- {productoStocks.Descripcion}"))</h5>
          <button type="button" class="btn-close" @onclick="CerrarStocks"></button>
        </div>
        <div class="modal-body">
          <div class="table-responsive">
            <table class="table table-sm table-striped">
              <thead>
                <tr>
                  <th>Dep√≥sito</th>
                  <th class="text-end">Stock</th>
                </tr>
              </thead>
              <tbody>
                @if (stocksDepositos is null)
                {
                  <tr><td colspan="2" class="text-muted">Cargando...</td></tr>
                }
                else if (!stocksDepositos.Any())
                {
                  <tr><td colspan="2" class="text-muted">Sin filas</td></tr>
                }
                else
                {
                  @foreach (var s in stocksDepositos)
                  {
                    <tr>
                      <td>@(s.Deposito?.Nombre ?? s.IdDeposito.ToString())</td>
                      <td class="text-end">@s.Stock.ToString("N4")</td>
                    </tr>
                  }
                }
              </tbody>
            </table>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" @onclick="CerrarStocks">Cerrar</button>
        </div>
      </div>
    </div>
  </div>
  @if (mostrarStocks)
  {
    <div class="modal-backdrop fade show"></div>
  }

  <!-- Modal: Administraci√≥n de Lotes -->
  <div class="modal fade @(mostrarModalLotes ? "show" : "")" style="display:@(mostrarModalLotes?"block":"none")" tabindex="-1">
    <div class="modal-dialog modal-xl">
      <div class="modal-content">
        <div class="modal-header bg-primary text-white">
          <h5 class="modal-title"><i class="bi bi-boxes me-2"></i>Administraci√≥n de Lotes - @editando.Descripcion</h5>
          <button type="button" class="btn-close btn-close-white" @onclick="CerrarModalLotes"></button>
        </div>
        <div class="modal-body">
          @if (!string.IsNullOrEmpty(mensajeErrorLote))
          {
            <div class="alert alert-danger alert-dismissible fade show" role="alert">
              <i class="bi bi-exclamation-triangle me-1"></i>@mensajeErrorLote
              <button type="button" class="btn-close" @onclick="() => mensajeErrorLote = null"></button>
            </div>
          }
          @if (!string.IsNullOrEmpty(mensajeExitoLote))
          {
            <div class="alert alert-success alert-dismissible fade show" role="alert">
              <i class="bi bi-check-circle me-1"></i>@mensajeExitoLote
              <button type="button" class="btn-close" @onclick="() => mensajeExitoLote = null"></button>
            </div>
          }

          @* Info: Los lotes STOCK-INICIAL se crean autom√°ticamente al guardar *@
          @if (lotesProducto.Any(l => l.EsLoteInicial))
          {
            <div class="alert alert-info py-2 mb-3">
              <i class="bi bi-info-circle me-2"></i>
              <small>Los lotes marcados como <span class="badge bg-info">Inicial</span> fueron creados autom√°ticamente con el stock existente. 
              Puede editarlos para asignar fecha de vencimiento o dividirlos en lotes m√°s espec√≠ficos.</small>
            </div>
          }

          <div class="row">
            <!-- Lista de lotes existentes -->
            <div class="col-md-7">
              <h6 class="border-bottom pb-2 mb-3"><i class="bi bi-list-ul me-1"></i>Lotes Registrados</h6>
              @if (!lotesProducto.Any())
              {
                <div class="text-muted text-center py-4">
                  <i class="bi bi-inbox display-4"></i>
                  <p>No hay lotes registrados para este producto.</p>
                  <small class="text-muted">Los lotes se crear√°n autom√°ticamente al registrar compras o al guardar el producto con stock existente.</small>
                </div>
              }
              else
              {
                <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                  <table class="table table-sm table-hover align-middle">
                    <thead class="table-light sticky-top">
                      <tr>
                        <th>Lote</th>
                        <th>Dep√≥sito</th>
                        <th class="text-center">Vencimiento</th>
                        <th class="text-end">Stock</th>
                        <th class="text-center">Estado</th>
                        <th class="text-center" style="width:100px">Acciones</th>
                      </tr>
                    </thead>
                    <tbody>
                      @foreach (var lote in lotesProducto)
                      {
                        <tr class="@(lote.EstaVencido ? "table-danger" : (lote.EstaProximoAVencer ? "table-warning" : ""))">
                          <td>
                            <strong>@lote.NumeroLote</strong>
                            @if (lote.EsLoteInicial)
                            {
                              <span class="badge bg-info ms-1" title="Lote migrado">Inicial</span>
                            }
                          </td>
                          <td><small>@(lote.Deposito?.Nombre ?? "-")</small></td>
                          <td class="text-center">
                            @if (lote.FechaVencimiento.HasValue)
                            {
                              <span title="@lote.FechaVencimiento.Value.ToString("dd/MM/yyyy")">
                                @lote.FechaVencimiento.Value.ToString("dd/MM/yy")
                                @if (lote.DiasParaVencimiento.HasValue)
                                {
                                  <br><small class="@(lote.DiasParaVencimiento < 0 ? "text-danger" : (lote.DiasParaVencimiento < 30 ? "text-warning" : "text-muted"))">
                                    @(lote.DiasParaVencimiento < 0 ? $"Vencido hace {-lote.DiasParaVencimiento} d√≠as" : $"{lote.DiasParaVencimiento} d√≠as")
                                  </small>
                                }
                              </span>
                            }
                            else
                            {
                              <span class="text-muted">-</span>
                            }
                          </td>
                          <td class="text-end fw-bold">@lote.Stock.ToString("N2")</td>
                          <td class="text-center">
                            <span class="@GetEstadoLoteBadge(lote)">@GetEstadoLoteTexto(lote)</span>
                          </td>
                          <td class="text-center">
                            <div class="btn-group btn-group-sm">
                              <button type="button" class="btn btn-outline-primary" @onclick="() => EditarLote(lote)" title="Editar">
                                <i class="bi bi-pencil"></i>
                              </button>
                              @if (_puedeEliminarLote)
                              {
                                <button type="button" class="btn btn-outline-danger" @onclick="() => EliminarLote(lote)" 
                                        title="Eliminar lote">
                                  <i class="bi bi-trash"></i>
                                </button>
                              }
                            </div>
                          </td>
                        </tr>
                      }
                    </tbody>
                    <tfoot class="table-light">
                      <tr class="fw-bold">
                        <td colspan="3">Total</td>
                        <td class="text-end">@lotesProducto.Sum(l => l.Stock).ToString("N2")</td>
                        <td colspan="2"></td>
                      </tr>
                    </tfoot>
                  </table>
                </div>
              }
            </div>

            <!-- Formulario para agregar/editar lote -->
            <div class="col-md-5">
              <h6 class="border-bottom pb-2 mb-3">
                <i class="bi bi-@(editandoLote ? "pencil" : "plus-circle") me-1"></i>
                @(editandoLote ? "Editar Lote" : "Agregar Nuevo Lote")
              </h6>
              <EditForm Model="@nuevoLote" OnValidSubmit="GuardarLote">
                <div class="row g-2">
                  <div class="col-12">
                    <label class="form-label small">N√∫mero de Lote *</label>
                    <InputText class="form-control form-control-sm" @bind-Value="nuevoLote.NumeroLote" placeholder="Ej: L2026001" />
                  </div>
                  <div class="col-12">
                    <label class="form-label small">Dep√≥sito *</label>
                    <InputSelect class="form-select form-select-sm" @bind-Value="nuevoLote.IdDeposito">
                      <option value="0">-- Seleccione --</option>
                      @foreach (var dep in depositos)
                      {
                        <option value="@dep.IdDeposito">@dep.Nombre</option>
                      }
                    </InputSelect>
                  </div>
                  <div class="col-6">
                    <label class="form-label small">Fecha Vencimiento <span class="text-danger">*</span></label>
                    <InputDate class="form-control form-control-sm" @bind-Value="nuevoLote.FechaVencimiento" />
                  </div>
                  <div class="col-6">
                    <label class="form-label small">Fecha Fabricaci√≥n</label>
                    <InputDate class="form-control form-control-sm" @bind-Value="nuevoLote.FechaFabricacion" />
                  </div>
                  <div class="col-6">
                    <label class="form-label small">Stock @(editandoLote ? "(Bloqueado)" : "Inicial")</label>
                    @if (editandoLote)
                    {
                      <input type="number" class="form-control form-control-sm bg-light" value="@nuevoLote.Stock" disabled title="El stock solo se modifica mediante Ajustes de Stock o Compras" />
                      <div class="alert alert-warning py-1 px-2 mt-1 mb-0 small">
                        <i class="bi bi-lock-fill me-1"></i><strong>Protegido:</strong> El stock solo puede modificarse desde el m√≥dulo <a href="/ajustes-stock" class="alert-link">Ajustes de Stock</a> o mediante Compras/Ventas.
                      </div>
                    }
                    else
                    {
                      <InputNumber class="form-control form-control-sm" @bind-Value="nuevoLote.Stock" />
                      <div class="form-text">Stock inicial del lote nuevo.</div>
                    }
                  </div>
                  <div class="col-6">
                    <label class="form-label small">Costo Unitario</label>
                    <InputNumber class="form-control form-control-sm" @bind-Value="nuevoLote.CostoUnitario" />
                  </div>
                  <div class="col-12">
                    <label class="form-label small">Estado</label>
                    <InputSelect class="form-select form-select-sm" @bind-Value="nuevoLote.Estado">
                      <option value="Activo">Activo</option>
                      <option value="Bloqueado">Bloqueado</option>
                      <option value="Agotado">Agotado</option>
                    </InputSelect>
                  </div>
                  <div class="col-12">
                    <label class="form-label small">Observaciones</label>
                    <InputTextArea class="form-control form-control-sm" @bind-Value="nuevoLote.Observacion" rows="2" />
                  </div>
                  <div class="col-12 d-flex gap-2 mt-3">
                    <button type="submit" class="btn btn-primary btn-sm flex-grow-1">
                      <i class="bi bi-check-lg me-1"></i>@(editandoLote ? "Actualizar" : "Agregar") Lote
                    </button>
                    @if (editandoLote)
                    {
                      <button type="button" class="btn btn-secondary btn-sm" @onclick="CancelarEdicionLote">
                        <i class="bi bi-x-lg me-1"></i>Cancelar
                      </button>
                    }
                  </div>
                </div>
              </EditForm>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" @onclick="CerrarModalLotes">
            <i class="bi bi-x-lg me-1"></i>Cerrar
          </button>
        </div>
      </div>
    </div>
  </div>
  @if (mostrarModalLotes)
  {
    <div class="modal-backdrop fade show"></div>
  }
  
  @* ========== MODAL VISUALIZACI√ìN LOTES (SOLO LECTURA) ========== *@
  <div class="modal fade @(mostrarModalLotesVisualizacion ? "show d-block" : "")" tabindex="-1" style="background: rgba(0,0,0,0.5);">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header bg-success text-white">
          <h5 class="modal-title"><i class="bi bi-collection me-2"></i>Lotes - @(productoVisualizandoLotes?.Descripcion ?? "")</h5>
          <button type="button" class="btn-close btn-close-white" @onclick="CerrarModalLotesVisualizacion"></button>
        </div>
        <div class="modal-body">
          @if (!lotesVisualizacion.Any())
          {
            <div class="text-muted text-center py-4">
              <i class="bi bi-inbox display-4"></i>
              <p>No hay lotes registrados para este producto.</p>
            </div>
          }
          else
          {
            <div class="table-responsive">
              <table class="table table-sm table-hover align-middle mb-0">
                <thead class="table-light">
                  <tr>
                    <th>Lote</th>
                    <th>Dep√≥sito</th>
                    <th class="text-center">Vencimiento</th>
                    <th class="text-end">Stock</th>
                    <th class="text-center">Estado</th>
                  </tr>
                </thead>
                <tbody>
                  @foreach (var lote in lotesVisualizacion)
                  {
                    <tr class="@(lote.EstaVencido ? "table-danger" : (lote.EstaProximoAVencer ? "table-warning" : ""))">
                      <td>
                        <strong>@lote.NumeroLote</strong>
                        @if (lote.EsLoteInicial)
                        {
                          <span class="badge bg-info ms-1">Inicial</span>
                        }
                      </td>
                      <td><small>@(lote.Deposito?.Nombre ?? "-")</small></td>
                      <td class="text-center">
                        @if (lote.FechaVencimiento.HasValue)
                        {
                          var diasVenc = (lote.FechaVencimiento.Value - DateTime.Today).Days;
                          var claseVenc = diasVenc < 0 ? "text-danger fw-bold" : (diasVenc <= 30 ? "text-warning" : "text-muted");
                          <span class="@claseVenc">
                            @lote.FechaVencimiento.Value.ToString("dd/MM/yyyy")
                            <br><small>@(diasVenc < 0 ? $"Vencido hace {-diasVenc} d√≠as" : $"{diasVenc} d√≠as")</small>
                          </span>
                        }
                        else
                        {
                          <span class="text-danger"><i class="bi bi-exclamation-triangle me-1"></i>Sin fecha</span>
                        }
                      </td>
                      <td class="text-end fw-bold">@lote.Stock.ToString("N2")</td>
                      <td class="text-center">
                        <span class="@GetEstadoLoteBadge(lote)">@GetEstadoLoteTexto(lote)</span>
                      </td>
                    </tr>
                  }
                </tbody>
                <tfoot class="table-light">
                  <tr class="fw-bold">
                    <td colspan="3">Total</td>
                    <td class="text-end">@lotesVisualizacion.Sum(l => l.Stock).ToString("N2")</td>
                    <td></td>
                  </tr>
                </tfoot>
              </table>
            </div>
            
            @if (lotesVisualizacion.Any(l => !l.FechaVencimiento.HasValue) || lotesVisualizacion.Any(l => l.EstaVencido) || lotesVisualizacion.Any(l => l.EstaProximoAVencer && !l.EstaVencido))
            {
              <div class="mt-3">
                @if (lotesVisualizacion.Any(l => !l.FechaVencimiento.HasValue))
                {
                  <div class="alert alert-warning py-2 mb-2">
                    <i class="bi bi-exclamation-triangle me-1"></i>
                    <strong>@lotesVisualizacion.Count(l => !l.FechaVencimiento.HasValue)</strong> lote(s) sin fecha de vencimiento
                  </div>
                }
                @if (lotesVisualizacion.Any(l => l.EstaVencido))
                {
                  <div class="alert alert-danger py-2 mb-2">
                    <i class="bi bi-x-circle me-1"></i>
                    <strong>@lotesVisualizacion.Count(l => l.EstaVencido)</strong> lote(s) vencido(s) - Stock: @lotesVisualizacion.Where(l => l.EstaVencido).Sum(l => l.Stock).ToString("N2")
                  </div>
                }
                @if (lotesVisualizacion.Any(l => l.EstaProximoAVencer && !l.EstaVencido))
                {
                  <div class="alert alert-info py-2 mb-2">
                    <i class="bi bi-clock me-1"></i>
                    <strong>@lotesVisualizacion.Count(l => l.EstaProximoAVencer && !l.EstaVencido)</strong> lote(s) pr√≥ximo(s) a vencer (30 d√≠as)
                  </div>
                }
              </div>
            }
          }
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-warning" @onclick="() => EditarProductoDesdeVisualizacion()">
            <i class="bi bi-pencil me-1"></i>Editar Lotes
          </button>
          <button type="button" class="btn btn-secondary" @onclick="CerrarModalLotesVisualizacion">
            <i class="bi bi-x-lg me-1"></i>Cerrar
          </button>
        </div>
      </div>
    </div>
  </div>
  @if (mostrarModalLotesVisualizacion)
  {
    <div class="modal-backdrop fade show"></div>
  }
</div>

@code {
  private List<Models.Producto> productos = new();
  private List<Models.Producto> filtrados = new();
  private List<Models.TiposIva> tiposIva = new();
  private List<Models.Marca> marcas = new();
  private List<Models.Sucursal> sucursales = new();
  private List<Models.Moneda> monedas = new();
  private List<Models.Deposito> depositosCombo = new();
  private List<Models.Clasificacion> clasificaciones = new();
  private List<Models.TiposItem> tiposItem = new();
  private List<Models.ProductoComponente> componentesCombo = new();
  private int selectedComponenteId = 0;
  private decimal cantidadComponente = 1m;
  private decimal? costoCalculadoComponentes = null; // Costo calculado sumando componentes
  private string filtro = string.Empty;
  private string filtroIva = string.Empty;
  private string filtroDeposito = string.Empty;
  private string filtroTipoItem = string.Empty;
  private bool soloActivos = true;
  private bool soloStockBajo = false;
  
  // Paginaci√≥n
  private int paginaActual = 1;
  private int registrosPorPagina = 100;
  private int TotalPaginas => (int)Math.Ceiling(filtrados.Count / (double)registrosPorPagina);
  private IEnumerable<Models.Producto> ProductosPagina => filtrados.Skip((paginaActual - 1) * registrosPorPagina).Take(registrosPorPagina);
  private bool mostrarModal = false;
  private bool _guardando = false;  // Protecci√≥n contra doble guardado
  private Models.Producto editando = new Models.Producto();
  private List<Models.Deposito> depositos = new();
  private Dictionary<int, List<(string Deposito, decimal Stock)>> stocksPorProductoDeposito = new();
  private IBrowserFile? pendingImage;
  private string? previewDataUrl;
  private bool mostrarEtiqueta = false;
  private Models.Producto? etiquetaProducto;
  private string ean13 = string.Empty; // legado
  private string _barcodeCode = string.Empty;
  private string barcodeCode { get => _barcodeCode; set { if (_barcodeCode != value) { _barcodeCode = value; if(!_suspendRenderEtiqueta) { _ = RenderEtiqueta(); } } } }
  private string _barcodeFormat = "CODE128";
  private string barcodeFormat { get => _barcodeFormat; set { if (_barcodeFormat != value) { _barcodeFormat = value; if(!_suspendRenderEtiqueta) { _ = RenderEtiqueta(); } } } }
  private int _barcodeWidth = 2;
  private int barcodeWidth { get => _barcodeWidth; set { if (_barcodeWidth != value) { _barcodeWidth = value; if(!_suspendRenderEtiqueta) { _ = RenderEtiqueta(); } } } }
  private int _barcodeHeight = 80;
  private int barcodeHeight { get => _barcodeHeight; set { if (_barcodeHeight != value) { _barcodeHeight = value; if(!_suspendRenderEtiqueta) { _ = RenderEtiqueta(); } } } }
  private int _barcodeMargin = 10;
  private int barcodeMargin { get => _barcodeMargin; set { if (_barcodeMargin != value) { _barcodeMargin = value; if(!_suspendRenderEtiqueta) { _ = RenderEtiqueta(); } } } }
  private bool _barcodeShowText = true;
  private bool barcodeShowText { get => _barcodeShowText; set { if (_barcodeShowText != value) { _barcodeShowText = value; if(!_suspendRenderEtiqueta) { _ = RenderEtiqueta(); } } } }
  private bool _barcodeShowName = true;
  private bool barcodeShowName { get => _barcodeShowName; set { if (_barcodeShowName != value) { _barcodeShowName = value; if(!_suspendRenderEtiqueta) { _ = RenderEtiqueta(); } } } }
  private bool _etiquetaRenderizada = false;
  private bool _suspendRenderEtiqueta = false;
  private string nuevaClasificacionNombre = string.Empty;
  private string undMedidaValue = "UNIDAD"; // valor intermedio TRIM para evitar padding de CHAR(10)
  // Variables para c√°lculo de precio desde costo
  private decimal? factorPrecio = null;
  private decimal? porcentajePrecio = null;
  private bool actualizandoPrecio = false; // evita recursi√≥n
  
  // Variables para c√°lculo de precio de PAQUETE desde costo paquete
  private decimal? factorPrecioPaquete = null;
  private decimal? porcentajePrecioPaquete = null;
  private bool actualizandoPrecioPaquete = false; // evita recursi√≥n
  // Autocompletado de componentes
  private string componenteSearch = string.Empty;
  private List<Models.Producto> componenteOpciones = new();
  private bool mostrandoOpciones = false;
  private CancellationTokenSource? _searchCts;
  private int selectedOptionIndex = -1;
  
  // Configuraci√≥n de farmacia (Precio Ministerio)
  private Models.ConfiguracionSistema? _config;
  private bool ModoFarmaciaActivo => _config?.FarmaciaModoActivo == true;
  private bool ModoGimnasioActivo => _config?.GimnasioModoActivo == true;
  private bool MostrarPrecioMinisterio => _config?.FarmaciaModoActivo == true && _config?.FarmaciaMostrarPrecioMinisterio == true;
  private bool ValidarPrecioMinisterio => _config?.FarmaciaModoActivo == true && _config?.FarmaciaValidarPrecioMinisterio == true;

  // Control de Lotes
  private bool mostrarModalLotes = false;
  private List<Models.ProductoLote> lotesProducto = new();
  private Models.ProductoLote nuevoLote = new();
  private bool editandoLote = false;
  private string? mensajeErrorLote;
  private string? mensajeExitoLote;
  private bool _puedeEliminarLote = false; // Permiso DELETE en inventario
  
  // Modal de visualizaci√≥n de lotes (solo lectura desde explorador)
  private bool mostrarModalLotesVisualizacion = false;
  private Models.Producto? productoVisualizandoLotes = null;
  private List<Models.ProductoLote> lotesVisualizacion = new();

  protected override async Task OnInitializedAsync()
  {
    // Cargar permisos del usuario
    try
    {
      var auth = await AuthenticationStateProvider.GetAuthenticationStateAsync();
      var user = auth.User;
      if (user?.Identity?.IsAuthenticated == true)
      {
        var idStr = user.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;
        if (int.TryParse(idStr, out var idUsu))
        {
          // Verificar permiso DELETE en /productos (m√≥dulo espec√≠fico de esta p√°gina)
          _puedeEliminarLote = await PermisosService.TienePermisoAsync(idUsu, "/productos", "DELETE");
        }
      }
    }
    catch { /* Permisos por defecto: false */ }
    
    await Cargar();
  }

  protected override async Task OnAfterRenderAsync(bool firstRender)
  {
    if (mostrarEtiqueta && !_etiquetaRenderizada)
    {
      for (var i = 0; i < 5 && !_etiquetaRenderizada; i++)
      {
        await RenderEtiqueta();
        if (_etiquetaRenderizada) break;
        await Task.Delay(50);
      }
    }
  }

  private async Task Cargar()
  {
    await using var db = await DbFactory.CreateDbContextAsync();
    
    // Cargar configuraci√≥n del sistema (farmacia)
    _config = await db.ConfiguracionSistema.FirstOrDefaultAsync();
    
  // Asegurar columna de moneda predeterminada del producto (si no existe)
  try
  {
    await db.Database.ExecuteSqlRawAsync(@"IF COL_LENGTH('Productos','IdMonedaPrecio') IS NULL
BEGIN
  ALTER TABLE Productos ADD IdMonedaPrecio INT NULL;
END");
  }
  catch { }
    tiposIva = await db.TiposIva.OrderBy(t => t.Porcentaje).ToListAsync();
    marcas = await db.Marcas.OrderBy(m => m.NombreMarca).ToListAsync();
    sucursales = await db.Sucursal.OrderBy(s => s.NombreSucursal).ToListAsync();
  // Limitar a ARS, USD, BRL y PYG como en Compras
  var cods = new[] { "ARS", "USD", "BRL", "PYG" };
  monedas = await db.Monedas.Where(m => cods.Contains(m.CodigoISO)).OrderBy(m => m.CodigoISO).ToListAsync();
    clasificaciones = await db.Clasificaciones.Where(c => c.Activo).OrderBy(c => c.Nombre).ToListAsync();
  tiposItem = await db.TiposItem.OrderBy(t => t.Nombre).ToListAsync();
  depositosCombo = await db.Depositos.Include(d => d.Sucursal).OrderBy(d => d.IdSucursal).ThenBy(d => d.Nombre).ToListAsync();
  depositos = await db.Depositos.Where(d => d.Activo).OrderBy(d => d.Nombre).ToListAsync();
    productos = await db.Productos
      .Include(p => p.TipoIva)
      .Include(p => p.Marca)
      .Include(p => p.Sucursal)
      .Include(p => p.Clasificacion)
      .OrderBy(p => p.Descripcion)
      .ToListAsync();
    
    // Cargar stocks por producto y dep√≥sito
    // Combinar ProductosDepositos + ProductosLotes para mostrar stock real
    var productosDeposito = await db.ProductosDepositos
      .Include(pd => pd.Deposito)
      .ToListAsync();
    
    // Cargar tambi√©n stocks de lotes agrupados por producto y dep√≥sito
    var stocksLotes = await db.ProductosLotes
      .Where(l => l.Estado == "Activo" && l.Stock > 0)
      .Include(l => l.Deposito)
      .GroupBy(l => new { l.IdProducto, l.IdDeposito })
      .Select(g => new { 
        g.Key.IdProducto, 
        g.Key.IdDeposito,
        NombreDeposito = g.First().Deposito != null ? g.First().Deposito.Nombre : "Sin nombre",
        StockTotal = g.Sum(l => l.Stock) 
      })
      .ToListAsync();
    
    // Obtener IDs de productos que controlan lote
    var productosConLote = productos.Where(p => p.ControlaLote).Select(p => p.IdProducto).ToHashSet();
    
    stocksPorProductoDeposito.Clear();
    
    // Para productos SIN control de lotes: usar ProductosDepositos
    foreach (var pd in productosDeposito.Where(pd => !productosConLote.Contains(pd.IdProducto)))
    {
      if (!stocksPorProductoDeposito.ContainsKey(pd.IdProducto))
      {
        stocksPorProductoDeposito[pd.IdProducto] = new List<(string, decimal)>();
      }
      var nombreDeposito = pd.Deposito?.Nombre ?? "Sin nombre";
      stocksPorProductoDeposito[pd.IdProducto].Add((nombreDeposito, pd.Stock));
    }
    
    // Para productos CON control de lotes: usar suma de ProductosLotes
    foreach (var sl in stocksLotes.Where(sl => productosConLote.Contains(sl.IdProducto)))
    {
      if (!stocksPorProductoDeposito.ContainsKey(sl.IdProducto))
      {
        stocksPorProductoDeposito[sl.IdProducto] = new List<(string, decimal)>();
      }
      stocksPorProductoDeposito[sl.IdProducto].Add((sl.NombreDeposito, sl.StockTotal));
    }
    
    Filtrar();
  }

  private void Filtrar()
  {
    paginaActual = 1;  // Resetear p√°gina al filtrar
    filtrados = productos.Where(p =>
      (string.IsNullOrWhiteSpace(filtro) ||
        p.Descripcion.Contains(filtro, StringComparison.OrdinalIgnoreCase) ||
        p.CodigoInterno.Contains(filtro, StringComparison.OrdinalIgnoreCase) ||
        (p.CodigoBarras ?? string.Empty).Contains(filtro, StringComparison.OrdinalIgnoreCase)) &&
      (string.IsNullOrEmpty(filtroIva) || p.IdTipoIva.ToString() == filtroIva) &&
      (string.IsNullOrEmpty(filtroTipoItem) || p.TipoItem.ToString() == filtroTipoItem) &&
      (!soloActivos || p.Activo) &&
      (!soloStockBajo || (p.StockMinimo > 0 && p.Stock <= p.StockMinimo))
    ).ToList();
    
    // Aplicar filtro por dep√≥sito: mostrar productos que tienen registro en ese dep√≥sito
    if (!string.IsNullOrEmpty(filtroDeposito))
    {
      var depositoSeleccionado = depositos.FirstOrDefault(d => d.IdDeposito.ToString() == filtroDeposito);
      if (depositoSeleccionado != null)
      {
        filtrados = filtrados.Where(p => 
          stocksPorProductoDeposito.ContainsKey(p.IdProducto) && 
          stocksPorProductoDeposito[p.IdProducto].Any(s => s.Deposito == depositoSeleccionado.Nombre)
        ).ToList();
      }
    }
  }
  
  private void IrPagina(int pagina)
  {
    if (pagina >= 1 && pagina <= TotalPaginas)
    {
      paginaActual = pagina;
    }
  }

  private void NuevoProducto()
  {
    editando = new Models.Producto
    {
      CodigoInterno = string.Empty,
      Descripcion = string.Empty,
      UnidadMedidaCodigo = "77",
      IdTipoIva = tiposIva.FirstOrDefault()?.IdTipoIva ?? 0,
      PrecioUnitarioGs = 0,
      Activo = true,
      UndMedida = "UNIDAD",
      IdSucursal = sucursales.FirstOrDefault()?.Id ?? 0,
  IdClasificacion = null,
  IdDepositoPredeterminado = 1,
  IdMonedaPrecio = monedas.FirstOrDefault(m => m.CodigoISO == "PYG")?.IdMoneda
    };
    undMedidaValue = "UNIDAD";
    pendingImage = null;
    previewDataUrl = null;
    factorPrecio = null;
    porcentajePrecio = null;
    // Resetear variables de paquete
    factorPrecioPaquete = null;
    porcentajePrecioPaquete = null;
  componentesCombo = new();
  costoCalculadoComponentes = null; // Limpiar costo calculado de componentes
  selectedComponenteId = 0;
  cantidadComponente = 1m;
  componenteSearch = string.Empty;
  componenteOpciones.Clear();
  mostrandoOpciones = false;
  selectedOptionIndex = -1;
    mostrarModal = true;
  }

  private void Editar(Models.Producto p)
  {
    editando = new Models.Producto
    {
      IdProducto = p.IdProducto,
      CodigoInterno = p.CodigoInterno,
      Descripcion = p.Descripcion,
      UnidadMedidaCodigo = p.UnidadMedidaCodigo,
      IdTipoIva = p.IdTipoIva,
      PrecioUnitarioGs = p.PrecioUnitarioGs,
      PrecioUnitarioUsd = p.PrecioUnitarioUsd,
      CostoUnitarioGs = p.CostoUnitarioGs,
      CodigoBarras = p.CodigoBarras,
      IdMarca = p.IdMarca,
      TipoItem = p.TipoItem,
      EsCombo = p.EsCombo,
      Activo = p.Activo,
      Foto = p.Foto,
      UndMedida = p.UndMedida,
      IP = p.IP,
      IdSucursal = p.IdSucursal,
      IdClasificacion = p.IdClasificacion,
      IdDepositoPredeterminado = p.IdDepositoPredeterminado ?? depositosCombo.FirstOrDefault()?.IdDeposito ?? 1,
      IdMonedaPrecio = p.IdMonedaPrecio,
      ControladoReceta = p.ControladoReceta,
      PermiteDecimal = p.PermiteDecimal,
      // Campos de paquete/caja
      CantidadPorPaquete = p.CantidadPorPaquete,
      PermiteVentaPorUnidad = p.PermiteVentaPorUnidad,
      // Campos que faltaban - CR√çTICOS para no perder datos al guardar
      ControlarVencimiento = p.ControlarVencimiento,
      FechaVencimiento = p.FechaVencimiento,
      FactorMultiplicador = p.FactorMultiplicador,
      Stock = p.Stock,
      StockMinimo = p.StockMinimo,
      FechaCreacion = p.FechaCreacion,
      UsuarioCreacion = p.UsuarioCreacion,
      FechaModificacion = p.FechaModificacion,
      UsuarioModificacion = p.UsuarioModificacion,
      // Campo Precio Ministerio (farmacia)
      PrecioMinisterio = p.PrecioMinisterio,
      // Campos de descuentos y opciones de venta
      PermiteDescuento = p.PermiteDescuento,
      PermiteVentaBajoCosto = p.PermiteVentaBajoCosto,
      UsaDescuentoEspecifico = p.UsaDescuentoEspecifico,
      DescuentoAutomaticoProducto = p.DescuentoAutomaticoProducto,
      DescuentoMaximoProducto = p.DescuentoMaximoProducto,
      MargenAdicionalCajeroProducto = p.MargenAdicionalCajeroProducto,
      // Campos de precios de paquete
      CostoPaqueteGs = p.CostoPaqueteGs,
      FactorPaquete = p.FactorPaquete,
      MarkupPaquetePct = p.MarkupPaquetePct,
      PrecioPaqueteGs = p.PrecioPaqueteGs,
      PrecioMinisterioPaquete = p.PrecioMinisterioPaquete,
      // Campos de control de lotes (farmacia)
      ControlaLote = p.ControlaLote,
      ControlaVencimiento = p.ControlaVencimiento,
      DiasAlertaVencimiento = p.DiasAlertaVencimiento,
      PermiteVentaVencido = p.PermiteVentaVencido,
      LoteInicialCreado = p.LoteInicialCreado
    };
    undMedidaValue = (p.UndMedida ?? "UNIDAD").Trim();
    pendingImage = null;
    previewDataUrl = null;
    // Cargar lotes si el producto controla lotes
    if (p.ControlaLote)
    {
      _ = CargarLotesProducto();
    }
    else
    {
      lotesProducto.Clear();
    }
    // Calcular factor y porcentaje inicial si hay costo (incluye paquete)
    CalcularFactorYPorcentajeDesdePrecios();
    mostrarModal = true;
    _ = CargarComponentesAsync(editando.IdProducto);
  }

  private async Task AbrirNuevaMarca()
  {
    var nombre = await JS.InvokeAsync<string>("prompt", "Nueva marca (nombre):");
    if (string.IsNullOrWhiteSpace(nombre)) return;
    await using var db = await DbFactory.CreateDbContextAsync();
    var nueva = new Models.Marca { NombreMarca = nombre.Trim() };
    db.Marcas.Add(nueva);
    await db.SaveChangesAsync();
    marcas = await db.Marcas.OrderBy(m => m.NombreMarca).ToListAsync();
    editando.IdMarca = nueva.IdMarca;
    StateHasChanged();
  }

  private async Task AbrirNuevaClasificacion()
  {
    var nombre = await JS.InvokeAsync<string>("prompt", "Nueva clasificaci√≥n (nombre):");
    if (string.IsNullOrWhiteSpace(nombre)) return;
    await using var db = await DbFactory.CreateDbContextAsync();
    var nueva = new Models.Clasificacion { Nombre = nombre.Trim(), Activo = true };
    db.Clasificaciones.Add(nueva);
    await db.SaveChangesAsync();
    clasificaciones = await db.Clasificaciones.Where(c => c.Activo).OrderBy(c => c.Nombre).ToListAsync();
    editando.IdClasificacion = nueva.IdClasificacion;
    StateHasChanged();
  }

  private async Task AbrirNuevoTipoItem()
  {
    var nombre = await JS.InvokeAsync<string>("prompt", "Nuevo tipo de √≠tem (nombre):");
    if (string.IsNullOrWhiteSpace(nombre)) return;
    var esGasto = await JS.InvokeAsync<bool>("confirm", "¬øMarcar este tipo como 'Gasto'? Esto se usar√° para reportes.");
    await using var db = await DbFactory.CreateDbContextAsync();
    var nuevo = new Models.TiposItem { Nombre = nombre.Trim(), EsGasto = esGasto };
    db.TiposItem.Add(nuevo);
    await db.SaveChangesAsync();
    tiposItem = await db.TiposItem.OrderBy(t => t.Nombre).ToListAsync();
    editando.TipoItem = nuevo.IdTipoItem;
    StateHasChanged();
  }

  // ========== M√âTODOS PARA UNIDAD DE MEDIDA / PAQUETE ==========
  
  private void OnUnidadMedidaChanged(ChangeEventArgs e)
  {
    editando.UnidadMedidaCodigo = e.Value?.ToString() ?? "77";
    
    // Si cambia a Paquete (006) o Caja (005), inicializar valores por defecto
    if (editando.UnidadMedidaCodigo == "006" || editando.UnidadMedidaCodigo == "005")
    {
      if (!editando.CantidadPorPaquete.HasValue || editando.CantidadPorPaquete <= 0)
      {
        editando.CantidadPorPaquete = 1; // Valor por defecto
      }
      // Por defecto, permitir venta por unidad cuando es paquete/caja
      editando.PermiteVentaPorUnidad = true;
    }
    else
    {
      // Si cambia a otra unidad, limpiar campos de paquete
      editando.CantidadPorPaquete = null;
      editando.PermiteVentaPorUnidad = true;
    }
    StateHasChanged();
  }
  
  private void OnCantidadPorPaqueteChanged(ChangeEventArgs e)
  {
    var valorStr = e.Value?.ToString()?.Replace(',', '.') ?? "";
    if (decimal.TryParse(valorStr, System.Globalization.NumberStyles.Any, System.Globalization.CultureInfo.InvariantCulture, out var cantidad) && cantidad > 0)
    {
      editando.CantidadPorPaquete = cantidad;
      // Recalcular precios unitarios al cambiar la cantidad por paquete
      RecalcularPreciosUnitariosDesdesPaquete();
    }
    else
    {
      editando.CantidadPorPaquete = 1; // M√≠nimo 1
    }
  }

  // ========== M√âTODOS PARA C√ÅLCULO BIDIRECCIONAL DE PRECIO ==========
  
  private void OnCostoChanged(ChangeEventArgs e)
  {
    if (actualizandoPrecio) return;
    var valorStr = e.Value?.ToString()?.Replace(',', '.') ?? "";
    if (decimal.TryParse(valorStr, System.Globalization.NumberStyles.Any, System.Globalization.CultureInfo.InvariantCulture, out var costo))
    {
      editando.CostoUnitarioGs = costo;
      // Si hay factor, recalcular precio
      if (factorPrecio.HasValue && factorPrecio.Value > 0 && costo > 0)
      {
        actualizandoPrecio = true;
        editando.PrecioUnitarioGs = Math.Round(costo * factorPrecio.Value, 0);
        actualizandoPrecio = false;
      }
      // Si hay porcentaje, recalcular precio
      else if (porcentajePrecio.HasValue && costo > 0)
      {
        actualizandoPrecio = true;
        editando.PrecioUnitarioGs = Math.Round(costo * (1 + porcentajePrecio.Value / 100), 0);
        actualizandoPrecio = false;
      }
    }
    else
    {
      editando.CostoUnitarioGs = null;
    }
  }

  private void OnFactorChanged(ChangeEventArgs e)
  {
    if (actualizandoPrecio) return;
    var valorStr = e.Value?.ToString()?.Replace(',', '.') ?? "";
    if (decimal.TryParse(valorStr, System.Globalization.NumberStyles.Any, System.Globalization.CultureInfo.InvariantCulture, out var factor) && factor > 0)
    {
      factorPrecio = factor;
      actualizandoPrecio = true;
      // Calcular porcentaje equivalente: (factor - 1) * 100
      porcentajePrecio = Math.Round((factor - 1) * 100, 2);
      // Calcular precio si hay costo
      if (editando.CostoUnitarioGs.HasValue && editando.CostoUnitarioGs.Value > 0)
      {
        editando.PrecioUnitarioGs = Math.Round(editando.CostoUnitarioGs.Value * factor, 0);
      }
      actualizandoPrecio = false;
    }
    else
    {
      factorPrecio = null;
    }
  }

  private void OnPorcentajeChanged(ChangeEventArgs e)
  {
    if (actualizandoPrecio) return;
    var valorStr = e.Value?.ToString()?.Replace(',', '.') ?? "";
    if (decimal.TryParse(valorStr, System.Globalization.NumberStyles.Any, System.Globalization.CultureInfo.InvariantCulture, out var porcentaje))
    {
      porcentajePrecio = porcentaje;
      actualizandoPrecio = true;
      // Calcular factor equivalente: 1 + porcentaje/100
      factorPrecio = Math.Round(1 + porcentaje / 100, 4);
      // Calcular precio si hay costo
      if (editando.CostoUnitarioGs.HasValue && editando.CostoUnitarioGs.Value > 0)
      {
        editando.PrecioUnitarioGs = Math.Round(editando.CostoUnitarioGs.Value * (1 + porcentaje / 100), 0);
      }
      actualizandoPrecio = false;
    }
    else
    {
      porcentajePrecio = null;
    }
  }

  private void OnPrecioChanged(ChangeEventArgs e)
  {
    if (actualizandoPrecio) return;
    var valorStr = e.Value?.ToString()?.Replace(',', '.') ?? "";
    if (decimal.TryParse(valorStr, System.Globalization.NumberStyles.Any, System.Globalization.CultureInfo.InvariantCulture, out var precio))
    {
      editando.PrecioUnitarioGs = precio;
      // Si hay costo, recalcular factor y porcentaje
      if (editando.CostoUnitarioGs.HasValue && editando.CostoUnitarioGs.Value > 0)
      {
        actualizandoPrecio = true;
        var costo = editando.CostoUnitarioGs.Value;
        factorPrecio = Math.Round(precio / costo, 4);
        porcentajePrecio = Math.Round((precio / costo - 1) * 100, 2);
        actualizandoPrecio = false;
      }
    }
  }

  private void OnPrecioMinisterioChanged(ChangeEventArgs e)
  {
    var valorStr = e.Value?.ToString()?.Replace(',', '.') ?? "";
    if (string.IsNullOrWhiteSpace(valorStr))
    {
      editando.PrecioMinisterio = null;
    }
    else if (decimal.TryParse(valorStr, System.Globalization.NumberStyles.Any, System.Globalization.CultureInfo.InvariantCulture, out var precio))
    {
      editando.PrecioMinisterio = precio;
    }
  }

  // ========== M√âTODOS PARA PRECIOS DE PAQUETE ==========
  
  private void OnCostoPaqueteChanged(ChangeEventArgs e)
  {
    if (actualizandoPrecioPaquete) return;
    var valorStr = e.Value?.ToString()?.Replace(',', '.') ?? "";
    if (decimal.TryParse(valorStr, System.Globalization.NumberStyles.Any, System.Globalization.CultureInfo.InvariantCulture, out var costo))
    {
      editando.CostoPaqueteGs = costo;
      // Si hay factor, recalcular precio paquete
      if (factorPrecioPaquete.HasValue && factorPrecioPaquete.Value > 0 && costo > 0)
      {
        actualizandoPrecioPaquete = true;
        editando.PrecioPaqueteGs = Math.Round(costo * factorPrecioPaquete.Value, 0);
        actualizandoPrecioPaquete = false;
      }
      // Si hay porcentaje, recalcular precio paquete
      else if (porcentajePrecioPaquete.HasValue && costo > 0)
      {
        actualizandoPrecioPaquete = true;
        editando.PrecioPaqueteGs = Math.Round(costo * (1 + porcentajePrecioPaquete.Value / 100), 0);
        actualizandoPrecioPaquete = false;
      }
      // Calcular costo unitario desde costo paquete
      RecalcularPreciosUnitariosDesdesPaquete();
    }
    else
    {
      editando.CostoPaqueteGs = null;
    }
  }

  private void OnFactorPaqueteChanged(ChangeEventArgs e)
  {
    if (actualizandoPrecioPaquete) return;
    var valorStr = e.Value?.ToString()?.Replace(',', '.') ?? "";
    if (decimal.TryParse(valorStr, System.Globalization.NumberStyles.Any, System.Globalization.CultureInfo.InvariantCulture, out var factor) && factor > 0)
    {
      factorPrecioPaquete = factor;
      editando.FactorPaquete = factor;
      actualizandoPrecioPaquete = true;
      // Calcular porcentaje equivalente: (factor - 1) * 100
      porcentajePrecioPaquete = Math.Round((factor - 1) * 100, 2);
      editando.MarkupPaquetePct = porcentajePrecioPaquete;
      // Calcular precio si hay costo
      if (editando.CostoPaqueteGs.HasValue && editando.CostoPaqueteGs.Value > 0)
      {
        editando.PrecioPaqueteGs = Math.Round(editando.CostoPaqueteGs.Value * factor, 0);
      }
      actualizandoPrecioPaquete = false;
      
      // Sincronizar factor y porcentaje a precios unitarios
      factorPrecio = factor;
      editando.FactorMultiplicador = factor;
      porcentajePrecio = porcentajePrecioPaquete;
      
      // Recalcular precios unitarios
      RecalcularPreciosUnitariosDesdesPaquete();
    }
    else
    {
      factorPrecioPaquete = null;
      editando.FactorPaquete = null;
    }
  }

  private void OnPorcentajePaqueteChanged(ChangeEventArgs e)
  {
    if (actualizandoPrecioPaquete) return;
    var valorStr = e.Value?.ToString()?.Replace(',', '.') ?? "";
    if (decimal.TryParse(valorStr, System.Globalization.NumberStyles.Any, System.Globalization.CultureInfo.InvariantCulture, out var porcentaje))
    {
      porcentajePrecioPaquete = porcentaje;
      editando.MarkupPaquetePct = porcentaje;
      actualizandoPrecioPaquete = true;
      // Calcular factor equivalente: 1 + porcentaje/100
      factorPrecioPaquete = Math.Round(1 + porcentaje / 100, 4);
      editando.FactorPaquete = factorPrecioPaquete;
      // Calcular precio si hay costo
      if (editando.CostoPaqueteGs.HasValue && editando.CostoPaqueteGs.Value > 0)
      {
        editando.PrecioPaqueteGs = Math.Round(editando.CostoPaqueteGs.Value * (1 + porcentaje / 100), 0);
      }
      actualizandoPrecioPaquete = false;
      
      // Sincronizar factor y porcentaje a precios unitarios
      factorPrecio = factorPrecioPaquete;
      editando.FactorMultiplicador = factorPrecioPaquete;
      porcentajePrecio = porcentaje;
      
      // Recalcular precios unitarios
      RecalcularPreciosUnitariosDesdesPaquete();
    }
    else
    {
      porcentajePrecioPaquete = null;
      editando.MarkupPaquetePct = null;
    }
  }

  private void OnPrecioPaqueteChanged(ChangeEventArgs e)
  {
    if (actualizandoPrecioPaquete) return;
    var valorStr = e.Value?.ToString()?.Replace(',', '.') ?? "";
    if (decimal.TryParse(valorStr, System.Globalization.NumberStyles.Any, System.Globalization.CultureInfo.InvariantCulture, out var precio))
    {
      editando.PrecioPaqueteGs = precio;
      // Si hay costo paquete, recalcular factor y porcentaje
      if (editando.CostoPaqueteGs.HasValue && editando.CostoPaqueteGs.Value > 0)
      {
        actualizandoPrecioPaquete = true;
        var costo = editando.CostoPaqueteGs.Value;
        factorPrecioPaquete = Math.Round(precio / costo, 4);
        editando.FactorPaquete = factorPrecioPaquete;
        porcentajePrecioPaquete = Math.Round((precio / costo - 1) * 100, 2);
        editando.MarkupPaquetePct = porcentajePrecioPaquete;
        
        // Sincronizar a unitarios
        factorPrecio = factorPrecioPaquete;
        editando.FactorMultiplicador = factorPrecioPaquete;
        porcentajePrecio = porcentajePrecioPaquete;
        
        actualizandoPrecioPaquete = false;
      }
      // Recalcular precio unitario
      RecalcularPreciosUnitariosDesdesPaquete();
    }
  }

  private void OnPrecioMinisterioPaqueteChanged(ChangeEventArgs e)
  {
    var valorStr = e.Value?.ToString()?.Replace(',', '.') ?? "";
    if (string.IsNullOrWhiteSpace(valorStr))
    {
      editando.PrecioMinisterioPaquete = null;
    }
    else if (decimal.TryParse(valorStr, System.Globalization.NumberStyles.Any, System.Globalization.CultureInfo.InvariantCulture, out var precio))
    {
      editando.PrecioMinisterioPaquete = precio;
      // Calcular precio ministerio unitario
      RecalcularPreciosUnitariosDesdesPaquete();
    }
  }

  /// <summary>
  /// Recalcula los precios unitarios diviendo los precios de paquete entre CantidadPorPaquete.
  /// Solo aplica si el producto es tipo Paquete (c√≥digo 006) o Caja (c√≥digo 005).
  /// </summary>
  private void RecalcularPreciosUnitariosDesdesPaquete()
  {
    // Solo aplicar si es Paquete o Caja y hay cantidad definida
    if ((editando.UnidadMedidaCodigo != "006" && editando.UnidadMedidaCodigo != "005") || 
        !editando.CantidadPorPaquete.HasValue || editando.CantidadPorPaquete.Value <= 0)
    {
      return;
    }
    
    var cantidadPorPaquete = editando.CantidadPorPaquete.Value;
    
    // Calcular Costo Unitario = Costo Paquete / Cantidad (CON DECIMALES)
    if (editando.CostoPaqueteGs.HasValue && editando.CostoPaqueteGs.Value > 0)
    {
      editando.CostoUnitarioGs = Math.Round(editando.CostoPaqueteGs.Value / cantidadPorPaquete, 2);
    }
    
    // Recalcular Precio Ministerio Unitario = Precio Ministerio Paquete / Cantidad
    if (editando.PrecioMinisterioPaquete.HasValue && editando.PrecioMinisterioPaquete.Value > 0)
    {
      editando.PrecioMinisterio = Math.Round(editando.PrecioMinisterioPaquete.Value / cantidadPorPaquete, 0);
    }
  }

  private void CalcularFactorYPorcentajeDesdePrecios()
  {
    // Calcular factor y porcentaje para precio unitario
    if (editando.CostoUnitarioGs.HasValue && editando.CostoUnitarioGs.Value > 0 && editando.PrecioUnitarioGs > 0)
    {
      var costo = editando.CostoUnitarioGs.Value;
      var precio = editando.PrecioUnitarioGs;
      factorPrecio = Math.Round(precio / costo, 4);
      porcentajePrecio = Math.Round((precio / costo - 1) * 100, 2);
    }
    else
    {
      factorPrecio = null;
      porcentajePrecio = null;
    }
    
    // Calcular factor y porcentaje para precio de paquete
    if (editando.CostoPaqueteGs.HasValue && editando.CostoPaqueteGs.Value > 0 && editando.PrecioPaqueteGs.HasValue && editando.PrecioPaqueteGs > 0)
    {
      var costo = editando.CostoPaqueteGs.Value;
      var precio = editando.PrecioPaqueteGs.Value;
      factorPrecioPaquete = Math.Round(precio / costo, 4);
      porcentajePrecioPaquete = Math.Round((precio / costo - 1) * 100, 2);
    }
    else if (editando.FactorPaquete.HasValue)
    {
      factorPrecioPaquete = editando.FactorPaquete;
      porcentajePrecioPaquete = editando.MarkupPaquetePct;
    }
    else
    {
      factorPrecioPaquete = null;
      porcentajePrecioPaquete = null;
    }
  }
  // ========== FIN M√âTODOS C√ÅLCULO PRECIO ==========

  private async Task Guardar()
  {
    // ========== PROTECCI√ìN CONTRA DOBLE GUARDADO ==========
    if (_guardando)
    {
      Console.WriteLine("[Productos] Clic duplicado en Guardar ignorado - operaci√≥n en curso");
      return;
    }
    
    if (string.IsNullOrWhiteSpace(editando.Descripcion) || string.IsNullOrWhiteSpace(editando.UnidadMedidaCodigo) || string.IsNullOrWhiteSpace(undMedidaValue) || editando.IdSucursal <= 0)
    {
      await JS.InvokeVoidAsync("alert", "Complete Descripci√≥n, Unidad SIFEN, UndMedida y Sucursal");
      return;
    }
    
    _guardando = true;
    await InvokeAsync(StateHasChanged);
    
    try
    {
      // Validar cantidad por paquete cuando la unidad es Paquete o Caja
      if ((editando.UnidadMedidaCodigo == "006" || editando.UnidadMedidaCodigo == "005") 
          && (!editando.CantidadPorPaquete.HasValue || editando.CantidadPorPaquete <= 0))
      {
        await JS.InvokeVoidAsync("alert", "Ingrese la cantidad de unidades por " + (editando.UnidadMedidaCodigo == "006" ? "paquete" : "caja"));
        return;
      }
      
      // Si es paquete o caja, asegurar que PermiteVentaPorUnidad est√© en true por defecto
      if (editando.UnidadMedidaCodigo == "006" || editando.UnidadMedidaCodigo == "005")
      {
        // Solo forzar true si el usuario no lo desactiv√≥ manualmente (dejarlo como est√° si ya tiene valor)
        // Nota: En productos nuevos, el valor por defecto es true gracias a OnUnidadMedidaChanged
      }
    
    // Validar Precio Ministerio (solo si est√° activa la validaci√≥n en configuraci√≥n)
    if (ValidarPrecioMinisterio && editando.PrecioMinisterio.HasValue && editando.PrecioUnitarioGs > editando.PrecioMinisterio.Value)
    {
      await JS.InvokeVoidAsync("alert", $"El Precio Unitario ({editando.PrecioUnitarioGs:N0} Gs) no puede superar el Precio Ministerio ({editando.PrecioMinisterio.Value:N0} Gs)");
      return;
    }
    
    editando.UndMedida = undMedidaValue.Trim();
    await using var db = await DbFactory.CreateDbContextAsync();

    // Validar c√≥digo de barras √∫nico (si se proporcion√≥)
    if (!string.IsNullOrWhiteSpace(editando.CodigoBarras))
    {
      var codigoBarrasDuplicado = await db.Productos
        .AnyAsync(p => p.CodigoBarras == editando.CodigoBarras && p.IdProducto != editando.IdProducto);
      if (codigoBarrasDuplicado)
      {
        await JS.InvokeVoidAsync("alert", "Ya existe otro producto con ese c√≥digo de barras");
        return;
      }
    }

    // Guardar imagen pendiente si existe
    var savedImg = await GuardarImagenPendienteAsync();
    if (!string.IsNullOrWhiteSpace(savedImg))
    {
      editando.Foto = savedImg;
    }
    
    // Guardar el factor multiplicador si se especific√≥
    if (factorPrecio.HasValue && factorPrecio.Value > 0)
    {
      editando.FactorMultiplicador = factorPrecio.Value;
    }
    
    // Actualizar fecha de modificaci√≥n
    editando.FechaModificacion = DateTime.Now;
    
    if (editando.IdProducto == 0)
    {
      // Si no se seleccion√≥ dep√≥sito predeterminado, usar el dep√≥sito 1 (Principal)
      if (!editando.IdDepositoPredeterminado.HasValue)
      {
        editando.IdDepositoPredeterminado = 1;
      }
      // Asegurar que el campo requerido no quede vac√≠o antes del primer Save
      if (string.IsNullOrWhiteSpace(editando.CodigoInterno)) editando.CodigoInterno = "AUTO";
      db.Productos.Add(editando);
      await db.SaveChangesAsync();

      // Generar c√≥digo definitivo basado en el Id y sucursal
      editando.CodigoInterno = $"PROD-{editando.IdSucursal:000}-{editando.IdProducto:000000}";
      db.Productos.Update(editando);
      await db.SaveChangesAsync();
    }
    else
    {
      db.Productos.Update(editando);
      await db.SaveChangesAsync();
    }

    // ========== CREAR LOTE INICIAL AUTOM√ÅTICAMENTE ==========
    // Si se activ√≥ control de lotes y no se ha creado el lote inicial, crearlo autom√°ticamente
    if (editando.ControlaLote && !editando.LoteInicialCreado)
    {
      await CrearLoteInicialAutomatico(db);
      // Recargar los lotes despu√©s de crearlos
      await CargarLotesProducto();
    }
    
    // ========== VALIDAR LOTES SIN FECHA DE VENCIMIENTO ==========
    // Si el producto controla lotes, verificar que todos tengan fecha de vencimiento
    if (editando.ControlaLote && editando.IdProducto > 0)
    {
      // Recargar lotes para tener la lista actualizada
      await CargarLotesProducto();
      
      var lotesSinVencimiento = lotesProducto.Where(l => !l.FechaVencimiento.HasValue).ToList();
      if (lotesSinVencimiento.Any())
      {
        var nombresLotes = string.Join(", ", lotesSinVencimiento.Select(l => l.NumeroLote));
        var confirmar = await JS.InvokeAsync<bool>("confirm", 
          $"‚ö†Ô∏è LOTES SIN FECHA DE VENCIMIENTO\n\n" +
          $"Los siguientes lotes no tienen fecha de vencimiento:\n{nombresLotes}\n\n" +
          $"Se recomienda editar cada lote y agregar la fecha de vencimiento para el correcto control de stock.\n\n" +
          $"¬øDesea continuar de todas formas?");
        
        if (!confirmar)
        {
          // Abrir el modal de lotes para que el usuario pueda editarlos
          mostrarModalLotes = true;
          return;
        }
      }
    }

  // Limpiar estado de imagen temporal
  pendingImage = null;
  previewDataUrl = null;
  var mensaje = editando.ControlaLote && lotesProducto.Any() 
    ? $"Producto guardado. Se crearon {lotesProducto.Count} lote(s) autom√°ticamente."
    : "Producto guardado";
  await JS.InvokeVoidAsync("alert", mensaje);
    mostrarModal = false;
    await Cargar();
    }
    finally
    {
      _guardando = false;
      await InvokeAsync(StateHasChanged);
    }
  }

  private async Task CargarComponentesAsync(int idProducto)
  {
    await using var db = await DbFactory.CreateDbContextAsync();
    componentesCombo = await db.ProductosComponentes
      .Include(pc => pc.Componente)
      .Where(pc => pc.IdProducto == idProducto && pc.Activo)
      .OrderBy(pc => pc.Componente!.Descripcion)
      .ToListAsync();
    
    // Calcular costo total de componentes
    CalcularCostoComponentes();
    
    StateHasChanged();
  }

  private async Task AgregarComponente()
  {
    if (editando.IdProducto <= 0) { await JS.InvokeVoidAsync("alert", "Guarde primero el producto"); return; }
    if (selectedComponenteId <= 0 || cantidadComponente <= 0) { return; }
    if (selectedComponenteId == editando.IdProducto) { await JS.InvokeVoidAsync("alert", "No puede agregarse a s√≠ mismo"); return; }
    await using var db = await DbFactory.CreateDbContextAsync();
    var existe = await db.ProductosComponentes.AnyAsync(pc => pc.IdProducto == editando.IdProducto && pc.IdComponente == selectedComponenteId);
    if (existe) { await JS.InvokeVoidAsync("alert", "Ese componente ya est√° en el combo"); return; }
    var comp = await db.Productos.FindAsync(selectedComponenteId);
    if (comp is null) { await JS.InvokeVoidAsync("alert", "Componente no encontrado"); return; }
    db.ProductosComponentes.Add(new Models.ProductoComponente
    {
      IdProducto = editando.IdProducto,
      IdComponente = selectedComponenteId,
      Cantidad = cantidadComponente,
      UnidadMedida = comp.UndMedida?.Trim(),
      Activo = true,
      FechaCreacion = DateTime.Now,
      UsuarioCreacion = "Sistema"
    });
    await db.SaveChangesAsync();
    selectedComponenteId = 0;
    cantidadComponente = 1m;
  componenteSearch = string.Empty;
  componenteOpciones.Clear();
  mostrandoOpciones = false;
  selectedOptionIndex = -1;
    await CargarComponentesAsync(editando.IdProducto);
  }

  private async Task QuitarComponente(int idProductoComponente)
  {
    await using var db = await DbFactory.CreateDbContextAsync();
    var pc = await db.ProductosComponentes.FirstOrDefaultAsync(x => x.IdProductoComponente == idProductoComponente);
    if (pc is null) return;
    db.ProductosComponentes.Remove(pc);
    await db.SaveChangesAsync();
    await CargarComponentesAsync(editando.IdProducto);
  }

  /// <summary>
  /// Calcula el costo total del combo sumando (costo componente √ó cantidad) de cada componente
  /// </summary>
  private void CalcularCostoComponentes()
  {
    if (componentesCombo.Count == 0)
    {
      costoCalculadoComponentes = null;
      return;
    }
    
    decimal total = 0m;
    foreach (var pc in componentesCombo)
    {
      var costoComp = pc.Componente?.CostoUnitarioGs ?? 0m;
      total += costoComp * pc.Cantidad;
    }
    costoCalculadoComponentes = total;
  }

  /// <summary>
  /// Aplica el costo calculado de componentes al precio de costo del producto combo
  /// </summary>
  private async Task AplicarCostoCalculado()
  {
    if (!costoCalculadoComponentes.HasValue || costoCalculadoComponentes.Value <= 0)
    {
      await JS.InvokeVoidAsync("alert", "No hay costo calculado para aplicar. Verifique que los componentes tengan costo asignado.");
      return;
    }
    
    editando.CostoUnitarioGs = costoCalculadoComponentes.Value;
    
    // Tambi√©n actualizar en BD si ya existe
    if (editando.IdProducto > 0)
    {
      await using var db = await DbFactory.CreateDbContextAsync();
      var prod = await db.Productos.FindAsync(editando.IdProducto);
      if (prod != null)
      {
        prod.CostoUnitarioGs = costoCalculadoComponentes.Value;
        prod.FechaModificacion = DateTime.Now;
        await db.SaveChangesAsync();
      }
    }
    
    StateHasChanged();
  }

  private void ShowComponenteOpciones()
  {
    mostrandoOpciones = true;
  if (componenteOpciones.Count > 0 && selectedOptionIndex < 0) selectedOptionIndex = 0;
  }

  private async Task BuscarComponentesAsync(string term, CancellationToken ct)
  {
    term = (term ?? string.Empty).Trim();
    if (string.IsNullOrWhiteSpace(term))
    {
      componenteOpciones = new();
      selectedOptionIndex = -1;
      StateHasChanged();
      return;
    }
    await using var db = await DbFactory.CreateDbContextAsync();
    var q = db.Productos.AsNoTracking()
      .Where(p => !p.EsCombo && p.IdProducto != editando.IdProducto && (
        p.Descripcion.Contains(term) || p.CodigoInterno.Contains(term)))
      .OrderBy(p => p.Descripcion)
      .Take(20);
    componenteOpciones = await q.ToListAsync(ct);
    selectedOptionIndex = componenteOpciones.Count > 0 ? 0 : -1;
    StateHasChanged();
  }

  private async Task OnComponenteSearchChanged(ChangeEventArgs e)
  {
    componenteSearch = e.Value?.ToString() ?? string.Empty;
    selectedComponenteId = 0;
    mostrandoOpciones = true;
  selectedOptionIndex = -1;
    _searchCts?.Cancel();
    _searchCts = new CancellationTokenSource();
    var token = _searchCts.Token;
    try
    {
      await Task.Delay(200, token); // debounce
      await BuscarComponentesAsync(componenteSearch, token);
    }
    catch (TaskCanceledException) { }
  }

  private void SeleccionarComponente(Models.Producto pr)
  {
    selectedComponenteId = pr.IdProducto;
    componenteSearch = pr.Descripcion;
    mostrandoOpciones = false;
    selectedOptionIndex = -1;
  }

  private async Task OnComponenteBlur(FocusEventArgs e)
  {
    // Peque√±o retraso para permitir click en una opci√≥n antes de cerrar
    await Task.Delay(150);
    mostrandoOpciones = false;
    StateHasChanged();
  }

  private void OnComponenteKeyDown(KeyboardEventArgs e)
  {
    if (!mostrandoOpciones) return;
    if (e.Key == "ArrowDown")
    {
      if (componenteOpciones.Count == 0) return;
      selectedOptionIndex = (selectedOptionIndex + 1 + componenteOpciones.Count) % componenteOpciones.Count;
    }
    else if (e.Key == "ArrowUp")
    {
      if (componenteOpciones.Count == 0) return;
      selectedOptionIndex = (selectedOptionIndex - 1 + componenteOpciones.Count) % componenteOpciones.Count;
    }
    else if (e.Key == "Enter")
    {
      if (selectedOptionIndex >= 0 && selectedOptionIndex < componenteOpciones.Count)
      {
        SeleccionarComponente(componenteOpciones[selectedOptionIndex]);
      }
    }
    else if (e.Key == "Escape")
    {
      mostrandoOpciones = false;
    }
  }

  private async Task Eliminar(Models.Producto p)
  {
    if (!await JS.InvokeAsync<bool>("confirm", $"¬øEliminar {p.Descripcion}?") ) return;
    await using var db = await DbFactory.CreateDbContextAsync();
    db.Productos.Remove(p);
    await db.SaveChangesAsync();
    await Cargar();
  }

  private void Cerrar()
  {
    pendingImage = null;
    previewDataUrl = null;
    mostrarModal = false;
  }
  private async Task SubmitForm() => await Guardar();

  private async Task OnFileSelected(InputFileChangeEventArgs e)
  {
    try
    {
      var file = e.File;
      if (file is null) return;
      var allowed = new[] { "image/png", "image/jpeg", "image/webp", "image/gif", "image/svg+xml" };
      if (!allowed.Contains(file.ContentType))
      {
        await JS.InvokeVoidAsync("alert", "Formato no permitido. Use PNG/JPG/WEBP/GIF/SVG");
        return;
      }
      pendingImage = file;
      using var ms = new MemoryStream();
      await file.OpenReadStream(maxAllowedSize: 2 * 1024 * 1024).CopyToAsync(ms);
      var base64 = Convert.ToBase64String(ms.ToArray());
      previewDataUrl = $"data:{file.ContentType};base64,{base64}";
      StateHasChanged();
    }
    catch (Exception ex)
    {
      await JS.InvokeVoidAsync("alert", $"Error al cargar la imagen: {ex.Message}");
    }
  }

  private void AbrirEtiqueta(Models.Producto p)
  {
  _suspendRenderEtiqueta = true; // evitar render hasta que el modal est√© visible
    etiquetaProducto = p;
    if (!string.IsNullOrWhiteSpace(p.CodigoBarras))
    {
      if (p.CodigoBarras.Length == 13) { barcodeFormat = "EAN13"; barcodeCode = p.CodigoBarras; }
      else if (p.CodigoBarras.Length == 12) { barcodeFormat = "UPC"; barcodeCode = p.CodigoBarras; }
      else { barcodeFormat = "CODE128"; barcodeCode = p.CodigoBarras; }
    }
    else
    {
      barcodeFormat = "CODE128";
      barcodeCode = GenerarCodigoAuto();
    }
    mostrarEtiqueta = true;
    _etiquetaRenderizada = false; // se renderizar√° en OnAfterRenderAsync
  _suspendRenderEtiqueta = false;
  }

  private void CerrarEtiqueta()
  {
    mostrarEtiqueta = false;
    etiquetaProducto = null;
    _etiquetaRenderizada = false;
  }

  private async Task RenderEtiqueta()
  {
    try
    {
      if (!mostrarEtiqueta || _suspendRenderEtiqueta) return;
      await Task.Delay(10); // peque√±o retraso para asegurar DOM listo
      // Verificar readiness del wrapper y JsBarcode
      var ready = await JS.InvokeAsync<bool>("BarcodeInterop.isReady");
      if (!ready) return;
      var fmt = barcodeFormat; // JsBarcode: EAN13 | UPC | CODE128
      var code = barcodeCode;
      if (string.IsNullOrWhiteSpace(code)) code = ean13; // compat
  var sub = barcodeShowName ? (etiquetaProducto?.Descripcion ?? editando?.Descripcion ?? "") : null;
  var ok = await JS.InvokeAsync<bool>("BarcodeInterop.render", "#barcodePreview", code, new { format = fmt, width = barcodeWidth, height = barcodeHeight, displayValue = barcodeShowText, margin = barcodeMargin, subText = sub, subTextFontSize = 10, subTextMarginTop = 0 });
      if (ok) _etiquetaRenderizada = true;
    }
    catch (JSException)
    {
      // Si el script a√∫n no est√° cargado, intenta silenciosamente m√°s tarde
    }
  }

  private async Task ImprimirEtiqueta()
  {
    try
    {
      var ready = await JS.InvokeAsync<bool>("BarcodeInterop.isReady");
      if (!ready)
      {
        await RenderEtiqueta();
        ready = await JS.InvokeAsync<bool>("BarcodeInterop.isReady");
        if (!ready) return;
      }
      await JS.InvokeAsync<bool>("BarcodeInterop.print", "#barcodePreview");
    }
    catch (JSException)
    {
      // Ignora si no est√° listo
    }
  }

  private string GenerarEan13()
  {
    // Generar 12 d√≠gitos base a partir del Id y sucursal si existen, completando con aleatorio
    var rnd = Random.Shared;
    string base12;
    if (etiquetaProducto != null && etiquetaProducto.IdProducto > 0)
    {
      base12 = $"{(etiquetaProducto.IdSucursal % 100):00}{(etiquetaProducto.IdProducto % 1000000000):0000000000}";
      base12 = base12.Substring(0, 12);
    }
    else
    {
      base12 = string.Concat(Enumerable.Range(0, 12).Select(_ => rnd.Next(0, 10).ToString()));
    }
    int check = CalcularDigitoVerificadorEan13(base12);
    return base12 + check.ToString();
  }

  private int CalcularDigitoVerificadorEan13(string base12)
  {
    // Algoritmo est√°ndar EAN-13: suma impares + 3*suma pares; d√≠gito = (10 - (sum % 10)) % 10
    int sum = 0;
    for (int i = 0; i < 12; i++)
    {
      int digit = base12[i] - '0';
      if ((i % 2) == 0) sum += digit; else sum += 3 * digit;
    }
    int check = (10 - (sum % 10)) % 10;
    return check;
  }

  private async Task GenerarEanAutoClick()
  {
  barcodeCode = GenerarCodigoAuto();
    for (var i = 0; i < 5 && !_etiquetaRenderizada; i++)
    {
      await RenderEtiqueta();
      if (_etiquetaRenderizada) break;
      await Task.Delay(50);
    }
  }

  private string GenerarCodigoAuto()
  {
    return barcodeFormat switch
    {
      "EAN13" => GenerarEan13(),
      "UPC" => GenerarUpcA(),
      _ => GenerarCode128()
    };
  }

  private string GenerarUpcA()
  {
    // UPC-A: 12 d√≠gitos con DV
    var rnd = Random.Shared;
    string base11;
    if (etiquetaProducto != null && etiquetaProducto.IdProducto > 0)
    {
      base11 = $"{(etiquetaProducto.IdSucursal % 100):00}{(etiquetaProducto.IdProducto % 1000000000):0000000000}".Substring(0, 11);
    }
    else
    {
      base11 = string.Concat(Enumerable.Range(0, 11).Select(_ => rnd.Next(0, 10).ToString()));
    }
    int sumOdd = 0, sumEven = 0;
    for (int i = 0; i < 11; i++)
    {
      int d = base11[i] - '0';
      if ((i % 2) == 0) sumOdd += d; else sumEven += d;
    }
    int total = sumOdd * 3 + sumEven;
    int dv = (10 - (total % 10)) % 10;
    return base11 + dv.ToString();
  }

  private string GenerarCode128()
  {
    if (etiquetaProducto != null)
    {
      if (!string.IsNullOrWhiteSpace(etiquetaProducto.CodigoInterno)) return etiquetaProducto.CodigoInterno;
      if (etiquetaProducto.IdProducto > 0) return $"PROD-{etiquetaProducto.IdSucursal:000}-{etiquetaProducto.IdProducto:000000}";
    }
    return $"PROD-{DateTime.UtcNow:yyyyMMddHHmmss}";
  }

  private async Task<string?> GuardarImagenPendienteAsync()
  {
    if (pendingImage is null) return null;
    var file = pendingImage;
    var uploads = Path.Combine(Env.WebRootPath, "uploads", "productos");
    Directory.CreateDirectory(uploads);
    var ext = Path.GetExtension(file.Name);
    if (string.IsNullOrWhiteSpace(ext))
    {
      ext = file.ContentType switch
      {
        "image/png" => ".png",
        "image/jpeg" => ".jpg",
        "image/webp" => ".webp",
        "image/gif" => ".gif",
        "image/svg+xml" => ".svg",
        _ => ".img"
      };
    }
    var name = $"{Guid.NewGuid():N}{ext.ToLower()}";
    var path = Path.Combine(uploads, name);
    await using (var stream = File.Create(path))
    {
      await file.OpenReadStream(maxAllowedSize: 2 * 1024 * 1024).CopyToAsync(stream);
    }
    return $"/uploads/productos/{name}";
  }

  // Stocks por dep√≥sito
  private bool mostrarStocks = false;
  private Models.Producto? productoStocks;
  private IReadOnlyList<Models.ProductoDeposito>? stocksDepositos;
  private async Task AbrirStocks(Models.Producto p)
  {
    productoStocks = p;
    mostrarStocks = true;
    stocksDepositos = null;
    try
    {
      stocksDepositos = await Inventario.ObtenerStocksPorProductoAsync(p.IdProducto);
    }
    catch { stocksDepositos = Array.Empty<Models.ProductoDeposito>(); }
    StateHasChanged();
  }
  private void CerrarStocks()
  {
    mostrarStocks = false;
    productoStocks = null;
    stocksDepositos = null;
  }

  // ========== M√âTODOS DE CONTROL DE LOTES ==========

  /// <summary>
  /// Crea autom√°ticamente lotes STOCK-INICIAL para el stock existente al activar control de lotes.
  /// Este m√©todo se llama desde Guardar() cuando se activa ControlaLote.
  /// Considera tanto ProductosDepositos como el Stock directo del Producto.
  /// </summary>
  private async Task CrearLoteInicialAutomatico(AppDbContext db)
  {
    var lotesCreados = 0;
    
    // 1. Obtener stock de ProductosDepositos (si hay registros espec√≠ficos)
    var stocksPorDeposito = await db.ProductosDepositos
      .Where(pd => pd.IdProducto == editando.IdProducto && pd.Stock > 0)
      .ToListAsync();

    // 2. Crear lotes para cada dep√≥sito con stock en ProductosDepositos
    foreach (var pd in stocksPorDeposito)
    {
      if (await CrearLoteInicialParaDeposito(db, pd.IdDeposito, pd.Stock))
        lotesCreados++;
    }

    // 3. Si NO hay registros en ProductosDepositos pero el producto tiene stock directo,
    //    crear lote en el dep√≥sito predeterminado
    if (!stocksPorDeposito.Any() && editando.Stock > 0)
    {
      // Usar el dep√≥sito predeterminado del producto, o el primer dep√≥sito si no tiene
      var idDeposito = editando.IdDepositoPredeterminado 
                    ?? await db.Depositos.Where(d => d.Activo == true).Select(d => d.IdDeposito).FirstOrDefaultAsync();
      
      if (idDeposito > 0)
      {
        if (await CrearLoteInicialParaDeposito(db, idDeposito, editando.Stock))
          lotesCreados++;
      }
    }

    // 4. Marcar como creado aunque no haya stock (para no repetir el proceso)
    editando.LoteInicialCreado = true;
    db.Productos.Update(editando);
    await db.SaveChangesAsync();
    
    if (lotesCreados > 0)
    {
      Console.WriteLine($"[LOTES] Creados {lotesCreados} lote(s) STOCK-INICIAL para producto {editando.IdProducto}");
    }
  }

  /// <summary>
  /// Crea un lote STOCK-INICIAL para un dep√≥sito espec√≠fico si no existe.
  /// </summary>
  private async Task<bool> CrearLoteInicialParaDeposito(AppDbContext db, int idDeposito, decimal stock)
  {
    if (stock <= 0) return false;
    
    // Verificar que no exista ya un lote inicial para este dep√≥sito
    var yaExiste = await db.ProductosLotes
      .AnyAsync(l => l.IdProducto == editando.IdProducto 
                  && l.IdDeposito == idDeposito 
                  && l.NumeroLote == "STOCK-INICIAL");
    
    if (yaExiste) return false;

    var loteInicial = new Models.ProductoLote
    {
      IdProducto = editando.IdProducto,
      IdDeposito = idDeposito,
      NumeroLote = "STOCK-INICIAL",
      FechaVencimiento = null, // Sin vencimiento definido
      Stock = stock,
      StockInicial = stock,
      Estado = "Activo",
      EsLoteInicial = true,
      FechaCreacion = DateTime.Now,
      UsuarioCreacion = "Sistema",
      Observacion = "Lote creado autom√°ticamente al activar control de lotes"
    };

    db.ProductosLotes.Add(loteInicial);
    await db.SaveChangesAsync();

    // Registrar movimiento inicial
    var movimiento = new Models.MovimientoLote
    {
      IdProductoLote = loteInicial.IdProductoLote,
      TipoMovimiento = TipoMovimientoLote.Inicial,
      Cantidad = stock,
      StockAnterior = 0,
      StockPosterior = stock,
      Motivo = "Migraci√≥n autom√°tica de stock existente al activar control de lotes",
      FechaMovimiento = DateTime.Now,
      Usuario = "Sistema"
    };
    db.MovimientosLotes.Add(movimiento);
    await db.SaveChangesAsync();
    
    return true;
  }
  
  private async Task OnControlaLoteChanged()
  {
    // Si se DESACTIVA el control de lotes y el producto ya existe
    if (!editando.ControlaLote && editando.IdProducto > 0)
    {
      await using var db = await DbFactory.CreateDbContextAsync();
      
      // Verificar si tiene lotes con stock > 0
      var lotesConStock = await db.ProductosLotes
        .Where(l => l.IdProducto == editando.IdProducto && l.Stock > 0)
        .Select(l => new { l.NumeroLote, l.Stock })
        .ToListAsync();
      
      if (lotesConStock.Any())
      {
        // ‚ùå NO PERMITIR desactivar si hay lotes con stock
        var totalStock = lotesConStock.Sum(l => l.Stock);
        var detalleLotes = string.Join("\n", lotesConStock.Take(5).Select(l => $"  ‚Ä¢ {l.NumeroLote}: {l.Stock:N2} unidades"));
        if (lotesConStock.Count > 5)
          detalleLotes += $"\n  ... y {lotesConStock.Count - 5} lote(s) m√°s";
        
        var mensaje = $"‚ùå NO SE PUEDE DESACTIVAR\n\n" +
          $"Este producto tiene {lotesConStock.Count} lote(s) con stock activo:\n\n" +
          $"{detalleLotes}\n\n" +
          $"Stock total en lotes: {totalStock:N2} unidades\n\n" +
          $"Para desactivar el control de lotes debe:\n\n" +
          $"1. Ir a Inventario ‚Üí Ajustes de Stock\n" +
          $"2. Ajustar a CERO el stock de cada lote\n" +
          $"3. Luego podr√° desactivar el control de lotes\n\n" +
          $"üí° Los lotes hist√≥ricos (con stock 0) permanecer√°n como registro.";
        
        await JS.InvokeVoidAsync("alert", mensaje);
        
        // Reactivar ControlaLote - NO se permite desactivar
        editando.ControlaLote = true;
        StateHasChanged();
        return;
      }
      
      // Si no hay lotes con stock, preguntar confirmaci√≥n
      var lotesHistoricos = await db.ProductosLotes
        .Where(l => l.IdProducto == editando.IdProducto && l.Stock == 0)
        .CountAsync();
      
      if (lotesHistoricos > 0)
      {
        var confirmar = await JS.InvokeAsync<bool>("confirm", 
          $"Este producto tiene {lotesHistoricos} lote(s) hist√≥rico(s) (sin stock).\n\n" +
          $"Al desactivar el control de lotes:\n" +
          $"‚Ä¢ Los lotes hist√≥ricos permanecer√°n como registro\n" +
          $"‚Ä¢ Se ocultar√°n de las pantallas de operaci√≥n\n" +
          $"‚Ä¢ El sistema dejar√° de controlar vencimientos\n\n" +
          $"¬øDesea continuar?");
        
        if (!confirmar)
        {
          editando.ControlaLote = true;
          StateHasChanged();
          return;
        }
      }
      
      // Si desactiva lotes, tambi√©n desactivar vencimiento
      editando.ControlaVencimiento = false;
    }
    
    // Si se ACTIVA el control de lotes y el producto ya existe
    if (editando.ControlaLote && editando.IdProducto > 0)
    {
      await using var db = await DbFactory.CreateDbContextAsync();
      
      // Verificar si ya tiene lotes creados
      var lotesExistentes = await db.ProductosLotes
        .Where(l => l.IdProducto == editando.IdProducto)
        .CountAsync();
      
      if (lotesExistentes > 0)
      {
        // Ya tiene lotes, simplemente cargarlos
        await CargarLotesProducto();
        // Marcar como creado para evitar duplicados al guardar
        editando.LoteInicialCreado = true;
      }
      else
      {
        // No tiene lotes - Verificar si tiene stock en dep√≥sitos
        var stocksDepositos = await db.ProductosDepositos
          .Include(pd => pd.Deposito)
          .Where(pd => pd.IdProducto == editando.IdProducto && pd.Stock > 0)
          .Select(pd => new { pd.IdDeposito, pd.Deposito.Nombre, pd.Stock })
          .ToListAsync();
        
        if (stocksDepositos.Any())
        {
          // Tiene stock - preguntar si quiere crear lotes
          var totalStock = stocksDepositos.Sum(s => s.Stock);
          var detalleDepositos = string.Join("\n", stocksDepositos.Select(s => $"  ‚Ä¢ {s.Nombre}: {s.Stock:N2}"));
          
          var mensaje = $"Este producto tiene stock existente en los dep√≥sitos:\n\n{detalleDepositos}\n\nTotal: {totalStock:N2} unidades\n\n¬øDesea crear lotes iniciales con este stock?\n\nSi acepta, se crear√° un lote 'STOCK-INICIAL' por cada dep√≥sito con su stock actual.";
          
          var aceptar = await JS.InvokeAsync<bool>("confirm", mensaje);
          
          if (aceptar)
          {
            // Crear lotes iniciales
            var usuario = await ObtenerUsuarioActualAsync();
            var fechaHoy = DateTime.Now;
            
            foreach (var stockDep in stocksDepositos)
            {
              var loteInicial = new Models.ProductoLote
              {
                IdProducto = editando.IdProducto,
                IdDeposito = stockDep.IdDeposito,
                NumeroLote = "STOCK-INICIAL",
                Stock = stockDep.Stock,
                StockInicial = stockDep.Stock,
                FechaIngreso = fechaHoy,
                Estado = "Activo",
                EsLoteInicial = true,
                Observacion = $"Lote inicial creado autom√°ticamente al activar control de lotes. Stock existente: {stockDep.Stock:N2}",
                FechaCreacion = fechaHoy,
                UsuarioCreacion = usuario,
                // FechaVencimiento = null - El usuario deber√° completarla despu√©s
              };
              
              db.ProductosLotes.Add(loteInicial);
            }
            
            await db.SaveChangesAsync();
            
            // IMPORTANTE: Marcar LoteInicialCreado en la BD para evitar duplicados al guardar
            var productoDb = await db.Productos.FindAsync(editando.IdProducto);
            if (productoDb != null)
            {
              productoDb.LoteInicialCreado = true;
              await db.SaveChangesAsync();
            }
            editando.LoteInicialCreado = true;
            
            await CargarLotesProducto();
            
            await JS.InvokeVoidAsync("alert", $"‚úÖ Se crearon {stocksDepositos.Count} lote(s) inicial(es).\n\n‚ö†Ô∏è IMPORTANTE: Debe editar cada lote para agregar la fecha de vencimiento.");
          }
          else
          {
            // No acept√≥ - desmarcar ControlaLote
            editando.ControlaLote = false;
            editando.ControlaVencimiento = false;
            StateHasChanged();
            return;
          }
        }
      }
    }
    
    // Si se activa control de lote, tambi√©n activar control de vencimiento por defecto
    if (editando.ControlaLote && !editando.ControlaVencimiento)
    {
      editando.ControlaVencimiento = true;
    }
  }
  
  private async Task<string?> ObtenerUsuarioActualAsync()
  {
    try
    {
      var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
      return authState?.User?.Identity?.Name;
    }
    catch
    {
      return "Sistema";
    }
  }

  private async Task CargarLotesProducto()
  {
    if (editando.IdProducto <= 0) return;
    
    await using var db = await DbFactory.CreateDbContextAsync();
    lotesProducto = await db.ProductosLotes
      .Include(l => l.Deposito)
      .Where(l => l.IdProducto == editando.IdProducto)
      .OrderBy(l => l.FechaVencimiento)
      .ThenBy(l => l.NumeroLote)
      .ToListAsync();
  }

  private async Task AbrirModalLotes()
  {
    await CargarLotesProducto();
    InicializarNuevoLote();
    editandoLote = false;
    mensajeErrorLote = null;
    mensajeExitoLote = null;
    mostrarModalLotes = true;
  }
  
  /// <summary>
  /// Abre el modal de lotes directamente desde el explorador de productos
  /// </summary>
  private async Task AbrirLotesDesdeExplorador(Models.Producto producto)
  {
    // Abrir modal de visualizaci√≥n (solo lectura)
    productoVisualizandoLotes = producto;
    
    // Cargar los lotes del producto
    using var context = await DbFactory.CreateDbContextAsync();
    lotesVisualizacion = await context.ProductosLotes
      .Where(l => l.IdProducto == producto.IdProducto)
      .Include(l => l.Deposito)
      .OrderBy(l => l.FechaVencimiento)
      .ThenBy(l => l.NumeroLote)
      .ToListAsync();
    
    mostrarModalLotesVisualizacion = true;
  }

  private void CerrarModalLotesVisualizacion()
  {
    mostrarModalLotesVisualizacion = false;
    productoVisualizandoLotes = null;
    lotesVisualizacion.Clear();
  }

  private async Task EditarProductoDesdeVisualizacion()
  {
    if (productoVisualizandoLotes == null) return;
    
    // Cerrar modal de visualizaci√≥n
    mostrarModalLotesVisualizacion = false;
    
    // Abrir el producto en modo edici√≥n con el modal de lotes
    editando = productoVisualizandoLotes;
    productoVisualizandoLotes = null;
    lotesVisualizacion.Clear();
    
    // Abrir modal de lotes editable
    await AbrirModalLotes();
  }

  private void CerrarModalLotes()
  {
    mostrarModalLotes = false;
    editandoLote = false;
    mensajeErrorLote = null;
    mensajeExitoLote = null;
  }

  private void InicializarNuevoLote()
  {
    nuevoLote = new Models.ProductoLote
    {
      IdProducto = editando.IdProducto,
      IdDeposito = editando.IdDepositoPredeterminado ?? depositos.FirstOrDefault()?.IdDeposito ?? 0,
      NumeroLote = string.Empty,
      FechaVencimiento = DateTime.Today.AddYears(1),
      Stock = 0,
      Estado = "Activo"
    };
    editandoLote = false;
  }

  private void EditarLote(Models.ProductoLote lote)
  {
    nuevoLote = new Models.ProductoLote
    {
      IdProductoLote = lote.IdProductoLote,
      IdProducto = lote.IdProducto,
      IdDeposito = lote.IdDeposito,
      NumeroLote = lote.NumeroLote,
      FechaVencimiento = lote.FechaVencimiento,
      FechaFabricacion = lote.FechaFabricacion,
      Stock = lote.Stock,
      StockInicial = lote.StockInicial,
      CostoUnitario = lote.CostoUnitario,
      Estado = lote.Estado,
      Observacion = lote.Observacion,
      EsLoteInicial = lote.EsLoteInicial
    };
    editandoLote = true;
    mensajeErrorLote = null;
    mensajeExitoLote = null;
  }

  private void CancelarEdicionLote()
  {
    InicializarNuevoLote();
    mensajeErrorLote = null;
    mensajeExitoLote = null;
  }

  private async Task GuardarLote()
  {
    mensajeErrorLote = null;
    mensajeExitoLote = null;

    // Validaciones
    if (string.IsNullOrWhiteSpace(nuevoLote.NumeroLote))
    {
      mensajeErrorLote = "El n√∫mero de lote es obligatorio.";
      return;
    }
    if (nuevoLote.IdDeposito <= 0)
    {
      mensajeErrorLote = "Debe seleccionar un dep√≥sito.";
      return;
    }
    
    // Validaci√≥n de fecha de vencimiento OBLIGATORIA
    if (!nuevoLote.FechaVencimiento.HasValue)
    {
      await JS.InvokeVoidAsync("alert", "‚ö†Ô∏è FECHA DE VENCIMIENTO OBLIGATORIA\n\nDebe ingresar la fecha de vencimiento del lote para evitar inconvenientes en el control de stock y despacho de productos.");
      mensajeErrorLote = "La fecha de vencimiento es obligatoria.";
      return;
    }

    await using var db = await DbFactory.CreateDbContextAsync();

    // Verificar duplicado (mismo lote/producto/dep√≥sito)
    var duplicado = await db.ProductosLotes
      .AnyAsync(l => l.IdProducto == nuevoLote.IdProducto 
                  && l.IdDeposito == nuevoLote.IdDeposito 
                  && l.NumeroLote == nuevoLote.NumeroLote
                  && l.IdProductoLote != nuevoLote.IdProductoLote);
    
    if (duplicado)
    {
      mensajeErrorLote = $"Ya existe un lote '{nuevoLote.NumeroLote}' para este producto en ese dep√≥sito.";
      return;
    }

    try
    {
      if (nuevoLote.IdProductoLote == 0)
      {
        // Crear nuevo lote
        nuevoLote.IdProducto = editando.IdProducto;
        nuevoLote.StockInicial = nuevoLote.Stock;
        nuevoLote.FechaCreacion = DateTime.Now;
        nuevoLote.UsuarioCreacion = "Sistema"; // TODO: obtener usuario actual
        
        db.ProductosLotes.Add(nuevoLote);
        await db.SaveChangesAsync();

        // Registrar movimiento inicial
        var movimiento = new Models.MovimientoLote
        {
          IdProductoLote = nuevoLote.IdProductoLote,
          TipoMovimiento = TipoMovimientoLote.Inicial,
          Cantidad = nuevoLote.Stock,
          StockAnterior = 0,
          StockPosterior = nuevoLote.Stock,
          Motivo = "Creaci√≥n manual de lote",
          FechaMovimiento = DateTime.Now,
          Usuario = "Sistema"
        };
        db.MovimientosLotes.Add(movimiento);
        await db.SaveChangesAsync();

        mensajeExitoLote = $"Lote '{nuevoLote.NumeroLote}' creado correctamente.";
      }
      else
      {
        // Actualizar lote existente
        var loteDb = await db.ProductosLotes.FindAsync(nuevoLote.IdProductoLote);
        if (loteDb != null)
        {
          loteDb.NumeroLote = nuevoLote.NumeroLote;
          loteDb.FechaVencimiento = nuevoLote.FechaVencimiento;
          loteDb.FechaFabricacion = nuevoLote.FechaFabricacion;
          loteDb.CostoUnitario = nuevoLote.CostoUnitario;
          loteDb.Estado = nuevoLote.Estado;
          loteDb.Observacion = nuevoLote.Observacion;
          loteDb.FechaModificacion = DateTime.Now;
          loteDb.UsuarioModificacion = "Sistema";

          // NOTA: El stock ya NO se modifica desde este modal.
          // Los cambios de stock deben hacerse exclusivamente mediante:
          // - Compras (incrementa stock)
          // - Ventas (decrementa stock)
          // - Ajustes de Stock (m√≥dulo dedicado)
          // - Transferencias entre dep√≥sitos

          await db.SaveChangesAsync();
          mensajeExitoLote = $"Lote '{nuevoLote.NumeroLote}' actualizado correctamente.";
        }
      }

      await CargarLotesProducto();
      InicializarNuevoLote();
    }
    catch (Exception ex)
    {
      mensajeErrorLote = $"Error al guardar: {ex.Message}";
    }
  }

  private async Task EliminarLote(Models.ProductoLote lote)
  {
    // Verificar permiso DELETE
    if (!_puedeEliminarLote)
    {
      mensajeErrorLote = "No tiene permiso para eliminar lotes. Contacte al administrador.";
      return;
    }
    
    // Si tiene stock, indicar que debe hacer ajuste primero
    if (lote.Stock > 0)
    {
      mensajeErrorLote = $"No se puede eliminar el lote '{lote.NumeroLote}' porque tiene stock ({lote.Stock:N2}).\n" +
                         $"Primero debe realizar un Ajuste de Stock en el men√∫ Inventario ‚Üí Ajustes de Stock para dejar el stock en 0.";
      return;
    }

    // Confirmar eliminaci√≥n
    var confirmar = await JS.InvokeAsync<bool>("confirm", $"¬øEst√° seguro de eliminar el lote '{lote.NumeroLote}'?");
    if (!confirmar) return;

    await using var db = await DbFactory.CreateDbContextAsync();
    
    var loteDb = await db.ProductosLotes.FindAsync(lote.IdProductoLote);
    if (loteDb != null)
    {
      db.ProductosLotes.Remove(loteDb);
      await db.SaveChangesAsync();
      mensajeExitoLote = $"Lote '{lote.NumeroLote}' eliminado exitosamente.";
      await CargarLotesProducto();
    }
  }

  private async Task CrearLoteInicial()
  {
    // Crear lote STOCK-INICIAL con el stock actual del producto
    await using var db = await DbFactory.CreateDbContextAsync();
    
    // Obtener stock actual por dep√≥sito
    var stocksPorDeposito = await db.ProductosDepositos
      .Where(pd => pd.IdProducto == editando.IdProducto && pd.Stock > 0)
      .ToListAsync();

    if (!stocksPorDeposito.Any())
    {
      mensajeExitoLote = "No hay stock actual para migrar a lotes.";
      return;
    }

    foreach (var pd in stocksPorDeposito)
    {
      var loteInicial = new Models.ProductoLote
      {
        IdProducto = editando.IdProducto,
        IdDeposito = pd.IdDeposito,
        NumeroLote = "STOCK-INICIAL",
        FechaVencimiento = null, // Sin vencimiento definido
        Stock = pd.Stock,
        StockInicial = pd.Stock,
        Estado = "Activo",
        EsLoteInicial = true,
        FechaCreacion = DateTime.Now,
        UsuarioCreacion = "Sistema",
        Observacion = "Lote creado autom√°ticamente por migraci√≥n de stock existente"
      };

      db.ProductosLotes.Add(loteInicial);
      await db.SaveChangesAsync();

      // Registrar movimiento
      var movimiento = new Models.MovimientoLote
      {
        IdProductoLote = loteInicial.IdProductoLote,
        TipoMovimiento = TipoMovimientoLote.Inicial,
        Cantidad = pd.Stock,
        StockAnterior = 0,
        StockPosterior = pd.Stock,
        Motivo = "Migraci√≥n de stock existente al activar control de lotes",
        FechaMovimiento = DateTime.Now,
        Usuario = "Sistema"
      };
      db.MovimientosLotes.Add(movimiento);
    }

    // Marcar que ya se cre√≥ el lote inicial
    var producto = await db.Productos.FindAsync(editando.IdProducto);
    if (producto != null)
    {
      producto.LoteInicialCreado = true;
      await db.SaveChangesAsync();
      editando.LoteInicialCreado = true;
    }

    await CargarLotesProducto();
    mensajeExitoLote = $"Se crearon {stocksPorDeposito.Count} lote(s) STOCK-INICIAL con el stock existente.";
  }

  private string GetEstadoLoteBadge(Models.ProductoLote lote)
  {
    if (lote.EstaVencido) return "badge bg-danger";
    if (lote.EstaProximoAVencer) return "badge bg-warning text-dark";
    if (lote.Stock <= 0) return "badge bg-secondary";
    return "badge bg-success";
  }

  private string GetEstadoLoteTexto(Models.ProductoLote lote)
  {
    if (lote.EstaVencido) return "Vencido";
    if (lote.EstaProximoAVencer) return $"Vence en {lote.DiasParaVencimiento} d√≠as";
    if (lote.Stock <= 0) return "Agotado";
    return "Activo";
  }
}

</PageProtection>
