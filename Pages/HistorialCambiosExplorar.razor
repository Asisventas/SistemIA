@page "/sistema/historial-cambios"
@using Microsoft.EntityFrameworkCore
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize]
@inject IDbContextFactory<SistemIA.Models.AppDbContext> DbFactory
@inject Microsoft.JSInterop.IJSRuntime JS
@using ClosedXML.Excel

<PageTitle>Historial de Cambios - SistemIA</PageTitle>

<SaProtection TituloPagina="Historial de Cambios del Sistema" UrlRetorno="/">

<h3 class="mb-3"><i class="bi bi-clock-history text-primary me-2"></i>Historial de Cambios del Sistema</h3>

<div class="card mb-3">
  <div class="card-body">
    <div class="row g-3 align-items-end">
      <div class="col-md-2">
        <label class="form-label">Desde</label>
        <input type="date" class="form-control" @bind="fDesde" />
      </div>
      <div class="col-md-2">
        <label class="form-label">Hasta</label>
        <input type="date" class="form-control" @bind="fHasta" />
      </div>
      <div class="col-md-2">
        <label class="form-label">Tema</label>
        <select class="form-select" @bind="fTema">
          <option value="">Todos</option>
          @foreach (var tema in temasDisponibles)
          {
            <option value="@tema">@tema</option>
          }
        </select>
      </div>
      <div class="col-md-2">
        <label class="form-label">Tipo Cambio</label>
        <select class="form-select" @bind="fTipoCambio">
          <option value="">Todos</option>
          <option value="Nueva Funcionalidad">Nueva Funcionalidad</option>
          <option value="Mejora">Mejora</option>
          <option value="Correccion">Corrección</option>
          <option value="Refactorizacion">Refactorización</option>
          <option value="Seguridad">Seguridad</option>
        </select>
      </div>
      <div class="col-md-2">
        <label class="form-label">Tags/Palabras</label>
        <input class="form-control" placeholder="Buscar..." @bind="fTexto" />
      </div>
      <div class="col-md-2 d-flex gap-2 justify-content-end">
        <button class="btn btn-primary" @onclick="Buscar"><i class="bi bi-search"></i> Buscar</button>
        <button class="btn btn-success" title="Exportar Excel" @onclick="ExportarXlsx"><i class="bi bi-file-earmark-excel"></i></button>
        <button class="btn btn-outline-secondary" title="Imprimir" @onclick="Imprimir"><i class="bi bi-printer"></i></button>
      </div>
    </div>
  </div>
</div>

<div class="card">
  <div class="card-header bg-light">
    <span class="fw-bold">Total: @lista.Count registro(s)</span>
  </div>
  <div class="card-body p-0">
    <div class="table-responsive">
      <table class="table table-sm table-hover align-middle mb-0">
        <thead class="table-light">
          <tr>
            <th style="width:50px;">ID</th>
            <th>Fecha</th>
            <th>Tema</th>
            <th>TÃ­tulo</th>
            <th>Tipo</th>
            <th>MÃ³dulo</th>
            <th>Implementado Por</th>
            <th>Tags</th>
            <th style="width:80px;">Acciones</th>
          </tr>
        </thead>
        <tbody>
          @foreach (var item in lista)
          {
            <tr>
              <td>@item.IdHistorialCambio</td>
              <td>@item.FechaCambio.ToString("dd/MM/yyyy")</td>
              <td><span class="badge bg-info">@item.Tema</span></td>
              <td>@item.TituloCambio</td>
              <td>
                @if (item.TipoCambio == "Nueva Funcionalidad") {<span class="badge bg-success">@item.TipoCambio</span>}
                else if (item.TipoCambio == "CorrecciÃ³n") {<span class="badge bg-danger">@item.TipoCambio</span>}
                else if (item.TipoCambio == "Mejora") {<span class="badge bg-primary">@item.TipoCambio</span>}
                else {<span class="badge bg-secondary">@item.TipoCambio</span>}
              </td>
              <td>@item.ModuloAfectado</td>
              <td>@item.ImplementadoPor</td>
              <td><small class="text-muted">@item.Tags</small></td>
              <td>
                <button class="btn btn-sm btn-outline-primary" @onclick="() => VerDetalle(item)"><i class="bi bi-eye"></i></button>
              </td>
            </tr>
          }
        </tbody>
      </table>
    </div>
  </div>
</div>

@if (itemSeleccionado != null)
{
  <div class="modal fade show d-block" tabindex="-1" style="background:rgba(0,0,0,0.5);">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title"><i class="bi bi-info-circle me-2"></i>Detalle del Cambio #@itemSeleccionado.IdHistorialCambio</h5>
          <button type="button" class="btn-close" @onclick="CerrarDetalle"></button>
        </div>
        <div class="modal-body">
          <div class="row g-3">
            <div class="col-md-6"><strong>Fecha:</strong> @itemSeleccionado.FechaCambio.ToString("dd/MM/yyyy HH:mm")</div>
            <div class="col-md-6"><strong>VersiÃ³n:</strong> @itemSeleccionado.Version</div>
            <div class="col-md-6"><strong>Tema:</strong> @itemSeleccionado.Tema</div>
            <div class="col-md-6"><strong>Tipo:</strong> @itemSeleccionado.TipoCambio</div>
            <div class="col-md-6"><strong>MÃ³dulo:</strong> @itemSeleccionado.ModuloAfectado</div>
            <div class="col-md-6"><strong>Prioridad:</strong> @itemSeleccionado.Prioridad</div>
            <div class="col-12"><strong>TÃ­tulo:</strong> @itemSeleccionado.TituloCambio</div>
            <div class="col-12"><strong>DescripciÃ³n:</strong><br/>@itemSeleccionado.DescripcionBreve</div>
            @if (!string.IsNullOrEmpty(itemSeleccionado.DescripcionTecnica))
            {
              <div class="col-12"><strong>DescripciÃ³n TÃ©cnica:</strong><pre class="bg-light p-2" style="max-height:200px;overflow:auto;">@itemSeleccionado.DescripcionTecnica</pre></div>
            }
            @if (!string.IsNullOrEmpty(itemSeleccionado.ArchivosModificados))
            {
              <div class="col-12"><strong>Archivos Modificados:</strong><pre class="bg-light p-2" style="max-height:150px;overflow:auto;">@itemSeleccionado.ArchivosModificados</pre></div>
            }
            <div class="col-md-6"><strong>Tags:</strong> @itemSeleccionado.Tags</div>
            <div class="col-md-6"><strong>Referencias:</strong> @itemSeleccionado.Referencias</div>
            <div class="col-12"><strong>Implementado Por:</strong> @itemSeleccionado.ImplementadoPor</div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" @onclick="CerrarDetalle">Cerrar</button>
        </div>
      </div>
    </div>
  </div>
}

</SaProtection>

@code {
    List<SistemIA.Models.HistorialCambioSistema> lista = new();
    List<string> temasDisponibles = new() { "Ventas", "Compras", "Inventario", "Clientes", "SIFEN", "Reportes", "Caja", "Usuarios", "ConfiguraciÃ³n", "UI/UX", "Base de Datos", "Correo", "Asistente IA", "Actualizador", "Infraestructura" };
    DateTime? fDesde = DateTime.Today.AddMonths(-3);
    DateTime? fHasta = DateTime.Today;
    string fTema = "";
    string fTipoCambio = "";
    string fTexto = "";
    SistemIA.Models.HistorialCambioSistema? itemSeleccionado;

    protected override async Task OnInitializedAsync() => await Buscar();

    async Task Buscar()
    {
        await using var ctx = await DbFactory.CreateDbContextAsync();
        var q = ctx.HistorialCambiosSistema.AsQueryable();
        if (fDesde.HasValue) q = q.Where(x => x.FechaCambio >= fDesde.Value);
        if (fHasta.HasValue) q = q.Where(x => x.FechaCambio <= fHasta.Value.AddDays(1));
        if (!string.IsNullOrEmpty(fTema)) q = q.Where(x => x.Tema == fTema);
        if (!string.IsNullOrEmpty(fTipoCambio)) q = q.Where(x => x.TipoCambio == fTipoCambio);
        if (!string.IsNullOrEmpty(fTexto))
        {
            var t = fTexto.ToLower();
            q = q.Where(x => (x.TituloCambio != null && x.TituloCambio.ToLower().Contains(t)) ||
                           (x.Tags != null && x.Tags.ToLower().Contains(t)) ||
                           (x.Referencias != null && x.Referencias.ToLower().Contains(t)) ||
                           (x.DescripcionBreve != null && x.DescripcionBreve.ToLower().Contains(t)));
        }
        lista = await q.OrderByDescending(x => x.FechaCambio).Take(500).ToListAsync();
    }

    void VerDetalle(SistemIA.Models.HistorialCambioSistema item) => itemSeleccionado = item;
    void CerrarDetalle() => itemSeleccionado = null;

    async Task ExportarXlsx()
    {
        using var wb = new XLWorkbook();
        var ws = wb.Worksheets.Add("Historial");
        ws.Cell(1, 1).Value = "ID"; ws.Cell(1, 2).Value = "Fecha"; ws.Cell(1, 3).Value = "Tema";
        ws.Cell(1, 4).Value = "TÃ­tulo"; ws.Cell(1, 5).Value = "Tipo"; ws.Cell(1, 6).Value = "MÃ³dulo";
        ws.Cell(1, 7).Value = "DescripciÃ³n"; ws.Cell(1, 8).Value = "Tags"; ws.Cell(1, 9).Value = "Implementado Por";
        var row = 2;
        foreach (var item in lista)
        {
            ws.Cell(row, 1).Value = item.IdHistorialCambio;
            ws.Cell(row, 2).Value = item.FechaCambio.ToString("dd/MM/yyyy");
            ws.Cell(row, 3).Value = item.Tema;
            ws.Cell(row, 4).Value = item.TituloCambio;
            ws.Cell(row, 5).Value = item.TipoCambio;
            ws.Cell(row, 6).Value = item.ModuloAfectado;
            ws.Cell(row, 7).Value = item.DescripcionBreve;
            ws.Cell(row, 8).Value = item.Tags;
            ws.Cell(row, 9).Value = item.ImplementadoPor;
            row++;
        }
        ws.Columns().AdjustToContents();
        using var ms = new System.IO.MemoryStream();
        wb.SaveAs(ms);
        var bytes = ms.ToArray();
        var base64 = Convert.ToBase64String(bytes);
        await JS.InvokeVoidAsync("eval", $"(function(){{var a=document.createElement('a');a.href='data:application/vnd.openxmlformats-officedocument.spreadsheetml.sheet;base64,{base64}';a.download='HistorialCambios.xlsx';a.click();}})()");
    }

    async Task Imprimir()
    {
        var html = GenerarTablaHtml();
        await JS.InvokeVoidAsync("eval", $"(function(){{var w=window.open('','','width=900,height=700');w.document.write('<html><head><title>Historial de Cambios</title><style>table{{border-collapse:collapse;width:100%;}}th,td{{border:1px solid #ccc;padding:6px;text-align:left;font-size:11px;}}th{{background:#f5f5f5;}}</style></head><body>'+{System.Text.Json.JsonSerializer.Serialize(html)}+'</body></html>');w.document.close();w.print();}})()");
    }

    string GenerarTablaHtml()
    {
        var sb = new System.Text.StringBuilder();
        sb.Append("<h3>Historial de Cambios del Sistema</h3>");
        sb.Append("<table><thead><tr><th>ID</th><th>Fecha</th><th>Tema</th><th>TÃ­tulo</th><th>Tipo</th><th>MÃ³dulo</th><th>DescripciÃ³n</th></tr></thead><tbody>");
        foreach (var item in lista)
        {
            sb.Append($"<tr><td>{item.IdHistorialCambio}</td><td>{item.FechaCambio:dd/MM/yyyy}</td><td>{item.Tema}</td><td>{item.TituloCambio}</td><td>{item.TipoCambio}</td><td>{item.ModuloAfectado}</td><td>{item.DescripcionBreve}</td></tr>");
        }
        sb.Append("</tbody></table>");
        return sb.ToString();
    }
}