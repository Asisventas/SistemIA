@page "/notas-credito"
@page "/notas-credito/{Id:int}"
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Authorization
@attribute [Authorize]
@using SistemIA.Models
@using SistemIA.Data
@using SistemIA.Services
@using Microsoft.EntityFrameworkCore
@inject IDbContextFactory<AppDbContext> DbFactory
@inject NavigationManager Nav
@inject ISucursalProvider SucursalProvider
@inject ICajaProvider CajaProvider
@inject ICajaService CajaService
@inject IInventarioService Inventario
@inject IJSRuntime JS
@inject PermisosService PermisosService
@inject AuthenticationStateProvider AuthStateProvider
@inject ITrackingService TrackingService
@using static SistemIA.Models.AsistenteIA.TipoAccionTracking
@using static SistemIA.Models.AsistenteIA.CategoriaAccion

<PageProtection Modulo="/notas-credito" Permiso="CREATE">
<PageTitle>@(_esEdicion ? "Editar" : "Nueva") Nota de Cr√©dito</PageTitle>

<div class="container-fluid">
    <div class="card shadow-sm">
        <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
            <h5 class="mb-0">
                <i class="bi bi-file-earmark-minus me-2"></i>
                @(_esEdicion ? "Editar" : "Nueva") Nota de Cr√©dito
            </h5>
            <button class="btn btn-light btn-sm" @onclick="Volver">
                <i class="bi bi-arrow-left"></i> Volver
            </button>
        </div>
        
        <div class="card-body">
            @if (_loading)
            {
                <div class="text-center p-4">
                    <div class="spinner-border text-primary" role="status"></div>
                </div>
            }
            else
            {
                @* Encabezado - Informaci√≥n principal *@
                <div class="row g-3 mb-4">
                    <div class="col-md-2">
                        <label class="form-label">Caja</label>
                        @if (_puedeCambiarCaja && _cajas.Any())
                        {
                            <select class="form-select form-select-sm" @bind="_nc.IdCaja" @bind:after="OnCajaChanged">
                                @foreach (var caja in _cajas)
                                {
                                    <option value="@caja.IdCaja">@(string.IsNullOrWhiteSpace(caja.Nombre) ? $"Caja #{caja.IdCaja}" : caja.Nombre)</option>
                                }
                            </select>
                        }
                        else
                        {
                            <span class="form-control form-control-sm bg-light">@(_cajaSeleccionada != null ? (string.IsNullOrWhiteSpace(_cajaSeleccionada.Nombre) ? $"Caja #{_cajaSeleccionada.IdCaja}" : _cajaSeleccionada.Nombre) : "Sin caja")</span>
                        }
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Turno</label>
                        <select class="form-select form-select-sm" @bind="_nc.Turno">
                            <option value="1">Turno 1</option>
                            <option value="2">Turno 2</option>
                            <option value="3">Turno 3</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Fecha</label>
                        <input type="date" class="form-control form-control-sm" @bind="_nc.Fecha" />
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">N√∫mero NC</label>
                        <input type="text" class="form-control form-control-sm" readonly 
                               value="@(_cajaSeleccionada?.Nivel1NC ?? "001")-@(_cajaSeleccionada?.Nivel2NC ?? "001")-@(_nc.NumeroNota.ToString("D7"))" />
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Timbrado</label>
                        <input type="text" class="form-control form-control-sm" readonly value="@(_cajaSeleccionada?.TimbradoNC)" />
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Estado</label>
                        <span class="badge @GetBadgeClass(_nc.Estado) d-block py-2">@_nc.Estado</span>
                    </div>
                </div>
                
                @* Motivo y Documento Asociado *@
                <div class="row g-3 mb-4">
                    <div class="col-md-2">
                        <label class="form-label fw-bold">Motivo <span class="text-danger">*</span></label>
                        <select class="form-select form-select-sm" @bind="_nc.Motivo" @bind:after="OnMotivoChanged">
                            @foreach (var motivo in MotivosNotaCredito.Todos)
                            {
                                <option value="@motivo">@motivo</option>
                            }
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label fw-bold">Afecta Stock</label>
                        <select class="form-select form-select-sm @GetAfectaStockClass()" @bind="_afectaStock">
                            <option value="1">‚ûï Suma Stock</option>
                            <option value="0">üö´ No afecta</option>
                            <option value="-1">‚ûñ Resta Stock</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Tipo Doc. Asociado</label>
                        <select class="form-select form-select-sm" @bind="_nc.TipoDocumentoAsociado">
                            <option value="Electr√≥nico">Electr√≥nico</option>
                            <option value="Impreso">Impreso</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label fw-bold">Factura Asociada</label>
                        <div class="input-group input-group-sm">
                            <input type="text" class="form-control" readonly 
                                   value="@(_ventaSeleccionada != null ? $"{_ventaSeleccionada.Establecimiento}-{_ventaSeleccionada.PuntoExpedicion}-{_ventaSeleccionada.NumeroFactura}" : "(Ninguna)")" />
                            <button class="btn btn-outline-primary" type="button" @onclick="AbrirBuscarFactura">
                                <i class="bi bi-search"></i>
                            </button>
                            @if (_ventaSeleccionada != null)
                            {
                                <button class="btn btn-outline-danger" type="button" @onclick="QuitarFactura">
                                    <i class="bi bi-x"></i>
                                </button>
                            }
                        </div>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Saldo Disponible</label>
                        <input type="text" class="form-control form-control-sm @(_ventaSeleccionada != null && _saldoDisponibleFactura <= 0 ? "bg-danger text-white" : "")" readonly 
                               value="@(_ventaSeleccionada != null ? _saldoDisponibleFactura.ToString("N0") + " Gs." : "N/A")" />
                        @if (_ventaSeleccionada != null && _saldoDisponibleFactura <= 0)
                        {
                            <small class="text-danger">Esta factura ya tiene NC por el total</small>
                        }
                    </div>
                </div>
                
                @* Cliente *@
                <div class="row g-3 mb-4 p-3 bg-light rounded">
                    <div class="col-md-5">
                        <label class="form-label fw-bold">Cliente</label>
                        <div class="input-group input-group-sm">
                            <input type="text" class="form-control" readonly 
                                   value="@(_clienteSeleccionado?.RazonSocial ?? _nc.NombreCliente ?? "CONSUMIDOR FINAL")" />
                            <button class="btn btn-outline-primary" type="button" @onclick="AbrirBuscarCliente">
                                <i class="bi bi-search"></i>
                            </button>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">RUC/CI</label>
                        <input type="text" class="form-control form-control-sm" readonly 
                               value="@(_clienteSeleccionado?.RUC ?? "")" />
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Direcci√≥n</label>
                        <input type="text" class="form-control form-control-sm" readonly 
                               value="@(_clienteSeleccionado?.Direccion ?? "")" />
                    </div>
                </div>
                
                @* Moneda *@
                <div class="row g-3 mb-4">
                    <div class="col-md-2">
                        <label class="form-label">Moneda</label>
                        <select class="form-select form-select-sm" @bind="_nc.IdMoneda" @bind:after="OnMonedaChanged">
                            @foreach (var mon in _monedas)
                            {
                                <option value="@mon.IdMoneda">@mon.Nombre (@mon.Simbolo)</option>
                            }
                        </select>
                    </div>
                    @if (_nc.EsMonedaExtranjera)
                    {
                        <div class="col-md-2">
                            <label class="form-label">Cambio del d√≠a</label>
                            <input type="number" class="form-control form-control-sm" step="0.01" @bind="_nc.CambioDelDia" />
                        </div>
                    }
                </div>
                
                @* Detalles de productos *@
                <div class="card mb-4">
                    <div class="card-header bg-secondary text-white py-2">
                        <div class="d-flex justify-content-between align-items-center">
                            <span><i class="bi bi-list-ul me-2"></i>Detalle de Productos</span>
                            <button class="btn btn-light btn-sm" @onclick="AbrirBuscarProducto">
                                <i class="bi bi-plus-lg"></i> Agregar
                            </button>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover table-sm mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th style="width:80px;">C√≥digo</th>
                                        <th>Descripci√≥n</th>
                                        <th style="width:90px;" class="text-end">Cantidad</th>
                                        <th style="width:110px;" class="text-end">P. Unitario</th>
                                        <th style="width:80px;" class="text-end">% Desc.</th>
                                        <th style="width:70px;" class="text-center">IVA</th>
                                        <th style="width:110px;" class="text-end">Subtotal</th>
                                        <th style="width:50px;"></th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var det in _detalles)
                                    {
                                        <tr>
                                            <td>@det.CodigoProducto</td>
                                            <td>@det.NombreProducto</td>
                                            <td>
                                                <input type="number" class="form-control form-control-sm text-end" 
                                                       step="@(det.PermiteDecimal ? "0.01" : "1")" 
                                                       min="@(det.PermiteDecimal ? "0.01" : "1")" 
                                                       @bind="det.Cantidad" @bind:after="() => ValidarYRecalcularLinea(det)" />
                                            </td>
                                            <td>
                                                <input type="number" class="form-control form-control-sm text-end" 
                                                       step="1" min="0" @bind="det.PrecioUnitario" @bind:after="RecalcularLinea" />
                                            </td>
                                            <td>
                                                <input type="number" class="form-control form-control-sm text-end" 
                                                       step="0.5" min="0" max="100" @bind="det.PorcentajeDescuento" @bind:after="RecalcularLinea" />
                                            </td>
                                            <td class="text-center">@det.TasaIVA%</td>
                                            <td class="text-end">@det.Importe.ToString("N0")</td>
                                            <td>
                                                <button class="btn btn-outline-danger btn-sm" @onclick="() => QuitarDetalle(det)">
                                                    <i class="bi bi-trash"></i>
                                                </button>
                                            </td>
                                        </tr>
                                    }
                                    @if (!_detalles.Any())
                                    {
                                        <tr>
                                            <td colspan="8" class="text-center text-muted py-3">
                                                No hay productos. Haga clic en "Agregar" para comenzar.
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                @* Totales *@
                <div class="row">
                    <div class="col-md-5">
                        <label class="form-label">Observaciones</label>
                        <textarea class="form-control" rows="3" @bind="_nc.Observaciones"></textarea>
                    </div>
                    <div class="col-md-4 offset-md-3">
                        <table class="table table-sm">
                            <tr>
                                <td>Subtotal:</td>
                                <td class="text-end">@_nc.Subtotal.ToString("N0")</td>
                            </tr>
                            <tr>
                                <td>Descuento:</td>
                                <td class="text-end">@_nc.TotalDescuento.ToString("N0")</td>
                            </tr>
                            <tr class="table-primary">
                                <td><strong>TOTAL @(_monedaSeleccionada?.Simbolo ?? "Gs."):</strong></td>
                                <td class="text-end"><strong>@_nc.Total.ToString("N0")</strong></td>
                            </tr>
                        </table>
                        
                        <div class="bg-light p-2 rounded small">
                            <div class="row">
                                <div class="col-4">
                                    <span>IVA 10%:</span><br/>
                                    <strong>@_nc.TotalIVA10.ToString("N0")</strong>
                                </div>
                                <div class="col-4">
                                    <span>IVA 5%:</span><br/>
                                    <strong>@_nc.TotalIVA5.ToString("N0")</strong>
                                </div>
                                <div class="col-4">
                                    <span>Exenta:</span><br/>
                                    <strong>@_nc.TotalExenta.ToString("N0")</strong>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                @* Botones de acci√≥n *@
                <div class="d-flex justify-content-between mt-4 pt-3 border-top">
                    <div>
                        <button class="btn btn-secondary" @onclick="Volver">
                            <i class="bi bi-x-lg"></i> Cancelar
                        </button>
                    </div>
                    <div class="d-flex gap-2">
                        @if (_nc.Estado != "Confirmada")
                        {
                            <button class="btn btn-success" @onclick="GuardarYConfirmar" disabled="@_guardando">
                                @if (_guardando)
                                {
                                    <span class="spinner-border spinner-border-sm me-1"></span>
                                }
                                <i class="bi bi-check-lg"></i> Guardar NC
                            </button>
                        }
                        @if (_nc.Estado == "Confirmada")
                        {
                            <button class="btn btn-info" @onclick="() => ImprimirA4()">
                                <i class="bi bi-printer"></i> Imprimir A4
                            </button>
                            <button class="btn btn-secondary" @onclick="() => _mostrarTicket = true">
                                <i class="bi bi-receipt"></i> Ticket
                            </button>
                            <button class="btn btn-primary" @onclick="NuevaNotaCredito">
                                <i class="bi bi-plus-lg"></i> Nueva NC
                            </button>
                        }
                    </div>
                </div>
            }
        </div>
    </div>
</div>

@* Modal buscar factura *@
@if (_mostrarBuscarFactura)
{
    <div class="modal fade show d-block" tabindex="-1" style="background:rgba(0,0,0,0.5);">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Buscar Factura</h5>
                    <button type="button" class="btn-close" @onclick="() => _mostrarBuscarFactura = false"></button>
                </div>
                <div class="modal-body">
                    <div class="input-group mb-3">
                        <input type="text" class="form-control" placeholder="Buscar por n√∫mero o cliente..." 
                               @bind="_busquedaFactura" @bind:event="oninput" 
                               @onkeydown="@(async e => { if (e.Key == "Enter") await BuscarFacturas(); })" />
                        <button class="btn btn-primary" @onclick="BuscarFacturas">
                            <i class="bi bi-search"></i> Buscar
                        </button>
                    </div>
                    
                    @if (_facturasEncontradas.Any())
                    {
                        <div class="table-responsive" style="max-height:450px;">
                            <table class="table table-hover table-sm">
                                <thead class="table-dark sticky-top">
                                    <tr>
                                        <th style="cursor:pointer" @onclick="@(() => OrdenarFacturas("numero"))">
                                            N√∫mero @GetOrdenIcon("numero")
                                        </th>
                                        <th style="cursor:pointer" @onclick="@(() => OrdenarFacturas("fecha"))">
                                            Fecha @GetOrdenIcon("fecha")
                                        </th>
                                        <th style="cursor:pointer" @onclick="@(() => OrdenarFacturas("cliente"))">
                                            Cliente @GetOrdenIcon("cliente")
                                        </th>
                                        <th class="text-end" style="cursor:pointer" @onclick="@(() => OrdenarFacturas("total"))">
                                            Total @GetOrdenIcon("total")
                                        </th>
                                        <th class="text-end" style="cursor:pointer" @onclick="@(() => OrdenarFacturas("saldo"))">
                                            Saldo Disp. @GetOrdenIcon("saldo")
                                        </th>
                                        <th class="text-center" style="width:80px;">Acci√≥n</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var v in ObtenerFacturasOrdenadas())
                                    {
                                        var saldoDisp = v.Total - (v.CreditoUsado ?? 0);
                                        var tieneSaldo = saldoDisp > 0;
                                        <tr class="@(tieneSaldo ? "" : "table-secondary")">
                                            <td class="fw-bold">@v.Establecimiento-@v.PuntoExpedicion-@v.NumeroFactura</td>
                                            <td>@v.Fecha.ToString("dd/MM/yyyy")</td>
                                            <td>@(v.Cliente?.RazonSocial ?? "S/N")</td>
                                            <td class="text-end">@v.Total.ToString("N0")</td>
                                            <td class="text-end @(tieneSaldo ? "text-success fw-bold" : "text-danger")">
                                                @saldoDisp.ToString("N0")
                                            </td>
                                            <td class="text-center">
                                                <button class="btn btn-success btn-sm" @onclick="@(() => SeleccionarFactura(v))" 
                                                        title="Seleccionar">
                                                    <i class="bi bi-check-lg"></i>
                                                </button>
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                        <small class="text-muted">@_facturasEncontradas.Count facturas encontradas. Click en columna para ordenar.</small>
                    }
                    else
                    {
                        <p class="text-muted text-center">Ingrese un t√©rmino de b√∫squeda y presione buscar o Enter.</p>
                    }
                </div>
            </div>
        </div>
    </div>
}

@* Modal buscar cliente *@
@if (_mostrarBuscarCliente)
{
    <div class="modal fade show d-block" tabindex="-1" style="background:rgba(0,0,0,0.5);">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Buscar Cliente</h5>
                    <button type="button" class="btn-close" @onclick="() => _mostrarBuscarCliente = false"></button>
                </div>
                <div class="modal-body">
                    <div class="input-group mb-3">
                        <input type="text" class="form-control" placeholder="Buscar por nombre o RUC..." 
                               @bind="_busquedaCliente" @bind:event="oninput" />
                        <button class="btn btn-primary" @onclick="BuscarClientes">
                            <i class="bi bi-search"></i>
                        </button>
                    </div>
                    
                    @if (_clientesEncontrados.Any())
                    {
                        <div class="table-responsive" style="max-height:300px;">
                            <table class="table table-hover table-sm">
                                <thead class="table-light sticky-top">
                                    <tr>
                                        <th>Raz√≥n Social</th>
                                        <th>RUC</th>
                                        <th>Tel√©fono</th>
                                        <th></th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var c in _clientesEncontrados)
                                    {
                                        <tr>
                                            <td>@c.RazonSocial</td>
                                            <td>@c.RUC</td>
                                            <td>@c.Telefono</td>
                                            <td>
                                                <button class="btn btn-success btn-sm" @onclick="() => SeleccionarCliente(c)">
                                                    <i class="bi bi-check"></i>
                                                </button>
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    }
                    else
                    {
                        <p class="text-muted text-center">Ingrese un t√©rmino de b√∫squeda y presione buscar.</p>
                    }
                </div>
            </div>
        </div>
    </div>
}

@* Modal buscar producto *@
@if (_mostrarBuscarProducto)
{
    <div class="modal fade show d-block" tabindex="-1" style="background:rgba(0,0,0,0.5);">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Agregar Producto</h5>
                    <button type="button" class="btn-close" @onclick="() => _mostrarBuscarProducto = false"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <input type="text" class="form-control" placeholder="Buscar por nombre, c√≥digo o c√≥digo de barras..." 
                               @bind="_busquedaProducto" @bind:event="oninput" @bind:after="BuscarProductosAsync"
                               @ref="_inputBusquedaProducto" />
                    </div>
                    
                    @if (_productosEncontrados.Any())
                    {
                        <div class="list-group" style="max-height:350px; overflow-y:auto;">
                            @foreach (var p in _productosEncontrados.Take(15))
                            {
                                <button type="button" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center @(p.Stock <= 0 ? "list-group-item-warning" : "")"
                                        @onclick="() => AgregarProducto(p)">
                                    <div>
                                        <div class="fw-semibold">@p.Descripcion</div>
                                        <div class="text-muted small">
                                            Cod: @(p.CodigoInterno ?? "-") ‚Ä¢ EAN: @(p.CodigoBarras ?? "-") ‚Ä¢ 
                                            <span class="@(p.Stock <= 0 ? "text-danger fw-bold" : "text-success")">Stock: @p.Stock.ToString("N0")</span>
                                        </div>
                                    </div>
                                    <div class="text-end">
                                        <span class="badge bg-primary fs-6">@p.PrecioUnitarioGs.ToString("N0")</span>
                                        <div class="small text-muted">IVA @(p.TipoIva?.Porcentaje ?? 10)%</div>
                                    </div>
                                </button>
                            }
                        </div>
                    }
                    else if (!string.IsNullOrWhiteSpace(_busquedaProducto))
                    {
                        <p class="text-muted text-center">No se encontraron productos.</p>
                    }
                    else
                    {
                        <p class="text-muted text-center">Escriba para buscar productos...</p>
                    }
                </div>
            </div>
        </div>
    </div>
}

@* Modal ticket preview *@
@if (_mostrarTicket && _nc.IdNotaCredito > 0)
{
    <div class="modal fade show d-block" tabindex="-1" style="background:rgba(0,0,0,0.5);">
        <div class="modal-dialog modal-sm">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Ticket NC</h5>
                    <button type="button" class="btn-close" @onclick="() => _mostrarTicket = false"></button>
                </div>
                <div class="modal-body">
                    <NotaCreditoTicketVistaPrevia NotaCredito="_ncConDetalles" Empresa="_empresa" MostrarBotonImprimir="true" />
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary btn-sm" @onclick="() => _mostrarTicket = false">Cerrar</button>
                </div>
            </div>
        </div>
    </div>
}

</PageProtection>

@code {
    [Parameter] public int? Id { get; set; }

    private NotaCreditoVenta _nc = new();
    private NotaCreditoVenta? _ncConDetalles;
    private List<NotaCreditoVentaDetalle> _detalles = new();
    private bool _esEdicion;
    private decimal _saldoDisponibleFactura; // Saldo disponible = Total factura - NC previas
    private string _usuarioActual = "Sistema";
    private int _afectaStock = 1; // 1 = Suma, 0 = No afecta, -1 = Resta
    private bool _loading = true;
    private bool _guardando;
    private bool _puedeCambiarCaja = false;
    private int? _usuarioId;
    
    // Selecciones
    private Caja? _cajaSeleccionada;
    private Venta? _ventaSeleccionada;
    private Cliente? _clienteSeleccionado;
    private Moneda? _monedaSeleccionada;
    private Sociedad? _empresa;
    
    // Listas
    private List<Caja> _cajas = new();
    private List<Moneda> _monedas = new();
    
    // Modales de b√∫squeda
    private bool _mostrarBuscarFactura;
    private bool _mostrarBuscarCliente;
    private bool _mostrarBuscarProducto;
    private bool _mostrarTicket;
    
    private string _busquedaFactura = "";
    private string _busquedaCliente = "";
    private string _busquedaProducto = "";
    
    // Control de concurrencia para b√∫squeda de productos
    private CancellationTokenSource? _ctsProductos;
    private bool _buscandoProductos;
    
    private ElementReference _inputBusquedaProducto;
    
    private List<Venta> _facturasEncontradas = new();
    private List<Cliente> _clientesEncontrados = new();
    private List<Producto> _productosEncontrados = new();
    
    // Ordenamiento de facturas
    private string _ordenFacturas = "fecha";
    private bool _ordenFacturasDesc = true;

    protected override async Task OnInitializedAsync()
    {
        var sucId = SucursalProvider.GetSucursalId();
        if (!sucId.HasValue)
        {
            Nav.NavigateTo("/sucursales");
            return;
        }
        
        // Capturar usuario autenticado
        try
        {
            var auth = await AuthStateProvider.GetAuthenticationStateAsync();
            var u = auth.User;
            if (u?.Identity?.IsAuthenticated == true)
            {
                if (int.TryParse(u.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value, out var idu))
                    _usuarioId = idu;
                
                _usuarioActual = u.Identity.Name ?? u.FindFirst(System.Security.Claims.ClaimTypes.Name)?.Value ?? "Sistema";
            }
        }
        catch { }
        
        if (string.IsNullOrEmpty(_usuarioActual))
            _usuarioActual = "Sistema";
        
        // Verificar permiso EDIT para cambiar caja
        if (_usuarioId.HasValue)
        {
            _puedeCambiarCaja = await PermisosService.TienePermisoAsync(_usuarioId.Value, "/notas-credito", "EDIT");
        }
        
        using var db = await DbFactory.CreateDbContextAsync();
        
        // Cargar cajas de la sucursal actual (IdSucursal == sucId o IdSucursal == null)
        _cajas = await db.Cajas
            .AsNoTracking()
            .Where(c => c.IdSucursal == sucId.Value || c.IdSucursal == null)
            .OrderBy(c => c.IdCaja)
            .ToListAsync();
        
        // Caja activa: primero la que tiene CajaActual == 1, luego la primera disponible
        _cajaSeleccionada = _cajas.FirstOrDefault(c => c.CajaActual == 1) ?? _cajas.FirstOrDefault();
        
        _monedas = await db.Monedas.Where(m => m.Estado).OrderBy(m => m.Orden).ToListAsync();
        _empresa = await db.Sociedades.FirstOrDefaultAsync();
        
        if (Id.HasValue && Id > 0)
        {
            // Edici√≥n
            _esEdicion = true;
            var nc = await db.NotasCreditoVentas
                .Include(n => n.Cliente)
                .Include(n => n.Caja)
                .Include(n => n.VentaAsociada)
                .Include(n => n.Moneda)
                .Include(n => n.Detalles!)
                    .ThenInclude(d => d.Producto)
                .FirstOrDefaultAsync(n => n.IdNotaCredito == Id.Value);
            
            if (nc == null)
            {
                Nav.NavigateTo("/notas-credito/explorar");
                return;
            }
            
            _nc = nc;
            _detalles = nc.Detalles?.ToList() ?? new();
            
            // Asignar PermiteDecimal desde el Producto cargado
            foreach (var det in _detalles)
            {
                det.PermiteDecimal = det.Producto?.PermiteDecimal ?? false;
            }
            
            _clienteSeleccionado = nc.Cliente;
            _ventaSeleccionada = nc.VentaAsociada;
            _cajaSeleccionada = nc.Caja ?? _cajaSeleccionada;
            _monedaSeleccionada = nc.Moneda;
            _ncConDetalles = nc;
        }
        else
        {
            // Nueva NC - _cajaSeleccionada ya est√° asignada arriba (la activa o la primera)
            _nc = new NotaCreditoVenta
            {
                IdSucursal = sucId.Value,
                IdCaja = _cajaSeleccionada?.IdCaja ?? 0,
                Fecha = _cajaSeleccionada?.FechaActualCaja ?? DateTime.Now,
                Turno = (_cajaSeleccionada?.TurnoActual ?? 1).ToString(),
                Motivo = MotivosNotaCredito.Devolucion,
                TipoDocumentoAsociado = "Electr√≥nico",
                Estado = "Borrador",
                IdMoneda = _monedas.FirstOrDefault(m => m.EsMonedaBase)?.IdMoneda ?? 1,
                CambioDelDia = 1,
                EsMonedaExtranjera = false,
                NumeroNota = await ObtenerSiguienteNumero(sucId.Value)
            };
            
            _monedaSeleccionada = _monedas.FirstOrDefault(m => m.IdMoneda == _nc.IdMoneda);
            if (_cajaSeleccionada != null)
            {
                _nc.Establecimiento = _cajaSeleccionada.Nivel1NC;
                _nc.PuntoExpedicion = _cajaSeleccionada.Nivel2NC;
                _nc.Timbrado = _cajaSeleccionada.TimbradoNC;
                _nc.Serie = _cajaSeleccionada.SerieNC;
            }
        }
        
        _loading = false;
    }

    private async Task<int> ObtenerSiguienteNumero(int sucId)
    {
        using var db = await DbFactory.CreateDbContextAsync();
        var ultimo = await db.NotasCreditoVentas
            .Where(n => n.IdSucursal == sucId)
            .OrderByDescending(n => n.NumeroNota)
            .Select(n => n.NumeroNota)
            .FirstOrDefaultAsync();
        
        return ultimo + 1;
    }

    private void OnMonedaChanged()
    {
        _monedaSeleccionada = _monedas.FirstOrDefault(m => m.IdMoneda == _nc.IdMoneda);
        _nc.SimboloMoneda = _monedaSeleccionada?.Simbolo;
        _nc.EsMonedaExtranjera = _monedaSeleccionada != null && !_monedaSeleccionada.EsMonedaBase;
        if (!_nc.EsMonedaExtranjera)
            _nc.CambioDelDia = 1;
    }

    // B√∫squeda de facturas
    private void AbrirBuscarFactura()
    {
        _busquedaFactura = "";
        _facturasEncontradas.Clear();
        _mostrarBuscarFactura = true;
    }

    private async Task BuscarFacturas()
    {
        var sucId = SucursalProvider.GetSucursalId();
        var busq = _busquedaFactura.ToLower();
        
        using var db = await DbFactory.CreateDbContextAsync();
        
        // Cargar facturas con el total de NC previas para calcular saldo disponible
        var facturas = await db.Ventas
            .Include(v => v.Cliente)
            .Where(v => v.IdSucursal == sucId && v.Estado == "Confirmado")
            .Where(v => (v.Cliente != null && v.Cliente.RazonSocial.ToLower().Contains(busq)) ||
                       (v.NumeroFactura != null && v.NumeroFactura.Contains(busq)))
            .OrderByDescending(v => v.Fecha)
            .Take(100)
            .ToListAsync();
        
        // Calcular saldo usado (NC confirmadas) para cada factura
        var idsVentas = facturas.Select(v => v.IdVenta).ToList();
        var ncPorVenta = await db.NotasCreditoVentas
            .Where(nc => nc.IdVentaAsociada.HasValue && idsVentas.Contains(nc.IdVentaAsociada.Value) && nc.Estado == "Confirmada")
            .GroupBy(nc => nc.IdVentaAsociada!.Value)
            .Select(g => new { IdVenta = g.Key, TotalNC = g.Sum(nc => nc.Total) })
            .ToDictionaryAsync(x => x.IdVenta, x => x.TotalNC);
        
        foreach (var v in facturas)
        {
            v.CreditoUsado = ncPorVenta.TryGetValue(v.IdVenta, out var usada) ? usada : 0;
        }
        
        _facturasEncontradas = facturas;
        
        // Resetear ordenamiento a fecha desc por defecto
        _ordenFacturas = "fecha";
        _ordenFacturasDesc = true;
    }
    
    private void OrdenarFacturas(string columna)
    {
        if (_ordenFacturas == columna)
            _ordenFacturasDesc = !_ordenFacturasDesc;
        else
        {
            _ordenFacturas = columna;
            _ordenFacturasDesc = columna == "fecha" || columna == "total" || columna == "saldo"; // Desc por defecto para n√∫meros
        }
    }
    
    private IEnumerable<Venta> ObtenerFacturasOrdenadas()
    {
        var ordenadas = _ordenFacturas switch
        {
            "numero" => _ordenFacturasDesc 
                ? _facturasEncontradas.OrderByDescending(v => v.NumeroFactura)
                : _facturasEncontradas.OrderBy(v => v.NumeroFactura),
            "fecha" => _ordenFacturasDesc
                ? _facturasEncontradas.OrderByDescending(v => v.Fecha)
                : _facturasEncontradas.OrderBy(v => v.Fecha),
            "cliente" => _ordenFacturasDesc
                ? _facturasEncontradas.OrderByDescending(v => v.Cliente?.RazonSocial ?? "")
                : _facturasEncontradas.OrderBy(v => v.Cliente?.RazonSocial ?? ""),
            "total" => _ordenFacturasDesc
                ? _facturasEncontradas.OrderByDescending(v => v.Total)
                : _facturasEncontradas.OrderBy(v => v.Total),
            "saldo" => _ordenFacturasDesc
                ? _facturasEncontradas.OrderByDescending(v => v.Total - (v.CreditoUsado ?? 0))
                : _facturasEncontradas.OrderBy(v => v.Total - (v.CreditoUsado ?? 0)),
            _ => _facturasEncontradas.OrderByDescending(v => v.Fecha)
        };
        return ordenadas;
    }
    
    private MarkupString GetOrdenIcon(string columna)
    {
        if (_ordenFacturas != columna)
            return new MarkupString("<i class='bi bi-chevron-expand text-muted'></i>");
        return _ordenFacturasDesc 
            ? new MarkupString("<i class='bi bi-chevron-down'></i>") 
            : new MarkupString("<i class='bi bi-chevron-up'></i>");
    }

    private async Task SeleccionarFactura(Venta v)
    {
        _ventaSeleccionada = v;
        _nc.IdVentaAsociada = v.IdVenta;
        
        using var db = await DbFactory.CreateDbContextAsync();
        
        // Calcular saldo disponible = Total factura - suma de NC confirmadas previas
        var totalNCPrevias = await db.NotasCreditoVentas
            .Where(nc => nc.IdVentaAsociada == v.IdVenta 
                      && nc.Estado == "Confirmada" 
                      && nc.IdNotaCredito != _nc.IdNotaCredito) // Excluir la actual si es edici√≥n
            .SumAsync(nc => nc.Total);
        
        _saldoDisponibleFactura = v.Total - totalNCPrevias;
        
        // Auto-seleccionar cliente
        if (v.Cliente != null)
        {
            _clienteSeleccionado = v.Cliente;
            _nc.IdCliente = v.IdCliente;
            _nc.NombreCliente = v.Cliente.RazonSocial;
        }
        
        // Cargar detalles de la factura al detalle de NC (si no hay detalles ya cargados)
        if (!_detalles.Any())
        {
            var detallesVenta = await db.VentasDetalles
                .Include(d => d.Producto)
                .Where(d => d.IdVenta == v.IdVenta)
                .ToListAsync();
            
            foreach (var dv in detallesVenta)
            {
                // Determinar tasa IVA
                int tasaIVA = 10; // default
                if (dv.IVA5 > 0 || dv.Grabado5 > 0) tasaIVA = 5;
                else if (dv.Exenta > 0 && dv.IVA10 == 0 && dv.IVA5 == 0) tasaIVA = 0;
                
                var det = new NotaCreditoVentaDetalle
                {
                    IdProducto = dv.IdProducto,
                    CodigoProducto = dv.Producto?.CodigoInterno,
                    NombreProducto = dv.Producto?.Descripcion,
                    Cantidad = dv.Cantidad,
                    PrecioUnitario = dv.PrecioUnitario,
                    PorcentajeDescuento = 0,
                    MontoDescuento = 0,
                    TasaIVA = tasaIVA
                };
                
                CalcularLinea(det);
                _detalles.Add(det);
            }
            
            RecalcularTotales();
        }
        
        _mostrarBuscarFactura = false;
    }

    private void QuitarFactura()
    {
        _ventaSeleccionada = null;
        _nc.IdVentaAsociada = null;
    }

    // B√∫squeda de clientes
    private void AbrirBuscarCliente()
    {
        _busquedaCliente = "";
        _clientesEncontrados.Clear();
        _mostrarBuscarCliente = true;
    }

    private async Task BuscarClientes()
    {
        var busq = _busquedaCliente.ToLower();
        
        using var db = await DbFactory.CreateDbContextAsync();
        _clientesEncontrados = await db.Clientes
            .Where(c => c.Estado)
            .Where(c => c.RazonSocial.ToLower().Contains(busq) || c.RUC.Contains(busq))
            .OrderBy(c => c.RazonSocial)
            .Take(50)
            .ToListAsync();
    }

    private void SeleccionarCliente(Cliente c)
    {
        _clienteSeleccionado = c;
        _nc.IdCliente = c.IdCliente;
        _nc.NombreCliente = c.RazonSocial;
        _mostrarBuscarCliente = false;
    }

    // B√∫squeda de productos
    private void AbrirBuscarProducto()
    {
        _busquedaProducto = "";
        _productosEncontrados.Clear();
        _mostrarBuscarProducto = true;
    }

    private async Task BuscarProductosAsync()
    {
        // Cancelar b√∫squeda anterior si existe
        _ctsProductos?.Cancel();
        _ctsProductos = new CancellationTokenSource();
        var token = _ctsProductos.Token;
        
        if (string.IsNullOrWhiteSpace(_busquedaProducto) || _busquedaProducto.Length < 2)
        {
            _productosEncontrados.Clear();
            return;
        }
        
        // Evitar consultas concurrentes
        if (_buscandoProductos) return;
        
        try
        {
            // Debounce: esperar 300ms antes de buscar
            await Task.Delay(300, token);
            
            _buscandoProductos = true;
            
            var sucId = SucursalProvider.GetSucursalId();
            var busq = _busquedaProducto.Trim().ToLower();
            const int depositoPrincipal = 1; // Dep√≥sito Principal
            
            using var db = await DbFactory.CreateDbContextAsync();
            
            // Traer productos con su stock del dep√≥sito principal
            var productos = await db.Productos
                .AsNoTracking()
                .Include(p => p.TipoIva)
                .Where(p => p.IdSucursal == sucId && p.Activo)
                .Where(p => p.CodigoInterno.ToLower().Contains(busq) 
                         || p.Descripcion.ToLower().Contains(busq)
                         || (p.CodigoBarras != null && p.CodigoBarras.Contains(busq)))
                .OrderBy(p => p.Descripcion)
                .Take(50)
                .ToListAsync(token);
            
            // Obtener stock del dep√≥sito principal para cada producto
            var idsProductos = productos.Select(p => p.IdProducto).ToList();
            var stocksDeposito = await db.ProductosDepositos
                .AsNoTracking()
                .Where(s => idsProductos.Contains(s.IdProducto) && s.IdDeposito == depositoPrincipal)
                .ToDictionaryAsync(s => s.IdProducto, s => s.Stock, token);
            
            // Asignar el stock del dep√≥sito principal a cada producto
            foreach (var p in productos)
            {
                p.Stock = stocksDeposito.TryGetValue(p.IdProducto, out var stk) ? stk : 0;
            }
            
            _productosEncontrados = productos;
        }
        catch (OperationCanceledException)
        {
            // B√∫squeda cancelada por nueva b√∫squeda, ignorar
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error b√∫squeda productos: {ex.Message}");
        }
        finally
        {
            _buscandoProductos = false;
        }
    }

    private void AgregarProducto(Producto p)
    {
        var tasa = p.TipoIva?.Porcentaje ?? 10;
        
        var det = new NotaCreditoVentaDetalle
        {
            IdProducto = p.IdProducto,
            // NO asignar Producto = p para evitar conflictos de tracking
            CodigoProducto = p.CodigoInterno,
            NombreProducto = p.Descripcion,
            Cantidad = 1,
            PrecioUnitario = p.PrecioUnitarioGs,
            PorcentajeDescuento = 0,
            MontoDescuento = 0,
            TasaIVA = (int)tasa,
            IdTipoIva = p.IdTipoIva,
            CambioDelDia = _nc.CambioDelDia,
            PermiteDecimal = p.PermiteDecimal
        };
        
        CalcularLinea(det);
        _detalles.Add(det);
        RecalcularTotales();
        
        _mostrarBuscarProducto = false;
    }

    private void QuitarDetalle(NotaCreditoVentaDetalle det)
    {
        _detalles.Remove(det);
        RecalcularTotales();
    }

    private void ValidarYRecalcularLinea(NotaCreditoVentaDetalle det)
    {
        // Si no permite decimal, redondear a entero
        if (!det.PermiteDecimal && det.Cantidad != Math.Floor(det.Cantidad))
        {
            det.Cantidad = Math.Max(1, Math.Round(det.Cantidad));
        }
        
        // Asegurar cantidad m√≠nima
        if (det.Cantidad < (det.PermiteDecimal ? 0.01m : 1m))
        {
            det.Cantidad = det.PermiteDecimal ? 0.01m : 1m;
        }
        
        CalcularLinea(det);
        RecalcularTotales();
    }

    private void RecalcularLinea()
    {
        foreach (var det in _detalles)
            CalcularLinea(det);
        RecalcularTotales();
    }

    private void CalcularLinea(NotaCreditoVentaDetalle det)
    {
        var subtotal = det.Cantidad * det.PrecioUnitario;
        det.MontoDescuento = subtotal * det.PorcentajeDescuento / 100;
        det.Importe = subtotal - det.MontoDescuento;
        
        // Calcular IVA
        if (det.TasaIVA == 10)
        {
            det.IVA10 = det.Importe / 11;
            det.Grabado10 = det.Importe - det.IVA10;
            det.IVA5 = 0;
            det.Grabado5 = 0;
            det.Exenta = 0;
        }
        else if (det.TasaIVA == 5)
        {
            det.IVA5 = det.Importe / 21;
            det.Grabado5 = det.Importe - det.IVA5;
            det.IVA10 = 0;
            det.Grabado10 = 0;
            det.Exenta = 0;
        }
        else
        {
            det.Exenta = det.Importe;
            det.IVA10 = 0;
            det.IVA5 = 0;
            det.Grabado10 = 0;
            det.Grabado5 = 0;
        }
    }

    private void RecalcularTotales()
    {
        _nc.Subtotal = _detalles.Sum(d => d.Cantidad * d.PrecioUnitario);
        _nc.TotalDescuento = _detalles.Sum(d => d.MontoDescuento);
        _nc.Total = _detalles.Sum(d => d.Importe);
        _nc.TotalIVA10 = _detalles.Sum(d => d.IVA10);
        _nc.TotalIVA5 = _detalles.Sum(d => d.IVA5);
        _nc.TotalExenta = _detalles.Sum(d => d.Exenta);
    }

    private void OnCajaChanged()
    {
        _cajaSeleccionada = _cajas.FirstOrDefault(c => c.IdCaja == _nc.IdCaja);
        if (_cajaSeleccionada != null)
        {
            _nc.Establecimiento = _cajaSeleccionada.Nivel1NC;
            _nc.PuntoExpedicion = _cajaSeleccionada.Nivel2NC;
            _nc.Timbrado = _cajaSeleccionada.TimbradoNC;
            _nc.Serie = _cajaSeleccionada.SerieNC;
        }
    }

    private async Task Guardar()
    {
        if (!ValidarDatos()) return;
        
        _guardando = true;
        
        try
        {
            using var db = await DbFactory.CreateDbContextAsync();
            
            // Limpiar referencias de navegaci√≥n para evitar conflictos de tracking
            _nc.Cliente = null;
            _nc.Caja = null;
            _nc.Moneda = null;
            _nc.VentaAsociada = null;
            
            foreach (var det in _detalles)
            {
                det.Producto = null;
            }
            
            _nc.Detalles = _detalles;
            _nc.FechaModificacion = DateTime.Now;
            _nc.ModificadoPor = _usuarioActual;
            
            if (_esEdicion)
            {
                // Actualizar detalles existentes
                var detExistentes = await db.Set<NotaCreditoVentaDetalle>()
                    .Where(d => d.IdNotaCredito == _nc.IdNotaCredito)
                    .ToListAsync();
                db.RemoveRange(detExistentes);
                
                foreach (var det in _detalles)
                {
                    det.IdNotaCredito = _nc.IdNotaCredito;
                    det.IdNotaCreditoDetalle = 0;
                }
                
                db.Update(_nc);
            }
            else
            {
                _nc.FechaCreacion = DateTime.Now;
                _nc.CreadoPor = _usuarioActual;
                db.NotasCreditoVentas.Add(_nc);
            }
            
            await db.SaveChangesAsync();
            
            // Cargar NC con detalles para impresi√≥n y refresco de UI
            _ncConDetalles = await db.NotasCreditoVentas
                .AsNoTracking()
                .Include(n => n.Cliente)
                .Include(n => n.Caja)
                .Include(n => n.Moneda)
                .Include(n => n.VentaAsociada)
                .Include(n => n.Detalles!)
                    .ThenInclude(d => d.Producto)
                .FirstOrDefaultAsync(n => n.IdNotaCredito == _nc.IdNotaCredito);
            
            // Actualizar _nc con los datos guardados para mostrar en UI
            if (_ncConDetalles != null)
            {
                _nc = _ncConDetalles;
                _detalles = _ncConDetalles.Detalles?.ToList() ?? new();
                _clienteSeleccionado = _ncConDetalles.Cliente;
                _ventaSeleccionada = _ncConDetalles.VentaAsociada;
            }
            
            _esEdicion = true; // Ahora es edici√≥n
            
            // Registrar acci√≥n para tracking IA
            _ = TrackingService.RegistrarOperacionAsync(
                tipoAccion: Creacion,
                categoria: "NotasCredito",
                descripcion: $"NC Venta #{_nc.NumeroNota} - {_nc.SimboloMoneda} {_nc.Total:N0} - {_nc.Motivo}",
                entidadId: _nc.IdNotaCredito,
                entidadTipo: "NotaCreditoVenta",
                datos: new { Cliente = _clienteSeleccionado?.RazonSocial, Items = _detalles.Count });
            
            await JS.InvokeVoidAsync("alert", "Nota de cr√©dito guardada correctamente.");
            
            // Preguntar si desea imprimir
            if (await JS.InvokeAsync<bool>("confirm", "¬øDesea imprimir el ticket de la Nota de Cr√©dito?"))
            {
                _mostrarTicket = true;
            }
            
            StateHasChanged();
        }
        catch (Exception ex)
        {
            var innerMsg = ex.InnerException?.Message ?? "";
            await JS.InvokeVoidAsync("alert", $"Error al guardar: {ex.Message}\n{innerMsg}");
            
            // Registrar error para tracking IA
            _ = TrackingService.RegistrarErrorAsync(
                descripcion: $"Error al guardar NC Venta: {ex.Message}",
                mensajeError: ex.Message,
                stackTrace: ex.StackTrace,
                componente: "NotasCredito");
        }
        finally
        {
            _guardando = false;
        }
    }

    private async Task GuardarYConfirmar()
    {
        if (!ValidarDatos()) return;
        
        // Validar que no exceda el saldo disponible de la factura
        if (_ventaSeleccionada != null && _nc.Total > _saldoDisponibleFactura)
        {
            await JS.InvokeVoidAsync("alert", 
                $"El monto de la NC ({_nc.Total:N0}) excede el saldo disponible de la factura ({_saldoDisponibleFactura:N0}).\n" +
                "No puede emitir una NC por un monto mayor al saldo pendiente.");
            return;
        }
        
        var stockMsg = _afectaStock switch
        {
            1 => "\n\n‚úÖ Se SUMAR√Å el stock de los productos.",
            -1 => "\n\n‚ö†Ô∏è Se RESTAR√Å el stock de los productos.",
            _ => "\n\nüìã No se modificar√° el stock."
        };
        
        if (!await JS.InvokeAsync<bool>("confirm", $"¬øGuardar la nota de cr√©dito?{stockMsg}"))
            return;
        
        _nc.Estado = "Confirmada";
        _nc.AfectaStock = _afectaStock; // Guardar para poder revertir al anular
        await Guardar();
        
        // Obtener datos de caja para movimientos
        var caja = await CajaService.ObtenerCajaActualAsync();
        var fechaCaja = caja?.FechaActualCaja ?? DateTime.Today;
        var turno = caja?.TurnoActual ?? 1;
        var idCaja = caja?.IdCaja;
        
        using var db = await DbFactory.CreateDbContextAsync();
        
        // Procesar stock si corresponde
        if (_afectaStock != 0)
        {
            foreach (var det in _detalles)
            {
                if (det.IdProducto > 0)
                {
                    var producto = await db.Productos.FindAsync(det.IdProducto);
                    var depositoId = producto?.IdDepositoPredeterminado ?? 1;
                    
                    // Tipo: 1 = Entrada, 2 = Salida
                    var tipoMov = _afectaStock == 1 ? 1 : 2;
                    var motivo = $"NC #{_nc.NumeroNota} - {_nc.Motivo}";
                    
                    await Inventario.AjustarStockAsync(
                        det.IdProducto,
                        depositoId,
                        det.Cantidad,
                        tipoMov,
                        motivo,
                        _usuarioActual ?? "Sistema",
                        _nc.IdSucursal,
                        idCaja,
                        fechaCaja,
                        turno
                    );
                }
            }
        }
        
        // Actualizar saldo de factura (restar el monto de la NC del total de la factura)
        if (_nc.IdVentaAsociada.HasValue)
        {
            var venta = await db.Ventas.FindAsync(_nc.IdVentaAsociada.Value);
            if (venta != null)
            {
                // Si no tiene CreditoSaldo inicializado, usar Total como base
                if (!venta.CreditoSaldo.HasValue)
                    venta.CreditoSaldo = venta.Total;
                
                venta.CreditoSaldo = Math.Max(0, venta.CreditoSaldo.Value - _nc.Total);
                await db.SaveChangesAsync();
            }
        }
        
        // Guardar n√∫mero de NC para mostrar en mensaje
        var numeroGuardado = _nc.NumeroNota;
        
        // Preguntar si desea imprimir
        var imprimir = await JS.InvokeAsync<bool>("confirm", $"NC #{numeroGuardado} guardada correctamente.\n\n¬øDesea imprimir el ticket?");
        
        if (imprimir && _ncConDetalles != null)
        {
            _mostrarTicket = true;
            StateHasChanged();
            // Esperar un momento para que se muestre el ticket y luego limpiar
            await Task.Delay(100);
        }
        
        // Limpiar para nueva NC (pero mantener ticket visible si se eligi√≥ imprimir)
        if (!imprimir)
        {
            await NuevaNotaCredito();
        }
    }

    private bool ValidarDatos()
    {
        if (!_detalles.Any())
        {
            JS.InvokeVoidAsync("alert", "Debe agregar al menos un producto.");
            return false;
        }
        
        if (_nc.IdCaja == 0)
        {
            JS.InvokeVoidAsync("alert", "Debe seleccionar una caja.");
            return false;
        }
        
        return true;
    }

    private void Volver()
    {
        Nav.NavigateTo("/notas-credito/explorar");
    }

    private void ImprimirA4()
    {
        if (_nc.IdNotaCredito > 0)
            Nav.NavigateTo($"/notas-credito/imprimir/{_nc.IdNotaCredito}");
    }

    private string GetBadgeClass(string estado) => estado switch
    {
        "Borrador" => "bg-warning text-dark",
        "Confirmada" => "bg-success",
        "Anulada" => "bg-danger",
        _ => "bg-secondary"
    };

    private string GetAfectaStockClass() => _afectaStock switch
    {
        1 => "border-success text-success",
        -1 => "border-danger text-danger",
        _ => ""
    };

    private void OnMotivoChanged()
    {
        // Sugerir comportamiento de stock seg√∫n motivo
        _afectaStock = _nc.Motivo switch
        {
            "Devoluci√≥n" => 1,           // Suma stock (cliente devuelve)
            "Mercader√≠a defectuosa" => 1, // Suma stock
            "Error de facturaci√≥n" => 0,  // No afecta stock
            "Descuento" => 0,             // No afecta stock
            "Bonificaci√≥n" => 0,          // No afecta stock
            _ => 0
        };
    }

    private async Task NuevaNotaCredito()
    {
        var sucId = SucursalProvider.GetSucursalId();
        if (!sucId.HasValue) return;
        
        // Limpiar todos los datos
        _detalles.Clear();
        _ventaSeleccionada = null;
        _clienteSeleccionado = null;
        _saldoDisponibleFactura = 0;
        _esEdicion = false;
        _ncConDetalles = null;
        _afectaStock = 0;
        
        // Crear nueva NC con valores por defecto (los totales de IVA se inicializan en 0)
        _nc = new NotaCreditoVenta
        {
            IdSucursal = sucId.Value,
            IdCaja = _cajaSeleccionada?.IdCaja ?? 0,
            Fecha = _cajaSeleccionada?.FechaActualCaja ?? DateTime.Now,
            Turno = (_cajaSeleccionada?.TurnoActual ?? 1).ToString(),
            Motivo = MotivosNotaCredito.Devolucion,
            Estado = "Borrador",
            IdMoneda = _monedas.FirstOrDefault(m => m.EsMonedaBase)?.IdMoneda ?? 1,
            CambioDelDia = 1,
            CreadoPor = _usuarioActual ?? "Sistema",
            FechaCreacion = DateTime.Now,
            TotalIVA5 = 0,
            TotalIVA10 = 0,
            TotalExenta = 0,
            Subtotal = 0,
            Total = 0
        };
        
        // Asignar datos de la caja seleccionada
        if (_cajaSeleccionada != null)
        {
            _nc.Establecimiento = _cajaSeleccionada.Nivel1NC;
            _nc.PuntoExpedicion = _cajaSeleccionada.Nivel2NC;
            _nc.Timbrado = _cajaSeleccionada.TimbradoNC;
            _nc.Serie = _cajaSeleccionada.SerieNC;
        }
        
        // Obtener siguiente n√∫mero
        _nc.NumeroNota = await ObtenerSiguienteNumero(sucId.Value);
        
        // Seleccionar moneda base
        _monedaSeleccionada = _monedas.FirstOrDefault(m => m.EsMonedaBase) ?? _monedas.FirstOrDefault();
        
        StateHasChanged();
    }
}
