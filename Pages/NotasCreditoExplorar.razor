@page "/notas-credito/explorar"
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize]
@using SistemIA.Models
@using SistemIA.Data
@using SistemIA.Services
@using Microsoft.EntityFrameworkCore
@using System.Text.Json
@inject IDbContextFactory<AppDbContext> DbFactory
@inject AppDbContext Db
@inject NavigationManager Nav
@inject ISucursalProvider SucursalProvider
@inject IJSRuntime JS
@inject IInventarioService Inventario
@inject ICajaService CajaService
@inject ILoteService LoteService
@inject IHttpClientFactory HttpClientFactory
@inject PermisosService PermisosService
@inject Microsoft.AspNetCore.Components.Authorization.AuthenticationStateProvider AuthStateProvider

<PageProtection Modulo="/notas-credito" Permiso="VIEW">
<PageTitle>Explorar Notas de Crédito</PageTitle>

<div class="container-fluid">
    <div class="card shadow-sm">
        <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
            <h5 class="mb-0"><i class="bi bi-file-earmark-minus me-2"></i>Notas de Crédito de Venta</h5>
            <button class="btn btn-light btn-sm" @onclick="NuevaNotaCredito">
                <i class="bi bi-plus-lg"></i> Nueva NC
            </button>
        </div>
        
        <div class="card-body">
            @* Filtros *@
            <div class="row g-2 mb-3">
                <div class="col-md-2">
                    <label class="form-label small">Desde</label>
                    <input type="date" class="form-control form-control-sm" @bind="_filtroDesde" />
                </div>
                <div class="col-md-2">
                    <label class="form-label small">Hasta</label>
                    <input type="date" class="form-control form-control-sm" @bind="_filtroHasta" />
                </div>
                <div class="col-md-2">
                    <label class="form-label small">Estado</label>
                    <select class="form-select form-select-sm" @bind="_filtroEstado">
                        <option value="">Todos</option>
                        <option value="Borrador">Borrador</option>
                        <option value="Confirmada">Confirmada</option>
                        <option value="Anulada">Anulada</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label small">Cliente/Número</label>
                    <input type="text" class="form-control form-control-sm" placeholder="Buscar..." @bind="_filtroBusqueda" @bind:event="oninput" />
                </div>
                <div class="col-md-3 d-flex align-items-end gap-2">
                    <button class="btn btn-primary btn-sm" @onclick="CargarDatos">
                        <i class="bi bi-search"></i> Buscar
                    </button>
                    <button class="btn btn-outline-secondary btn-sm" @onclick="LimpiarFiltros">
                        <i class="bi bi-x-lg"></i> Limpiar
                    </button>
                </div>
            </div>
            
            @if (_loading)
            {
                <div class="text-center p-4">
                    <div class="spinner-border text-primary" role="status"></div>
                    <p class="mt-2">Cargando...</p>
                </div>
            }
            else if (!_notas.Any())
            {
                <div class="alert alert-info">
                    <i class="bi bi-info-circle me-2"></i>No se encontraron notas de crédito con los filtros seleccionados.
                </div>
            }
            else
            {
                <div class="table-responsive">
                    <table class="table table-hover table-sm">
                        <thead class="table-light">
                            <tr>
                                <th style="width:70px;">ID Venta</th>
                                <th style="width:100px;">Número</th>
                                <th style="width:100px;">Fecha</th>
                                <th>Cliente</th>
                                <th style="width:120px;">RUC</th>
                                <th style="width:130px;">Motivo</th>
                                <th style="width:100px;">Factura Ref.</th>
                                <th style="width:110px;" class="text-end">Total</th>
                                <th style="width:90px;" class="text-center">Estado</th>
                                <th style="width:100px;" class="text-center">SIFEN</th>
                                <th style="width:180px;" class="text-center">Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var nc in _notas)
                            {
                                <tr class="@(nc.Estado == "Anulada" ? "table-secondary text-decoration-line-through" : "")">
                                    <td class="text-muted small">@(nc.IdVentaAsociada?.ToString() ?? "-")</td>
                                    <td>@nc.Establecimiento-@nc.PuntoExpedicion-@nc.NumeroNota.ToString("D7")</td>
                                    <td>@nc.Fecha.ToString("dd/MM/yyyy")</td>
                                    <td>@(nc.Cliente?.RazonSocial ?? nc.NombreCliente ?? "S/N")</td>
                                    <td>@(nc.Cliente?.RUC ?? "")</td>
                                    <td><small>@nc.Motivo</small></td>
                                    <td>
                                        @if (nc.VentaAsociada != null)
                                        {
                                            <small>@nc.VentaAsociada.Establecimiento-@nc.VentaAsociada.PuntoExpedicion-@nc.VentaAsociada.NumeroFactura</small>
                                        }
                                    </td>
                                    <td class="text-end">@(nc.SimboloMoneda ?? "Gs.") @nc.Total.ToString("N0")</td>
                                    <td class="text-center">
                                        <span class="badge @GetBadgeClass(nc.Estado)">@nc.Estado</span>
                                    </td>
                                    <td class="text-center">
                                        @if (!string.IsNullOrEmpty(nc.EstadoSifen))
                                        {
                                            <span class="badge @GetSifenBadgeClass(nc.EstadoSifen)" title="@nc.MensajeSifen">
                                                @nc.EstadoSifen
                                            </span>
                                            @if (nc.EstadoSifen == "ACEPTADO" && !string.IsNullOrEmpty(nc.UrlQrSifen))
                                            {
                                                <a href="@nc.UrlQrSifen" target="_blank" class="ms-1" title="Ver QR SIFEN">
                                                    <i class="bi bi-qr-code text-success"></i>
                                                </a>
                                            }
                                        }
                                        else if (nc.Estado == "Confirmada")
                                        {
                                            <span class="badge bg-light text-dark">Pendiente</span>
                                        }
                                    </td>
                                    <td class="text-center">
                                        <div class="btn-group btn-group-sm">
                                            <button class="btn btn-outline-primary" title="Editar" @onclick="() => Editar(nc.IdNotaCredito)" disabled="@(nc.Estado != "Borrador")">
                                                <i class="bi bi-pencil"></i>
                                            </button>
                                            <button class="btn btn-outline-info" title="Imprimir A4 (KuDE)" @onclick="() => ImprimirA4(nc.IdNotaCredito)">
                                                <i class="bi bi-printer"></i>
                                            </button>
                                            @if (nc.Estado == "Borrador")
                                            {
                                                <button class="btn btn-outline-success" title="Confirmar" @onclick="() => Confirmar(nc)">
                                                    <i class="bi bi-check-lg"></i>
                                                </button>
                                            }
                                            @if (nc.Estado == "Confirmada")
                                            {
                                                <button class="btn btn-outline-danger" title="Anular" @onclick="() => Anular(nc)">
                                                    <i class="bi bi-x-lg"></i>
                                                </button>
                                            }
                                            @if (_tienePermisoEliminar && PuedeEliminarNC(nc))
                                            {
                                                <button class="btn btn-danger" title="Eliminar permanentemente" @onclick="() => EliminarNC(nc)">
                                                    <i class="bi bi-trash3"></i>
                                                </button>
                                            }
                                        </div>
                                        @* Botones SIFEN - Igual que VentasExplorar *@
                                        <div class="btn-group btn-group-sm" role="group">
                                            @if (!string.IsNullOrWhiteSpace(nc.CDC))
                                            {
                                                <button class="btn btn-outline-info" title="Ver QR" @onclick="() => MostrarQR(nc.CDC, nc.UrlQrSifen)"><i class="bi bi-qr-code"></i></button>
                                            }
                                            <button class="btn btn-outline-primary" title="Enviar SIFEN" disabled="@(nc.Estado != "Confirmada" || nc.EstadoSifen == "ACEPTADO" || _enviandoSifen)" @onclick="() => EnviarSifen(nc)">
                                                @if (_enviandoSifen && _ncEnviando == nc.IdNotaCredito)
                                                {
                                                    <span class="spinner-border spinner-border-sm"></span>
                                                }
                                                else
                                                {
                                                    <i class="bi bi-send"></i>
                                                }
                                            </button>
                                            <button class="btn btn-outline-success" title="Consultar SIFEN" disabled="@(string.IsNullOrWhiteSpace(nc.IdLote) && string.IsNullOrWhiteSpace(nc.CDC))" @onclick="() => ConsultarSifen(nc)">
                                                @if (_consultandoSifen && _ncConsultando == nc.IdNotaCredito)
                                                {
                                                    <span class="spinner-border spinner-border-sm"></span>
                                                }
                                                else
                                                {
                                                    <i class="bi bi-cloud-check"></i>
                                                }
                                            </button>
                                            <a class="btn btn-outline-dark" title="Ver XML" href="/notascredito/@nc.IdNotaCredito/xml" target="_blank"><i class="bi bi-filetype-xml"></i></a>
                                        </div>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
                
                @* Totales *@
                <div class="row mt-3">
                    <div class="col-md-6">
                        <small class="text-muted">Mostrando @_notas.Count notas de crédito</small>
                    </div>
                    <div class="col-md-6 text-end">
                        <strong>Total: Gs. @_notas.Where(n => n.Estado != "Anulada").Sum(n => n.Total).ToString("N0")</strong>
                    </div>
                </div>
            }
        </div>
    </div>
</div>

@* Modal QR SIFEN *@
@if (_mostrarQR && !string.IsNullOrWhiteSpace(_qrCdc))
{
    <div class="modal fade show d-block" tabindex="-1" style="background:rgba(0,0,0,0.5);">
        <div class="modal-dialog modal-sm modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h6 class="modal-title"><i class="bi bi-qr-code me-2"></i>QR SIFEN</h6>
                    <button type="button" class="btn-close btn-close-white" @onclick="CerrarQR"></button>
                </div>
                <div class="modal-body text-center">
                    @{
                        var esTest = _empresa?.ServidorSifen?.Contains("test", StringComparison.OrdinalIgnoreCase) ?? true;
                        var baseConsulta = esTest 
                            ? "https://ekuatia.set.gov.py/consultas-test/qr?"
                            : "https://ekuatia.set.gov.py/consultas/qr?";
                        
                        var consultaUrl = !string.IsNullOrWhiteSpace(_qrUrl) 
                            ? _qrUrl 
                            : $"{baseConsulta}cdc={_qrCdc}";
                        
                        var qrImgUrl = $"https://api.qrserver.com/v1/create-qr-code/?size=200x200&data={Uri.EscapeDataString(consultaUrl)}";
                    }
                    <img src="@qrImgUrl" alt="QR SIFEN" class="img-fluid mb-3" style="max-width: 200px;" />
                    <p class="small text-muted mb-1">CDC:</p>
                    <p class="small text-break" style="font-family: monospace;">@_qrCdc</p>
                </div>
                <div class="modal-footer justify-content-between">
                    <a href="@consultaUrl" target="_blank" class="btn btn-primary btn-sm">
                        <i class="bi bi-box-arrow-up-right me-1"></i>Consultar en SET
                    </a>
                    <button class="btn btn-secondary btn-sm" @onclick="CerrarQR">Cerrar</button>
                </div>
            </div>
        </div>
    </div>
}

@* Modal de Resultado SIFEN (Envío/Consulta) *@
@if (_mostrarResultadoSifen)
{
    <div class="modal fade show d-block" tabindex="-1" style="background:rgba(0,0,0,0.6);">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header @(_resultadoSifenExito ? "bg-success" : "bg-danger") text-white">
                    <h5 class="modal-title">
                        <i class="bi @(_resultadoSifenExito ? "bi-check-circle" : "bi-x-circle") me-2"></i>
                        @(_resultadoSifenExito ? "Operación Exitosa" : "Error en Operación")
                    </h5>
                    <button type="button" class="btn-close btn-close-white" @onclick="CerrarResultadoSifen"></button>
                </div>
                <div class="modal-body">
                    @if (_resultadoSifenExito)
                    {
                        <div class="text-center mb-3">
                            <i class="bi bi-check-circle-fill text-success" style="font-size: 4rem;"></i>
                        </div>
                        <div class="alert alert-success">
                            <strong>Estado:</strong> @_resultadoSifenEstado
                        </div>
                        @if (!string.IsNullOrWhiteSpace(_resultadoSifenCdc))
                        {
                            <div class="mb-2">
                                <strong>CDC:</strong>
                                <div class="small text-muted text-break font-monospace">@_resultadoSifenCdc</div>
                            </div>
                        }
                        @if (!string.IsNullOrWhiteSpace(_resultadoSifenCodigo))
                        {
                            <div class="mb-2"><strong>Código:</strong> @_resultadoSifenCodigo</div>
                        }
                    }
                    else
                    {
                        <div class="text-center mb-3">
                            <i class="bi bi-x-circle-fill text-danger" style="font-size: 4rem;"></i>
                        </div>
                        <div class="alert alert-danger">
                            <strong>Error:</strong> @_resultadoSifenError
                        </div>
                        @if (!string.IsNullOrWhiteSpace(_resultadoSifenCodigo))
                        {
                            <div class="mb-2"><strong>Código:</strong> @_resultadoSifenCodigo</div>
                        }
                    }
                    @if (!string.IsNullOrWhiteSpace(_resultadoSifenMensaje))
                    {
                        <div class="mb-2"><strong>Mensaje:</strong> @_resultadoSifenMensaje</div>
                    }
                </div>
                <div class="modal-footer">
                    <button class="btn btn-primary" @onclick="CerrarResultadoSifen">
                        <i class="bi bi-check-lg me-1"></i>Aceptar
                    </button>
                </div>
            </div>
        </div>
    </div>
}

@* Modal Confirmar Anulación SIFEN *@
@if (_mostrarConfirmarAnulacion)
{
    <div class="modal fade show d-block" tabindex="-1" style="background:rgba(0,0,0,0.6);">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-warning text-dark">
                    <h5 class="modal-title">
                        <i class="bi bi-exclamation-triangle me-2"></i>
                        Anular NC con SIFEN
                    </h5>
                    <button type="button" class="btn-close" @onclick="CancelarAnulacion"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-warning">
                        <i class="bi bi-info-circle me-2"></i>
                        Esta NC fue <strong>APROBADA</strong> por SIFEN. Se enviará un Evento de Cancelación antes de anular.
                    </div>
                    
                    <div class="mb-3">
                        <strong>NC:</strong> @_ncAnulando?.Establecimiento-@_ncAnulando?.PuntoExpedicion-@_ncAnulando?.NumeroNota.ToString("D7")
                    </div>
                    <div class="mb-3">
                        <strong>CDC:</strong>
                        <div class="small text-muted text-break font-monospace">@_ncAnulando?.CDC</div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label"><strong>Motivo de anulación:</strong> <span class="text-danger">*</span></label>
                        <textarea class="form-control" rows="3" @bind="_motivoAnulacion" 
                                  placeholder="Ingrese el motivo (5-500 caracteres)"></textarea>
                        <small class="text-muted">@(_motivoAnulacion?.Length ?? 0)/500 caracteres</small>
                    </div>
                    
                    <div class="alert alert-danger">
                        <i class="bi bi-exclamation-octagon me-2"></i>
                        <strong>¡Atención!</strong> Esta acción es <strong>IRREVERSIBLE</strong> en SIFEN.
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" @onclick="CancelarAnulacion" disabled="@_procesandoAnulacion">
                        Cancelar
                    </button>
                    <button class="btn btn-danger" @onclick="ConfirmarAnulacionSifen" disabled="@_procesandoAnulacion">
                        @if (_procesandoAnulacion)
                        {
                            <span class="spinner-border spinner-border-sm me-1"></span>
                            <span>Procesando...</span>
                        }
                        else
                        {
                            <i class="bi bi-send me-1"></i>
                            <span>Enviar Cancelación</span>
                        }
                    </button>
                </div>
            </div>
        </div>
    </div>
}

</PageProtection>

@code {
    private List<NotaCreditoVenta> _notas = new();
    private bool _loading = true;
    private Sociedad? _empresa;
    
    // Filtros
    private DateTime _filtroDesde = DateTime.Today.AddDays(-30);
    private DateTime _filtroHasta = DateTime.Today;
    private string _filtroEstado = "";
    private string _filtroBusqueda = "";
    
    // SIFEN
    private bool _enviandoSifen;
    private bool _consultandoSifen;
    private int? _ncEnviando;
    private int? _ncConsultando;
    
    // QR Modal
    private bool _mostrarQR;
    private string? _qrCdc;
    private string? _qrUrl;
    
    // Modal Resultado SIFEN
    private bool _mostrarResultadoSifen;
    private bool _resultadoSifenExito;
    private string? _resultadoSifenEstado;
    private string? _resultadoSifenCdc;
    private string? _resultadoSifenCodigo;
    private string? _resultadoSifenMensaje;
    private string? _resultadoSifenError;
    
    // Modal Anulación SIFEN
    private bool _mostrarConfirmarAnulacion;
    private bool _procesandoAnulacion;
    private NotaCreditoVenta? _ncAnulando;
    private string? _motivoAnulacion;
    
    // Permiso DELETE
    private bool _tienePermisoEliminar;
    private int? _usuarioId;

    protected override async Task OnInitializedAsync()
    {
        var sucId = SucursalProvider.GetSucursalId();
        if (!sucId.HasValue)
        {
            Nav.NavigateTo("/sucursales");
            return;
        }
        
        _empresa = await Db.Sociedades.FirstOrDefaultAsync();
        
        // Verificar permiso DELETE
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var idUsuStr = authState.User?.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;
        if (int.TryParse(idUsuStr, out var idUsu))
        {
            _usuarioId = idUsu;
            _tienePermisoEliminar = await PermisosService.TienePermisoAsync(idUsu, "/notas-credito", "DELETE");
        }
        
        await CargarDatos();
    }

    private async Task CargarDatos()
    {
        _loading = true;
        var sucId = SucursalProvider.GetSucursalId();
        
        var query = Db.NotasCreditoVentas
            .Include(n => n.Cliente)
            .Include(n => n.VentaAsociada)
            .Include(n => n.Detalles)
            .Where(n => n.IdSucursal == sucId)
            .Where(n => n.Fecha.Date >= _filtroDesde.Date && n.Fecha.Date <= _filtroHasta.Date);
        
        if (!string.IsNullOrEmpty(_filtroEstado))
            query = query.Where(n => n.Estado == _filtroEstado);
        
        if (!string.IsNullOrEmpty(_filtroBusqueda))
        {
            var busq = _filtroBusqueda.ToLower();
            query = query.Where(n => 
                (n.Cliente != null && n.Cliente.RazonSocial.ToLower().Contains(busq)) ||
                (n.NombreCliente != null && n.NombreCliente.ToLower().Contains(busq)) ||
                n.NumeroNota.ToString().Contains(busq));
        }
        
        _notas = await query.OrderByDescending(n => n.IdNotaCredito).ToListAsync();
        _loading = false;
    }

    private void LimpiarFiltros()
    {
        _filtroDesde = DateTime.Today.AddDays(-30);
        _filtroHasta = DateTime.Today;
        _filtroEstado = "";
        _filtroBusqueda = "";
    }

    private void NuevaNotaCredito()
    {
        Nav.NavigateTo("/notas-credito");
    }

    private void Editar(int id)
    {
        Nav.NavigateTo($"/notas-credito/{id}");
    }

    private void ImprimirA4(int id)
    {
        Nav.NavigateTo($"/notas-credito/imprimir/{id}");
    }

    private async Task Confirmar(NotaCreditoVenta nc)
    {
        if (!await JS.InvokeAsync<bool>("confirm", $"¿Confirmar la NC #{nc.NumeroNota}? Una vez confirmada, no podrá editarse."))
            return;
        
        nc.Estado = "Confirmada";
        nc.ModificadoPor = "Sistema";
        nc.FechaModificacion = DateTime.Now;
        
        // Actualizar saldo de factura si aplica
        if (nc.IdVentaAsociada.HasValue)
        {
            var venta = await Db.Ventas.FindAsync(nc.IdVentaAsociada.Value);
            if (venta != null && venta.CreditoSaldo.HasValue)
            {
                venta.CreditoSaldo = Math.Max(0, venta.CreditoSaldo.Value - nc.Total);
            }
        }
        
        await Db.SaveChangesAsync();
        await CargarDatos();
    }

    private async Task Anular(NotaCreditoVenta nc)
    {
        // Si la NC fue aprobada por SIFEN, mostrar modal de confirmación con motivo
        var estadosSifenAprobados = new[] { "ACEPTADO", "APROBADO" };
        var ncAprobadaSifen = !string.IsNullOrWhiteSpace(nc.EstadoSifen) && 
                             estadosSifenAprobados.Contains(nc.EstadoSifen.ToUpper());
        
        if (ncAprobadaSifen && !string.IsNullOrWhiteSpace(nc.CDC))
        {
            // Verificar si puede cancelar (dentro de 48 horas)
            var ncDb = await Db.NotasCreditoVentas.FirstOrDefaultAsync(n => n.IdNotaCredito == nc.IdNotaCredito);
            if (ncDb?.FechaEnvioSifen.HasValue == true)
            {
                var horasTranscurridas = (DateTime.Now - ncDb.FechaEnvioSifen.Value).TotalHours;
                if (horasTranscurridas > 48)
                {
                    MostrarResultadoSifen(false, null, null, null, 
                        $"Han pasado más de 48 horas desde el envío a SIFEN ({horasTranscurridas:F1} horas).\nNo se puede cancelar vía evento SIFEN.",
                        null);
                    return;
                }
            }
            
            // Mostrar modal de confirmación con motivo
            _ncAnulando = nc;
            _motivoAnulacion = "Operación cancelada";
            _mostrarConfirmarAnulacion = true;
            StateHasChanged();
            return;
        }
        
        // NC no fue aprobada por SIFEN, anulación normal
        if (!await JS.InvokeAsync<bool>("confirm", $"¿Anular la NC #{nc.NumeroNota}? Esta acción no se puede deshacer."))
            return;
        
        await ProcesarAnulacionLocal(nc);
    }
    
    private void CancelarAnulacion()
    {
        _mostrarConfirmarAnulacion = false;
        _ncAnulando = null;
        _motivoAnulacion = null;
        _procesandoAnulacion = false;
    }
    
    private async Task ConfirmarAnulacionSifen()
    {
        if (_ncAnulando == null || string.IsNullOrWhiteSpace(_motivoAnulacion))
        {
            await JS.InvokeVoidAsync("alert", "Debe ingresar un motivo de anulación.");
            return;
        }
        
        if (_motivoAnulacion.Length < 5 || _motivoAnulacion.Length > 500)
        {
            await JS.InvokeVoidAsync("alert", "El motivo debe tener entre 5 y 500 caracteres.");
            return;
        }
        
        _procesandoAnulacion = true;
        StateHasChanged();
        
        try
        {
            // Enviar evento de cancelación a SIFEN para la NC
            var handler = new HttpClientHandler();
            handler.ServerCertificateCustomValidationCallback = (message, cert, chain, errors) => true;
            using var http = new HttpClient(handler);
            http.Timeout = TimeSpan.FromSeconds(120);
            
            var baseUrl = Nav.BaseUri.TrimEnd('/');
            var response = await http.PostAsync(
                $"{baseUrl}/notascredito/{_ncAnulando.IdNotaCredito}/cancelar-sifen?motivo={Uri.EscapeDataString(_motivoAnulacion)}", 
                null);
            var json = await response.Content.ReadAsStringAsync();
            
            var result = JsonSerializer.Deserialize<Dictionary<string, JsonElement>>(json);
            var exito = result?.TryGetValue("ok", out var okEl) == true && okEl.GetBoolean();
            
            if (exito)
            {
                // SIFEN aceptó, procesar anulación local
                _mostrarConfirmarAnulacion = false;
                await ProcesarAnulacionLocal(_ncAnulando);
                
                var codigo = result?.TryGetValue("codigo", out var codEl) == true ? codEl.GetString() : "";
                MostrarResultadoSifen(true, "CANCELADO EN SIFEN", _ncAnulando.CDC, codigo, 
                    "La NC fue cancelada en SIFEN y anulada en el sistema.", null);
            }
            else
            {
                var error = result?.TryGetValue("error", out var errEl) == true ? errEl.GetString() : "Error desconocido";
                var codigo = result?.TryGetValue("codigo", out var codEl) == true ? codEl.GetString() : "";
                var mensaje = result?.TryGetValue("mensaje", out var msgEl) == true ? msgEl.GetString() : "";
                
                MostrarResultadoSifen(false, null, null, codigo, mensaje, error);
            }
        }
        catch (Exception ex)
        {
            MostrarResultadoSifen(false, null, null, null, null, $"Error de conexión: {ex.Message}");
        }
        finally
        {
            _procesandoAnulacion = false;
            _mostrarConfirmarAnulacion = false;
            _ncAnulando = null;
            StateHasChanged();
        }
    }
    
    private async Task ProcesarAnulacionLocal(NotaCreditoVenta nc)
    {
        using var db = await DbFactory.CreateDbContextAsync();
        
        // Recargar NC con detalles para reversión de stock
        var ncDb = await db.NotasCreditoVentas
            .Include(n => n.Detalles!)
                .ThenInclude(d => d.Producto)
            .FirstOrDefaultAsync(n => n.IdNotaCredito == nc.IdNotaCredito);
        
        if (ncDb == null) return;
        
        ncDb.Estado = "Anulada";
        ncDb.ModificadoPor = "Sistema";
        ncDb.FechaModificacion = DateTime.Now;
        
        // Revertir movimientos de lotes (para productos con control de lotes)
        await LoteService.RevertirMovimientoAsync("NotaCreditoVenta", nc.IdNotaCredito, "Sistema");
        
        // Revertir stock si la NC afectaba stock
        if (ncDb.AfectaStock != 0 && ncDb.Detalles != null && ncDb.Detalles.Any())
        {
            var caja = await CajaService.ObtenerCajaActualAsync();
            var fechaCaja = caja?.FechaActualCaja ?? DateTime.Today;
            var turno = caja?.TurnoActual ?? 1;
            var idCaja = caja?.IdCaja;
            
            foreach (var det in ncDb.Detalles)
            {
                if (det.IdProducto > 0)
                {
                    var depositoId = det.Producto?.IdDepositoPredeterminado ?? 1;
                    
                    // Revertir: Si NC sumó (1=entrada), ahora restamos (2=salida) y viceversa
                    var tipoMov = ncDb.AfectaStock == 1 ? 2 : 1;
                    var motivo = $"Anulación NC #{ncDb.NumeroNota}";
                    
                    await Inventario.AjustarStockAsync(
                        det.IdProducto,
                        depositoId,
                        det.Cantidad,
                        tipoMov,
                        motivo,
                        "Sistema",
                        ncDb.IdSucursal,
                        idCaja,
                        fechaCaja,
                        turno
                    );
                }
            }
        }
        
        // Revertir saldo de factura si aplica
        if (ncDb.IdVentaAsociada.HasValue)
        {
            var venta = await db.Ventas.FindAsync(ncDb.IdVentaAsociada.Value);
            if (venta != null && venta.CreditoSaldo.HasValue)
            {
                venta.CreditoSaldo += ncDb.Total;
            }
        }
        
        await db.SaveChangesAsync();
        await CargarDatos();
    }

    private string GetBadgeClass(string estado) => estado switch
    {
        "Borrador" => "bg-warning text-dark",
        "Confirmada" => "bg-success",
        "Anulada" => "bg-danger",
        _ => "bg-secondary"
    };

    private string GetSifenBadgeClass(string estado) => estado switch
    {
        "ACEPTADO" => "bg-success",
        "RECHAZADO" => "bg-danger",
        "ENVIADO" => "bg-info",
        "PENDIENTE" => "bg-warning text-dark",
        _ => "bg-secondary"
    };

    private async Task EnviarSifen(NotaCreditoVenta nc)
    {
        if (_enviandoSifen) return;
        
        // Verificar que tenga factura asociada con CDC
        if (nc.VentaAsociada == null || string.IsNullOrEmpty(nc.VentaAsociada.CDC))
        {
            MostrarResultadoSifen(false, null, null, null, null, 
                "La factura asociada no tiene CDC. Primero debe enviar la factura a SIFEN.");
            return;
        }
        
        if (!await JS.InvokeAsync<bool>("confirm", $"¿Enviar NC #{nc.NumeroNota} a SIFEN?"))
            return;
        
        _enviandoSifen = true;
        _ncEnviando = nc.IdNotaCredito;
        StateHasChanged();
        
        try
        {
            var handler = new HttpClientHandler();
            handler.ServerCertificateCustomValidationCallback = (message, cert, chain, errors) => true;
            using var http = new HttpClient(handler);
            http.Timeout = TimeSpan.FromSeconds(120);
            
            var baseUrl = Nav.BaseUri.TrimEnd('/');
            var response = await http.PostAsync($"{baseUrl}/notascredito/{nc.IdNotaCredito}/enviar-sifen", null);
            var json = await response.Content.ReadAsStringAsync();
            
            var result = JsonSerializer.Deserialize<Dictionary<string, JsonElement>>(json);
            
            if (result != null && result.TryGetValue("ok", out var okElement) && okElement.GetBoolean())
            {
                var estado = result.TryGetValue("estado", out var estadoEl) ? estadoEl.GetString() : "ENVIADO";
                var cdc = result.TryGetValue("cdc", out var cdcEl) ? cdcEl.GetString() : "";
                var codigo = result.TryGetValue("codigo", out var codEl) ? codEl.GetString() : "";
                var mensaje = result.TryGetValue("mensaje", out var msgEl) ? msgEl.GetString() : "";
                
                // Actualizar el item en la lista local para refrescar UI inmediatamente
                var ncLocal = _notas.FirstOrDefault(n => n.IdNotaCredito == nc.IdNotaCredito);
                if (ncLocal != null)
                {
                    ncLocal.EstadoSifen = estado;
                    ncLocal.CDC = cdc;
                    ncLocal.MensajeSifen = mensaje;
                }
                
                // Refrescar UI antes de mostrar el modal
                StateHasChanged();
                
                MostrarResultadoSifen(true, estado, cdc, codigo, mensaje, null);
            }
            else
            {
                var error = result?.TryGetValue("error", out var errEl) == true ? errEl.GetString() : "Error desconocido";
                var codigo = result?.TryGetValue("codigo", out var codEl) == true ? codEl.GetString() : "";
                var mensaje = result?.TryGetValue("mensaje", out var msgEl) == true ? msgEl.GetString() : "";
                
                // Actualizar estado de rechazo en la lista local
                var ncLocal = _notas.FirstOrDefault(n => n.IdNotaCredito == nc.IdNotaCredito);
                if (ncLocal != null && codigo == "0160")
                {
                    ncLocal.EstadoSifen = "RECHAZADO";
                    ncLocal.MensajeSifen = mensaje ?? error;
                }
                
                // Refrescar UI antes de mostrar el modal
                StateHasChanged();
                
                MostrarResultadoSifen(false, null, null, codigo, mensaje, error);
            }
            
            // Recargar datos completos
            await CargarDatos();
        }
        catch (Exception ex)
        {
            MostrarResultadoSifen(false, null, null, null, null, $"Error de conexión: {ex.Message}");
        }
        finally
        {
            _enviandoSifen = false;
            _ncEnviando = null;
            StateHasChanged();
        }
    }

    private async Task ConsultarSifen(NotaCreditoVenta nc)
    {
        if (_consultandoSifen || (string.IsNullOrEmpty(nc.IdLote) && string.IsNullOrEmpty(nc.CDC))) return;
        
        _consultandoSifen = true;
        _ncConsultando = nc.IdNotaCredito;
        StateHasChanged();
        
        try
        {
            var handler = new HttpClientHandler();
            handler.ServerCertificateCustomValidationCallback = (message, cert, chain, errors) => true;
            using var http = new HttpClient(handler);
            http.Timeout = TimeSpan.FromSeconds(60);
            
            var baseUrl = Nav.BaseUri.TrimEnd('/');
            var response = await http.GetAsync($"{baseUrl}/notascredito/{nc.IdNotaCredito}/consultar-sifen");
            var json = await response.Content.ReadAsStringAsync();
            
            var result = JsonSerializer.Deserialize<Dictionary<string, JsonElement>>(json);
            
            if (result != null && result.TryGetValue("ok", out var okElement) && okElement.GetBoolean())
            {
                var estado = result.TryGetValue("estadoSifen", out var estadoEl) ? estadoEl.GetString() : "";
                var codigo = result.TryGetValue("codigo", out var codEl) ? codEl.GetString() : "";
                var mensaje = result.TryGetValue("mensaje", out var msgEl) ? msgEl.GetString() : "";
                
                // Actualizar el item en la lista local para refrescar UI inmediatamente
                var ncLocal = _notas.FirstOrDefault(n => n.IdNotaCredito == nc.IdNotaCredito);
                if (ncLocal != null)
                {
                    ncLocal.EstadoSifen = estado;
                    ncLocal.MensajeSifen = mensaje;
                }
                
                // Refrescar UI antes de mostrar el modal
                StateHasChanged();
                
                MostrarResultadoSifen(true, estado, nc.CDC, codigo, mensaje, null);
            }
            else
            {
                var error = result?.TryGetValue("error", out var errEl) == true ? errEl.GetString() : "Error desconocido";
                
                // Refrescar UI antes de mostrar el modal
                StateHasChanged();
                
                MostrarResultadoSifen(false, null, null, null, null, error);
            }
            
            await CargarDatos();
        }
        catch (Exception ex)
        {
            MostrarResultadoSifen(false, null, null, null, null, $"Error de conexión: {ex.Message}");
        }
        finally
        {
            _consultandoSifen = false;
            _ncConsultando = null;
            StateHasChanged();
        }
    }
    
    // ========== Métodos de Modales ==========
    
    private void MostrarResultadoSifen(bool exito, string? estado, string? cdc, string? codigo, string? mensaje, string? error)
    {
        _resultadoSifenExito = exito;
        _resultadoSifenEstado = estado;
        _resultadoSifenCdc = cdc;
        _resultadoSifenCodigo = codigo;
        _resultadoSifenMensaje = mensaje;
        _resultadoSifenError = error;
        _mostrarResultadoSifen = true;
        StateHasChanged();
    }
    
    private void CerrarResultadoSifen()
    {
        _mostrarResultadoSifen = false;
        _resultadoSifenExito = false;
        _resultadoSifenEstado = null;
        _resultadoSifenCdc = null;
        _resultadoSifenCodigo = null;
        _resultadoSifenMensaje = null;
        _resultadoSifenError = null;
        StateHasChanged();
    }
    
    private void MostrarQR(string? cdc, string? urlQr)
    {
        _qrCdc = cdc;
        _qrUrl = urlQr;
        _mostrarQR = true;
        StateHasChanged();
    }
    
    private void CerrarQR()
    {
        _mostrarQR = false;
        _qrCdc = null;
        _qrUrl = null;
        StateHasChanged();;
    }
    
    // ========== Métodos de Eliminación ==========
    
    /// <summary>
    /// Verifica si una NC puede ser eliminada.
    /// Solo se puede eliminar si:
    /// 1. Es autoimpresor (no tiene CDC) y estado Borrador o Confirmada
    /// 2. O fue RECHAZADA por SIFEN (error de envío)
    /// NO se puede eliminar si fue ACEPTADA por SIFEN.
    /// </summary>
    private bool PuedeEliminarNC(NotaCreditoVenta nc)
    {
        // Nunca se puede eliminar si fue ACEPTADA por SIFEN
        var estadosSifenAceptados = new[] { "ACEPTADO", "APROBADO", "ENVIADO" };
        if (!string.IsNullOrWhiteSpace(nc.EstadoSifen) && 
            estadosSifenAceptados.Contains(nc.EstadoSifen.ToUpper()))
        {
            return false;
        }
        
        // Si tiene CDC y fue RECHAZADA, se puede eliminar
        var estadosSifenRechazados = new[] { "RECHAZADO", "RECHAZADA", "ERROR" };
        if (!string.IsNullOrWhiteSpace(nc.CDC) && 
            !string.IsNullOrWhiteSpace(nc.EstadoSifen) &&
            estadosSifenRechazados.Contains(nc.EstadoSifen.ToUpper()))
        {
            return true;
        }
        
        // Si no tiene CDC (autoimpresor), se puede eliminar si es Borrador o Confirmada
        if (string.IsNullOrWhiteSpace(nc.CDC))
        {
            return nc.Estado == "Borrador" || nc.Estado == "Confirmada";
        }
        
        return false;
    }
    
    private async Task EliminarNC(NotaCreditoVenta nc)
    {
        // Verificar permiso DELETE
        if (!_tienePermisoEliminar)
        {
            await JS.InvokeVoidAsync("alert", "❌ No tiene permiso para eliminar Notas de Crédito.\n\nContacte al administrador para solicitar el permiso DELETE en el módulo Notas de Crédito.");
            return;
        }
        
        // Verificar si se puede eliminar
        if (!PuedeEliminarNC(nc))
        {
            await JS.InvokeVoidAsync("alert", "❌ Esta Nota de Crédito no puede ser eliminada.\n\n" +
                $"Estado: {nc.Estado}\n" +
                $"Estado SIFEN: {nc.EstadoSifen ?? "N/A"}\n" +
                $"CDC: {(string.IsNullOrWhiteSpace(nc.CDC) ? "Sin CDC (Autoimpresor)" : nc.CDC)}\n\n" +
                "Solo se pueden eliminar NC que:\n" +
                "• Sean autoimpresor (sin CDC) y estén en Borrador o Confirmada\n" +
                "• Hayan sido RECHAZADAS por SIFEN");
            return;
        }
        
        // Confirmación
        var numeroNc = $"{nc.Establecimiento}-{nc.PuntoExpedicion}-{nc.NumeroNota.ToString("D7")}";
        var mensajeConfirm = $"¿ELIMINAR PERMANENTEMENTE la Nota de Crédito #{numeroNc}?\n\n" +
            $"Cliente: {nc.Cliente?.RazonSocial ?? nc.NombreCliente ?? "S/N"}\n" +
            $"Total: {nc.SimboloMoneda ?? "Gs."} {nc.Total:N0}\n\n" +
            "⚠️ Esta acción NO SE PUEDE DESHACER.";
        
        if (!await JS.InvokeAsync<bool>("confirm", mensajeConfirm))
            return;
        
        try
        {
            await using var ctx = await DbFactory.CreateDbContextAsync();
            
            // Cargar la NC con sus detalles y caja
            var ncDb = await ctx.NotasCreditoVentas
                .Include(n => n.Detalles)
                .Include(n => n.Caja)
                .FirstOrDefaultAsync(n => n.IdNotaCredito == nc.IdNotaCredito);
            
            if (ncDb == null)
            {
                await JS.InvokeVoidAsync("alert", "La Nota de Crédito ya no existe.");
                await CargarDatos();
                return;
            }
            
            // Revertir stock si la NC había afectado stock y estaba confirmada
            if (ncDb.AfectaStock != 0 && ncDb.Estado == "Confirmada" && ncDb.Detalles?.Any() == true)
            {
                var authState = await AuthStateProvider.GetAuthenticationStateAsync();
                var usuarioNombre = authState.User?.Identity?.Name ?? "Sistema";
                
                foreach (var det in ncDb.Detalles)
                {
                    if (det.IdProducto > 0 && det.IdDeposito > 0)
                    {
                        // Si AfectaStock = 1 (suma), revertimos con salida (2)
                        // Si AfectaStock = -1 (resta), revertimos con entrada (1)
                        var tipoMov = ncDb.AfectaStock == 1 ? 2 : 1;
                        await Inventario.AjustarStockAsync(
                            det.IdProducto,
                            det.IdDeposito ?? 0,
                            det.Cantidad,
                            tipoMov,
                            $"Eliminación NC #{ncDb.NumeroNota}",
                            usuarioNombre);
                    }
                }
            }
            
            // ========================================================================
            // RETROCEDER CONTADOR DE CAJA SI ES LA ÚLTIMA NC
            // ========================================================================
            bool retrocedioContador = false;
            if (ncDb.IdCaja > 0)
            {
                // Buscar el máximo NumeroNota RESTANTE para la misma caja/timbrado/serie
                var maxNCRestante = await ctx.NotasCreditoVentas
                    .Where(n => n.IdCaja == ncDb.IdCaja 
                             && n.Timbrado == ncDb.Timbrado 
                             && n.Serie == ncDb.Serie
                             && n.IdNotaCredito != ncDb.IdNotaCredito)
                    .OrderByDescending(n => n.NumeroNota)
                    .Select(n => (int?)n.NumeroNota)
                    .FirstOrDefaultAsync();
                
                // Si no hay ninguna NC restante, o la máxima restante es menor al que eliminamos
                if (!maxNCRestante.HasValue || ncDb.NumeroNota > maxNCRestante.Value)
                {
                    var cajaActualizar = await ctx.Cajas.FindAsync(ncDb.IdCaja);
                    if (cajaActualizar != null && 
                        cajaActualizar.TimbradoNC == ncDb.Timbrado && 
                        cajaActualizar.SerieNC == ncDb.Serie)
                    {
                        // Retroceder el contador al número de la NC eliminada
                        cajaActualizar.NumeroNC = ncDb.NumeroNota.ToString("D7");
                        retrocedioContador = true;
                    }
                }
            }
            
            // Eliminar detalles
            if (ncDb.Detalles?.Any() == true)
            {
                ctx.Set<NotaCreditoVentaDetalle>().RemoveRange(ncDb.Detalles);
            }
            
            // Eliminar la NC
            ctx.NotasCreditoVentas.Remove(ncDb);
            
            await ctx.SaveChangesAsync();
            
            var msgExtra = retrocedioContador 
                ? $"\n\nEl número de NC {numeroNc} quedó disponible para la próxima nota de crédito."
                : "";
            await JS.InvokeVoidAsync("alert", $"✅ Nota de Crédito #{numeroNc} eliminada correctamente.{msgExtra}");
            await CargarDatos();
        }
        catch (Exception ex)
        {
            var innerMsg = ex.InnerException?.Message ?? ex.Message;
            await JS.InvokeVoidAsync("alert", $"❌ Error al eliminar la Nota de Crédito:\n\n{innerMsg}");
        }
    }
}
