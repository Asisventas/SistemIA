@page "/vehiculos"
@page "/vehiculos/{IdVehiculo:int}"
@using Microsoft.EntityFrameworkCore
@inject IDbContextFactory<SistemIA.Models.AppDbContext> DbFactory
@inject NavigationManager Nav

<PageTitle>@(_idVehiculo > 0 ? "Editar" : "Nuevo") Vehículo - SistemIA</PageTitle>

<div class="container-fluid py-3">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h3 class="mb-0">
            <i class="bi bi-car-front-fill text-warning me-2"></i>
            @(_idVehiculo > 0 ? "Editar" : "Nuevo") Vehículo
        </h3>
        <button class="btn btn-outline-secondary" @onclick="Volver">
            <i class="bi bi-arrow-left me-1"></i>Volver
        </button>
    </div>

    @if (_cargando)
    {
        <div class="text-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Cargando...</span>
            </div>
        </div>
    }
    else if (_vehiculo == null)
    {
        <div class="alert alert-danger">Vehículo no encontrado</div>
    }
    else
    {
        <div class="card shadow-sm">
            <div class="card-header bg-light">
                <h6 class="mb-0"><i class="bi bi-info-circle me-2"></i>Datos del Vehículo</h6>
            </div>
            <div class="card-body">
                <EditForm Model="_vehiculo" OnValidSubmit="GuardarAsync">
                    <DataAnnotationsValidator />

                    <div class="row g-3">
                        <!-- Cliente -->
                        <div class="col-md-6">
                            <label class="form-label small text-muted">Cliente</label>
                            <InputSelect @bind-Value="_vehiculo.IdCliente" class="form-select">
                                <option value="0">-- Sin cliente asignado --</option>
                                @foreach (var c in _clientes)
                                {
                                    <option value="@c.IdCliente">@c.RazonSocial (@c.RUC)</option>
                                }
                            </InputSelect>
                        </div>

                        <!-- Matrícula -->
                        <div class="col-md-3">
                            <label class="form-label small text-muted">
                                Matrícula <span class="text-danger">*</span>
                            </label>
                            <InputText @bind-Value="_vehiculo.Matricula" class="form-control" 
                                       style="text-transform: uppercase;" maxlength="20" />
                            <ValidationMessage For="() => _vehiculo.Matricula" />
                        </div>

                        <!-- Tipo de vehículo -->
                        <div class="col-md-3">
                            <label class="form-label small text-muted">Tipo</label>
                            <InputSelect @bind-Value="_vehiculo.TipoVehiculo" class="form-select">
                                <option value="">-- Seleccionar --</option>
                                <option value="Automóvil">Automóvil</option>
                                <option value="Camioneta">Camioneta</option>
                                <option value="SUV">SUV</option>
                                <option value="Camión">Camión</option>
                                <option value="Motocicleta">Motocicleta</option>
                                <option value="Furgón">Furgón</option>
                                <option value="Bus">Bus</option>
                                <option value="Otro">Otro</option>
                            </InputSelect>
                        </div>

                        <!-- Marca -->
                        <div class="col-md-3">
                            <label class="form-label small text-muted">Marca</label>
                            <InputText @bind-Value="_vehiculo.Marca" class="form-control" list="marcasVehiculos" />
                            <datalist id="marcasVehiculos">
                                <option value="Toyota" />
                                <option value="Hyundai" />
                                <option value="Kia" />
                                <option value="Nissan" />
                                <option value="Chevrolet" />
                                <option value="Ford" />
                                <option value="Volkswagen" />
                                <option value="Honda" />
                                <option value="Mitsubishi" />
                                <option value="Suzuki" />
                                <option value="Fiat" />
                                <option value="Renault" />
                                <option value="Peugeot" />
                                <option value="BMW" />
                                <option value="Mercedes-Benz" />
                                <option value="Audi" />
                            </datalist>
                        </div>

                        <!-- Modelo -->
                        <div class="col-md-3">
                            <label class="form-label small text-muted">Modelo</label>
                            <InputText @bind-Value="_vehiculo.Modelo" class="form-control" />
                        </div>

                        <!-- Año -->
                        <div class="col-md-2">
                            <label class="form-label small text-muted">Año</label>
                            <InputNumber @bind-Value="_vehiculo.Anio" class="form-control" />
                        </div>

                        <!-- Color -->
                        <div class="col-md-2">
                            <label class="form-label small text-muted">Color</label>
                            <InputText @bind-Value="_vehiculo.Color" class="form-control" />
                        </div>

                        <!-- Combustible -->
                        <div class="col-md-2">
                            <label class="form-label small text-muted">Combustible</label>
                            <InputSelect @bind-Value="_vehiculo.TipoCombustible" class="form-select">
                                <option value="">--</option>
                                <option value="Nafta">Nafta</option>
                                <option value="Diesel">Diesel</option>
                                <option value="GLP">GLP</option>
                                <option value="GNC">GNC</option>
                                <option value="Eléctrico">Eléctrico</option>
                                <option value="Híbrido">Híbrido</option>
                            </InputSelect>
                        </div>

                        <!-- Kilometraje actual -->
                        <div class="col-md-3">
                            <label class="form-label small text-muted">Kilometraje actual</label>
                            <div class="input-group">
                                <InputNumber @bind-Value="_vehiculo.KilometrajeActual" class="form-control" />
                                <span class="input-group-text">km</span>
                            </div>
                        </div>

                        <!-- Número de Chasis -->
                        <div class="col-md-4">
                            <label class="form-label small text-muted">Número de Chasis</label>
                            <InputText @bind-Value="_vehiculo.NumeroChasis" class="form-control" maxlength="50" />
                        </div>

                        <!-- Número de Motor -->
                        <div class="col-md-4">
                            <label class="form-label small text-muted">Número de Motor</label>
                            <InputText @bind-Value="_vehiculo.NumeroMotor" class="form-control" maxlength="50" />
                        </div>

                        <!-- Observaciones -->
                        <div class="col-12">
                            <label class="form-label small text-muted">Observaciones</label>
                            <InputTextArea @bind-Value="_vehiculo.Observaciones" class="form-control" rows="2" />
                        </div>
                    </div>

                    <hr />

                    <div class="d-flex justify-content-end gap-2">
                        <button type="button" class="btn btn-outline-secondary" @onclick="Volver">
                            <i class="bi bi-x-lg me-1"></i>Cancelar
                        </button>
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-check-lg me-1"></i>Guardar
                        </button>
                    </div>
                </EditForm>
            </div>
        </div>

        @* Historial de órdenes (si existe) *@
        @if (_idVehiculo > 0 && _ordenesHistorico.Any())
        {
            <div class="card shadow-sm mt-4">
                <div class="card-header bg-light">
                    <h6 class="mb-0"><i class="bi bi-clock-history me-2"></i>Historial de Servicios</h6>
                </div>
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>Fecha</th>
                                <th>Orden</th>
                                <th>Km</th>
                                <th>Trabajos</th>
                                <th class="text-end">Total</th>
                                <th>Estado</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var o in _ordenesHistorico)
                            {
                                <tr>
                                    <td>@o.FechaCreacion.ToString("dd/MM/yyyy")</td>
                                    <td><span class="badge bg-secondary">@o.CodigoOrden</span></td>
                                    <td>@o.KilometrajeIngreso?.ToString("N0") km</td>
                                    <td>@(o.TrabajosARealizar?.Length > 50 ? o.TrabajosARealizar.Substring(0, 50) + "..." : o.TrabajosARealizar)</td>
                                    <td class="text-end">@o.Total.ToString("N0")</td>
                                    <td><span class="badge bg-@o.ColorEstado">@o.Estado</span></td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        }
    }
</div>

@code {
    [Parameter]
    public int IdVehiculo { get; set; }

    private int _idVehiculo => IdVehiculo;
    private Vehiculo? _vehiculo;
    private bool _cargando = true;
    
    private List<Cliente> _clientes = new();
    private List<OrdenTrabajo> _ordenesHistorico = new();
    
    private int _idSucursal = 1; // TODO: Obtener de sesión

    protected override async Task OnInitializedAsync()
    {
        await CargarClientesAsync();

        if (_idVehiculo > 0)
        {
            await CargarVehiculoAsync();
            await CargarHistoricoAsync();
        }
        else
        {
            _vehiculo = new Vehiculo
            {
                IdSucursal = _idSucursal,
                FechaCreacion = DateTime.Now
            };
        }
        _cargando = false;
    }

    private async Task CargarClientesAsync()
    {
        await using var ctx = await DbFactory.CreateDbContextAsync();
        _clientes = await ctx.Clientes
            .Where(c => c.Estado == true)
            .OrderBy(c => c.RazonSocial)
            .Take(500)
            .ToListAsync();
    }

    private async Task CargarVehiculoAsync()
    {
        await using var ctx = await DbFactory.CreateDbContextAsync();
        _vehiculo = await ctx.Vehiculos
            .Include(v => v.Cliente)
            .FirstOrDefaultAsync(v => v.IdVehiculo == _idVehiculo);
    }

    private async Task CargarHistoricoAsync()
    {
        await using var ctx = await DbFactory.CreateDbContextAsync();
        _ordenesHistorico = await ctx.OrdenesTrabajo
            .Where(o => o.IdVehiculo == _idVehiculo)
            .OrderByDescending(o => o.FechaCreacion)
            .Take(20)
            .ToListAsync();
    }

    private async Task GuardarAsync()
    {
        if (_vehiculo == null) return;

        _vehiculo.Matricula = _vehiculo.Matricula?.ToUpper().Trim();

        await using var ctx = await DbFactory.CreateDbContextAsync();

        // Validar matrícula única en la sucursal
        var existeMatricula = await ctx.Vehiculos
            .AnyAsync(v => v.IdSucursal == _vehiculo.IdSucursal 
                        && v.Matricula == _vehiculo.Matricula 
                        && v.IdVehiculo != _vehiculo.IdVehiculo);
        if (existeMatricula)
        {
            // Mostrar error - por ahora solo log
            return;
        }

        if (_vehiculo.IdVehiculo == 0)
        {
            _vehiculo.FechaCreacion = DateTime.Now;
            ctx.Vehiculos.Add(_vehiculo);
        }
        else
        {
            _vehiculo.FechaModificacion = DateTime.Now;
            ctx.Vehiculos.Update(_vehiculo);
        }

        await ctx.SaveChangesAsync();
        Nav.NavigateTo("/vehiculos/explorar");
    }

    private void Volver()
    {
        Nav.NavigateTo("/vehiculos/explorar");
    }
}
